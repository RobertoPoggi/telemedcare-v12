<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firma Contratto TeleMedCare</title>
    
    <!-- üî• FIX CRITICO REDIRECT: 26 Feb 2026 -->
    <!-- Aggiunto event.preventDefault() + type="button" + history.pushState -->
    <!-- per prevenire QUALSIASI redirect dopo firma contratto -->
    <meta name="fix-version" content="REDIRECT-FIX-2026-02-26">
    <meta name="fix-commit" content="pending">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .content {
            padding: 40px;
        }

        .contract-section {
            margin-bottom: 30px;
        }

        .contract-section h2 {
            color: #667eea;
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .contract-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #666;
        }

        .info-value {
            color: #333;
            text-align: right;
        }

        .contract-html {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 30px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 30px;
            font-size: 14px;
            line-height: 1.6;
        }

        .signature-section {
            background: #fff9e6;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .signature-section h3 {
            color: #ff9800;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .signature-canvas-container {
            background: white;
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        #signatureCanvas {
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            cursor: crosshair;
            touch-action: none;
            max-width: 100%;
        }

        .signature-hint {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-clear {
            background: #f44336;
            color: white;
        }

        .btn-clear:hover {
            background: #d32f2f;
        }

        .btn-sign {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 18px;
            padding: 15px 50px;
        }

        .btn-sign:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-sign:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .consent {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .consent label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .consent input {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #4CAF50;
            color: white;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            z-index: 9999;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-width: 500px;
            width: 90%;
        }

        .success-message.active {
            display: block;
        }

        .success-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9998;
        }

        .success-overlay.active {
            display: block;
        }

        .error-message {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #f44336;
            color: white;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            z-index: 9999;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-width: 500px;
            width: 90%;
        }

        .error-message.active {
            display: block;
        }

        .footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            color: #666;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }

            .content {
                padding: 20px;
            }

            .info-row {
                flex-direction: column;
                gap: 5px;
            }

            .info-value {
                text-align: left;
            }

            .button-group {
                flex-direction: column;
            }

            #signatureCanvas {
                width: 100%;
                height: 200px;
            }
        }
    </style>

    <!-- BUILD INFO: ANTI-CACHE V11 ROLLBACK -->
    <meta name="build-version" content="V12">
    <meta name="build-commit" content="d7cf15a">
    <meta name="build-date" content="2026-03-01T02:47:40.687Z">
    <meta name="build-timestamp" content="1772333260688">
    <!-- END BUILD INFO -->
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÑ Firma Digitale Contratto</h1>
            <p>TeleMedCare - Servizio di TeleAssistenza Domiciliare</p>
        </div>

        <div class="content">
            <div id="loadingContract" class="loading active">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: #666;">Caricamento contratto in corso...</p>
            </div>

            <div id="contractContent" style="display: none;">
                <div class="contract-section">
                    <h2>üìã Dettagli Contratto</h2>
                    <div class="contract-info">
                        <div class="info-row">
                            <span class="info-label">Cliente:</span>
                            <span class="info-value" id="clientName">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Servizio:</span>
                            <span class="info-value" id="serviceName">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Piano:</span>
                            <span class="info-value" id="planName">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Dispositivo:</span>
                            <span class="info-value" id="deviceName">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Prezzo:</span>
                            <span class="info-value" id="price">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Codice Contratto:</span>
                            <span class="info-value" id="contractCode">-</span>
                        </div>
                    </div>
                </div>

                <div class="contract-section">
                    <h2>üìÉ Contenuto Contratto</h2>
                    <div class="contract-html" id="contractHtml">
                        <!-- Il contenuto HTML del contratto verr√† inserito qui -->
                    </div>
                </div>

                <div class="signature-section">
                    <h3>‚úçÔ∏è Firma qui sotto con il mouse (desktop) o con il dito (mobile)</h3>
                    <div class="signature-canvas-container">
                        <canvas id="signatureCanvas" width="700" height="200"></canvas>
                        <p class="signature-hint">üñäÔ∏è Disegna la tua firma nell'area sopra</p>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-clear" onclick="clearSignature()">üóëÔ∏è Cancella Firma</button>
                    </div>
                </div>

                <div class="consent">
                    <label>
                        <input type="checkbox" id="consentCheck" onchange="toggleSignButton()">
                        <span>Dichiaro di aver letto e accettato tutti i termini e le condizioni del contratto. Confermo che la firma digitale apposta √® valida e vincolante.</span>
                    </label>
                </div>

                <div style="text-align: center;">
                    <button type="button" class="btn btn-sign" id="signButton" onclick="submitSignature(event)" disabled>
                        ‚úÖ Firma e Invia Contratto
                    </button>
                </div>

                <div id="loadingSubmit" class="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px; color: #666;">Invio firma in corso...</p>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>üîí Firma digitale sicura - TeleMedCare ¬© 2026</p>
            <p style="margin-top: 5px;">Medica GB S.r.l. - P.IVA 12435130963</p>
        </div>

        <!-- Success e Error message FUORI da contractContent per overlay -->
        <div id="successMessage" class="success-message">
            <h2>‚úÖ Contratto Firmato con Successo!</h2>
            <p style="margin-top: 10px;">Grazie per aver completato la firma. Riceverai una email di conferma a breve.</p>
            <p style="margin-top: 10px; font-size: 14px; margin-bottom: 20px;">Ti arriver√† anche la pro-forma per procedere con il pagamento.</p>
            <button type="button" onclick="closeWindow(event)" class="btn btn-sign" style="width: auto; padding: 12px 40px; font-size: 16px;">
                ‚úì Chiudi
            </button>
        </div>

        <div id="errorMessage" class="error-message">
            <h2>‚ùå Errore</h2>
            <p id="errorText" style="margin-top: 10px;">Si √® verificato un errore. Riprova.</p>
        </div>
    </div>

    <script>
        let canvas, ctx, drawing = false;
        let contractId = null;
        let contractData = null;

        // Inizializza canvas firma
        window.onload = function() {
            canvas = document.getElementById('signatureCanvas');
            ctx = canvas.getContext('2d');
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';

            // Eventi mouse (desktop)
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Eventi touch (mobile)
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', stopDrawing);

            // Carica contratto
            loadContract();
        };

        function startDrawing(e) {
            drawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!drawing) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
        }

        function stopDrawing() {
            drawing = false;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            drawing = true;
            ctx.beginPath();
            ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!drawing) return;
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
            ctx.stroke();
        }

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function toggleSignButton() {
            const consentCheck = document.getElementById('consentCheck');
            const signButton = document.getElementById('signButton');
            signButton.disabled = !consentCheck.checked;
        }

        async function loadContract() {
            try {
                // Estrai contractId dall'URL
                const urlParams = new URLSearchParams(window.location.search);
                contractId = urlParams.get('contractId');

                if (!contractId) {
                    throw new Error('ID contratto mancante');
                }

                // Chiama API per ottenere dati contratto
                const response = await fetch(`/api/contracts/${contractId}`);
                
                if (!response.ok) {
                    throw new Error('Contratto non trovato');
                }

                contractData = await response.json();

                // Popola i campi
                document.getElementById('clientName').textContent = 
                    `${contractData.nomeCliente} ${contractData.cognomeCliente}`;
                document.getElementById('serviceName').textContent = contractData.servizio || 'eCura PRO';
                document.getElementById('planName').textContent = contractData.piano || 'AVANZATO';
                document.getElementById('deviceName').textContent = contractData.dispositivo || 'SiDLY Care PRO';
                document.getElementById('price').textContent = contractData.prezzo || '‚Ç¨1.024,80/anno';
                document.getElementById('contractCode').textContent = contractData.contractCode;
                
                // Carica HTML del contratto
                document.getElementById('contractHtml').innerHTML = contractData.contractHtml;

                // Mostra contenuto
                document.getElementById('loadingContract').classList.remove('active');
                document.getElementById('contractContent').style.display = 'block';

            } catch (error) {
                console.error('Errore caricamento contratto:', error);
                document.getElementById('loadingContract').innerHTML = 
                    `<p style="color: #f44336;">‚ùå ${error.message}</p>`;
            }
        }

        async function submitSignature(event) {
            // üî• CRITICAL FIX: Previeni QUALSIASI comportamento di navigazione
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();
            }
            
            console.log('üîç [DEBUG] submitSignature() chiamata - NESSUN redirect previsto');
            
            // üî• BLOCCO GLOBALE: Previeni QUALSIASI tentativo di navigazione
            const blockNavigation = (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.warn('‚ö†Ô∏è [BLOCKED] Tentativo navigazione bloccato!');
                return false;
            };
            
            // Blocca tutti i possibili eventi di navigazione
            window.addEventListener('beforeunload', blockNavigation, { capture: true });
            window.addEventListener('unload', blockNavigation, { capture: true });
            document.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    e.preventDefault();
                    console.warn('‚ö†Ô∏è [BLOCKED] Click su link bloccato');
                }
            }, { capture: true });
            
            try {
                // Verifica che ci sia una firma
                const signatureData = canvas.toDataURL('image/png');
                
                // Controlla se il canvas √® vuoto
                const emptyCanvas = document.createElement('canvas');
                emptyCanvas.width = canvas.width;
                emptyCanvas.height = canvas.height;
                
                if (signatureData === emptyCanvas.toDataURL('image/png')) {
                    alert('‚ùå Per favore, firma il contratto prima di inviare.');
                    return;
                }

                // Mostra loading
                document.getElementById('signButton').disabled = true;
                document.getElementById('loadingSubmit').classList.add('active');

                // Prepara dati firma
                const signaturePayload = {
                    contractId: contractId,
                    signatureData: signatureData,
                    timestamp: new Date().toISOString(),
                    ipAddress: await getClientIP(),
                    userAgent: navigator.userAgent,
                    screenResolution: `${screen.width}x${screen.height}`
                };

                // Invia firma al server
                const response = await fetch('/api/contracts/sign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(signaturePayload)
                });

                const result = await response.json();
                console.log('üîç [DEBUG] Response ricevuta:', result);

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Errore durante l\'invio della firma');
                }

                console.log('‚úÖ [DEBUG] Firma salvata con successo - Mostro popup successo (NO redirect)');
                
                // üî• PROTEZIONE MASSIMA: Blocca history e location
                Object.defineProperty(window, 'location', {
                    configurable: false,
                    writable: false,
                    value: window.location
                });
                
                // Mostra messaggio successo con overlay
                document.getElementById('loadingSubmit').classList.remove('active');
                document.getElementById('successOverlay').classList.add('active');
                document.getElementById('successMessage').classList.add('active');
                
                // Nascondi il form di firma (non serve pi√π nascondere le sezioni, il popup √® in overlay)
                document.getElementById('contractContent').style.display = 'none';
                
                // üî• CRITICAL: Previeni QUALSIASI navigazione dopo successo
                console.log('üîç [DEBUG] Popup successo mostrato - L\'utente DEVE rimanere su questa pagina');
                
                // Blocca il back button per evitare navigazioni accidentali
                window.history.pushState(null, '', window.location.href);
                window.addEventListener('popstate', function(e) {
                    window.history.pushState(null, '', window.location.href);
                    console.warn('‚ö†Ô∏è [BLOCKED] Back button bloccato');
                });
                
                // üî• BLOCCO ASSOLUTO: return false per fermare esecuzione
                return false;

            } catch (error) {
                console.error('Errore invio firma:', error);
                document.getElementById('loadingSubmit').classList.remove('active');
                document.getElementById('errorText').textContent = error.message;
                document.getElementById('successOverlay').classList.add('active');
                document.getElementById('errorMessage').classList.add('active');
                document.getElementById('signButton').disabled = false;
            }
        }

        function closeWindow(event) {
            // üî• CRITICAL FIX: Previeni navigazione
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            console.log('üîç [DEBUG] Bottone Chiudi cliccato - Nessuna navigazione');
            
            // Non chiude automaticamente la finestra per evitare problemi con iframe/popup
            // Mostra solo messaggio che l'utente pu√≤ chiudere manualmente
            const btn = event ? event.target : null;
            if (btn) {
                btn.style.display = 'none';
                const msg = document.createElement('p');
                msg.style.marginTop = '20px';
                msg.style.fontSize = '14px';
                msg.textContent = '‚úì Contratto firmato con successo! Puoi chiudere questa finestra.';
                btn.parentElement.appendChild(msg);
            }
        }

        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch {
                return 'unknown';
            }
        }
    </script>

    <!-- Overlay per popup successo -->
    <div id="successOverlay" class="success-overlay"></div>
</body>
</html>
