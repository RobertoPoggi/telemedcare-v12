var C0=Object.defineProperty;var gu=t=>{throw TypeError(t)};var R0=(t,o,e)=>o in t?C0(t,o,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[o]=e;var O=(t,o,e)=>R0(t,typeof o!="symbol"?o+"":o,e),fu=(t,o,e)=>o.has(t)||gu("Cannot "+e),yt=(t,o)=>Object(o)!==o?gu('Cannot use the "in" operator on this value'):t.has(o),n=(t,o,e)=>(fu(t,o,"read from private field"),e?e.call(t):o.get(t)),f=(t,o,e)=>o.has(t)?gu("Cannot add the same private member more than once"):o instanceof WeakSet?o.add(t):o.set(t,e),v=(t,o,e,a)=>(fu(t,o,"write to private field"),a?a.call(t,e):o.set(t,e),e),T=(t,o,e)=>(fu(t,o,"access private method"),e);var pr=(t,o,e,a)=>({set _(i){v(t,o,i,e)},get _(){return n(t,o,a)}});import"crypto";import*as Uc from"fs";import*as pm from"path";import{join as _0}from"path";import{Buffer as hg}from"node:buffer";import{spawn as O0}from"child_process";var mm=(t,o,e)=>(a,i)=>{let r=-1;return s(0);async function s(l){if(l<=r)throw new Error("next() called multiple times");r=l;let d,c=!1,u;if(t[l]?(u=t[l][0][0],a.req.routeIndex=l):u=l===t.length&&i||void 0,u)try{d=await u(a,()=>s(l+1))}catch(p){if(p instanceof Error&&o)a.error=p,d=await o(p,a),c=!0;else throw p}else a.finalized===!1&&e&&(d=await e(a));return d&&(a.finalized===!1||c)&&(a.res=d),a}},D0=Symbol(),M0=async(t,o=Object.create(null))=>{const{all:e=!1,dot:a=!1}=o,r=(t instanceof wg?t.raw.headers:t.headers).get("Content-Type");return r!=null&&r.startsWith("multipart/form-data")||r!=null&&r.startsWith("application/x-www-form-urlencoded")?z0(t,{all:e,dot:a}):{}};async function z0(t,o){const e=await t.formData();return e?L0(e,o):{}}function L0(t,o){const e=Object.create(null);return t.forEach((a,i)=>{o.all||i.endsWith("[]")?N0(e,i,a):e[i]=a}),o.dot&&Object.entries(e).forEach(([a,i])=>{a.includes(".")&&(P0(e,a,i),delete e[a])}),e}var N0=(t,o,e)=>{t[o]!==void 0?Array.isArray(t[o])?t[o].push(e):t[o]=[t[o],e]:o.endsWith("[]")?t[o]=[e]:t[o]=e},P0=(t,o,e)=>{let a=t;const i=o.split(".");i.forEach((r,s)=>{s===i.length-1?a[r]=e:((!a[r]||typeof a[r]!="object"||Array.isArray(a[r])||a[r]instanceof File)&&(a[r]=Object.create(null)),a=a[r])})},vg=t=>{const o=t.split("/");return o[0]===""&&o.shift(),o},B0=t=>{const{groups:o,path:e}=k0(t),a=vg(e);return F0(a,o)},k0=t=>{const o=[];return t=t.replace(/\{[^}]+\}/g,(e,a)=>{const i=`@${a}`;return o.push([i,e]),i}),{groups:o,path:t}},F0=(t,o)=>{for(let e=o.length-1;e>=0;e--){const[a]=o[e];for(let i=t.length-1;i>=0;i--)if(t[i].includes(a)){t[i]=t[i].replace(a,o[e][1]);break}}return t},jc={},$0=(t,o)=>{if(t==="*")return"*";const e=t.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(e){const a=`${t}#${o}`;return jc[a]||(e[2]?jc[a]=o&&o[0]!==":"&&o[0]!=="*"?[a,e[1],new RegExp(`^${e[2]}(?=/${o})`)]:[t,e[1],new RegExp(`^${e[2]}$`)]:jc[a]=[t,e[1],!0]),jc[a]}return null},$p=(t,o)=>{try{return o(t)}catch{return t.replace(/(?:%[0-9A-Fa-f]{2})+/g,e=>{try{return o(e)}catch{return e}})}},U0=t=>$p(t,decodeURI),Eg=t=>{const o=t.url,e=o.indexOf("/",o.indexOf(":")+4);let a=e;for(;a<o.length;a++){const i=o.charCodeAt(a);if(i===37){const r=o.indexOf("?",a),s=o.slice(e,r===-1?void 0:r);return U0(s.includes("%25")?s.replace(/%25/g,"%2525"):s)}else if(i===63)break}return o.slice(e,a)},j0=t=>{const o=Eg(t);return o.length>1&&o.at(-1)==="/"?o.slice(0,-1):o},fr=(t,o,...e)=>(e.length&&(o=fr(o,...e)),`${(t==null?void 0:t[0])==="/"?"":"/"}${t}${o==="/"?"":`${(t==null?void 0:t.at(-1))==="/"?"":"/"}${(o==null?void 0:o[0])==="/"?o.slice(1):o}`}`),bg=t=>{if(t.charCodeAt(t.length-1)!==63||!t.includes(":"))return null;const o=t.split("/"),e=[];let a="";return o.forEach(i=>{if(i!==""&&!/\:/.test(i))a+="/"+i;else if(/\:/.test(i))if(/\?/.test(i)){e.length===0&&a===""?e.push("/"):e.push(a);const r=i.replace("?","");a+="/"+r,e.push(a)}else a+="/"+i}),e.filter((i,r,s)=>s.indexOf(i)===r)},hu=t=>/[%+]/.test(t)?(t.indexOf("+")!==-1&&(t=t.replace(/\+/g," ")),t.indexOf("%")!==-1?$p(t,Tg):t):t,yg=(t,o,e)=>{let a;if(!e&&o&&!/[%+]/.test(o)){let s=t.indexOf(`?${o}`,8);for(s===-1&&(s=t.indexOf(`&${o}`,8));s!==-1;){const l=t.charCodeAt(s+o.length+1);if(l===61){const d=s+o.length+2,c=t.indexOf("&",d);return hu(t.slice(d,c===-1?void 0:c))}else if(l==38||isNaN(l))return"";s=t.indexOf(`&${o}`,s+1)}if(a=/[%+]/.test(t),!a)return}const i={};a??(a=/[%+]/.test(t));let r=t.indexOf("?",8);for(;r!==-1;){const s=t.indexOf("&",r+1);let l=t.indexOf("=",r);l>s&&s!==-1&&(l=-1);let d=t.slice(r+1,l===-1?s===-1?void 0:s:l);if(a&&(d=hu(d)),r=s,d==="")continue;let c;l===-1?c="":(c=t.slice(l+1,s===-1?void 0:s),a&&(c=hu(c))),e?(i[d]&&Array.isArray(i[d])||(i[d]=[]),i[d].push(c)):i[d]??(i[d]=c)}return o?i[o]:i},H0=yg,V0=(t,o)=>yg(t,o,!0),Tg=decodeURIComponent,gm=t=>$p(t,Tg),Cr,Tt,No,Ig,Sg,Lu,Ko,og,wg=(og=class{constructor(t,o="/",e=[[]]){f(this,No);O(this,"raw");f(this,Cr);f(this,Tt);O(this,"routeIndex",0);O(this,"path");O(this,"bodyCache",{});f(this,Ko,t=>{const{bodyCache:o,raw:e}=this,a=o[t];if(a)return a;const i=Object.keys(o)[0];return i?o[i].then(r=>(i==="json"&&(r=JSON.stringify(r)),new Response(r)[t]())):o[t]=e[t]()});this.raw=t,this.path=o,v(this,Tt,e),v(this,Cr,{})}param(t){return t?T(this,No,Ig).call(this,t):T(this,No,Sg).call(this)}query(t){return H0(this.url,t)}queries(t){return V0(this.url,t)}header(t){if(t)return this.raw.headers.get(t)??void 0;const o={};return this.raw.headers.forEach((e,a)=>{o[a]=e}),o}async parseBody(t){var o;return(o=this.bodyCache).parsedBody??(o.parsedBody=await M0(this,t))}json(){return n(this,Ko).call(this,"text").then(t=>JSON.parse(t))}text(){return n(this,Ko).call(this,"text")}arrayBuffer(){return n(this,Ko).call(this,"arrayBuffer")}blob(){return n(this,Ko).call(this,"blob")}formData(){return n(this,Ko).call(this,"formData")}addValidatedData(t,o){n(this,Cr)[t]=o}valid(t){return n(this,Cr)[t]}get url(){return this.raw.url}get method(){return this.raw.method}get[D0](){return n(this,Tt)}get matchedRoutes(){return n(this,Tt)[0].map(([[,t]])=>t)}get routePath(){return n(this,Tt)[0].map(([[,t]])=>t)[this.routeIndex].path}},Cr=new WeakMap,Tt=new WeakMap,No=new WeakSet,Ig=function(t){const o=n(this,Tt)[0][this.routeIndex][1][t],e=T(this,No,Lu).call(this,o);return e&&/\%/.test(e)?gm(e):e},Sg=function(){const t={},o=Object.keys(n(this,Tt)[0][this.routeIndex][1]);for(const e of o){const a=T(this,No,Lu).call(this,n(this,Tt)[0][this.routeIndex][1][e]);a!==void 0&&(t[e]=/\%/.test(a)?gm(a):a)}return t},Lu=function(t){return n(this,Tt)[1]?n(this,Tt)[1][t]:t},Ko=new WeakMap,og),W0={Stringify:1},Ag=async(t,o,e,a,i)=>{typeof t=="object"&&!(t instanceof String)&&(t instanceof Promise||(t=t.toString()),t instanceof Promise&&(t=await t));const r=t.callbacks;return r!=null&&r.length?(i?i[0]+=t:i=[t],Promise.all(r.map(l=>l({phase:o,buffer:i,context:a}))).then(l=>Promise.all(l.filter(Boolean).map(d=>Ag(d,o,!1,a,i))).then(()=>i[0]))):Promise.resolve(t)},G0="text/plain; charset=UTF-8",vu=(t,o)=>({"Content-Type":t,...o}),_n,On,uo,Rr,po,Qe,Dn,_r,Or,Ka,Mn,zn,qo,hr,ag,K0=(ag=class{constructor(t,o){f(this,qo);f(this,_n);f(this,On);O(this,"env",{});f(this,uo);O(this,"finalized",!1);O(this,"error");f(this,Rr);f(this,po);f(this,Qe);f(this,Dn);f(this,_r);f(this,Or);f(this,Ka);f(this,Mn);f(this,zn);O(this,"render",(...t)=>(n(this,_r)??v(this,_r,o=>this.html(o)),n(this,_r).call(this,...t)));O(this,"setLayout",t=>v(this,Dn,t));O(this,"getLayout",()=>n(this,Dn));O(this,"setRenderer",t=>{v(this,_r,t)});O(this,"header",(t,o,e)=>{this.finalized&&v(this,Qe,new Response(n(this,Qe).body,n(this,Qe)));const a=n(this,Qe)?n(this,Qe).headers:n(this,Ka)??v(this,Ka,new Headers);o===void 0?a.delete(t):e!=null&&e.append?a.append(t,o):a.set(t,o)});O(this,"status",t=>{v(this,Rr,t)});O(this,"set",(t,o)=>{n(this,uo)??v(this,uo,new Map),n(this,uo).set(t,o)});O(this,"get",t=>n(this,uo)?n(this,uo).get(t):void 0);O(this,"newResponse",(...t)=>T(this,qo,hr).call(this,...t));O(this,"body",(t,o,e)=>T(this,qo,hr).call(this,t,o,e));O(this,"text",(t,o,e)=>!n(this,Ka)&&!n(this,Rr)&&!o&&!e&&!this.finalized?new Response(t):T(this,qo,hr).call(this,t,o,vu(G0,e)));O(this,"json",(t,o,e)=>T(this,qo,hr).call(this,JSON.stringify(t),o,vu("application/json",e)));O(this,"html",(t,o,e)=>{const a=i=>T(this,qo,hr).call(this,i,o,vu("text/html; charset=UTF-8",e));return typeof t=="object"?Ag(t,W0.Stringify,!1,{}).then(a):a(t)});O(this,"redirect",(t,o)=>{const e=String(t);return this.header("Location",/[^\x00-\xFF]/.test(e)?encodeURI(e):e),this.newResponse(null,o??302)});O(this,"notFound",()=>(n(this,Or)??v(this,Or,()=>new Response),n(this,Or).call(this,this)));v(this,_n,t),o&&(v(this,po,o.executionCtx),this.env=o.env,v(this,Or,o.notFoundHandler),v(this,zn,o.path),v(this,Mn,o.matchResult))}get req(){return n(this,On)??v(this,On,new wg(n(this,_n),n(this,zn),n(this,Mn))),n(this,On)}get event(){if(n(this,po)&&"respondWith"in n(this,po))return n(this,po);throw Error("This context has no FetchEvent")}get executionCtx(){if(n(this,po))return n(this,po);throw Error("This context has no ExecutionContext")}get res(){return n(this,Qe)||v(this,Qe,new Response(null,{headers:n(this,Ka)??v(this,Ka,new Headers)}))}set res(t){if(n(this,Qe)&&t){t=new Response(t.body,t);for(const[o,e]of n(this,Qe).headers.entries())if(o!=="content-type")if(o==="set-cookie"){const a=n(this,Qe).headers.getSetCookie();t.headers.delete("set-cookie");for(const i of a)t.headers.append("set-cookie",i)}else t.headers.set(o,e)}v(this,Qe,t),this.finalized=!0}get var(){return n(this,uo)?Object.fromEntries(n(this,uo)):{}}},_n=new WeakMap,On=new WeakMap,uo=new WeakMap,Rr=new WeakMap,po=new WeakMap,Qe=new WeakMap,Dn=new WeakMap,_r=new WeakMap,Or=new WeakMap,Ka=new WeakMap,Mn=new WeakMap,zn=new WeakMap,qo=new WeakSet,hr=function(t,o,e){const a=n(this,Qe)?new Headers(n(this,Qe).headers):n(this,Ka)??new Headers;if(typeof o=="object"&&"headers"in o){const r=o.headers instanceof Headers?o.headers:new Headers(o.headers);for(const[s,l]of r)s.toLowerCase()==="set-cookie"?a.append(s,l):a.set(s,l)}if(e)for(const[r,s]of Object.entries(e))if(typeof s=="string")a.set(r,s);else{a.delete(r);for(const l of s)a.append(r,l)}const i=typeof o=="number"?o:(o==null?void 0:o.status)??n(this,Rr);return new Response(t,{status:i,headers:a})},ag),Ce="ALL",q0="all",Y0=["get","post","put","delete","options","patch"],xg="Can not add a route since the matcher is already built.",Cg=class extends Error{},Z0="__COMPOSED_HANDLER",X0=t=>t.text("404 Not Found",404),fm=(t,o)=>{if("getResponse"in t){const e=t.getResponse();return o.newResponse(e.body,e)}return console.error(t),o.text("Internal Server Error",500)},xt,_e,_g,Ct,Ua,Zc,Xc,ig,Rg=(ig=class{constructor(o={}){f(this,_e);O(this,"get");O(this,"post");O(this,"put");O(this,"delete");O(this,"options");O(this,"patch");O(this,"all");O(this,"on");O(this,"use");O(this,"router");O(this,"getPath");O(this,"_basePath","/");f(this,xt,"/");O(this,"routes",[]);f(this,Ct,X0);O(this,"errorHandler",fm);O(this,"onError",o=>(this.errorHandler=o,this));O(this,"notFound",o=>(v(this,Ct,o),this));O(this,"fetch",(o,...e)=>T(this,_e,Xc).call(this,o,e[1],e[0],o.method));O(this,"request",(o,e,a,i)=>o instanceof Request?this.fetch(e?new Request(o,e):o,a,i):(o=o.toString(),this.fetch(new Request(/^https?:\/\//.test(o)?o:`http://localhost${fr("/",o)}`,e),a,i)));O(this,"fire",()=>{addEventListener("fetch",o=>{o.respondWith(T(this,_e,Xc).call(this,o.request,o,void 0,o.request.method))})});[...Y0,q0].forEach(r=>{this[r]=(s,...l)=>(typeof s=="string"?v(this,xt,s):T(this,_e,Ua).call(this,r,n(this,xt),s),l.forEach(d=>{T(this,_e,Ua).call(this,r,n(this,xt),d)}),this)}),this.on=(r,s,...l)=>{for(const d of[s].flat()){v(this,xt,d);for(const c of[r].flat())l.map(u=>{T(this,_e,Ua).call(this,c.toUpperCase(),n(this,xt),u)})}return this},this.use=(r,...s)=>(typeof r=="string"?v(this,xt,r):(v(this,xt,"*"),s.unshift(r)),s.forEach(l=>{T(this,_e,Ua).call(this,Ce,n(this,xt),l)}),this);const{strict:a,...i}=o;Object.assign(this,i),this.getPath=a??!0?o.getPath??Eg:j0}route(o,e){const a=this.basePath(o);return e.routes.map(i=>{var s;let r;e.errorHandler===fm?r=i.handler:(r=async(l,d)=>(await mm([],e.errorHandler)(l,()=>i.handler(l,d))).res,r[Z0]=i.handler),T(s=a,_e,Ua).call(s,i.method,i.path,r)}),this}basePath(o){const e=T(this,_e,_g).call(this);return e._basePath=fr(this._basePath,o),e}mount(o,e,a){let i,r;a&&(typeof a=="function"?r=a:(r=a.optionHandler,a.replaceRequest===!1?i=d=>d:i=a.replaceRequest));const s=r?d=>{const c=r(d);return Array.isArray(c)?c:[c]}:d=>{let c;try{c=d.executionCtx}catch{}return[d.env,c]};i||(i=(()=>{const d=fr(this._basePath,o),c=d==="/"?0:d.length;return u=>{const p=new URL(u.url);return p.pathname=p.pathname.slice(c)||"/",new Request(p,u)}})());const l=async(d,c)=>{const u=await e(i(d.req.raw),...s(d));if(u)return u;await c()};return T(this,_e,Ua).call(this,Ce,fr(o,"*"),l),this}},xt=new WeakMap,_e=new WeakSet,_g=function(){const o=new Rg({router:this.router,getPath:this.getPath});return o.errorHandler=this.errorHandler,v(o,Ct,n(this,Ct)),o.routes=this.routes,o},Ct=new WeakMap,Ua=function(o,e,a){o=o.toUpperCase(),e=fr(this._basePath,e);const i={basePath:this._basePath,path:e,method:o,handler:a};this.router.add(o,e,[a,i]),this.routes.push(i)},Zc=function(o,e){if(o instanceof Error)return this.errorHandler(o,e);throw o},Xc=function(o,e,a,i){if(i==="HEAD")return(async()=>new Response(null,await T(this,_e,Xc).call(this,o,e,a,"GET")))();const r=this.getPath(o,{env:a}),s=this.router.match(i,r),l=new K0(o,{path:r,matchResult:s,env:a,executionCtx:e,notFoundHandler:n(this,Ct)});if(s[0].length===1){let c;try{c=s[0][0][0][0](l,async()=>{l.res=await n(this,Ct).call(this,l)})}catch(u){return T(this,_e,Zc).call(this,u,l)}return c instanceof Promise?c.then(u=>u||(l.finalized?l.res:n(this,Ct).call(this,l))).catch(u=>T(this,_e,Zc).call(this,u,l)):c??n(this,Ct).call(this,l)}const d=mm(s[0],this.errorHandler,n(this,Ct));return(async()=>{try{const c=await d(l);if(!c.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return c.res}catch(c){return T(this,_e,Zc).call(this,c,l)}})()},ig),bd="[^/]+",hn=".*",vn="(?:|/.*)",vr=Symbol(),J0=new Set(".\\+*[^]$()");function Q0(t,o){return t.length===1?o.length===1?t<o?-1:1:-1:o.length===1||t===hn||t===vn?1:o===hn||o===vn?-1:t===bd?1:o===bd?-1:t.length===o.length?t<o?-1:1:o.length-t.length}var qa,Ya,Rt,rg,Nu=(rg=class{constructor(){f(this,qa);f(this,Ya);f(this,Rt,Object.create(null))}insert(o,e,a,i,r){if(o.length===0){if(n(this,qa)!==void 0)throw vr;if(r)return;v(this,qa,e);return}const[s,...l]=o,d=s==="*"?l.length===0?["","",hn]:["","",bd]:s==="/*"?["","",vn]:s.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);let c;if(d){const u=d[1];let p=d[2]||bd;if(u&&d[2]&&(p===".*"||(p=p.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(p))))throw vr;if(c=n(this,Rt)[p],!c){if(Object.keys(n(this,Rt)).some(g=>g!==hn&&g!==vn))throw vr;if(r)return;c=n(this,Rt)[p]=new Nu,u!==""&&v(c,Ya,i.varIndex++)}!r&&u!==""&&a.push([u,n(c,Ya)])}else if(c=n(this,Rt)[s],!c){if(Object.keys(n(this,Rt)).some(u=>u.length>1&&u!==hn&&u!==vn))throw vr;if(r)return;c=n(this,Rt)[s]=new Nu}c.insert(l,e,a,i,r)}buildRegExpStr(){const e=Object.keys(n(this,Rt)).sort(Q0).map(a=>{const i=n(this,Rt)[a];return(typeof n(i,Ya)=="number"?`(${a})@${n(i,Ya)}`:J0.has(a)?`\\${a}`:a)+i.buildRegExpStr()});return typeof n(this,qa)=="number"&&e.unshift(`#${n(this,qa)}`),e.length===0?"":e.length===1?e[0]:"(?:"+e.join("|")+")"}},qa=new WeakMap,Ya=new WeakMap,Rt=new WeakMap,rg),Ld,Ln,sg,ev=(sg=class{constructor(){f(this,Ld,{varIndex:0});f(this,Ln,new Nu)}insert(t,o,e){const a=[],i=[];for(let s=0;;){let l=!1;if(t=t.replace(/\{[^}]+\}/g,d=>{const c=`@\\${s}`;return i[s]=[c,d],s++,l=!0,c}),!l)break}const r=t.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let s=i.length-1;s>=0;s--){const[l]=i[s];for(let d=r.length-1;d>=0;d--)if(r[d].indexOf(l)!==-1){r[d]=r[d].replace(l,i[s][1]);break}}return n(this,Ln).insert(r,o,a,n(this,Ld),e),a}buildRegExp(){let t=n(this,Ln).buildRegExpStr();if(t==="")return[/^$/,[],[]];let o=0;const e=[],a=[];return t=t.replace(/#(\d+)|@(\d+)|\.\*\$/g,(i,r,s)=>r!==void 0?(e[++o]=Number(r),"$()"):(s!==void 0&&(a[Number(s)]=++o),"")),[new RegExp(`^${t}`),e,a]}},Ld=new WeakMap,Ln=new WeakMap,sg),Og=[],tv=[/^$/,[],Object.create(null)],Jc=Object.create(null);function Dg(t){return Jc[t]??(Jc[t]=new RegExp(t==="*"?"":`^${t.replace(/\/\*$|([.\\+*[^\]$()])/g,(o,e)=>e?`\\${e}`:"(?:|/.*)")}$`))}function ov(){Jc=Object.create(null)}function av(t){var c;const o=new ev,e=[];if(t.length===0)return tv;const a=t.map(u=>[!/\*|\/:/.test(u[0]),...u]).sort(([u,p],[g,m])=>u?1:g?-1:p.length-m.length),i=Object.create(null);for(let u=0,p=-1,g=a.length;u<g;u++){const[m,b,h]=a[u];m?i[b]=[h.map(([w])=>[w,Object.create(null)]),Og]:p++;let E;try{E=o.insert(b,p,m)}catch(w){throw w===vr?new Cg(b):w}m||(e[p]=h.map(([w,S])=>{const C=Object.create(null);for(S-=1;S>=0;S--){const[R,z]=E[S];C[R]=z}return[w,C]}))}const[r,s,l]=o.buildRegExp();for(let u=0,p=e.length;u<p;u++)for(let g=0,m=e[u].length;g<m;g++){const b=(c=e[u][g])==null?void 0:c[1];if(!b)continue;const h=Object.keys(b);for(let E=0,w=h.length;E<w;E++)b[h[E]]=l[b[h[E]]]}const d=[];for(const u in s)d[u]=e[s[u]];return[r,d,i]}function mr(t,o){if(t){for(const e of Object.keys(t).sort((a,i)=>i.length-a.length))if(Dg(e).test(o))return[...t[e]]}}var Yo,Zo,Js,Mg,zg,ng,iv=(ng=class{constructor(){f(this,Js);O(this,"name","RegExpRouter");f(this,Yo);f(this,Zo);v(this,Yo,{[Ce]:Object.create(null)}),v(this,Zo,{[Ce]:Object.create(null)})}add(t,o,e){var l;const a=n(this,Yo),i=n(this,Zo);if(!a||!i)throw new Error(xg);a[t]||[a,i].forEach(d=>{d[t]=Object.create(null),Object.keys(d[Ce]).forEach(c=>{d[t][c]=[...d[Ce][c]]})}),o==="/*"&&(o="*");const r=(o.match(/\/:/g)||[]).length;if(/\*$/.test(o)){const d=Dg(o);t===Ce?Object.keys(a).forEach(c=>{var u;(u=a[c])[o]||(u[o]=mr(a[c],o)||mr(a[Ce],o)||[])}):(l=a[t])[o]||(l[o]=mr(a[t],o)||mr(a[Ce],o)||[]),Object.keys(a).forEach(c=>{(t===Ce||t===c)&&Object.keys(a[c]).forEach(u=>{d.test(u)&&a[c][u].push([e,r])})}),Object.keys(i).forEach(c=>{(t===Ce||t===c)&&Object.keys(i[c]).forEach(u=>d.test(u)&&i[c][u].push([e,r]))});return}const s=bg(o)||[o];for(let d=0,c=s.length;d<c;d++){const u=s[d];Object.keys(i).forEach(p=>{var g;(t===Ce||t===p)&&((g=i[p])[u]||(g[u]=[...mr(a[p],u)||mr(a[Ce],u)||[]]),i[p][u].push([e,r-c+d+1]))})}}match(t,o){ov();const e=T(this,Js,Mg).call(this);return this.match=(a,i)=>{const r=e[a]||e[Ce],s=r[2][i];if(s)return s;const l=i.match(r[0]);if(!l)return[[],Og];const d=l.indexOf("",1);return[r[1][d],l]},this.match(t,o)}},Yo=new WeakMap,Zo=new WeakMap,Js=new WeakSet,Mg=function(){const t=Object.create(null);return Object.keys(n(this,Zo)).concat(Object.keys(n(this,Yo))).forEach(o=>{t[o]||(t[o]=T(this,Js,zg).call(this,o))}),v(this,Yo,v(this,Zo,void 0)),t},zg=function(t){const o=[];let e=t===Ce;return[n(this,Yo),n(this,Zo)].forEach(a=>{const i=a[t]?Object.keys(a[t]).map(r=>[r,a[t][r]]):[];i.length!==0?(e||(e=!0),o.push(...i)):t!==Ce&&o.push(...Object.keys(a[Ce]).map(r=>[r,a[Ce][r]]))}),e?av(o):null},ng),Xo,mo,lg,rv=(lg=class{constructor(t){O(this,"name","SmartRouter");f(this,Xo,[]);f(this,mo,[]);v(this,Xo,t.routers)}add(t,o,e){if(!n(this,mo))throw new Error(xg);n(this,mo).push([t,o,e])}match(t,o){if(!n(this,mo))throw new Error("Fatal error");const e=n(this,Xo),a=n(this,mo),i=e.length;let r=0,s;for(;r<i;r++){const l=e[r];try{for(let d=0,c=a.length;d<c;d++)l.add(...a[d]);s=l.match(t,o)}catch(d){if(d instanceof Cg)continue;throw d}this.match=l.match.bind(l),v(this,Xo,[l]),v(this,mo,void 0);break}if(r===i)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,s}get activeRouter(){if(n(this,mo)||n(this,Xo).length!==1)throw new Error("No active router has been determined yet.");return n(this,Xo)[0]}},Xo=new WeakMap,mo=new WeakMap,lg),rn=Object.create(null),Jo,Ke,Za,Dr,Fe,go,ja,cg,Lg=(cg=class{constructor(o,e,a){f(this,go);f(this,Jo);f(this,Ke);f(this,Za);f(this,Dr,0);f(this,Fe,rn);if(v(this,Ke,a||Object.create(null)),v(this,Jo,[]),o&&e){const i=Object.create(null);i[o]={handler:e,possibleKeys:[],score:0},v(this,Jo,[i])}v(this,Za,[])}insert(o,e,a){v(this,Dr,++pr(this,Dr)._);let i=this;const r=B0(e),s=[];for(let l=0,d=r.length;l<d;l++){const c=r[l],u=r[l+1],p=$0(c,u),g=Array.isArray(p)?p[0]:c;if(g in n(i,Ke)){i=n(i,Ke)[g],p&&s.push(p[1]);continue}n(i,Ke)[g]=new Lg,p&&(n(i,Za).push(p),s.push(p[1])),i=n(i,Ke)[g]}return n(i,Jo).push({[o]:{handler:a,possibleKeys:s.filter((l,d,c)=>c.indexOf(l)===d),score:n(this,Dr)}}),i}search(o,e){var d;const a=[];v(this,Fe,rn);let r=[this];const s=vg(e),l=[];for(let c=0,u=s.length;c<u;c++){const p=s[c],g=c===u-1,m=[];for(let b=0,h=r.length;b<h;b++){const E=r[b],w=n(E,Ke)[p];w&&(v(w,Fe,n(E,Fe)),g?(n(w,Ke)["*"]&&a.push(...T(this,go,ja).call(this,n(w,Ke)["*"],o,n(E,Fe))),a.push(...T(this,go,ja).call(this,w,o,n(E,Fe)))):m.push(w));for(let S=0,C=n(E,Za).length;S<C;S++){const R=n(E,Za)[S],z=n(E,Fe)===rn?{}:{...n(E,Fe)};if(R==="*"){const N=n(E,Ke)["*"];N&&(a.push(...T(this,go,ja).call(this,N,o,n(E,Fe))),v(N,Fe,z),m.push(N));continue}const[D,F,L]=R;if(!p&&!(L instanceof RegExp))continue;const M=n(E,Ke)[D],j=s.slice(c).join("/");if(L instanceof RegExp){const N=L.exec(j);if(N){if(z[F]=N[0],a.push(...T(this,go,ja).call(this,M,o,n(E,Fe),z)),Object.keys(n(M,Ke)).length){v(M,Fe,z);const A=((d=N[0].match(/\//))==null?void 0:d.length)??0;(l[A]||(l[A]=[])).push(M)}continue}}(L===!0||L.test(p))&&(z[F]=p,g?(a.push(...T(this,go,ja).call(this,M,o,z,n(E,Fe))),n(M,Ke)["*"]&&a.push(...T(this,go,ja).call(this,n(M,Ke)["*"],o,z,n(E,Fe)))):(v(M,Fe,z),m.push(M)))}}r=m.concat(l.shift()??[])}return a.length>1&&a.sort((c,u)=>c.score-u.score),[a.map(({handler:c,params:u})=>[c,u])]}},Jo=new WeakMap,Ke=new WeakMap,Za=new WeakMap,Dr=new WeakMap,Fe=new WeakMap,go=new WeakSet,ja=function(o,e,a,i){const r=[];for(let s=0,l=n(o,Jo).length;s<l;s++){const d=n(o,Jo)[s],c=d[e]||d[Ce],u={};if(c!==void 0&&(c.params=Object.create(null),r.push(c),a!==rn||i&&i!==rn))for(let p=0,g=c.possibleKeys.length;p<g;p++){const m=c.possibleKeys[p],b=u[c.score];c.params[m]=i!=null&&i[m]&&!b?i[m]:a[m]??(i==null?void 0:i[m]),u[c.score]=!0}}return r},cg),Xa,dg,sv=(dg=class{constructor(){O(this,"name","TrieRouter");f(this,Xa);v(this,Xa,new Lg)}add(t,o,e){const a=bg(o);if(a){for(let i=0,r=a.length;i<r;i++)n(this,Xa).insert(t,a[i],e);return}n(this,Xa).insert(t,o,e)}match(t,o){return n(this,Xa).search(t,o)}},Xa=new WeakMap,dg),Ng=class extends Rg{constructor(t={}){super(t),this.router=t.router??new rv({routers:[new iv,new sv]})}},nv=t=>{const e={...{origin:"*",allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],allowHeaders:[],exposeHeaders:[]},...t},a=(r=>typeof r=="string"?r==="*"?()=>r:s=>r===s?s:null:typeof r=="function"?r:s=>r.includes(s)?s:null)(e.origin),i=(r=>typeof r=="function"?r:Array.isArray(r)?()=>r:()=>[])(e.allowMethods);return async function(s,l){var u;function d(p,g){s.res.headers.set(p,g)}const c=await a(s.req.header("origin")||"",s);if(c&&d("Access-Control-Allow-Origin",c),e.origin!=="*"){const p=s.req.header("Vary");p?d("Vary",p):d("Vary","Origin")}if(e.credentials&&d("Access-Control-Allow-Credentials","true"),(u=e.exposeHeaders)!=null&&u.length&&d("Access-Control-Expose-Headers",e.exposeHeaders.join(",")),s.req.method==="OPTIONS"){e.maxAge!=null&&d("Access-Control-Max-Age",e.maxAge.toString());const p=await i(s.req.header("origin")||"",s);p.length&&d("Access-Control-Allow-Methods",p.join(","));let g=e.allowHeaders;if(!(g!=null&&g.length)){const m=s.req.header("Access-Control-Request-Headers");m&&(g=m.split(/\s*,\s*/))}return g!=null&&g.length&&(d("Access-Control-Allow-Headers",g.join(",")),s.res.headers.append("Vary","Access-Control-Request-Headers")),s.res.headers.delete("Content-Length"),s.res.headers.delete("Content-Type"),new Response(null,{headers:s.res.headers,status:204,statusText:"No Content"})}await l()}},lv=/^\s*(?:text\/(?!event-stream(?:[;\s]|$))[^;\s]+|application\/(?:javascript|json|xml|xml-dtd|ecmascript|dart|postscript|rtf|tar|toml|vnd\.dart|vnd\.ms-fontobject|vnd\.ms-opentype|wasm|x-httpd-php|x-javascript|x-ns-proxy-autoconfig|x-sh|x-tar|x-virtualbox-hdd|x-virtualbox-ova|x-virtualbox-ovf|x-virtualbox-vbox|x-virtualbox-vdi|x-virtualbox-vhd|x-virtualbox-vmdk|x-www-form-urlencoded)|font\/(?:otf|ttf)|image\/(?:bmp|vnd\.adobe\.photoshop|vnd\.microsoft\.icon|vnd\.ms-dds|x-icon|x-ms-bmp)|message\/rfc822|model\/gltf-binary|x-shader\/x-fragment|x-shader\/x-vertex|[^;\s]+?\+(?:json|text|xml|yaml))(?:[;\s]|$)/i,hm=(t,o=dv)=>{const e=/\.([a-zA-Z0-9]+?)$/,a=t.match(e);if(!a)return;let i=o[a[1]];return i&&i.startsWith("text")&&(i+="; charset=utf-8"),i},cv={aac:"audio/aac",avi:"video/x-msvideo",avif:"image/avif",av1:"video/av1",bin:"application/octet-stream",bmp:"image/bmp",css:"text/css",csv:"text/csv",eot:"application/vnd.ms-fontobject",epub:"application/epub+zip",gif:"image/gif",gz:"application/gzip",htm:"text/html",html:"text/html",ico:"image/x-icon",ics:"text/calendar",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json",jsonld:"application/ld+json",map:"application/json",mid:"audio/x-midi",midi:"audio/x-midi",mjs:"text/javascript",mp3:"audio/mpeg",mp4:"video/mp4",mpeg:"video/mpeg",oga:"audio/ogg",ogv:"video/ogg",ogx:"application/ogg",opus:"audio/opus",otf:"font/otf",pdf:"application/pdf",png:"image/png",rtf:"application/rtf",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",ts:"video/mp2t",ttf:"font/ttf",txt:"text/plain",wasm:"application/wasm",webm:"video/webm",weba:"audio/webm",webmanifest:"application/manifest+json",webp:"image/webp",woff:"font/woff",woff2:"font/woff2",xhtml:"application/xhtml+xml",xml:"application/xml",zip:"application/zip","3gp":"video/3gpp","3g2":"video/3gpp2",gltf:"model/gltf+json",glb:"model/gltf-binary"},dv=cv,uv=(...t)=>{let o=t.filter(i=>i!=="").join("/");o=o.replace(new RegExp("(?<=\\/)\\/+","g"),"");const e=o.split("/"),a=[];for(const i of e)i===".."&&a.length>0&&a.at(-1)!==".."?a.pop():i!=="."&&a.push(i);return a.join("/")||"."},Pg={br:".br",zstd:".zst",gzip:".gz"},pv=Object.keys(Pg),mv="index.html",gv=t=>{const o=t.root??"./",e=t.path,a=t.join??uv;return async(i,r)=>{var u,p,g,m;if(i.finalized)return r();let s;if(t.path)s=t.path;else try{if(s=decodeURIComponent(i.req.path),/(?:^|[\/\\])\.\.(?:$|[\/\\])/.test(s))throw new Error}catch{return await((u=t.onNotFound)==null?void 0:u.call(t,i.req.path,i)),r()}let l=a(o,!e&&t.rewriteRequestPath?t.rewriteRequestPath(s):s);t.isDir&&await t.isDir(l)&&(l=a(l,mv));const d=t.getContent;let c=await d(l,i);if(c instanceof Response)return i.newResponse(c.body,c);if(c){const b=t.mimes&&hm(l,t.mimes)||hm(l);if(i.header("Content-Type",b||"application/octet-stream"),t.precompressed&&(!b||lv.test(b))){const h=new Set((p=i.req.header("Accept-Encoding"))==null?void 0:p.split(",").map(E=>E.trim()));for(const E of pv){if(!h.has(E))continue;const w=await d(l+Pg[E],i);if(w){c=w,i.header("Content-Encoding",E),i.header("Vary","Accept-Encoding",{append:!0});break}}}return await((g=t.onFound)==null?void 0:g.call(t,l,i)),i.body(c)}await((m=t.onNotFound)==null?void 0:m.call(t,l,i)),await r()}},fv=async(t,o)=>{let e;o&&o.manifest?typeof o.manifest=="string"?e=JSON.parse(o.manifest):e=o.manifest:typeof __STATIC_CONTENT_MANIFEST=="string"?e=JSON.parse(__STATIC_CONTENT_MANIFEST):e=__STATIC_CONTENT_MANIFEST;let a;o&&o.namespace?a=o.namespace:a=__STATIC_CONTENT;const i=e[t]||t;if(!i)return null;const r=await a.get(i,{type:"stream"});return r||null},hv=t=>async function(e,a){return gv({...t,getContent:async r=>fv(r,{manifest:t.manifest,namespace:t.namespace?t.namespace:e.env?e.env.__STATIC_CONTENT:void 0})})(e,a)},Up=t=>hv(t);const Qc={INVIO_CONTRATTO:{id:"invio_contratto",name:"Invio Contratto",subject:"üìã TeleMedCare - Il tuo contratto √® pronto!",htmlPath:"/templates/email/email_invio_contratto.html",variables:["NOME_CLIENTE","PIANO_SERVIZIO","PREZZO_PIANO","CODICE_CLIENTE"],category:"workflow"},INVIO_PROFORMA:{id:"invio_proforma",name:"Invio Proforma",subject:"üí∞ TeleMedCare - Fattura Proforma per {{PIANO_SERVIZIO}}",htmlPath:"/templates/email/email_invio_proforma.html",variables:["NOME_CLIENTE","PIANO_SERVIZIO","IMPORTO_TOTALE","SCADENZA_PAGAMENTO","CODICE_CLIENTE"],category:"workflow"},BENVENUTO:{id:"benvenuto",name:"Benvenuto Cliente",subject:"üéâ Benvenuto/a in TeleMedCare, {{NOME_CLIENTE}}!",htmlPath:"/templates/email/email_benvenuto.html",variables:["NOME_CLIENTE","PIANO_SERVIZIO","COSTO_SERVIZIO","DATA_ATTIVAZIONE","CODICE_CLIENTE","SERVIZI_INCLUSI"],category:"workflow"},CONFIGURAZIONE:{id:"configurazione",name:"Configurazione Dispositivo",subject:"‚öôÔ∏è TeleMedCare - Configurazione del tuo dispositivo",htmlPath:"/templates/email/email_conferma_attivazione.html",variables:["NOME_CLIENTE","DISPOSITIVO","SERIAL_NUMBER","ISTRUZIONI_CONFIG"],category:"workflow"},CONFERMA:{id:"conferma",name:"Conferma Attivazione",subject:"‚úÖ TeleMedCare - Servizio attivato con successo!",htmlPath:"/templates/email/email_conferma_attivazione.html",variables:["NOME_CLIENTE","PIANO_SERVIZIO","DATA_ATTIVAZIONE","CODICE_CLIENTE"],category:"workflow"},FOLLOWUP_CALL:{id:"followup_call",name:"Follow-up Call",subject:"üìû TeleMedCare - Chiamata di follow-up programmata",htmlPath:"/templates/email/email_followup_call.html",variables:["NOME_CLIENTE","DATA_CHIAMATA","ORA_CHIAMATA","MOTIVO_CHIAMATA"],category:"workflow"},NOTIFICA_INFO:{id:"notifica_info",name:"Notifica Nuovo Lead",subject:"üö® TeleMedCare - Nuovo Lead ricevuto: {{NOME_CLIENTE}}",htmlPath:"/templates/email/email_notifica_info.html",variables:["NOME_CLIENTE","EMAIL_CLIENTE","TELEFONO_CLIENTE","SERVIZIO_RICHIESTO","TIMESTAMP_LEAD","LEAD_ID"],category:"notification"},DOCUMENTI_INFORMATIVI:{id:"documenti_informativi",name:"Invio Documenti Informativi",subject:"üìã TeleMedCare - Documentazione richiesta per {{NOME_CLIENTE}}",htmlPath:"/templates/email/email_documenti_informativi.html",variables:["NOME_CLIENTE","EMAIL_CLIENTE","DOCUMENTI_RICHIESTI","SERVIZIO_INTERESSE","TIMESTAMP_RICHIESTA"],category:"workflow"}};class wr{static render(o,e){let a=o;for(const[i,r]of Object.entries(e)){const s=new RegExp(`{{${i}}}`,"g");a=a.replace(s,String(r))}return a=a.replace(/{{[^}]+}}/g,""),a}static renderSubject(o,e){return this.render(o,e)}static htmlToText(o){return o.replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/\s+/g," ").trim()}}const Va=class Va{constructor(o){O(this,"env");this.env=o}static getInstance(){return Va.instance||(Va.instance=new Va),Va.instance}async sendEmail(o){var a;const e={to:o.to,from:o.from,subject:o.subject,html:o.html,text:o.text,attachments:(a=o.attachments)==null?void 0:a.map(i=>({filename:i.filename,content:i.content||"",contentType:i.contentType||"application/octet-stream"}))};return this.sendEmailInternal(e,this.env)}async sendTemplateEmail(o,e,a,i,r){try{const s=Qc[o.toUpperCase()];if(!s)throw new Error(`Template ${o} non trovato`);const l=await this.loadTemplate(s.htmlPath),d=wr.render(l,a),c=wr.renderSubject(s.subject,a),u=wr.htmlToText(d),p={to:e,subject:c,html:d,text:u,attachments:i};return await this.sendEmailInternal(p,r)}catch(s){return console.error("‚ùå Errore invio email template:",s),{success:!1,error:s instanceof Error?s.message:"Errore sconosciuto",timestamp:new Date().toISOString()}}}async loadTemplate(o){try{return console.log(`üìß Uso template embedded per: ${o}`),this.getEmbeddedTemplate(o)}catch(e){throw console.error(`‚ùå Errore caricamento template ${o}:`,e),e}}getEmbeddedTemplate(o){var a;switch((a=o.split("/").pop())==null?void 0:a.replace(".html","")){case"email_invio_contratto":return`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>TeleMedCare - Contratto</title></head>
<body style="font-family:Arial,sans-serif;margin:0;padding:20px;background:#f4f6f8;">
<div style="max-width:600px;margin:0 auto;background:white;border-radius:6px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
<div style="background:#0b63a5;color:white;padding:20px;"><h1 style="margin:0;font-size:20px;">üìã TeleMedCare</h1></div>
<div style="padding:24px;">
<p>Gentile <strong>{{NOME_CLIENTE}}</strong>,</p>
<p>Siamo lieti di accompagnarLa in questo importante passo verso una maggiore sicurezza e tranquillit√†. Come promesso, in allegato trova la brochure del dispositivo prescelto con tutti i dettagli delle sue caratteristiche innovative nonch√© il contratto per il servizio {{PIANO_SERVIZIO}} che ha selezionato tra le sue preferenze.</p>

<div style="background:#e6f7ff;border:1px solid #91d5ff;padding:16px;border-radius:6px;margin:16px 0;">
<h3 style="margin:0 0 8px;color:#1890ff;">üìò Brochure Dispositivo</h3>
<p style="margin:4px 0;">Trova in allegato la brochure completa con tutte le caratteristiche tecniche e innovative del dispositivo.</p>
</div>

<div style="background:#f8fbff;border:1px solid #e6f0fa;padding:16px;border-radius:6px;margin:16px 0;">
<h3 style="margin:0 0 8px;color:#0b63a5;">üìã Contratto Servizio</h3>
<strong>Piano:</strong> {{PIANO_SERVIZIO}}<br>
<strong>Investimento:</strong> {{PREZZO_PIANO}}<br>
<strong>Codice Cliente:</strong> {{CODICE_CLIENTE}}
</div>

<h3 style="color:#0b63a5;">üöÄ Prossimi passi per l'attivazione:</h3>

<div style="background:#fff7e6;border-left:4px solid #ffa940;padding:12px 16px;margin:12px 0;">
<p style="margin:0;font-weight:bold;color:#d46b08;">Opzione 1: Firma Elettronica (Consigliata)</p>
<ol style="margin:8px 0 0 18px;padding:0;">
<li>Dopo averlo letto ed esaminato, firmi in modo elettronico il contratto (usando il mouse del PC o il dito su tablet o sul cellulare)</li>
<li>Prema invio per conferma e ricever√† rapidamente la proforma con tutte le informazioni per effettuare il bonifico</li>
</ol>
</div>

<div style="background:#f6ffed;border-left:4px solid #52c41a;padding:12px 16px;margin:12px 0;">
<p style="margin:0;font-weight:bold;color:#389e0d;">Oppure - Opzione 2: Firma Cartacea</p>
<ol style="margin:8px 0 0 18px;padding:0;">
<li>Provveda a stampare e leggere attentamente il contratto allegato</li>
<li>Firmi in ogni pagina richiesta e nell'ultima pagina</li>
<li>Ci invii il contratto firmato via email o WhatsApp</li>
<li>Appena possibile ricever√† la proforma con tutte le informazioni per effettuare il bonifico</li>
</ol>
</div>

<p style="margin-top:16px;padding:12px;background:#fafafa;border-radius:6px;"><strong>üì¶ Consegna:</strong> In ogni caso ricever√† il dispositivo entro 10 giorni lavorativi dall'arrivo del pagamento.</p>

<p style="margin-top:20px;"><strong>Grazie per la fiducia!</strong><br>Il Team TeleMedCare</p>
</div></div></body></html>`;case"email_invio_proforma":return`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>TeleMedCare - Proforma</title></head>
<body style="font-family:Arial,sans-serif;margin:0;padding:20px;background:#f4f6f8;">
<div style="max-width:600px;margin:0 auto;background:white;border-radius:6px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
<div style="background:#10b981;color:white;padding:20px;"><h1 style="margin:0;font-size:20px;">üí∞ TeleMedCare</h1></div>
<div style="padding:24px;">
<p>Gentile <strong>{{NOME_CLIENTE}}</strong>,</p>
<p>In allegato trova la <strong>fattura proforma</strong> per il servizio {{PIANO_SERVIZIO}}.</p>
<div style="background:#f0fdf4;border:1px solid #dcfce7;padding:16px;border-radius:6px;margin:16px 0;">
<h3 style="margin:0 0 8px;color:#10b981;">üí≥ Dettagli Pagamento</h3>
<strong>Piano:</strong> {{PIANO_SERVIZIO}}<br>
<strong>Importo Totale:</strong> {{IMPORTO_TOTALE}}<br>
<strong>Scadenza Pagamento:</strong> {{SCADENZA_PAGAMENTO}}<br>
<strong>Codice Cliente:</strong> {{CODICE_CLIENTE}}
</div>
<p>Pu√≤ procedere con il pagamento tramite bonifico bancario utilizzando i dati allegati.</p>
<p style="margin-top:20px;"><strong>Grazie!</strong><br>Il Team TeleMedCare</p>
</div></div></body></html>`;case"email_benvenuto":return`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Benvenuto in TeleMedCare</title></head>
<body style="font-family:Arial,sans-serif;margin:0;padding:20px;background:#f4f6f8;">
<div style="max-width:600px;margin:0 auto;background:white;border-radius:6px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
<div style="background:#0b6cf6;color:white;padding:20px;"><h1 style="margin:0;font-size:20px;">üéâ TeleMedCare</h1></div>
<div style="padding:24px;">
<h1>Benvenuto/a {{NOME_CLIENTE}}!</h1>
<p style="font-size:18px;">üéâ Congratulazioni per la Sua scelta!</p>
<p>Ha scelto il nostro servizio <strong>{{PIANO_SERVIZIO}}</strong> e ora fa parte della famiglia TeleMedCare.</p>
<div style="background:#f7f9fc;border:1px solid #eef2f7;padding:16px;border-radius:6px;margin:16px 0;">
<h3 style="margin:0 0 8px;color:#0b6cf6;">üìã Il Suo Servizio</h3>
<strong>Piano:</strong> {{PIANO_SERVIZIO}}<br>
<strong>Costo:</strong> {{COSTO_SERVIZIO}}<br>
<strong>Data Attivazione:</strong> {{DATA_ATTIVAZIONE}}<br>
<strong>Codice Cliente:</strong> {{CODICE_CLIENTE}}
</div>
<h3 style="color:#0b6cf6;">üöÄ Prossimi Passi:</h3>
<ol style="margin-left:18px;">
<li><strong>Consegna:</strong> Dispositivo entro 10 giorni</li>
<li><strong>Configurazione:</strong> Email per setup personalizzato</li>
<li><strong>Training:</strong> Tutorial gratuito</li>
<li><strong>Attivazione:</strong> Test completo con la Centrale</li>
</ol>
<p style="margin-top:20px;"><strong>Benvenuto/a nella famiglia TeleMedCare!</strong><br>Il Team TeleMedCare</p>
</div></div></body></html>`;case"email_conferma_attivazione":return`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Servizio Attivato</title></head>
<body style="font-family:Arial,sans-serif;margin:0;padding:20px;background:#f4f6f8;">
<div style="max-width:600px;margin:0 auto;background:white;border-radius:6px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
<div style="background:#10b981;color:white;padding:20px;"><h1 style="margin:0;font-size:20px;">‚úÖ TeleMedCare</h1></div>
<div style="padding:24px;">
<h1>Servizio Attivato!</h1>
<p>Gentile <strong>{{NOME_CLIENTE}}</strong>,</p>
<p>Il Suo servizio <strong>{{PIANO_SERVIZIO}}</strong> √® stato attivato con successo!</p>
<div style="background:#f0fdf4;border:1px solid #dcfce7;padding:16px;border-radius:6px;margin:16px 0;">
<h3 style="margin:0 0 8px;color:#10b981;">‚úÖ Configurazione Completata</h3>
<strong>Dispositivo:</strong> {{DISPOSITIVO}}<br>
<strong>Serial Number:</strong> {{SERIAL_NUMBER}}<br>
<strong>Data Attivazione:</strong> {{DATA_ATTIVAZIONE}}<br>
<strong>Codice Cliente:</strong> {{CODICE_CLIENTE}}
</div>
<p>Il Suo dispositivo √® ora operativo e monitorato H24.</p>
<p style="margin-top:20px;"><strong>La Sua sicurezza √® la nostra priorit√†!</strong><br>Il Team TeleMedCare</p>
</div></div></body></html>`;case"email_followup_call":return`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Follow-up Call</title></head>
<body style="font-family:Arial,sans-serif;margin:0;padding:20px;background:#f4f6f8;">
<div style="max-width:600px;margin:0 auto;background:white;border-radius:6px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
<div style="background:#f59e0b;color:white;padding:20px;"><h1 style="margin:0;font-size:20px;">üìû TeleMedCare</h1></div>
<div style="padding:24px;">
<h1>Chiamata di Follow-up</h1>
<p>Gentile <strong>{{NOME_CLIENTE}}</strong>,</p>
<p>Abbiamo programmato una chiamata di follow-up per verificare il corretto funzionamento del servizio.</p>
<div style="background:#fffbeb;border:1px solid #fef3c7;padding:16px;border-radius:6px;margin:16px 0;">
<h3 style="margin:0 0 8px;color:#f59e0b;">üìÖ Dettagli Chiamata</h3>
<strong>Data:</strong> {{DATA_CHIAMATA}}<br>
<strong>Orario:</strong> {{ORA_CHIAMATA}}<br>
<strong>Motivo:</strong> {{MOTIVO_CHIAMATA}}
</div>
<p>Se non dovesse essere disponibile, La ricontatteremo.</p>
<p style="margin-top:20px;"><strong>Grazie!</strong><br>Il Team TeleMedCare</p>
</div></div></body></html>`;case"email_notifica_info":return`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Nuovo Lead TeleMedCare</title></head>
<body style="font-family:Arial,sans-serif;margin:0;padding:20px;background:#f4f6f8;">
<div style="max-width:600px;margin:0 auto;background:white;border-radius:6px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
<div style="background:#dc2626;color:white;padding:20px;"><h1 style="margin:0;font-size:20px;">üö® TeleMedCare - NUOVO LEAD</h1></div>
<div style="padding:24px;">
<h1 style="color:#dc2626;">Nuovo Lead Ricevuto!</h1>
<p><strong>Un nuovo potenziale cliente ha manifestato interesse per i nostri servizi.</strong></p>
<div style="background:#fef2f2;border:1px solid #fecaca;padding:16px;border-radius:6px;margin:16px 0;">
<h3 style="margin:0 0 8px;color:#dc2626;">üë§ Dati Cliente</h3>
<strong>Nome:</strong> {{NOME_CLIENTE}}<br>
<strong>Email:</strong> {{EMAIL_CLIENTE}}<br>
<strong>Telefono:</strong> {{TELEFONO_CLIENTE}}<br>
<strong>Servizio richiesto:</strong> {{SERVIZIO_RICHIESTO}}<br>
<strong>Data/Ora:</strong> {{TIMESTAMP_LEAD}}<br>
<strong>Lead ID:</strong> {{LEAD_ID}}
</div>
<h3 style="color:#dc2626;">‚ö° Azioni Immediate Richieste:</h3>
<ol style="margin-left:18px;color:#374151;">
<li><strong>Contattare entro 30 minuti</strong> per massimizzare conversione</li>
<li><strong>Verificare interesse</strong> e necessit√† specifiche</li>
<li><strong>Inviare documentazione</strong> personalizzata</li>
<li><strong>Programmare demo</strong> se richiesta</li>
</ol>
<p style="margin-top:20px;"><strong>Priorit√† ALTA - Gestire immediatamente!</strong><br>Sistema TeleMedCare V11.0</p>
</div></div></body></html>`;case"email_documenti_informativi":return`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Documenti Informativi TeleMedCare</title></head>
<body style="font-family:Arial,sans-serif;margin:0;padding:20px;background:#f4f6f8;">
<div style="max-width:600px;margin:0 auto;background:white;border-radius:6px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
<div style="background:#0ea5e9;color:white;padding:20px;"><h1 style="margin:0;font-size:20px;">üìã TeleMedCare</h1></div>
<div style="padding:24px;">
<h1>Invio Documenti Informativi</h1>
<p>Team TeleMedCare,</p>
<p><strong>{{NOME_CLIENTE}}</strong> ha richiesto documentazione informativa sui nostri servizi.</p>
<div style="background:#f0f9ff;border:1px solid #bae6fd;padding:16px;border-radius:6px;margin:16px 0;">
<h3 style="margin:0 0 8px;color:#0ea5e9;">üìã Dettagli Richiesta</h3>
<strong>Cliente:</strong> {{NOME_CLIENTE}}<br>
<strong>Email:</strong> {{EMAIL_CLIENTE}}<br>
<strong>Documenti richiesti:</strong> {{DOCUMENTI_RICHIESTI}}<br>
<strong>Servizio di interesse:</strong> {{SERVIZIO_INTERESSE}}<br>
<strong>Data richiesta:</strong> {{TIMESTAMP_RICHIESTA}}
</div>
<h3 style="color:#0ea5e9;">üìã Azioni da Completare:</h3>
<ol style="margin-left:18px;color:#374151;">
<li><strong>Inviare brochure</strong> del servizio richiesto</li>
<li><strong>Allegare listino prezzi</strong> aggiornato</li>
<li><strong>Includere case studies</strong> pertinenti</li>
<li><strong>Programmare follow-up</strong> a 3-5 giorni</li>
</ol>
<p style="margin-top:20px;"><strong>Da gestire entro 4 ore lavorative</strong><br>Sistema TeleMedCare V11.0</p>
</div></div></body></html>`;default:return`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>TeleMedCare</title></head>
<body style="font-family:Arial,sans-serif;padding:20px;text-align:center;">
<h1 style="color:#0b63a5;">üìß TeleMedCare</h1>
<p>Template email non disponibile.</p>
<p>Contatti il supporto per assistenza.</p>
</body></html>`}}async sendEmailInternal(o,e){var a;try{console.log("üìß Invio email reale:",{to:o.to,subject:o.subject,attachments:((a=o.attachments)==null?void 0:a.length)||0,hasEnv:!!e,hasResend:!!(e!=null&&e.RESEND_API_KEY)});let i=null,r=null;try{console.log("üìß [PRIMARY] Tentativo Resend...");const s=await this.sendWithResend(o,e);if(s.success)return console.log("‚úÖ Email inviata con successo via Resend:",s.messageId),s;console.warn("‚ö†Ô∏è Resend non ha avuto successo:",s),i=s.error||"Unknown error"}catch(s){i=s,console.error("‚ùå Resend exception:",s)}try{console.log("üìß [FALLBACK] Tentativo SendGrid...");const s=await this.sendWithSendGrid(o,e);if(s.success)return console.log("‚úÖ Email inviata con successo via SendGrid:",s.messageId),s;console.warn("‚ö†Ô∏è SendGrid non ha avuto successo:",s),r=s.error||"Unknown error"}catch(s){r=s,console.error("‚ùå SendGrid exception:",s)}return console.error("üö®üö®üö® TUTTI I PROVIDER FALLITI - MODALIT√Ä DEMO ATTIVA üö®üö®üö®"),console.error("üìß Email destinatario:",o.to),console.error("üìß Oggetto:",o.subject),console.error("‚ùå Resend error:",i),console.error("‚ùå SendGrid error:",r),console.error("üîë RESEND_API_KEY presente?",!!(e!=null&&e.RESEND_API_KEY)),console.error("üîë SENDGRID_API_KEY presente?",!!(e!=null&&e.SENDGRID_API_KEY)),{success:!0,messageId:`DEMO_${Date.now()}_${Math.random().toString(36).substring(2)}`,timestamp:new Date().toISOString(),warning:"‚ö†Ô∏è DEMO MODE: Email NON inviata realmente! Configura RESEND_API_KEY o SENDGRID_API_KEY",demoMode:!0,errors:{resend:(i==null?void 0:i.message)||String(i),sendgrid:(r==null?void 0:r.message)||String(r)}}}catch(i){return{success:!1,error:i instanceof Error?i.message:"Errore invio email",timestamp:new Date().toISOString()}}}async sendWithSendGrid(o,e){var l;const a=(e==null?void 0:e.SENDGRID_API_KEY)||"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";console.log("üìß SendGrid: Using API key:",`${a.substring(0,10)}...`),console.log("üìß SendGrid: From:",o.from||"info@telemedcare.it"),console.log("üìß SendGrid: To:",o.to);const i={personalizations:[{to:[{email:o.to}],subject:o.subject}],from:{name:"TeleMedCare",email:o.from||"info@telemedcare.it"},content:[{type:"text/html",value:o.html}],attachments:(l=o.attachments)==null?void 0:l.map(d=>({filename:d.filename,content:typeof d.content=="string"?d.content:Buffer.from(d.content).toString("base64"),type:d.contentType,disposition:"attachment"}))};console.log("üìß SendGrid: Sending request...");const r=await fetch("https://api.sendgrid.com/v3/mail/send",{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify(i)});if(console.log("üìß SendGrid: Response status:",r.status),!r.ok){const d=await r.text();throw console.error("‚ùå SendGrid error response:",d),new Error(`SendGrid API error: ${r.status} ${d}`)}return{success:!0,messageId:r.headers.get("X-Message-Id")||"sendgrid-"+Date.now(),timestamp:new Date().toISOString()}}async sendWithResend(o,e){var d;const a=e==null?void 0:e.RESEND_API_KEY;if(!a)throw console.error("‚ùå RESEND_API_KEY non configurata!"),new Error("RESEND_API_KEY non configurata in Cloudflare Pages");console.log("üìß Resend: Using API key:",a?`${a.substring(0,10)}...`:"NONE");const r={from:`TeleMedCare <${o.from||"info@telemedcare.it"}>`,to:[o.to],subject:o.subject,html:o.html,text:o.text,attachments:(d=o.attachments)==null?void 0:d.map(c=>({filename:c.filename,content:c.content,content_type:c.contentType}))},s=await fetch("https://api.resend.com/emails",{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify(r)});if(!s.ok){const c=await s.text();throw new Error(`Resend API error: ${s.status} ${c}`)}return{success:!0,messageId:(await s.json()).id,timestamp:new Date().toISOString()}}async sendWorkflowEmails(o){const e=[];for(const a of o){const i=await this.sendTemplateEmail(a.templateId,a.to,a.variables,a.attachments);e.push(i),await new Promise(r=>setTimeout(r,100))}return e}getAllTemplates(){return Qc}getTemplate(o){return Qc[o.toUpperCase()]||null}};O(Va,"instance",null);let Xe=Va;const At=Object.freeze(Object.defineProperty({__proto__:null,EMAIL_TEMPLATES:Qc,EmailService:Xe,TemplateEngine:wr,default:Xe},Symbol.toStringTag,{value:"Module"}));async function ou(t,o,e){try{if(console.log(`üîî [NOTIFICATION] Inizio invio notifica per lead ${t}`),console.log("üîî [NOTIFICATION] Lead data:",JSON.stringify(o,null,2)),e!=null&&e.DB){console.log("üîî [NOTIFICATION] Controllo switch admin_email_notifications_enabled...");const h=await e.DB.prepare("SELECT value FROM settings WHERE key = ?").bind("admin_email_notifications_enabled").first();if(console.log("üîî [NOTIFICATION] Switch value:",h==null?void 0:h.value),(h==null?void 0:h.value)!=="true"){console.log(`‚è≠Ô∏è [NOTIFICATION] Notifiche admin disabilitate, skip email per lead ${t}`);return}console.log("‚úÖ [NOTIFICATION] Switch attivo, procedo con invio email")}else console.warn("‚ö†Ô∏è [NOTIFICATION] Database non disponibile, procedo comunque con invio email");console.log("üìß [NOTIFICATION] Creazione EmailService...");const a=new Xe(e);console.log("üìß [NOTIFICATION] EmailService creato, preparo dati email...");const i=o.nomeRichiedente||"N/A",r=o.cognomeRichiedente||"",s=o.email||"N/A",l=o.telefono||"Non fornito",d=o.citta||"Non fornita",c=o.servizio||"eCura PRO",u=o.piano||"BASE",p=o.fonte||"N/A",g=o.note||"",m=o.created_at?new Date(o.created_at).toLocaleString("it-IT"):new Date().toLocaleString("it-IT");console.log(`üìß [NOTIFICATION] Invio email a ${(e==null?void 0:e.EMAIL_TO_INFO)||"info@telemedcare.it"}...`),console.log(`üìß [NOTIFICATION] Subject: üÜï Nuovo Lead: ${i} ${r} - ${u}`);const b=await a.sendEmail({to:(e==null?void 0:e.EMAIL_TO_INFO)||"info@telemedcare.it",from:(e==null?void 0:e.EMAIL_FROM)||"info@telemedcare.it",subject:`üÜï Nuovo Lead: ${i} ${r} - ${u}`,html:`
        <!DOCTYPE html>
        <html lang="it">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Nuovo Lead TeleMedCare</title>
        </head>
        <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
            <h1 style="color: white; margin: 0; font-size: 28px;">üÜï Nuovo Lead TeleMedCare</h1>
          </div>
          
          <div style="background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px;">
            <p style="font-size: 16px; margin-bottom: 20px;"><strong>Richiesta ricevuta:</strong> ${m}</p>
            
            <h2 style="color: #667eea; margin-top: 30px;">üë§ Dati Richiedente</h2>
            <table style="width: 100%; border-collapse: collapse;">
              <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px; font-weight: bold;">Nome:</td>
                <td style="padding: 10px;">${i} ${r}</td>
              </tr>
              <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px; font-weight: bold;">Email:</td>
                <td style="padding: 10px;"><a href="mailto:${s}">${s}</a></td>
              </tr>
              <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px; font-weight: bold;">Telefono:</td>
                <td style="padding: 10px;">${l}</td>
              </tr>
              <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px; font-weight: bold;">Citt√†:</td>
                <td style="padding: 10px;">${d}</td>
              </tr>
            </table>
            
            <h2 style="color: #667eea; margin-top: 30px;">üìã Dettagli Servizio</h2>
            <table style="width: 100%; border-collapse: collapse;">
              <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px; font-weight: bold;">Servizio:</td>
                <td style="padding: 10px;">${c}</td>
              </tr>
              <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px; font-weight: bold;">Piano:</td>
                <td style="padding: 10px;">${u}</td>
              </tr>
              <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px; font-weight: bold;">Fonte:</td>
                <td style="padding: 10px;">${p}</td>
              </tr>
              <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px; font-weight: bold;">Lead ID:</td>
                <td style="padding: 10px;"><code>${t}</code></td>
              </tr>
            </table>
            
            ${g?`
            <h2 style="color: #667eea; margin-top: 30px;">üìù Note</h2>
            <div style="background: white; border-left: 4px solid #667eea; padding: 15px; margin: 20px 0;">
              <p style="margin: 0; font-size: 14px; color: #666;">${g}</p>
            </div>
            `:""}
            
            <div style="margin-top: 30px; text-align: center;">
              <a href="https://telemedcare-v12.pages.dev/dashboard" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold;">Visualizza nella Dashboard</a>
            </div>
          </div>
          
          <div style="text-align: center; padding: 20px; font-size: 12px; color: #666;">
            <p style="margin: 5px 0;">TeleMedCare - Sistema di Gestione Lead</p>
            <p style="margin: 5px 0;">info@telemedcare.it</p>
          </div>
        </body>
        </html>
      `,text:`Nuovo Lead: ${i} ${r}

Email: ${s}
Telefono: ${l}
Citt√†: ${d}
Servizio: ${c} - ${u}
Fonte: ${p}
Lead ID: ${t}`});console.log("‚úÖ [NOTIFICATION] Email result:",JSON.stringify(b,null,2)),console.log(`üìß [NOTIFICATION] Email inviata per nuovo lead ${t} (fonte: ${p})`)}catch(a){console.error(`‚ö†Ô∏è [NOTIFICATION] Errore invio email per lead ${t}:`,a)}}const jp=Object.freeze(Object.defineProperty({__proto__:null,sendNewLeadNotification:ou},Symbol.toStringTag,{value:"Module"}));async function Bg(t){var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=[{key:"hubspot_auto_import_enabled",value:"false",description:"Abilita import automatico da HubSpot"},{key:"lead_email_notifications_enabled",value:"false",description:"Abilita invio email automatiche ai lead"},{key:"admin_email_notifications_enabled",value:"true",description:"Abilita notifiche email a info@telemedcare.it"},{key:"reminder_completion_enabled",value:"false",description:"Abilita reminder automatici completamento dati lead"},{key:"auto_completion_enabled",value:"false",description:"Abilita invio automatico email completamento dati"},{key:"auto_payment_workflow_enabled",value:"false",description:"Abilita workflow automatico pagamenti"},{key:"auto_contract_workflow_enabled",value:"false",description:"Abilita workflow automatico contratti"}];for(const s of e)try{await t.env.DB.prepare(`
          INSERT OR IGNORE INTO settings (key, value, description, updated_at) 
          VALUES (?, ?, ?, datetime('now'))
        `).bind(s.key,s.value,s.description).run()}catch(l){console.warn(`‚ö†Ô∏è Skip init setting ${s.key}:`,l)}const a=await t.env.DB.prepare("SELECT key, value, description FROM settings").all(),i={},r={};return a.results.forEach(s=>{const l=s.value==="true";i[s.key]={value:s.value,description:s.description},r[s.key]=l}),t.json({success:!0,settings:i,...r})}catch(e){return console.error("‚ùå Errore get settings:",e),t.json({success:!1,error:"Errore recupero configurazioni"},500)}}async function kg(t){var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=t.req.param("key"),{value:a}=await t.req.json();if(!await t.env.DB.prepare("SELECT key FROM settings WHERE key = ?").bind(e).first())return t.json({success:!1,error:`Setting '${e}' non trovato`},404);let r="false";return(a===!0||a==="true"||a==="1"||a===1)&&(r="true"),await t.env.DB.prepare("UPDATE settings SET value = ?, updated_at = ? WHERE key = ?").bind(r,new Date().toISOString(),e).run(),console.log(`‚öôÔ∏è Setting aggiornato: ${e} = ${r}`),t.json({success:!0,message:"Setting aggiornato",key:e,value:r==="true"})}catch(e){return console.error("‚ùå Errore update setting:",e),t.json({success:!1,error:"Errore aggiornamento setting"},500)}}async function au(t,o){try{const e=await t.prepare("SELECT value FROM settings WHERE key = ?").bind(o).first();return(e==null?void 0:e.value)==="true"}catch(e){return console.error(`‚ùå Errore lettura setting ${o}:`,e),!1}}const Fg=Object.freeze(Object.defineProperty({__proto__:null,getSetting:au,getSettings:Bg,updateSetting:kg},Symbol.toStringTag,{value:"Module"})),$g={FAMILY:{BASE:{servizio:"FAMILY",piano:"BASE",dispositivo:"Senium",descrizioneDispositivo:"Dispositivo base per monitoraggio familiare",setupBase:390,setupIva:85.8,setupTotale:475.8,rinnovoBase:200,rinnovoIva:44,rinnovoTotale:244,detrazioneFiscale19:90.4,serviziInclusi:["Dispositivo medicale Senium","Monitoraggio parametri vitali base","Supporto tecnico (orario lavorativo)","Report mensili","Aggiornamenti software"]},AVANZATO:{servizio:"FAMILY",piano:"AVANZATO",dispositivo:"Senium",descrizioneDispositivo:"Dispositivo base con centrale operativa H24",setupBase:690,setupIva:151.8,setupTotale:841.8,rinnovoBase:500,rinnovoIva:110,rinnovoTotale:610,detrazioneFiscale19:159.94,serviziInclusi:["Dispositivo medicale Senium","Centrale Operativa H24/7","Monitoraggio parametri vitali avanzato","Supporto professionale continuo","Assistenza medica specializzata","Report sanitari periodici","Coordinamento emergenze"]}},PRO:{BASE:{servizio:"PRO",piano:"BASE",dispositivo:"SiDLY Care PRO",descrizioneDispositivo:"Dispositivo professionale per assistenza avanzata",setupBase:480,setupIva:105.6,setupTotale:585.6,rinnovoBase:240,rinnovoIva:52.8,rinnovoTotale:292.8,detrazioneFiscale19:111.26,serviziInclusi:["Dispositivo medicale SiDLY Care PRO (Classe IIa)","Rilevamento automatico cadute","GPS e geolocalizzazione","Monitoraggio parametri vitali","Comunicazione bidirezionale","Pulsante SOS","Supporto tecnico standard"]},AVANZATO:{servizio:"PRO",piano:"AVANZATO",dispositivo:"SiDLY Care PRO",descrizioneDispositivo:"Dispositivo professionale con centrale operativa H24",setupBase:840,setupIva:184.8,setupTotale:1024.8,rinnovoBase:600,rinnovoIva:132,rinnovoTotale:732,detrazioneFiscale19:194.71,serviziInclusi:["Dispositivo medicale SiDLY Care PRO (Classe IIa)","Centrale Operativa H24/7","Rilevamento cadute con algoritmi avanzati","GPS e geolocalizzazione precisa","Monitoraggio parametri vitali avanzato","Comunicazione bidirezionale vocale","Pulsante SOS geolocalizzato","Promemoria farmaci","Supporto familiare con notifiche","Assistenza professionale continua","Intervento immediato emergenze","Consulenze mediche specializzate"]}},PREMIUM:{BASE:{servizio:"PREMIUM",piano:"BASE",dispositivo:"SiDLY Vital Care",descrizioneDispositivo:"Dispositivo premium per monitoraggio completo",setupBase:590,setupIva:129.8,setupTotale:719.8,rinnovoBase:300,rinnovoIva:66,rinnovoTotale:366,detrazioneFiscale19:136.76,serviziInclusi:["Dispositivo medicale SiDLY Vital Care (Classe IIa)","Monitoraggio completo parametri vitali","Rilevamento cadute avanzato","GPS e tracking","Comunicazione vocale HD","Dashboard famiglia avanzata","Supporto tecnico standard"]},AVANZATO:{servizio:"PREMIUM",piano:"AVANZATO",dispositivo:"SiDLY Vital Care",descrizioneDispositivo:"Dispositivo premium con centrale operativa H24",setupBase:990,setupIva:217.8,setupTotale:1207.8,rinnovoBase:750,rinnovoIva:165,rinnovoTotale:915,detrazioneFiscale19:229.48,serviziInclusi:["Dispositivo medicale SiDLY Vital Care (Classe IIa)","Centrale Operativa H24/7","Monitoraggio completo parametri vitali","Rilevamento cadute intelligente","GPS e geolocalizzazione avanzata","Comunicazione vocale HD bidirezionale","Pulsante SOS prioritario","Dashboard famiglia premium","Promemoria farmaci intelligenti","Assistenza medica specializzata H24","Intervento emergenze immediato","Report sanitari dettagliati","Consulenze mediche illimitate","Supporto psicologico famiglia"]}}};function Nc(t,o){const e=$g[t];return e&&e[o]||null}function io(t,o){return`eCura ${t} ${o==="BASE"?"Base":"Avanzato"}`}const Ug=Object.freeze(Object.defineProperty({__proto__:null,ECURA_PRICING:$g,formatServiceName:io,getPricing:Nc},Symbol.toStringTag,{value:"Module"}));async function Bo(t,o,e){try{console.log(`üìÇ [TEMPLATE] Tentativo caricamento da DB: "${t}"`);const s=await o.prepare("SELECT id, name, subject, content FROM email_templates WHERE name = ?").bind(t).first();if(s&&s.content)return console.log(`‚úÖ [TEMPLATE] Caricato dal DB: "${t}" (${s.content.length} chars)`),s.content;console.log(`‚ö†Ô∏è [TEMPLATE] Template "${t}" non trovato nel DB, provo file statico...`)}catch(s){console.error("‚ùå [TEMPLATE] Errore caricamento DB:",s),console.log("‚ö†Ô∏è [TEMPLATE] Fallback a file statico...")}const a=(e==null?void 0:e.PUBLIC_URL)||(e==null?void 0:e.PAGES_URL)||"https://telemedcare-v12.pages.dev",i=`/templates/email/${t}.html`,r=`${a}${i}`;console.log(`üìÇ [TEMPLATE] Loading from file: ${r}`);try{const s=await fetch(r);if(!s.ok)throw new Error(`Template not found: HTTP ${s.status}`);const l=await s.text();return console.log(`‚úÖ [TEMPLATE] Loaded from file: "${t}" (${l.length} chars)`),l}catch(s){throw console.error(`‚ùå [TEMPLATE] Error loading "${t}":`,s),new Error(`Template "${t}" not found in DB or at ${r}`)}}function ko(t,o){let e=t;for(const[a,i]of Object.entries(o))if(Array.isArray(i)){const r=`{{#${a}}}`,s=`{{/${a}}}`,l=new RegExp(`${r}([\\s\\S]*?)${s}`,"g");e=e.replace(l,(d,c)=>i.length===0?"":i.map(u=>{let p=c;for(const[g,m]of Object.entries(u)){const b=new RegExp(`{{#${g}}}([\\s\\S]*?){{/${g}}}`,"g");p=p.replace(b,(h,E)=>m?E:"")}for(const[g,m]of Object.entries(u)){const b=`{{${g}}}`,h=new RegExp(b.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),E=m!=null?String(m):"";p=p.replace(h,E)}return p}).join(""))}for(const[a,i]of Object.entries(o))if(!Array.isArray(i)){const r=`{{${a}}}`,s=new RegExp(r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),l=i!=null?String(i):"";e=e.replace(s,l)}return e}const Pa=Object.freeze(Object.defineProperty({__proto__:null,loadEmailTemplate:Bo,renderTemplate:ko},Symbol.toStringTag,{value:"Module"})),vv={FAMILY:{servizio:"FAMILY",nomeDispositivo:"Senium",filename:"Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf",descrizione:"Dispositivo per monitoraggio familiare"},PRO:{servizio:"PRO",nomeDispositivo:"SiDLY Care PRO",filename:"Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf",descrizione:"Dispositivo professionale per assistenza avanzata (SiDLY Care PRO)"},PREMIUM:{servizio:"PREMIUM",nomeDispositivo:"SiDLY Vital Care",filename:"Medica-GB-SiDLY_Vital_Care_ITA-compresso.pdf",descrizione:"Dispositivo premium per monitoraggio completo (SiDLY Vital Care)"}};function Ev(t){const o=t.toUpperCase();return vv[o]||null}async function jg(t,o){try{const e=Ev(t);if(!e)return console.error(`‚ùå Servizio "${t}" non trovato nella mappa brochure`),null;const a=`${o}/brochures/${e.filename}`;console.log(`üì• [BROCHURE] Servizio: ${t} ‚Üí Dispositivo: ${e.nomeDispositivo}`),console.log(`üì• [BROCHURE] Caricamento da: ${a}`);const i=await fetch(a);if(!i.ok)return console.error(`‚ùå Errore HTTP ${i.status} per ${a}`),null;const r=await i.arrayBuffer(),s=(r.byteLength/1024).toFixed(2);console.log(`‚úÖ [BROCHURE] ${e.nomeDispositivo}: ${e.filename} (${s} KB)`);const l=new Uint8Array(r),d=32768;let c="";for(let p=0;p<l.length;p+=d){const g=l.slice(p,p+d);c+=String.fromCharCode.apply(null,Array.from(g))}const u=btoa(c);return{filename:e.filename,content:u,size:r.byteLength}}catch(e){return console.error(`‚ùå Errore caricamento brochure per servizio "${t}":`,e),null}}function Hg(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let o="";for(let e=0;e<64;e++)o+=t.charAt(Math.floor(Math.random()*t.length));return o}function Vg(t){const o=new Date;return o.setDate(o.getDate()+t),o.toISOString()}function iu(t){const o={telefono:"Telefono",nomeAssistito:"Nome Assistito",cognomeAssistito:"Cognome Assistito",dataNascitaAssistito:"Data di Nascita Assistito",luogoNascitaAssistito:"Luogo di Nascita Assistito",cfAssistito:"Codice Fiscale Assistito",indirizzoAssistito:"Indirizzo Assistito",condizioniSalute:"Condizioni di Salute"},e=[],a={};return Object.entries(o).forEach(([i,r])=>{const s=t[i];!s||s===""||s===null||s===void 0?e.push(r):a[r]=s}),t.nomeRichiedente&&(a["Nome Richiedente"]=t.nomeRichiedente),t.cognomeRichiedente&&(a["Cognome Richiedente"]=t.cognomeRichiedente),t.email&&(a.Email=t.email),t.servizio&&(a["Servizio Richiesto"]=t.servizio),t.piano&&(a["Piano Selezionato"]=t.piano),{missing:e,available:a}}function bv(t){const{missing:o}=iu(t);return o.length===0}async function Wg(t){const o=await t.prepare("SELECT key, value FROM system_config").all(),e={};return o.results.forEach(a=>{const i=a.key,r=a.value;i==="auto_completion_enabled"||i==="cron_enabled"||i==="hubspot_sync_enabled"?e[i]=r==="true":e[i]=parseInt(r,10)}),{auto_completion_enabled:e.auto_completion_enabled||!1,auto_completion_token_days:e.auto_completion_token_days||30,auto_completion_reminder_days:e.auto_completion_reminder_days||3,auto_completion_max_reminders:e.auto_completion_max_reminders||2,cron_enabled:e.cron_enabled!==void 0?e.cron_enabled:!0,hubspot_sync_enabled:e.hubspot_sync_enabled!==void 0?e.hubspot_sync_enabled:!1}}async function yv(t,o,e){const a=typeof e=="boolean"?e?"true":"false":String(e);await t.prepare(`
    INSERT INTO system_config (key, value, updated_at)
    VALUES (?, ?, datetime('now'))
    ON CONFLICT(key) DO UPDATE SET
      value = excluded.value,
      updated_at = excluded.updated_at
  `).bind(o,a).run()}async function Tv(t,o,e=30){const a=Hg(),i=`TOKEN-${Date.now()}-${Math.random().toString(36).substring(2,9).toUpperCase()}`,r=Vg(e),s=new Date().toISOString();return await t.prepare(`
    INSERT INTO lead_completion_tokens (
      id, lead_id, token, expires_at, completed, created_at
    ) VALUES (?, ?, ?, ?, 0, ?)
  `).bind(i,o,a,r,s).run(),await ru(t,o,i,"token_created",`Token creato, scadenza: ${r}`),{id:i,lead_id:o,token:a,expires_at:r,completed:0,created_at:s,completed_at:null,reminder_sent_at:null,reminder_count:0}}async function wv(t,o){const e=await t.prepare("SELECT * FROM lead_completion_tokens WHERE token = ? LIMIT 1").bind(o).first();if(!e)return{valid:!1,error:"Token non trovato"};if(e.completed)return{valid:!1,error:"Token gi√† utilizzato"};const a=new Date,i=new Date(e.expires_at);return a>i?{valid:!1,error:"Token scaduto"}:{valid:!0,tokenData:e}}async function Iv(t,o){const e=new Date().toISOString();await t.prepare(`
    UPDATE lead_completion_tokens
    SET completed = 1, completed_at = ?
    WHERE id = ?
  `).bind(e,o).run();const a=await t.prepare("SELECT lead_id FROM lead_completion_tokens WHERE id = ?").bind(o).first();a&&await ru(t,a.lead_id,o,"completed","Lead completato con successo")}async function Gg(t,o){const e=new Date().toISOString();await t.prepare(`
    UPDATE lead_completion_tokens
    SET reminder_sent_at = ?, reminder_count = reminder_count + 1
    WHERE id = ?
  `).bind(e,o).run();const a=await t.prepare("SELECT lead_id, reminder_count FROM lead_completion_tokens WHERE id = ?").bind(o).first();a&&await ru(t,a.lead_id,o,"reminder_sent",`Reminder ${a.reminder_count} inviato`)}async function Kg(t,o,e){const a=new Date;a.setDate(a.getDate()-o);const i=new Date;return i.setHours(i.getHours()-23),(await t.prepare(`
    SELECT * FROM lead_completion_tokens
    WHERE completed = 0
      AND expires_at > datetime('now')
      AND reminder_count < ?
      AND (
        reminder_sent_at IS NULL
        OR (
          reminder_sent_at < ? 
          AND reminder_sent_at < ?
        )
      )
  `).bind(e,a.toISOString(),i.toISOString()).all()).results}async function ru(t,o,e,a,i){const r=`LOG-${Date.now()}-${Math.random().toString(36).substring(2,9).toUpperCase()}`,s=new Date().toISOString();await t.prepare(`
    INSERT INTO lead_completion_log (id, lead_id, token_id, action, details, created_at)
    VALUES (?, ?, ?, ?, ?, ?)
  `).bind(r,o,e,a,i,s).run()}async function qg(t,o,e,a){try{const i=(await Promise.resolve().then(()=>At)).default,{loadEmailTemplate:r,renderTemplate:s}=await Promise.resolve().then(()=>Pa),l=new i(o),d=await r("email_reminder_completamento",t,o),u=`${o.PUBLIC_URL||o.PAGES_URL||"https://telemedcare-v12.pages.dev"}/completa-dati?token=${e.token}`,{missing:p}=iu(a),g=p.map(S=>`<li style="color: #856404; font-weight: 500;">${S}</li>`).join(`
        `),m=new Date(e.expires_at),b=Math.ceil((m.getTime()-Date.now())/(1e3*60*60*24)),h={NOME_CLIENTE:a.nomeRichiedente||"Cliente",COGNOME_CLIENTE:a.cognomeRichiedente||"",LEAD_ID:a.id,SERVIZIO:a.servizio||"eCura",PIANO:a.piano||"BASE",MISSING_FIELDS_HTML:g,MISSING_FIELDS_COUNT:p.length,COMPLETION_LINK:u,DAYS_REMAINING:b,TOKEN_EXPIRY:m.toLocaleDateString("it-IT"),REMINDER_COUNT:e.reminder_count+1},E=s(d,h),w=await l.sendEmail({to:a.email,subject:`‚è∞ Promemoria: Completa i tuoi dati TeleMedCare (${b} giorni rimasti)`,html:E,tags:[{name:"tipo",value:"reminder_completamento"},{name:"lead_id",value:a.id},{name:"reminder_count",value:String(e.reminder_count+1)}]});return w.success?(await Gg(t,e.id),console.log(`‚úÖ [REMINDER] Email inviata a ${a.email} (reminder #${e.reminder_count+1})`),!0):(console.error("‚ùå [REMINDER] Errore invio email:",w.error),!1)}catch(i){return console.error("‚ùå [REMINDER] Errore sendReminderEmail:",i),!1}}async function Sv(t,o){const e=await Wg(t);if(!e.cron_enabled)return console.log("‚ö†Ô∏è [REMINDER] Cron disabilitato dalla dashboard - nessuna azione eseguita"),{success:0,failed:0,total:0,disabled:!0};console.log("‚úÖ [REMINDER] Cron abilitato - avvio processo reminder");const a=await Kg(t,e.auto_completion_reminder_days,e.auto_completion_max_reminders);console.log(`üìß [REMINDER] Trovati ${a.length} token che necessitano reminder`);let i=0,r=0;for(const s of a)try{const l=await t.prepare("SELECT * FROM leads WHERE id = ?").bind(s.lead_id).first();if(!l){console.warn(`‚ö†Ô∏è [REMINDER] Lead ${s.lead_id} non trovato`),r++;continue}await qg(t,o,s,l)?i++:r++,await new Promise(c=>setTimeout(c,1e3))}catch(l){console.error(`‚ùå [REMINDER] Errore processando token ${s.id}:`,l),r++}return{success:i,failed:r,total:a.length}}const at=Object.freeze(Object.defineProperty({__proto__:null,calculateExpiryDate:Vg,createCompletionToken:Tv,generateSecureToken:Hg,getMissingFields:iu,getSystemConfig:Wg,getTokensNeedingReminder:Kg,isLeadComplete:bv,logCompletionAction:ru,markTokenAsCompleted:Iv,processReminders:Sv,recordReminderSent:Gg,sendReminderEmail:qg,updateSystemConfig:yv,validateCompletionToken:wv},Symbol.toStringTag,{value:"Module"}));async function Av(t,o){const e=o.servizio||"eCura PRO",a=o.tipoServizio||"BASE",i=e.includes("PREMIUM")?"SiDLY Vital Care":"SiDLY Care PRO",r=o.prezzoBase,s=a==="AVANZATO"?600:200,l=new Date().toLocaleDateString("it-IT",{day:"2-digit",month:"long",year:"numeric"}),d=new Date().toLocaleDateString("it-IT"),c=new Date(Date.now()+365*24*60*60*1e3).toLocaleDateString("it-IT"),u=!t.intestatarioContratto||t.intestatarioContratto==="richiedente",p=u?t.nomeRichiedente:t.nomeAssistito||t.nomeRichiedente,g=u?t.cognomeRichiedente:t.cognomeAssistito||t.cognomeRichiedente,m=t.luogoNascitaAssistito||"N/A",b=t.dataNascitaAssistito||"N/A",h=t.indirizzoAssistito||"N/A",E=t.capAssistito||"N/A",w=t.cittaAssistito||"N/A",S=t.provinciaAssistito||"N/A",C=t.cfAssistito||"N/A";return`
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contratto eCura - ${o.contractCode}</title>
    <style>
        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            color: #333;
            background-color: #fff;
        }
        
        h1 {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
            text-transform: uppercase;
        }
        
        h2 {
            font-size: 16px;
            font-weight: bold;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        
        p {
            margin-bottom: 12px;
            text-align: justify;
        }
        
        .party {
            margin: 20px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-left: 4px solid #0066cc;
        }
        
        .breviter {
            font-style: italic;
            margin-top: 10px;
        }
        
        .premises {
            margin: 20px 0;
        }
        
        .premises ul {
            list-style-type: none;
            padding-left: 0;
        }
        
        .premises li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }
        
        .premises li:before {
            content: "-";
            position: absolute;
            left: 0;
        }
        
        .feature-list {
            margin: 15px 0;
            padding-left: 20px;
        }
        
        .highlight {
            background-color: transparent;
            padding: 0;
            font-weight: bold;
        }
        
        .payment-details {
            background-color: #f5f5f5;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #ddd;
        }
        
        .signature-section {
            margin-top: 40px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        
        .signature-block {
            width: 45%;
            border-top: 1px solid #333;
            padding-top: 10px;
            text-align: center;
        }
        
        .letterhead {
            border-top: 3px solid #0066cc;
            border-bottom: 3px solid #0066cc;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }
        
        .letterhead-logo {
            flex-shrink: 0;
            margin-right: 30px;
        }
        
        .letterhead-logo img {
            max-width: 180px;
            height: auto;
        }
        
        .letterhead-info {
            flex-grow: 1;
            text-align: right;
        }
        
        .letterhead-info h3 {
            font-size: 18px;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #0066cc;
        }
        
        .letterhead-info p {
            font-size: 11px;
            margin: 3px 0;
        }
        
        .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid #0066cc;
            text-align: center;
            font-size: 12px;
            color: #666;
        }
        
        .footer p {
            margin: 5px 0;
        }
        
        @media print {
            body {
                padding: 20px;
            }
            .signature-section {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <!-- Carta intestata ufficiale Medica GB -->
    <div class="letterhead">
        <div class="letterhead-logo">
            <img src="/images/medicagb-logo.png" alt="Medica GB Logo">
        </div>
        <div class="letterhead-info">
            <h3>Medica GB S.r.l.</h3>
            <p>Corso Garibaldi 34 ‚Äì 20121 Milano</p>
            <p>PEC: medicagbsrl@pecimprese.it</p>
            <p>E.mail: info@medicagb.it</p>
            <p>Codice Fiscale e P.IVA: 12435130963 - REA: MI-2661409</p>
            <p>www.medicagb.it</p>
        </div>
    </div>
    
    <h1>SCRITTURA PRIVATA</h1>
    
    <p>Con la presente scrittura privata da valere a tutti gli effetti e conseguenze di legge tra:</p>
    
    <div class="party">
        <p><strong>Medica GB S.r.l.</strong>, con sede in Corso Garibaldi 34 a Milano 20121 e con Partita IVA e registro imprese 12435130963, in persona dell'Amministratore Stefania Rocca</p>
        <p class="breviter">(breviter Medica GB)</p>
    </div>
    
    <p style="text-align: center; font-weight: bold;">e</p>
    
    <div class="party">
        <p>Sig. <span class="highlight">${p} ${g}</span> nato/a a <span class="highlight">${m}</span> il <span class="highlight">${b}</span>, residente e domiciliato/a in <span class="highlight">${h}</span> n__________ - <span class="highlight">${E}</span> <span class="highlight">${w}</span> (<span class="highlight">${S}</span>) e con codice fiscale <span class="highlight">${C}</span>.</p>
        
        <p><strong>Indirizzo di spedizione:</strong> <span class="highlight">${h} - ${E} ${w} (${S})</span></p>
        
        <p><strong>Riferimenti:</strong><br>
        Signor <span class="highlight">${p} ${g}</span> ‚Äì telefono <span class="highlight">${t.telefono||"N/A"}</span> ‚Äì e-mail <span class="highlight">${t.email}</span></p>
        
        <p class="breviter">(breviter Il Cliente)</p>
    </div>
    
    <div class="premises">
        <p><strong>premesso che</strong></p>
        <ul>
            <li>Medica GB eroga servizi di assistenza domiciliare con tecnologie innovative, servizi di diagnostica a domicilio, esami strumentali, telemedicina, teleassistenza, telemonitoraggio e riabilitazione a domicilio.</li>
            <li>Medica GB si avvale della consulenza di Medici, Terapisti, Infermieri e Operatori Socio Sanitari per erogare i servizi sopra descritti;</li>
        </ul>
        <p><strong>Tanto premesso,</strong></p>
        <p style="text-align: center; font-weight: bold;">si conviene e stabilisce quanto segue</p>
    </div>
    
    <h2>Premessa</h2>
    <p>La premessa che precede costituisce parte integrante del presente Contratto.</p>
    
    <h2>Oggetto del Contratto</h2>
    <p>L'oggetto del presente Contratto √® l'erogazione del "Servizio di TeleAssistenza ${a==="BASE"?"base":"avanzato"}" mediante l'utilizzo del Dispositivo ${i}. Le funzioni del Dispositivo ${i} sono le seguenti:</p>
    
    <div class="feature-list">
        <p><strong>Rilevatore automatico di caduta:</strong> effettua una chiamata vocale di allarme, in caso di caduta, e invia una notifica tramite sms ai familiari. Nell'sms arriver√† sia il link da cliccare per individuare la posizione dell'assistito (geolocalizzazione) che i valori dei parametri fisiologici che √® stato possibile rilevare.</p>
        
        <p><strong>Pulsante SOS:</strong> premendo il pulsante SOS √® possibile effettuare una chiamata vocale al primo contatto di emergenza (in caso di mancata risposta, in cascata, ai successivi contatti di emergenza configurati) ed inviare una notifica di emergenza (SMS geolocalizzato) ai familiari configurati in Piattaforma).</p>
        
        <p><strong>Comunicazione vocale bidirezionale:</strong> √® possibile configurare sulla Piattaforma ${i} i contatti dei familiari; dopo l'invio dell'allarme i familiari (configurati in Piattaforma) ricevono una chiamata dal bracciale e possono parlare con l'assistito; inoltre, in qualsiasi momento, i familiari (configurati in Piattaforma) possono contattare l'assistito tramite il bracciale.</p>
        
        <p><strong>Posizione gps e gps-assistito:</strong> consente di geolocalizzare l'assistito quando viene inviato l'allarme oppure, in ogni momento, tramite l'APP. √à inoltre possibile impostare una cosiddetta area sicura per l'assistito (geo-fencing) con invio automatico dell'allarme in caso di uscita dalla zona sicura.</p>
        
        <p><strong>Misurazioni della frequenza cardiaca e della saturazione di ossigeno:</strong> √® possibile impostare una notifica che arrivi ai familiari tramite APP quando i valori rilevati vanno oltre le soglie impostate in piattaforma (comunicate dal proprio Medico di Base).</p>
        
        <p><strong>Assistenza vocale:</strong> informa l'assistito in relazione ai seguenti eventi: pressione pulsante SOS, attivazione bracciale, messa in carica del bracciale, segnalazione di batteria scarica, ecc.</p>
        
        <p><strong>Promemoria per l'assunzione dei farmaci:</strong> un messaggio ricorda l'orario in cui assumere i farmaci (aderenza terapeutica).</p>
        
        <p><strong>Registrazione dei passi:</strong> aiuta a valutare quanto sei attivo durante la giornata. Inoltre, monitorando le calorie bruciate, aiuta a mantenere una dieta sana.</p>
    </div>
    
    <p>L'integrazione di queste funzioni consente l'elaborazione di consigli sanitari personalizzati per le esigenze dell'Assistito da parte del Medico di Medicina Generale.</p>
    
    <h2>Durata del Servizio</h2>
    <p>Il Servizio di TeleAssistenza ${a==="BASE"?"base":"avanzato"} ha una durata di 12 mesi a partire da <span class="highlight">${d}</span> fino al <span class="highlight">${c}</span>. Il Contratto sar√† prorogabile su richiesta scritta del Cliente e su accettazione di Medica GB.</p>
    
    <h2>Tariffa del Servizio</h2>
    <p>La tariffa annuale per il primo anno di attivazione del "Servizio di TeleAssistenza ${a==="BASE"?"Base":"avanzato"}" √® pari a <span class="highlight">${r} ‚Ç¨</span> ${a==="BASE"?"(47‚Ç¨/mese)":"(70‚Ç¨/mese)"} + IVA 22% (totale <span class="highlight">${o.prezzoIvaInclusa||Math.round(r*1.22)} ‚Ç¨ inclusa iva</span>) e include:</p>
    
    <ul>
        <li>Dispositivo ${i} (hardware)</li>
        <li>Configurazione del Dispositivo e del Processo di Comunicazione con uno o pi√π familiari e Piattaforma Web e APP di TeleAssistenza per la durata di 12 mesi</li>
        <li>SIM per trasmissione dati e comunicazione vocale per la durata di 12 mesi</li>
    </ul>
    
    <p>Per i successivi anni (rinnovabili di anno in anno) la tariffa annuale per il "Servizio di Continuit√† di TeleAssistenza ${a==="BASE"?"base":"avanzato"}" sar√† pari a <span class="highlight">${s} ‚Ç¨</span> ${a==="BASE"?"(25‚Ç¨/mese)":"(50‚Ç¨/mese)"} + IVA 22% con inclusi:</p>
    
    <ul>
        <li>Piattaforma Web e APP di TeleAssistenza per la durata di 12mesi</li>
        <li>SIM per trasmissione dati e comunicazione vocale per la durata di 12 mesi</li>
    </ul>
    
    <h2>Metodo di pagamento</h2>
    <p>Medica GB emetter√† fattura anticipata di 12 mesi all'attivazione del Servizio e il Cliente proceder√† al pagamento a ricevimento della fattura stessa tramite bonifico bancario</p>
    
    <div class="payment-details">
        <p><strong>Intestato a:</strong> Medica GB Srl</p>
        <p><strong>Causale:</strong> (NOME E COGNOME ASSISTITO) - SERVIZI PER ${i.toUpperCase()}</p>
        <p><strong>Banca Popolare di Milano - Iban:</strong> IT97L0503401727000000003519</p>
    </div>
    
    <h2>Riservatezza ed esclusiva</h2>
    <p>Il Cliente e Medica GB si impegnano reciprocamente a non divulgare o, comunque, non utilizzare, se non per motivi attinenti all'esercizio del presente contratto, tutte le informazioni di cui venissero a conoscenza nello svolgimento del Servizio.</p>
    <p>Il Cliente si impegna a contattare Medica GB per tutte le modifiche e proroghe del presente contratto.</p>
    
    <h2>Foro competente</h2>
    <p>Ogni eventuale contestazione o controversia che dovesse insorgere tra le parti in relazione all'interpretazione, alla validit√† ed esecuzione del presente contratto, sar√† definita alla cognizione esclusiva del Foro di Milano.</p>
    
    <div class="signature-section">
        <div>
            <p>Milano, l√¨ <span class="highlight">${l}</span></p>
        </div>
    </div>
    
    <div class="signature-section">
        <div class="signature-block">
            <p><strong>Medica GB S.r.l.</strong></p>
        </div>
        <div class="signature-block">
            <p><strong>Il Cliente</strong></p>
        </div>
    </div>
    
    <div class="footer">
        <p><strong>Medica GB S.r.l.</strong></p>
        <p>Corso Garibaldi 34 ‚Äì 20121 Milano</p>
        <p>PEC: medicagbsrl@pecimprese.it</p>
        <p>E.mail: info@medicagb.it</p>
        <p>Codice Fiscale e P.IVA: 12435130963 - REA: MI-2661409</p>
        <p>www.medicagb.it</p>
    </div>
</body>
</html>
  `.trim()}async function Yg(t,o,e){var i;const a={success:!1,step:"notifica_info",emailsSent:[],errors:[]};try{console.log("üìß [WORKFLOW] STEP 1: Invio notifica nuovo lead a info@telemedcare.it"),console.log(`Lead: ${t.nomeRichiedente} ${t.cognomeRichiedente} - ${t.email}`);const r=new Xe(o),s=await Bo("email_notifica_info",e,o),l=new Date,d=t.vuoleContratto||!1,c=t.vuoleBrochure||!1,u=t.vuoleManuale||!1;let p="";d?p="Il cliente ha richiesto il CONTRATTO. Procedere con la preparazione e invio del contratto pre-compilato.":c||u?p="Il cliente ha richiesto solo DOCUMENTAZIONE INFORMATIVA. √à stata inviata automaticamente email con documenti.":p="Contattare il cliente entro 24 ore per verificare le sue esigenze e procedere con l'attivazione del servizio TeleMedCare.";const g={NOME_RICHIEDENTE:t.nomeRichiedente,COGNOME_RICHIEDENTE:t.cognomeRichiedente,EMAIL_RICHIEDENTE:t.email,TELEFONO_RICHIEDENTE:t.telefono||"Non fornito",CF_RICHIEDENTE:t.cfIntestatario||"Non fornito",INDIRIZZO_RICHIEDENTE:t.indirizzoIntestatario||"Non fornito",NOME_ASSISTITO:t.nomeAssistito||t.nomeRichiedente,COGNOME_ASSISTITO:t.cognomeAssistito||t.cognomeRichiedente,ETA_ASSISTITO:((i=t.etaAssistito)==null?void 0:i.toString())||"Non fornita",DATA_NASCITA_ASSISTITO:t.dataNascitaAssistito||"Non fornita",LUOGO_NASCITA_ASSISTITO:t.luogoNascitaAssistito||"Non fornito",CF_ASSISTITO:t.cfAssistito||"Non fornito",INDIRIZZO_ASSISTITO:t.indirizzoAssistito||"Non fornito",CONDIZIONI_SALUTE:t.condizioniSalute||t.note||"Non specificate",NOTE_AGGIUNTIVE:t.note||"Nessuna",PIANO_SERVIZIO:io(t.servizio||"PRO",t.pacchetto),SERVIZIO:t.servizio||"eCura PRO",PIANO:t.pacchetto||"BASE",PREZZO_PIANO:t.pacchetto==="BASE"?"‚Ç¨585,60":"‚Ç¨1.024,80",DATA_RICHIESTA:l.toLocaleDateString("it-IT",{timeZone:"Europe/Rome"}),ORA_RICHIESTA:l.toLocaleTimeString("it-IT",{timeZone:"Europe/Rome"}),TIMESTAMP_COMPLETO:l.toLocaleString("it-IT",{timeZone:"Europe/Rome"}),VERSIONE_SISTEMA:"TeleMedCare V12.0",VUOLE_CONTRATTO:d?"S√å":"NO",VUOLE_BROCHURE:c?"S√å":"NO",VUOLE_MANUALE:u?"S√å":"NO",VUOLE_CONTRATTO_TEXT:d?"‚úÖ SI":"‚ùå NO",VUOLE_CONTRATTO_COLOR:d?"#198754":"#dc3545",VUOLE_BROCHURE_TEXT:c?"‚úÖ SI":"‚ùå NO",VUOLE_BROCHURE_COLOR:c?"#198754":"#dc3545",VUOLE_MANUALE_TEXT:u?"‚úÖ SI":"‚ùå NO",VUOLE_MANUALE_COLOR:u?"#198754":"#dc3545",URGENZA:t.urgenzaRisposta||"NORMALE",AZIONE_SUGGERITA:p},m=ko(s,g),b=await r.sendEmail({to:o.EMAIL_TO_INFO||"info@telemedcare.it",from:"info@telemedcare.it",subject:`üÜï Nuovo Lead: ${t.nomeRichiedente} ${t.cognomeRichiedente} - ${t.pacchetto}`,html:m,text:`Nuovo lead ricevuto: ${t.nomeRichiedente} ${t.cognomeRichiedente}
Servizio: ${t.pacchetto}
Email: ${t.email}`});b.success?(a.success=!0,a.emailsSent.push("email_notifica_info -> info@telemedcare.it"),a.messageIds=[b.messageId],console.log(`‚úÖ [WORKFLOW] Email notifica inviata con successo: ${b.messageId}`)):(a.errors.push(`Errore invio email notifica: ${b.error}`),console.error("‚ùå [WORKFLOW] Errore invio email notifica:",b.error))}catch(r){a.errors.push(`Eccezione invio email notifica: ${r.message}`),console.error("‚ùå [WORKFLOW] Eccezione STEP 1:",r)}return a}async function Zg(t,o,e,a){const i={success:!1,step:"documenti_informativi",emailsSent:[],errors:[]};try{if(!await au(a,"lead_email_notifications_enabled"))return console.log("‚è≠Ô∏è [WORKFLOW] Email automatiche ai lead disabilitate - skip invio documenti informativi"),i.errors.push("Email automatiche ai lead disabilitate nelle impostazioni sistema"),i;console.log(`üìß [WORKFLOW] STEP 2A: Invio documenti informativi a ${t.email}`),console.log(`Richiesti: Brochure=${t.vuoleBrochure}, Manuale=${t.vuoleManuale}`);const s=new Xe(o),l=await Bo("email_documenti_informativi",a,o),d=t.servizio||"eCura",c=t.pacchetto==="BASE"||t.pacchetto==="base"?"BASE":"AVANZATO",u=d==="PREMIUM"||d==="premium"?"SiDLY Vital Care":"SiDLY Care PRO",p=o.PUBLIC_URL||o.PAGES_URL||"https://telemedcare-v12.pages.dev";console.log(`üåê [WORKFLOW] Using baseUrl: ${p}`);const m=`${p}/brochures/${d==="PREMIUM"||d==="premium"?"Medica-GB-SiDLY_Vital_Care_ITA-compresso.pdf":"Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf"}`,{missing:b,available:h}=iu(t),E=b.length>0;let w="";if(E){const D=`${p}/completa-dati?leadId=${t.id}`,F=30,L=new Date;L.setDate(L.getDate()+F);const M=L.toLocaleDateString("it-IT");w=`
<!-- SEZIONE COMPLETAMENTO DATI (lead incompleto) -->
<div class="warning-box">
    <h4>‚ö†Ô∏è Ultimi Dettagli Necessari</h4>
    <p>Per procedere con l'attivazione del servizio, abbiamo bisogno di alcuni dati aggiuntivi:</p>
    <ul style="margin: 15px 0; padding-left: 25px; line-height: 2;">
        ${b.map(N=>`<li style="color: #856404; font-weight: 500;">${N}</li>`).join(`
        `)}
    </ul>
    <p style="margin: 20px 0 10px 0; font-weight: 500;">Clicchi sul pulsante qui sotto per completare i dati in soli 2 minuti:</p>
    <div style="text-align: center; margin: 25px 0;">
        <a href="${D}" 
           style="display: inline-block; 
                  background: linear-gradient(135deg, #0066CC 0%, #0099CC 100%); 
                  color: white; 
                  padding: 15px 40px; 
                  text-decoration: none; 
                  border-radius: 8px; 
                  font-size: 18px; 
                  font-weight: 600;
                  box-shadow: 0 4px 8px rgba(0,102,204,0.3);">
            üìù Completa i Dati Ora
        </a>
    </div>
    <p style="font-size: 13px; color: #856404; margin: 15px 0;">
        ‚è∞ Il link √® valido per ${F} giorni (scadenza: ${M})
    </p>
</div>
`}const S={NOME_CLIENTE:t.nomeRichiedente,COGNOME_CLIENTE:t.cognomeRichiedente,NOME_ASSISTITO:t.nomeAssistito||t.nomeRichiedente,COGNOME_ASSISTITO:t.cognomeAssistito||t.cognomeRichiedente,LEAD_ID:t.id,TIPO_SERVIZIO:t.pacchetto==="BASE"?"Base":"Avanzato",SERVIZIO:d,SERVIZI:d,PIANO:c,DISPOSITIVO:u,BROCHURE_URL:m,DATA_RICHIESTA:new Date().toLocaleDateString("it-IT"),PACCHETTO:t.pacchetto||"BASE",PREZZO_PIANO:t.pacchetto==="BASE"?"‚Ç¨480/anno":"‚Ç¨840/anno",PREZZO_SERVIZIO_PIANO:t.pacchetto==="BASE"?"‚Ç¨480/anno":"‚Ç¨840/anno",COMPLETION_SECTION:w},C=ko(l,S),R=[];try{const D=o.PUBLIC_URL||o.PAGES_URL||"https://telemedcare-v12.pages.dev";if(console.log(`üåê [WORKFLOW] Using baseUrl: ${D}`),t.vuoleBrochure){console.log(`üìÑ [WORKFLOW] Caricamento brochure per servizio: ${t.servizio||"DEFAULT"}`);const F=t.servizio||"DEFAULT",L=F.replace(/^eCura\s+/i,"").trim();console.log(`üìÑ [WORKFLOW] Servizio normalizzato: "${F}" ‚Üí "${L}"`);try{let M=null;if(L!=="DEFAULT"&&(L==="FAMILY"||L==="PRO"||L==="PREMIUM")&&(console.log(`üì• [WORKFLOW] Caricamento brochure specifica per ${L}`),M=await jg(L,D),M?console.log(`‚úÖ [WORKFLOW] Brochure ${L} caricata: ${(M.size/1024).toFixed(2)} KB`):console.warn(`‚ö†Ô∏è [WORKFLOW] Brochure ${L} non trovata, fallback su brochure generica`)),!M){console.log("üìÑ [WORKFLOW] Caricamento brochure generica eCura");const j=`${D}/brochures/Brochure_eCura.pdf`,N=await fetch(j);if(N.ok){const A=await N.arrayBuffer(),x=new Uint8Array(A);let P="";const B=8192;for(let ae=0;ae<x.length;ae+=B){const ie=x.subarray(ae,Math.min(ae+B,x.length));P+=String.fromCharCode.apply(null,Array.from(ie))}M={filename:"Brochure_eCura.pdf",content:btoa(P),size:A.byteLength},console.log(`‚úÖ [WORKFLOW] Brochure generica caricata: ${(M.size/1024).toFixed(2)} KB`)}}M&&(R.push({filename:M.filename,content:M.content,contentType:"application/pdf"}),console.log("‚úÖ [WORKFLOW] Brochure aggiunta agli allegati"))}catch(M){console.error("‚ùå [WORKFLOW] Errore caricamento brochure:",M),console.error("‚ùå [WORKFLOW] Stack trace:",M.stack)}}if(t.vuoleManuale){console.log("üìÑ [WORKFLOW] Caricamento manuale da public/documents/");try{const F=`${D}/documents/Manuale_SiDLY.pdf`,L=await fetch(F);if(L.ok){const M=await L.arrayBuffer();console.log(`üì• [WORKFLOW] Manuale ArrayBuffer ricevuto: ${M.byteLength} bytes`);const j=new Uint8Array(M);let N="";const A=8192;for(let P=0;P<j.length;P+=A){const B=j.subarray(P,Math.min(P+A,j.length));N+=String.fromCharCode.apply(null,Array.from(B))}const x=btoa(N);R.push({filename:"Manuale_SiDLY.pdf",content:x,contentType:"application/pdf"}),console.log(`‚úÖ [WORKFLOW] Manuale caricato: ${(M.byteLength/1024).toFixed(2)} KB`)}else console.warn(`‚ö†Ô∏è [WORKFLOW] Manuale non trovato: ${L.status}`)}catch(F){console.error("‚ùå [WORKFLOW] Errore caricamento manuale:",F)}}}catch(D){console.warn("‚ö†Ô∏è [WORKFLOW] Errore preparazione allegati:",D)}console.log(`üìÑ [WORKFLOW] Documenti richiesti: Brochure=${t.vuoleBrochure}, Manuale=${t.vuoleManuale}`),console.log(`üìÑ [WORKFLOW] Brochure URL: ${m}`),console.log("üìÑ [WORKFLOW] Link download inclusi nel template email");const z=await s.sendEmail({to:t.email,from:"info@telemedcare.it",subject:"üìö TeleMedCare - Documenti Informativi Richiesti",html:C});z.success?(i.success=!0,i.emailsSent.push(`email_documenti_informativi -> ${t.email}`),i.messageIds=[z.messageId],console.log(`‚úÖ [WORKFLOW] Email documenti inviata con successo: ${z.messageId}`)):(i.errors.push(`Errore invio email documenti: ${z.error}`),console.error("‚ùå [WORKFLOW] Errore invio email documenti:",z.error))}catch(r){i.errors.push(`Eccezione invio email documenti: ${r.message}`),console.error("‚ùå [WORKFLOW] Eccezione STEP 2A:",r)}return i}async function Xg(t,o,e,a,i){const r={success:!1,step:"invio_contratto",emailsSent:[],errors:[]};try{const s=await au(i,"lead_email_notifications_enabled");if(console.log(`üîç [WORKFLOW] Email automatiche lead: ${s?"ABILITATE ‚úÖ":"DISABILITATE ‚ùå"}`),!s)return console.log("‚è≠Ô∏è [WORKFLOW] Email automatiche ai lead disabilitate - skip invio contratto"),r.errors.push("‚ö†Ô∏è Email automatiche ai lead DISABILITATE nelle impostazioni sistema. Vai su Impostazioni > Email Lead per abilitarle."),r;if(console.log(`üìß [WORKFLOW] STEP 2B: Invio contratto ${o.tipoServizio} a ${t.email}`),console.log(`üìä [CONTRATTO] DB disponibile: ${!!i}`),console.log(`üìä [CONTRATTO] Contract ID: ${o.contractId}`),console.log(`üìä [CONTRATTO] Lead ID: ${t.id}`),i)try{console.log("üìã [CONTRATTO] Generazione HTML contratto...");const R=await Av(t,o);console.log(`üìã [CONTRATTO] HTML generato (${R.length} chars)`),console.log("üíæ [CONTRATTO] Salvataggio nel DB..."),console.log("üíæ [CONTRATTO] DB type:",typeof i,i?"Available":"NULL");const z=o.tipoServizio==="AVANZATO"?70:40,D=12;console.log("üíæ [CONTRATTO] Dati da salvare:",{id:o.contractId,leadId:t.id,codice_contratto:o.contractCode,tipo_contratto:o.tipoServizio,servizio:o.servizio,piano:o.tipoServizio,prezzo_totale:o.prezzoBase});const F=await i.prepare(`
          INSERT INTO contracts (
            id, leadId, codice_contratto, tipo_contratto, 
            template_utilizzato, contenuto_html, 
            pdf_generated, pdf_url, email_sent, email_template_used,
            status, servizio, piano, 
            prezzo_mensile, durata_mesi, prezzo_totale, 
            data_invio, data_scadenza,
            created_at, updated_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(o.contractId,t.id,o.contractCode,o.tipoServizio,"template_contratto_firma_digitale",R,0,"",1,"email_invio_contratto","PENDING",o.servizio,o.tipoServizio,z,D,o.prezzoBase,new Date().toISOString(),new Date(Date.now()+720*60*60*1e3).toISOString(),new Date().toISOString(),new Date().toISOString()).run();console.log("‚úÖ [CONTRATTO] Insert result:",F),console.log(`‚úÖ [CONTRATTO] Salvato nel DB: ${o.contractId}`)}catch(R){console.error("‚ùå [CONTRATTO] Errore salvataggio DB:",R),console.error("‚ùå [CONTRATTO] Stack:",R==null?void 0:R.stack)}else console.warn("‚ö†Ô∏è  [CONTRATTO] DB non disponibile - contratto NON salvato!");const l=new Xe(e);console.log("üìß [CONTRATTO] Caricamento template email_invio_contratto...");const d=await Bo("email_invio_contratto",i,e);console.log(`üìß [CONTRATTO] Template caricato (${d.length} chars)`);const c=o.servizio||t.servizio||"eCura PRO",u=o.tipoServizio||"BASE",p=c.includes("PREMIUM")||c.includes("premium")?"SiDLY Vital Care":"SiDLY Care PRO",g=(e==null?void 0:e.PUBLIC_URL)||"https://telemedcare-v12.pages.dev",m=c.replace(/^eCura\s+/i,"").trim().toUpperCase();let b="Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf";m==="PREMIUM"&&(b="Medica-GB-SiDLY_Vital_Care_ITA-compresso.pdf");const h=`${g}/brochures/${b}`,E={NOME_CLIENTE:t.nomeRichiedente,COGNOME_CLIENTE:t.cognomeRichiedente,PIANO_SERVIZIO:io(c.replace("eCura ",""),u),SERVIZIO:c,PIANO:u,DISPOSITIVO:p,PREZZO_PIANO:`‚Ç¨${o.prezzoBase.toFixed(2)}`,PREZZO_SERVIZIO_PIANO:`‚Ç¨${o.prezzoBase.toFixed(2)}/anno`,CODICE_CLIENTE:t.id,CODICE_CONTRATTO:o.contractCode,LINK_FIRMA:`${g}/firma-contratto.html?v=${Date.now()}&contractId=${o.contractId}`,LINK_BROCHURE:h,DATA_INVIO:new Date().toLocaleDateString("it-IT")};console.log("üìß [CONTRATTO] Template data:",JSON.stringify(E,null,2));const w=ko(d,E);console.log(`üìß [CONTRATTO] Template renderizzato (${w.length} chars)`);const S=[];if(t.vuoleBrochure&&(e!=null&&e.ASSETS))try{console.log(`üìé [CONTRATTO] Caricamento brochure via ASSETS: ${h}`);const R=new URL(h),z=await e.ASSETS.fetch(R);if(z.ok){const D=await z.arrayBuffer(),F=(D.byteLength/1024).toFixed(2);console.log(`üì• [CONTRATTO] PDF caricato: ${F} KB`);const L=new Uint8Array(D),M=32768;let j="";for(let x=0;x<L.length;x+=M){const P=L.slice(x,x+M);j+=String.fromCharCode.apply(null,Array.from(P))}const N=btoa(j),A=h.split("/").pop()||"Brochure_eCura.pdf";S.push({filename:A,content:N,contentType:"application/pdf"}),console.log(`‚úÖ [CONTRATTO] Brochure allegata: ${A} (${F} KB, ${N.length} chars base64)`)}else console.warn(`‚ö†Ô∏è [CONTRATTO] ASSETS non trova brochure: ${h} (status: ${z.status})`)}catch(R){console.error("‚ùå [CONTRATTO] Errore caricamento brochure:",R)}else t.vuoleBrochure&&!(e!=null&&e.ASSETS)&&console.warn("‚ö†Ô∏è [CONTRATTO] ASSETS binding non disponibile, brochure disponibile solo via link");console.log(`üìé [CONTRATTO] Link brochure nel template: ${h}`),t.vuoleManuale&&a.manuale&&console.log(`üìé [CONTRATTO] Link manuale disponibile: ${a.manuale}`),console.log(`üìß [CONTRATTO] Invio email a: ${t.email}`),console.log(`üìß [CONTRATTO] Subject: üìÑ TeleMedCare - Il Tuo Contratto ${o.tipoServizio}`),console.log(`üìß [CONTRATTO] Allegati: ${S.length}`),console.log(`üìß [CONTRATTO] HTML length: ${w.length}`);const C=await l.sendEmail({to:t.email,from:"info@telemedcare.it",subject:`üìÑ TeleMedCare - Il Tuo Contratto ${o.tipoServizio}`,html:w,attachments:S});console.log("üìß [CONTRATTO] Send result:",JSON.stringify(C,null,2)),C.success?(r.success=!0,r.emailsSent.push(`email_invio_contratto -> ${t.email}`),r.messageIds=[C.messageId],console.log(`‚úÖ [WORKFLOW] Email contratto inviata con successo: ${C.messageId}`)):(r.errors.push(`Errore invio email contratto: ${C.error}`),console.error("‚ùå [WORKFLOW] Errore invio email contratto:",C.error))}catch(s){r.errors.push(`Eccezione invio email contratto: ${s.message}`),console.error("‚ùå [WORKFLOW] Eccezione STEP 2B:",s)}return r}async function Jg(t,o,e,a){const i={success:!1,step:"invio_proforma",emailsSent:[],errors:[]};try{console.log(`üìß [WORKFLOW] STEP 3: Invio proforma ${o.numeroProforma} a ${t.email}`);const r=new Xe(e),s=await Bo("email_invio_proforma",a,e),l={NOME_CLIENTE:t.nomeRichiedente,COGNOME_CLIENTE:t.cognomeRichiedente,PIANO_SERVIZIO:io(o.servizio||"PRO",o.tipoServizio),NUMERO_PROFORMA:o.numeroProforma,IMPORTO_TOTALE:`‚Ç¨${o.prezzoIvaInclusa.toFixed(2)}`,SCADENZA_PAGAMENTO:new Date(o.dataScadenza).toLocaleDateString("it-IT"),IBAN:"IT97L0503401727000000003519",CAUSALE:`Proforma ${o.numeroProforma} - ${t.nomeRichiedente} ${t.cognomeRichiedente}`,LINK_PAGAMENTO:`${e.PUBLIC_URL||e.PAGES_URL||"https://telemedcare-v12.pages.dev"}/pagamento?proformaId=${o.proformaId}`,DATA_INVIO:new Date().toLocaleDateString("it-IT")},d=ko(s,l),c=[{filename:`Proforma_${o.numeroProforma}.pdf`,path:o.proformaPdfUrl}],u=await r.sendEmail({to:t.email,from:"info@telemedcare.it",subject:`üí∞ TeleMedCare - Fattura Proforma ${o.numeroProforma}`,html:d,attachments:c});u.success?(i.success=!0,i.emailsSent.push(`email_invio_proforma -> ${t.email}`),i.messageIds=[u.messageId],console.log(`‚úÖ [WORKFLOW] Email proforma inviata con successo: ${u.messageId}`)):(i.errors.push(`Errore invio email proforma: ${u.error}`),console.error("‚ùå [WORKFLOW] Errore invio email proforma:",u.error))}catch(r){i.errors.push(`Eccezione invio email proforma: ${r.message}`),console.error("‚ùå [WORKFLOW] Eccezione STEP 3:",r)}return i}async function Qg(t,o,e){const a={success:!1,step:"email_benvenuto",emailsSent:[],errors:[]};try{console.log(`üìß [WORKFLOW] STEP 4: Invio email benvenuto a ${t.email}`);const i=new Xe(o),r=await Bo("email_benvenuto",e,o),s={NOME_CLIENTE:t.nomeRichiedente,COGNOME_CLIENTE:t.cognomeRichiedente,PIANO_SERVIZIO:io(t.servizio||"PRO",t.pacchetto),CODICE_CLIENTE:t.codiceCliente,DATA_ATTIVAZIONE:new Date().toLocaleDateString("it-IT"),LINK_CONFIGURAZIONE:`${o.PUBLIC_URL||"https://telemedcare.it"}/configurazione?clientId=${t.codiceCliente}`,PREZZO_PIANO:t.pacchetto==="BASE"?"‚Ç¨490/anno":"‚Ç¨840/anno"},l=ko(r,s),d=await i.sendEmail({to:t.email,from:"info@telemedcare.it",subject:`üéâ Benvenuto/a in TeleMedCare, ${t.nomeRichiedente}!`,html:l});d.success?(a.success=!0,a.emailsSent.push(`email_benvenuto -> ${t.email}`),a.messageIds=[d.messageId],console.log(`‚úÖ [WORKFLOW] Email benvenuto inviata con successo: ${d.messageId}`)):(a.errors.push(`Errore invio email benvenuto: ${d.error}`),console.error("‚ùå [WORKFLOW] Errore invio email benvenuto:",d.error))}catch(i){a.errors.push(`Eccezione invio email benvenuto: ${i.message}`),console.error("‚ùå [WORKFLOW] Eccezione STEP 4:",i)}return a}async function ef(t,o,e,a){const i={success:!1,step:"email_configurazione_info",emailsSent:[],errors:[]};try{console.log("üìß [WORKFLOW] STEP 5: Invio configurazione cliente a info@telemedcare.it");const r=new Xe(e),s=await Bo("email_configurazione",a,e),l={NOME_CLIENTE:t.nomeRichiedente,COGNOME_CLIENTE:t.cognomeRichiedente,CODICE_CLIENTE:t.codiceCliente,EMAIL_CLIENTE:t.email,TELEFONO_CLIENTE:t.telefono||"Non fornito",PIANO_SERVIZIO:t.pacchetto,DATA_COMPILAZIONE:new Date().toLocaleDateString("it-IT"),DATI_CONFIGURAZIONE:JSON.stringify(o,null,2)},d=ko(s,l),c=await r.sendEmail({to:e.EMAIL_TO_INFO||"info@telemedcare.it",from:"info@telemedcare.it",subject:`üìã Nuova Configurazione Cliente: ${t.nomeRichiedente} ${t.cognomeRichiedente}`,html:d});c.success?(i.success=!0,i.emailsSent.push("email_configurazione -> info@telemedcare.it"),i.messageIds=[c.messageId],console.log(`‚úÖ [WORKFLOW] Email configurazione inviata con successo: ${c.messageId}`)):(i.errors.push(`Errore invio email configurazione: ${c.error}`),console.error("‚ùå [WORKFLOW] Errore invio email configurazione:",c.error))}catch(r){i.errors.push(`Eccezione invio email configurazione: ${r.message}`),console.error("‚ùå [WORKFLOW] Eccezione STEP 5:",r)}return i}async function tf(t,o,e,a){const i={success:!1,step:"email_conferma_attivazione",emailsSent:[],errors:[]};try{console.log(`üìß [WORKFLOW] STEP 6: Invio email conferma attivazione a ${t.email}`);const r=new Xe(e),s=await Bo("email_conferma_attivazione",a,e),l={NOME_CLIENTE:t.nomeRichiedente,COGNOME_CLIENTE:t.cognomeRichiedente,CODICE_CLIENTE:t.codiceCliente,PIANO_SERVIZIO:io(t.servizio||"PRO",t.pacchetto),MODELLO_DISPOSITIVO:o.modello||"SiDLY Care Pro V11.0",IMEI_DISPOSITIVO:o.imei,NUMERO_SIM:o.numeroSim||"Da configurare",DATA_ATTIVAZIONE:new Date(o.dataAssociazione).toLocaleDateString("it-IT"),TELEFONO_ASSISTENZA:"+39 02 1234567"},d=ko(s,l),c=await r.sendEmail({to:t.email,from:"info@telemedcare.it",subject:"‚úÖ TeleMedCare - Servizio Attivato!",html:d});c.success?(i.success=!0,i.emailsSent.push(`email_conferma -> ${t.email}`),i.messageIds=[c.messageId],console.log(`‚úÖ [WORKFLOW] Email conferma attivazione inviata con successo: ${c.messageId}`)):(i.errors.push(`Errore invio email conferma: ${c.error}`),console.error("‚ùå [WORKFLOW] Errore invio email conferma:",c.error))}catch(r){i.errors.push(`Eccezione invio email conferma: ${r.message}`),console.error("‚ùå [WORKFLOW] Eccezione STEP 6:",r)}return i}const Ks={inviaEmailNotificaInfo:Yg,inviaEmailDocumentiInformativi:Zg,inviaEmailContratto:Xg,inviaEmailProforma:Jg,inviaEmailBenvenuto:Qg,inviaEmailConfigurazione:ef,inviaEmailConfermaAttivazione:tf},Pc=Object.freeze(Object.defineProperty({__proto__:null,default:Ks,inviaEmailBenvenuto:Qg,inviaEmailConfermaAttivazione:tf,inviaEmailConfigurazione:ef,inviaEmailContratto:Xg,inviaEmailDocumentiInformativi:Zg,inviaEmailNotificaInfo:Yg,inviaEmailProforma:Jg},Symbol.toStringTag,{value:"Module"}));function vm(){const t=Date.now(),o=Math.floor(Math.random()*1e4).toString().padStart(4,"0");return`PAY${t}${o}`}async function xv(t,o){try{const e=vm();console.log(`üí≥ [PAYMENT] Registrazione pagamento ${e} per proforma ${o.proformaId}`),console.log("üí≥ [PAYMENT DEBUG] Full paymentData:",JSON.stringify(o));const a=e,i=o.proformaId,r=o.contractId,s=o.leadId,l=o.importo,d="EUR",c=o.metodoPagamento,u=o.transactionId||null,p="PENDING",g={field1_id:{value:a,type:typeof a,isUndefined:a===void 0},field2_proforma_id:{value:i,type:typeof i,isUndefined:i===void 0},field3_contract_id:{value:r,type:typeof r,isUndefined:r===void 0},field4_leadId:{value:s,type:typeof s,isUndefined:s===void 0},field5_importo:{value:l,type:typeof l,isUndefined:l===void 0},field6_valuta:{value:d,type:typeof d,isUndefined:d===void 0},field7_metodo:{value:c,type:typeof c,isUndefined:c===void 0},field8_transaction_id:{value:u,type:typeof u,isUndefined:u===void 0},field9_status:{value:p,type:typeof p,isUndefined:p===void 0}};if(console.log("üí≥ [PAYMENT DEBUG] All fields:",JSON.stringify(g,null,2)),a===void 0)return{success:!1,error:"Field 1 (id) is undefined",debug:g};if(i===void 0)return{success:!1,error:"Field 2 (proforma_id) is undefined",debug:g};if(r===void 0)return{success:!1,error:"Field 3 (contract_id) is undefined",debug:g};if(s===void 0)return{success:!1,error:"Field 4 (leadId) is undefined",debug:g};if(l===void 0)return{success:!1,error:"Field 5 (importo) is undefined",debug:g};if(c===void 0)return{success:!1,error:"Field 7 (metodo) is undefined",debug:g};const m=await t.prepare(`
      INSERT INTO payments (
        id,
        proforma_id,
        contract_id,
        leadId,
        importo,
        valuta,
        metodo_pagamento,
        transaction_id,
        status,
        data_pagamento
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
    `).bind(a,i,r,s,l,d,c,u,p).run();return console.log("‚úÖ [PAYMENT] INSERT successful:",m),console.log(`‚úÖ [PAYMENT] Pagamento ${e} registrato con successo`),{success:!0,paymentId:e}}catch(e){console.error("‚ùå [PAYMENT] Errore registrazione pagamento:",e);const a=vm(),i=o.proformaId,r=o.contractId,s=o.leadId,l=o.importo,d="EUR",c=o.metodoPagamento,u=o.transactionId||null,p="PENDING",g={field1_id:{value:a,type:typeof a,isUndefined:a===void 0},field2_proforma_id:{value:i,type:typeof i,isUndefined:i===void 0},field3_contract_id:{value:r,type:typeof r,isUndefined:r===void 0},field4_leadId:{value:s,type:typeof s,isUndefined:s===void 0},field5_importo:{value:l,type:typeof l,isUndefined:l===void 0},field6_valuta:{value:d,type:typeof d,isUndefined:d===void 0},field7_metodo:{value:c,type:typeof c,isUndefined:c===void 0},field8_transaction_id:{value:u,type:typeof u,isUndefined:u===void 0},field9_status:{value:p,type:typeof p,isUndefined:p===void 0},originalError:e.message};return{success:!1,error:e.message,debug:g}}}async function of(t,o){try{console.log(`‚úÖ [PAYMENT] Conferma pagamento ${o}`),await t.prepare(`
      UPDATE payments 
      SET status = 'COMPLETED', 
          data_conferma = datetime('now')
      WHERE id = ?
    `).bind(o).run();const e=await t.prepare(`
      SELECT * FROM payments WHERE id = ?
    `).bind(o).first();return e&&(await t.prepare(`
        UPDATE proforma 
        SET status = 'PAID', updated_at = datetime('now')
        WHERE id = ?
      `).bind(e.proforma_id).run(),await t.prepare(`
        UPDATE leads 
        SET status = 'CONVERTED', updated_at = datetime('now')
        WHERE id = ?
      `).bind(e.leadId).run(),console.log("‚úÖ [PAYMENT] Pagamento confermato e status aggiornati")),{success:!0,paymentId:o}}catch(e){return console.error("‚ùå [PAYMENT] Errore conferma pagamento:",e),{success:!1,error:e.message}}}async function Cv(t,o,e,a){try{console.log(`üí≥ [STRIPE] Creazione Payment Intent per ‚Ç¨${(o/100).toFixed(2)}`);const i=t.STRIPE_SECRET_KEY;if(!i)return console.warn("‚ö†Ô∏è [STRIPE] API Key non configurata, modalit√† test"),{success:!0,stripeClientSecret:`test_client_secret_${Date.now()}`,paymentId:`test_pi_${Date.now()}`};const r=await fetch("https://api.stripe.com/v1/payment_intents",{method:"POST",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({amount:o.toString(),currency:"eur",description:e,"metadata[proforma_id]":a.proformaId||"","metadata[contract_id]":a.contractId||"","metadata[lead_id]":a.leadId||""})});if(!r.ok){const l=await r.text();throw new Error(`Stripe API error: ${l}`)}const s=await r.json();return console.log(`‚úÖ [STRIPE] Payment Intent creato: ${s.id}`),{success:!0,stripeClientSecret:s.client_secret,paymentId:s.id}}catch(i){return console.error("‚ùå [STRIPE] Errore creazione Payment Intent:",i),{success:!1,error:i.message}}}async function Rv(t,o){try{if(console.log(`üîî [STRIPE WEBHOOK] Evento ricevuto: ${o.type}`),o.type==="payment_intent.succeeded"){const e=o.data.object,a=await t.prepare(`
        SELECT * FROM payments 
        WHERE stripe_payment_intent_id = ?
      `).bind(e.id).first();if(a)return await of(t,a.id),console.log(`‚úÖ [STRIPE WEBHOOK] Pagamento ${a.id} confermato automaticamente`),{success:!0,paymentId:a.id};console.warn(`‚ö†Ô∏è [STRIPE WEBHOOK] Pagamento non trovato per PaymentIntent ${e.id}`)}return{success:!0}}catch(e){return console.error("‚ùå [STRIPE WEBHOOK] Errore gestione webhook:",e),{success:!1,error:e.message}}}async function _v(t,o){try{const e=await t.prepare(`
      SELECT COUNT(*) as count 
      FROM payments 
      WHERE proforma_id = ? AND status = 'COMPLETED'
    `).bind(o).first();return(e==null?void 0:e.count)>0}catch(e){return console.error("‚ùå [PAYMENT] Errore verifica pagamento:",e),!1}}async function Ov(t,o){try{return await t.prepare(`
      SELECT * FROM payments WHERE id = ?
    `).bind(o).first()}catch(e){return console.error("‚ùå [PAYMENT] Errore recupero dettagli pagamento:",e),null}}const Em={registerPayment:xv,confirmPayment:of,createStripePaymentIntent:Cv,handleStripeWebhook:Rv,isProformaPaid:_v,getPaymentDetails:Ov};async function Dv(t,o){try{console.log(`üìã [CONFIG] Salvataggio configurazione per cliente ${o.codiceCliente}`);const e=JSON.stringify(o),a=o.leadId,i=e,r="SUBMITTED";if(console.log("üìã [CONFIG DEBUG] Field 1 (leadId):",a,typeof a),console.log("üìã [CONFIG DEBUG] Field 2 (config_data):",i==null?void 0:i.substring(0,50),typeof i),console.log("üìã [CONFIG DEBUG] Field 3 (status):",r,typeof r),a===void 0)throw new Error("Field 1 (leadId) is undefined");if(i===void 0)throw new Error("Field 2 (configuration_data) is undefined");const s=await t.prepare(`
      INSERT INTO configurations (
        leadId,
        configuration_data,
        status,
        created_at
      ) VALUES (?, ?, ?, datetime('now'))
    `).bind(a,i,r).run(),l=String(s.meta.last_row_id);return await t.prepare(`
      UPDATE leads 
      SET status = 'CONFIGURED', updated_at = datetime('now')
      WHERE id = ?
    `).bind(o.leadId).run(),console.log("‚úÖ [CONFIG] Configurazione salvata con successo"),{success:!0,configurationId:l}}catch(e){console.error("‚ùå [CONFIG] Errore salvataggio configurazione:",e);const a=o.leadId,i=JSON.stringify(o),r="SUBMITTED",s={field1_leadId:{value:a,type:typeof a,isUndefined:a===void 0},field2_config_data:{value:i==null?void 0:i.substring(0,50),type:typeof i,isUndefined:i===void 0},field3_status:{value:r,type:typeof r,isUndefined:r===void 0},originalError:e.message};return{success:!1,error:e.message,debug:s}}}async function Mv(t,o){try{const e=await t.prepare(`
      SELECT configuration_data 
      FROM configurations 
      WHERE leadId = ?
      ORDER BY created_at DESC
      LIMIT 1
    `).bind(o).first();return e&&e.configuration_data?JSON.parse(e.configuration_data):null}catch(e){return console.error("‚ùå [CONFIG] Errore recupero configurazione:",e),null}}async function zv(t,o){try{const e=await t.prepare(`
      SELECT COUNT(*) as count 
      FROM configurations 
      WHERE leadId = ? AND status = 'SUBMITTED'
    `).bind(o).first();return(e==null?void 0:e.count)>0}catch(e){return console.error("‚ùå [CONFIG] Errore verifica configurazione:",e),!1}}async function Lv(t,o,e){try{return await t.prepare(`
      UPDATE configurations 
      SET status = ?, updated_at = datetime('now')
      WHERE id = ?
    `).bind(e,o).run(),console.log(`‚úÖ [CONFIG] Status configurazione ${o} aggiornato a ${e}`),{success:!0}}catch(a){return console.error("‚ùå [CONFIG] Errore aggiornamento status:",a),{success:!1,error:a.message}}}const Nv={saveConfiguration:Dv,getConfiguration:Mv,hasCompletedConfiguration:zv,updateConfigurationStatus:Lv};/**
 * @license
 * Copyright 2025 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */globalThis.Buffer=hg;var Pu=function(t,o){return Pu=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,a){e.__proto__=a}||function(e,a){for(var i in a)Object.prototype.hasOwnProperty.call(a,i)&&(e[i]=a[i])},Pu(t,o)};function Fo(t,o){if(typeof o!="function"&&o!==null)throw new TypeError("Class extends value "+String(o)+" is not a constructor or null");Pu(t,o);function e(){this.constructor=t}t.prototype=o===null?Object.create(o):(e.prototype=o.prototype,new e)}function Pv(t,o,e,a){function i(r){return r instanceof e?r:new e(function(s){s(r)})}return new(e||(e=Promise))(function(r,s){function l(u){try{c(a.next(u))}catch(p){s(p)}}function d(u){try{c(a.throw(u))}catch(p){s(p)}}function c(u){u.done?r(u.value):i(u.value).then(l,d)}c((a=a.apply(t,[])).next())})}function af(t,o){var e={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},a,i,r,s;return s={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function l(c){return function(u){return d([c,u])}}function d(c){if(a)throw new TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(e=0)),e;)try{if(a=1,i&&(r=c[0]&2?i.return:c[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,c[1])).done)return r;switch(i=0,r&&(c=[c[0]&2,r.value]),c[0]){case 0:case 1:r=c;break;case 4:return e.label++,{value:c[1],done:!1};case 5:e.label++,i=c[1],c=[0];continue;case 7:c=e.ops.pop(),e.trys.pop();continue;default:if(r=e.trys,!(r=r.length>0&&r[r.length-1])&&(c[0]===6||c[0]===2)){e=0;continue}if(c[0]===3&&(!r||c[1]>r[0]&&c[1]<r[3])){e.label=c[1];break}if(c[0]===6&&e.label<r[1]){e.label=r[1],r=c;break}if(r&&e.label<r[2]){e.label=r[2],e.ops.push(c);break}r[2]&&e.ops.pop(),e.trys.pop();continue}c=o.call(t,e)}catch(u){c=[6,u],i=0}finally{a=r=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}function qs(t){var o=typeof Symbol=="function"&&Symbol.iterator,e=o&&t[o],a=0;if(e)return e.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&a>=t.length&&(t=void 0),{value:t&&t[a++],done:!t}}};throw new TypeError(o?"Object is not iterable.":"Symbol.iterator is not defined.")}function tr(t,o){var e=typeof Symbol=="function"&&t[Symbol.iterator];if(!e)return t;var a=e.call(t),i,r=[],s;try{for(;(o===void 0||o-- >0)&&!(i=a.next()).done;)r.push(i.value)}catch(l){s={error:l}}finally{try{i&&!i.done&&(e=a.return)&&e.call(a)}finally{if(s)throw s.error}}return r}function Ys(t,o,e){if(arguments.length===2)for(var a=0,i=o.length,r;a<i;a++)(r||!(a in o))&&(r||(r=Array.prototype.slice.call(o,0,a)),r[a]=o[a]);return t.concat(r||Array.prototype.slice.call(o))}function Ir(t){return this instanceof Ir?(this.v=t,this):new Ir(t)}function Bv(t,o,e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var a=e.apply(t,o||[]),i,r=[];return i={},s("next"),s("throw"),s("return"),i[Symbol.asyncIterator]=function(){return this},i;function s(g){a[g]&&(i[g]=function(m){return new Promise(function(b,h){r.push([g,m,b,h])>1||l(g,m)})})}function l(g,m){try{d(a[g](m))}catch(b){p(r[0][3],b)}}function d(g){g.value instanceof Ir?Promise.resolve(g.value.v).then(c,u):p(r[0][2],g)}function c(g){l("next",g)}function u(g){l("throw",g)}function p(g,m){g(m),r.shift(),r.length&&l(r[0][0],r[0][1])}}function kv(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var o=t[Symbol.asyncIterator],e;return o?o.call(t):(t=typeof qs=="function"?qs(t):t[Symbol.iterator](),e={},a("next"),a("throw"),a("return"),e[Symbol.asyncIterator]=function(){return this},e);function a(r){e[r]=t[r]&&function(s){return new Promise(function(l,d){s=t[r](s),i(l,d,s.done,s.value)})}}function i(r,s,l,d){Promise.resolve(d).then(function(c){r({value:c,done:l})},s)}}function Ee(t){return typeof t=="function"}function Hp(t){var o=function(a){Error.call(a),a.stack=new Error().stack},e=t(o);return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,e}var Eu=Hp(function(t){return function(e){t(this),this.message=e?e.length+` errors occurred during unsubscription:
`+e.map(function(a,i){return i+1+") "+a.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=e}});function yd(t,o){if(t){var e=t.indexOf(o);0<=e&&t.splice(e,1)}}var Bc=(function(){function t(o){this.initialTeardown=o,this.closed=!1,this._parentage=null,this._finalizers=null}return t.prototype.unsubscribe=function(){var o,e,a,i,r;if(!this.closed){this.closed=!0;var s=this._parentage;if(s)if(this._parentage=null,Array.isArray(s))try{for(var l=qs(s),d=l.next();!d.done;d=l.next()){var c=d.value;c.remove(this)}}catch(h){o={error:h}}finally{try{d&&!d.done&&(e=l.return)&&e.call(l)}finally{if(o)throw o.error}}else s.remove(this);var u=this.initialTeardown;if(Ee(u))try{u()}catch(h){r=h instanceof Eu?h.errors:[h]}var p=this._finalizers;if(p){this._finalizers=null;try{for(var g=qs(p),m=g.next();!m.done;m=g.next()){var b=m.value;try{bm(b)}catch(h){r=r??[],h instanceof Eu?r=Ys(Ys([],tr(r)),tr(h.errors)):r.push(h)}}}catch(h){a={error:h}}finally{try{m&&!m.done&&(i=g.return)&&i.call(g)}finally{if(a)throw a.error}}}if(r)throw new Eu(r)}},t.prototype.add=function(o){var e;if(o&&o!==this)if(this.closed)bm(o);else{if(o instanceof t){if(o.closed||o._hasParent(this))return;o._addParent(this)}(this._finalizers=(e=this._finalizers)!==null&&e!==void 0?e:[]).push(o)}},t.prototype._hasParent=function(o){var e=this._parentage;return e===o||Array.isArray(e)&&e.includes(o)},t.prototype._addParent=function(o){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(o),e):e?[e,o]:o},t.prototype._removeParent=function(o){var e=this._parentage;e===o?this._parentage=null:Array.isArray(e)&&yd(e,o)},t.prototype.remove=function(o){var e=this._finalizers;e&&yd(e,o),o instanceof t&&o._removeParent(this)},t.EMPTY=(function(){var o=new t;return o.closed=!0,o})(),t})(),rf=Bc.EMPTY;function sf(t){return t instanceof Bc||t&&"closed"in t&&Ee(t.remove)&&Ee(t.add)&&Ee(t.unsubscribe)}function bm(t){Ee(t)?t():t.unsubscribe()}var Fv={Promise:void 0},$v={setTimeout:function(t,o){for(var e=[],a=2;a<arguments.length;a++)e[a-2]=arguments[a];return setTimeout.apply(void 0,Ys([t,o],tr(e)))},clearTimeout:function(t){return clearTimeout(t)},delegate:void 0};function nf(t){$v.setTimeout(function(){throw t})}function Zs(){}function ed(t){t()}var Vp=(function(t){Fo(o,t);function o(e){var a=t.call(this)||this;return a.isStopped=!1,e?(a.destination=e,sf(e)&&e.add(a)):a.destination=Hv,a}return o.create=function(e,a,i){return new Td(e,a,i)},o.prototype.next=function(e){this.isStopped||this._next(e)},o.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},o.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},o.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this),this.destination=null)},o.prototype._next=function(e){this.destination.next(e)},o.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},o.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},o})(Bc),Uv=(function(){function t(o){this.partialObserver=o}return t.prototype.next=function(o){var e=this.partialObserver;if(e.next)try{e.next(o)}catch(a){Hc(a)}},t.prototype.error=function(o){var e=this.partialObserver;if(e.error)try{e.error(o)}catch(a){Hc(a)}else Hc(o)},t.prototype.complete=function(){var o=this.partialObserver;if(o.complete)try{o.complete()}catch(e){Hc(e)}},t})(),Td=(function(t){Fo(o,t);function o(e,a,i){var r=t.call(this)||this,s;return Ee(e)||!e?s={next:e??void 0,error:a??void 0,complete:i??void 0}:s=e,r.destination=new Uv(s),r}return o})(Vp);function Hc(t){nf(t)}function jv(t){throw t}var Hv={closed:!0,next:Zs,error:jv,complete:Zs},Wp=(function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"})();function Ba(t){return t}function Vv(){for(var t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];return lf(t)}function lf(t){return t.length===0?Ba:t.length===1?t[0]:function(e){return t.reduce(function(a,i){return i(a)},e)}}var Pe=(function(){function t(o){o&&(this._subscribe=o)}return t.prototype.lift=function(o){var e=new t;return e.source=this,e.operator=o,e},t.prototype.subscribe=function(o,e,a){var i=this,r=Gv(o)?o:new Td(o,e,a);return ed(function(){var s=i,l=s.operator,d=s.source;r.add(l?l.call(r,d):d?i._subscribe(r):i._trySubscribe(r))}),r},t.prototype._trySubscribe=function(o){try{return this._subscribe(o)}catch(e){o.error(e)}},t.prototype.forEach=function(o,e){var a=this;return e=ym(e),new e(function(i,r){var s=new Td({next:function(l){try{o(l)}catch(d){r(d),s.unsubscribe()}},error:r,complete:i});a.subscribe(s)})},t.prototype._subscribe=function(o){var e;return(e=this.source)===null||e===void 0?void 0:e.subscribe(o)},t.prototype[Wp]=function(){return this},t.prototype.pipe=function(){for(var o=[],e=0;e<arguments.length;e++)o[e]=arguments[e];return lf(o)(this)},t.prototype.toPromise=function(o){var e=this;return o=ym(o),new o(function(a,i){var r;e.subscribe(function(s){return r=s},function(s){return i(s)},function(){return a(r)})})},t.create=function(o){return new t(o)},t})();function ym(t){var o;return(o=t??Fv.Promise)!==null&&o!==void 0?o:Promise}function Wv(t){return t&&Ee(t.next)&&Ee(t.error)&&Ee(t.complete)}function Gv(t){return t&&t instanceof Vp||Wv(t)&&sf(t)}function Kv(t){return Ee(t==null?void 0:t.lift)}function Ve(t){return function(o){if(Kv(o))return o.lift(function(e){try{return t(e,this)}catch(a){this.error(a)}});throw new TypeError("Unable to lift unknown Observable type")}}function He(t,o,e,a,i){return new qv(t,o,e,a,i)}var qv=(function(t){Fo(o,t);function o(e,a,i,r,s,l){var d=t.call(this,e)||this;return d.onFinalize=s,d.shouldUnsubscribe=l,d._next=a?function(c){try{a(c)}catch(u){e.error(u)}}:t.prototype._next,d._error=r?function(c){try{r(c)}catch(u){e.error(u)}finally{this.unsubscribe()}}:t.prototype._error,d._complete=i?function(){try{i()}catch(c){e.error(c)}finally{this.unsubscribe()}}:t.prototype._complete,d}return o.prototype.unsubscribe=function(){var e;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var a=this.closed;t.prototype.unsubscribe.call(this),!a&&((e=this.onFinalize)===null||e===void 0||e.call(this))}},o})(Vp),Yv=Hp(function(t){return function(){t(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),cf=(function(t){Fo(o,t);function o(){var e=t.call(this)||this;return e.closed=!1,e.currentObservers=null,e.observers=[],e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return o.prototype.lift=function(e){var a=new Tm(this,this);return a.operator=e,a},o.prototype._throwIfClosed=function(){if(this.closed)throw new Yv},o.prototype.next=function(e){var a=this;ed(function(){var i,r;if(a._throwIfClosed(),!a.isStopped){a.currentObservers||(a.currentObservers=Array.from(a.observers));try{for(var s=qs(a.currentObservers),l=s.next();!l.done;l=s.next()){var d=l.value;d.next(e)}}catch(c){i={error:c}}finally{try{l&&!l.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}}})},o.prototype.error=function(e){var a=this;ed(function(){if(a._throwIfClosed(),!a.isStopped){a.hasError=a.isStopped=!0,a.thrownError=e;for(var i=a.observers;i.length;)i.shift().error(e)}})},o.prototype.complete=function(){var e=this;ed(function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var a=e.observers;a.length;)a.shift().complete()}})},o.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(o.prototype,"observed",{get:function(){var e;return((e=this.observers)===null||e===void 0?void 0:e.length)>0},enumerable:!1,configurable:!0}),o.prototype._trySubscribe=function(e){return this._throwIfClosed(),t.prototype._trySubscribe.call(this,e)},o.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},o.prototype._innerSubscribe=function(e){var a=this,i=this,r=i.hasError,s=i.isStopped,l=i.observers;return r||s?rf:(this.currentObservers=null,l.push(e),new Bc(function(){a.currentObservers=null,yd(l,e)}))},o.prototype._checkFinalizedStatuses=function(e){var a=this,i=a.hasError,r=a.thrownError,s=a.isStopped;i?e.error(r):s&&e.complete()},o.prototype.asObservable=function(){var e=new Pe;return e.source=this,e},o.create=function(e,a){return new Tm(e,a)},o})(Pe),Tm=(function(t){Fo(o,t);function o(e,a){var i=t.call(this)||this;return i.destination=e,i.source=a,i}return o.prototype.next=function(e){var a,i;(i=(a=this.destination)===null||a===void 0?void 0:a.next)===null||i===void 0||i.call(a,e)},o.prototype.error=function(e){var a,i;(i=(a=this.destination)===null||a===void 0?void 0:a.error)===null||i===void 0||i.call(a,e)},o.prototype.complete=function(){var e,a;(a=(e=this.destination)===null||e===void 0?void 0:e.complete)===null||a===void 0||a.call(e)},o.prototype._subscribe=function(e){var a,i;return(i=(a=this.source)===null||a===void 0?void 0:a.subscribe(e))!==null&&i!==void 0?i:rf},o})(cf),Gp={now:function(){return(Gp.delegate||Date).now()},delegate:void 0},Zv=(function(t){Fo(o,t);function o(e,a,i){e===void 0&&(e=1/0),a===void 0&&(a=1/0),i===void 0&&(i=Gp);var r=t.call(this)||this;return r._bufferSize=e,r._windowTime=a,r._timestampProvider=i,r._buffer=[],r._infiniteTimeWindow=!0,r._infiniteTimeWindow=a===1/0,r._bufferSize=Math.max(1,e),r._windowTime=Math.max(1,a),r}return o.prototype.next=function(e){var a=this,i=a.isStopped,r=a._buffer,s=a._infiniteTimeWindow,l=a._timestampProvider,d=a._windowTime;i||(r.push(e),!s&&r.push(l.now()+d)),this._trimBuffer(),t.prototype.next.call(this,e)},o.prototype._subscribe=function(e){this._throwIfClosed(),this._trimBuffer();for(var a=this._innerSubscribe(e),i=this,r=i._infiniteTimeWindow,s=i._buffer,l=s.slice(),d=0;d<l.length&&!e.closed;d+=r?1:2)e.next(l[d]);return this._checkFinalizedStatuses(e),a},o.prototype._trimBuffer=function(){var e=this,a=e._bufferSize,i=e._timestampProvider,r=e._buffer,s=e._infiniteTimeWindow,l=(s?1:2)*a;if(a<1/0&&l<r.length&&r.splice(0,r.length-l),!s){for(var d=i.now(),c=0,u=1;u<r.length&&r[u]<=d;u+=2)c=u;c&&r.splice(0,c+1)}},o})(cf),Xv=(function(t){Fo(o,t);function o(e,a){return t.call(this)||this}return o.prototype.schedule=function(e,a){return this},o})(Bc),wm={setInterval:function(t,o){for(var e=[],a=2;a<arguments.length;a++)e[a-2]=arguments[a];return setInterval.apply(void 0,Ys([t,o],tr(e)))},clearInterval:function(t){return clearInterval(t)},delegate:void 0},Jv=(function(t){Fo(o,t);function o(e,a){var i=t.call(this,e,a)||this;return i.scheduler=e,i.work=a,i.pending=!1,i}return o.prototype.schedule=function(e,a){var i;if(a===void 0&&(a=0),this.closed)return this;this.state=e;var r=this.id,s=this.scheduler;return r!=null&&(this.id=this.recycleAsyncId(s,r,a)),this.pending=!0,this.delay=a,this.id=(i=this.id)!==null&&i!==void 0?i:this.requestAsyncId(s,this.id,a),this},o.prototype.requestAsyncId=function(e,a,i){return i===void 0&&(i=0),wm.setInterval(e.flush.bind(e,this),i)},o.prototype.recycleAsyncId=function(e,a,i){if(i===void 0&&(i=0),i!=null&&this.delay===i&&this.pending===!1)return a;a!=null&&wm.clearInterval(a)},o.prototype.execute=function(e,a){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var i=this._execute(e,a);if(i)return i;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},o.prototype._execute=function(e,a){var i=!1,r;try{this.work(e)}catch(s){i=!0,r=s||new Error("Scheduled action threw falsy error")}if(i)return this.unsubscribe(),r},o.prototype.unsubscribe=function(){if(!this.closed){var e=this,a=e.id,i=e.scheduler,r=i.actions;this.work=this.state=this.scheduler=null,this.pending=!1,yd(r,this),a!=null&&(this.id=this.recycleAsyncId(i,a,null)),this.delay=null,t.prototype.unsubscribe.call(this)}},o})(Xv),Im=(function(){function t(o,e){e===void 0&&(e=t.now),this.schedulerActionCtor=o,this.now=e}return t.prototype.schedule=function(o,e,a){return e===void 0&&(e=0),new this.schedulerActionCtor(this,o).schedule(a,e)},t.now=Gp.now,t})(),Qv=(function(t){Fo(o,t);function o(e,a){a===void 0&&(a=Im.now);var i=t.call(this,e,a)||this;return i.actions=[],i._active=!1,i}return o.prototype.flush=function(e){var a=this.actions;if(this._active){a.push(e);return}var i;this._active=!0;do if(i=e.execute(e.state,e.delay))break;while(e=a.shift());if(this._active=!1,i){for(;e=a.shift();)e.unsubscribe();throw i}},o})(Im),eE=new Qv(Jv),tE=eE,Qi=new Pe(function(t){return t.complete()});function oE(t){return t&&Ee(t.schedule)}function df(t){return t[t.length-1]}function su(t){return oE(df(t))?t.pop():void 0}function aE(t,o){return typeof df(t)=="number"?t.pop():o}var Kp=function(t){return t&&typeof t.length=="number"&&typeof t!="function"};function uf(t){return Ee(t==null?void 0:t.then)}function pf(t){return Ee(t[Wp])}function mf(t){return Symbol.asyncIterator&&Ee(t==null?void 0:t[Symbol.asyncIterator])}function gf(t){return new TypeError("You provided "+(t!==null&&typeof t=="object"?"an invalid object":"'"+t+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function iE(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var ff=iE();function hf(t){return Ee(t==null?void 0:t[ff])}function vf(t){return Bv(this,arguments,function(){var e,a,i,r;return af(this,function(s){switch(s.label){case 0:e=t.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,Ir(e.read())];case 3:return a=s.sent(),i=a.value,r=a.done,r?[4,Ir(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,Ir(i)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}})})}function Ef(t){return Ee(t==null?void 0:t.getReader)}function dt(t){if(t instanceof Pe)return t;if(t!=null){if(pf(t))return rE(t);if(Kp(t))return sE(t);if(uf(t))return nE(t);if(mf(t))return bf(t);if(hf(t))return lE(t);if(Ef(t))return cE(t)}throw gf(t)}function rE(t){return new Pe(function(o){var e=t[Wp]();if(Ee(e.subscribe))return e.subscribe(o);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function sE(t){return new Pe(function(o){for(var e=0;e<t.length&&!o.closed;e++)o.next(t[e]);o.complete()})}function nE(t){return new Pe(function(o){t.then(function(e){o.closed||(o.next(e),o.complete())},function(e){return o.error(e)}).then(null,nf)})}function lE(t){return new Pe(function(o){var e,a;try{for(var i=qs(t),r=i.next();!r.done;r=i.next()){var s=r.value;if(o.next(s),o.closed)return}}catch(l){e={error:l}}finally{try{r&&!r.done&&(a=i.return)&&a.call(i)}finally{if(e)throw e.error}}o.complete()})}function bf(t){return new Pe(function(o){dE(t,o).catch(function(e){return o.error(e)})})}function cE(t){return bf(vf(t))}function dE(t,o){var e,a,i,r;return Pv(this,void 0,void 0,function(){var s,l;return af(this,function(d){switch(d.label){case 0:d.trys.push([0,5,6,11]),e=kv(t),d.label=1;case 1:return[4,e.next()];case 2:if(a=d.sent(),!!a.done)return[3,4];if(s=a.value,o.next(s),o.closed)return[2];d.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return l=d.sent(),i={error:l},[3,11];case 6:return d.trys.push([6,,9,10]),a&&!a.done&&(r=e.return)?[4,r.call(e)]:[3,8];case 7:d.sent(),d.label=8;case 8:return[3,10];case 9:if(i)throw i.error;return[7];case 10:return[7];case 11:return o.complete(),[2]}})})}function er(t,o,e,a,i){a===void 0&&(a=0),i===void 0&&(i=!1);var r=o.schedule(function(){e(),i?t.add(this.schedule(null,a)):this.unsubscribe()},a);if(t.add(r),!i)return r}function yf(t,o){return o===void 0&&(o=0),Ve(function(e,a){e.subscribe(He(a,function(i){return er(a,t,function(){return a.next(i)},o)},function(){return er(a,t,function(){return a.complete()},o)},function(i){return er(a,t,function(){return a.error(i)},o)}))})}function Tf(t,o){return o===void 0&&(o=0),Ve(function(e,a){a.add(t.schedule(function(){return e.subscribe(a)},o))})}function uE(t,o){return dt(t).pipe(Tf(o),yf(o))}function pE(t,o){return dt(t).pipe(Tf(o),yf(o))}function mE(t,o){return new Pe(function(e){var a=0;return o.schedule(function(){a===t.length?e.complete():(e.next(t[a++]),e.closed||this.schedule())})})}function gE(t,o){return new Pe(function(e){var a;return er(e,o,function(){a=t[ff](),er(e,o,function(){var i,r,s;try{i=a.next(),r=i.value,s=i.done}catch(l){e.error(l);return}s?e.complete():e.next(r)},0,!0)}),function(){return Ee(a==null?void 0:a.return)&&a.return()}})}function wf(t,o){if(!t)throw new Error("Iterable cannot be null");return new Pe(function(e){er(e,o,function(){var a=t[Symbol.asyncIterator]();er(e,o,function(){a.next().then(function(i){i.done?e.complete():e.next(i.value)})},0,!0)})})}function fE(t,o){return wf(vf(t),o)}function hE(t,o){if(t!=null){if(pf(t))return uE(t,o);if(Kp(t))return mE(t,o);if(uf(t))return pE(t,o);if(mf(t))return wf(t,o);if(hf(t))return gE(t,o);if(Ef(t))return fE(t,o)}throw gf(t)}function ue(t,o){return o?hE(t,o):dt(t)}function Sm(){for(var t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];var e=su(t);return ue(t,e)}var qp=Hp(function(t){return function(){t(this),this.name="EmptyError",this.message="no elements in sequence"}});function nt(t,o){return new Promise(function(e,a){var i=new Td({next:function(r){e(r),i.unsubscribe()},error:a,complete:function(){a(new qp)}});t.subscribe(i)})}function vE(t){return t instanceof Date&&!isNaN(t)}function st(t,o){return Ve(function(e,a){var i=0;e.subscribe(He(a,function(r){a.next(t.call(o,r,i++))}))})}var EE=Array.isArray;function bE(t,o){return EE(o)?t.apply(void 0,Ys([],tr(o))):t(o)}function yE(t){return st(function(o){return bE(t,o)})}function If(t,o,e,a,i,r,s,l){var d=[],c=0,u=0,p=!1,g=function(){p&&!d.length&&!c&&o.complete()},m=function(h){return c<a?b(h):d.push(h)},b=function(h){r&&o.next(h),c++;var E=!1;dt(e(h,u++)).subscribe(He(o,function(w){i==null||i(w),r?m(w):o.next(w)},function(){E=!0},void 0,function(){if(E)try{c--;for(var w=function(){var S=d.shift();s||b(S)};d.length&&c<a;)w();g()}catch(S){o.error(S)}}))};return t.subscribe(He(o,m,function(){p=!0,g()})),function(){l==null||l()}}function $e(t,o,e){return e===void 0&&(e=1/0),Ee(o)?$e(function(a,i){return st(function(r,s){return o(a,r,i,s)})(dt(t(a,i)))},e):(typeof o=="number"&&(e=o),Ve(function(a,i){return If(a,i,t,e)}))}function Sf(t){return t===void 0&&(t=1/0),$e(Ba,t)}function TE(){return Sf(1)}function Bu(){for(var t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];return TE()(ue(t,su(t)))}function Sr(t){return new Pe(function(o){dt(t()).subscribe(o)})}var wE=["addListener","removeListener"],IE=["addEventListener","removeEventListener"],SE=["on","off"];function ku(t,o,e,a){if(Ee(e)&&(a=e,e=void 0),a)return ku(t,o,e).pipe(yE(a));var i=tr(CE(t)?IE.map(function(l){return function(d){return t[l](o,d,e)}}):AE(t)?wE.map(Am(t,o)):xE(t)?SE.map(Am(t,o)):[],2),r=i[0],s=i[1];if(!r&&Kp(t))return $e(function(l){return ku(l,o,e)})(dt(t));if(!r)throw new TypeError("Invalid event target");return new Pe(function(l){var d=function(){for(var c=[],u=0;u<arguments.length;u++)c[u]=arguments[u];return l.next(1<c.length?c:c[0])};return r(d),function(){return s(d)}})}function Am(t,o){return function(e){return function(a){return t[e](o,a)}}}function AE(t){return Ee(t.addListener)&&Ee(t.removeListener)}function xE(t){return Ee(t.on)&&Ee(t.off)}function CE(t){return Ee(t.addEventListener)&&Ee(t.removeEventListener)}function Yp(t,o,e){return t===void 0&&(t=0),e===void 0&&(e=tE),new Pe(function(a){var i=vE(t)?+t-e.now():t;i<0&&(i=0);var r=0;return e.schedule(function(){a.closed||(a.next(r++),a.complete())},i)})}function In(){for(var t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];var e=su(t),a=aE(t,1/0),i=t;return i.length?i.length===1?dt(i[0]):Sf(a)(ue(i,e)):Qi}var Af=new Pe(Zs),RE=Array.isArray;function _E(t){return t.length===1&&RE(t[0])?t[0]:t}function tn(t,o){return Ve(function(e,a){var i=0;e.subscribe(He(a,function(r){return t.call(o,r,i++)&&a.next(r)}))})}function OE(){for(var t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];return t=_E(t),t.length===1?dt(t[0]):new Pe(xf(t))}function xf(t){return function(o){for(var e=[],a=function(r){e.push(dt(t[r]).subscribe(He(o,function(s){if(e){for(var l=0;l<e.length;l++)l!==r&&e[l].unsubscribe();e=null}o.next(s)})))},i=0;e&&!o.closed&&i<t.length;i++)a(i)}}function dn(t){return Ve(function(o,e){var a=null,i=!1,r;a=o.subscribe(He(e,void 0,void 0,function(s){r=dt(t(s,dn(t)(o))),a?(a.unsubscribe(),a=null,r.subscribe(e)):i=!0})),i&&(a.unsubscribe(),a=null,r.subscribe(e))})}function Cf(t){return Ve(function(o,e){var a=!1;o.subscribe(He(e,function(i){a=!0,e.next(i)},function(){a||e.next(t),e.complete()}))})}function Rf(t){return t<=0?function(){return Qi}:Ve(function(o,e){var a=0;o.subscribe(He(e,function(i){++a<=t&&(e.next(i),t<=a&&e.complete())}))})}function td(){return Ve(function(t,o){t.subscribe(He(o,Zs))})}function nu(t){return t===void 0&&(t=DE),Ve(function(o,e){var a=!1;o.subscribe(He(e,function(i){a=!0,e.next(i)},function(){return a?e.complete():e.error(t())}))})}function DE(){return new qp}function wd(t,o){var e=arguments.length>=2;return function(a){return a.pipe(t?tn(function(i,r){return t(i,r,a)}):Ba,Rf(1),e?Cf(o):nu(function(){return new qp}))}}function ME(t,o,e){return e===void 0&&(e=1/0),Ve(function(a,i){var r=o;return If(a,i,function(s,l){return t(r,s,l)},e,function(s){r=s},!1,void 0,function(){return r=null})})}function to(){for(var t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];return t.length?Ve(function(e,a){xf(Ys([e],tr(t)))(a)}):Ba}function od(t){t===void 0&&(t=1/0);var o;t&&typeof t=="object"?o=t:o={count:t};var e=o.count,a=e===void 0?1/0:e,i=o.delay,r=o.resetOnSuccess,s=r===void 0?!1:r;return a<=0?Ba:Ve(function(l,d){var c=0,u,p=function(){var g=!1;u=l.subscribe(He(d,function(m){s&&(c=0),d.next(m)},void 0,function(m){if(c++<a){var b=function(){u?(u.unsubscribe(),u=null,p()):g=!0};if(i!=null){var h=typeof i=="number"?Yp(i):dt(i(m,c)),E=He(d,function(){E.unsubscribe(),b()},function(){d.complete()});h.subscribe(E)}else b()}else d.error(m)})),g&&(u.unsubscribe(),u=null,p())};p()})}function zE(){for(var t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];var e=su(t);return Ve(function(a,i){(e?Bu(t,a,e):Bu(t,a)).subscribe(i)})}function LE(t,o){return Ve(function(e,a){var i=null,r=0,s=!1,l=function(){return s&&!i&&a.complete()};e.subscribe(He(a,function(d){i==null||i.unsubscribe();var c=0,u=r++;dt(t(d,u)).subscribe(i=He(a,function(p){return a.next(o?o(d,p,u,c++):p)},function(){i=null,l()}))},function(){s=!0,l()}))})}function NE(t){return Ve(function(o,e){dt(t).subscribe(He(e,function(){return e.complete()},Zs)),!e.closed&&o.subscribe(e)})}function Vc(t,o,e){var a=Ee(t)||o||e?{next:t,error:o,complete:e}:t;return a?Ve(function(i,r){var s;(s=a.subscribe)===null||s===void 0||s.call(a);var l=!0;i.subscribe(He(r,function(d){var c;(c=a.next)===null||c===void 0||c.call(a,d),r.next(d)},function(){var d;l=!1,(d=a.complete)===null||d===void 0||d.call(a),r.complete()},function(d){var c;l=!1,(c=a.error)===null||c===void 0||c.call(a,d),r.error(d)},function(){var d,c;l&&((d=a.unsubscribe)===null||d===void 0||d.call(a)),(c=a.finalize)===null||c===void 0||c.call(a)}))}):Ba}const Zp="1.0.4";/**
 * @license
 * Copyright 2020 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const $=(t,o)=>{if(!t)throw new Error(o)};/**
 * @license
 * Copyright 2020 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const _f=!!(typeof process<"u"&&process.version);var PE={};let bu=null;async function BE(){return bu||(bu=(await Promise.resolve().then(()=>NT)).default),bu}const Xp=t=>_f?async(...o)=>{const e=PE.DEBUG||"";(e==="*"||(e.endsWith("*")?t.startsWith(e):t===e))&&(await BE())(t)(o)}:(...o)=>{const e=globalThis.__PUPPETEER_DEBUG;!e||!(e==="*"||(e.endsWith("*")?t.startsWith(e):t===e))||console.log(`${t}:`,...o)};/**
 * @license
 * Copyright 2018 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class Jp extends Error{constructor(o,e){super(o,e),this.name=this.constructor.name}get[Symbol.toStringTag](){return this.constructor.name}}class Qp extends Jp{}var Nn,Pn;class Sn extends Jp{constructor(){super(...arguments);f(this,Nn);f(this,Pn,"")}set code(e){v(this,Nn,e)}get code(){return n(this,Nn)}set originalMessage(e){v(this,Pn,e)}get originalMessage(){return n(this,Pn)}}Nn=new WeakMap,Pn=new WeakMap;class Of extends Jp{}class za extends Sn{}/**
 * @license
 * Copyright 2020 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const kE={letter:{width:8.5,height:11},legal:{width:8.5,height:14},tabloid:{width:11,height:17},ledger:{width:17,height:11},a0:{width:33.1,height:46.8},a1:{width:23.4,height:33.1},a2:{width:16.54,height:23.4},a3:{width:11.7,height:16.54},a4:{width:8.27,height:11.7},a5:{width:5.83,height:8.27},a6:{width:4.13,height:5.83}};/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const X=Xp("puppeteer:error"),FE=Object.freeze({width:800,height:600}),Id=Symbol("Source URL for Puppeteer evaluation scripts");var Ja,Qa;const Wa=class Wa{constructor(){f(this,Ja);f(this,Qa)}static fromCallSite(o,e){const a=new Wa;return v(a,Ja,o),v(a,Qa,e.toString()),a}get functionName(){return n(this,Ja)}get siteString(){return n(this,Qa)}toString(){return`pptr:${[n(this,Ja),encodeURIComponent(n(this,Qa))].join(";")}`}};Ja=new WeakMap,Qa=new WeakMap,O(Wa,"INTERNAL_URL","pptr:internal"),O(Wa,"parse",o=>{o=o.slice(5);const[e="",a=""]=o.split(";"),i=new Wa;return v(i,Ja,e),v(i,Qa,decodeURIComponent(a)),i}),O(Wa,"isPuppeteerURL",o=>o.startsWith("pptr:"));let Mo=Wa;const Ne=(t,o)=>{if(Object.prototype.hasOwnProperty.call(o,Id))return o;const e=Error.prepareStackTrace;Error.prepareStackTrace=(i,r)=>r[2];const a=new Error().stack;return Error.prepareStackTrace=e,Object.assign(o,{[Id]:Mo.fromCallSite(t,a)})},$E=t=>{if(Object.prototype.hasOwnProperty.call(t,Id))return t[Id]},rr=t=>typeof t=="string"||t instanceof String,UE=t=>typeof t=="number"||t instanceof Number;function Df(t,...o){var i;if(rr(t))return $(o.length===0,"Cannot evaluate a string with arguments"),t;function e(r){return Object.is(r,void 0)?"undefined":JSON.stringify(r)}const a=`(${t})(${o.map(e).join(",")})`;return((i=globalThis.navigator)==null?void 0:i.userAgent)==="Cloudflare-Workers"?`((__name => (${a}))(t => t))`:a}let yu=null;async function xm(){if(!yu)try{yu=await import("fs/promises")}catch(t){throw t instanceof TypeError?new Error("Cannot write to a path outside of a Node-like environment. fs"):t}return yu}async function Mf(t,o){const e=[],a=t.getReader();if(o)throw new Error("Cannot write to a path outside of a Node-like environment.");for(;;){const{done:i,value:r}=await a.read();if(i)break;e.push(r)}try{return hg.concat(e)}catch(i){return X(i),null}}async function zf(t,o){return new ReadableStream({async pull(e){function a(l,d){return d?Uint8Array.from(atob(l),u=>u.codePointAt(0)):new TextEncoder().encode(l)}const{data:i,base64Encoded:r,eof:s}=await t.send("IO.read",{handle:o});e.enqueue(a(i,r??!1)),s&&(await t.send("IO.close",{handle:o}),e.close())}})}function jE(t){let o=null;return new Set(["alert","confirm","prompt","beforeunload"]).has(t)&&(o=t),$(o,`Unknown javascript dialog type: ${t}`),o}function oo(t,o){return t===0?Af:Yp(t).pipe(st(()=>{throw new Qp(`Timed out after waiting ${t}ms`,{cause:o})}))}const Cm="__puppeteer_utility_world__"+Zp,Rm=/^[\040\t]*\/\/[@#] sourceURL=\s*(\S*?)\s*$/m;function HE(t){return`//# sourceURL=${t}`}const VE=500;function WE(t={},o="in"){var s,l,d,c;const e={scale:1,displayHeaderFooter:!1,headerTemplate:"",footerTemplate:"",printBackground:!1,landscape:!1,pageRanges:"",preferCSSPageSize:!1,omitBackground:!1,outline:!1,tagged:!0,waitForFonts:!0};let a=8.5,i=11;if(t.format){const u=kE[t.format.toLowerCase()];$(u,"Unknown paper format: "+t.format),a=u.width,i=u.height}else a=gr(t.width,o)??a,i=gr(t.height,o)??i;const r={top:gr((s=t.margin)==null?void 0:s.top,o)||0,left:gr((l=t.margin)==null?void 0:l.left,o)||0,bottom:gr((d=t.margin)==null?void 0:d.bottom,o)||0,right:gr((c=t.margin)==null?void 0:c.right,o)||0};return t.outline&&(t.tagged=!0),{...e,...t,width:a,height:i,margin:r}}const Tu={px:1,in:96,cm:37.8,mm:3.78};function gr(t,o="in"){if(typeof t>"u")return;let e;if(UE(t))e=t;else if(rr(t)){const a=t;let i=a.substring(a.length-2).toLowerCase(),r="";i in Tu?r=a.substring(0,a.length-2):(i="px",r=a);const s=Number(r);$(!isNaN(s),"Failed to parse parameter value: "+a),e=s*Tu[i]}else throw new Error("page.pdf() Cannot handle parameter type: "+typeof t);return e/Tu[o]}function Re(t,o){return new Pe(e=>{const a=i=>{e.next(i)};return t.on(o,a),()=>{t.off(o,a)}})}function un(t,o){return t?ku(t,"abort").pipe(st(()=>{throw t.reason instanceof Error?(t.reason.cause=o,t.reason):new Error(t.reason,{cause:o})})):Af}function En(t){return $e(o=>ue(Promise.resolve(t(o))).pipe(tn(e=>e),st(()=>o)))}function GE(t){return{all:t=t||new Map,on:function(o,e){var a=t.get(o);a?a.push(e):t.set(o,[e])},off:function(o,e){var a=t.get(o);a&&(e?a.splice(a.indexOf(e)>>>0,1):t.set(o,[]))},emit:function(o,e){var a=t.get(o);a&&a.slice().map(function(i){i(e)}),(a=t.get("*"))&&a.slice().map(function(i){i(o,e)})}}}/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */Symbol.dispose??(Symbol.dispose=Symbol("dispose"));Symbol.asyncDispose??(Symbol.asyncDispose=Symbol("asyncDispose"));const ge=Symbol.dispose,kt=Symbol.asyncDispose;var ug,pg,Qo,fo;pg=ge,ug=Symbol.toStringTag;const om=class om{constructor(){f(this,Qo,!1);f(this,fo,[]);O(this,pg,this.dispose);O(this,ug,"DisposableStack")}get disposed(){return n(this,Qo)}dispose(){if(!n(this,Qo)){v(this,Qo,!0);for(const o of n(this,fo).reverse())o[ge]()}}use(o){return o&&n(this,fo).push(o),o}adopt(o,e){return n(this,fo).push({[ge](){e(o)}}),o}defer(o){n(this,fo).push({[ge](){o()}})}move(){if(n(this,Qo))throw new ReferenceError("a disposed stack can not use anything new");const o=new om;return v(o,fo,n(this,fo)),v(this,Qo,!0),o}};Qo=new WeakMap,fo=new WeakMap;let zo=om;var mg,gg,ea,ho;gg=kt,mg=Symbol.toStringTag;const am=class am{constructor(){f(this,ea,!1);f(this,ho,[]);O(this,gg,this.dispose);O(this,mg,"AsyncDisposableStack")}get disposed(){return n(this,ea)}async dispose(){if(!n(this,ea)){v(this,ea,!0);for(const o of n(this,ho).reverse())await o[kt]()}}use(o){return o&&n(this,ho).push(o),o}adopt(o,e){return n(this,ho).push({[kt](){return e(o)}}),o}defer(o){n(this,ho).push({[kt](){return o()}})}move(){if(n(this,ea))throw new ReferenceError("a disposed stack can not use anything new");const o=new am;return v(o,ho,n(this,ho)),v(this,ea,!0),o}};ea=new WeakMap,ho=new WeakMap;let Sd=am;/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var vo,qt;class Ie{constructor(o=GE(new Map)){f(this,vo);f(this,qt,new Map);v(this,vo,o)}on(o,e){const a=n(this,qt).get(o);return a===void 0?n(this,qt).set(o,[e]):a.push(e),n(this,vo).on(o,e),this}off(o,e){const a=n(this,qt).get(o)??[];if(e===void 0){for(const r of a)n(this,vo).off(o,r);return n(this,qt).delete(o),this}const i=a.lastIndexOf(e);return i>-1&&n(this,vo).off(o,...a.splice(i,1)),this}emit(o,e){return n(this,vo).emit(o,e),this.listenerCount(o)>0}once(o,e){const a=i=>{e(i),this.off(o,a)};return this.on(o,a)}listenerCount(o){var e;return((e=n(this,qt).get(o))==null?void 0:e.length)||0}removeAllListeners(o){return o!==void 0?this.off(o):(this[ge](),this)}[ge](){for(const[o,e]of n(this,qt))for(const a of e)n(this,vo).off(o,a);n(this,qt).clear()}}vo=new WeakMap,qt=new WeakMap;/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const KE=new Map([["geolocation","geolocation"],["midi","midi"],["notifications","notifications"],["camera","videoCapture"],["microphone","audioCapture"],["background-sync","backgroundSync"],["ambient-light-sensor","sensors"],["accelerometer","sensors"],["gyroscope","sensors"],["magnetometer","sensors"],["accessibility-events","accessibilityEvents"],["clipboard-read","clipboardReadWrite"],["clipboard-write","clipboardReadWrite"],["clipboard-sanitized-write","clipboardSanitizedWrite"],["payment-handler","paymentHandler"],["persistent-storage","durableStorage"],["idle-detection","idleDetection"],["midi-sysex","midiSysex"]]);class qE extends Ie{constructor(){super()}async waitForTarget(o,e={}){const{timeout:a=3e4}=e;return await nt(In(Re(this,"targetcreated"),Re(this,"targetchanged"),ue(this.targets())).pipe(En(o),to(oo(a))))}async pages(){return(await Promise.all(this.browserContexts().map(e=>e.pages()))).reduce((e,a)=>e.concat(a),[])}isConnected(){return this.connected}[ge](){return this.process()?void this.close().catch(X):void this.disconnect().catch(X)}[kt](){return this.process()?this.close():this.disconnect()}sessionId(){throw new Error("Not implemented")}}var ve;(function(t){t.Disconnected=Symbol("CDPSession.Disconnected"),t.Swapped=Symbol("CDPSession.Swapped"),t.Ready=Symbol("CDPSession.Ready"),t.SessionAttached="sessionattached",t.SessionDetached="sessiondetached"})(ve||(ve={}));class ad extends Ie{constructor(){super()}parentSession(){}}/**
 * @license
 * Copyright 2024 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var ta,oa,ei,Bn,Nd,Mr,kn,Fn,Fu,zr;const Pd=class Pd{constructor(o){f(this,Fn);f(this,ta,!1);f(this,oa,!1);f(this,ei);f(this,Bn);f(this,Nd,new Promise(o=>{v(this,Bn,o)}));f(this,Mr);f(this,kn);f(this,zr);o&&o.timeout>0&&(v(this,kn,new Qp(o.message)),v(this,Mr,setTimeout(()=>{this.reject(n(this,kn))},o.timeout)))}static create(o){return new Pd(o)}static async race(o){const e=new Set;try{const a=o.map(i=>i instanceof Pd?(n(i,Mr)&&e.add(i),i.valueOrThrow()):i);return await Promise.race(a)}finally{for(const a of e)a.reject(new Error("Timeout cleared"))}}resolve(o){n(this,oa)||n(this,ta)||(v(this,ta,!0),T(this,Fn,Fu).call(this,o))}reject(o){n(this,oa)||n(this,ta)||(v(this,oa,!0),T(this,Fn,Fu).call(this,o))}resolved(){return n(this,ta)}finished(){return n(this,ta)||n(this,oa)}value(){return n(this,ei)}valueOrThrow(){return n(this,zr)||v(this,zr,(async()=>{if(await n(this,Nd),n(this,oa))throw n(this,ei);return n(this,ei)})()),n(this,zr)}};ta=new WeakMap,oa=new WeakMap,ei=new WeakMap,Bn=new WeakMap,Nd=new WeakMap,Mr=new WeakMap,kn=new WeakMap,Fn=new WeakSet,Fu=function(o){clearTimeout(n(this,Mr)),v(this,ei,o),n(this,Bn).call(this)},zr=new WeakMap;let me=Pd;/**
 * @license
 * Copyright 2024 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var $n,Un,fg,Lr,jn;const Tn=class Tn{constructor(){f(this,Lr,!1);f(this,jn,[])}async acquire(o){if(!n(this,Lr))return v(this,Lr,!0),new Tn.Guard(this);const e=me.create();return n(this,jn).push(e.resolve.bind(e)),await e.valueOrThrow(),new Tn.Guard(this,o)}release(){const o=n(this,jn).shift();if(!o){v(this,Lr,!1);return}o()}};Lr=new WeakMap,jn=new WeakMap,O(Tn,"Guard",(fg=class{constructor(e,a){f(this,$n);f(this,Un);v(this,$n,e),v(this,Un,a)}[ge](){var e;return(e=n(this,Un))==null||e.call(this),n(this,$n).release()}},$n=new WeakMap,Un=new WeakMap,fg));let An=Tn;/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var ti,Nr;class YE extends Ie{constructor(){super();f(this,ti);f(this,Nr,0)}startScreenshot(){const e=n(this,ti)||new An;return v(this,ti,e),pr(this,Nr)._++,e.acquire(()=>{pr(this,Nr)._--,n(this,Nr)===0&&v(this,ti,void 0)})}waitForScreenshotOperations(){var e;return(e=n(this,ti))==null?void 0:e.acquire()}async waitForTarget(e,a={}){const{timeout:i=3e4}=a;return await nt(In(Re(this,"targetcreated"),Re(this,"targetchanged"),ue(this.targets())).pipe(En(e),to(oo(i))))}get closed(){return!this.browser().browserContexts().includes(this)}get id(){}[ge](){return void this.close().catch(X)}[kt](){return this.close()}}ti=new WeakMap,Nr=new WeakMap;/**
 * @license
 * Copyright 2024 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var ZE=function(t,o,e){if(o!=null){if(typeof o!="object"&&typeof o!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=o[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=o[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");t.stack.push({value:o,dispose:a,async:e})}else e&&t.stack.push({async:!0});return o},XE=(function(t){return function(o){function e(i){o.error=o.hasError?new t(i,o.error,"An error was suppressed during disposal."):i,o.hasError=!0}function a(){for(;o.stack.length;){var i=o.stack.pop();try{var r=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(r).then(a,function(s){return e(s),a()})}catch(s){e(s)}}if(o.hasError)throw o.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(t,o,e){var a=new Error(e);return a.name="SuppressedError",a.error=t,a.suppressed=o,a}),Pr,Eo,_t;class wu extends YE{constructor(e,a,i){super();f(this,Pr);f(this,Eo);f(this,_t);v(this,Pr,e),v(this,Eo,a),v(this,_t,i)}get id(){return n(this,_t)}targets(){return n(this,Eo).targets().filter(e=>e.browserContext()===this)}async pages(){return(await Promise.all(this.targets().filter(a=>{var i;return a.type()==="page"||a.type()==="other"&&((i=n(this,Eo)._getIsPageTargetCallback())==null?void 0:i(a))}).map(a=>a.page()))).filter(a=>!!a)}isIncognito(){return!!n(this,_t)}async overridePermissions(e,a){const i=a.map(r=>{const s=KE.get(r);if(!s)throw new Error("Unknown permission: "+r);return s});await n(this,Pr).send("Browser.grantPermissions",{origin:e,browserContextId:n(this,_t)||void 0,permissions:i})}async clearPermissionOverrides(){await n(this,Pr).send("Browser.resetPermissions",{browserContextId:n(this,_t)||void 0})}async newPage(){const e={stack:[],error:void 0,hasError:!1};try{const a=ZE(e,await this.waitForScreenshotOperations(),!1);return await n(this,Eo)._createPageInContext(n(this,_t))}catch(a){e.error=a,e.hasError=!0}finally{XE(e)}}browser(){return n(this,Eo)}async close(){$(n(this,_t),"Non-incognito profiles cannot be closed!"),await n(this,Eo)._disposeContext(n(this,_t))}}Pr=new WeakMap,Eo=new WeakMap,_t=new WeakMap;/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var bt;(function(t){t.PAGE="page",t.BACKGROUND_PAGE="background_page",t.SERVICE_WORKER="service_worker",t.SHARED_WORKER="shared_worker",t.BROWSER="browser",t.WEBVIEW="webview",t.OTHER="other",t.TAB="tab"})(bt||(bt={}));class JE{constructor(){}async worker(){return null}async page(){return null}}/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */function ro(t){return typeof t=="object"&&t!==null&&"name"in t&&"message"in t}function Lf(t,o,e){return t.message=o,t.originalMessage=e??t.originalMessage,t}function Nf(t){let o=t.error.message;return t.error&&typeof t.error=="object"&&"data"in t.error&&(o+=` ${t.error.data}`),o}/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Ot,Bd;class Pf{constructor(){f(this,Ot,new Map);f(this,Bd,eb())}create(o,e,a){const i=new QE(n(this,Bd).call(this),o,e);n(this,Ot).set(i.id,i);try{a(i.id)}catch(r){throw i.promise.catch(X).finally(()=>{n(this,Ot).delete(i.id)}),i.reject(r),r}return i.promise.finally(()=>{n(this,Ot).delete(i.id)})}reject(o,e,a){const i=n(this,Ot).get(o);i&&this._reject(i,e,a)}_reject(o,e,a){let i,r;e instanceof Sn?(i=e,i.cause=o.error,r=e.message):(i=o.error,r=e),o.reject(Lf(i,`Protocol error (${o.label}): ${r}`,a))}resolve(o,e){const a=n(this,Ot).get(o);a&&a.resolve(e)}clear(){for(const o of n(this,Ot).values())this._reject(o,new za("Target closed"));n(this,Ot).clear()}getPendingProtocolErrors(){const o=[];for(const e of n(this,Ot).values())o.push(new Error(`${e.label} timed out. Trace: ${e.error.stack}`));return o}}Ot=new WeakMap,Bd=new WeakMap;var Hn,Vn,oi,Br,Wn;class QE{constructor(o,e,a){f(this,Hn);f(this,Vn,new Sn);f(this,oi,me.create());f(this,Br);f(this,Wn);v(this,Hn,o),v(this,Wn,e),a&&v(this,Br,setTimeout(()=>{n(this,oi).reject(Lf(n(this,Vn),`${e} timed out. Increase the 'protocolTimeout' setting in launch/connect calls for a higher timeout if needed.`))},a))}resolve(o){clearTimeout(n(this,Br)),n(this,oi).resolve(o)}reject(o){clearTimeout(n(this,Br)),n(this,oi).reject(o)}get id(){return n(this,Hn)}get promise(){return n(this,oi).valueOrThrow()}get error(){return n(this,Vn)}get label(){return n(this,Wn)}}Hn=new WeakMap,Vn=new WeakMap,oi=new WeakMap,Br=new WeakMap,Wn=new WeakMap;function eb(){let t=0;return()=>++t}/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var ai,kr,aa,Dt,Fr,$r;class Ar extends ad{constructor(e,a,i,r){super();f(this,ai);f(this,kr);f(this,aa,new Pf);f(this,Dt);f(this,Fr);f(this,$r);v(this,Dt,e),v(this,kr,a),v(this,ai,i),v(this,Fr,r)}_setTarget(e){v(this,$r,e)}_target(){return $(n(this,$r),"Target must exist"),n(this,$r)}connection(){return n(this,Dt)}parentSession(){var a;return n(this,Fr)?((a=n(this,Dt))==null?void 0:a.session(n(this,Fr)))??void 0:this}send(e,a,i){return n(this,Dt)?n(this,Dt)._rawSend(n(this,aa),e,a,n(this,ai),i):Promise.reject(new za(`Protocol error (${e}): Session closed. Most likely the ${n(this,kr)} has been closed.`))}_onMessage(e){e.id?e.error?n(this,aa).reject(e.id,Nf(e),e.error.message):n(this,aa).resolve(e.id,e.result):($(!e.id),this.emit(e.method,e.params))}async detach(){if(!n(this,Dt))throw new Error(`Session already detached. Most likely the ${n(this,kr)} has been closed.`);await n(this,Dt).send("Target.detachFromTarget",{sessionId:n(this,ai)})}_onClosed(){n(this,aa).clear(),v(this,Dt,void 0),this.emit(ve.Disconnected,void 0)}id(){return n(this,ai)}getPendingProtocolErrors(){return n(this,aa).getPendingProtocolErrors()}}ai=new WeakMap,kr=new WeakMap,aa=new WeakMap,Dt=new WeakMap,Fr=new WeakMap,$r=new WeakMap;/**
 * @license
 * Copyright 2019 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const _m=3e4;var bo,ii;class em{constructor(){f(this,bo);f(this,ii);v(this,bo,null),v(this,ii,null)}setDefaultTimeout(o){v(this,bo,o)}setDefaultNavigationTimeout(o){v(this,ii,o)}navigationTimeout(){return n(this,ii)!==null?n(this,ii):n(this,bo)!==null?n(this,bo):_m}timeout(){return n(this,bo)!==null?n(this,bo):_m}}bo=new WeakMap,ii=new WeakMap;/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var tb=function(t,o,e){if(o!=null){if(typeof o!="object"&&typeof o!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=o[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=o[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");t.stack.push({value:o,dispose:a,async:e})}else e&&t.stack.push({async:!0});return o},ob=(function(t){return function(o){function e(i){o.error=o.hasError?new t(i,o.error,"An error was suppressed during disposal."):i,o.hasError=!0}function a(){for(;o.stack.length;){var i=o.stack.pop();try{var r=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(r).then(a,function(s){return e(s),a()})}catch(s){e(s)}}if(o.hasError)throw o.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(t,o,e){var a=new Error(e);return a.name="SuppressedError",a.error=t,a.suppressed=o,a});const sn=new WeakSet;function ab(t,o){let e=!1;if(t.prototype[ge]){const a=t.prototype[ge];t.prototype[ge]=function(){if(sn.has(this)){sn.delete(this);return}return a.call(this)},e=!0}if(t.prototype[kt]){const a=t.prototype[kt];t.prototype[kt]=function(){if(sn.has(this)){sn.delete(this);return}return a.call(this)},e=!0}return e&&(t.prototype.move=function(){return sn.add(this),this}),t}function oe(t=o=>`Attempted to use disposed ${o.constructor.name}.`){return(o,e)=>function(...a){if(this.disposed)throw new Error(t(this));return o.call(this,...a)}}function jt(t,o){const e=new WeakMap;let a=-1;return function(...i){if(a===-1&&(a=i.length),a!==i.length)throw new Error("Memoized method was called with the wrong number of arguments");let r=!1,s=e;for(const l of i)s.has(l)||(r=!0,s.set(l,new WeakMap)),s=s.get(l);if(r)return t.call(this,...i)}}function ib(t=function(){return this}){return(o,e)=>{const a=new WeakMap;return async function(...i){const r={stack:[],error:void 0,hasError:!1};try{const s=t.call(this);let l=a.get(s);l||(l=new An,a.set(s,l));const d=tb(r,await l.acquire(),!0);return await o.call(this,...i)}catch(s){r.error=s,r.hasError=!0}finally{const s=ob(r);s&&await s}}}}var rb=function(t,o,e){if(o!=null){if(typeof o!="object"&&typeof o!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=o[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=o[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");t.stack.push({value:o,dispose:a,async:e})}else e&&t.stack.push({async:!0});return o},sb=(function(t){return function(o){function e(i){o.error=o.hasError?new t(i,o.error,"An error was suppressed during disposal."):i,o.hasError=!0}function a(){for(;o.stack.length;){var i=o.stack.pop();try{var r=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(r).then(a,function(s){return e(s),a()})}catch(s){e(s)}}if(o.hasError)throw o.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(t,o,e){var a=new Error(e);return a.name="SuppressedError",a.error=t,a.suppressed=o,a}),yr;(function(t){t.Action="action"})(yr||(yr={}));var ri,si,ni,Gn,li,ci,so,Bf,kf,Ff,$f;class on extends Ie{constructor(){super(...arguments);f(this,so);O(this,"visibility",null);O(this,"_timeout",3e4);f(this,ri,!0);f(this,si,!0);f(this,ni,!0);O(this,"operators",{conditions:(e,a)=>$e(i=>In(...e.map(r=>r(i,a))).pipe(Cf(i))),retryAndRaceWithSignalAndTimer:(e,a)=>{const i=[];return e&&i.push(un(e,a)),i.push(oo(this._timeout,a)),Vv(od({delay:id}),to(...i))}});f(this,Gn,(e,a)=>n(this,si)?ue(e.frame.waitForFunction(i=>i instanceof HTMLElement?!["BUTTON","INPUT","SELECT","TEXTAREA","OPTION","OPTGROUP"].includes(i.nodeName)||!i.hasAttribute("disabled"):!0,{timeout:this._timeout,signal:a},e)).pipe(td()):Qi);f(this,li,e=>n(this,ni)?Sr(()=>ue(e.evaluate(a=>new Promise(i=>{window.requestAnimationFrame(()=>{const r=a.getBoundingClientRect();window.requestAnimationFrame(()=>{const s=a.getBoundingClientRect();i([{x:r.x,y:r.y,width:r.width,height:r.height},{x:s.x,y:s.y,width:s.width,height:s.height}])})})})))).pipe(wd(([a,i])=>a.x===i.x&&a.y===i.y&&a.width===i.width&&a.height===i.height),od({delay:id}),td()):Qi);f(this,ci,e=>n(this,ri)?ue(e.isIntersectingViewport({threshold:0})).pipe(tn(a=>!a),$e(()=>ue(e.scrollIntoView())),$e(()=>Sr(()=>ue(e.isIntersectingViewport({threshold:0}))).pipe(wd(Ba),od({delay:id}),td()))):Qi)}static race(e){return $u.create(e)}get timeout(){return this._timeout}setTimeout(e){const a=this._clone();return a._timeout=e,a}setVisibility(e){const a=this._clone();return a.visibility=e,a}setWaitForEnabled(e){const a=this._clone();return v(a,si,e),a}setEnsureElementIsInTheViewport(e){const a=this._clone();return v(a,ri,e),a}setWaitForStableBoundingBox(e){const a=this._clone();return v(a,ni,e),a}copyOptions(e){return this._timeout=e._timeout,this.visibility=e.visibility,v(this,si,n(e,si)),v(this,ri,n(e,ri)),v(this,ni,n(e,ni)),this}clone(){return this._clone()}async waitHandle(e){const a=new Error("Locator.waitHandle");return await nt(this._wait(e).pipe(this.operators.retryAndRaceWithSignalAndTimer(e==null?void 0:e.signal,a)))}async wait(e){const a={stack:[],error:void 0,hasError:!1};try{return await rb(a,await this.waitHandle(e),!1).jsonValue()}catch(i){a.error=i,a.hasError=!0}finally{sb(a)}}map(e){return new Cd(this._clone(),a=>a.evaluateHandle(e))}filter(e){return new xd(this._clone(),async(a,i)=>(await a.frame.waitForFunction(e,{signal:i,timeout:this._timeout},a),!0))}filterHandle(e){return new xd(this._clone(),e)}mapHandle(e){return new Cd(this._clone(),e)}click(e){return nt(T(this,so,Bf).call(this,e))}fill(e,a){return nt(T(this,so,kf).call(this,e,a))}hover(e){return nt(T(this,so,Ff).call(this,e))}scroll(e){return nt(T(this,so,$f).call(this,e))}}ri=new WeakMap,si=new WeakMap,ni=new WeakMap,Gn=new WeakMap,li=new WeakMap,ci=new WeakMap,so=new WeakSet,Bf=function(e){const a=e==null?void 0:e.signal,i=new Error("Locator.click");return this._wait(e).pipe(this.operators.conditions([n(this,ci),n(this,li),n(this,Gn)],a),Vc(()=>this.emit(yr.Action,void 0)),$e(r=>ue(r.click(e)).pipe(dn(s=>{throw r.dispose().catch(X),s}))),this.operators.retryAndRaceWithSignalAndTimer(a,i))},kf=function(e,a){const i=a==null?void 0:a.signal,r=new Error("Locator.fill");return this._wait(a).pipe(this.operators.conditions([n(this,ci),n(this,li),n(this,Gn)],i),Vc(()=>this.emit(yr.Action,void 0)),$e(s=>ue(s.evaluate(l=>l instanceof HTMLSelectElement?"select":l instanceof HTMLTextAreaElement?"typeable-input":l instanceof HTMLInputElement?new Set(["textarea","text","url","tel","search","password","number","email"]).has(l.type)?"typeable-input":"other-input":l.isContentEditable?"contenteditable":"unknown")).pipe($e(l=>{switch(l){case"select":return ue(s.select(e).then(Zs));case"contenteditable":case"typeable-input":return ue(s.evaluate((d,c)=>{const u=d.isContentEditable?d.innerText:d.value;if(c.length<=u.length||!c.startsWith(d.value))return d.isContentEditable?d.innerText="":d.value="",c;const p=d.isContentEditable?d.innerText:d.value;return d.isContentEditable?(d.innerText="",d.innerText=p):(d.value="",d.value=p),c.substring(p.length)},e)).pipe($e(d=>ue(s.type(d))));case"other-input":return ue(s.focus()).pipe($e(()=>ue(s.evaluate((d,c)=>{d.value=c,d.dispatchEvent(new Event("input",{bubbles:!0})),d.dispatchEvent(new Event("change",{bubbles:!0}))},e))));case"unknown":throw new Error("Element cannot be filled out.")}})).pipe(dn(l=>{throw s.dispose().catch(X),l}))),this.operators.retryAndRaceWithSignalAndTimer(i,r))},Ff=function(e){const a=e==null?void 0:e.signal,i=new Error("Locator.hover");return this._wait(e).pipe(this.operators.conditions([n(this,ci),n(this,li)],a),Vc(()=>this.emit(yr.Action,void 0)),$e(r=>ue(r.hover()).pipe(dn(s=>{throw r.dispose().catch(X),s}))),this.operators.retryAndRaceWithSignalAndTimer(a,i))},$f=function(e){const a=e==null?void 0:e.signal,i=new Error("Locator.scroll");return this._wait(e).pipe(this.operators.conditions([n(this,ci),n(this,li)],a),Vc(()=>this.emit(yr.Action,void 0)),$e(r=>ue(r.evaluate((s,l,d)=>{l!==void 0&&(s.scrollTop=l),d!==void 0&&(s.scrollLeft=d)},e==null?void 0:e.scrollTop,e==null?void 0:e.scrollLeft)).pipe(dn(s=>{throw r.dispose().catch(X),s}))),this.operators.retryAndRaceWithSignalAndTimer(a,i))};var Ur,jr;const kd=class kd extends on{constructor(e,a){super();f(this,Ur);f(this,jr);v(this,Ur,e),v(this,jr,a)}static create(e,a){return new kd(e,a).setTimeout("getDefaultTimeout"in e?e.getDefaultTimeout():e.page().getDefaultTimeout())}_clone(){return new kd(n(this,Ur),n(this,jr))}_wait(e){const a=e==null?void 0:e.signal;return Sr(()=>ue(n(this,Ur).waitForFunction(n(this,jr),{timeout:this.timeout,signal:a}))).pipe(nu())}};Ur=new WeakMap,jr=new WeakMap;let Ad=kd;var qe;class Uf extends on{constructor(e){super();f(this,qe);v(this,qe,e),this.copyOptions(n(this,qe))}get delegate(){return n(this,qe)}setTimeout(e){const a=super.setTimeout(e);return v(a,qe,n(this,qe).setTimeout(e)),a}setVisibility(e){const a=super.setVisibility(e);return v(a,qe,n(a,qe).setVisibility(e)),a}setWaitForEnabled(e){const a=super.setWaitForEnabled(e);return v(a,qe,n(this,qe).setWaitForEnabled(e)),a}setEnsureElementIsInTheViewport(e){const a=super.setEnsureElementIsInTheViewport(e);return v(a,qe,n(this,qe).setEnsureElementIsInTheViewport(e)),a}setWaitForStableBoundingBox(e){const a=super.setWaitForStableBoundingBox(e);return v(a,qe,n(this,qe).setWaitForStableBoundingBox(e)),a}}qe=new WeakMap;var Hr;const im=class im extends Uf{constructor(e,a){super(e);f(this,Hr);v(this,Hr,a)}_clone(){return new im(this.delegate.clone(),n(this,Hr)).copyOptions(this)}_wait(e){return this.delegate._wait(e).pipe($e(a=>ue(Promise.resolve(n(this,Hr).call(this,a,e==null?void 0:e.signal))).pipe(tn(i=>i),st(()=>a))),nu())}};Hr=new WeakMap;let xd=im;var Vr;const rm=class rm extends Uf{constructor(e,a){super(e);f(this,Vr);v(this,Vr,a)}_clone(){return new rm(this.delegate.clone(),n(this,Vr)).copyOptions(this)}_wait(e){return this.delegate._wait(e).pipe($e(a=>ue(Promise.resolve(n(this,Vr).call(this,a,e==null?void 0:e.signal)))))}};Vr=new WeakMap;let Cd=rm;var Wr,Gr,Fd;const $d=class $d extends on{constructor(e,a){super();f(this,Wr);f(this,Gr);f(this,Fd,e=>this.visibility?(()=>{switch(this.visibility){case"hidden":return Sr(()=>ue(e.isHidden()));case"visible":return Sr(()=>ue(e.isVisible()))}})().pipe(wd(Ba),od({delay:id}),td()):Qi);v(this,Wr,e),v(this,Gr,a)}static create(e,a){return new $d(e,a).setTimeout("getDefaultTimeout"in e?e.getDefaultTimeout():e.page().getDefaultTimeout())}_clone(){return new $d(n(this,Wr),n(this,Gr)).copyOptions(this)}_wait(e){const a=e==null?void 0:e.signal;return Sr(()=>ue(n(this,Wr).waitForSelector(n(this,Gr),{visible:!1,timeout:this._timeout,signal:a}))).pipe(tn(i=>i!==null),nu(),this.operators.conditions([n(this,Fd)],a))}};Wr=new WeakMap,Gr=new WeakMap,Fd=new WeakMap;let Rd=$d;function nb(t){for(const o of t)if(!(o instanceof on))throw new Error("Unknown locator for race candidate");return t}var Kr;const Ud=class Ud extends on{constructor(e){super();f(this,Kr);v(this,Kr,e)}static create(e){const a=nb(e);return new Ud(a)}_clone(){return new Ud(n(this,Kr).map(e=>e.clone())).copyOptions(this)}_wait(e){return OE(...n(this,Kr).map(a=>a._wait(e)))}};Kr=new WeakMap;let $u=Ud;const id=100;var lb=function(t,o,e){for(var a=arguments.length>2,i=0;i<o.length;i++)e=a?o[i].call(t,e):o[i].call(t);return a?e:void 0},cb=function(t,o,e,a,i,r){function s(w){if(w!==void 0&&typeof w!="function")throw new TypeError("Function expected");return w}for(var l=a.kind,d=l==="getter"?"get":l==="setter"?"set":"value",c=!o&&t?a.static?t:t.prototype:null,u=o||(c?Object.getOwnPropertyDescriptor(c,a.name):{}),p,g=!1,m=e.length-1;m>=0;m--){var b={};for(var h in a)b[h]=h==="access"?{}:a[h];for(var h in a.access)b.access[h]=a.access[h];b.addInitializer=function(w){if(g)throw new TypeError("Cannot add initializers after decoration has completed");r.push(s(w||null))};var E=(0,e[m])(l==="accessor"?{get:u.get,set:u.set}:u[d],b);if(l==="accessor"){if(E===void 0)continue;if(E===null||typeof E!="object")throw new TypeError("Object expected");(p=s(E.get))&&(u.get=p),(p=s(E.set))&&(u.set=p),(p=s(E.init))&&i.unshift(p)}else(p=s(E))&&(l==="field"?i.unshift(p):u[d]=p)}c&&Object.defineProperty(c,a.name,u),g=!0},Om=function(t,o,e){if(o!=null){if(typeof o!="object"&&typeof o!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=o[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=o[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");t.stack.push({value:o,dispose:a,async:e})}else e&&t.stack.push({async:!0});return o},db=(function(t){return function(o){function e(i){o.error=o.hasError?new t(i,o.error,"An error was suppressed during disposal."):i,o.hasError=!0}function a(){for(;o.stack.length;){var i=o.stack.pop();try{var r=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(r).then(a,function(s){return e(s),a()})}catch(s){e(s)}}if(o.hasError)throw o.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(t,o,e){var a=new Error(e);return a.name="SuppressedError",a.error=t,a.suppressed=o,a});function ub(t){t.optimizeForSpeed??(t.optimizeForSpeed=!1),t.type??(t.type="png"),t.fromSurface??(t.fromSurface=!0),t.fullPage??(t.fullPage=!1),t.omitBackground??(t.omitBackground=!1),t.encoding??(t.encoding="binary"),t.captureBeyondViewport??(t.captureBeyondViewport=!0)}let pb=(()=>{var a,i,r,s,l;let t=Ie,o=[],e;return l=class extends t{constructor(){super();O(this,"_isDragging",(lb(this,o),!1));O(this,"_timeoutSettings",new em);f(this,a,new WeakMap);f(this,i,new Zv(1));f(this,r,0);f(this,s);Re(this,"request").pipe($e(u=>Bu(Sm(1),In(Re(this,"requestfailed"),Re(this,"requestfinished"),Re(this,"response").pipe(st(p=>p.request()))).pipe(tn(p=>p.id===u.id),Rf(1),st(()=>-1)))),ME((u,p)=>Sm(u+p),0),NE(Re(this,"close")),zE(0)).subscribe(n(this,i))}on(u,p){if(u!=="request")return super.on(u,p);let g=n(this,a).get(p);return g===void 0&&(g=m=>{m.enqueueInterceptAction(()=>p(m))},n(this,a).set(p,g)),super.on(u,g)}off(u,p){return u==="request"&&(p=n(this,a).get(p)||p),super.off(u,p)}get accessibility(){return this.mainFrame().accessibility}locator(u){return typeof u=="string"?Rd.create(this,u):Ad.create(this,u)}locatorRace(u){return on.race(u)}async $(u){return await this.mainFrame().$(u)}async $$(u,p){return await this.mainFrame().$$(u,p)}async evaluateHandle(u,...p){return u=Ne(this.evaluateHandle.name,u),await this.mainFrame().evaluateHandle(u,...p)}async $eval(u,p,...g){return p=Ne(this.$eval.name,p),await this.mainFrame().$eval(u,p,...g)}async $$eval(u,p,...g){return p=Ne(this.$$eval.name,p),await this.mainFrame().$$eval(u,p,...g)}async addScriptTag(u){return await this.mainFrame().addScriptTag(u)}async addStyleTag(u){return await this.mainFrame().addStyleTag(u)}url(){return this.mainFrame().url()}async content(){return await this.mainFrame().content()}async setContent(u,p){await this.mainFrame().setContent(u,p)}async goto(u,p){return await this.mainFrame().goto(u,p)}async waitForNavigation(u={}){return await this.mainFrame().waitForNavigation(u)}waitForRequest(u,p={}){const{timeout:g=this._timeoutSettings.timeout(),signal:m}=p;if(typeof u=="string"){const h=u;u=E=>E.url()===h}const b=Re(this,"request").pipe(En(u),to(oo(g),un(m),Re(this,"close").pipe(st(()=>{throw new za("Page closed!")}))));return nt(b)}waitForResponse(u,p={}){const{timeout:g=this._timeoutSettings.timeout(),signal:m}=p;if(typeof u=="string"){const h=u;u=E=>E.url()===h}const b=Re(this,"response").pipe(En(u),to(oo(g),un(m),Re(this,"close").pipe(st(()=>{throw new za("Page closed!")}))));return nt(b)}waitForNetworkIdle(u={}){return nt(this.waitForNetworkIdle$(u))}waitForNetworkIdle$(u={}){const{timeout:p=this._timeoutSettings.timeout(),idleTime:g=VE,concurrency:m=0,signal:b}=u;return n(this,i).pipe(LE(h=>h>m?Qi:Yp(g)),st(()=>{}),to(oo(p),un(b),Re(this,"close").pipe(st(()=>{throw new za("Page closed!")}))))}async waitForFrame(u,p={}){const{timeout:g=this.getDefaultTimeout(),signal:m}=p;return rr(u)&&(u=b=>u===b.url()),await nt(In(Re(this,"frameattached"),Re(this,"framenavigated"),ue(this.frames())).pipe(En(u),wd(),to(oo(g),un(m),Re(this,"close").pipe(st(()=>{throw new za("Page closed.")})))))}async emulate(u){await Promise.all([this.setUserAgent(u.userAgent),this.setViewport(u.viewport)])}async evaluate(u,...p){return u=Ne(this.evaluate.name,u),await this.mainFrame().evaluate(u,...p)}async _maybeWriteBufferToFile(u,p){if(u)throw new Error("Cannot write to a path outside of a Node-like environment.")}async _startScreencast(){++pr(this,r)._,n(this,s)||v(this,s,this.mainFrame().client.send("Page.startScreencast",{format:"png"}).then(()=>new Promise(u=>this.mainFrame().client.once("Page.screencastFrame",()=>u())))),await n(this,s)}async _stopScreencast(){--pr(this,r)._,n(this,s)&&(v(this,s,void 0),n(this,r)===0&&await this.mainFrame().client.send("Page.stopScreencast"))}async screenshot(u={}){const p={stack:[],error:void 0,hasError:!1};try{const g=Om(p,await this.browserContext().startScreenshot(),!1);await this.bringToFront();const m={...u,clip:u.clip?{...u.clip}:void 0};if(m.type===void 0&&m.path!==void 0){const w=m.path;switch(w.slice(w.lastIndexOf(".")+1).toLowerCase()){case"png":m.type="png";break;case"jpeg":case"jpg":m.type="jpeg";break;case"webp":m.type="webp";break}}if(m.quality!==void 0){if(m.quality<0||m.quality>100)throw new Error(`Expected 'quality' (${m.quality}) to be between 0 and 100, inclusive.`);if(m.type===void 0||!["jpeg","webp"].includes(m.type))throw new Error(`${m.type??"png"} screenshots do not support 'quality'.`)}if(m.clip){if(m.clip.width<=0)throw new Error("'width' in 'clip' must be positive.");if(m.clip.height<=0)throw new Error("'height' in 'clip' must be positive.")}ub(m);const b=Om(p,new Sd,!0);if(m.clip){if(m.fullPage)throw new Error("'clip' and 'fullPage' are mutually exclusive");m.clip=gb(mb(m.clip))}else if(m.fullPage){if(!m.captureBeyondViewport){const w=await this.mainFrame().isolatedRealm().evaluate(()=>{const C=document.documentElement;return{width:C.scrollWidth,height:C.scrollHeight}}),S=this.viewport();await this.setViewport({...S,...w}),b.defer(async()=>{await this.setViewport(S).catch(X)})}}else m.captureBeyondViewport=!1;const h=await this._screenshot(m);if(m.encoding==="base64")return h;const E=Buffer.from(h,"base64");return await this._maybeWriteBufferToFile(m.path,E),E}catch(g){p.error=g,p.hasError=!0}finally{const g=db(p);g&&await g}}async title(){return await this.mainFrame().title()}click(u,p){return this.mainFrame().click(u,p)}focus(u){return this.mainFrame().focus(u)}hover(u){return this.mainFrame().hover(u)}select(u,...p){return this.mainFrame().select(u,...p)}tap(u){return this.mainFrame().tap(u)}type(u,p,g){return this.mainFrame().type(u,p,g)}async waitForSelector(u,p={}){return await this.mainFrame().waitForSelector(u,p)}waitForFunction(u,p,...g){return this.mainFrame().waitForFunction(u,p,...g)}[(e=[ib(function(){return this.browser()})],ge)](){return void this.close().catch(X)}[kt](){return this.close()}},a=new WeakMap,i=new WeakMap,r=new WeakMap,s=new WeakMap,(()=>{const u=typeof Symbol=="function"&&Symbol.metadata?Object.create(t[Symbol.metadata]??null):void 0;cb(l,null,e,{kind:"method",name:"screenshot",static:!1,private:!1,access:{has:p=>"screenshot"in p,get:p=>p.screenshot},metadata:u},null,o),u&&Object.defineProperty(l,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:u})})(),l})();function mb(t){return{...t,...t.width<0?{x:t.x+t.width,width:-t.width}:{x:t.x,width:t.width},...t.height<0?{y:t.y+t.height,height:-t.height}:{y:t.y,height:t.height}}}function gb(t){const o=Math.round(t.x),e=Math.round(t.y),a=Math.round(t.width+t.x-o),i=Math.round(t.height+t.y-e);return{...t,x:o,y:e,width:a,height:i}}/**
 * @license
 * Copyright 2020 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Kn,qn,Yn,qr;class Dm{constructor(o,e,a,i){f(this,Kn);f(this,qn);f(this,Yn);f(this,qr);v(this,Kn,o),v(this,qn,e),v(this,Yn,a),v(this,qr,i)}type(){return n(this,Kn)}text(){return n(this,qn)}args(){return n(this,Yn)}location(){return n(this,qr)[0]??{}}stackTrace(){return n(this,qr)}}Kn=new WeakMap,qn=new WeakMap,Yn=new WeakMap,qr=new WeakMap;/**
 * @license
 * Copyright 2020 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Yr,Zn,di;class fb{constructor(o,e){f(this,Yr);f(this,Zn);f(this,di,!1);v(this,Yr,o),v(this,Zn,e.mode!=="selectSingle")}isMultiple(){return n(this,Zn)}async accept(o){$(!n(this,di),"Cannot accept FileChooser which is already handled!"),v(this,di,!0),await n(this,Yr).uploadFile(...o)}async cancel(){$(!n(this,di),"Cannot cancel FileChooser which is already handled!"),v(this,di,!0),await n(this,Yr).evaluate(o=>{o.dispatchEvent(new Event("cancel",{bubbles:!0}))})}}Yr=new WeakMap,Zn=new WeakMap,di=new WeakMap;/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var ze;(function(t){t.Request=Symbol("NetworkManager.Request"),t.RequestServedFromCache=Symbol("NetworkManager.RequestServedFromCache"),t.Response=Symbol("NetworkManager.Response"),t.RequestFailed=Symbol("NetworkManager.RequestFailed"),t.RequestFinished=Symbol("NetworkManager.RequestFinished")})(ze||(ze={}));/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Mm=function(t,o,e){for(var a=arguments.length>2,i=0;i<o.length;i++)e=a?o[i].call(t,e):o[i].call(t);return a?e:void 0},Iu=function(t,o,e,a,i,r){function s(w){if(w!==void 0&&typeof w!="function")throw new TypeError("Function expected");return w}for(var l=a.kind,d=l==="getter"?"get":l==="setter"?"set":"value",c=!o&&t?a.static?t:t.prototype:null,u=o||(c?Object.getOwnPropertyDescriptor(c,a.name):{}),p,g=!1,m=e.length-1;m>=0;m--){var b={};for(var h in a)b[h]=h==="access"?{}:a[h];for(var h in a.access)b.access[h]=a.access[h];b.addInitializer=function(w){if(g)throw new TypeError("Cannot add initializers after decoration has completed");r.push(s(w||null))};var E=(0,e[m])(l==="accessor"?{get:u.get,set:u.set}:u[d],b);if(l==="accessor"){if(E===void 0)continue;if(E===null||typeof E!="object")throw new TypeError("Object expected");(p=s(E.get))&&(u.get=p),(p=s(E.set))&&(u.set=p),(p=s(E.init))&&i.unshift(p)}else(p=s(E))&&(l==="field"?i.unshift(p):u[d]=p)}c&&Object.defineProperty(c,a.name,u),g=!0},hb=function(t,o,e){if(o!=null){if(typeof o!="object"&&typeof o!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=o[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=o[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");t.stack.push({value:o,dispose:a,async:e})}else e&&t.stack.push({async:!0});return o},vb=(function(t){return function(o){function e(i){o.error=o.hasError?new t(i,o.error,"An error was suppressed during disposal."):i,o.hasError=!0}function a(){for(;o.stack.length;){var i=o.stack.pop();try{var r=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(r).then(a,function(s){return e(s),a()})}catch(s){e(s)}}if(o.hasError)throw o.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(t,o,e){var a=new Error(e);return a.name="SuppressedError",a.error=t,a.suppressed=o,a});let Tr=(()=>{var l;let t=[ab],o,e=[],a,i=[],r,s;return l=class{constructor(){Mm(this,i)}async evaluate(c,...u){return c=Ne(this.evaluate.name,c),await this.realm.evaluate(c,this,...u)}async evaluateHandle(c,...u){return c=Ne(this.evaluateHandle.name,c),await this.realm.evaluateHandle(c,this,...u)}async getProperty(c){return await this.evaluateHandle((u,p)=>u[p],c)}async getProperties(){const c=await this.evaluate(g=>{var h;const m=[],b=Object.getOwnPropertyDescriptors(g);for(const E in b)(h=b[E])!=null&&h.enumerable&&m.push(E);return m}),u=new Map,p=await Promise.all(c.map(g=>this.getProperty(g)));for(const[g,m]of Object.entries(c)){const b={stack:[],error:void 0,hasError:!1};try{const h=hb(b,p[g],!1);h&&u.set(m,h.move())}catch(h){b.error=h,b.hasError=!0}finally{vb(b)}}return u}[(r=[oe()],s=[oe()],ge)](){return void this.dispose().catch(X)}[kt](){return this.dispose()}},a=l,(()=>{const c=typeof Symbol=="function"&&Symbol.metadata?Object.create(null):void 0;Iu(l,null,r,{kind:"method",name:"getProperty",static:!1,private:!1,access:{has:u=>"getProperty"in u,get:u=>u.getProperty},metadata:c},null,i),Iu(l,null,s,{kind:"method",name:"getProperties",static:!1,private:!1,access:{has:u=>"getProperties"in u,get:u=>u.getProperties},metadata:c},null,i),Iu(null,o={value:a},t,{kind:"class",name:a.name,metadata:c},null,e),a=o.value,c&&Object.defineProperty(a,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:c}),Mm(a,e)})(),a})();var Eb=function(t,o,e){if(o!=null){if(typeof o!="object"&&typeof o!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=o[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=o[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");t.stack.push({value:o,dispose:a,async:e})}else e&&t.stack.push({async:!0});return o},bb=(function(t){return function(o){function e(i){o.error=o.hasError?new t(i,o.error,"An error was suppressed during disposal."):i,o.hasError=!0}function a(){for(;o.stack.length;){var i=o.stack.pop();try{var r=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(r).then(a,function(s){return e(s),a()})}catch(s){e(s)}}if(o.hasError)throw o.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(t,o,e){var a=new Error(e);return a.name="SuppressedError",a.error=t,a.suppressed=o,a}),yo,Xn,Jn;class _d{constructor(o,e,a){f(this,yo);f(this,Xn);f(this,Jn);v(this,yo,o),v(this,Xn,e),v(this,Jn,a)}get name(){return n(this,yo)}get initSource(){return n(this,Jn)}async run(o,e,a,i){const r=new zo;try{if(!i){const s={stack:[],error:void 0,hasError:!1};try{const d=await Eb(s,await o.evaluateHandle((c,u)=>globalThis[c].args.get(u),n(this,yo),e),!1).getProperties();for(const[c,u]of d)if(c in a)switch(u.remoteObject().subtype){case"node":a[+c]=u;break;default:r.use(u)}else r.use(u)}catch(l){s.error=l,s.hasError=!0}finally{bb(s)}}await o.evaluate((s,l,d)=>{const c=globalThis[s].callbacks;c.get(l).resolve(d),c.delete(l)},n(this,yo),e,await n(this,Xn).call(this,...a));for(const s of a)s instanceof Tr&&r.use(s)}catch(s){ro(s)?await o.evaluate((l,d,c,u)=>{const p=new Error(c);p.stack=u;const g=globalThis[l].callbacks;g.get(d).reject(p),g.delete(d)},n(this,yo),e,s.message,s.stack).catch(X):await o.evaluate((l,d,c)=>{const u=globalThis[l].callbacks;u.get(d).reject(c),u.delete(d)},n(this,yo),e,s).catch(X)}}}yo=new WeakMap,Xn=new WeakMap,Jn=new WeakMap;/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const yb=Xp("puppeteer:protocol:SEND ‚ñ∫"),Tb=Xp("puppeteer:protocol:RECV ‚óÄ");var Qn,Yt,ui,Zr,et,pi,Xr,ia,el,Uu;class jf extends Ie{constructor(e,a,i=0,r){super();f(this,el);f(this,Qn);f(this,Yt);f(this,ui);f(this,Zr);f(this,et,new Map);f(this,pi,!1);f(this,Xr,new Set);f(this,ia,new Pf);v(this,Qn,e),v(this,ui,i),v(this,Zr,r??18e4),v(this,Yt,a),n(this,Yt).onmessage=this.onMessage.bind(this),n(this,Yt).onclose=T(this,el,Uu).bind(this)}static fromSession(e){return e.connection()}get delay(){return n(this,ui)}get timeout(){return n(this,Zr)}get _closed(){return n(this,pi)}get _sessions(){return n(this,et)}session(e){return n(this,et).get(e)||null}url(){return n(this,Qn)}send(e,a,i){return this._rawSend(n(this,ia),e,a,void 0,i)}_rawSend(e,a,i,r,s){return n(this,pi)?Promise.reject(new Error("Protocol error: Connection closed.")):e.create(a,(s==null?void 0:s.timeout)??n(this,Zr),l=>{const d=JSON.stringify({method:a,params:i,id:l,sessionId:r});yb(d),n(this,Yt).send(d)})}async closeBrowser(){await this.send("Browser.close")}async onMessage(e){n(this,ui)&&await new Promise(i=>setTimeout(i,n(this,ui))),Tb(e);const a=JSON.parse(e);if(a.method==="Target.attachedToTarget"){const i=a.params.sessionId,r=new Ar(this,a.params.targetInfo.type,i,a.sessionId);n(this,et).set(i,r),this.emit(ve.SessionAttached,r);const s=n(this,et).get(a.sessionId);s&&s.emit(ve.SessionAttached,r)}else if(a.method==="Target.detachedFromTarget"){const i=n(this,et).get(a.params.sessionId);if(i){i._onClosed(),n(this,et).delete(a.params.sessionId),this.emit(ve.SessionDetached,i);const r=n(this,et).get(a.sessionId);r&&r.emit(ve.SessionDetached,i)}}if(a.sessionId){const i=n(this,et).get(a.sessionId);i&&i._onMessage(a)}else a.id?a.error?n(this,ia).reject(a.id,Nf(a),a.error.message):n(this,ia).resolve(a.id,a.result):this.emit(a.method,a.params)}dispose(){T(this,el,Uu).call(this),n(this,Yt).close()}isAutoAttached(e){return!n(this,Xr).has(e)}async _createSession(e,a=!0){a||n(this,Xr).add(e.targetId);const{sessionId:i}=await this.send("Target.attachToTarget",{targetId:e.targetId,flatten:!0});n(this,Xr).delete(e.targetId);const r=n(this,et).get(i);if(!r)throw new Error("CDPSession creation failed.");return r}async createSession(e){return await this._createSession(e,!1)}getPendingProtocolErrors(){const e=[];e.push(...n(this,ia).getPendingProtocolErrors());for(const a of n(this,et).values())e.push(...a.getPendingProtocolErrors());return e}}Qn=new WeakMap,Yt=new WeakMap,ui=new WeakMap,Zr=new WeakMap,et=new WeakMap,pi=new WeakMap,Xr=new WeakMap,ia=new WeakMap,el=new WeakSet,Uu=function(){if(!n(this,pi)){v(this,pi,!0),n(this,Yt).onmessage=void 0,n(this,Yt).onclose=void 0,n(this,ia).clear();for(const e of n(this,et).values())e._onClosed();n(this,et).clear(),this.emit(ve.Disconnected,void 0)}};function ju(t){return t instanceof za}/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var mi,gi;class wb{constructor(o){f(this,mi);f(this,gi);v(this,mi,new Ib(o)),v(this,gi,new Sb(o))}updateClient(o){n(this,mi).updateClient(o),n(this,gi).updateClient(o)}async startJSCoverage(o={}){return await n(this,mi).start(o)}async stopJSCoverage(){return await n(this,mi).stop()}async startCSSCoverage(o={}){return await n(this,gi).start(o)}async stopCSSCoverage(){return await n(this,gi).stop()}}mi=new WeakMap,gi=new WeakMap;var tt,fi,hi,vi,Jr,tl,Qr,es,Qs,Hf,Vf;class Ib{constructor(o){f(this,Qs);f(this,tt);f(this,fi,!1);f(this,hi,new Map);f(this,vi,new Map);f(this,Jr);f(this,tl,!1);f(this,Qr,!1);f(this,es,!1);v(this,tt,o)}updateClient(o){v(this,tt,o)}async start(o={}){$(!n(this,fi),"JSCoverage is already enabled");const{resetOnNavigation:e=!0,reportAnonymousScripts:a=!1,includeRawScriptCoverage:i=!1,useBlockCoverage:r=!0}=o;v(this,tl,e),v(this,Qr,a),v(this,es,i),v(this,fi,!0),n(this,hi).clear(),n(this,vi).clear(),v(this,Jr,new zo);const s=n(this,Jr).use(new Ie(n(this,tt)));s.on("Debugger.scriptParsed",T(this,Qs,Vf).bind(this)),s.on("Runtime.executionContextsCleared",T(this,Qs,Hf).bind(this)),await Promise.all([n(this,tt).send("Profiler.enable"),n(this,tt).send("Profiler.startPreciseCoverage",{callCount:n(this,es),detailed:r}),n(this,tt).send("Debugger.enable"),n(this,tt).send("Debugger.setSkipAllPauses",{skip:!0})])}async stop(){var i;$(n(this,fi),"JSCoverage is not enabled"),v(this,fi,!1);const o=await Promise.all([n(this,tt).send("Profiler.takePreciseCoverage"),n(this,tt).send("Profiler.stopPreciseCoverage"),n(this,tt).send("Profiler.disable"),n(this,tt).send("Debugger.disable")]);(i=n(this,Jr))==null||i.dispose();const e=[],a=o[0];for(const r of a.result){let s=n(this,hi).get(r.scriptId);!s&&n(this,Qr)&&(s="debugger://VM"+r.scriptId);const l=n(this,vi).get(r.scriptId);if(l===void 0||s===void 0)continue;const d=[];for(const u of r.functions)d.push(...u.ranges);const c=Kf(d);n(this,es)?e.push({url:s,ranges:c,text:l,rawScriptCoverage:r}):e.push({url:s,ranges:c,text:l})}return e}}tt=new WeakMap,fi=new WeakMap,hi=new WeakMap,vi=new WeakMap,Jr=new WeakMap,tl=new WeakMap,Qr=new WeakMap,es=new WeakMap,Qs=new WeakSet,Hf=function(){n(this,tl)&&(n(this,hi).clear(),n(this,vi).clear())},Vf=async function(o){if(!Mo.isPuppeteerURL(o.url)&&!(!o.url&&!n(this,Qr)))try{const e=await n(this,tt).send("Debugger.getScriptSource",{scriptId:o.scriptId});n(this,hi).set(o.scriptId,o.url),n(this,vi).set(o.scriptId,e.scriptSource)}catch(e){X(e)}};var gt,Ei,ra,bi,ts,ol,en,Wf,Gf;class Sb{constructor(o){f(this,en);f(this,gt);f(this,Ei,!1);f(this,ra,new Map);f(this,bi,new Map);f(this,ts);f(this,ol,!1);v(this,gt,o)}updateClient(o){v(this,gt,o)}async start(o={}){$(!n(this,Ei),"CSSCoverage is already enabled");const{resetOnNavigation:e=!0}=o;v(this,ol,e),v(this,Ei,!0),n(this,ra).clear(),n(this,bi).clear(),v(this,ts,new zo);const a=n(this,ts).use(new Ie(n(this,gt)));a.on("CSS.styleSheetAdded",T(this,en,Gf).bind(this)),a.on("Runtime.executionContextsCleared",T(this,en,Wf).bind(this)),await Promise.all([n(this,gt).send("DOM.enable"),n(this,gt).send("CSS.enable"),n(this,gt).send("CSS.startRuleUsageTracking")])}async stop(){var i;$(n(this,Ei),"CSSCoverage is not enabled"),v(this,Ei,!1);const o=await n(this,gt).send("CSS.stopRuleUsageTracking");await Promise.all([n(this,gt).send("CSS.disable"),n(this,gt).send("DOM.disable")]),(i=n(this,ts))==null||i.dispose();const e=new Map;for(const r of o.ruleUsage){let s=e.get(r.styleSheetId);s||(s=[],e.set(r.styleSheetId,s)),s.push({startOffset:r.startOffset,endOffset:r.endOffset,count:r.used?1:0})}const a=[];for(const r of n(this,ra).keys()){const s=n(this,ra).get(r);$(typeof s<"u",`Stylesheet URL is undefined (styleSheetId=${r})`);const l=n(this,bi).get(r);$(typeof l<"u",`Stylesheet text is undefined (styleSheetId=${r})`);const d=Kf(e.get(r)||[]);a.push({url:s,ranges:d,text:l})}return a}}gt=new WeakMap,Ei=new WeakMap,ra=new WeakMap,bi=new WeakMap,ts=new WeakMap,ol=new WeakMap,en=new WeakSet,Wf=function(){n(this,ol)&&(n(this,ra).clear(),n(this,bi).clear())},Gf=async function(o){const e=o.header;if(e.sourceURL)try{const a=await n(this,gt).send("CSS.getStyleSheetText",{styleSheetId:e.styleSheetId});n(this,ra).set(e.styleSheetId,e.sourceURL),n(this,bi).set(e.styleSheetId,a.text)}catch(a){X(a)}};function Kf(t){const o=[];for(const r of t)o.push({offset:r.startOffset,type:0,range:r}),o.push({offset:r.endOffset,type:1,range:r});o.sort((r,s)=>{if(r.offset!==s.offset)return r.offset-s.offset;if(r.type!==s.type)return s.type-r.type;const l=r.range.endOffset-r.range.startOffset,d=s.range.endOffset-s.range.startOffset;return r.type===0?d-l:l-d});const e=[],a=[];let i=0;for(const r of o){if(e.length&&i<r.offset&&e[e.length-1]>0){const s=a[a.length-1];s&&s.end===i?s.end=r.offset:a.push({start:i,end:r.offset})}i=r.offset,r.type===0?e.push(r.range.count):e.pop()}return a.filter(r=>r.end-r.start>0)}/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var al,il,rl;class Ab{constructor(o,e,a=""){f(this,al);f(this,il);f(this,rl);O(this,"handled",!1);v(this,al,o),v(this,il,e),v(this,rl,a)}type(){return n(this,al)}message(){return n(this,il)}defaultValue(){return n(this,rl)}async accept(o){$(!this.handled,"Cannot accept dialog which is already handled!"),this.handled=!0,await this.handle({accept:!0,text:o})}async dismiss(){$(!this.handled,"Cannot dismiss dialog which is already handled!"),this.handled=!0,await this.handle({accept:!1})}}al=new WeakMap,il=new WeakMap,rl=new WeakMap;/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var sl;class xb extends Ab{constructor(e,a,i,r=""){super(a,i,r);f(this,sl);v(this,sl,e)}async handle(e){await n(this,sl).send("Page.handleJavaScriptDialog",{accept:e.accept,promptText:e.text})}}sl=new WeakMap;var Cb=function(t,o,e){for(var a=arguments.length>2,i=0;i<o.length;i++)e=a?o[i].call(t,e):o[i].call(t);return a?e:void 0},Ht=function(t,o,e,a,i,r){function s(w){if(w!==void 0&&typeof w!="function")throw new TypeError("Function expected");return w}for(var l=a.kind,d=l==="getter"?"get":l==="setter"?"set":"value",c=!o&&t?a.static?t:t.prototype:null,u=o||(c?Object.getOwnPropertyDescriptor(c,a.name):{}),p,g=!1,m=e.length-1;m>=0;m--){var b={};for(var h in a)b[h]=h==="access"?{}:a[h];for(var h in a.access)b.access[h]=a.access[h];b.addInitializer=function(w){if(g)throw new TypeError("Cannot add initializers after decoration has completed");r.push(s(w||null))};var E=(0,e[m])(l==="accessor"?{get:u.get,set:u.set}:u[d],b);if(l==="accessor"){if(E===void 0)continue;if(E===null||typeof E!="object")throw new TypeError("Object expected");(p=s(E.get))&&(u.get=p),(p=s(E.set))&&(u.set=p),(p=s(E.init))&&i.unshift(p)}else(p=s(E))&&(l==="field"?i.unshift(p):u[d]=p)}c&&Object.defineProperty(c,a.name,u),g=!0},Vt=function(t,o,e){return typeof o=="symbol"&&(o=o.description?"[".concat(o.description,"]"):""),Object.defineProperty(t,"name",{configurable:!0,value:e?"".concat(e," ",o):o})},yi,os,nl;class Wt{constructor(o,e,a){f(this,yi);f(this,os);f(this,nl);v(this,yi,o),v(this,os,e),v(this,nl,a),n(this,os).registerState(this)}async setState(o){v(this,yi,o),await this.sync()}get state(){return n(this,yi)}async sync(){await Promise.all(n(this,os).clients().map(o=>n(this,nl).call(this,o,n(this,yi))))}}yi=new WeakMap,os=new WeakMap,nl=new WeakMap;let Rb=(()=>{var z,D,F,L,M,j,N,A,x,P,B,J,ae,ie,Z,H,Hu,Vu,Wu,Gu,Ku,qu,Yu,Zu,Xu,Ju,Q;let t=[],o,e,a,i,r,s,l,d,c,u,p,g,m,b,h,E,w,S,C,R;return Q=class{constructor(W){f(this,H);f(this,z,Cb(this,t));f(this,D,!1);f(this,F,!1);f(this,L,[]);f(this,M,new Wt({active:!1},this,n(this,H,Hu)));f(this,j,new Wt({active:!1},this,n(this,H,Vu)));f(this,N,new Wt({active:!1},this,n(this,H,Wu)));f(this,A,new Wt({active:!1},this,n(this,H,Gu)));f(this,x,new Wt({active:!1},this,n(this,H,Ku)));f(this,P,new Wt({active:!1},this,n(this,H,qu)));f(this,B,new Wt({active:!1},this,n(this,H,Yu)));f(this,J,new Wt({active:!1},this,n(this,H,Zu)));f(this,ae,new Wt({active:!1},this,n(this,H,Xu)));f(this,ie,new Wt({javaScriptEnabled:!0,active:!1},this,n(this,H,Ju)));f(this,Z,new Set);v(this,z,W)}updateClient(W){v(this,z,W),n(this,Z).delete(W)}registerState(W){n(this,L).push(W)}clients(){return[n(this,z),...Array.from(n(this,Z))]}async registerSpeculativeSession(W){n(this,Z).add(W),W.once(ve.Disconnected,()=>{n(this,Z).delete(W)}),Promise.all(n(this,L).map(k=>k.sync().catch(X)))}get javascriptEnabled(){return n(this,ie).state.javaScriptEnabled}async emulateViewport(W){const k=n(this,M).state;if(!W&&!k.active)return!1;await n(this,M).setState(W?{viewport:W,active:!0}:{active:!1});const Y=(W==null?void 0:W.isMobile)||!1,ye=(W==null?void 0:W.hasTouch)||!1,$t=n(this,D)!==Y||n(this,F)!==ye;return v(this,D,Y),v(this,F,ye),$t}async emulateIdleState(W){await n(this,j).setState({active:!0,overrides:W})}async emulateTimezone(W){await n(this,N).setState({timezoneId:W,active:!0})}async emulateVisionDeficiency(W){$(!W||new Set(["none","achromatopsia","blurredVision","deuteranopia","protanopia","tritanopia"]).has(W),`Unsupported vision deficiency: ${W}`),await n(this,A).setState({active:!0,visionDeficiency:W})}async emulateCPUThrottling(W){$(W===null||W>=1,"Throttling rate should be greater or equal to 1"),await n(this,x).setState({active:!0,factor:W??void 0})}async emulateMediaFeatures(W){if(Array.isArray(W))for(const k of W){const Y=k.name;$(/^(?:prefers-(?:color-scheme|reduced-motion)|color-gamut)$/.test(Y),"Unsupported media feature: "+Y)}await n(this,P).setState({active:!0,mediaFeatures:W})}async emulateMediaType(W){$(W==="screen"||W==="print"||(W??void 0)===void 0,"Unsupported media type: "+W),await n(this,B).setState({type:W,active:!0})}async setGeolocation(W){const{longitude:k,latitude:Y,accuracy:ye=0}=W;if(k<-180||k>180)throw new Error(`Invalid longitude "${k}": precondition -180 <= LONGITUDE <= 180 failed.`);if(Y<-90||Y>90)throw new Error(`Invalid latitude "${Y}": precondition -90 <= LATITUDE <= 90 failed.`);if(ye<0)throw new Error(`Invalid accuracy "${ye}": precondition 0 <= ACCURACY failed.`);await n(this,J).setState({active:!0,geoLocation:{longitude:k,latitude:Y,accuracy:ye}})}async resetDefaultBackgroundColor(){await n(this,ae).setState({active:!0,color:void 0})}async setTransparentBackgroundColor(){await n(this,ae).setState({active:!0,color:{r:0,g:0,b:0,a:0}})}async setJavaScriptEnabled(W){await n(this,ie).setState({active:!0,javaScriptEnabled:W})}},z=new WeakMap,D=new WeakMap,F=new WeakMap,L=new WeakMap,M=new WeakMap,j=new WeakMap,N=new WeakMap,A=new WeakMap,x=new WeakMap,P=new WeakMap,B=new WeakMap,J=new WeakMap,ae=new WeakMap,ie=new WeakMap,Z=new WeakMap,H=new WeakSet,Hu=function(){return e.value},Vu=function(){return i.value},Wu=function(){return s.value},Gu=function(){return d.value},Ku=function(){return u.value},qu=function(){return g.value},Yu=function(){return b.value},Zu=function(){return E.value},Xu=function(){return S.value},Ju=function(){return R.value},(()=>{const W=typeof Symbol=="function"&&Symbol.metadata?Object.create(null):void 0;o=[jt],a=[jt],r=[jt],l=[jt],c=[jt],p=[jt],m=[jt],h=[jt],w=[jt],C=[jt],Ht(Q,e={value:Vt(async function(k,Y){if(!Y.viewport){await Promise.all([k.send("Emulation.clearDeviceMetricsOverride"),k.send("Emulation.setTouchEmulationEnabled",{enabled:!1})]).catch(X);return}const{viewport:ye}=Y,$t=ye.isMobile||!1,nr=ye.width,lr=ye.height,cr=ye.deviceScaleFactor??1,dr=ye.isLandscape?{angle:90,type:"landscapePrimary"}:{angle:0,type:"portraitPrimary"},ur=ye.hasTouch||!1;await Promise.all([k.send("Emulation.setDeviceMetricsOverride",{mobile:$t,width:nr,height:lr,deviceScaleFactor:cr,screenOrientation:dr}).catch(Uo=>{if(Uo.message.includes("Target does not support metrics override")){X(Uo);return}throw Uo}),k.send("Emulation.setTouchEmulationEnabled",{enabled:ur})])},"#applyViewport")},o,{kind:"method",name:"#applyViewport",static:!1,private:!0,access:{has:k=>yt(H,k),get:k=>n(k,H,Hu)},metadata:W},null,t),Ht(Q,i={value:Vt(async function(k,Y){Y.active&&(Y.overrides?await k.send("Emulation.setIdleOverride",{isUserActive:Y.overrides.isUserActive,isScreenUnlocked:Y.overrides.isScreenUnlocked}):await k.send("Emulation.clearIdleOverride"))},"#emulateIdleState")},a,{kind:"method",name:"#emulateIdleState",static:!1,private:!0,access:{has:k=>yt(H,k),get:k=>n(k,H,Vu)},metadata:W},null,t),Ht(Q,s={value:Vt(async function(k,Y){if(Y.active)try{await k.send("Emulation.setTimezoneOverride",{timezoneId:Y.timezoneId||""})}catch(ye){throw ro(ye)&&ye.message.includes("Invalid timezone")?new Error(`Invalid timezone ID: ${Y.timezoneId}`):ye}},"#emulateTimezone")},r,{kind:"method",name:"#emulateTimezone",static:!1,private:!0,access:{has:k=>yt(H,k),get:k=>n(k,H,Wu)},metadata:W},null,t),Ht(Q,d={value:Vt(async function(k,Y){Y.active&&await k.send("Emulation.setEmulatedVisionDeficiency",{type:Y.visionDeficiency||"none"})},"#emulateVisionDeficiency")},l,{kind:"method",name:"#emulateVisionDeficiency",static:!1,private:!0,access:{has:k=>yt(H,k),get:k=>n(k,H,Gu)},metadata:W},null,t),Ht(Q,u={value:Vt(async function(k,Y){Y.active&&await k.send("Emulation.setCPUThrottlingRate",{rate:Y.factor??1})},"#emulateCpuThrottling")},c,{kind:"method",name:"#emulateCpuThrottling",static:!1,private:!0,access:{has:k=>yt(H,k),get:k=>n(k,H,Ku)},metadata:W},null,t),Ht(Q,g={value:Vt(async function(k,Y){Y.active&&await k.send("Emulation.setEmulatedMedia",{features:Y.mediaFeatures})},"#emulateMediaFeatures")},p,{kind:"method",name:"#emulateMediaFeatures",static:!1,private:!0,access:{has:k=>yt(H,k),get:k=>n(k,H,qu)},metadata:W},null,t),Ht(Q,b={value:Vt(async function(k,Y){Y.active&&await k.send("Emulation.setEmulatedMedia",{media:Y.type||""})},"#emulateMediaType")},m,{kind:"method",name:"#emulateMediaType",static:!1,private:!0,access:{has:k=>yt(H,k),get:k=>n(k,H,Yu)},metadata:W},null,t),Ht(Q,E={value:Vt(async function(k,Y){Y.active&&await k.send("Emulation.setGeolocationOverride",Y.geoLocation?{longitude:Y.geoLocation.longitude,latitude:Y.geoLocation.latitude,accuracy:Y.geoLocation.accuracy}:void 0)},"#setGeolocation")},h,{kind:"method",name:"#setGeolocation",static:!1,private:!0,access:{has:k=>yt(H,k),get:k=>n(k,H,Zu)},metadata:W},null,t),Ht(Q,S={value:Vt(async function(k,Y){Y.active&&await k.send("Emulation.setDefaultBackgroundColorOverride",{color:Y.color})},"#setDefaultBackgroundColor")},w,{kind:"method",name:"#setDefaultBackgroundColor",static:!1,private:!0,access:{has:k=>yt(H,k),get:k=>n(k,H,Xu)},metadata:W},null,t),Ht(Q,R={value:Vt(async function(k,Y){Y.active&&await k.send("Emulation.setScriptExecutionDisabled",{value:!Y.javaScriptEnabled})},"#setJavaScriptEnabled")},C,{kind:"method",name:"#setJavaScriptEnabled",static:!1,private:!0,access:{has:k=>yt(H,k),get:k=>n(k,H,Ju)},metadata:W},null,t),W&&Object.defineProperty(Q,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:W})})(),Q})();/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var wt,Ti,Zt,ll,as,is,sa,cl,rs,jd,dl,ul,Hd,wi,pn;class qf extends Ie{constructor(e,a,i){super();f(this,wi);f(this,wt);f(this,Ti,new Map);f(this,Zt,new Map);f(this,ll,new Map);f(this,as);f(this,is);f(this,sa,new WeakMap);f(this,cl,me.create());f(this,rs,new Set);f(this,jd,e=>{this.removeSessionListeners(e),n(this,ll).delete(e.id())});f(this,dl,async e=>{if(n(this,Ti).has(e.targetInfo.targetId))return;if(n(this,Ti).set(e.targetInfo.targetId,e.targetInfo),e.targetInfo.type==="browser"&&e.targetInfo.attached){const i=n(this,is).call(this,e.targetInfo,void 0);i._initialize(),n(this,Zt).set(e.targetInfo.targetId,i),T(this,wi,pn).call(this,i._targetId);return}const a=n(this,is).call(this,e.targetInfo,void 0);if(n(this,as)&&!n(this,as).call(this,a)){T(this,wi,pn).call(this,e.targetInfo.targetId);return}a._initialize(),n(this,Zt).set(e.targetInfo.targetId,a),this.emit("targetAvailable",a),T(this,wi,pn).call(this,a._targetId)});f(this,ul,e=>{n(this,Ti).delete(e.targetId),T(this,wi,pn).call(this,e.targetId);const a=n(this,Zt).get(e.targetId);a&&(this.emit("targetGone",a),n(this,Zt).delete(e.targetId))});f(this,Hd,async(e,a)=>{const i=a.targetInfo,r=n(this,wt).session(a.sessionId);if(!r)throw new Error(`Session ${a.sessionId} was not created.`);const s=n(this,Zt).get(i.targetId);$(s,`Target ${i.targetId} is missing`),r._setTarget(s),this.setupAttachmentListeners(r),n(this,ll).set(r.id(),n(this,Zt).get(i.targetId)),e.emit(ve.Ready,r)});v(this,wt,e),v(this,as,i),v(this,is,a),n(this,wt).on("Target.targetCreated",n(this,dl)),n(this,wt).on("Target.targetDestroyed",n(this,ul)),n(this,wt).on(ve.SessionDetached,n(this,jd)),this.setupAttachmentListeners(n(this,wt))}setupAttachmentListeners(e){const a=i=>n(this,Hd).call(this,e,i);$(!n(this,sa).has(e)),n(this,sa).set(e,a),e.on("Target.attachedToTarget",a)}removeSessionListeners(e){n(this,sa).has(e)&&(e.off("Target.attachedToTarget",n(this,sa).get(e)),n(this,sa).delete(e))}getAvailableTargets(){return n(this,Zt)}getChildTargets(e){return new Set}dispose(){n(this,wt).off("Target.targetCreated",n(this,dl)),n(this,wt).off("Target.targetDestroyed",n(this,ul))}async initialize(){await n(this,wt).send("Target.setDiscoverTargets",{discover:!0,filter:[{}]}),v(this,rs,new Set(n(this,Ti).keys())),await n(this,cl).valueOrThrow()}}wt=new WeakMap,Ti=new WeakMap,Zt=new WeakMap,ll=new WeakMap,as=new WeakMap,is=new WeakMap,sa=new WeakMap,cl=new WeakMap,rs=new WeakMap,jd=new WeakMap,dl=new WeakMap,ul=new WeakMap,Hd=new WeakMap,wi=new WeakSet,pn=function(e){n(this,rs).delete(e),n(this,rs).size===0&&n(this,cl).resolve()};/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const rd=Symbol("_isElementHandle");/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const zm=new Map,_b=t=>{let o=zm.get(t);return o||(o=new Function(`return ${t}`)(),zm.set(t,o),o)};function La(t){var e;let o;return typeof t=="function"&&((e=globalThis.navigator)==null?void 0:e.userAgent)==="Cloudflare-Workers"?o=`((__name => (${t}))(t => t))`:o=t.toString(),o}const bn=(t,o)=>{let e=La(t);for(const[a,i]of Object.entries(o))e=e.replace(new RegExp(`PLACEHOLDER\\(\\s*(?:'${a}'|"${a}")\\s*\\)`,"g"),`(${i})`);return _b(e)};/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var sd=function(t,o,e){if(o!=null){if(typeof o!="object"&&typeof o!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=o[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=o[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");t.stack.push({value:o,dispose:a,async:e})}else e&&t.stack.push({async:!0});return o},Qu=(function(t){return function(o){function e(i){o.error=o.hasError?new t(i,o.error,"An error was suppressed during disposal."):i,o.hasError=!0}function a(){for(;o.stack.length;){var i=o.stack.pop();try{var r=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(r).then(a,function(s){return e(s),a()})}catch(s){e(s)}}if(o.hasError)throw o.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(t,o,e){var a=new Error(e);return a.name="SuppressedError",a.error=t,a.suppressed=o,a});const Ob=20;async function*Db(t,o){const e={stack:[],error:void 0,hasError:!1};try{const i=await sd(e,await t.evaluateHandle(async(l,d)=>{const c=[];for(;c.length<d;){const u=await l.next();if(u.done)break;c.push(u.value)}return c},o),!1).getProperties(),r=i.values();return sd(e,new zo,!1).defer(()=>{for(const l of r){const d={stack:[],error:void 0,hasError:!1};try{sd(d,l,!1)[ge]()}catch(c){d.error=c,d.hasError=!0}finally{Qu(d)}}}),yield*r,i.size===0}catch(a){e.error=a,e.hasError=!0}finally{Qu(e)}}async function*Mb(t){let o=Ob;for(;!(yield*Db(t,o));)o<<=1}async function*Yf(t){const o={stack:[],error:void 0,hasError:!1};try{const e=sd(o,await t.evaluateHandle(a=>(async function*(){yield*a})()),!1);yield*Mb(e)}catch(e){o.error=e,o.hasError=!0}finally{Qu(o)}}/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var pl;const Vd=class Vd{constructor(o){f(this,pl);v(this,pl,o)}async get(o){return await n(this,pl).call(this,o)}};pl=new WeakMap,O(Vd,"create",o=>new Vd(o));let ao=Vd;/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Wc=function(t,o,e){if(o!=null){if(typeof o!="object"&&typeof o!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=o[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=o[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");t.stack.push({value:o,dispose:a,async:e})}else e&&t.stack.push({async:!0});return o},Gc=(function(t){return function(o){function e(i){o.error=o.hasError?new t(i,o.error,"An error was suppressed during disposal."):i,o.hasError=!0}function a(){for(;o.stack.length;){var i=o.stack.pop();try{var r=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(r).then(a,function(s){return e(s),a()})}catch(s){e(s)}}if(o.hasError)throw o.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(t,o,e){var a=new Error(e);return a.name="SuppressedError",a.error=t,a.suppressed=o,a});class Lo{static get _querySelector(){if(this.querySelector)return this.querySelector;if(!this.querySelectorAll)throw new Error("Cannot create default `querySelector`.");return this.querySelector=bn(async(o,e,a)=>{const r=PLACEHOLDER("querySelectorAll")(o,e,a);for await(const s of r)return s;return null},{querySelectorAll:La(this.querySelectorAll)})}static get _querySelectorAll(){if(this.querySelectorAll)return this.querySelectorAll;if(!this.querySelector)throw new Error("Cannot create default `querySelectorAll`.");return this.querySelectorAll=bn(async function*(o,e,a){const r=await PLACEHOLDER("querySelector")(o,e,a);r&&(yield r)},{querySelector:La(this.querySelector)})}static async*queryAll(o,e){const a={stack:[],error:void 0,hasError:!1};try{const i=Wc(a,await o.evaluateHandle(this._querySelectorAll,e,ao.create(r=>r.puppeteerUtil)),!1);yield*Yf(i)}catch(i){a.error=i,a.hasError=!0}finally{Gc(a)}}static async queryOne(o,e){const a={stack:[],error:void 0,hasError:!1};try{const i=Wc(a,await o.evaluateHandle(this._querySelector,e,ao.create(r=>r.puppeteerUtil)),!1);return rd in i?i.move():null}catch(i){a.error=i,a.hasError=!0}finally{Gc(a)}}static async waitFor(o,e,a){const i={stack:[],error:void 0,hasError:!1};try{let r;const s=Wc(i,await(async()=>{if(!(rd in o)){r=o;return}return r=o.frame,await r.isolatedRealm().adoptHandle(o)})(),!1),{visible:l=!1,hidden:d=!1,timeout:c,signal:u}=a,p=a.polling??(l||d?"raf":"mutation");try{const g={stack:[],error:void 0,hasError:!1};try{u==null||u.throwIfAborted();const m=Wc(g,await r.isolatedRealm().waitForFunction(async(b,h,E,w,S)=>{const R=await b.createFunction(h)(w??document,E,b);return b.checkVisibility(R,S)},{polling:p,root:s,timeout:c,signal:u},ao.create(b=>b.puppeteerUtil),La(this._querySelector),e,s,l?!0:d?!1:void 0),!1);if(u!=null&&u.aborted)throw u.reason;return rd in m?await r.mainRealm().transferHandle(m):null}catch(m){g.error=m,g.hasError=!0}finally{Gc(g)}}catch(g){throw!ro(g)||g.name==="AbortError"||(g.message=`Waiting for selector \`${e}\` failed: ${g.message}`),g}}catch(r){i.error=r,i.hasError=!0}finally{Gc(i)}}}O(Lo,"querySelectorAll"),O(Lo,"querySelector");class lu{static async*map(o,e){for await(const a of o)yield await e(a)}static async*flatMap(o,e){for await(const a of o)yield*e(a)}static async collect(o){const e=[];for await(const a of o)e.push(a);return e}static async first(o){for await(const e of o)return e}}/**
 * @license
 * Copyright 2020 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const zb=t=>["name","role"].includes(t),Lm=t=>t.replace(/ +/g," ").trim(),Lb=/\[\s*(?<attribute>\w+)\s*=\s*(?<quote>"|')(?<value>\\.|.*?(?=\k<quote>))\k<quote>\s*\]/g,Nb=t=>{const o={},e=t.replace(Lb,(a,i,r,s)=>(i=i.trim(),$(zb(i),`Unknown aria attribute "${i}" in selector`),o[i]=Lm(s),""));return e&&!o.name&&(o.name=Lm(e)),o},wn=class wn extends Lo{static async*queryAll(o,e){const{name:a,role:i}=Nb(e);yield*o.queryAXTree(a,i)}};O(wn,"querySelector",async(o,e,{ariaQuerySelector:a})=>await a(o,e)),O(wn,"queryOne",async(o,e)=>await lu.first(wn.queryAll(o,e))??null);let xn=wn;/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class Od extends Lo{}O(Od,"querySelector",(o,e,{cssQuerySelector:a})=>a(o,e)),O(Od,"querySelectorAll",(o,e,{cssQuerySelectorAll:a})=>a(o,e));const Pb='"use strict";var g=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var Y=Object.prototype.hasOwnProperty;var l=(t,e)=>{for(var r in e)g(t,r,{get:e[r],enumerable:!0})},G=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of B(e))!Y.call(t,n)&&n!==r&&g(t,n,{get:()=>e[n],enumerable:!(o=X(e,n))||o.enumerable});return t};var J=t=>G(g({},"__esModule",{value:!0}),t);var pe={};l(pe,{default:()=>he});module.exports=J(pe);var N=class extends Error{constructor(e,r){super(e,r),this.name=this.constructor.name}get[Symbol.toStringTag](){return this.constructor.name}},p=class extends N{};var c=class t{static create(e){return new t(e)}static async race(e){let r=new Set;try{let o=e.map(n=>n instanceof t?(n.#n&&r.add(n),n.valueOrThrow()):n);return await Promise.race(o)}finally{for(let o of r)o.reject(new Error("Timeout cleared"))}}#e=!1;#r=!1;#o;#t;#a=new Promise(e=>{this.#t=e});#n;#i;constructor(e){e&&e.timeout>0&&(this.#i=new p(e.message),this.#n=setTimeout(()=>{this.reject(this.#i)},e.timeout))}#l(e){clearTimeout(this.#n),this.#o=e,this.#t()}resolve(e){this.#r||this.#e||(this.#e=!0,this.#l(e))}reject(e){this.#r||this.#e||(this.#r=!0,this.#l(e))}resolved(){return this.#e}finished(){return this.#e||this.#r}value(){return this.#o}#s;valueOrThrow(){return this.#s||(this.#s=(async()=>{if(await this.#a,this.#r)throw this.#o;return this.#o})()),this.#s}};var L=new Map,F=t=>{let e=L.get(t);return e||(e=new Function(`return ${t}`)(),L.set(t,e),e)};var x={};l(x,{ariaQuerySelector:()=>z,ariaQuerySelectorAll:()=>b});var z=(t,e)=>globalThis.__ariaQuerySelector(t,e),b=async function*(t,e){yield*await globalThis.__ariaQuerySelectorAll(t,e)};var E={};l(E,{cssQuerySelector:()=>K,cssQuerySelectorAll:()=>Z});var K=(t,e)=>t.querySelector(e),Z=function(t,e){return t.querySelectorAll(e)};var A={};l(A,{customQuerySelectors:()=>P});var v=class{#e=new Map;register(e,r){if(!r.queryOne&&r.queryAll){let o=r.queryAll;r.queryOne=(n,i)=>{for(let s of o(n,i))return s;return null}}else if(r.queryOne&&!r.queryAll){let o=r.queryOne;r.queryAll=(n,i)=>{let s=o(n,i);return s?[s]:[]}}else if(!r.queryOne||!r.queryAll)throw new Error("At least one query method must be defined.");this.#e.set(e,{querySelector:r.queryOne,querySelectorAll:r.queryAll})}unregister(e){this.#e.delete(e)}get(e){return this.#e.get(e)}clear(){this.#e.clear()}},P=new v;var R={};l(R,{pierceQuerySelector:()=>ee,pierceQuerySelectorAll:()=>te});var ee=(t,e)=>{let r=null,o=n=>{let i=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT);do{let s=i.currentNode;s.shadowRoot&&o(s.shadowRoot),!(s instanceof ShadowRoot)&&s!==n&&!r&&s.matches(e)&&(r=s)}while(!r&&i.nextNode())};return t instanceof Document&&(t=t.documentElement),o(t),r},te=(t,e)=>{let r=[],o=n=>{let i=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT);do{let s=i.currentNode;s.shadowRoot&&o(s.shadowRoot),!(s instanceof ShadowRoot)&&s!==n&&s.matches(e)&&r.push(s)}while(i.nextNode())};return t instanceof Document&&(t=t.documentElement),o(t),r};var u=(t,e)=>{if(!t)throw new Error(e)};var y=class{#e;#r;#o;#t;constructor(e,r){this.#e=e,this.#r=r}async start(){let e=this.#t=c.create(),r=await this.#e();if(r){e.resolve(r);return}this.#o=new MutationObserver(async()=>{let o=await this.#e();o&&(e.resolve(o),await this.stop())}),this.#o.observe(this.#r,{childList:!0,subtree:!0,attributes:!0})}async stop(){u(this.#t,"Polling never started."),this.#t.finished()||this.#t.reject(new Error("Polling stopped")),this.#o&&(this.#o.disconnect(),this.#o=void 0)}result(){return u(this.#t,"Polling never started."),this.#t.valueOrThrow()}},w=class{#e;#r;constructor(e){this.#e=e}async start(){let e=this.#r=c.create(),r=await this.#e();if(r){e.resolve(r);return}let o=async()=>{if(e.finished())return;let n=await this.#e();if(!n){window.requestAnimationFrame(o);return}e.resolve(n),await this.stop()};window.requestAnimationFrame(o)}async stop(){u(this.#r,"Polling never started."),this.#r.finished()||this.#r.reject(new Error("Polling stopped"))}result(){return u(this.#r,"Polling never started."),this.#r.valueOrThrow()}},T=class{#e;#r;#o;#t;constructor(e,r){this.#e=e,this.#r=r}async start(){let e=this.#t=c.create(),r=await this.#e();if(r){e.resolve(r);return}this.#o=setInterval(async()=>{let o=await this.#e();o&&(e.resolve(o),await this.stop())},this.#r)}async stop(){u(this.#t,"Polling never started."),this.#t.finished()||this.#t.reject(new Error("Polling stopped")),this.#o&&(clearInterval(this.#o),this.#o=void 0)}result(){return u(this.#t,"Polling never started."),this.#t.valueOrThrow()}};var _={};l(_,{PCombinator:()=>H,pQuerySelector:()=>fe,pQuerySelectorAll:()=>$});var a=class{static async*map(e,r){for await(let o of e)yield await r(o)}static async*flatMap(e,r){for await(let o of e)yield*r(o)}static async collect(e){let r=[];for await(let o of e)r.push(o);return r}static async first(e){for await(let r of e)return r}};var C={};l(C,{textQuerySelectorAll:()=>m});var re=new Set(["checkbox","image","radio"]),oe=t=>t instanceof HTMLSelectElement||t instanceof HTMLTextAreaElement||t instanceof HTMLInputElement&&!re.has(t.type),ne=new Set(["SCRIPT","STYLE"]),f=t=>!ne.has(t.nodeName)&&!document.head?.contains(t),I=new WeakMap,j=t=>{for(;t;)I.delete(t),t instanceof ShadowRoot?t=t.host:t=t.parentNode},W=new WeakSet,se=new MutationObserver(t=>{for(let e of t)j(e.target)}),d=t=>{let e=I.get(t);if(e||(e={full:"",immediate:[]},!f(t)))return e;let r="";if(oe(t))e.full=t.value,e.immediate.push(t.value),t.addEventListener("input",o=>{j(o.target)},{once:!0,capture:!0});else{for(let o=t.firstChild;o;o=o.nextSibling){if(o.nodeType===Node.TEXT_NODE){e.full+=o.nodeValue??"",r+=o.nodeValue??"";continue}r&&e.immediate.push(r),r="",o.nodeType===Node.ELEMENT_NODE&&(e.full+=d(o).full)}r&&e.immediate.push(r),t instanceof Element&&t.shadowRoot&&(e.full+=d(t.shadowRoot).full),W.has(t)||(se.observe(t,{childList:!0,characterData:!0,subtree:!0}),W.add(t))}return I.set(t,e),e};var m=function*(t,e){let r=!1;for(let o of t.childNodes)if(o instanceof Element&&f(o)){let n;o.shadowRoot?n=m(o.shadowRoot,e):n=m(o,e);for(let i of n)yield i,r=!0}r||t instanceof Element&&f(t)&&d(t).full.includes(e)&&(yield t)};var O={};l(O,{checkVisibility:()=>le,pierce:()=>S,pierceAll:()=>k});var ie=["hidden","collapse"],le=(t,e)=>{if(!t)return e===!1;if(e===void 0)return t;let r=t.nodeType===Node.TEXT_NODE?t.parentElement:t,o=window.getComputedStyle(r),n=o&&!ie.includes(o.visibility)&&!ae(r);return e===n?t:!1};function ae(t){let e=t.getBoundingClientRect();return e.width===0||e.height===0}var ce=t=>"shadowRoot"in t&&t.shadowRoot instanceof ShadowRoot;function*S(t){ce(t)?yield t.shadowRoot:yield t}function*k(t){t=S(t).next().value,yield t;let e=[document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT)];for(let r of e){let o;for(;o=r.nextNode();)o.shadowRoot&&(yield o.shadowRoot,e.push(document.createTreeWalker(o.shadowRoot,NodeFilter.SHOW_ELEMENT)))}}var Q={};l(Q,{xpathQuerySelectorAll:()=>q});var q=function*(t,e,r=-1){let n=(t.ownerDocument||document).evaluate(e,t,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE),i=[],s;for(;(s=n.iterateNext())&&(i.push(s),!(r&&i.length===r)););for(let h=0;h<i.length;h++)s=i[h],yield s,delete i[h]};var ue=/[-\\w\\P{ASCII}*]/,H=(r=>(r.Descendent=">>>",r.Child=">>>>",r))(H||{}),V=t=>"querySelectorAll"in t,M=class{#e;#r=[];#o=void 0;elements;constructor(e,r){this.elements=[e],this.#e=r,this.#t()}async run(){if(typeof this.#o=="string")switch(this.#o.trimStart()){case":scope":this.#t();break}for(;this.#o!==void 0;this.#t()){let e=this.#o;typeof e=="string"?e[0]&&ue.test(e[0])?this.elements=a.flatMap(this.elements,async function*(r){V(r)&&(yield*r.querySelectorAll(e))}):this.elements=a.flatMap(this.elements,async function*(r){if(!r.parentElement){if(!V(r))return;yield*r.querySelectorAll(e);return}let o=0;for(let n of r.parentElement.children)if(++o,n===r)break;yield*r.parentElement.querySelectorAll(`:scope>:nth-child(${o})${e}`)}):this.elements=a.flatMap(this.elements,async function*(r){switch(e.name){case"text":yield*m(r,e.value);break;case"xpath":yield*q(r,e.value);break;case"aria":yield*b(r,e.value);break;default:let o=P.get(e.name);if(!o)throw new Error(`Unknown selector type: ${e.name}`);yield*o.querySelectorAll(r,e.value)}})}}#t(){if(this.#r.length!==0){this.#o=this.#r.shift();return}if(this.#e.length===0){this.#o=void 0;return}let e=this.#e.shift();switch(e){case">>>>":{this.elements=a.flatMap(this.elements,S),this.#t();break}case">>>":{this.elements=a.flatMap(this.elements,k),this.#t();break}default:this.#r=e,this.#t();break}}},D=class{#e=new WeakMap;calculate(e,r=[]){if(e===null)return r;e instanceof ShadowRoot&&(e=e.host);let o=this.#e.get(e);if(o)return[...o,...r];let n=0;for(let s=e.previousSibling;s;s=s.previousSibling)++n;let i=this.calculate(e.parentNode,[n]);return this.#e.set(e,i),[...i,...r]}},U=(t,e)=>{if(t.length+e.length===0)return 0;let[r=-1,...o]=t,[n=-1,...i]=e;return r===n?U(o,i):r<n?-1:1},de=async function*(t){let e=new Set;for await(let o of t)e.add(o);let r=new D;yield*[...e.values()].map(o=>[o,r.calculate(o)]).sort(([,o],[,n])=>U(o,n)).map(([o])=>o)},$=function(t,e){let r=JSON.parse(e);if(r.some(o=>{let n=0;return o.some(i=>(typeof i=="string"?++n:n=0,n>1))}))throw new Error("Multiple deep combinators found in sequence.");return de(a.flatMap(r,o=>{let n=new M(t,o);return n.run(),n.elements}))},fe=async function(t,e){for await(let r of $(t,e))return r;return null};var me=Object.freeze({...x,...A,...R,..._,...C,...O,...Q,...E,Deferred:c,createFunction:F,createTextContent:d,IntervalPoller:T,isSuitableNodeForTextMatching:f,MutationPoller:y,RAFPoller:w}),he=me;\n';/**
 * @license
 * Copyright 2024 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var ss,ns,ar,ep,Zf;class Bb{constructor(){f(this,ar);f(this,ss,!1);f(this,ns,new Set)}append(o){T(this,ar,ep).call(this,()=>{n(this,ns).add(o)})}pop(o){T(this,ar,ep).call(this,()=>{n(this,ns).delete(o)})}inject(o,e=!1){(n(this,ss)||e)&&o(T(this,ar,Zf).call(this)),v(this,ss,!1)}}ss=new WeakMap,ns=new WeakMap,ar=new WeakSet,ep=function(o){o(),v(this,ss,!0)},Zf=function(){return`(() => {
      const module = {};
      ${Pb}
      ${[...n(this,ns)].map(o=>`(${o})(module.exports.default);`).join("")}
      return module.exports.default;
    })()`};const nd=new Bb;/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Mt;class kb{constructor(){f(this,Mt,new Map)}get(o){const e=n(this,Mt).get(o);return e?e[1]:void 0}register(o,e){var r;$(!n(this,Mt).has(o),`Cannot register over existing handler: ${o}`),$(/^[a-zA-Z]+$/.test(o),"Custom query handler names may only contain [a-zA-Z]"),$(e.queryAll||e.queryOne,"At least one query method must be implemented.");const a=(r=class extends Lo{},O(r,"querySelectorAll",bn((s,l,d)=>d.customQuerySelectors.get(PLACEHOLDER("name")).querySelectorAll(s,l),{name:JSON.stringify(o)})),O(r,"querySelector",bn((s,l,d)=>d.customQuerySelectors.get(PLACEHOLDER("name")).querySelector(s,l),{name:JSON.stringify(o)})),r),i=bn(s=>{s.customQuerySelectors.register(PLACEHOLDER("name"),{queryAll:PLACEHOLDER("queryAll"),queryOne:PLACEHOLDER("queryOne")})},{name:JSON.stringify(o),queryAll:e.queryAll?La(e.queryAll):String(void 0),queryOne:e.queryOne?La(e.queryOne):String(void 0)}).toString();n(this,Mt).set(o,[i,a]),nd.append(i)}unregister(o){const e=n(this,Mt).get(o);if(!e)throw new Error(`Cannot unregister unknown handler: ${o}`);nd.pop(e[0]),n(this,Mt).delete(o)}names(){return[...n(this,Mt).keys()]}clear(){for(const[o]of n(this,Mt))nd.pop(o);n(this,Mt).clear()}}Mt=new WeakMap;const tp=new kb;/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class op extends Lo{}O(op,"querySelector",(o,e,{pierceQuerySelector:a})=>a(o,e)),O(op,"querySelectorAll",(o,e,{pierceQuerySelectorAll:a})=>a(o,e));/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class ap extends Lo{}O(ap,"querySelectorAll",(o,e,{pQuerySelectorAll:a})=>a(o,e)),O(ap,"querySelector",(o,e,{pQuerySelector:a})=>a(o,e));var Xs={attribute:/\[\s*(?:(?<namespace>\*|[-\w\P{ASCII}]*)\|)?(?<name>[-\w\P{ASCII}]+)\s*(?:(?<operator>\W?=)\s*(?<value>.+?)\s*(\s(?<caseSensitive>[iIsS]))?\s*)?\]/gu,id:/#(?<name>[-\w\P{ASCII}]+)/gu,class:/\.(?<name>[-\w\P{ASCII}]+)/gu,comma:/\s*,\s*/g,combinator:/\s*[\s>+~]\s*/g,"pseudo-element":/::(?<name>[-\w\P{ASCII}]+)(?:\((?<argument>¬∂*)\))?/gu,"pseudo-class":/:(?<name>[-\w\P{ASCII}]+)(?:\((?<argument>¬∂*)\))?/gu,universal:/(?:(?<namespace>\*|[-\w\P{ASCII}]*)\|)?\*/gu,type:/(?:(?<namespace>\*|[-\w\P{ASCII}]*)\|)?(?<name>[-\w\P{ASCII}]+)/gu},Fb=new Set(["combinator","comma"]),$b=t=>{switch(t){case"pseudo-element":case"pseudo-class":return new RegExp(Xs[t].source.replace("(?<argument>¬∂*)","(?<argument>.*)"),"gu");default:return Xs[t]}};function Ub(t,o){let e=0,a="";for(;o<t.length;o++){const i=t[o];switch(i){case"(":++e;break;case")":--e;break}if(a+=i,e===0)return a}return a}function jb(t,o=Xs){if(!t)return[];const e=[t];for(const[i,r]of Object.entries(o))for(let s=0;s<e.length;s++){const l=e[s];if(typeof l!="string")continue;r.lastIndex=0;const d=r.exec(l);if(!d)continue;const c=d.index-1,u=[],p=d[0],g=l.slice(0,c+1);g&&u.push(g),u.push({...d.groups,type:i,content:p});const m=l.slice(c+p.length+1);m&&u.push(m),e.splice(s,1,...u)}let a=0;for(const i of e)switch(typeof i){case"string":throw new Error(`Unexpected sequence ${i} found at index ${a}`);case"object":a+=i.content.length,i.pos=[a-i.content.length,a],Fb.has(i.type)&&(i.content=i.content.trim()||" ");break}return e}var Hb=/(['"])([^\\\n]+?)\1/g,Vb=/\\./g;function Wb(t,o=Xs){if(t=t.trim(),t==="")return[];const e=[];t=t.replace(Vb,(r,s)=>(e.push({value:r,offset:s}),"ÓÄÄ".repeat(r.length))),t=t.replace(Hb,(r,s,l,d)=>(e.push({value:r,offset:d}),`${s}${"ÓÄÅ".repeat(l.length)}${s}`));{let r=0,s;for(;(s=t.indexOf("(",r))>-1;){const l=Ub(t,s);e.push({value:l,offset:s}),t=`${t.substring(0,s)}(${"¬∂".repeat(l.length-2)})${t.substring(s+l.length)}`,r=s+l.length}}const a=jb(t,o),i=new Set;for(const r of e.reverse())for(const s of a){const{offset:l,value:d}=r;if(!(s.pos[0]<=l&&l+d.length<=s.pos[1]))continue;const{content:c}=s,u=l-s.pos[0];s.content=c.slice(0,u)+d+c.slice(u+d.length),s.content!==c&&i.add(s)}for(const r of i){const s=$b(r.type);if(!s)throw new Error(`Unknown token type: ${r.type}`);s.lastIndex=0;const l=s.exec(r.content);if(!l)throw new Error(`Unable to parse content for ${r.type}: ${r.content}`);Object.assign(r,l.groups)}return a}function*ld(t,o){switch(t.type){case"list":for(let e of t.list)yield*ld(e,t);break;case"complex":yield*ld(t.left,t),yield*ld(t.right,t);break;case"compound":yield*t.list.map(e=>[e,t]);break;default:yield[t,o]}}function nn(t){let o;return Array.isArray(t)?o=t:o=[...ld(t)].map(([e])=>e),o.map(e=>e.content).join("")}/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */Xs.nesting=/&/g;Xs.combinator=/\s*(>>>>?|[\s>+~])\s*/g;const Gb=/\\[\s\S]/g,Kb=t=>t.length<=1?t:((t[0]==='"'||t[0]==="'")&&t.endsWith(t[0])&&(t=t.slice(1,-1)),t.replace(Gb,o=>o[1]));function qb(t){let o=!0,e=!1,a=!1;const i=Wb(t);if(i.length===0)return[[],o,a,!1];let r=[],s=[r];const l=[s],d=[];for(const c of i){switch(c.type){case"combinator":switch(c.content){case">>>":o=!1,d.length&&(r.push(nn(d)),d.splice(0)),r=[],s.push(">>>"),s.push(r);continue;case">>>>":o=!1,d.length&&(r.push(nn(d)),d.splice(0)),r=[],s.push(">>>>"),s.push(r);continue}break;case"pseudo-element":if(!c.name.startsWith("-p-"))break;o=!1,d.length&&(r.push(nn(d)),d.splice(0));const u=c.name.slice(3);u==="aria"&&(e=!0),r.push({name:u,value:Kb(c.argument??"")});continue;case"pseudo-class":a=!0;break;case"comma":d.length&&(r.push(nn(d)),d.splice(0)),r=[],s=[r],l.push(s);continue}d.push(c)}return d.length&&r.push(nn(d)),[l,o,a,e]}/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class Xf extends Lo{}O(Xf,"querySelectorAll",(o,e,{textQuerySelectorAll:a})=>a(o,e));/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class ip extends Lo{}O(ip,"querySelectorAll",(o,e,{xpathQuerySelectorAll:a})=>a(o,e)),O(ip,"querySelector",(o,e,{xpathQuerySelectorAll:a})=>{for(const i of a(o,e,1))return i;return null});/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const Yb={aria:xn,pierce:op,xpath:ip,text:Xf},Zb=["=","/"];function cd(t){for(const o of[tp.names().map(e=>[e,tp.get(e)]),Object.entries(Yb)])for(const[e,a]of o)for(const i of Zb){const r=`${e}${i}`;if(t.startsWith(r))return t=t.slice(r.length),{updatedSelector:t,polling:e==="aria"?"raf":"mutation",QueryHandler:a}}try{const[o,e,a,i]=qb(t);return e?{updatedSelector:t,polling:a?"raf":"mutation",QueryHandler:Od}:{updatedSelector:JSON.stringify(o),polling:i?"raf":"mutation",QueryHandler:ap}}catch{return{updatedSelector:t,polling:"mutation",QueryHandler:Od}}}/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Xb=function(t,o,e){for(var a=arguments.length>2,i=0;i<o.length;i++)e=a?o[i].call(t,e):o[i].call(t);return a?e:void 0},Ae=function(t,o,e,a,i,r){function s(w){if(w!==void 0&&typeof w!="function")throw new TypeError("Function expected");return w}for(var l=a.kind,d=l==="getter"?"get":l==="setter"?"set":"value",c=!o&&t?a.static?t:t.prototype:null,u=o||(c?Object.getOwnPropertyDescriptor(c,a.name):{}),p,g=!1,m=e.length-1;m>=0;m--){var b={};for(var h in a)b[h]=h==="access"?{}:a[h];for(var h in a.access)b.access[h]=a.access[h];b.addInitializer=function(w){if(g)throw new TypeError("Cannot add initializers after decoration has completed");r.push(s(w||null))};var E=(0,e[m])(l==="accessor"?{get:u.get,set:u.set}:u[d],b);if(l==="accessor"){if(E===void 0)continue;if(E===null||typeof E!="object")throw new TypeError("Object expected");(p=s(E.get))&&(u.get=p),(p=s(E.set))&&(u.set=p),(p=s(E.init))&&i.unshift(p)}else(p=s(E))&&(l==="field"?i.unshift(p):u[d]=p)}c&&Object.defineProperty(c,a.name,u),g=!0},Vo=function(t,o,e){if(o!=null){if(typeof o!="object"&&typeof o!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=o[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=o[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");t.stack.push({value:o,dispose:a,async:e})}else e&&t.stack.push({async:!0});return o},Wo=(function(t){return function(o){function e(i){o.error=o.hasError?new t(i,o.error,"An error was suppressed during disposal."):i,o.hasError=!0}function a(){for(;o.stack.length;){var i=o.stack.pop();try{var r=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(r).then(a,function(s){return e(s),a()})}catch(s){e(s)}}if(o.hasError)throw o.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(t,o,e){var a=new Error(e);return a.name="SuppressedError",a.error=t,a.suppressed=o,a}),Ue;(function(t){t.FrameNavigated=Symbol("Frame.FrameNavigated"),t.FrameSwapped=Symbol("Frame.FrameSwapped"),t.LifecycleEvent=Symbol("Frame.LifecycleEvent"),t.FrameNavigatedWithinDocument=Symbol("Frame.FrameNavigatedWithinDocument"),t.FrameDetached=Symbol("Frame.FrameDetached"),t.FrameSwappedByActivation=Symbol("Frame.FrameSwappedByActivation")})(Ue||(Ue={}));const he=oe(t=>`Attempted to use detached Frame '${t._id}'.`);let Jb=(()=>{var D,F,mn,M;let t=Ie,o=[],e,a,i,r,s,l,d,c,u,p,g,m,b,h,E,w,S,C,R,z;return M=class extends t{constructor(){super();f(this,F);O(this,"_id",Xb(this,o));O(this,"_parentId");O(this,"_name");O(this,"_hasStartedLoading",!1);f(this,D)}clearDocumentHandle(){v(this,D,void 0)}async frameElement(){const A={stack:[],error:void 0,hasError:!1};try{const x=this.parentFrame();if(!x)return null;const P=Vo(A,await x.isolatedRealm().evaluateHandle(()=>document.querySelectorAll("iframe,frame")),!1);for await(const B of Yf(P)){const J={stack:[],error:void 0,hasError:!1};try{const ae=Vo(J,B,!1),ie=await ae.contentFrame();if((ie==null?void 0:ie._id)===this._id)return ae.move()}catch(ae){J.error=ae,J.hasError=!0}finally{Wo(J)}}return null}catch(x){A.error=x,A.hasError=!0}finally{Wo(A)}}async evaluateHandle(A,...x){return A=Ne(this.evaluateHandle.name,A),await this.mainRealm().evaluateHandle(A,...x)}async evaluate(A,...x){return A=Ne(this.evaluate.name,A),await this.mainRealm().evaluate(A,...x)}locator(A){return typeof A=="string"?Rd.create(this,A):Ad.create(this,A)}async $(A){return await(await T(this,F,mn).call(this)).$(A)}async $$(A,x){return await(await T(this,F,mn).call(this)).$$(A,x)}async $eval(A,x,...P){return x=Ne(this.$eval.name,x),await(await T(this,F,mn).call(this)).$eval(A,x,...P)}async $$eval(A,x,...P){return x=Ne(this.$$eval.name,x),await(await T(this,F,mn).call(this)).$$eval(A,x,...P)}async waitForSelector(A,x={}){const{updatedSelector:P,QueryHandler:B,polling:J}=cd(A);return await B.waitFor(this,P,{polling:J,...x})}async waitForFunction(A,x={},...P){return await this.mainRealm().waitForFunction(A,x,...P)}async content(){return await this.evaluate(()=>{let A="";for(const x of document.childNodes)switch(x){case document.documentElement:A+=document.documentElement.outerHTML;break;default:A+=new XMLSerializer().serializeToString(x);break}return A})}async setFrameContent(A){return await this.evaluate(x=>{document.open(),document.write(x),document.close()},A)}name(){return this._name||""}isDetached(){return this.detached}get disposed(){return this.detached}async addScriptTag(A){let{content:x="",type:P}=A;const{path:B}=A;if(+!!A.url+ +!!B+ +!!x!=1)throw new Error("Exactly one of `url`, `path`, or `content` must be specified.");return B&&(x=await(await xm()).readFile(B,"utf8"),x+=`//# sourceURL=${B.replace(/\n/g,"")}`),P=P??"text/javascript",await this.mainRealm().transferHandle(await this.isolatedRealm().evaluateHandle(async({url:J,id:ae,type:ie,content:Z})=>await new Promise((H,We)=>{const Se=document.createElement("script");Se.type=ie,Se.text=Z,Se.addEventListener("error",ut=>{We(new Error(ut.message??"Could not load script"))},{once:!0}),ae&&(Se.id=ae),J?(Se.src=J,Se.addEventListener("load",()=>{H(Se)},{once:!0}),document.head.appendChild(Se)):(document.head.appendChild(Se),H(Se))}),{...A,type:P,content:x}))}async addStyleTag(A){let{content:x=""}=A;const{path:P}=A;if(+!!A.url+ +!!P+ +!!x!=1)throw new Error("Exactly one of `url`, `path`, or `content` must be specified.");return P&&(x=await(await xm()).readFile(P,"utf8"),x+="/*# sourceURL="+P.replace(/\n/g,"")+"*/",A.content=x),await this.mainRealm().transferHandle(await this.isolatedRealm().evaluateHandle(async({url:B,content:J})=>await new Promise((ae,ie)=>{let Z;if(!B)Z=document.createElement("style"),Z.appendChild(document.createTextNode(J));else{const H=document.createElement("link");H.rel="stylesheet",H.href=B,Z=H}return Z.addEventListener("load",()=>{ae(Z)},{once:!0}),Z.addEventListener("error",H=>{ie(new Error(H.message??"Could not load style"))},{once:!0}),document.head.appendChild(Z),Z}),A))}async click(A,x={}){const P={stack:[],error:void 0,hasError:!1};try{const B=Vo(P,await this.$(A),!1);$(B,`No element found for selector: ${A}`),await B.click(x),await B.dispose()}catch(B){P.error=B,P.hasError=!0}finally{Wo(P)}}async focus(A){const x={stack:[],error:void 0,hasError:!1};try{const P=Vo(x,await this.$(A),!1);$(P,`No element found for selector: ${A}`),await P.focus()}catch(P){x.error=P,x.hasError=!0}finally{Wo(x)}}async hover(A){const x={stack:[],error:void 0,hasError:!1};try{const P=Vo(x,await this.$(A),!1);$(P,`No element found for selector: ${A}`),await P.hover()}catch(P){x.error=P,x.hasError=!0}finally{Wo(x)}}async select(A,...x){const P={stack:[],error:void 0,hasError:!1};try{const B=Vo(P,await this.$(A),!1);return $(B,`No element found for selector: ${A}`),await B.select(...x)}catch(B){P.error=B,P.hasError=!0}finally{Wo(P)}}async tap(A){const x={stack:[],error:void 0,hasError:!1};try{const P=Vo(x,await this.$(A),!1);$(P,`No element found for selector: ${A}`),await P.tap()}catch(P){x.error=P,x.hasError=!0}finally{Wo(x)}}async type(A,x,P){const B={stack:[],error:void 0,hasError:!1};try{const J=Vo(B,await this.$(A),!1);$(J,`No element found for selector: ${A}`),await J.type(x,P)}catch(J){B.error=J,B.hasError=!0}finally{Wo(B)}}async title(){return await this.isolatedRealm().evaluate(()=>document.title)}},D=new WeakMap,F=new WeakSet,mn=function(){return n(this,D)||v(this,D,this.mainRealm().evaluateHandle(()=>document)),n(this,D)},(()=>{const A=typeof Symbol=="function"&&Symbol.metadata?Object.create(t[Symbol.metadata]??null):void 0;e=[he],a=[he],i=[he],r=[he],s=[he],l=[he],d=[he],c=[he],u=[he],p=[he],g=[he],m=[he],b=[he],h=[he],E=[he],w=[he],S=[he],C=[he],R=[he],z=[he],Ae(M,null,e,{kind:"method",name:"frameElement",static:!1,private:!1,access:{has:x=>"frameElement"in x,get:x=>x.frameElement},metadata:A},null,o),Ae(M,null,a,{kind:"method",name:"evaluateHandle",static:!1,private:!1,access:{has:x=>"evaluateHandle"in x,get:x=>x.evaluateHandle},metadata:A},null,o),Ae(M,null,i,{kind:"method",name:"evaluate",static:!1,private:!1,access:{has:x=>"evaluate"in x,get:x=>x.evaluate},metadata:A},null,o),Ae(M,null,r,{kind:"method",name:"locator",static:!1,private:!1,access:{has:x=>"locator"in x,get:x=>x.locator},metadata:A},null,o),Ae(M,null,s,{kind:"method",name:"$",static:!1,private:!1,access:{has:x=>"$"in x,get:x=>x.$},metadata:A},null,o),Ae(M,null,l,{kind:"method",name:"$$",static:!1,private:!1,access:{has:x=>"$$"in x,get:x=>x.$$},metadata:A},null,o),Ae(M,null,d,{kind:"method",name:"$eval",static:!1,private:!1,access:{has:x=>"$eval"in x,get:x=>x.$eval},metadata:A},null,o),Ae(M,null,c,{kind:"method",name:"$$eval",static:!1,private:!1,access:{has:x=>"$$eval"in x,get:x=>x.$$eval},metadata:A},null,o),Ae(M,null,u,{kind:"method",name:"waitForSelector",static:!1,private:!1,access:{has:x=>"waitForSelector"in x,get:x=>x.waitForSelector},metadata:A},null,o),Ae(M,null,p,{kind:"method",name:"waitForFunction",static:!1,private:!1,access:{has:x=>"waitForFunction"in x,get:x=>x.waitForFunction},metadata:A},null,o),Ae(M,null,g,{kind:"method",name:"content",static:!1,private:!1,access:{has:x=>"content"in x,get:x=>x.content},metadata:A},null,o),Ae(M,null,m,{kind:"method",name:"addScriptTag",static:!1,private:!1,access:{has:x=>"addScriptTag"in x,get:x=>x.addScriptTag},metadata:A},null,o),Ae(M,null,b,{kind:"method",name:"addStyleTag",static:!1,private:!1,access:{has:x=>"addStyleTag"in x,get:x=>x.addStyleTag},metadata:A},null,o),Ae(M,null,h,{kind:"method",name:"click",static:!1,private:!1,access:{has:x=>"click"in x,get:x=>x.click},metadata:A},null,o),Ae(M,null,E,{kind:"method",name:"focus",static:!1,private:!1,access:{has:x=>"focus"in x,get:x=>x.focus},metadata:A},null,o),Ae(M,null,w,{kind:"method",name:"hover",static:!1,private:!1,access:{has:x=>"hover"in x,get:x=>x.hover},metadata:A},null,o),Ae(M,null,S,{kind:"method",name:"select",static:!1,private:!1,access:{has:x=>"select"in x,get:x=>x.select},metadata:A},null,o),Ae(M,null,C,{kind:"method",name:"tap",static:!1,private:!1,access:{has:x=>"tap"in x,get:x=>x.tap},metadata:A},null,o),Ae(M,null,R,{kind:"method",name:"type",static:!1,private:!1,access:{has:x=>"type"in x,get:x=>x.type},metadata:A},null,o),Ae(M,null,z,{kind:"method",name:"title",static:!1,private:!1,access:{has:x=>"title"in x,get:x=>x.title},metadata:A},null,o),A&&Object.defineProperty(M,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:A})})(),M})();/**
 * @license
 * Copyright 2024 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var ml,gl,ls;class Qb{constructor(o,e,a){f(this,ml);f(this,gl);f(this,ls,new WeakMap);v(this,ml,e),v(this,gl,a),n(this,ls).set(o,e)}get id(){return n(this,ml)}get source(){return n(this,gl)}getIdForFrame(o){return n(this,ls).get(o)}setIdForFrame(o,e){n(this,ls).set(o,e)}}ml=new WeakMap,gl=new WeakMap,ls=new WeakMap;/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class ey{constructor(o,e){O(this,"id");O(this,"name");this.id=o,this.name=e}}var ft,fl,Ii,Si,cs,ds,hl,rp;class ty{constructor(o,e,a){f(this,hl);f(this,ft);f(this,fl);f(this,Ii);f(this,Si,!1);f(this,cs,T(this,hl,rp).bind(this));f(this,ds,new Set);O(this,"devices",[]);v(this,ft,o),v(this,fl,e),v(this,Ii,a.id),n(this,ft).on("DeviceAccess.deviceRequestPrompted",n(this,cs)),n(this,ft).on("Target.detachedFromTarget",()=>{v(this,ft,null)}),T(this,hl,rp).call(this,a)}async waitForDevice(o,e={}){for(const s of this.devices)if(o(s))return s;const{timeout:a=n(this,fl).timeout()}=e,i=me.create({message:`Waiting for \`DeviceRequestPromptDevice\` failed: ${a}ms exceeded`,timeout:a}),r={filter:o,promise:i};n(this,ds).add(r);try{return await i.valueOrThrow()}finally{n(this,ds).delete(r)}}async select(o){return $(n(this,ft)!==null,"Cannot select device through detached session!"),$(this.devices.includes(o),"Cannot select unknown device!"),$(!n(this,Si),"Cannot select DeviceRequestPrompt which is already handled!"),n(this,ft).off("DeviceAccess.deviceRequestPrompted",n(this,cs)),v(this,Si,!0),await n(this,ft).send("DeviceAccess.selectPrompt",{id:n(this,Ii),deviceId:o.id})}async cancel(){return $(n(this,ft)!==null,"Cannot cancel prompt through detached session!"),$(!n(this,Si),"Cannot cancel DeviceRequestPrompt which is already handled!"),n(this,ft).off("DeviceAccess.deviceRequestPrompted",n(this,cs)),v(this,Si,!0),await n(this,ft).send("DeviceAccess.cancelPrompt",{id:n(this,Ii)})}}ft=new WeakMap,fl=new WeakMap,Ii=new WeakMap,Si=new WeakMap,cs=new WeakMap,ds=new WeakMap,hl=new WeakSet,rp=function(o){if(o.id===n(this,Ii))for(const e of o.devices){if(this.devices.some(i=>i.id===e.id))continue;const a=new ey(e.id,e.name);this.devices.push(a);for(const i of n(this,ds))i.filter(a)&&i.promise.resolve(a)}};var zt,us,To,Wd,Jf;class oy{constructor(o,e){f(this,Wd);f(this,zt);f(this,us);f(this,To,new Set);v(this,zt,o),v(this,us,e),n(this,zt).on("DeviceAccess.deviceRequestPrompted",a=>{T(this,Wd,Jf).call(this,a)}),n(this,zt).on("Target.detachedFromTarget",()=>{v(this,zt,null)})}async waitForDevicePrompt(o={}){$(n(this,zt)!==null,"Cannot wait for device prompt through detached session!");const e=n(this,To).size===0;let a;e&&(a=n(this,zt).send("DeviceAccess.enable"));const{timeout:i=n(this,us).timeout()}=o,r=me.create({message:`Waiting for \`DeviceRequestPrompt\` failed: ${i}ms exceeded`,timeout:i});n(this,To).add(r);try{const[s]=await Promise.all([r.valueOrThrow(),a]);return s}finally{n(this,To).delete(r)}}}zt=new WeakMap,us=new WeakMap,To=new WeakMap,Wd=new WeakSet,Jf=function(o){if(!n(this,To).size)return;$(n(this,zt)!==null);const e=new ty(n(this,zt),n(this,us),o);for(const a of n(this,To))a.resolve(e);n(this,To).clear()};/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var ay=function(t,o,e){for(var a=arguments.length>2,i=0;i<o.length;i++)e=a?o[i].call(t,e):o[i].call(t);return a?e:void 0},le=function(t,o,e,a,i,r){function s(w){if(w!==void 0&&typeof w!="function")throw new TypeError("Function expected");return w}for(var l=a.kind,d=l==="getter"?"get":l==="setter"?"set":"value",c=!o&&t?a.static?t:t.prototype:null,u=o||(c?Object.getOwnPropertyDescriptor(c,a.name):{}),p,g=!1,m=e.length-1;m>=0;m--){var b={};for(var h in a)b[h]=h==="access"?{}:a[h];for(var h in a.access)b.access[h]=a.access[h];b.addInitializer=function(w){if(g)throw new TypeError("Cannot add initializers after decoration has completed");r.push(s(w||null))};var E=(0,e[m])(l==="accessor"?{get:u.get,set:u.set}:u[d],b);if(l==="accessor"){if(E===void 0)continue;if(E===null||typeof E!="object")throw new TypeError("Object expected");(p=s(E.get))&&(u.get=p),(p=s(E.set))&&(u.set=p),(p=s(E.init))&&i.unshift(p)}else(p=s(E))&&(l==="field"?i.unshift(p):u[d]=p)}c&&Object.defineProperty(c,a.name,u),g=!0},ln=function(t,o,e){if(o!=null){if(typeof o!="object"&&typeof o!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=o[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=o[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");t.stack.push({value:o,dispose:a,async:e})}else e&&t.stack.push({async:!0});return o},cn=(function(t){return function(o){function e(i){o.error=o.hasError?new t(i,o.error,"An error was suppressed during disposal."):i,o.hasError=!0}function a(){for(;o.stack.length;){var i=o.stack.pop();try{var r=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(r).then(a,function(s){return e(s),a()})}catch(s){e(s)}}if(o.hasError)throw o.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(t,o,e){var a=new Error(e);return a.name="SuppressedError",a.error=t,a.suppressed=o,a}),iy=function(t,o,e){return typeof o=="symbol"&&(o=o.description?"[".concat(o.description,"]"):""),Object.defineProperty(t,"name",{configurable:!0,value:e?"".concat(e," ",o):o})};let Su=(()=>{var re,sp,np,lp,Qf,cp,dp,eh,th,oh,V;var t,o,e,a,i,r,s,l,d,c,u,p,g,m,b,h,E,w,S,C,R,z,D,F,L,M,j,N,A,x;let P=Tr,B=[],J,ae,ie,Z,H,We,Se,ut,Je,Ft,pt,$o,fe,no,Ge,Q,lo,W,k,Y,ye,$t,nr,lr,cr,dr,ur,Uo,kc,Fc,$c,mu;return V=class extends P{constructor(_){super();f(this,re);O(this,"isolatedHandle",ay(this,B));O(this,"handle");this.handle=_,this[rd]=!0}static bindIsolatedHandle(_,y){return async function(...K){if(this.realm===this.frame.isolatedRealm())return await _.call(this,...K);let G;this.isolatedHandle?G=this.isolatedHandle:this.isolatedHandle=G=await this.frame.isolatedRealm().adoptHandle(this);const q=await _.call(G,...K);return q===G?this:q instanceof Tr?await this.realm.transferHandle(q):(Array.isArray(q)&&await Promise.all(q.map(async(ee,de,Be)=>{ee instanceof Tr&&(Be[de]=await this.realm.transferHandle(ee))})),q instanceof Map&&await Promise.all([...q.entries()].map(async([ee,de])=>{de instanceof Tr&&q.set(ee,await this.realm.transferHandle(de))})),q)}}get id(){return this.handle.id}get disposed(){return this.handle.disposed}async getProperty(_){return await this.handle.getProperty(_)}async getProperties(){return await this.handle.getProperties()}async evaluate(_,...y){return _=Ne(this.evaluate.name,_),await this.handle.evaluate(_,...y)}async evaluateHandle(_,...y){return _=Ne(this.evaluateHandle.name,_),await this.handle.evaluateHandle(_,...y)}async jsonValue(){return await this.handle.jsonValue()}toString(){return this.handle.toString()}remoteObject(){return this.handle.remoteObject()}dispose(){return this.handle.dispose()}asElement(){return this}async $(_){const{updatedSelector:y,QueryHandler:K}=cd(_);return await K.queryOne(this,y)}async $$(_,y){return(y==null?void 0:y.isolate)===!1?await T(this,re,np).call(this,_):await n(this,re,sp).call(this,_)}async $eval(_,y,...K){const G={stack:[],error:void 0,hasError:!1};try{y=Ne(this.$eval.name,y);const q=ln(G,await this.$(_),!1);if(!q)throw new Error(`Error: failed to find element matching selector "${_}"`);return await q.evaluate(y,...K)}catch(q){G.error=q,G.hasError=!0}finally{cn(G)}}async $$eval(_,y,...K){const G={stack:[],error:void 0,hasError:!1};try{y=Ne(this.$$eval.name,y);const q=await this.$$(_),ee=ln(G,await this.evaluateHandle((Be,...ke)=>ke,...q),!1),[de]=await Promise.all([ee.evaluate(y,...K),...q.map(Be=>Be.dispose())]);return de}catch(q){G.error=q,G.hasError=!0}finally{cn(G)}}async waitForSelector(_,y={}){const{updatedSelector:K,QueryHandler:G,polling:q}=cd(_);return await G.waitFor(this,K,{polling:q,...y})}async isVisible(){return await T(this,re,lp).call(this,!0)}async isHidden(){return await T(this,re,lp).call(this,!1)}async toElement(_){if(!await this.evaluate((K,G)=>K.nodeName===G.toUpperCase(),_))throw new Error(`Element is not a(n) \`${_}\` element`);return this}async clickablePoint(_){const y=await T(this,re,Qf).call(this);if(!y)throw new Error("Node is either not clickable or not an Element");return _!==void 0?{x:y.x+_.x,y:y.y+_.y}:{x:y.x+y.width/2,y:y.y+y.height/2}}async hover(){await this.scrollIntoViewIfNeeded();const{x:_,y}=await this.clickablePoint();await this.frame.page().mouse.move(_,y)}async click(_={}){await this.scrollIntoViewIfNeeded();const{x:y,y:K}=await this.clickablePoint(_.offset);await this.frame.page().mouse.click(y,K,_)}async drag(_){await this.scrollIntoViewIfNeeded();const y=this.frame.page();if(y.isDragInterceptionEnabled()){const K=await this.clickablePoint();return _ instanceof V&&(_=await _.clickablePoint()),await y.mouse.drag(K,_)}try{y._isDragging||(y._isDragging=!0,await this.hover(),await y.mouse.down()),_ instanceof V?await _.hover():await y.mouse.move(_.x,_.y)}catch(K){throw y._isDragging=!1,K}}async dragEnter(_={items:[],dragOperationsMask:1}){const y=this.frame.page();await this.scrollIntoViewIfNeeded();const K=await this.clickablePoint();await y.mouse.dragEnter(K,_)}async dragOver(_={items:[],dragOperationsMask:1}){const y=this.frame.page();await this.scrollIntoViewIfNeeded();const K=await this.clickablePoint();await y.mouse.dragOver(K,_)}async drop(_={items:[],dragOperationsMask:1}){const y=this.frame.page();if("items"in _){await this.scrollIntoViewIfNeeded();const K=await this.clickablePoint();await y.mouse.drop(K,_)}else await _.drag(this),y._isDragging=!1,await y.mouse.up()}async dragAndDrop(_,y){const K=this.frame.page();$(K.isDragInterceptionEnabled(),"Drag Interception is not enabled!"),await this.scrollIntoViewIfNeeded();const G=await this.clickablePoint(),q=await _.clickablePoint();await K.mouse.dragAndDrop(G,q,y)}async select(..._){for(const y of _)$(rr(y),'Values must be strings. Found value "'+y+'" of type "'+typeof y+'"');return await this.evaluate((y,K)=>{const G=new Set(K);if(!(y instanceof HTMLSelectElement))throw new Error("Element is not a <select> element.");const q=new Set;if(y.multiple)for(const ee of y.options)ee.selected=G.has(ee.value),ee.selected&&q.add(ee.value);else{for(const ee of y.options)ee.selected=!1;for(const ee of y.options)if(G.has(ee.value)){ee.selected=!0,q.add(ee.value);break}}return y.dispatchEvent(new Event("input",{bubbles:!0})),y.dispatchEvent(new Event("change",{bubbles:!0})),[...q.values()]},_)}async tap(){await this.scrollIntoViewIfNeeded();const{x:_,y}=await this.clickablePoint();await this.frame.page().touchscreen.tap(_,y)}async touchStart(){await this.scrollIntoViewIfNeeded();const{x:_,y}=await this.clickablePoint();await this.frame.page().touchscreen.touchStart(_,y)}async touchMove(){await this.scrollIntoViewIfNeeded();const{x:_,y}=await this.clickablePoint();await this.frame.page().touchscreen.touchMove(_,y)}async touchEnd(){await this.scrollIntoViewIfNeeded(),await this.frame.page().touchscreen.touchEnd()}async focus(){await this.evaluate(_=>{if(!(_ instanceof HTMLElement))throw new Error("Cannot focus non-HTMLElement");return _.focus()})}async type(_,y){await this.focus(),await this.frame.page().keyboard.type(_,y)}async press(_,y){await this.focus(),await this.frame.page().keyboard.press(_,y)}async boundingBox(){const _=await this.evaluate(K=>{if(!(K instanceof Element)||K.getClientRects().length===0)return null;const G=K.getBoundingClientRect();return{x:G.x,y:G.y,width:G.width,height:G.height}});if(!_)return null;const y=await T(this,re,dp).call(this);return y?{x:_.x+y.x,y:_.y+y.y,height:_.height,width:_.width}:null}async boxModel(){const _=await this.evaluate(K=>{if(!(K instanceof Element)||K.getClientRects().length===0)return null;const G=K.getBoundingClientRect(),q=window.getComputedStyle(K),ee={padding:{left:parseInt(q.paddingLeft,10),top:parseInt(q.paddingTop,10),right:parseInt(q.paddingRight,10),bottom:parseInt(q.paddingBottom,10)},margin:{left:-parseInt(q.marginLeft,10),top:-parseInt(q.marginTop,10),right:-parseInt(q.marginRight,10),bottom:-parseInt(q.marginBottom,10)},border:{left:parseInt(q.borderLeft,10),top:parseInt(q.borderTop,10),right:parseInt(q.borderRight,10),bottom:parseInt(q.borderBottom,10)}},de=[{x:G.left,y:G.top},{x:G.left+G.width,y:G.top},{x:G.left+G.width,y:G.top+G.bottom},{x:G.left,y:G.top+G.bottom}],Be=Ut(de,ee.border),ke=Ut(Be,ee.padding),Fa=Ut(de,ee.margin);return{content:ke,padding:Be,border:de,margin:Fa,width:G.width,height:G.height};function Ut(jo,Ho){return[{x:jo[0].x+Ho.left,y:jo[0].y+Ho.top},{x:jo[1].x-Ho.right,y:jo[1].y+Ho.top},{x:jo[2].x-Ho.right,y:jo[2].y-Ho.bottom},{x:jo[3].x+Ho.left,y:jo[3].y-Ho.bottom}]}});if(!_)return null;const y=await T(this,re,dp).call(this);if(!y)return null;for(const K of["content","padding","border","margin"])for(const G of _[K])G.x+=y.x,G.y+=y.y;return _}async screenshot(_={}){const{scrollIntoView:y=!0,clip:K}=_,G=this.frame.page();y&&await this.scrollIntoViewIfNeeded();const q=await T(this,re,eh).call(this),[ee,de]=await this.evaluate(()=>{if(!window.visualViewport)throw new Error("window.visualViewport is not supported.");return[window.visualViewport.pageLeft,window.visualViewport.pageTop]});return q.x+=ee,q.y+=de,K&&(q.x+=K.x,q.y+=K.y,q.height=K.height,q.width=K.width),await G.screenshot({..._,clip:q})}async assertConnectedElement(){const _=await this.evaluate(async y=>{if(!y.isConnected)return"Node is detached from document";if(y.nodeType!==Node.ELEMENT_NODE)return"Node is not of type HTMLElement"});if(_)throw new Error(_)}async scrollIntoViewIfNeeded(){await this.isIntersectingViewport({threshold:1})||await this.scrollIntoView()}async isIntersectingViewport(_={}){var K;const y={stack:[],error:void 0,hasError:!1};try{await this.assertConnectedElement();const G=await T(this,re,th).call(this);return await(ln(y,G&&await T(K=G,re,oh).call(K),!1)??this).evaluate(async(ee,de)=>{const Be=await new Promise(ke=>{const Fa=new IntersectionObserver(Ut=>{ke(Ut[0].intersectionRatio),Fa.disconnect()});Fa.observe(ee)});return de===1?Be===1:Be>de},_.threshold??0)}catch(G){y.error=G,y.hasError=!0}finally{cn(y)}}async scrollIntoView(){await this.assertConnectedElement(),await this.evaluate(async _=>{_.scrollIntoView({block:"center",inline:"center",behavior:"instant"})})}},re=new WeakSet,sp=function(){return Se.value},np=async function(_){const{updatedSelector:y,QueryHandler:K}=cd(_);return await lu.collect(K.queryAll(this,y))},lp=async function(_){return await this.evaluate(async(y,K,G)=>!!K.checkVisibility(y,G),ao.create(y=>y.puppeteerUtil),_)},Qf=async function(){var q;const _=await this.evaluate(ee=>ee instanceof Element?[...ee.getClientRects()].map(de=>({x:de.x,y:de.y,width:de.width,height:de.height})):null);if(!(_!=null&&_.length))return null;await T(this,re,cp).call(this,_);let y=this.frame,K;for(;K=y==null?void 0:y.parentFrame();){const ee={stack:[],error:void 0,hasError:!1};try{const de=ln(ee,await y.frameElement(),!1);if(!de)throw new Error("Unsupported frame type");const Be=await de.evaluate(ke=>{if(ke.getClientRects().length===0)return null;const Fa=ke.getBoundingClientRect(),Ut=window.getComputedStyle(ke);return{left:Fa.left+parseInt(Ut.paddingLeft,10)+parseInt(Ut.borderLeftWidth,10),top:Fa.top+parseInt(Ut.paddingTop,10)+parseInt(Ut.borderTopWidth,10)}});if(!Be)return null;for(const ke of _)ke.x+=Be.left,ke.y+=Be.top;await T(q=de,re,cp).call(q,_),y=K}catch(de){ee.error=de,ee.hasError=!0}finally{cn(ee)}}const G=_.find(ee=>ee.width>=1&&ee.height>=1);return G?{x:G.x,y:G.y,height:G.height,width:G.width}:null},cp=async function(_){const{documentWidth:y,documentHeight:K}=await this.frame.isolatedRealm().evaluate(()=>({documentWidth:document.documentElement.clientWidth,documentHeight:document.documentElement.clientHeight}));for(const G of _)ry(G,y,K)},dp=async function(){const _={x:0,y:0};let y=this.frame,K;for(;K=y==null?void 0:y.parentFrame();){const G={stack:[],error:void 0,hasError:!1};try{const q=ln(G,await y.frameElement(),!1);if(!q)throw new Error("Unsupported frame type");const ee=await q.evaluate(de=>{if(de.getClientRects().length===0)return null;const Be=de.getBoundingClientRect(),ke=window.getComputedStyle(de);return{left:Be.left+parseInt(ke.paddingLeft,10)+parseInt(ke.borderLeftWidth,10),top:Be.top+parseInt(ke.paddingTop,10)+parseInt(ke.borderTopWidth,10)}});if(!ee)return null;_.x+=ee.left,_.y+=ee.top,y=K}catch(q){G.error=q,G.hasError=!0}finally{cn(G)}}return _},eh=async function(){const _=await this.boundingBox();return $(_,"Node is either not visible or not an HTMLElement"),$(_.width!==0,"Node has 0 width."),$(_.height!==0,"Node has 0 height."),_},th=async function(){return await this.evaluate(_=>_ instanceof SVGElement)?this:null},oh=async function(){return await this.evaluateHandle(_=>_ instanceof SVGSVGElement?_:_.ownerSVGElement)},(()=>{const _=typeof Symbol=="function"&&Symbol.metadata?Object.create(P[Symbol.metadata]??null):void 0;J=[oe(),(t=V).bindIsolatedHandle.bind(t)],ae=[oe(),(o=V).bindIsolatedHandle.bind(o)],ie=[oe(),(e=V).bindIsolatedHandle.bind(e)],Z=[oe(),(a=V).bindIsolatedHandle.bind(a)],H=[oe()],We=[(i=V).bindIsolatedHandle.bind(i)],ut=[oe(),(r=V).bindIsolatedHandle.bind(r)],Je=[oe(),(s=V).bindIsolatedHandle.bind(s)],Ft=[oe(),(l=V).bindIsolatedHandle.bind(l)],pt=[oe(),(d=V).bindIsolatedHandle.bind(d)],$o=[oe(),(c=V).bindIsolatedHandle.bind(c)],fe=[oe(),(u=V).bindIsolatedHandle.bind(u)],no=[oe(),(p=V).bindIsolatedHandle.bind(p)],Ge=[oe(),(g=V).bindIsolatedHandle.bind(g)],Q=[oe(),(m=V).bindIsolatedHandle.bind(m)],lo=[oe(),(b=V).bindIsolatedHandle.bind(b)],W=[oe(),(h=V).bindIsolatedHandle.bind(h)],k=[oe(),(E=V).bindIsolatedHandle.bind(E)],Y=[oe(),(w=V).bindIsolatedHandle.bind(w)],ye=[oe(),(S=V).bindIsolatedHandle.bind(S)],$t=[oe(),(C=V).bindIsolatedHandle.bind(C)],nr=[oe(),(R=V).bindIsolatedHandle.bind(R)],lr=[oe(),(z=V).bindIsolatedHandle.bind(z)],cr=[oe(),(D=V).bindIsolatedHandle.bind(D)],dr=[oe(),(F=V).bindIsolatedHandle.bind(F)],ur=[oe(),(L=V).bindIsolatedHandle.bind(L)],Uo=[oe(),(M=V).bindIsolatedHandle.bind(M)],kc=[oe(),(j=V).bindIsolatedHandle.bind(j)],Fc=[oe(),(N=V).bindIsolatedHandle.bind(N)],$c=[oe(),(A=V).bindIsolatedHandle.bind(A)],mu=[oe(),(x=V).bindIsolatedHandle.bind(x)],le(V,null,J,{kind:"method",name:"getProperty",static:!1,private:!1,access:{has:y=>"getProperty"in y,get:y=>y.getProperty},metadata:_},null,B),le(V,null,ae,{kind:"method",name:"getProperties",static:!1,private:!1,access:{has:y=>"getProperties"in y,get:y=>y.getProperties},metadata:_},null,B),le(V,null,ie,{kind:"method",name:"jsonValue",static:!1,private:!1,access:{has:y=>"jsonValue"in y,get:y=>y.jsonValue},metadata:_},null,B),le(V,null,Z,{kind:"method",name:"$",static:!1,private:!1,access:{has:y=>"$"in y,get:y=>y.$},metadata:_},null,B),le(V,null,H,{kind:"method",name:"$$",static:!1,private:!1,access:{has:y=>"$$"in y,get:y=>y.$$},metadata:_},null,B),le(V,Se={value:iy(async function(y){return await T(this,re,np).call(this,y)},"#$$")},We,{kind:"method",name:"#$$",static:!1,private:!0,access:{has:y=>yt(re,y),get:y=>n(y,re,sp)},metadata:_},null,B),le(V,null,ut,{kind:"method",name:"waitForSelector",static:!1,private:!1,access:{has:y=>"waitForSelector"in y,get:y=>y.waitForSelector},metadata:_},null,B),le(V,null,Je,{kind:"method",name:"isVisible",static:!1,private:!1,access:{has:y=>"isVisible"in y,get:y=>y.isVisible},metadata:_},null,B),le(V,null,Ft,{kind:"method",name:"isHidden",static:!1,private:!1,access:{has:y=>"isHidden"in y,get:y=>y.isHidden},metadata:_},null,B),le(V,null,pt,{kind:"method",name:"toElement",static:!1,private:!1,access:{has:y=>"toElement"in y,get:y=>y.toElement},metadata:_},null,B),le(V,null,$o,{kind:"method",name:"clickablePoint",static:!1,private:!1,access:{has:y=>"clickablePoint"in y,get:y=>y.clickablePoint},metadata:_},null,B),le(V,null,fe,{kind:"method",name:"hover",static:!1,private:!1,access:{has:y=>"hover"in y,get:y=>y.hover},metadata:_},null,B),le(V,null,no,{kind:"method",name:"click",static:!1,private:!1,access:{has:y=>"click"in y,get:y=>y.click},metadata:_},null,B),le(V,null,Ge,{kind:"method",name:"drag",static:!1,private:!1,access:{has:y=>"drag"in y,get:y=>y.drag},metadata:_},null,B),le(V,null,Q,{kind:"method",name:"dragEnter",static:!1,private:!1,access:{has:y=>"dragEnter"in y,get:y=>y.dragEnter},metadata:_},null,B),le(V,null,lo,{kind:"method",name:"dragOver",static:!1,private:!1,access:{has:y=>"dragOver"in y,get:y=>y.dragOver},metadata:_},null,B),le(V,null,W,{kind:"method",name:"drop",static:!1,private:!1,access:{has:y=>"drop"in y,get:y=>y.drop},metadata:_},null,B),le(V,null,k,{kind:"method",name:"dragAndDrop",static:!1,private:!1,access:{has:y=>"dragAndDrop"in y,get:y=>y.dragAndDrop},metadata:_},null,B),le(V,null,Y,{kind:"method",name:"select",static:!1,private:!1,access:{has:y=>"select"in y,get:y=>y.select},metadata:_},null,B),le(V,null,ye,{kind:"method",name:"tap",static:!1,private:!1,access:{has:y=>"tap"in y,get:y=>y.tap},metadata:_},null,B),le(V,null,$t,{kind:"method",name:"touchStart",static:!1,private:!1,access:{has:y=>"touchStart"in y,get:y=>y.touchStart},metadata:_},null,B),le(V,null,nr,{kind:"method",name:"touchMove",static:!1,private:!1,access:{has:y=>"touchMove"in y,get:y=>y.touchMove},metadata:_},null,B),le(V,null,lr,{kind:"method",name:"touchEnd",static:!1,private:!1,access:{has:y=>"touchEnd"in y,get:y=>y.touchEnd},metadata:_},null,B),le(V,null,cr,{kind:"method",name:"focus",static:!1,private:!1,access:{has:y=>"focus"in y,get:y=>y.focus},metadata:_},null,B),le(V,null,dr,{kind:"method",name:"type",static:!1,private:!1,access:{has:y=>"type"in y,get:y=>y.type},metadata:_},null,B),le(V,null,ur,{kind:"method",name:"press",static:!1,private:!1,access:{has:y=>"press"in y,get:y=>y.press},metadata:_},null,B),le(V,null,Uo,{kind:"method",name:"boundingBox",static:!1,private:!1,access:{has:y=>"boundingBox"in y,get:y=>y.boundingBox},metadata:_},null,B),le(V,null,kc,{kind:"method",name:"boxModel",static:!1,private:!1,access:{has:y=>"boxModel"in y,get:y=>y.boxModel},metadata:_},null,B),le(V,null,Fc,{kind:"method",name:"screenshot",static:!1,private:!1,access:{has:y=>"screenshot"in y,get:y=>y.screenshot},metadata:_},null,B),le(V,null,$c,{kind:"method",name:"isIntersectingViewport",static:!1,private:!1,access:{has:y=>"isIntersectingViewport"in y,get:y=>y.isIntersectingViewport},metadata:_},null,B),le(V,null,mu,{kind:"method",name:"scrollIntoView",static:!1,private:!1,access:{has:y=>"scrollIntoView"in y,get:y=>y.scrollIntoView},metadata:_},null,B),_&&Object.defineProperty(V,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:_})})(),V})();function ry(t,o,e){t.width=Math.max(t.x>=0?Math.min(o-t.x,t.width):Math.min(o,t.width+t.x),0),t.height=Math.max(t.y>=0?Math.min(e-t.y,t.height):Math.min(e,t.height+t.y),0)}/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */function Nm(t){let o,e;if(!t.exception)o="Error",e=t.text;else{if((t.exception.type!=="object"||t.exception.subtype!=="error")&&!t.exception.objectId)return or(t.exception);{const l=ah(t);o=l.name,e=l.message}}const a=e.split(`
`).length,i=new Error(e);i.name=o;const r=i.stack.split(`
`),s=r.splice(0,a);if(r.shift(),t.stackTrace&&r.length<Error.stackTraceLimit)for(const l of t.stackTrace.callFrames.reverse()){if(Mo.isPuppeteerURL(l.url)&&l.url!==Mo.INTERNAL_URL){const d=Mo.parse(l.url);r.unshift(`    at ${l.functionName||d.functionName} (${d.functionName} at ${d.siteString}, <anonymous>:${l.lineNumber}:${l.columnNumber})`)}else r.push(`    at ${l.functionName||"<anonymous>"} (${l.url}:${l.lineNumber}:${l.columnNumber})`);if(r.length>=Error.stackTraceLimit)break}return i.stack=[...s,...r].join(`
`),i}const ah=t=>{var r,s,l,d;let o="",e;const a=((s=(r=t.exception)==null?void 0:r.description)==null?void 0:s.split(`
    at `))??[],i=Math.min(((l=t.stackTrace)==null?void 0:l.callFrames.length)??0,a.length-1);return a.splice(-i,i),(d=t.exception)!=null&&d.className&&(o=t.exception.className),e=a.join(`
`),o&&e.startsWith(`${o}: `)&&(e=e.slice(o.length+2)),{message:e,name:o}};function sy(t){let o,e;if(!t.exception)o="Error",e=t.text;else{if((t.exception.type!=="object"||t.exception.subtype!=="error")&&!t.exception.objectId)return or(t.exception);{const l=ah(t);o=l.name,e=l.message}}const a=new Error(e);a.name=o;const i=a.message.split(`
`).length,r=a.stack.split(`
`).splice(0,i),s=[];if(t.stackTrace){for(const l of t.stackTrace.callFrames)if(s.push(`    at ${l.functionName||"<anonymous>"} (${l.url}:${l.lineNumber+1}:${l.columnNumber+1})`),s.length>=Error.stackTraceLimit)break}return a.stack=[...r,...s].join(`
`),a}function or(t){if($(!t.objectId,"Cannot extract value when objectId is given"),t.unserializableValue){if(t.type==="bigint")return BigInt(t.unserializableValue.replace("n",""));switch(t.unserializableValue){case"-0":return-0;case"NaN":return NaN;case"Infinity":return 1/0;case"-Infinity":return-1/0;default:throw new Error("Unsupported unserializable value: "+t.unserializableValue)}}return t.value}function ih(t,o,e){globalThis[o]||Object.assign(globalThis,{[o](...a){const i=globalThis[o];i.args??(i.args=new Map),i.callbacks??(i.callbacks=new Map);const r=(i.lastSeq??0)+1;return i.lastSeq=r,i.args.set(r,a),globalThis[e+o](JSON.stringify({type:t,name:o,seq:r,args:a,isTrivial:!a.some(s=>s instanceof Node)})),new Promise((s,l)=>{i.callbacks.set(r,{resolve(d){i.args.delete(r),s(d)},reject(d){i.args.delete(r),l(d)}})})}})}const xr="puppeteer_";function ny(t,o){return Df(ih,t,o,xr)}/**
 * @license
 * Copyright 2019 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var ps,rt,ms;class cu extends Tr{constructor(e,a){super();f(this,ps,!1);f(this,rt);f(this,ms);v(this,ms,e),v(this,rt,a)}get disposed(){return n(this,ps)}get realm(){return n(this,ms)}get client(){return this.realm.environment.client}async jsonValue(){if(!n(this,rt).objectId)return or(n(this,rt));const e=await this.evaluate(a=>a);if(e===void 0)throw new Error("Could not serialize referenced object");return e}asElement(){return null}async dispose(){n(this,ps)||(v(this,ps,!0),await rh(this.client,n(this,rt)))}toString(){return n(this,rt).objectId?"JSHandle@"+(n(this,rt).subtype||n(this,rt).type):"JSHandle:"+or(n(this,rt))}get id(){return n(this,rt).objectId}remoteObject(){return n(this,rt)}async getProperties(){const e=await this.client.send("Runtime.getProperties",{objectId:n(this,rt).objectId,ownProperties:!0}),a=new Map;for(const i of e.result)!i.enumerable||!i.value||a.set(i.name,n(this,ms).createCdpHandle(i.value));return a}}ps=new WeakMap,rt=new WeakMap,ms=new WeakMap;async function rh(t,o){o.objectId&&await t.send("Runtime.releaseObject",{objectId:o.objectId}).catch(e=>{X(e)})}/**
 * @license
 * Copyright 2019 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var ly=function(t,o,e){for(var a=arguments.length>2,i=0;i<o.length;i++)e=a?o[i].call(t,e):o[i].call(t);return a?e:void 0},Kc=function(t,o,e,a,i,r){function s(w){if(w!==void 0&&typeof w!="function")throw new TypeError("Function expected");return w}for(var l=a.kind,d=l==="getter"?"get":l==="setter"?"set":"value",c=!o&&t?a.static?t:t.prototype:null,u=o||(c?Object.getOwnPropertyDescriptor(c,a.name):{}),p,g=!1,m=e.length-1;m>=0;m--){var b={};for(var h in a)b[h]=h==="access"?{}:a[h];for(var h in a.access)b.access[h]=a.access[h];b.addInitializer=function(w){if(g)throw new TypeError("Cannot add initializers after decoration has completed");r.push(s(w||null))};var E=(0,e[m])(l==="accessor"?{get:u.get,set:u.set}:u[d],b);if(l==="accessor"){if(E===void 0)continue;if(E===null||typeof E!="object")throw new TypeError("Object expected");(p=s(E.get))&&(u.get=p),(p=s(E.set))&&(u.set=p),(p=s(E.init))&&i.unshift(p)}else(p=s(E))&&(l==="field"?i.unshift(p):u[d]=p)}c&&Object.defineProperty(c,a.name,u),g=!0};const cy=new Set(["StaticText","InlineTextBox"]);let sh=(()=>{var d,nh,u;var t,o;let e=Su,a=[],i,r,s,l;return u=class extends e{constructor(m,b){super(new cu(m,b));f(this,d);ly(this,a)}get realm(){return this.handle.realm}get client(){return this.handle.client}remoteObject(){return this.handle.remoteObject()}get frame(){return this.realm.environment}async contentFrame(){const m=await this.client.send("DOM.describeNode",{objectId:this.id});return typeof m.node.frameId!="string"?null:n(this,d,nh).frame(m.node.frameId)}async scrollIntoView(){await this.assertConnectedElement();try{await this.client.send("DOM.scrollIntoViewIfNeeded",{objectId:this.id})}catch(m){X(m),await super.scrollIntoView()}}async uploadFile(...m){const b=await this.evaluate(S=>S.multiple);$(m.length<=1||b,"Multiple file uploads only work with <input type=file multiple>");let h;try{h=await import("path")}catch(S){throw S instanceof TypeError?new Error("JSHandle#uploadFile can only be used in Node-like environments."):S}const E=m.map(S=>h.win32.isAbsolute(S)||h.posix.isAbsolute(S)?S:h.resolve(S));if(E.length===0){await this.evaluate(S=>{S.files=new DataTransfer().files,S.dispatchEvent(new Event("input",{bubbles:!0,composed:!0})),S.dispatchEvent(new Event("change",{bubbles:!0}))});return}const{node:{backendNodeId:w}}=await this.client.send("DOM.describeNode",{objectId:this.id});await this.client.send("DOM.setFileInputFiles",{objectId:this.id,files:E,backendNodeId:w})}async autofill(m){const h=(await this.client.send("DOM.describeNode",{objectId:this.handle.id})).node.backendNodeId,E=this.frame._id;await this.client.send("Autofill.trigger",{fieldId:h,frameId:E,card:m.creditCard})}async*queryAXTree(m,b){const{nodes:h}=await this.client.send("Accessibility.queryAXTree",{objectId:this.id,accessibleName:m,role:b}),E=h.filter(w=>!(w.ignored||!w.role||cy.has(w.role.value)));return yield*lu.map(E,w=>this.realm.adoptBackendNode(w.backendDOMNodeId))}},d=new WeakSet,nh=function(){return this.frame._frameManager},(()=>{const m=typeof Symbol=="function"&&Symbol.metadata?Object.create(e[Symbol.metadata]??null):void 0;i=[oe()],r=[oe(),(t=Su).bindIsolatedHandle.bind(t)],s=[oe(),(o=Su).bindIsolatedHandle.bind(o)],l=[oe()],Kc(u,null,i,{kind:"method",name:"contentFrame",static:!1,private:!1,access:{has:b=>"contentFrame"in b,get:b=>b.contentFrame},metadata:m},null,a),Kc(u,null,r,{kind:"method",name:"scrollIntoView",static:!1,private:!1,access:{has:b=>"scrollIntoView"in b,get:b=>b.scrollIntoView},metadata:m},null,a),Kc(u,null,s,{kind:"method",name:"uploadFile",static:!1,private:!1,access:{has:b=>"uploadFile"in b,get:b=>b.uploadFile},metadata:m},null,a),Kc(u,null,l,{kind:"method",name:"autofill",static:!1,private:!1,access:{has:b=>"autofill"in b,get:b=>b.autofill},metadata:m},null,a),m&&Object.defineProperty(u,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:m})})(),u})();/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var dy=function(t,o,e){if(o!=null){if(typeof o!="object"&&typeof o!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=o[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=o[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");t.stack.push({value:o,dispose:a,async:e})}else e&&t.stack.push({async:!0});return o},uy=(function(t){return function(o){function e(i){o.error=o.hasError?new t(i,o.error,"An error was suppressed during disposal."):i,o.hasError=!0}function a(){for(;o.stack.length;){var i=o.stack.pop();try{var r=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(r).then(a,function(s){return e(s),a()})}catch(s){e(s)}}if(o.hasError)throw o.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(t,o,e){var a=new Error(e);return a.name="SuppressedError",a.error=t,a.suppressed=o,a});const py=new _d("__ariaQuerySelector",xn.queryOne,""),my=new _d("__ariaQuerySelectorAll",(async(t,o)=>{const e=xn.queryAll(t,o);return await t.realm.evaluateHandle((...a)=>a,...await lu.collect(e))}),"");var na,Ai,Lt,gs,vl,xi,Gd,ct,ch,dh,uh,El,la,up,pp;class lh extends Ie{constructor(e,a,i){super();f(this,ct);f(this,na);f(this,Ai);f(this,Lt);f(this,gs);f(this,vl,new zo);f(this,xi,new Map);f(this,Gd,new An);f(this,El,!1);f(this,la);v(this,na,e),v(this,Ai,i),v(this,Lt,a.id),a.name&&v(this,gs,a.name);const r=n(this,vl).use(new Ie(n(this,na)));r.on("Runtime.bindingCalled",T(this,ct,dh).bind(this)),r.on("Runtime.executionContextDestroyed",async s=>{s.executionContextId===n(this,Lt)&&this[ge]()}),r.on("Runtime.executionContextsCleared",async()=>{this[ge]()}),r.on("Runtime.consoleAPICalled",T(this,ct,uh).bind(this)),r.on(ve.Disconnected,()=>{this[ge]()})}get id(){return n(this,Lt)}get puppeteerUtil(){let e=Promise.resolve();return n(this,El)||(e=Promise.all([T(this,ct,up).call(this,py),T(this,ct,up).call(this,my)]),v(this,El,!0)),nd.inject(a=>{n(this,la)&&n(this,la).then(i=>{i.dispose()}),v(this,la,e.then(()=>this.evaluateHandle(a)))},!n(this,la)),n(this,la)}async evaluate(e,...a){return await T(this,ct,pp).call(this,!0,e,...a)}async evaluateHandle(e,...a){return await T(this,ct,pp).call(this,!1,e,...a)}[ge](){n(this,vl).dispose(),this.emit("disposed",void 0)}}na=new WeakMap,Ai=new WeakMap,Lt=new WeakMap,gs=new WeakMap,vl=new WeakMap,xi=new WeakMap,Gd=new WeakMap,ct=new WeakSet,ch=async function(e){const a={stack:[],error:void 0,hasError:!1};try{if(n(this,xi).has(e.name))return;const i=dy(a,await n(this,Gd).acquire(),!1);try{await n(this,na).send("Runtime.addBinding",n(this,gs)?{name:xr+e.name,executionContextName:n(this,gs)}:{name:xr+e.name,executionContextId:n(this,Lt)}),await this.evaluate(ih,"internal",e.name,xr),n(this,xi).set(e.name,e)}catch(r){if(r instanceof Error&&(r.message.includes("Execution context was destroyed")||r.message.includes("Cannot find context with specified id")))return;X(r)}}catch(i){a.error=i,a.hasError=!0}finally{uy(a)}},dh=async function(e){if(e.executionContextId!==n(this,Lt))return;let a;try{a=JSON.parse(e.payload)}catch{return}const{type:i,name:r,seq:s,args:l,isTrivial:d}=a;if(i!=="internal"){this.emit("bindingcalled",e);return}if(!n(this,xi).has(r)){this.emit("bindingcalled",e);return}try{const c=n(this,xi).get(r);await(c==null?void 0:c.run(this,s,l,d))}catch(c){X(c)}},uh=function(e){e.executionContextId===n(this,Lt)&&this.emit("consoleapicalled",e)},El=new WeakMap,la=new WeakMap,up=async function(e){try{await T(this,ct,ch).call(this,e)}catch(a){X(a)}},pp=async function(e,a,...i){var g;const r=HE(((g=$E(a))==null?void 0:g.toString())??Mo.INTERNAL_URL);if(rr(a)){const m=n(this,Lt),b=a,h=Rm.test(b)?b:`${b}
${r}
`,{exceptionDetails:E,result:w}=await n(this,na).send("Runtime.evaluate",{expression:h,contextId:m,returnByValue:e,awaitPromise:!0,userGesture:!0}).catch(Pm);if(E)throw Nm(E);return e?or(w):n(this,Ai).createCdpHandle(w)}const s=La(a),l=Rm.test(s)?s:`${s}
${r}
`;let d;try{d=n(this,na).send("Runtime.callFunctionOn",{functionDeclaration:l,executionContextId:n(this,Lt),arguments:i.length?await Promise.all(i.map(p.bind(this))):[],returnByValue:e,awaitPromise:!0,userGesture:!0})}catch(m){throw m instanceof TypeError&&m.message.startsWith("Converting circular structure to JSON")&&(m.message+=" Recursive objects are not allowed."),m}const{exceptionDetails:c,result:u}=await d.catch(Pm);if(c)throw Nm(c);return e?or(u):n(this,Ai).createCdpHandle(u);async function p(m){if(m instanceof ao&&(m=await m.get(this)),typeof m=="bigint")return{unserializableValue:`${m.toString()}n`};if(Object.is(m,-0))return{unserializableValue:"-0"};if(Object.is(m,1/0))return{unserializableValue:"Infinity"};if(Object.is(m,-1/0))return{unserializableValue:"-Infinity"};if(Object.is(m,NaN))return{unserializableValue:"NaN"};const b=m&&(m instanceof cu||m instanceof sh)?m:null;if(b){if(b.realm!==n(this,Ai))throw new Error("JSHandles can be evaluated only in the context they were created!");if(b.disposed)throw new Error("JSHandle is disposed!");return b.remoteObject().unserializableValue?{unserializableValue:b.remoteObject().unserializableValue}:b.remoteObject().objectId?{objectId:b.remoteObject().objectId}:{value:b.remoteObject().value}}return{value:m}}};const Pm=t=>{if(t.message.includes("Object reference chain is too long"))return{result:{type:"undefined"}};if(t.message.includes("Object couldn't be returned by value"))return{result:{type:"undefined"}};throw t.message.endsWith("Cannot find context with specified id")||t.message.endsWith("Inspected target navigated or closed")?new Error("Execution context was destroyed, most likely because of a navigation."):t};/**
 * @license
 * Copyright 2018 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Ci;class gy{constructor(o){f(this,Ci);v(this,Ci,o)}async snapshot(o={}){const{interestingOnly:e=!0,root:a=null}=o,{nodes:i}=await n(this,Ci).environment.client.send("Accessibility.getFullAXTree");let r;if(a){const{node:c}=await n(this,Ci).environment.client.send("DOM.describeNode",{objectId:a.id});r=c.backendNodeId}const s=mp.createTree(n(this,Ci),i);let l=s;if(r&&(l=s.find(c=>c.payload.backendDOMNodeId===r),!l))return null;if(!e)return this.serializeTree(l)[0]??null;const d=new Set;return this.collectInterestingNodes(d,s,!1),d.has(l)?this.serializeTree(l,d)[0]??null:null}serializeTree(o,e){const a=[];for(const r of o.children)a.push(...this.serializeTree(r,e));if(e&&!e.has(o))return a;const i=o.serialize();return a.length&&(i.children=a),[i]}collectInterestingNodes(o,e,a){if(e.isInteresting(a)&&o.add(e),!e.isLeafNode()){a=a||e.isControl();for(const i of e.children)this.collectInterestingNodes(o,i,a)}}}Ci=new WeakMap;var fs,bl,Ri,yl,_i,ht,Tl,Oi,wl,Po,ph,mh,gp;const sm=class sm{constructor(o,e){f(this,Po);O(this,"payload");O(this,"children",[]);f(this,fs,!1);f(this,bl,!1);f(this,Ri,!1);f(this,yl,!1);f(this,_i);f(this,ht);f(this,Tl);f(this,Oi);f(this,wl);this.payload=e,v(this,_i,this.payload.name?this.payload.name.value:""),v(this,ht,this.payload.role?this.payload.role.value:"Unknown"),v(this,Tl,this.payload.ignored),v(this,wl,o);for(const a of this.payload.properties||[])a.name==="editable"&&(v(this,fs,a.value.value==="richtext"),v(this,bl,!0)),a.name==="focusable"&&v(this,Ri,a.value.value),a.name==="hidden"&&v(this,yl,a.value.value)}find(o){if(o(this))return this;for(const e of this.children){const a=e.find(o);if(a)return a}return null}isLeafNode(){if(!this.children.length||T(this,Po,ph).call(this)||T(this,Po,mh).call(this))return!0;switch(n(this,ht)){case"doc-cover":case"graphics-symbol":case"img":case"image":case"Meter":case"scrollbar":case"slider":case"separator":case"progressbar":return!0}return T(this,Po,gp).call(this)?!1:!!(n(this,Ri)&&n(this,_i)||n(this,ht)==="heading"&&n(this,_i))}isControl(){switch(n(this,ht)){case"button":case"checkbox":case"ColorWell":case"combobox":case"DisclosureTriangle":case"listbox":case"menu":case"menubar":case"menuitem":case"menuitemcheckbox":case"menuitemradio":case"radio":case"scrollbar":case"searchbox":case"slider":case"spinbutton":case"switch":case"tab":case"textbox":case"tree":case"treeitem":return!0;default:return!1}}isInteresting(o){return n(this,ht)==="Ignored"||n(this,yl)||n(this,Tl)?!1:n(this,Ri)||n(this,fs)||this.isControl()?!0:o?!1:this.isLeafNode()&&!!n(this,_i)}serialize(){const o=new Map;for(const g of this.payload.properties||[])o.set(g.name.toLowerCase(),g.value.value);this.payload.name&&o.set("name",this.payload.name.value),this.payload.value&&o.set("value",this.payload.value.value),this.payload.description&&o.set("description",this.payload.description.value);const e={role:n(this,ht),elementHandle:async()=>this.payload.backendDOMNodeId?await n(this,wl).adoptBackendNode(this.payload.backendDOMNodeId):null},a=["name","value","description","keyshortcuts","roledescription","valuetext"],i=g=>o.get(g);for(const g of a)o.has(g)&&(e[g]=i(g));const r=["disabled","expanded","focused","modal","multiline","multiselectable","readonly","required","selected"],s=g=>o.get(g);for(const g of r)g==="focused"&&n(this,ht)==="RootWebArea"||!s(g)||(e[g]=s(g));const l=["checked","pressed"];for(const g of l){if(!o.has(g))continue;const m=o.get(g);e[g]=m==="mixed"?"mixed":m==="true"}const d=["level","valuemax","valuemin"],c=g=>o.get(g);for(const g of d)o.has(g)&&(e[g]=c(g));const u=["autocomplete","haspopup","invalid","orientation"],p=g=>o.get(g);for(const g of u){const m=p(g);!m||m==="false"||(e[g]=p(g))}return e}static createTree(o,e){const a=new Map;for(const i of e)a.set(i.nodeId,new sm(o,i));for(const i of a.values())for(const r of i.payload.childIds||[]){const s=a.get(r);s&&i.children.push(s)}return a.values().next().value}};fs=new WeakMap,bl=new WeakMap,Ri=new WeakMap,yl=new WeakMap,_i=new WeakMap,ht=new WeakMap,Tl=new WeakMap,Oi=new WeakMap,wl=new WeakMap,Po=new WeakSet,ph=function(){return n(this,fs)?!1:n(this,bl)?!0:n(this,ht)==="textbox"||n(this,ht)==="searchbox"},mh=function(){const o=n(this,ht);return o==="LineBreak"||o==="text"||o==="InlineTextBox"||o==="StaticText"},gp=function(){var o;if(n(this,Oi)===void 0){v(this,Oi,!1);for(const e of this.children)if(n(e,Ri)||T(o=e,Po,gp).call(o)){v(this,Oi,!0);break}}return n(this,Oi)};let mp=sm;/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Le;(function(t){t.FrameAttached=Symbol("FrameManager.FrameAttached"),t.FrameNavigated=Symbol("FrameManager.FrameNavigated"),t.FrameDetached=Symbol("FrameManager.FrameDetached"),t.FrameSwapped=Symbol("FrameManager.FrameSwapped"),t.LifecycleEvent=Symbol("FrameManager.LifecycleEvent"),t.FrameNavigatedWithinDocument=Symbol("FrameManager.FrameNavigatedWithinDocument"),t.ConsoleApiCalled=Symbol("FrameManager.ConsoleApiCalled"),t.BindingCalled=Symbol("FrameManager.BindingCalled")})(Le||(Le={}));/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var wo,hs,Il,ca,Di,Sl,Al,Mi,vt,vs,Es;class fy{constructor(o,e,a,...i){f(this,wo);f(this,hs);f(this,Il);f(this,ca);f(this,Di);f(this,Sl);f(this,Al);f(this,Mi,me.create());f(this,vt);f(this,vs);f(this,Es,[]);var r;switch(v(this,wo,o),v(this,hs,e.polling),v(this,Il,e.root),v(this,vs,e.signal),(r=n(this,vs))==null||r.addEventListener("abort",()=>{var s;this.terminate((s=n(this,vs))==null?void 0:s.reason)},{once:!0}),typeof a){case"string":v(this,ca,`() => {return (${a});}`);break;default:v(this,ca,La(a));break}v(this,Di,i),n(this,wo).taskManager.add(this),e.timeout&&(v(this,Al,new Qp(`Waiting failed: ${e.timeout}ms exceeded`)),v(this,Sl,setTimeout(()=>{this.terminate(n(this,Al))},e.timeout))),this.rerun()}get result(){return n(this,Mi).valueOrThrow()}async rerun(){for(const e of n(this,Es))e.abort();n(this,Es).length=0;const o=new AbortController;n(this,Es).push(o);try{switch(n(this,hs)){case"raf":v(this,vt,await n(this,wo).evaluateHandle(({RAFPoller:a,createFunction:i},r,...s)=>{const l=i(r);return new a(()=>l(...s))},ao.create(a=>a.puppeteerUtil),n(this,ca),...n(this,Di)));break;case"mutation":v(this,vt,await n(this,wo).evaluateHandle(({MutationPoller:a,createFunction:i},r,s,...l)=>{const d=i(s);return new a(()=>d(...l),r||document)},ao.create(a=>a.puppeteerUtil),n(this,Il),n(this,ca),...n(this,Di)));break;default:v(this,vt,await n(this,wo).evaluateHandle(({IntervalPoller:a,createFunction:i},r,s,...l)=>{const d=i(s);return new a(()=>d(...l),r)},ao.create(a=>a.puppeteerUtil),n(this,hs),n(this,ca),...n(this,Di)));break}await n(this,vt).evaluate(a=>{a.start()});const e=await n(this,vt).evaluateHandle(a=>a.result());n(this,Mi).resolve(e),await this.terminate()}catch(e){if(o.signal.aborted)return;const a=this.getBadError(e);a&&await this.terminate(a)}}async terminate(o){if(n(this,wo).taskManager.delete(this),clearTimeout(n(this,Sl)),o&&!n(this,Mi).finished()&&n(this,Mi).reject(o),n(this,vt))try{await n(this,vt).evaluateHandle(async e=>{await e.stop()}),n(this,vt)&&(await n(this,vt).dispose(),v(this,vt,void 0))}catch{}}getBadError(o){return ro(o)?o.message.includes("Execution context is not available in detached frame")?new Error("Waiting failed: Frame detached"):o.message.includes("Execution context was destroyed")||o.message.includes("Cannot find context with specified id")||o.message.includes("AbortError: Actor 'MessageHandlerFrame' destroyed")?void 0:o:new Error("WaitTask failed with an error",{cause:o})}}wo=new WeakMap,hs=new WeakMap,Il=new WeakMap,ca=new WeakMap,Di=new WeakMap,Sl=new WeakMap,Al=new WeakMap,Mi=new WeakMap,vt=new WeakMap,vs=new WeakMap,Es=new WeakMap;var da;class hy{constructor(){f(this,da,new Set)}add(o){n(this,da).add(o)}delete(o){n(this,da).delete(o)}terminateAll(o){for(const e of n(this,da))e.terminate(o);n(this,da).clear()}async rerunAll(){await Promise.all([...n(this,da)].map(o=>o.rerun()))}}da=new WeakMap;/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var xl;class vy{constructor(o){O(this,"timeoutSettings");O(this,"taskManager",new hy);f(this,xl,!1);this.timeoutSettings=o}async waitForFunction(o,e={},...a){const{polling:i="raf",timeout:r=this.timeoutSettings.timeout(),root:s,signal:l}=e;if(typeof i=="number"&&i<0)throw new Error("Cannot poll with non-positive interval");return await new fy(this,{polling:i,root:s,timeout:r,signal:l},o,...a).result}get disposed(){return n(this,xl)}dispose(){v(this,xl,!0),this.taskManager.terminateAll(new Error("waitForFunction failed: frame got detached."))}[ge](){this.dispose()}}xl=new WeakMap;/**
 * @license
 * Copyright 2019 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Xt,Nt,ua,Ze,gh,fh,hh,dd,ud;class fp extends vy{constructor(e,a){super(a);f(this,Ze);f(this,Xt);f(this,Nt,new Ie);f(this,ua);v(this,ua,e)}get environment(){return n(this,ua)}get client(){return n(this,ua).client}get emitter(){return n(this,Nt)}setContext(e){var a;(a=n(this,Xt))==null||a[ge](),e.once("disposed",T(this,Ze,gh).bind(this)),e.on("consoleapicalled",T(this,Ze,fh).bind(this)),e.on("bindingcalled",T(this,Ze,hh).bind(this)),v(this,Xt,e),n(this,Nt).emit("context",e),this.taskManager.rerunAll()}hasContext(){return!!n(this,Xt)}get context(){return n(this,Xt)}async evaluateHandle(e,...a){e=Ne(this.evaluateHandle.name,e);let i=T(this,Ze,dd).call(this);return i||(i=await T(this,Ze,ud).call(this)),await i.evaluateHandle(e,...a)}async evaluate(e,...a){e=Ne(this.evaluate.name,e);let i=T(this,Ze,dd).call(this);return i||(i=await T(this,Ze,ud).call(this)),await i.evaluate(e,...a)}async adoptBackendNode(e){let a=T(this,Ze,dd).call(this);a||(a=await T(this,Ze,ud).call(this));const{object:i}=await this.client.send("DOM.resolveNode",{backendNodeId:e,executionContextId:a.id});return this.createCdpHandle(i)}async adoptHandle(e){if(e.realm===this)return await e.evaluateHandle(i=>i);const a=await this.client.send("DOM.describeNode",{objectId:e.id});return await this.adoptBackendNode(a.node.backendNodeId)}async transferHandle(e){if(e.realm===this||e.remoteObject().objectId===void 0)return e;const a=await this.client.send("DOM.describeNode",{objectId:e.remoteObject().objectId}),i=await this.adoptBackendNode(a.node.backendNodeId);return await e.dispose(),i}createCdpHandle(e){return e.subtype==="node"?new sh(this,e):new cu(this,e)}[ge](){var e;(e=n(this,Xt))==null||e[ge](),n(this,Nt).emit("disposed",void 0),super[ge](),n(this,Nt).removeAllListeners()}}Xt=new WeakMap,Nt=new WeakMap,ua=new WeakMap,Ze=new WeakSet,gh=function(){v(this,Xt,void 0),"clearDocumentHandle"in n(this,ua)&&n(this,ua).clearDocumentHandle()},fh=function(e){n(this,Nt).emit("consoleapicalled",e)},hh=function(e){n(this,Nt).emit("bindingcalled",e)},dd=function(){if(this.disposed)throw new Error(`Execution context is not available in detached frame or worker "${this.environment.url()}" (are you trying to evaluate?)`);return n(this,Xt)},ud=async function(){return await nt(Re(n(this,Nt),"context").pipe(to(Re(n(this,Nt),"disposed").pipe(st(()=>{throw new Error("Execution context was destroyed")})),oo(this.timeoutSettings.timeout()))))};/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const Gt=Symbol("mainWorld"),pd=Symbol("puppeteerWorld");/**
 * @license
 * Copyright 2019 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const Ey=new Map([["load","load"],["domcontentloaded","DOMContentLoaded"],["networkidle0","networkIdle"],["networkidle2","networkAlmostIdle"]]);var Cl,pa,bs,ma,zi,Rl,Li,_l,Ol,Dl,Ml,zl,Io,be,vh,Eh,bh,yh,Th,wh,md,Ha;class Au{constructor(o,e,a,i){f(this,be);f(this,Cl);f(this,pa);f(this,bs);f(this,ma,null);f(this,zi,new zo);f(this,Rl);f(this,Li);f(this,_l,me.create());f(this,Ol,me.create());f(this,Dl,me.create());f(this,Ml);f(this,zl);f(this,Io);Array.isArray(a)?a=a.slice():typeof a=="string"&&(a=[a]),v(this,Rl,e._loaderId),v(this,Cl,a.map(d=>{const c=Ey.get(d);return $(c,"Unknown value for options.waitUntil: "+d),c})),v(this,pa,e),v(this,bs,i),n(this,zi).use(new Ie(e._frameManager)).on(Le.LifecycleEvent,T(this,be,Ha).bind(this));const s=n(this,zi).use(new Ie(e));s.on(Ue.FrameNavigatedWithinDocument,T(this,be,Th).bind(this)),s.on(Ue.FrameNavigated,T(this,be,wh).bind(this)),s.on(Ue.FrameSwapped,T(this,be,md).bind(this)),s.on(Ue.FrameSwappedByActivation,T(this,be,md).bind(this)),s.on(Ue.FrameDetached,T(this,be,yh).bind(this));const l=n(this,zi).use(new Ie(o));l.on(ze.Request,T(this,be,vh).bind(this)),l.on(ze.Response,T(this,be,bh).bind(this)),l.on(ze.RequestFailed,T(this,be,Eh).bind(this)),v(this,Li,me.create({timeout:n(this,bs),message:`Navigation timeout of ${n(this,bs)} ms exceeded`})),T(this,be,Ha).call(this)}async navigationResponse(){var o;return await((o=n(this,Io))==null?void 0:o.valueOrThrow()),n(this,ma)?n(this,ma).response():null}sameDocumentNavigationPromise(){return n(this,_l).valueOrThrow()}newDocumentNavigationPromise(){return n(this,Dl).valueOrThrow()}lifecyclePromise(){return n(this,Ol).valueOrThrow()}terminationPromise(){return n(this,Li).valueOrThrow()}dispose(){n(this,zi).dispose(),n(this,Li).resolve(new Error("LifecycleWatcher disposed"))}}Cl=new WeakMap,pa=new WeakMap,bs=new WeakMap,ma=new WeakMap,zi=new WeakMap,Rl=new WeakMap,Li=new WeakMap,_l=new WeakMap,Ol=new WeakMap,Dl=new WeakMap,Ml=new WeakMap,zl=new WeakMap,Io=new WeakMap,be=new WeakSet,vh=function(o){var e,a;o.frame()!==n(this,pa)||!o.isNavigationRequest()||(v(this,ma,o),(e=n(this,Io))==null||e.resolve(),v(this,Io,me.create()),o.response()!==null&&((a=n(this,Io))==null||a.resolve()))},Eh=function(o){var e,a;((e=n(this,ma))==null?void 0:e.id)===o.id&&((a=n(this,Io))==null||a.resolve())},bh=function(o){var e,a;((e=n(this,ma))==null?void 0:e.id)===o.request().id&&((a=n(this,Io))==null||a.resolve())},yh=function(o){if(n(this,pa)===o){n(this,Li).resolve(new Error("Navigating frame was detached"));return}T(this,be,Ha).call(this)},Th=function(){v(this,Ml,!0),T(this,be,Ha).call(this)},wh=function(o){if(o==="BackForwardCacheRestore")return T(this,be,md).call(this);T(this,be,Ha).call(this)},md=function(){v(this,zl,!0),T(this,be,Ha).call(this)},Ha=function(){if(!o(n(this,pa),n(this,Cl)))return;n(this,Ol).resolve(),n(this,Ml)&&n(this,_l).resolve(void 0),(n(this,zl)||n(this,pa)._loaderId!==n(this,Rl))&&n(this,Dl).resolve(void 0);function o(e,a){for(const i of a)if(!e._lifecycleEvents.has(i))return!1;for(const i of e.childFrames())if(i._hasStartedLoading&&!o(i,a))return!1;return!0}};/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var by=function(t,o,e){for(var a=arguments.length>2,i=0;i<o.length;i++)e=a?o[i].call(t,e):o[i].call(t);return a?e:void 0},$a=function(t,o,e,a,i,r){function s(w){if(w!==void 0&&typeof w!="function")throw new TypeError("Function expected");return w}for(var l=a.kind,d=l==="getter"?"get":l==="setter"?"set":"value",c=!o&&t?a.static?t:t.prototype:null,u=o||(c?Object.getOwnPropertyDescriptor(c,a.name):{}),p,g=!1,m=e.length-1;m>=0;m--){var b={};for(var h in a)b[h]=h==="access"?{}:a[h];for(var h in a.access)b.access[h]=a.access[h];b.addInitializer=function(w){if(g)throw new TypeError("Cannot add initializers after decoration has completed");r.push(s(w||null))};var E=(0,e[m])(l==="accessor"?{get:u.get,set:u.set}:u[d],b);if(l==="accessor"){if(E===void 0)continue;if(E===null||typeof E!="object")throw new TypeError("Object expected");(p=s(E.get))&&(u.get=p),(p=s(E.set))&&(u.set=p),(p=s(E.init))&&i.unshift(p)}else(p=s(E))&&(l==="field"?i.unshift(p):u[d]=p)}c&&Object.defineProperty(c,a.name,u),g=!0};let Bm=(()=>{var c,u,p,g,Ih,Sh,Ah,E;let t=Jb,o=[],e,a,i,r,s,l,d;return E=class extends t{constructor(C,R,z,D){super();f(this,g);f(this,c,(by(this,o),""));f(this,u,!1);f(this,p);O(this,"_frameManager");O(this,"_loaderId","");O(this,"_lifecycleEvents",new Set);O(this,"_id");O(this,"_parentId");O(this,"accessibility");O(this,"worlds");this._frameManager=C,v(this,c,""),this._id=R,this._parentId=z,v(this,u,!1),v(this,p,D),this._loaderId="",this.worlds={[Gt]:new fp(this,this._frameManager.timeoutSettings),[pd]:new fp(this,this._frameManager.timeoutSettings)},this.accessibility=new gy(this.worlds[Gt]),this.on(Ue.FrameSwappedByActivation,()=>{this._onLoadingStarted(),this._onLoadingStopped()}),this.worlds[Gt].emitter.on("consoleapicalled",T(this,g,Ih).bind(this)),this.worlds[Gt].emitter.on("bindingcalled",T(this,g,Sh).bind(this))}_client(){return n(this,p)}updateId(C){this._id=C}updateClient(C){v(this,p,C)}page(){return this._frameManager.page()}isOOPFrame(){return n(this,p)!==this._frameManager.client}async goto(C,R={}){const{referer:z=this._frameManager.networkManager.extraHTTPHeaders().referer,referrerPolicy:D=this._frameManager.networkManager.extraHTTPHeaders()["referer-policy"],waitUntil:F=["load"],timeout:L=this._frameManager.timeoutSettings.navigationTimeout()}=R;let M=!1;const j=new Au(this._frameManager.networkManager,this,F,L);let N=await me.race([A(n(this,p),C,z,D,this._id),j.terminationPromise()]);N||(N=await me.race([j.terminationPromise(),M?j.newDocumentNavigationPromise():j.sameDocumentNavigationPromise()]));try{if(N)throw N;return await j.navigationResponse()}finally{j.dispose()}async function A(x,P,B,J,ae){try{const ie=await x.send("Page.navigate",{url:P,referrer:B,frameId:ae,referrerPolicy:J});return M=!!ie.loaderId,ie.errorText==="net::ERR_HTTP_RESPONSE_CODE_FAILURE"?null:ie.errorText?new Error(`${ie.errorText} at ${P}`):null}catch(ie){if(ro(ie))return ie;throw ie}}}async waitForNavigation(C={}){const{waitUntil:R=["load"],timeout:z=this._frameManager.timeoutSettings.navigationTimeout()}=C,D=new Au(this._frameManager.networkManager,this,R,z),F=await me.race([D.terminationPromise(),...C.ignoreSameDocumentNavigation?[]:[D.sameDocumentNavigationPromise()],D.newDocumentNavigationPromise()]);try{if(F)throw F;const L=await me.race([D.terminationPromise(),D.navigationResponse()]);if(L instanceof Error)throw F;return L||null}finally{D.dispose()}}get client(){return n(this,p)}mainRealm(){return this.worlds[Gt]}isolatedRealm(){return this.worlds[pd]}async setContent(C,R={}){const{waitUntil:z=["load"],timeout:D=this._frameManager.timeoutSettings.navigationTimeout()}=R;await this.setFrameContent(C);const F=new Au(this._frameManager.networkManager,this,z,D),L=await me.race([F.terminationPromise(),F.lifecyclePromise()]);if(F.dispose(),L)throw L}url(){return n(this,c)}parentFrame(){return this._frameManager._frameTree.parentFrame(this._id)||null}childFrames(){return this._frameManager._frameTree.childFrames(this._id)}async addPreloadScript(C){if(!this.isOOPFrame()&&this!==this._frameManager.mainFrame()||C.getIdForFrame(this))return;const{identifier:R}=await n(this,p).send("Page.addScriptToEvaluateOnNewDocument",{source:C.source});C.setIdForFrame(this,R)}async addExposedFunctionBinding(C){this!==this._frameManager.mainFrame()&&!this._hasStartedLoading||await Promise.all([n(this,p).send("Runtime.addBinding",{name:xr+C.name}),this.evaluate(C.initSource).catch(X)])}async removeExposedFunctionBinding(C){this!==this._frameManager.mainFrame()&&!this._hasStartedLoading||await Promise.all([n(this,p).send("Runtime.removeBinding",{name:xr+C.name}),this.evaluate(R=>{globalThis[R]=void 0},C.name).catch(X)])}async waitForDevicePrompt(C={}){return await T(this,g,Ah).call(this).waitForDevicePrompt(C)}_navigated(C){this._name=C.name,v(this,c,`${C.url}${C.urlFragment||""}`)}_navigatedWithinDocument(C){v(this,c,C)}_onLifecycleEvent(C,R){R==="init"&&(this._loaderId=C,this._lifecycleEvents.clear()),this._lifecycleEvents.add(R)}_onLoadingStopped(){this._lifecycleEvents.add("DOMContentLoaded"),this._lifecycleEvents.add("load")}_onLoadingStarted(){this._hasStartedLoading=!0}get detached(){return n(this,u)}[(e=[he],a=[he],i=[he],r=[he],s=[he],l=[he],d=[he],ge)](){n(this,u)||(v(this,u,!0),this.worlds[Gt][ge](),this.worlds[pd][ge]())}exposeFunction(){throw new Of}},c=new WeakMap,u=new WeakMap,p=new WeakMap,g=new WeakSet,Ih=function(C){this._frameManager.emit(Le.ConsoleApiCalled,[this.worlds[Gt],C])},Sh=function(C){this._frameManager.emit(Le.BindingCalled,[this.worlds[Gt],C])},Ah=function(){const C=this.page().mainFrame();return this.isOOPFrame()||C===null?this._frameManager._deviceRequestPromptManager(n(this,p)):C._frameManager._deviceRequestPromptManager(n(this,p))},(()=>{const C=typeof Symbol=="function"&&Symbol.metadata?Object.create(t[Symbol.metadata]??null):void 0;$a(E,null,e,{kind:"method",name:"goto",static:!1,private:!1,access:{has:R=>"goto"in R,get:R=>R.goto},metadata:C},null,o),$a(E,null,a,{kind:"method",name:"waitForNavigation",static:!1,private:!1,access:{has:R=>"waitForNavigation"in R,get:R=>R.waitForNavigation},metadata:C},null,o),$a(E,null,i,{kind:"method",name:"setContent",static:!1,private:!1,access:{has:R=>"setContent"in R,get:R=>R.setContent},metadata:C},null,o),$a(E,null,r,{kind:"method",name:"addPreloadScript",static:!1,private:!1,access:{has:R=>"addPreloadScript"in R,get:R=>R.addPreloadScript},metadata:C},null,o),$a(E,null,s,{kind:"method",name:"addExposedFunctionBinding",static:!1,private:!1,access:{has:R=>"addExposedFunctionBinding"in R,get:R=>R.addExposedFunctionBinding},metadata:C},null,o),$a(E,null,l,{kind:"method",name:"removeExposedFunctionBinding",static:!1,private:!1,access:{has:R=>"removeExposedFunctionBinding"in R,get:R=>R.removeExposedFunctionBinding},metadata:C},null,o),$a(E,null,d,{kind:"method",name:"waitForDevicePrompt",static:!1,private:!1,access:{has:R=>"waitForDevicePrompt"in R,get:R=>R.waitForDevicePrompt},metadata:C},null,o),C&&Object.defineProperty(E,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:C})})(),E})();/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Ni,ys,ga,Ts,ws,Ll;class yy{constructor(){f(this,Ni,new Map);f(this,ys,new Map);f(this,ga,new Map);f(this,Ts);f(this,ws,!1);f(this,Ll,new Map)}getMainFrame(){return n(this,Ts)}getById(o){return n(this,Ni).get(o)}waitForFrame(o){const e=this.getById(o);if(e)return Promise.resolve(e);const a=me.create();return(n(this,Ll).get(o)||new Set).add(a),a.valueOrThrow()}frames(){return Array.from(n(this,Ni).values())}addFrame(o){var e;n(this,Ni).set(o._id,o),o._parentId?(n(this,ys).set(o._id,o._parentId),n(this,ga).has(o._parentId)||n(this,ga).set(o._parentId,new Set),n(this,ga).get(o._parentId).add(o._id)):(!n(this,Ts)||n(this,ws))&&(v(this,Ts,o),v(this,ws,!1)),(e=n(this,Ll).get(o._id))==null||e.forEach(a=>a.resolve(o))}removeFrame(o){var e;n(this,Ni).delete(o._id),n(this,ys).delete(o._id),o._parentId?(e=n(this,ga).get(o._parentId))==null||e.delete(o._id):v(this,ws,!0)}childFrames(o){const e=n(this,ga).get(o);return e?Array.from(e).map(a=>this.getById(a)).filter(a=>a!==void 0):[]}parentFrame(o){const e=n(this,ys).get(o);return e?this.getById(e):void 0}}Ni=new WeakMap,ys=new WeakMap,ga=new WeakMap,Ts=new WeakMap,ws=new WeakMap,Ll=new WeakMap;class km{constructor(){O(this,"_interceptionId");O(this,"_failureText",null);O(this,"_response",null);O(this,"_fromMemoryCache",!1);O(this,"_redirectChain",[]);O(this,"interception",{enabled:!1,handled:!1,handlers:[],resolutionState:{action:Kt.None},requestOverrides:{},response:null,abortReason:null})}continueRequestOverrides(){return $(this.interception.enabled,"Request Interception is not enabled!"),this.interception.requestOverrides}responseForRequest(){return $(this.interception.enabled,"Request Interception is not enabled!"),this.interception.response}abortErrorReason(){return $(this.interception.enabled,"Request Interception is not enabled!"),this.interception.abortReason}interceptResolutionState(){return this.interception.enabled?this.interception.handled?{action:Kt.AlreadyHandled}:{...this.interception.resolutionState}:{action:Kt.Disabled}}isInterceptResolutionHandled(){return this.interception.handled}enqueueInterceptAction(o){this.interception.handlers.push(o)}async finalizeInterceptions(){await this.interception.handlers.reduce((e,a)=>e.then(a),Promise.resolve()),this.interception.handlers=[];const{action:o}=this.interceptResolutionState();switch(o){case"abort":return await this._abort(this.interception.abortReason);case"respond":if(this.interception.response===null)throw new Error("Response is missing for the interception");return await this._respond(this.interception.response);case"continue":return await this._continue(this.interception.requestOverrides)}}async continue(o={},e){if(!this.url().startsWith("data:")){if($(this.interception.enabled,"Request Interception is not enabled!"),$(!this.interception.handled,"Request is already handled!"),e===void 0)return await this._continue(o);if(this.interception.requestOverrides=o,this.interception.resolutionState.priority===void 0||e>this.interception.resolutionState.priority){this.interception.resolutionState={action:Kt.Continue,priority:e};return}if(e===this.interception.resolutionState.priority){if(this.interception.resolutionState.action==="abort"||this.interception.resolutionState.action==="respond")return;this.interception.resolutionState.action=Kt.Continue}}}async respond(o,e){if(!this.url().startsWith("data:")){if($(this.interception.enabled,"Request Interception is not enabled!"),$(!this.interception.handled,"Request is already handled!"),e===void 0)return await this._respond(o);if(this.interception.response=o,this.interception.resolutionState.priority===void 0||e>this.interception.resolutionState.priority){this.interception.resolutionState={action:Kt.Respond,priority:e};return}if(e===this.interception.resolutionState.priority){if(this.interception.resolutionState.action==="abort")return;this.interception.resolutionState.action=Kt.Respond}}}async abort(o="failed",e){if(this.url().startsWith("data:"))return;const a=wy[o];if($(a,"Unknown error code: "+o),$(this.interception.enabled,"Request Interception is not enabled!"),$(!this.interception.handled,"Request is already handled!"),e===void 0)return await this._abort(a);if(this.interception.abortReason=a,this.interception.resolutionState.priority===void 0||e>=this.interception.resolutionState.priority){this.interception.resolutionState={action:Kt.Abort,priority:e};return}}static getResponse(o){const e=rr(o)?new TextEncoder().encode(o):o,a=[];for(const i of e)a.push(String.fromCharCode(i));return{contentLength:e.byteLength,base64:btoa(a.join(""))}}}var Kt;(function(t){t.Abort="abort",t.Respond="respond",t.Continue="continue",t.Disabled="disabled",t.None="none",t.AlreadyHandled="already-handled"})(Kt||(Kt={}));function Fm(t){const o=[];for(const e in t){const a=t[e];if(!Object.is(a,void 0)){const i=Array.isArray(a)?a:[a];o.push(...i.map(r=>({name:e,value:r+""})))}}return o}const Ty={100:"Continue",101:"Switching Protocols",102:"Processing",103:"Early Hints",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",208:"Already Reported",226:"IM Used",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",306:"Switch Proxy",307:"Temporary Redirect",308:"Permanent Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Payload Too Large",414:"URI Too Long",415:"Unsupported Media Type",416:"Range Not Satisfiable",417:"Expectation Failed",418:"I'm a teapot",421:"Misdirected Request",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",425:"Too Early",426:"Upgrade Required",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",451:"Unavailable For Legal Reasons",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",508:"Loop Detected",510:"Not Extended",511:"Network Authentication Required"},wy={aborted:"Aborted",accessdenied:"AccessDenied",addressunreachable:"AddressUnreachable",blockedbyclient:"BlockedByClient",blockedbyresponse:"BlockedByResponse",connectionaborted:"ConnectionAborted",connectionclosed:"ConnectionClosed",connectionfailed:"ConnectionFailed",connectionrefused:"ConnectionRefused",connectionreset:"ConnectionReset",internetdisconnected:"InternetDisconnected",namenotresolved:"NameNotResolved",timedout:"TimedOut",failed:"Failed"};function xu(t){if(t.originalMessage.includes("Invalid header")||t.originalMessage.includes('Expected "header"')||t.originalMessage.includes("invalid argument"))throw t;X(t)}var So,Nl,Pl,Bl,kl,Fl,$l,Ul,jl,Hl;class $m extends km{constructor(e,a,i,r,s,l){super();O(this,"id");f(this,So);f(this,Nl);f(this,Pl);f(this,Bl);f(this,kl);f(this,Fl,!1);f(this,$l);f(this,Ul,{});f(this,jl);f(this,Hl);v(this,So,e),this.id=s.requestId,v(this,Nl,s.requestId===s.loaderId&&s.type==="Document"),this._interceptionId=i,v(this,Pl,s.request.url),v(this,Bl,(s.type||"other").toLowerCase()),v(this,kl,s.request.method),v(this,$l,s.request.postData),v(this,Fl,s.request.hasPostData??!1),v(this,jl,a),this._redirectChain=l,v(this,Hl,s.initiator),this.interception.enabled=r;for(const[d,c]of Object.entries(s.request.headers))n(this,Ul)[d.toLowerCase()]=c}get client(){return n(this,So)}url(){return n(this,Pl)}resourceType(){return n(this,Bl)}method(){return n(this,kl)}postData(){return n(this,$l)}hasPostData(){return n(this,Fl)}async fetchPostData(){try{return(await n(this,So).send("Network.getRequestPostData",{requestId:this.id})).postData}catch(e){X(e);return}}headers(){return n(this,Ul)}response(){return this._response}frame(){return n(this,jl)}isNavigationRequest(){return n(this,Nl)}initiator(){return n(this,Hl)}redirectChain(){return this._redirectChain.slice()}failure(){return this._failureText?{errorText:this._failureText}:null}async _continue(e={}){const{url:a,method:i,postData:r,headers:s}=e;this.interception.handled=!0;const l=r?btoa(r):void 0;if(this._interceptionId===void 0)throw new Error("HTTPRequest is missing _interceptionId needed for Fetch.continueRequest");await n(this,So).send("Fetch.continueRequest",{requestId:this._interceptionId,url:a,method:i,postData:l,headers:s?Fm(s):void 0}).catch(d=>(this.interception.handled=!1,xu(d)))}async _respond(e){this.interception.handled=!0;let a;e.body&&(a=km.getResponse(e.body));const i={};if(e.headers)for(const s of Object.keys(e.headers)){const l=e.headers[s];i[s.toLowerCase()]=Array.isArray(l)?l.map(d=>String(d)):String(l)}e.contentType&&(i["content-type"]=e.contentType),a!=null&&a.contentLength&&!("content-length"in i)&&(i["content-length"]=String(a.contentLength));const r=e.status||200;if(this._interceptionId===void 0)throw new Error("HTTPRequest is missing _interceptionId needed for Fetch.fulfillRequest");await n(this,So).send("Fetch.fulfillRequest",{requestId:this._interceptionId,responseCode:r,responsePhrase:Ty[r],responseHeaders:Fm(i),body:a==null?void 0:a.base64}).catch(s=>(this.interception.handled=!1,xu(s)))}async _abort(e){if(this.interception.handled=!0,this._interceptionId===void 0)throw new Error("HTTPRequest is missing _interceptionId needed for Fetch.failRequest");await n(this,So).send("Fetch.failRequest",{requestId:this._interceptionId,errorReason:e||"Failed"}).catch(xu)}}So=new WeakMap,Nl=new WeakMap,Pl=new WeakMap,Bl=new WeakMap,kl=new WeakMap,Fl=new WeakMap,$l=new WeakMap,Ul=new WeakMap,jl=new WeakMap,Hl=new WeakMap;/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class Iy{constructor(){}ok(){const o=this.status();return o===0||o>=200&&o<=299}async text(){return(await this.buffer()).toString("utf8")}async json(){const o=await this.text();return JSON.parse(o)}}/**
 * @license
 * Copyright 2020 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Vl,Wl,Gl,Kl,ql,Yl;class Sy{constructor(o){f(this,Vl);f(this,Wl);f(this,Gl);f(this,Kl);f(this,ql);f(this,Yl);v(this,Vl,o.subjectName),v(this,Wl,o.issuer),v(this,Gl,o.validFrom),v(this,Kl,o.validTo),v(this,ql,o.protocol),v(this,Yl,o.sanList)}issuer(){return n(this,Wl)}validFrom(){return n(this,Gl)}validTo(){return n(this,Kl)}protocol(){return n(this,ql)}subjectName(){return n(this,Vl)}subjectAlternativeNames(){return n(this,Yl)}}Vl=new WeakMap,Wl=new WeakMap,Gl=new WeakMap,Kl=new WeakMap,ql=new WeakMap,Yl=new WeakMap;/**
 * @license
 * Copyright 2020 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Zl,fa,Is,Ss,Xl,Jl,Ql,ec,tc,oc,ac,ic,rc,Kd,xh;class Um extends Iy{constructor(e,a,i,r){super();f(this,Kd);f(this,Zl);f(this,fa);f(this,Is,null);f(this,Ss,me.create());f(this,Xl);f(this,Jl);f(this,Ql);f(this,ec);f(this,tc);f(this,oc);f(this,ac,{});f(this,ic);f(this,rc);v(this,Zl,e),v(this,fa,a),v(this,Xl,{ip:i.remoteIPAddress,port:i.remotePort}),v(this,Ql,T(this,Kd,xh).call(this,r)||i.statusText),v(this,ec,a.url()),v(this,tc,!!i.fromDiskCache),v(this,oc,!!i.fromServiceWorker),v(this,Jl,r?r.statusCode:i.status);const s=r?r.headers:i.headers;for(const[l,d]of Object.entries(s))n(this,ac)[l.toLowerCase()]=d;v(this,ic,i.securityDetails?new Sy(i.securityDetails):null),v(this,rc,i.timing||null)}_resolveBody(e){return e?n(this,Ss).reject(e):n(this,Ss).resolve()}remoteAddress(){return n(this,Xl)}url(){return n(this,ec)}status(){return n(this,Jl)}statusText(){return n(this,Ql)}headers(){return n(this,ac)}securityDetails(){return n(this,ic)}timing(){return n(this,rc)}buffer(){return n(this,Is)||v(this,Is,n(this,Ss).valueOrThrow().then(async()=>{try{const e=await n(this,Zl).send("Network.getResponseBody",{requestId:n(this,fa).id});return Buffer.from(e.body,e.base64Encoded?"base64":"utf8")}catch(e){throw e instanceof Sn&&e.originalMessage==="No resource with given identifier found"?new Sn("Could not load body for this request. This might happen if the request is a preflight request."):e}})),n(this,Is)}request(){return n(this,fa)}fromCache(){return n(this,tc)||n(this,fa)._fromMemoryCache}fromServiceWorker(){return n(this,oc)}frame(){return n(this,fa).frame()}}Zl=new WeakMap,fa=new WeakMap,Is=new WeakMap,Ss=new WeakMap,Xl=new WeakMap,Jl=new WeakMap,Ql=new WeakMap,ec=new WeakMap,tc=new WeakMap,oc=new WeakMap,ac=new WeakMap,ic=new WeakMap,rc=new WeakMap,Kd=new WeakSet,xh=function(e){if(!e||!e.headersText)return;const a=e.headersText.split("\r",1)[0];if(!a)return;const i=a.match(/[^ ]* [^ ]* (.*)/);if(!i)return;const r=i[1];if(r)return r};/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Pi,Bi,ki,Fi,$i,Ui;class Ay{constructor(){f(this,Pi,new Map);f(this,Bi,new Map);f(this,ki,new Map);f(this,Fi,new Map);f(this,$i,new Map);f(this,Ui,new Map)}forget(o){n(this,Pi).delete(o),n(this,Bi).delete(o),n(this,Ui).delete(o),n(this,$i).delete(o),n(this,Fi).delete(o)}responseExtraInfo(o){return n(this,Fi).has(o)||n(this,Fi).set(o,[]),n(this,Fi).get(o)}queuedRedirectInfo(o){return n(this,$i).has(o)||n(this,$i).set(o,[]),n(this,$i).get(o)}queueRedirectInfo(o,e){this.queuedRedirectInfo(o).push(e)}takeQueuedRedirectInfo(o){return this.queuedRedirectInfo(o).shift()}inFlightRequestsCount(){let o=0;for(const e of n(this,ki).values())e.response()||o++;return o}storeRequestWillBeSent(o,e){n(this,Pi).set(o,e)}getRequestWillBeSent(o){return n(this,Pi).get(o)}forgetRequestWillBeSent(o){n(this,Pi).delete(o)}getRequestPaused(o){return n(this,Bi).get(o)}forgetRequestPaused(o){n(this,Bi).delete(o)}storeRequestPaused(o,e){n(this,Bi).set(o,e)}getRequest(o){return n(this,ki).get(o)}storeRequest(o,e){n(this,ki).set(o,e)}forgetRequest(o){n(this,ki).delete(o)}getQueuedEventGroup(o){return n(this,Ui).get(o)}queueEventGroup(o,e){n(this,Ui).set(o,e)}forgetQueuedEventGroup(o){n(this,Ui).delete(o)}}Pi=new WeakMap,Bi=new WeakMap,ki=new WeakMap,Fi=new WeakMap,$i=new WeakMap,Ui=new WeakMap;/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var As,ce,ji,ha,xs,Jt,Ao,va,Ye,Cs,sc,qd,Ea,U,Ch,hp,Go,gd,vp,fd,gn,Rh,_h,Oh,Ep,Dh,fn,Mh,zh,bp,Lh,Nh,hd,Ph,yp,Bh,Tp;class xy extends Ie{constructor(e){super();f(this,U);f(this,As);f(this,ce,new Ay);f(this,ji);f(this,ha,null);f(this,xs,new Set);f(this,Jt,!1);f(this,Ao,!1);f(this,va);f(this,Ye);f(this,Cs);f(this,sc);f(this,qd,[["Fetch.requestPaused",T(this,U,Oh)],["Fetch.authRequired",T(this,U,_h)],["Network.requestWillBeSent",T(this,U,Rh)],["Network.requestServedFromCache",T(this,U,Mh)],["Network.responseReceived",T(this,U,Lh)],["Network.loadingFinished",T(this,U,Ph)],["Network.loadingFailed",T(this,U,Bh)],["Network.responseReceivedExtraInfo",T(this,U,Nh)],[ve.Disconnected,T(this,U,Ch)]]);f(this,Ea,new Map);v(this,As,e)}async addClient(e){if(n(this,Ea).has(e))return;const a=new zo;n(this,Ea).set(e,a);const i=a.use(new Ie(e));for(const[r,s]of n(this,qd))i.on(r,l=>s.bind(this)(e,l));await Promise.all([e.send("Network.enable"),T(this,U,hp).call(this,e),T(this,U,gd).call(this,e),T(this,U,gn).call(this,e),T(this,U,fd).call(this,e),T(this,U,vp).call(this,e)])}async authenticate(e){v(this,ha,e);const a=n(this,Jt)||!!n(this,ha);a!==n(this,Ao)&&(v(this,Ao,a),await T(this,U,Go).call(this,T(this,U,fd).bind(this)))}async setExtraHTTPHeaders(e){const a={};for(const[i,r]of Object.entries(e))$(rr(r),`Expected value of header "${i}" to be String, but "${typeof r}" is found.`),a[i.toLowerCase()]=r;v(this,ji,a),await T(this,U,Go).call(this,T(this,U,hp).bind(this))}extraHTTPHeaders(){return Object.assign({},n(this,ji))}inFlightRequestsCount(){return n(this,ce).inFlightRequestsCount()}async setOfflineMode(e){n(this,Ye)||v(this,Ye,{offline:!1,upload:-1,download:-1,latency:0}),n(this,Ye).offline=e,await T(this,U,Go).call(this,T(this,U,gd).bind(this))}async emulateNetworkConditions(e){n(this,Ye)||v(this,Ye,{offline:!1,upload:-1,download:-1,latency:0}),n(this,Ye).upload=e?e.upload:-1,n(this,Ye).download=e?e.download:-1,n(this,Ye).latency=e?e.latency:0,await T(this,U,Go).call(this,T(this,U,gd).bind(this))}async setUserAgent(e,a){v(this,Cs,e),v(this,sc,a),await T(this,U,Go).call(this,T(this,U,vp).bind(this))}async setCacheEnabled(e){v(this,va,!e),await T(this,U,Go).call(this,T(this,U,gn).bind(this))}async setRequestInterception(e){v(this,Jt,e);const a=n(this,Jt)||!!n(this,ha);a!==n(this,Ao)&&(v(this,Ao,a),await T(this,U,Go).call(this,T(this,U,fd).bind(this)))}}As=new WeakMap,ce=new WeakMap,ji=new WeakMap,ha=new WeakMap,xs=new WeakMap,Jt=new WeakMap,Ao=new WeakMap,va=new WeakMap,Ye=new WeakMap,Cs=new WeakMap,sc=new WeakMap,qd=new WeakMap,Ea=new WeakMap,U=new WeakSet,Ch=async function(e){var a;(a=n(this,Ea).get(e))==null||a.dispose(),n(this,Ea).delete(e)},hp=async function(e){n(this,ji)!==void 0&&await e.send("Network.setExtraHTTPHeaders",{headers:n(this,ji)})},Go=async function(e){await Promise.all(Array.from(n(this,Ea).keys()).map(a=>e(a)))},gd=async function(e){n(this,Ye)!==void 0&&await e.send("Network.emulateNetworkConditions",{offline:n(this,Ye).offline,latency:n(this,Ye).latency,uploadThroughput:n(this,Ye).upload,downloadThroughput:n(this,Ye).download})},vp=async function(e){n(this,Cs)!==void 0&&await e.send("Network.setUserAgentOverride",{userAgent:n(this,Cs),userAgentMetadata:n(this,sc)})},fd=async function(e){n(this,va)===void 0&&v(this,va,!1),n(this,Ao)?await Promise.all([T(this,U,gn).call(this,e),e.send("Fetch.enable",{handleAuthRequests:!0,patterns:[{urlPattern:"*"}]})]):await Promise.all([T(this,U,gn).call(this,e),e.send("Fetch.disable")])},gn=async function(e){n(this,va)!==void 0&&await e.send("Network.setCacheDisabled",{cacheDisabled:n(this,va)})},Rh=function(e,a){if(n(this,Jt)&&!a.request.url.startsWith("data:")){const{requestId:i}=a;n(this,ce).storeRequestWillBeSent(i,a);const r=n(this,ce).getRequestPaused(i);if(r){const{requestId:s}=r;T(this,U,Ep).call(this,a,r),T(this,U,fn).call(this,e,a,s),n(this,ce).forgetRequestPaused(i)}return}T(this,U,fn).call(this,e,a,void 0)},_h=function(e,a){let i="Default";n(this,xs).has(a.requestId)?i="CancelAuth":n(this,ha)&&(i="ProvideCredentials",n(this,xs).add(a.requestId));const{username:r,password:s}=n(this,ha)||{username:void 0,password:void 0};e.send("Fetch.continueWithAuth",{requestId:a.requestId,authChallengeResponse:{response:i,username:r,password:s}}).catch(X)},Oh=function(e,a){!n(this,Jt)&&n(this,Ao)&&e.send("Fetch.continueRequest",{requestId:a.requestId}).catch(X);const{networkId:i,requestId:r}=a;if(!i){T(this,U,Dh).call(this,e,a);return}const s=(()=>{const l=n(this,ce).getRequestWillBeSent(i);if(l&&(l.request.url!==a.request.url||l.request.method!==a.request.method)){n(this,ce).forgetRequestWillBeSent(i);return}return l})();s?(T(this,U,Ep).call(this,s,a),T(this,U,fn).call(this,e,s,r)):n(this,ce).storeRequestPaused(i,a)},Ep=function(e,a){e.request.headers={...e.request.headers,...a.request.headers}},Dh=function(e,a){const i=a.frameId?n(this,As).frame(a.frameId):null,r=new $m(e,i,a.requestId,n(this,Jt),a,[]);this.emit(ze.Request,r),r.finalizeInterceptions()},fn=function(e,a,i){let r=[];if(a.redirectResponse){let d=null;if(a.redirectHasExtraInfo&&(d=n(this,ce).responseExtraInfo(a.requestId).shift(),!d)){n(this,ce).queueRedirectInfo(a.requestId,{event:a,fetchRequestId:i});return}const c=n(this,ce).getRequest(a.requestId);c&&(T(this,U,zh).call(this,e,c,a.redirectResponse,d),r=c._redirectChain)}const s=a.frameId?n(this,As).frame(a.frameId):null,l=new $m(e,s,i,n(this,Jt),a,r);n(this,ce).storeRequest(a.requestId,l),this.emit(ze.Request,l),l.finalizeInterceptions()},Mh=function(e,a){const i=n(this,ce).getRequest(a.requestId);i&&(i._fromMemoryCache=!0),this.emit(ze.RequestServedFromCache,i)},zh=function(e,a,i,r){const s=new Um(e,a,i,r);a._response=s,a._redirectChain.push(a),s._resolveBody(new Error("Response body is unavailable for redirect responses")),T(this,U,hd).call(this,a,!1),this.emit(ze.Response,s),this.emit(ze.RequestFinished,a)},bp=function(e,a,i){const r=n(this,ce).getRequest(a.requestId);if(!r)return;n(this,ce).responseExtraInfo(a.requestId).length&&X(new Error("Unexpected extraInfo events for request "+a.requestId)),a.response.fromDiskCache&&(i=null);const l=new Um(e,r,a.response,i);r._response=l,this.emit(ze.Response,l)},Lh=function(e,a){const i=n(this,ce).getRequest(a.requestId);let r=null;if(i&&!i._fromMemoryCache&&a.hasExtraInfo&&(r=n(this,ce).responseExtraInfo(a.requestId).shift(),!r)){n(this,ce).queueEventGroup(a.requestId,{responseReceivedEvent:a});return}T(this,U,bp).call(this,e,a,r)},Nh=function(e,a){const i=n(this,ce).takeQueuedRedirectInfo(a.requestId);if(i){n(this,ce).responseExtraInfo(a.requestId).push(a),T(this,U,fn).call(this,e,i.event,i.fetchRequestId);return}const r=n(this,ce).getQueuedEventGroup(a.requestId);if(r){n(this,ce).forgetQueuedEventGroup(a.requestId),T(this,U,bp).call(this,e,r.responseReceivedEvent,a),r.loadingFinishedEvent&&T(this,U,yp).call(this,r.loadingFinishedEvent),r.loadingFailedEvent&&T(this,U,Tp).call(this,r.loadingFailedEvent);return}n(this,ce).responseExtraInfo(a.requestId).push(a)},hd=function(e,a){const i=e.id,r=e._interceptionId;n(this,ce).forgetRequest(i),r!==void 0&&n(this,xs).delete(r),a&&n(this,ce).forget(i)},Ph=function(e,a){const i=n(this,ce).getQueuedEventGroup(a.requestId);i?i.loadingFinishedEvent=a:T(this,U,yp).call(this,a)},yp=function(e){var i;const a=n(this,ce).getRequest(e.requestId);a&&(a.response()&&((i=a.response())==null||i._resolveBody()),T(this,U,hd).call(this,a,!0),this.emit(ze.RequestFinished,a))},Bh=function(e,a){const i=n(this,ce).getQueuedEventGroup(a.requestId);i?i.loadingFailedEvent=a:T(this,U,Tp).call(this,a)},Tp=function(e){const a=n(this,ce).getRequest(e.requestId);if(!a)return;a._failureText=e.errorText;const i=a.response();i&&i._resolveBody(),T(this,U,hd).call(this,a,!0),this.emit(ze.RequestFailed,a)};/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const Cy=100;var nc,ba,Rs,lc,It,Hi,_s,Vi,cc,ot,se,wp,kh,Fh,$h,Ip,Sp,Ap,Uh,jh,Hh,Vh,Er;class Ry extends Ie{constructor(e,a,i){super();f(this,se);f(this,nc);f(this,ba);f(this,Rs);f(this,lc,new Set);f(this,It);f(this,Hi,new Map);f(this,_s,new Set);O(this,"_frameTree",new yy);f(this,Vi,new Set);f(this,cc,new WeakMap);f(this,ot);v(this,It,e),v(this,nc,a),v(this,ba,new xy(this)),v(this,Rs,i),this.setupEventListeners(n(this,It)),e.once(ve.Disconnected,()=>{T(this,se,wp).call(this).catch(X)})}get timeoutSettings(){return n(this,Rs)}get networkManager(){return n(this,ba)}get client(){return n(this,It)}async swapFrameTree(e){v(this,It,e),$(n(this,It)instanceof Ar,"CDPSession is not an instance of CDPSessionImpl.");const a=this._frameTree.getMainFrame();a&&(n(this,Vi).add(n(this,It)._target()._targetId),this._frameTree.removeFrame(a),a.updateId(n(this,It)._target()._targetId),this._frameTree.addFrame(a),a.updateClient(e)),this.setupEventListeners(e),e.once(ve.Disconnected,()=>{T(this,se,wp).call(this).catch(X)}),await this.initialize(e,a),await n(this,ba).addClient(e),a&&a.emit(Ue.FrameSwappedByActivation,void 0)}async registerSpeculativeSession(e){await n(this,ba).addClient(e)}setupEventListeners(e){e.on("Page.frameAttached",async a=>{var i;await((i=n(this,ot))==null?void 0:i.valueOrThrow()),T(this,se,Sp).call(this,e,a.frameId,a.parentFrameId)}),e.on("Page.frameNavigated",async a=>{var i;n(this,Vi).add(a.frame.id),await((i=n(this,ot))==null?void 0:i.valueOrThrow()),T(this,se,Ap).call(this,a.frame,a.type)}),e.on("Page.navigatedWithinDocument",async a=>{var i;await((i=n(this,ot))==null?void 0:i.valueOrThrow()),T(this,se,jh).call(this,a.frameId,a.url)}),e.on("Page.frameDetached",async a=>{var i;await((i=n(this,ot))==null?void 0:i.valueOrThrow()),T(this,se,Hh).call(this,a.frameId,a.reason)}),e.on("Page.frameStartedLoading",async a=>{var i;await((i=n(this,ot))==null?void 0:i.valueOrThrow()),T(this,se,Fh).call(this,a.frameId)}),e.on("Page.frameStoppedLoading",async a=>{var i;await((i=n(this,ot))==null?void 0:i.valueOrThrow()),T(this,se,$h).call(this,a.frameId)}),e.on("Runtime.executionContextCreated",async a=>{var i;await((i=n(this,ot))==null?void 0:i.valueOrThrow()),T(this,se,Vh).call(this,a.context,e)}),e.on("Page.lifecycleEvent",async a=>{var i;await((i=n(this,ot))==null?void 0:i.valueOrThrow()),T(this,se,kh).call(this,a)})}async initialize(e,a){var i,r;try{(i=n(this,ot))==null||i.resolve(),v(this,ot,me.create()),await Promise.all([n(this,ba).addClient(e),e.send("Page.enable"),e.send("Page.getFrameTree").then(({frameTree:s})=>{var l;T(this,se,Ip).call(this,e,s),(l=n(this,ot))==null||l.resolve()}),e.send("Page.setLifecycleEventsEnabled",{enabled:!0}),e.send("Runtime.enable").then(()=>T(this,se,Uh).call(this,e,Cm)),...(a?Array.from(n(this,Hi).values()):[]).map(s=>a==null?void 0:a.addPreloadScript(s)),...(a?Array.from(n(this,_s).values()):[]).map(s=>a==null?void 0:a.addExposedFunctionBinding(s))])}catch(s){if((r=n(this,ot))==null||r.resolve(),ro(s)&&ju(s))return;throw s}}page(){return n(this,nc)}mainFrame(){const e=this._frameTree.getMainFrame();return $(e,"Requesting main frame too early!"),e}frames(){return Array.from(this._frameTree.frames())}frame(e){return this._frameTree.getById(e)||null}async addExposedFunctionBinding(e){n(this,_s).add(e),await Promise.all(this.frames().map(async a=>await a.addExposedFunctionBinding(e)))}async removeExposedFunctionBinding(e){n(this,_s).delete(e),await Promise.all(this.frames().map(async a=>await a.removeExposedFunctionBinding(e)))}async evaluateOnNewDocument(e){const{identifier:a}=await this.mainFrame()._client().send("Page.addScriptToEvaluateOnNewDocument",{source:e}),i=new Qb(this.mainFrame(),a,e);return n(this,Hi).set(a,i),await Promise.all(this.frames().map(async r=>await r.addPreloadScript(i))),{identifier:a}}async removeScriptToEvaluateOnNewDocument(e){const a=n(this,Hi).get(e);if(!a)throw new Error(`Script to evaluate on new document with id ${e} not found`);n(this,Hi).delete(e),await Promise.all(this.frames().map(i=>{const r=a.getIdForFrame(i);if(r)return i._client().send("Page.removeScriptToEvaluateOnNewDocument",{identifier:r}).catch(X)}))}onAttachedToTarget(e){if(e._getTargetInfo().type!=="iframe")return;const a=this.frame(e._getTargetInfo().targetId);a&&a.updateClient(e._session()),this.setupEventListeners(e._session()),this.initialize(e._session(),a)}_deviceRequestPromptManager(e){let a=n(this,cc).get(e);return a===void 0&&(a=new oy(e,n(this,Rs)),n(this,cc).set(e,a)),a}}nc=new WeakMap,ba=new WeakMap,Rs=new WeakMap,lc=new WeakMap,It=new WeakMap,Hi=new WeakMap,_s=new WeakMap,Vi=new WeakMap,cc=new WeakMap,ot=new WeakMap,se=new WeakSet,wp=async function(){const e=this._frameTree.getMainFrame();if(!e)return;for(const i of e.childFrames())T(this,se,Er).call(this,i);const a=me.create({timeout:Cy,message:"Frame was not swapped"});e.once(Ue.FrameSwappedByActivation,()=>{a.resolve()});try{await a.valueOrThrow()}catch{T(this,se,Er).call(this,e)}},kh=function(e){const a=this.frame(e.frameId);a&&(a._onLifecycleEvent(e.loaderId,e.name),this.emit(Le.LifecycleEvent,a),a.emit(Ue.LifecycleEvent,void 0))},Fh=function(e){const a=this.frame(e);a&&a._onLoadingStarted()},$h=function(e){const a=this.frame(e);a&&(a._onLoadingStopped(),this.emit(Le.LifecycleEvent,a),a.emit(Ue.LifecycleEvent,void 0))},Ip=function(e,a){if(a.frame.parentId&&T(this,se,Sp).call(this,e,a.frame.id,a.frame.parentId),n(this,Vi).has(a.frame.id)?n(this,Vi).delete(a.frame.id):T(this,se,Ap).call(this,a.frame,"Navigation"),!!a.childFrames)for(const i of a.childFrames)T(this,se,Ip).call(this,e,i)},Sp=function(e,a,i){let r=this.frame(a);if(r){e&&r.isOOPFrame()&&r.updateClient(e);return}r=new Bm(this,a,i,e),this._frameTree.addFrame(r),this.emit(Le.FrameAttached,r)},Ap=async function(e,a){const i=e.id,r=!e.parentId;let s=this._frameTree.getById(i);if(s)for(const l of s.childFrames())T(this,se,Er).call(this,l);r&&(s?(this._frameTree.removeFrame(s),s._id=i):s=new Bm(this,i,void 0,n(this,It)),this._frameTree.addFrame(s)),s=await this._frameTree.waitForFrame(i),s._navigated(e),this.emit(Le.FrameNavigated,s),s.emit(Ue.FrameNavigated,a)},Uh=async function(e,a){const i=`${e.id()}:${a}`;n(this,lc).has(i)||(await e.send("Page.addScriptToEvaluateOnNewDocument",{source:`//# sourceURL=${Mo.INTERNAL_URL}`,worldName:a}),await Promise.all(this.frames().filter(r=>r.client===e).map(r=>e.send("Page.createIsolatedWorld",{frameId:r._id,worldName:a,grantUniveralAccess:!0}).catch(X))),n(this,lc).add(i))},jh=function(e,a){const i=this.frame(e);i&&(i._navigatedWithinDocument(a),this.emit(Le.FrameNavigatedWithinDocument,i),i.emit(Ue.FrameNavigatedWithinDocument,void 0),this.emit(Le.FrameNavigated,i),i.emit(Ue.FrameNavigated,"Navigation"))},Hh=function(e,a){const i=this.frame(e);if(i)switch(a){case"remove":T(this,se,Er).call(this,i);break;case"swap":this.emit(Le.FrameSwapped,i),i.emit(Ue.FrameSwapped,void 0);break}},Vh=function(e,a){const i=e.auxData,r=i&&i.frameId,s=typeof r=="string"?this.frame(r):void 0;let l;if(s){if(s.client!==a)return;e.auxData&&e.auxData.isDefault?l=s.worlds[Gt]:e.name===Cm&&(l=s.worlds[pd])}if(!l)return;const d=new lh((s==null?void 0:s.client)||n(this,It),e,l);l.setContext(d)},Er=function(e){for(const a of e.childFrames())T(this,se,Er).call(this,a);e[ge](),this._frameTree.removeFrame(e),this.emit(Le.FrameDetached,e),e.emit(Ue.FrameDetached,e)};/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class _y{constructor(){}}const je=Object.freeze({Left:"left",Right:"right",Middle:"middle",Back:"back",Forward:"forward"});class Oy{constructor(){}}class Dy{constructor(){}async tap(o,e){await this.touchStart(o,e),await this.touchEnd()}}/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const jm={0:{keyCode:48,key:"0",code:"Digit0"},1:{keyCode:49,key:"1",code:"Digit1"},2:{keyCode:50,key:"2",code:"Digit2"},3:{keyCode:51,key:"3",code:"Digit3"},4:{keyCode:52,key:"4",code:"Digit4"},5:{keyCode:53,key:"5",code:"Digit5"},6:{keyCode:54,key:"6",code:"Digit6"},7:{keyCode:55,key:"7",code:"Digit7"},8:{keyCode:56,key:"8",code:"Digit8"},9:{keyCode:57,key:"9",code:"Digit9"},Power:{key:"Power",code:"Power"},Eject:{key:"Eject",code:"Eject"},Abort:{keyCode:3,code:"Abort",key:"Cancel"},Help:{keyCode:6,code:"Help",key:"Help"},Backspace:{keyCode:8,code:"Backspace",key:"Backspace"},Tab:{keyCode:9,code:"Tab",key:"Tab"},Numpad5:{keyCode:12,shiftKeyCode:101,key:"Clear",code:"Numpad5",shiftKey:"5",location:3},NumpadEnter:{keyCode:13,code:"NumpadEnter",key:"Enter",text:"\r",location:3},Enter:{keyCode:13,code:"Enter",key:"Enter",text:"\r"},"\r":{keyCode:13,code:"Enter",key:"Enter",text:"\r"},"\n":{keyCode:13,code:"Enter",key:"Enter",text:"\r"},ShiftLeft:{keyCode:16,code:"ShiftLeft",key:"Shift",location:1},ShiftRight:{keyCode:16,code:"ShiftRight",key:"Shift",location:2},ControlLeft:{keyCode:17,code:"ControlLeft",key:"Control",location:1},ControlRight:{keyCode:17,code:"ControlRight",key:"Control",location:2},AltLeft:{keyCode:18,code:"AltLeft",key:"Alt",location:1},AltRight:{keyCode:18,code:"AltRight",key:"Alt",location:2},Pause:{keyCode:19,code:"Pause",key:"Pause"},CapsLock:{keyCode:20,code:"CapsLock",key:"CapsLock"},Escape:{keyCode:27,code:"Escape",key:"Escape"},Convert:{keyCode:28,code:"Convert",key:"Convert"},NonConvert:{keyCode:29,code:"NonConvert",key:"NonConvert"},Space:{keyCode:32,code:"Space",key:" "},Numpad9:{keyCode:33,shiftKeyCode:105,key:"PageUp",code:"Numpad9",shiftKey:"9",location:3},PageUp:{keyCode:33,code:"PageUp",key:"PageUp"},Numpad3:{keyCode:34,shiftKeyCode:99,key:"PageDown",code:"Numpad3",shiftKey:"3",location:3},PageDown:{keyCode:34,code:"PageDown",key:"PageDown"},End:{keyCode:35,code:"End",key:"End"},Numpad1:{keyCode:35,shiftKeyCode:97,key:"End",code:"Numpad1",shiftKey:"1",location:3},Home:{keyCode:36,code:"Home",key:"Home"},Numpad7:{keyCode:36,shiftKeyCode:103,key:"Home",code:"Numpad7",shiftKey:"7",location:3},ArrowLeft:{keyCode:37,code:"ArrowLeft",key:"ArrowLeft"},Numpad4:{keyCode:37,shiftKeyCode:100,key:"ArrowLeft",code:"Numpad4",shiftKey:"4",location:3},Numpad8:{keyCode:38,shiftKeyCode:104,key:"ArrowUp",code:"Numpad8",shiftKey:"8",location:3},ArrowUp:{keyCode:38,code:"ArrowUp",key:"ArrowUp"},ArrowRight:{keyCode:39,code:"ArrowRight",key:"ArrowRight"},Numpad6:{keyCode:39,shiftKeyCode:102,key:"ArrowRight",code:"Numpad6",shiftKey:"6",location:3},Numpad2:{keyCode:40,shiftKeyCode:98,key:"ArrowDown",code:"Numpad2",shiftKey:"2",location:3},ArrowDown:{keyCode:40,code:"ArrowDown",key:"ArrowDown"},Select:{keyCode:41,code:"Select",key:"Select"},Open:{keyCode:43,code:"Open",key:"Execute"},PrintScreen:{keyCode:44,code:"PrintScreen",key:"PrintScreen"},Insert:{keyCode:45,code:"Insert",key:"Insert"},Numpad0:{keyCode:45,shiftKeyCode:96,key:"Insert",code:"Numpad0",shiftKey:"0",location:3},Delete:{keyCode:46,code:"Delete",key:"Delete"},NumpadDecimal:{keyCode:46,shiftKeyCode:110,code:"NumpadDecimal",key:"\0",shiftKey:".",location:3},Digit0:{keyCode:48,code:"Digit0",shiftKey:")",key:"0"},Digit1:{keyCode:49,code:"Digit1",shiftKey:"!",key:"1"},Digit2:{keyCode:50,code:"Digit2",shiftKey:"@",key:"2"},Digit3:{keyCode:51,code:"Digit3",shiftKey:"#",key:"3"},Digit4:{keyCode:52,code:"Digit4",shiftKey:"$",key:"4"},Digit5:{keyCode:53,code:"Digit5",shiftKey:"%",key:"5"},Digit6:{keyCode:54,code:"Digit6",shiftKey:"^",key:"6"},Digit7:{keyCode:55,code:"Digit7",shiftKey:"&",key:"7"},Digit8:{keyCode:56,code:"Digit8",shiftKey:"*",key:"8"},Digit9:{keyCode:57,code:"Digit9",shiftKey:"(",key:"9"},KeyA:{keyCode:65,code:"KeyA",shiftKey:"A",key:"a"},KeyB:{keyCode:66,code:"KeyB",shiftKey:"B",key:"b"},KeyC:{keyCode:67,code:"KeyC",shiftKey:"C",key:"c"},KeyD:{keyCode:68,code:"KeyD",shiftKey:"D",key:"d"},KeyE:{keyCode:69,code:"KeyE",shiftKey:"E",key:"e"},KeyF:{keyCode:70,code:"KeyF",shiftKey:"F",key:"f"},KeyG:{keyCode:71,code:"KeyG",shiftKey:"G",key:"g"},KeyH:{keyCode:72,code:"KeyH",shiftKey:"H",key:"h"},KeyI:{keyCode:73,code:"KeyI",shiftKey:"I",key:"i"},KeyJ:{keyCode:74,code:"KeyJ",shiftKey:"J",key:"j"},KeyK:{keyCode:75,code:"KeyK",shiftKey:"K",key:"k"},KeyL:{keyCode:76,code:"KeyL",shiftKey:"L",key:"l"},KeyM:{keyCode:77,code:"KeyM",shiftKey:"M",key:"m"},KeyN:{keyCode:78,code:"KeyN",shiftKey:"N",key:"n"},KeyO:{keyCode:79,code:"KeyO",shiftKey:"O",key:"o"},KeyP:{keyCode:80,code:"KeyP",shiftKey:"P",key:"p"},KeyQ:{keyCode:81,code:"KeyQ",shiftKey:"Q",key:"q"},KeyR:{keyCode:82,code:"KeyR",shiftKey:"R",key:"r"},KeyS:{keyCode:83,code:"KeyS",shiftKey:"S",key:"s"},KeyT:{keyCode:84,code:"KeyT",shiftKey:"T",key:"t"},KeyU:{keyCode:85,code:"KeyU",shiftKey:"U",key:"u"},KeyV:{keyCode:86,code:"KeyV",shiftKey:"V",key:"v"},KeyW:{keyCode:87,code:"KeyW",shiftKey:"W",key:"w"},KeyX:{keyCode:88,code:"KeyX",shiftKey:"X",key:"x"},KeyY:{keyCode:89,code:"KeyY",shiftKey:"Y",key:"y"},KeyZ:{keyCode:90,code:"KeyZ",shiftKey:"Z",key:"z"},MetaLeft:{keyCode:91,code:"MetaLeft",key:"Meta",location:1},MetaRight:{keyCode:92,code:"MetaRight",key:"Meta",location:2},ContextMenu:{keyCode:93,code:"ContextMenu",key:"ContextMenu"},NumpadMultiply:{keyCode:106,code:"NumpadMultiply",key:"*",location:3},NumpadAdd:{keyCode:107,code:"NumpadAdd",key:"+",location:3},NumpadSubtract:{keyCode:109,code:"NumpadSubtract",key:"-",location:3},NumpadDivide:{keyCode:111,code:"NumpadDivide",key:"/",location:3},F1:{keyCode:112,code:"F1",key:"F1"},F2:{keyCode:113,code:"F2",key:"F2"},F3:{keyCode:114,code:"F3",key:"F3"},F4:{keyCode:115,code:"F4",key:"F4"},F5:{keyCode:116,code:"F5",key:"F5"},F6:{keyCode:117,code:"F6",key:"F6"},F7:{keyCode:118,code:"F7",key:"F7"},F8:{keyCode:119,code:"F8",key:"F8"},F9:{keyCode:120,code:"F9",key:"F9"},F10:{keyCode:121,code:"F10",key:"F10"},F11:{keyCode:122,code:"F11",key:"F11"},F12:{keyCode:123,code:"F12",key:"F12"},F13:{keyCode:124,code:"F13",key:"F13"},F14:{keyCode:125,code:"F14",key:"F14"},F15:{keyCode:126,code:"F15",key:"F15"},F16:{keyCode:127,code:"F16",key:"F16"},F17:{keyCode:128,code:"F17",key:"F17"},F18:{keyCode:129,code:"F18",key:"F18"},F19:{keyCode:130,code:"F19",key:"F19"},F20:{keyCode:131,code:"F20",key:"F20"},F21:{keyCode:132,code:"F21",key:"F21"},F22:{keyCode:133,code:"F22",key:"F22"},F23:{keyCode:134,code:"F23",key:"F23"},F24:{keyCode:135,code:"F24",key:"F24"},NumLock:{keyCode:144,code:"NumLock",key:"NumLock"},ScrollLock:{keyCode:145,code:"ScrollLock",key:"ScrollLock"},AudioVolumeMute:{keyCode:173,code:"AudioVolumeMute",key:"AudioVolumeMute"},AudioVolumeDown:{keyCode:174,code:"AudioVolumeDown",key:"AudioVolumeDown"},AudioVolumeUp:{keyCode:175,code:"AudioVolumeUp",key:"AudioVolumeUp"},MediaTrackNext:{keyCode:176,code:"MediaTrackNext",key:"MediaTrackNext"},MediaTrackPrevious:{keyCode:177,code:"MediaTrackPrevious",key:"MediaTrackPrevious"},MediaStop:{keyCode:178,code:"MediaStop",key:"MediaStop"},MediaPlayPause:{keyCode:179,code:"MediaPlayPause",key:"MediaPlayPause"},Semicolon:{keyCode:186,code:"Semicolon",shiftKey:":",key:";"},Equal:{keyCode:187,code:"Equal",shiftKey:"+",key:"="},NumpadEqual:{keyCode:187,code:"NumpadEqual",key:"=",location:3},Comma:{keyCode:188,code:"Comma",shiftKey:"<",key:","},Minus:{keyCode:189,code:"Minus",shiftKey:"_",key:"-"},Period:{keyCode:190,code:"Period",shiftKey:">",key:"."},Slash:{keyCode:191,code:"Slash",shiftKey:"?",key:"/"},Backquote:{keyCode:192,code:"Backquote",shiftKey:"~",key:"`"},BracketLeft:{keyCode:219,code:"BracketLeft",shiftKey:"{",key:"["},Backslash:{keyCode:220,code:"Backslash",shiftKey:"|",key:"\\"},BracketRight:{keyCode:221,code:"BracketRight",shiftKey:"}",key:"]"},Quote:{keyCode:222,code:"Quote",shiftKey:'"',key:"'"},AltGraph:{keyCode:225,code:"AltGraph",key:"AltGraph"},Props:{keyCode:247,code:"Props",key:"CrSel"},Cancel:{keyCode:3,key:"Cancel",code:"Abort"},Clear:{keyCode:12,key:"Clear",code:"Numpad5",location:3},Shift:{keyCode:16,key:"Shift",code:"ShiftLeft",location:1},Control:{keyCode:17,key:"Control",code:"ControlLeft",location:1},Alt:{keyCode:18,key:"Alt",code:"AltLeft",location:1},Accept:{keyCode:30,key:"Accept"},ModeChange:{keyCode:31,key:"ModeChange"}," ":{keyCode:32,key:" ",code:"Space"},Print:{keyCode:42,key:"Print"},Execute:{keyCode:43,key:"Execute",code:"Open"},"\0":{keyCode:46,key:"\0",code:"NumpadDecimal",location:3},a:{keyCode:65,key:"a",code:"KeyA"},b:{keyCode:66,key:"b",code:"KeyB"},c:{keyCode:67,key:"c",code:"KeyC"},d:{keyCode:68,key:"d",code:"KeyD"},e:{keyCode:69,key:"e",code:"KeyE"},f:{keyCode:70,key:"f",code:"KeyF"},g:{keyCode:71,key:"g",code:"KeyG"},h:{keyCode:72,key:"h",code:"KeyH"},i:{keyCode:73,key:"i",code:"KeyI"},j:{keyCode:74,key:"j",code:"KeyJ"},k:{keyCode:75,key:"k",code:"KeyK"},l:{keyCode:76,key:"l",code:"KeyL"},m:{keyCode:77,key:"m",code:"KeyM"},n:{keyCode:78,key:"n",code:"KeyN"},o:{keyCode:79,key:"o",code:"KeyO"},p:{keyCode:80,key:"p",code:"KeyP"},q:{keyCode:81,key:"q",code:"KeyQ"},r:{keyCode:82,key:"r",code:"KeyR"},s:{keyCode:83,key:"s",code:"KeyS"},t:{keyCode:84,key:"t",code:"KeyT"},u:{keyCode:85,key:"u",code:"KeyU"},v:{keyCode:86,key:"v",code:"KeyV"},w:{keyCode:87,key:"w",code:"KeyW"},x:{keyCode:88,key:"x",code:"KeyX"},y:{keyCode:89,key:"y",code:"KeyY"},z:{keyCode:90,key:"z",code:"KeyZ"},Meta:{keyCode:91,key:"Meta",code:"MetaLeft",location:1},"*":{keyCode:106,key:"*",code:"NumpadMultiply",location:3},"+":{keyCode:107,key:"+",code:"NumpadAdd",location:3},"-":{keyCode:109,key:"-",code:"NumpadSubtract",location:3},"/":{keyCode:111,key:"/",code:"NumpadDivide",location:3},";":{keyCode:186,key:";",code:"Semicolon"},"=":{keyCode:187,key:"=",code:"Equal"},",":{keyCode:188,key:",",code:"Comma"},".":{keyCode:190,key:".",code:"Period"},"`":{keyCode:192,key:"`",code:"Backquote"},"[":{keyCode:219,key:"[",code:"BracketLeft"},"\\":{keyCode:220,key:"\\",code:"Backslash"},"]":{keyCode:221,key:"]",code:"BracketRight"},"'":{keyCode:222,key:"'",code:"Quote"},Attn:{keyCode:246,key:"Attn"},CrSel:{keyCode:247,key:"CrSel",code:"Props"},ExSel:{keyCode:248,key:"ExSel"},EraseEof:{keyCode:249,key:"EraseEof"},Play:{keyCode:250,key:"Play"},ZoomOut:{keyCode:251,key:"ZoomOut"},")":{keyCode:48,key:")",code:"Digit0"},"!":{keyCode:49,key:"!",code:"Digit1"},"@":{keyCode:50,key:"@",code:"Digit2"},"#":{keyCode:51,key:"#",code:"Digit3"},$:{keyCode:52,key:"$",code:"Digit4"},"%":{keyCode:53,key:"%",code:"Digit5"},"^":{keyCode:54,key:"^",code:"Digit6"},"&":{keyCode:55,key:"&",code:"Digit7"},"(":{keyCode:57,key:"(",code:"Digit9"},A:{keyCode:65,key:"A",code:"KeyA"},B:{keyCode:66,key:"B",code:"KeyB"},C:{keyCode:67,key:"C",code:"KeyC"},D:{keyCode:68,key:"D",code:"KeyD"},E:{keyCode:69,key:"E",code:"KeyE"},F:{keyCode:70,key:"F",code:"KeyF"},G:{keyCode:71,key:"G",code:"KeyG"},H:{keyCode:72,key:"H",code:"KeyH"},I:{keyCode:73,key:"I",code:"KeyI"},J:{keyCode:74,key:"J",code:"KeyJ"},K:{keyCode:75,key:"K",code:"KeyK"},L:{keyCode:76,key:"L",code:"KeyL"},M:{keyCode:77,key:"M",code:"KeyM"},N:{keyCode:78,key:"N",code:"KeyN"},O:{keyCode:79,key:"O",code:"KeyO"},P:{keyCode:80,key:"P",code:"KeyP"},Q:{keyCode:81,key:"Q",code:"KeyQ"},R:{keyCode:82,key:"R",code:"KeyR"},S:{keyCode:83,key:"S",code:"KeyS"},T:{keyCode:84,key:"T",code:"KeyT"},U:{keyCode:85,key:"U",code:"KeyU"},V:{keyCode:86,key:"V",code:"KeyV"},W:{keyCode:87,key:"W",code:"KeyW"},X:{keyCode:88,key:"X",code:"KeyX"},Y:{keyCode:89,key:"Y",code:"KeyY"},Z:{keyCode:90,key:"Z",code:"KeyZ"},":":{keyCode:186,key:":",code:"Semicolon"},"<":{keyCode:188,key:"<",code:"Comma"},_:{keyCode:189,key:"_",code:"Minus"},">":{keyCode:190,key:">",code:"Period"},"?":{keyCode:191,key:"?",code:"Slash"},"~":{keyCode:192,key:"~",code:"Backquote"},"{":{keyCode:219,key:"{",code:"BracketLeft"},"|":{keyCode:220,key:"|",code:"Backslash"},"}":{keyCode:221,key:"}",code:"BracketRight"},'"':{keyCode:222,key:'"',code:"Quote"},SoftLeft:{key:"SoftLeft",code:"SoftLeft",location:4},SoftRight:{key:"SoftRight",code:"SoftRight",location:4},Camera:{keyCode:44,key:"Camera",code:"Camera",location:4},Call:{key:"Call",code:"Call",location:4},EndCall:{keyCode:95,key:"EndCall",code:"EndCall",location:4},VolumeDown:{keyCode:182,key:"VolumeDown",code:"VolumeDown",location:4},VolumeUp:{keyCode:183,key:"VolumeUp",code:"VolumeUp",location:4}};/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var ya,Os,Na,xp,Cp;class My extends _y{constructor(e){super();f(this,Na);f(this,ya);f(this,Os,new Set);O(this,"_modifiers",0);v(this,ya,e)}updateClient(e){v(this,ya,e)}async down(e,a={text:void 0,commands:[]}){const i=T(this,Na,Cp).call(this,e),r=n(this,Os).has(i.code);n(this,Os).add(i.code),this._modifiers|=T(this,Na,xp).call(this,i.key);const s=a.text===void 0?i.text:a.text;await n(this,ya).send("Input.dispatchKeyEvent",{type:s?"keyDown":"rawKeyDown",modifiers:this._modifiers,windowsVirtualKeyCode:i.keyCode,code:i.code,key:i.key,text:s,unmodifiedText:s,autoRepeat:r,location:i.location,isKeypad:i.location===3,commands:a.commands})}async up(e){const a=T(this,Na,Cp).call(this,e);this._modifiers&=~T(this,Na,xp).call(this,a.key),n(this,Os).delete(a.code),await n(this,ya).send("Input.dispatchKeyEvent",{type:"keyUp",modifiers:this._modifiers,key:a.key,windowsVirtualKeyCode:a.keyCode,code:a.code,location:a.location})}async sendCharacter(e){await n(this,ya).send("Input.insertText",{text:e})}charIsKey(e){return!!jm[e]}async type(e,a={}){const i=a.delay||void 0;for(const r of e)this.charIsKey(r)?await this.press(r,{delay:i}):(i&&await new Promise(s=>setTimeout(s,i)),await this.sendCharacter(r))}async press(e,a={}){const{delay:i=null}=a;await this.down(e,a),i&&await new Promise(r=>setTimeout(r,a.delay)),await this.up(e)}}ya=new WeakMap,Os=new WeakMap,Na=new WeakSet,xp=function(e){return e==="Alt"?1:e==="Control"?2:e==="Meta"?4:e==="Shift"?8:0},Cp=function(e){const a=this._modifiers&8,i={key:"",keyCode:0,code:"",text:"",location:0},r=jm[e];return $(r,`Unknown key: "${e}"`),r.key&&(i.key=r.key),a&&r.shiftKey&&(i.key=r.shiftKey),r.keyCode&&(i.keyCode=r.keyCode),a&&r.shiftKeyCode&&(i.keyCode=r.shiftKeyCode),r.code&&(i.code=r.code),r.location&&(i.location=r.location),i.key.length===1&&(i.text=i.key),r.text&&(i.text=r.text),a&&r.shiftText&&(i.text=r.shiftText),this._modifiers&-9&&(i.text=""),i};const Hm=t=>{switch(t){case je.Left:return 1;case je.Right:return 2;case je.Middle:return 4;case je.Back:return 8;case je.Forward:return 16}},zy=t=>t&1?je.Left:t&2?je.Right:t&4?je.Middle:t&8?je.Back:t&16?je.Forward:"none";var Et,Pt,Ds,we,mt,Wi,Wh,vd;class Ly extends Oy{constructor(e,a){super();f(this,we);f(this,Et);f(this,Pt);f(this,Ds,{position:{x:0,y:0},buttons:0});f(this,Wi,[]);v(this,Et,e),v(this,Pt,a)}updateClient(e){v(this,Et,e)}async reset(){const e=[];for(const[a,i]of[[1,je.Left],[4,je.Middle],[2,je.Right],[16,je.Forward],[8,je.Back]])n(this,we,mt).buttons&a&&e.push(this.up({button:i}));(n(this,we,mt).position.x!==0||n(this,we,mt).position.y!==0)&&e.push(this.move(0,0)),await Promise.all(e)}async move(e,a,i={}){const{steps:r=1}=i,s=n(this,we,mt).position,l={x:e,y:a};for(let d=1;d<=r;d++)await T(this,we,vd).call(this,c=>{c({position:{x:s.x+(l.x-s.x)*(d/r),y:s.y+(l.y-s.y)*(d/r)}});const{buttons:u,position:p}=n(this,we,mt);return n(this,Et).send("Input.dispatchMouseEvent",{type:"mouseMoved",modifiers:n(this,Pt)._modifiers,buttons:u,button:zy(u),...p})})}async down(e={}){const{button:a=je.Left,clickCount:i=1}=e,r=Hm(a);if(!r)throw new Error(`Unsupported mouse button: ${a}`);if(n(this,we,mt).buttons&r)throw new Error(`'${a}' is already pressed.`);await T(this,we,vd).call(this,s=>{s({buttons:n(this,we,mt).buttons|r});const{buttons:l,position:d}=n(this,we,mt);return n(this,Et).send("Input.dispatchMouseEvent",{type:"mousePressed",modifiers:n(this,Pt)._modifiers,clickCount:i,buttons:l,button:a,...d})})}async up(e={}){const{button:a=je.Left,clickCount:i=1}=e,r=Hm(a);if(!r)throw new Error(`Unsupported mouse button: ${a}`);if(!(n(this,we,mt).buttons&r))throw new Error(`'${a}' is not pressed.`);await T(this,we,vd).call(this,s=>{s({buttons:n(this,we,mt).buttons&~r});const{buttons:l,position:d}=n(this,we,mt);return n(this,Et).send("Input.dispatchMouseEvent",{type:"mouseReleased",modifiers:n(this,Pt)._modifiers,clickCount:i,buttons:l,button:a,...d})})}async click(e,a,i={}){const{delay:r,count:s=1,clickCount:l=s}=i;if(s<1)throw new Error("Click must occur a positive number of times.");const d=[this.move(e,a)];if(l===s)for(let c=1;c<s;++c)d.push(this.down({...i,clickCount:c}),this.up({...i,clickCount:c}));d.push(this.down({...i,clickCount:l})),typeof r=="number"&&(await Promise.all(d),d.length=0,await new Promise(c=>{setTimeout(c,r)})),d.push(this.up({...i,clickCount:l})),await Promise.all(d)}async wheel(e={}){const{deltaX:a=0,deltaY:i=0}=e,{position:r,buttons:s}=n(this,we,mt);await n(this,Et).send("Input.dispatchMouseEvent",{type:"mouseWheel",pointerType:"mouse",modifiers:n(this,Pt)._modifiers,deltaY:i,deltaX:a,buttons:s,...r})}async drag(e,a){const i=new Promise(r=>{n(this,Et).once("Input.dragIntercepted",s=>r(s.data))});return await this.move(e.x,e.y),await this.down(),await this.move(a.x,a.y),await i}async dragEnter(e,a){await n(this,Et).send("Input.dispatchDragEvent",{type:"dragEnter",x:e.x,y:e.y,modifiers:n(this,Pt)._modifiers,data:a})}async dragOver(e,a){await n(this,Et).send("Input.dispatchDragEvent",{type:"dragOver",x:e.x,y:e.y,modifiers:n(this,Pt)._modifiers,data:a})}async drop(e,a){await n(this,Et).send("Input.dispatchDragEvent",{type:"drop",x:e.x,y:e.y,modifiers:n(this,Pt)._modifiers,data:a})}async dragAndDrop(e,a,i={}){const{delay:r=null}=i,s=await this.drag(e,a);await this.dragEnter(a,s),await this.dragOver(a,s),r&&await new Promise(l=>setTimeout(l,r)),await this.drop(a,s),await this.up()}}Et=new WeakMap,Pt=new WeakMap,Ds=new WeakMap,we=new WeakSet,mt=function(){return Object.assign({...n(this,Ds)},...n(this,Wi))},Wi=new WeakMap,Wh=function(){const e={};n(this,Wi).push(e);const a=()=>{n(this,Wi).splice(n(this,Wi).indexOf(e),1)};return{update:i=>{Object.assign(e,i)},commit:()=>{v(this,Ds,{...n(this,Ds),...e}),a()},rollback:a}},vd=async function(e){const{update:a,commit:i,rollback:r}=T(this,we,Wh).call(this);try{await e(a),i()}catch(s){throw r(),s}};var Ta,Gi;class Ny extends Dy{constructor(e,a){super();f(this,Ta);f(this,Gi);v(this,Ta,e),v(this,Gi,a)}updateClient(e){v(this,Ta,e)}async touchStart(e,a){await n(this,Ta).send("Input.dispatchTouchEvent",{type:"touchStart",touchPoints:[{x:Math.round(e),y:Math.round(a),radiusX:.5,radiusY:.5,force:.5}],modifiers:n(this,Gi)._modifiers})}async touchMove(e,a){await n(this,Ta).send("Input.dispatchTouchEvent",{type:"touchMove",touchPoints:[{x:Math.round(e),y:Math.round(a),radiusX:.5,radiusY:.5,force:.5}],modifiers:n(this,Gi)._modifiers})}async touchEnd(){await n(this,Ta).send("Input.dispatchTouchEvent",{type:"touchEnd",touchPoints:[],modifiers:n(this,Gi)._modifiers})}}Ta=new WeakMap,Gi=new WeakMap;var xo,Ms,dc;class Py{constructor(o){f(this,xo);f(this,Ms,!1);f(this,dc);v(this,xo,o)}updateClient(o){v(this,xo,o)}async start(o={}){$(!n(this,Ms),"Cannot start recording trace while already recording trace.");const e=["-*","devtools.timeline","v8.execute","disabled-by-default-devtools.timeline","disabled-by-default-devtools.timeline.frame","toplevel","blink.console","blink.user_timing","latencyInfo","disabled-by-default-devtools.timeline.stack","disabled-by-default-v8.cpu_profiler"],{path:a,screenshots:i=!1,categories:r=e}=o;i&&r.push("disabled-by-default-devtools.screenshot");const s=r.filter(d=>d.startsWith("-")).map(d=>d.slice(1)),l=r.filter(d=>!d.startsWith("-"));v(this,dc,a),v(this,Ms,!0),await n(this,xo).send("Tracing.start",{transferMode:"ReturnAsStream",traceConfig:{excludedCategories:s,includedCategories:l}})}async stop(){const o=me.create();return n(this,xo).once("Tracing.tracingComplete",async e=>{try{$(e.stream,'Missing "stream"');const a=await zf(n(this,xo),e.stream),i=await Mf(a,n(this,dc));o.resolve(i??void 0)}catch(a){ro(a)?o.reject(a):o.reject(new Error(`Unknown error: ${a}`))}}),await n(this,xo).send("Tracing.end"),v(this,Ms,!1),await o.valueOrThrow()}}xo=new WeakMap,Ms=new WeakMap,dc=new WeakMap;/**
 * @license
 * Copyright 2018 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var uc;class By extends Ie{constructor(e){super();O(this,"timeoutSettings",new em);f(this,uc);v(this,uc,e)}url(){return n(this,uc)}async evaluate(e,...a){return e=Ne(this.evaluate.name,e),await this.mainRealm().evaluate(e,...a)}async evaluateHandle(e,...a){return e=Ne(this.evaluateHandle.name,e),await this.mainRealm().evaluateHandle(e,...a)}async close(){throw new Of("WebWorker.close() is not supported")}}uc=new WeakMap;var Qt,Co,pc,mc;class Gh extends By{constructor(e,a,i,r,s,l){super(a);f(this,Qt);f(this,Co);f(this,pc);f(this,mc);v(this,pc,i),v(this,Co,e),v(this,mc,r),v(this,Qt,new fp(this,new em)),n(this,Co).once("Runtime.executionContextCreated",async d=>{n(this,Qt).setContext(new lh(e,d.context,n(this,Qt)))}),n(this,Qt).emitter.on("consoleapicalled",async d=>{try{return s(d.type,d.args.map(c=>new cu(n(this,Qt),c)),d.stackTrace)}catch(c){X(c)}}),n(this,Co).on("Runtime.exceptionThrown",l),n(this,Co).once(ve.Disconnected,()=>{n(this,Qt).dispose()}),n(this,Co).send("Runtime.enable").catch(X)}mainRealm(){return n(this,Qt)}get client(){return n(this,Co)}async close(){var e,a;switch(n(this,mc)){case bt.SERVICE_WORKER:case bt.SHARED_WORKER:{await((e=this.client.connection())==null?void 0:e.send("Target.closeTarget",{targetId:n(this,pc)})),await((a=this.client.connection())==null?void 0:a.send("Target.detachFromTarget",{sessionId:this.client.id()}));break}default:await this.evaluate(()=>{self.close()})}}}Qt=new WeakMap,Co=new WeakMap,pc=new WeakMap,mc=new WeakMap;/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Cu=function(t,o,e){if(o!=null){if(typeof o!="object"&&typeof o!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=o[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=o[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");t.stack.push({value:o,dispose:a,async:e})}else e&&t.stack.push({async:!0});return o},Ru=(function(t){return function(o){function e(i){o.error=o.hasError?new t(i,o.error,"An error was suppressed during disposal."):i,o.hasError=!0}function a(){for(;o.stack.length;){var i=o.stack.pop();try{var r=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(r).then(a,function(s){return e(s),a()})}catch(s){e(s)}}if(o.hasError)throw o.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(t,o,e){var a=new Error(e);return a.name="SuppressedError",a.error=t,a.suppressed=o,a});function _u(t){switch(t){case"warning":return"warn";default:return t}}var gc,wa,ne,Bt,Ia,Ki,Sa,zs,Ls,pe,xe,Ns,Aa,Ps,Bs,ks,qi,Ro,Yd,fc,hc,Zd,Xd,Jd,te,Kh,qh,Yh,Rp,vc,Fs,Zh,Xh,Jh,Qh,e0,_p,Op,t0,o0,Dp,a0,Mp;const nm=class nm extends pb{constructor(e,a){super();f(this,te);f(this,gc,!1);f(this,wa);f(this,ne);f(this,Bt);f(this,Ia);f(this,Ki);f(this,Sa);f(this,zs);f(this,Ls);f(this,pe);f(this,xe);f(this,Ns);f(this,Aa,new Map);f(this,Ps,new Map);f(this,Bs);f(this,ks);f(this,qi,new Map);f(this,Ro,new Set);f(this,Yd,me.create());f(this,fc,!1);f(this,hc,!1);f(this,Zd,[[Le.FrameAttached,e=>{this.emit("frameattached",e)}],[Le.FrameDetached,e=>{this.emit("framedetached",e)}],[Le.FrameNavigated,e=>{this.emit("framenavigated",e)}]]);f(this,Xd,[[ze.Request,e=>{this.emit("request",e)}],[ze.RequestServedFromCache,e=>{this.emit("requestservedfromcache",e)}],[ze.Response,e=>{this.emit("response",e)}],[ze.RequestFailed,e=>{this.emit("requestfailed",e)}],[ze.RequestFinished,e=>{this.emit("requestfinished",e)}]]);f(this,Jd,[[ve.Disconnected,()=>{n(this,Yd).reject(new za("Target closed"))}],["Page.domContentEventFired",()=>this.emit("domcontentloaded",void 0)],["Page.loadEventFired",()=>this.emit("load",void 0)],["Page.javascriptDialogOpening",T(this,te,a0).bind(this)],["Runtime.exceptionThrown",T(this,te,Op).bind(this)],["Inspector.targetCrashed",T(this,te,Jh).bind(this)],["Performance.metrics",T(this,te,e0).bind(this)],["Log.entryAdded",T(this,te,Qh).bind(this)],["Page.fileChooserOpened",T(this,te,Xh).bind(this)]]);f(this,vc,e=>{var r;const a=(r=e._session())==null?void 0:r.id(),i=n(this,qi).get(a);i&&(n(this,qi).delete(a),this.emit("workerdestroyed",i))});f(this,Fs,e=>{if($(e instanceof Ar),n(this,pe).onAttachedToTarget(e._target()),e._target()._getTargetInfo().type==="worker"){const a=new Gh(e,e._target().url(),e._target()._targetId,e._target().type(),T(this,te,Dp).bind(this),T(this,te,Op).bind(this));n(this,qi).set(e.id(),a),this.emit("workercreated",a)}e.on(ve.Ready,n(this,Fs))});v(this,ne,e),v(this,Ia,e.parentSession()),$(n(this,Ia),"Tab target session is not defined."),v(this,Ki,n(this,Ia)._target()),$(n(this,Ki),"Tab target is not defined."),v(this,Bt,a),v(this,wa,a._targetManager()),v(this,Sa,new My(e)),v(this,zs,new Ly(e,n(this,Sa))),v(this,Ls,new Ny(e,n(this,Sa))),v(this,pe,new Ry(e,this,this._timeoutSettings)),v(this,xe,new Rb(e)),v(this,Ns,new Py(e)),v(this,Bs,new wb(e)),v(this,ks,null);for(const[i,r]of n(this,Zd))n(this,pe).on(i,r);n(this,pe).on(Le.ConsoleApiCalled,([i,r])=>{T(this,te,t0).call(this,i,r)}),n(this,pe).on(Le.BindingCalled,([i,r])=>{T(this,te,o0).call(this,i,r)});for(const[i,r]of n(this,Xd))n(this,pe).networkManager.on(i,r);n(this,Ia).on(ve.Swapped,T(this,te,qh).bind(this)),n(this,Ia).on(ve.Ready,T(this,te,Yh).bind(this)),n(this,wa).on("targetGone",n(this,vc)),n(this,Ki)._isClosedDeferred.valueOrThrow().then(()=>{n(this,wa).off("targetGone",n(this,vc)),this.emit("close",void 0),v(this,gc,!0)}).catch(X),T(this,te,Rp).call(this),T(this,te,Kh).call(this)}static async _create(e,a,i){var s;const r=new nm(e,a);if(await T(s=r,te,Zh).call(s),i)try{await r.setViewport(i)}catch(l){if(ro(l)&&ju(l))X(l);else throw l}return r}_client(){return n(this,ne)}isServiceWorkerBypassed(){return n(this,fc)}isDragInterceptionEnabled(){return n(this,hc)}isJavaScriptEnabled(){return n(this,xe).javascriptEnabled}async waitForFileChooser(e={}){const a=n(this,Ro).size===0,{timeout:i=this._timeoutSettings.timeout()}=e,r=me.create({message:`Waiting for \`FileChooser\` failed: ${i}ms exceeded`,timeout:i});n(this,Ro).add(r);let s;a&&(s=n(this,ne).send("Page.setInterceptFileChooserDialog",{enabled:!0}));try{const[l]=await Promise.all([r.valueOrThrow(),s]);return l}catch(l){throw n(this,Ro).delete(r),l}}async setGeolocation(e){return await n(this,xe).setGeolocation(e)}target(){return n(this,Bt)}browser(){return n(this,Bt).browser()}browserContext(){return n(this,Bt).browserContext()}mainFrame(){return n(this,pe).mainFrame()}get keyboard(){return n(this,Sa)}get touchscreen(){return n(this,Ls)}get coverage(){return n(this,Bs)}get tracing(){return n(this,Ns)}frames(){return n(this,pe).frames()}workers(){return Array.from(n(this,qi).values())}async setRequestInterception(e){return await n(this,pe).networkManager.setRequestInterception(e)}async setBypassServiceWorker(e){return v(this,fc,e),await n(this,ne).send("Network.setBypassServiceWorker",{bypass:e})}async setDragInterception(e){return v(this,hc,e),await n(this,ne).send("Input.setInterceptDrags",{enabled:e})}async setOfflineMode(e){return await n(this,pe).networkManager.setOfflineMode(e)}async emulateNetworkConditions(e){return await n(this,pe).networkManager.emulateNetworkConditions(e)}setDefaultNavigationTimeout(e){this._timeoutSettings.setDefaultNavigationTimeout(e)}setDefaultTimeout(e){this._timeoutSettings.setDefaultTimeout(e)}getDefaultTimeout(){return this._timeoutSettings.timeout()}async queryObjects(e){$(!e.disposed,"Prototype JSHandle is disposed!"),$(e.id,"Prototype JSHandle must not be referencing primitive value");const a=await this.mainFrame().client.send("Runtime.queryObjects",{prototypeObjectId:e.id});return this.mainFrame().mainRealm().createCdpHandle(a.objects)}async cookies(...e){const a=(await n(this,ne).send("Network.getCookies",{urls:e.length?e:[this.url()]})).cookies,i=["sourcePort"],r=s=>{for(const l of i)delete s[l];return s};return a.map(r)}async deleteCookie(...e){const a=this.url();for(const i of e){const r=Object.assign({},i);!i.url&&a.startsWith("http")&&(r.url=a),await n(this,ne).send("Network.deleteCookies",r)}}async setCookie(...e){const a=this.url(),i=a.startsWith("http"),r=e.map(s=>{const l=Object.assign({},s);return!l.url&&i&&(l.url=a),$(l.url!=="about:blank",`Blank page can not have cookie "${l.name}"`),$(!String.prototype.startsWith.call(l.url||"","data:"),`Data URL page can not have cookie "${l.name}"`),l});await this.deleteCookie(...r),r.length&&await n(this,ne).send("Network.setCookies",{cookies:r})}async exposeFunction(e,a){if(n(this,Aa).has(e))throw new Error(`Failed to add page binding with name ${e}: window['${e}'] already exists!`);const i=ny("exposedFun",e);let r;switch(typeof a){case"function":r=new _d(e,a,i);break;default:r=new _d(e,a.default,i);break}n(this,Aa).set(e,r);const[{identifier:s}]=await Promise.all([n(this,pe).evaluateOnNewDocument(i),n(this,pe).addExposedFunctionBinding(r)]);n(this,Ps).set(e,s)}async removeExposedFunction(e){const a=n(this,Ps).get(e);if(!a)throw new Error(`Function with name "${e}" does not exist`);const i=n(this,Aa).get(e);n(this,Ps).delete(e),n(this,Aa).delete(e),await Promise.all([n(this,pe).removeScriptToEvaluateOnNewDocument(a),n(this,pe).removeExposedFunctionBinding(i)])}async authenticate(e){return await n(this,pe).networkManager.authenticate(e)}async setExtraHTTPHeaders(e){return await n(this,pe).networkManager.setExtraHTTPHeaders(e)}async setUserAgent(e,a){return await n(this,pe).networkManager.setUserAgent(e,a)}async metrics(){const e=await n(this,ne).send("Performance.getMetrics");return T(this,te,_p).call(this,e.metrics)}async reload(e){const[a]=await Promise.all([this.waitForNavigation({...e,ignoreSameDocumentNavigation:!0}),n(this,ne).send("Page.reload")]);return a}async createCDPSession(){return await this.target().createCDPSession()}async goBack(e={}){return await T(this,te,Mp).call(this,-1,e)}async goForward(e={}){return await T(this,te,Mp).call(this,1,e)}async bringToFront(){await n(this,ne).send("Page.bringToFront")}async setJavaScriptEnabled(e){return await n(this,xe).setJavaScriptEnabled(e)}async setBypassCSP(e){await n(this,ne).send("Page.setBypassCSP",{enabled:e})}async emulateMediaType(e){return await n(this,xe).emulateMediaType(e)}async emulateCPUThrottling(e){return await n(this,xe).emulateCPUThrottling(e)}async emulateMediaFeatures(e){return await n(this,xe).emulateMediaFeatures(e)}async emulateTimezone(e){return await n(this,xe).emulateTimezone(e)}async emulateIdleState(e){return await n(this,xe).emulateIdleState(e)}async emulateVisionDeficiency(e){return await n(this,xe).emulateVisionDeficiency(e)}async setViewport(e){const a=await n(this,xe).emulateViewport(e);v(this,ks,e),a&&await this.reload()}viewport(){return n(this,ks)}async evaluateOnNewDocument(e,...a){const i=Df(e,...a);return await n(this,pe).evaluateOnNewDocument(i)}async removeScriptToEvaluateOnNewDocument(e){return await n(this,pe).removeScriptToEvaluateOnNewDocument(e)}async setCacheEnabled(e=!0){await n(this,pe).networkManager.setCacheEnabled(e)}async _screenshot(e){const a={stack:[],error:void 0,hasError:!1};try{const{fromSurface:i,omitBackground:r,optimizeForSpeed:s,quality:l,clip:d,type:c,captureBeyondViewport:u}=e,p=this.target()._targetManager()instanceof qf,g=Cu(a,new Sd,!0);!p&&r&&(c==="png"||c==="webp")&&(await n(this,xe).setTransparentBackgroundColor(),g.defer(async()=>{await n(this,xe).resetDefaultBackgroundColor().catch(X)}));let m=d;if(m&&!u){const h=await this.mainFrame().isolatedRealm().evaluate(()=>{const{height:E,pageLeft:w,pageTop:S,width:C}=window.visualViewport;return{x:w,y:S,height:E,width:C}});m=Fy(m,h)}const{data:b}=await n(this,ne).send("Page.captureScreenshot",{format:c,...s?{optimizeForSpeed:s}:{},...l!==void 0?{quality:Math.round(l)}:{},...m?{clip:{...m,scale:m.scale??1}}:{},...i?{}:{fromSurface:i},captureBeyondViewport:u});return b}catch(i){a.error=i,a.hasError=!0}finally{const i=Ru(a);i&&await i}}async createPDFStream(e={}){const{timeout:a=this._timeoutSettings.timeout()}=e,{landscape:i,displayHeaderFooter:r,headerTemplate:s,footerTemplate:l,printBackground:d,scale:c,width:u,height:p,margin:g,pageRanges:m,preferCSSPageSize:b,omitBackground:h,tagged:E,outline:w,waitForFonts:S}=WE(e);h&&await n(this,xe).setTransparentBackgroundColor(),S&&await nt(ue(this.mainFrame().isolatedRealm().evaluate(()=>document.fonts.ready)).pipe(to(oo(a))));const C=n(this,ne).send("Page.printToPDF",{transferMode:"ReturnAsStream",landscape:i,displayHeaderFooter:r,headerTemplate:s,footerTemplate:l,printBackground:d,scale:c,paperWidth:u,paperHeight:p,marginTop:g.top,marginBottom:g.bottom,marginLeft:g.left,marginRight:g.right,pageRanges:m,preferCSSPageSize:b,generateTaggedPDF:E,generateDocumentOutline:w}),R=await nt(ue(C).pipe(to(oo(a))));return h&&await n(this,xe).resetDefaultBackgroundColor(),$(R.stream,"`stream` is missing from `Page.printToPDF"),await zf(n(this,ne),R.stream)}async pdf(e={}){const{path:a=void 0}=e,i=await this.createPDFStream(e),r=await Mf(i,a);return $(r,"Could not create buffer"),r}async close(e={runBeforeUnload:void 0}){const a={stack:[],error:void 0,hasError:!1};try{const i=Cu(a,await this.browserContext().waitForScreenshotOperations(),!1),r=n(this,ne).connection();$(r,"Protocol error: Connection closed. Most likely the page has been closed."),!!e.runBeforeUnload?await n(this,ne).send("Page.close"):(await r.send("Target.closeTarget",{targetId:n(this,Bt)._targetId}),await n(this,Ki)._isClosedDeferred.valueOrThrow())}catch(i){a.error=i,a.hasError=!0}finally{Ru(a)}}isClosed(){return n(this,gc)}get mouse(){return n(this,zs)}async waitForDevicePrompt(e={}){return await this.mainFrame().waitForDevicePrompt(e)}};gc=new WeakMap,wa=new WeakMap,ne=new WeakMap,Bt=new WeakMap,Ia=new WeakMap,Ki=new WeakMap,Sa=new WeakMap,zs=new WeakMap,Ls=new WeakMap,pe=new WeakMap,xe=new WeakMap,Ns=new WeakMap,Aa=new WeakMap,Ps=new WeakMap,Bs=new WeakMap,ks=new WeakMap,qi=new WeakMap,Ro=new WeakMap,Yd=new WeakMap,fc=new WeakMap,hc=new WeakMap,Zd=new WeakMap,Xd=new WeakMap,Jd=new WeakMap,te=new WeakSet,Kh=function(){const e=[];for(const i of n(this,wa).getChildTargets(n(this,Bt)))e.push(i);let a=0;for(;a<e.length;){const i=e[a];a++;const r=i._session();r&&n(this,Fs).call(this,r);for(const s of n(this,wa).getChildTargets(i))e.push(s)}},qh=async function(e){v(this,ne,e),$(n(this,ne)instanceof Ar,"CDPSession is not instance of CDPSessionImpl"),v(this,Bt,n(this,ne)._target()),$(n(this,Bt),"Missing target on swap"),n(this,Sa).updateClient(e),n(this,zs).updateClient(e),n(this,Ls).updateClient(e),n(this,xe).updateClient(e),n(this,Ns).updateClient(e),n(this,Bs).updateClient(e),await n(this,pe).swapFrameTree(e),T(this,te,Rp).call(this)},Yh=async function(e){$(e instanceof Ar),e._target()._subtype()==="prerender"&&(n(this,pe).registerSpeculativeSession(e).catch(X),n(this,xe).registerSpeculativeSession(e).catch(X))},Rp=function(){n(this,ne).on(ve.Ready,n(this,Fs));for(const[e,a]of n(this,Jd))n(this,ne).on(e,a)},vc=new WeakMap,Fs=new WeakMap,Zh=async function(){try{await Promise.all([n(this,pe).initialize(n(this,ne)),n(this,ne).send("Performance.enable"),n(this,ne).send("Log.enable")])}catch(e){if(ro(e)&&ju(e))X(e);else throw e}},Xh=async function(e){const a={stack:[],error:void 0,hasError:!1};try{if(!n(this,Ro).size)return;const i=n(this,pe).frame(e.frameId);$(i,"This should never happen.");const r=Cu(a,await i.worlds[Gt].adoptBackendNode(e.backendNodeId),!1),s=new fb(r.move(),e);for(const l of n(this,Ro))l.resolve(s);n(this,Ro).clear()}catch(i){a.error=i,a.hasError=!0}finally{Ru(a)}},Jh=function(){this.emit("error",new Error("Page crashed!"))},Qh=function(e){const{level:a,text:i,args:r,source:s,url:l,lineNumber:d}=e.entry;r&&r.map(c=>{rh(n(this,ne),c)}),s!=="worker"&&this.emit("console",new Dm(_u(a),i,[],[{url:l,lineNumber:d}]))},e0=function(e){this.emit("metrics",{title:e.title,metrics:T(this,te,_p).call(this,e.metrics)})},_p=function(e){const a={};for(const i of e||[])ky.has(i.name)&&(a[i.name]=i.value);return a},Op=function(e){this.emit("pageerror",sy(e.exceptionDetails))},t0=function(e,a){const i=a.args.map(r=>e.createCdpHandle(r));T(this,te,Dp).call(this,_u(a.type),i,a.stackTrace)},o0=async function(e,a){let i;try{i=JSON.parse(a.payload)}catch{return}const{type:r,name:s,seq:l,args:d,isTrivial:c}=i;if(r!=="exposedFun")return;const u=e.context;if(!u)return;const p=n(this,Aa).get(s);await(p==null?void 0:p.run(u,l,d,c))},Dp=function(e,a,i){if(!this.listenerCount("console")){a.forEach(d=>d.dispose());return}const r=[];for(const d of a){const c=d.remoteObject();c.objectId?r.push(d.toString()):r.push(or(c))}const s=[];if(i)for(const d of i.callFrames)s.push({url:d.url,lineNumber:d.lineNumber,columnNumber:d.columnNumber});const l=new Dm(_u(e),r.join(" "),a,s);this.emit("console",l)},a0=function(e){const a=jE(e.type),i=new xb(n(this,ne),a,e.message,e.defaultPrompt);this.emit("dialog",i)},Mp=async function(e,a){const i=await n(this,ne).send("Page.getNavigationHistory"),r=i.entries[i.currentIndex+e];return r?(await Promise.all([this.waitForNavigation(a),n(this,ne).send("Page.navigateToHistoryEntry",{entryId:r.id})]))[0]:null};let Cn=nm;const ky=new Set(["Timestamp","Documents","Frames","JSEventListeners","Nodes","LayoutCount","RecalcStyleCount","LayoutDuration","RecalcStyleDuration","ScriptDuration","TaskDuration","JSHeapUsedSize","JSHeapTotalSize"]);function Fy(t,o){const e=Math.max(t.x,o.x),a=Math.max(t.y,o.y);return{x:e,y:a,width:Math.max(Math.min(t.x+t.width,o.x+o.width)-e,0),height:Math.max(Math.min(t.y+t.height,o.y+o.height)-a,0)}}/**
 * @license
 * Copyright 2019 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var St;(function(t){t.SUCCESS="success",t.ABORTED="aborted"})(St||(St={}));var xa,Ca,eo,$s,Ra,Us;class du extends JE{constructor(e,a,i,r,s){super();f(this,xa);f(this,Ca);f(this,eo);f(this,$s);f(this,Ra);f(this,Us,new Set);O(this,"_initializedDeferred",me.create());O(this,"_isClosedDeferred",me.create());O(this,"_targetId");v(this,Ca,a),v(this,$s,r),v(this,eo,e),v(this,xa,i),this._targetId=e.targetId,v(this,Ra,s),n(this,Ca)&&n(this,Ca)instanceof Ar&&n(this,Ca)._setTarget(this)}async asPage(){const e=this._session();return e?await Cn._create(e,this,null):await this.createCDPSession().then(a=>Cn._create(a,this,null))}_subtype(){return n(this,eo).subtype}_session(){return n(this,Ca)}_addChildTarget(e){n(this,Us).add(e)}_removeChildTarget(e){n(this,Us).delete(e)}_childTargets(){return n(this,Us)}_sessionFactory(){if(!n(this,Ra))throw new Error("sessionFactory is not initialized");return n(this,Ra)}createCDPSession(){if(!n(this,Ra))throw new Error("sessionFactory is not initialized");return n(this,Ra).call(this,!1).then(e=>(e._setTarget(this),e))}url(){return n(this,eo).url}type(){switch(n(this,eo).type){case"page":return bt.PAGE;case"background_page":return bt.BACKGROUND_PAGE;case"service_worker":return bt.SERVICE_WORKER;case"shared_worker":return bt.SHARED_WORKER;case"browser":return bt.BROWSER;case"webview":return bt.WEBVIEW;case"tab":return bt.TAB;default:return bt.OTHER}}_targetManager(){if(!n(this,$s))throw new Error("targetManager is not initialized");return n(this,$s)}_getTargetInfo(){return n(this,eo)}browser(){if(!n(this,xa))throw new Error("browserContext is not initialized");return n(this,xa).browser()}browserContext(){if(!n(this,xa))throw new Error("browserContext is not initialized");return n(this,xa)}opener(){const{openerId:e}=n(this,eo);if(e)return this.browser().targets().find(a=>a._targetId===e)}_targetInfoChanged(e){v(this,eo,e),this._checkIfInitialized()}_initialize(){this._initializedDeferred.resolve(St.SUCCESS)}_isTargetExposed(){return this.type()!==bt.TAB&&!this._subtype()}_checkIfInitialized(){this._initializedDeferred.resolved()||this._initializedDeferred.resolve(St.SUCCESS)}}xa=new WeakMap,Ca=new WeakMap,eo=new WeakMap,$s=new WeakMap,Ra=new WeakMap,Us=new WeakMap;var Ec;const lm=class lm extends du{constructor(e,a,i,r,s,l){super(e,a,i,r,s);f(this,Ec);O(this,"pagePromise");v(this,Ec,l??void 0)}_initialize(){this._initializedDeferred.valueOrThrow().then(async e=>{if(e===St.ABORTED)return;const a=this.opener();if(!(a instanceof lm))return;if(!a||!a.pagePromise||this.type()!=="page")return!0;const i=await a.pagePromise;if(!i.listenerCount("popup"))return!0;const r=await this.page();return i.emit("popup",r),!0}).catch(X),this._checkIfInitialized()}async page(){if(!this.pagePromise){const e=this._session();this.pagePromise=(e?Promise.resolve(e):this._sessionFactory()(!1)).then(a=>Cn._create(a,this,n(this,Ec)??null))}return await this.pagePromise??null}_checkIfInitialized(){this._initializedDeferred.resolved()||this._getTargetInfo().url!==""&&this._initializedDeferred.resolve(St.SUCCESS)}};Ec=new WeakMap;let Dd=lm;class $y extends Dd{}var js;class Uy extends du{constructor(){super(...arguments);f(this,js)}async worker(){if(!n(this,js)){const e=this._session();v(this,js,(e?Promise.resolve(e):this._sessionFactory()(!1)).then(a=>new Gh(a,this._getTargetInfo().url,this._targetId,this.type(),()=>{},()=>{})))}return await n(this,js)}}js=new WeakMap;class jy extends du{}/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */function Hy(t,o){return!!t._subtype()&&!o.subtype}var Oe,_a,De,Yi,bc,Oa,Zi,Xi,Da,yc,Ji,Tc,Hs,Qd,lt,zp,Lp,wc,Ic,Sc,Ac,eu,br,tu;class Vy extends Ie{constructor(e,a,i,r=!0){super();f(this,lt);f(this,Oe);f(this,_a,new Map);f(this,De,new Map);f(this,Yi,new Map);f(this,bc,new Set);f(this,Oa);f(this,Zi);f(this,Xi,new WeakMap);f(this,Da,new WeakMap);f(this,yc,me.create());f(this,Ji,new Set);f(this,Tc,!0);f(this,Hs,[{}]);f(this,Qd,()=>{if(n(this,Tc))for(const[e,a]of n(this,_a).entries()){const i=new du(a,void 0,void 0,this,void 0),r=a.type==="browser"||a.url.startsWith("chrome-extension://");(!n(this,Oa)||n(this,Oa).call(this,i))&&!r&&n(this,Ji).add(e)}});f(this,wc,e=>{T(this,lt,Lp).call(this,e)});f(this,Ic,async e=>{if(n(this,_a).set(e.targetInfo.targetId,e.targetInfo),this.emit("targetDiscovered",e.targetInfo),e.targetInfo.type==="browser"&&e.targetInfo.attached){if(n(this,De).has(e.targetInfo.targetId))return;const a=n(this,Zi).call(this,e.targetInfo,void 0);a._initialize(),n(this,De).set(e.targetInfo.targetId,a)}});f(this,Sc,e=>{const a=n(this,_a).get(e.targetId);if(n(this,_a).delete(e.targetId),T(this,lt,br).call(this,e.targetId),(a==null?void 0:a.type)==="service_worker"&&n(this,De).has(e.targetId)){const i=n(this,De).get(e.targetId);i&&(this.emit("targetGone",i),n(this,De).delete(e.targetId))}});f(this,Ac,e=>{var s;if(n(this,_a).set(e.targetInfo.targetId,e.targetInfo),n(this,bc).has(e.targetInfo.targetId)||!n(this,De).has(e.targetInfo.targetId)||!e.targetInfo.attached)return;const a=n(this,De).get(e.targetInfo.targetId);if(!a)return;const i=a.url(),r=a._initializedDeferred.value()===St.SUCCESS;if(Hy(a,e.targetInfo)){const l=a==null?void 0:a._session();$(l,"Target that is being activated is missing a CDPSession."),(s=l.parentSession())==null||s.emit(ve.Swapped,l)}a._targetInfoChanged(e.targetInfo),r&&i!==a.url()&&this.emit("targetChanged",{target:a,wasInitialized:r,previousURL:i})});f(this,eu,async(e,a)=>{const i=a.targetInfo,r=n(this,Oe).session(a.sessionId);if(!r)throw new Error(`Session ${a.sessionId} was not created.`);const s=async()=>{await r.send("Runtime.runIfWaitingForDebugger").catch(X),await e.send("Target.detachFromTarget",{sessionId:r.id()}).catch(X)};if(!n(this,Oe).isAutoAttached(i.targetId))return;if(i.type==="service_worker"){if(T(this,lt,br).call(this,i.targetId),await s(),n(this,De).has(i.targetId))return;const u=n(this,Zi).call(this,i);u._initialize(),n(this,De).set(i.targetId,u),this.emit("targetAvailable",u);return}const l=n(this,De).has(i.targetId),d=l?n(this,De).get(i.targetId):n(this,Zi).call(this,i,r,e instanceof ad?e:void 0);if(n(this,Oa)&&!n(this,Oa).call(this,d)){n(this,bc).add(i.targetId),T(this,lt,br).call(this,i.targetId),await s();return}T(this,lt,zp).call(this,r),l?(r._setTarget(d),n(this,Yi).set(r.id(),n(this,De).get(i.targetId))):(d._initialize(),n(this,De).set(i.targetId,d),n(this,Yi).set(r.id(),d));const c=e instanceof ad?e._target():null;c==null||c._addChildTarget(d),e.emit(ve.Ready,r),n(this,Ji).delete(d._targetId),l||this.emit("targetAvailable",d),T(this,lt,br).call(this),await Promise.all([r.send("Target.setAutoAttach",{waitForDebuggerOnStart:!0,flatten:!0,autoAttach:!0,filter:n(this,Hs)}),r.send("Runtime.runIfWaitingForDebugger")]).catch(X)});f(this,tu,(e,a)=>{const i=n(this,Yi).get(a.sessionId);n(this,Yi).delete(a.sessionId),i&&(e instanceof ad&&e._target()._removeChildTarget(i),n(this,De).delete(i._targetId),this.emit("targetGone",i))});v(this,Oe,e),v(this,Oa,i),v(this,Zi,a),v(this,Tc,r),n(this,Oe).on("Target.targetCreated",n(this,Ic)),n(this,Oe).on("Target.targetDestroyed",n(this,Sc)),n(this,Oe).on("Target.targetInfoChanged",n(this,Ac)),n(this,Oe).on(ve.SessionDetached,n(this,wc)),T(this,lt,zp).call(this,n(this,Oe))}async initialize(){await n(this,Oe).send("Target.setDiscoverTargets",{discover:!0,filter:n(this,Hs)}),n(this,Qd).call(this),await n(this,Oe).send("Target.setAutoAttach",{waitForDebuggerOnStart:!0,flatten:!0,autoAttach:!0,filter:[{type:"page",exclude:!0},...n(this,Hs)]}),T(this,lt,br).call(this),await n(this,yc).valueOrThrow()}getChildTargets(e){return e._childTargets()}dispose(){n(this,Oe).off("Target.targetCreated",n(this,Ic)),n(this,Oe).off("Target.targetDestroyed",n(this,Sc)),n(this,Oe).off("Target.targetInfoChanged",n(this,Ac)),n(this,Oe).off(ve.SessionDetached,n(this,wc)),T(this,lt,Lp).call(this,n(this,Oe))}getAvailableTargets(){return n(this,De)}}Oe=new WeakMap,_a=new WeakMap,De=new WeakMap,Yi=new WeakMap,bc=new WeakMap,Oa=new WeakMap,Zi=new WeakMap,Xi=new WeakMap,Da=new WeakMap,yc=new WeakMap,Ji=new WeakMap,Tc=new WeakMap,Hs=new WeakMap,Qd=new WeakMap,lt=new WeakSet,zp=function(e){const a=r=>{n(this,eu).call(this,e,r)};$(!n(this,Xi).has(e)),n(this,Xi).set(e,a),e.on("Target.attachedToTarget",a);const i=r=>n(this,tu).call(this,e,r);$(!n(this,Da).has(e)),n(this,Da).set(e,i),e.on("Target.detachedFromTarget",i)},Lp=function(e){const a=n(this,Xi).get(e);a&&(e.off("Target.attachedToTarget",a),n(this,Xi).delete(e)),n(this,Da).has(e)&&(e.off("Target.detachedFromTarget",n(this,Da).get(e)),n(this,Da).delete(e))},wc=new WeakMap,Ic=new WeakMap,Sc=new WeakMap,Ac=new WeakMap,eu=new WeakMap,br=function(e){e!==void 0&&n(this,Ji).delete(e),n(this,Ji).size===0&&n(this,yc).resolve()},tu=new WeakMap;/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Vs,xc,Me,Cc,Ws,Gs,Ma,_o,Te,Rc,_c,ir,i0,Oc,Dc,Mc,zc,Lc,Np;const cm=class cm extends qE{constructor(e,a,i,r,s,l,d,c,u=!0,p){super();f(this,ir);O(this,"protocol","cdp");f(this,Vs);f(this,xc);f(this,Me);f(this,Cc);f(this,Ws);f(this,Gs);f(this,Ma);f(this,_o,new Map);f(this,Te);f(this,Rc);f(this,_c,()=>{this.emit("disconnected",void 0)});f(this,Oc,(e,a)=>{var d;const{browserContextId:i}=e,r=i&&n(this,_o).has(i)?n(this,_o).get(i):n(this,Ma);if(!r)throw new Error("Missing browser context");const s=c=>n(this,Me)._createSession(e,c),l=new jy(e,a,r,n(this,Te),s);return(d=e.url)!=null&&d.startsWith("devtools://")?new $y(e,a,r,n(this,Te),s,n(this,Vs)??null):n(this,Gs).call(this,l)?new Dd(e,a,r,n(this,Te),s,n(this,Vs)??null):e.type==="service_worker"||e.type==="shared_worker"?new Uy(e,a,r,n(this,Te),s):l});f(this,Dc,async e=>{e._isTargetExposed()&&await e._initializedDeferred.valueOrThrow()===St.SUCCESS&&(this.emit("targetcreated",e),e.browserContext().emit("targetcreated",e))});f(this,Mc,async e=>{e._initializedDeferred.resolve(St.ABORTED),e._isClosedDeferred.resolve(),e._isTargetExposed()&&await e._initializedDeferred.valueOrThrow()===St.SUCCESS&&(this.emit("targetdestroyed",e),e.browserContext().emit("targetdestroyed",e))});f(this,zc,({target:e})=>{this.emit("targetchanged",e),e.browserContext().emit("targetchanged",e)});f(this,Lc,e=>{this.emit("targetdiscovered",e)});e=e||"chrome",v(this,Vs,r),v(this,xc,s),v(this,Me,a),v(this,Cc,l||(()=>{})),v(this,Ws,d||(()=>!0)),T(this,ir,i0).call(this,c),e==="firefox"?v(this,Te,new qf(a,n(this,Oc),n(this,Ws))):v(this,Te,new Vy(a,n(this,Oc),n(this,Ws),u)),v(this,Ma,new wu(n(this,Me),this));for(const g of i)n(this,_o).set(g,new wu(n(this,Me),this,g));v(this,Rc,p||"unknown")}static async _create(e,a,i,r,s,l,d,c,u,p=!0,g){const m=new cm(e,a,i,s,l,d,c,u,p,g);return r&&await a.send("Security.setIgnoreCertificateErrors",{ignore:!0}),await m._attach(),m}async _attach(){n(this,Me).on(ve.Disconnected,n(this,_c)),n(this,Te).on("targetAvailable",n(this,Dc)),n(this,Te).on("targetGone",n(this,Mc)),n(this,Te).on("targetChanged",n(this,zc)),n(this,Te).on("targetDiscovered",n(this,Lc)),await n(this,Te).initialize()}_detach(){n(this,Me).off(ve.Disconnected,n(this,_c)),n(this,Te).off("targetAvailable",n(this,Dc)),n(this,Te).off("targetGone",n(this,Mc)),n(this,Te).off("targetChanged",n(this,zc)),n(this,Te).off("targetDiscovered",n(this,Lc))}process(){return n(this,xc)??null}_targetManager(){return n(this,Te)}_getIsPageTargetCallback(){return n(this,Gs)}async createBrowserContext(e={}){const{proxyServer:a,proxyBypassList:i}=e,{browserContextId:r}=await n(this,Me).send("Target.createBrowserContext",{proxyServer:a,proxyBypassList:i&&i.join(",")}),s=new wu(n(this,Me),this,r);return n(this,_o).set(r,s),s}browserContexts(){return[n(this,Ma),...Array.from(n(this,_o).values())]}defaultBrowserContext(){return n(this,Ma)}async _disposeContext(e){e&&(await n(this,Me).send("Target.disposeBrowserContext",{browserContextId:e}),n(this,_o).delete(e))}wsEndpoint(){return n(this,Me).url()}async newPage(){return await n(this,Ma).newPage()}async _createPageInContext(e){const{targetId:a}=await n(this,Me).send("Target.createTarget",{url:"about:blank",browserContextId:e||void 0}),i=await this.waitForTarget(l=>l._targetId===a);if(!i)throw new Error(`Missing target for page (id = ${a})`);if(!(await i._initializedDeferred.valueOrThrow()===St.SUCCESS))throw new Error(`Failed to create target for page (id = ${a})`);const s=await i.page();if(!s)throw new Error(`Failed to create a page for context (id = ${e})`);return s}targets(){return Array.from(n(this,Te).getAvailableTargets().values()).filter(e=>e._isTargetExposed()&&e._initializedDeferred.value()===St.SUCCESS)}target(){const e=this.targets().find(a=>a.type()==="browser");if(!e)throw new Error("Browser target is not found");return e}async version(){return(await T(this,ir,Np).call(this)).product}async userAgent(){return(await T(this,ir,Np).call(this)).userAgent}async close(){await n(this,Cc).call(null),await this.disconnect()}disconnect(){return n(this,Te).dispose(),n(this,Me).dispose(),this._detach(),Promise.resolve()}get connected(){return!n(this,Me)._closed}get debugInfo(){return{pendingProtocolErrors:n(this,Me).getPendingProtocolErrors()}}sessionId(){return n(this,Rc)}};Vs=new WeakMap,xc=new WeakMap,Me=new WeakMap,Cc=new WeakMap,Ws=new WeakMap,Gs=new WeakMap,Ma=new WeakMap,_o=new WeakMap,Te=new WeakMap,Rc=new WeakMap,_c=new WeakMap,ir=new WeakSet,i0=function(e){v(this,Gs,e||(a=>a.type()==="page"||a.type()==="background_page"||a.type()==="webview"))},Oc=new WeakMap,Dc=new WeakMap,Mc=new WeakMap,zc=new WeakMap,Lc=new WeakMap,Np=function(){return n(this,Me).send("Browser.getVersion")};let Md=cm;/**
 * @license
 * Copyright 2020 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */async function Wy(t,o,e){const{ignoreHTTPSErrors:a=!1,defaultViewport:i=FE,targetFilter:r,_isPageTarget:s,slowMo:l=0,protocolTimeout:d}=e,c=new jf(o,t,l,d),p=(await c.send("Browser.getVersion")).product.toLowerCase().includes("firefox")?"firefox":"chrome",{browserContextIds:g}=await c.send("Target.getBrowserContexts");return await Md._create(p,c,g,a,i,void 0,()=>c.send("Browser.close").catch(X),r,s)}/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const Vm=async()=>_f?(await Promise.resolve().then(()=>FT)).NodeWebSocketTransport:(await Promise.resolve().then(()=>tT)).BrowserWebSocketTransport;async function Gy(t){const{connectionTransport:o,endpointUrl:e}=await Ky(t);return await Wy(o,e,t)}async function Ky(t){const{browserWSEndpoint:o,browserURL:e,transport:a,headers:i={}}=t;if($(+!!o+ +!!e+ +!!a==1,"Exactly one of browserWSEndpoint, browserURL or transport must be passed to puppeteer.connect"),a)return{connectionTransport:a,endpointUrl:""};if(o)return{connectionTransport:await(await Vm()).create(o,i),endpointUrl:o};if(e){const r=await qy(e);return{connectionTransport:await(await Vm()).create(r),endpointUrl:r}}throw new Error("Invalid connection options")}async function qy(t){const o=new URL("/json/version",t);try{const e=await globalThis.fetch(o.toString(),{method:"GET"});if(!e.ok)throw new Error(`HTTP ${e.statusText}`);return(await e.json()).webSocketDebuggerUrl}catch(e){throw ro(e)&&(e.message=`Failed to fetch browser webSocket URL from ${o}: `+e.message),e}}/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class r0{constructor(o){O(this,"_isPuppeteerCore");O(this,"_changedProduct",!1);this._isPuppeteerCore=o.isPuppeteerCore,this.connect=this.connect.bind(this)}static registerCustomQueryHandler(o,e){return this.customQueryHandlers.register(o,e)}static unregisterCustomQueryHandler(o){return this.customQueryHandlers.unregister(o)}static customQueryHandlerNames(){return this.customQueryHandlers.names()}static clearCustomQueryHandlers(){return this.customQueryHandlers.clear()}connect(o){return Gy(o)}}O(r0,"customQueryHandlers",tp);/**
 * @license
 * Copyright 2025 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const Yy=Object.freeze({width:800,height:600});async function Zy(t,o){const{ignoreHTTPSErrors:e=!1,defaultViewport:a=Yy,targetFilter:i,_isPageTarget:r,slowMo:s=0,protocolTimeout:l,sessionId:d="unknown"}=o,c=new jf("",t,s,l),p=(await c.send("Browser.getVersion")).product.toLowerCase().includes("firefox")?"firefox":"chrome",{browserContextIds:g}=await c.send("Target.getBrowserContexts");return await Md._create(p,c,g,e,a,void 0,()=>c.send("Browser.close").catch(console.log),i,r,!0,d)}/**
 * @license
 * Copyright 2025 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const Rn=4,Ed=1048575,Wm=Ed-Rn,Xy=t=>{const e=new TextEncoder().encode(t),a=new Uint8Array(Math.min(Ed,Rn+e.length));new DataView(a.buffer).setUint32(0,e.length,!0),a.set(e.slice(0,Wm),Rn);const r=[a];for(let s=Wm;s<t.length;s+=Ed)r.push(e.slice(s,s+Ed));return r},Jy=(t,o)=>{if(t.length===0)return null;const e=new Uint8Array(0),a=t[0]||e,r=new DataView(a.buffer).getUint32(0,!0);let s=-Rn;for(let l=0;l<t.length;++l){const d=t[l]||e;if(s+=d.length,s>r)throw new Error(`Should have gotten the exact number of bytes but we got more.  SessionID: ${o}`);if(s===r){const c=t.splice(0,l+1);c[0]=a.subarray(Rn);const u=new Uint8Array(r);let p=0;for(let b=0;b<=l;++b){const h=c[b]||e;u.set(h,p),p+=h.length}return new TextDecoder().decode(u)}}return null},Qy="https://fake.host";class tm{constructor(o,e){O(this,"ws");O(this,"pingInterval");O(this,"chunks",[]);O(this,"onmessage");O(this,"onclose");O(this,"sessionId");this.pingInterval=setInterval(()=>this.ws.send("ping"),1e3),this.ws=o,this.sessionId=e,this.ws.addEventListener("message",a=>{this.chunks.push(new Uint8Array(a.data));const i=Jy(this.chunks,e);i&&this.onmessage&&this.onmessage(i)}),this.ws.addEventListener("close",()=>{clearInterval(this.pingInterval),this.onclose&&this.onclose()}),this.ws.addEventListener("error",a=>{console.error(`Websocket error: SessionID: ${e}`,a),clearInterval(this.pingInterval)})}static async create(o,e){const a=`${Qy}/v1/connectDevtools?browser_session=${e}`,i=await o.fetch(a,{headers:{Upgrade:"websocket","cf-brapi-client":`@cloudflare/puppeteer@${Zp}`}});return i.webSocket.accept(),new tm(i.webSocket,e)}send(o){for(const e of Xy(o))this.ws.send(e)}close(){clearInterval(this.pingInterval),this.ws.close()}toString(){return this.sessionId}}/**
 * @license
 * Copyright 2025 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const qc="https://fake.host";class eT extends r0{constructor(){super({isPuppeteerCore:!1}),this.acquire=this.acquire.bind(this),this.connect=this.connect.bind(this),this.launch=this.launch.bind(this),this.sessions=this.sessions.bind(this),this.history=this.history.bind(this),this.limits=this.limits.bind(this)}async launch(o,e){const a=await this.acquire(o,e);return await this.connect(o,a.sessionId)}async sessions(o){const e=await o.fetch(`${qc}/v1/sessions`),a=e.status,i=await e.text();if(a!==200)throw new Error(`Unable to fetch new sessions: code: ${a}: message: ${i}`);return JSON.parse(i).sessions}async history(o){const e=await o.fetch(`${qc}/v1/history`),a=e.status,i=await e.text();if(a!==200)throw new Error(`Unable to fetch account history: code: ${a}: message: ${i}`);return JSON.parse(i).history}async limits(o){const e=await o.fetch(`${qc}/v1/limits`),a=e.status,i=await e.text();if(a!==200)throw new Error(`Unable to fetch account limits: code: ${a}: message: ${i}`);return JSON.parse(i)}async connect(o,e){try{if(!e)return await super.connect(o);const a=await tm.create(o,e);return await Zy(a,{sessionId:e})}catch(a){throw new Error(`Unable to connect to existing session ${e} (it may still be in use or not ready yet) - retry or launch a new browser: ${a}`)}}async acquire(o,e){const a=new URLSearchParams;e!=null&&e.keep_alive&&a.set("keep_alive",`${e.keep_alive}`),e!=null&&e.location&&a.set("location",e.location);const i=`${qc}/v1/acquire?${a.toString()}`,r=await o.fetch(i),s=r.status,l=await r.text();if(s!==200)throw new Error(`Unable to create new browser: code: ${s}: message: ${l}`);return JSON.parse(l)}}var Oo;const dm=class dm{constructor(o){f(this,Oo);O(this,"onmessage");O(this,"onclose");v(this,Oo,o),n(this,Oo).addEventListener("message",e=>{this.onmessage&&this.onmessage.call(null,e.data)}),n(this,Oo).addEventListener("close",()=>{this.onclose&&this.onclose.call(null)}),n(this,Oo).addEventListener("error",()=>{})}static create(o){return new Promise((e,a)=>{const i=new WebSocket(o);i.addEventListener("open",()=>e(new dm(i))),i.addEventListener("error",a)})}send(o){n(this,Oo).send(o)}close(){n(this,Oo).close()}};Oo=new WeakMap;let Pp=dm;const tT=Object.freeze(Object.defineProperty({__proto__:null,BrowserWebSocketTransport:Pp},Symbol.toStringTag,{value:"Module"}));/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const oT=[{name:"Blackberry PlayBook",userAgent:"Mozilla/5.0 (PlayBook; U; RIM Tablet OS 2.1.0; en-US) AppleWebKit/536.2+ (KHTML like Gecko) Version/7.2.1.0 Safari/536.2+",viewport:{width:600,height:1024,deviceScaleFactor:1,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Blackberry PlayBook landscape",userAgent:"Mozilla/5.0 (PlayBook; U; RIM Tablet OS 2.1.0; en-US) AppleWebKit/536.2+ (KHTML like Gecko) Version/7.2.1.0 Safari/536.2+",viewport:{width:1024,height:600,deviceScaleFactor:1,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"BlackBerry Z30",userAgent:"Mozilla/5.0 (BB10; Touch) AppleWebKit/537.10+ (KHTML, like Gecko) Version/10.0.9.2372 Mobile Safari/537.10+",viewport:{width:360,height:640,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"BlackBerry Z30 landscape",userAgent:"Mozilla/5.0 (BB10; Touch) AppleWebKit/537.10+ (KHTML, like Gecko) Version/10.0.9.2372 Mobile Safari/537.10+",viewport:{width:640,height:360,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Galaxy Note 3",userAgent:"Mozilla/5.0 (Linux; U; Android 4.3; en-us; SM-N900T Build/JSS15J) AppleWebKit/534.30 (KHTML, like Gecko) Version/4.0 Mobile Safari/534.30",viewport:{width:360,height:640,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Galaxy Note 3 landscape",userAgent:"Mozilla/5.0 (Linux; U; Android 4.3; en-us; SM-N900T Build/JSS15J) AppleWebKit/534.30 (KHTML, like Gecko) Version/4.0 Mobile Safari/534.30",viewport:{width:640,height:360,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Galaxy Note II",userAgent:"Mozilla/5.0 (Linux; U; Android 4.1; en-us; GT-N7100 Build/JRO03C) AppleWebKit/534.30 (KHTML, like Gecko) Version/4.0 Mobile Safari/534.30",viewport:{width:360,height:640,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Galaxy Note II landscape",userAgent:"Mozilla/5.0 (Linux; U; Android 4.1; en-us; GT-N7100 Build/JRO03C) AppleWebKit/534.30 (KHTML, like Gecko) Version/4.0 Mobile Safari/534.30",viewport:{width:640,height:360,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Galaxy S III",userAgent:"Mozilla/5.0 (Linux; U; Android 4.0; en-us; GT-I9300 Build/IMM76D) AppleWebKit/534.30 (KHTML, like Gecko) Version/4.0 Mobile Safari/534.30",viewport:{width:360,height:640,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Galaxy S III landscape",userAgent:"Mozilla/5.0 (Linux; U; Android 4.0; en-us; GT-I9300 Build/IMM76D) AppleWebKit/534.30 (KHTML, like Gecko) Version/4.0 Mobile Safari/534.30",viewport:{width:640,height:360,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Galaxy S5",userAgent:"Mozilla/5.0 (Linux; Android 5.0; SM-G900P Build/LRX21T) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:360,height:640,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Galaxy S5 landscape",userAgent:"Mozilla/5.0 (Linux; Android 5.0; SM-G900P Build/LRX21T) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:640,height:360,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Galaxy S8",userAgent:"Mozilla/5.0 (Linux; Android 7.0; SM-G950U Build/NRD90M) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.84 Mobile Safari/537.36",viewport:{width:360,height:740,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Galaxy S8 landscape",userAgent:"Mozilla/5.0 (Linux; Android 7.0; SM-G950U Build/NRD90M) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.84 Mobile Safari/537.36",viewport:{width:740,height:360,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Galaxy S9+",userAgent:"Mozilla/5.0 (Linux; Android 8.0.0; SM-G965U Build/R16NW) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.111 Mobile Safari/537.36",viewport:{width:320,height:658,deviceScaleFactor:4.5,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Galaxy S9+ landscape",userAgent:"Mozilla/5.0 (Linux; Android 8.0.0; SM-G965U Build/R16NW) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.111 Mobile Safari/537.36",viewport:{width:658,height:320,deviceScaleFactor:4.5,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Galaxy Tab S4",userAgent:"Mozilla/5.0 (Linux; Android 8.1.0; SM-T837A) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.80 Safari/537.36",viewport:{width:712,height:1138,deviceScaleFactor:2.25,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Galaxy Tab S4 landscape",userAgent:"Mozilla/5.0 (Linux; Android 8.1.0; SM-T837A) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.80 Safari/537.36",viewport:{width:1138,height:712,deviceScaleFactor:2.25,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPad",userAgent:"Mozilla/5.0 (iPad; CPU OS 11_0 like Mac OS X) AppleWebKit/604.1.34 (KHTML, like Gecko) Version/11.0 Mobile/15A5341f Safari/604.1",viewport:{width:768,height:1024,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPad landscape",userAgent:"Mozilla/5.0 (iPad; CPU OS 11_0 like Mac OS X) AppleWebKit/604.1.34 (KHTML, like Gecko) Version/11.0 Mobile/15A5341f Safari/604.1",viewport:{width:1024,height:768,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPad (gen 6)",userAgent:"Mozilla/5.0 (iPad; CPU OS 12_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:768,height:1024,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPad (gen 6) landscape",userAgent:"Mozilla/5.0 (iPad; CPU OS 12_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:1024,height:768,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPad (gen 7)",userAgent:"Mozilla/5.0 (iPad; CPU OS 12_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:810,height:1080,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPad (gen 7) landscape",userAgent:"Mozilla/5.0 (iPad; CPU OS 12_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:1080,height:810,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPad Mini",userAgent:"Mozilla/5.0 (iPad; CPU OS 11_0 like Mac OS X) AppleWebKit/604.1.34 (KHTML, like Gecko) Version/11.0 Mobile/15A5341f Safari/604.1",viewport:{width:768,height:1024,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPad Mini landscape",userAgent:"Mozilla/5.0 (iPad; CPU OS 11_0 like Mac OS X) AppleWebKit/604.1.34 (KHTML, like Gecko) Version/11.0 Mobile/15A5341f Safari/604.1",viewport:{width:1024,height:768,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPad Pro",userAgent:"Mozilla/5.0 (iPad; CPU OS 11_0 like Mac OS X) AppleWebKit/604.1.34 (KHTML, like Gecko) Version/11.0 Mobile/15A5341f Safari/604.1",viewport:{width:1024,height:1366,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPad Pro landscape",userAgent:"Mozilla/5.0 (iPad; CPU OS 11_0 like Mac OS X) AppleWebKit/604.1.34 (KHTML, like Gecko) Version/11.0 Mobile/15A5341f Safari/604.1",viewport:{width:1366,height:1024,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPad Pro 11",userAgent:"Mozilla/5.0 (iPad; CPU OS 12_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:834,height:1194,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPad Pro 11 landscape",userAgent:"Mozilla/5.0 (iPad; CPU OS 12_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:1194,height:834,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 4",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 7_1_2 like Mac OS X) AppleWebKit/537.51.2 (KHTML, like Gecko) Version/7.0 Mobile/11D257 Safari/9537.53",viewport:{width:320,height:480,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 4 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 7_1_2 like Mac OS X) AppleWebKit/537.51.2 (KHTML, like Gecko) Version/7.0 Mobile/11D257 Safari/9537.53",viewport:{width:480,height:320,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 5",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_1 like Mac OS X) AppleWebKit/603.1.30 (KHTML, like Gecko) Version/10.0 Mobile/14E304 Safari/602.1",viewport:{width:320,height:568,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 5 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_1 like Mac OS X) AppleWebKit/603.1.30 (KHTML, like Gecko) Version/10.0 Mobile/14E304 Safari/602.1",viewport:{width:568,height:320,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 6",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:375,height:667,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 6 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:667,height:375,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 6 Plus",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:414,height:736,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 6 Plus landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:736,height:414,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 7",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:375,height:667,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 7 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:667,height:375,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 7 Plus",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:414,height:736,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 7 Plus landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:736,height:414,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 8",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:375,height:667,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 8 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:667,height:375,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 8 Plus",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:414,height:736,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 8 Plus landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:736,height:414,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone SE",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_1 like Mac OS X) AppleWebKit/603.1.30 (KHTML, like Gecko) Version/10.0 Mobile/14E304 Safari/602.1",viewport:{width:320,height:568,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone SE landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_1 like Mac OS X) AppleWebKit/603.1.30 (KHTML, like Gecko) Version/10.0 Mobile/14E304 Safari/602.1",viewport:{width:568,height:320,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone X",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:375,height:812,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone X landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:812,height:375,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone XR",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 12_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0 Mobile/15E148 Safari/604.1",viewport:{width:414,height:896,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone XR landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 12_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0 Mobile/15E148 Safari/604.1",viewport:{width:896,height:414,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 11",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 13_7 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1 Mobile/15E148 Safari/604.1",viewport:{width:414,height:828,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 11 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 13_7 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1 Mobile/15E148 Safari/604.1",viewport:{width:828,height:414,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 11 Pro",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 13_7 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1 Mobile/15E148 Safari/604.1",viewport:{width:375,height:812,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 11 Pro landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 13_7 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1 Mobile/15E148 Safari/604.1",viewport:{width:812,height:375,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 11 Pro Max",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 13_7 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1 Mobile/15E148 Safari/604.1",viewport:{width:414,height:896,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 11 Pro Max landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 13_7 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1 Mobile/15E148 Safari/604.1",viewport:{width:896,height:414,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 12",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 14_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:390,height:844,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 12 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 14_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:844,height:390,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 12 Pro",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 14_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:390,height:844,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 12 Pro landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 14_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:844,height:390,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 12 Pro Max",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 14_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:428,height:926,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 12 Pro Max landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 14_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:926,height:428,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 12 Mini",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 14_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:375,height:812,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 12 Mini landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 14_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:812,height:375,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 13",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:390,height:844,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 13 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:844,height:390,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 13 Pro",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:390,height:844,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 13 Pro landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:844,height:390,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 13 Pro Max",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:428,height:926,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 13 Pro Max landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:926,height:428,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 13 Mini",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:375,height:812,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 13 Mini landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:812,height:375,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 14",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1",viewport:{width:390,height:663,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 14 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1",viewport:{width:750,height:340,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 14 Plus",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1",viewport:{width:428,height:745,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 14 Plus landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1",viewport:{width:832,height:378,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 14 Pro",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1",viewport:{width:393,height:659,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 14 Pro landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1",viewport:{width:734,height:343,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 14 Pro Max",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1",viewport:{width:430,height:739,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 14 Pro Max landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1",viewport:{width:814,height:380,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 15",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 17_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E148 Safari/604.1",viewport:{width:393,height:659,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 15 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 17_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E148 Safari/604.1",viewport:{width:734,height:343,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 15 Plus",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 17_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E148 Safari/604.1",viewport:{width:430,height:739,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 15 Plus landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 17_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E148 Safari/604.1",viewport:{width:814,height:380,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 15 Pro",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 17_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E148 Safari/604.1",viewport:{width:393,height:659,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 15 Pro landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 17_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E148 Safari/604.1",viewport:{width:734,height:343,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 15 Pro Max",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 17_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E148 Safari/604.1",viewport:{width:430,height:739,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 15 Pro Max landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 17_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E148 Safari/604.1",viewport:{width:814,height:380,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"JioPhone 2",userAgent:"Mozilla/5.0 (Mobile; LYF/F300B/LYF-F300B-001-01-15-130718-i;Android; rv:48.0) Gecko/48.0 Firefox/48.0 KAIOS/2.5",viewport:{width:240,height:320,deviceScaleFactor:1,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"JioPhone 2 landscape",userAgent:"Mozilla/5.0 (Mobile; LYF/F300B/LYF-F300B-001-01-15-130718-i;Android; rv:48.0) Gecko/48.0 Firefox/48.0 KAIOS/2.5",viewport:{width:320,height:240,deviceScaleFactor:1,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Kindle Fire HDX",userAgent:"Mozilla/5.0 (Linux; U; en-us; KFAPWI Build/JDQ39) AppleWebKit/535.19 (KHTML, like Gecko) Silk/3.13 Safari/535.19 Silk-Accelerated=true",viewport:{width:800,height:1280,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Kindle Fire HDX landscape",userAgent:"Mozilla/5.0 (Linux; U; en-us; KFAPWI Build/JDQ39) AppleWebKit/535.19 (KHTML, like Gecko) Silk/3.13 Safari/535.19 Silk-Accelerated=true",viewport:{width:1280,height:800,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"LG Optimus L70",userAgent:"Mozilla/5.0 (Linux; U; Android 4.4.2; en-us; LGMS323 Build/KOT49I.MS32310c) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:384,height:640,deviceScaleFactor:1.25,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"LG Optimus L70 landscape",userAgent:"Mozilla/5.0 (Linux; U; Android 4.4.2; en-us; LGMS323 Build/KOT49I.MS32310c) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:640,height:384,deviceScaleFactor:1.25,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Microsoft Lumia 550",userAgent:"Mozilla/5.0 (Windows Phone 10.0; Android 4.2.1; Microsoft; Lumia 550) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2486.0 Mobile Safari/537.36 Edge/14.14263",viewport:{width:640,height:360,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Microsoft Lumia 950",userAgent:"Mozilla/5.0 (Windows Phone 10.0; Android 4.2.1; Microsoft; Lumia 950) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2486.0 Mobile Safari/537.36 Edge/14.14263",viewport:{width:360,height:640,deviceScaleFactor:4,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Microsoft Lumia 950 landscape",userAgent:"Mozilla/5.0 (Windows Phone 10.0; Android 4.2.1; Microsoft; Lumia 950) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2486.0 Mobile Safari/537.36 Edge/14.14263",viewport:{width:640,height:360,deviceScaleFactor:4,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Nexus 10",userAgent:"Mozilla/5.0 (Linux; Android 6.0.1; Nexus 10 Build/MOB31T) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Safari/537.36",viewport:{width:800,height:1280,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Nexus 10 landscape",userAgent:"Mozilla/5.0 (Linux; Android 6.0.1; Nexus 10 Build/MOB31T) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Safari/537.36",viewport:{width:1280,height:800,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Nexus 4",userAgent:"Mozilla/5.0 (Linux; Android 4.4.2; Nexus 4 Build/KOT49H) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:384,height:640,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Nexus 4 landscape",userAgent:"Mozilla/5.0 (Linux; Android 4.4.2; Nexus 4 Build/KOT49H) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:640,height:384,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Nexus 5",userAgent:"Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:360,height:640,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Nexus 5 landscape",userAgent:"Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:640,height:360,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Nexus 5X",userAgent:"Mozilla/5.0 (Linux; Android 8.0.0; Nexus 5X Build/OPR4.170623.006) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:412,height:732,deviceScaleFactor:2.625,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Nexus 5X landscape",userAgent:"Mozilla/5.0 (Linux; Android 8.0.0; Nexus 5X Build/OPR4.170623.006) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:732,height:412,deviceScaleFactor:2.625,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Nexus 6",userAgent:"Mozilla/5.0 (Linux; Android 7.1.1; Nexus 6 Build/N6F26U) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:412,height:732,deviceScaleFactor:3.5,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Nexus 6 landscape",userAgent:"Mozilla/5.0 (Linux; Android 7.1.1; Nexus 6 Build/N6F26U) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:732,height:412,deviceScaleFactor:3.5,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Nexus 6P",userAgent:"Mozilla/5.0 (Linux; Android 8.0.0; Nexus 6P Build/OPP3.170518.006) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:412,height:732,deviceScaleFactor:3.5,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Nexus 6P landscape",userAgent:"Mozilla/5.0 (Linux; Android 8.0.0; Nexus 6P Build/OPP3.170518.006) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:732,height:412,deviceScaleFactor:3.5,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Nexus 7",userAgent:"Mozilla/5.0 (Linux; Android 6.0.1; Nexus 7 Build/MOB30X) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Safari/537.36",viewport:{width:600,height:960,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Nexus 7 landscape",userAgent:"Mozilla/5.0 (Linux; Android 6.0.1; Nexus 7 Build/MOB30X) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Safari/537.36",viewport:{width:960,height:600,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Nokia Lumia 520",userAgent:"Mozilla/5.0 (compatible; MSIE 10.0; Windows Phone 8.0; Trident/6.0; IEMobile/10.0; ARM; Touch; NOKIA; Lumia 520)",viewport:{width:320,height:533,deviceScaleFactor:1.5,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Nokia Lumia 520 landscape",userAgent:"Mozilla/5.0 (compatible; MSIE 10.0; Windows Phone 8.0; Trident/6.0; IEMobile/10.0; ARM; Touch; NOKIA; Lumia 520)",viewport:{width:533,height:320,deviceScaleFactor:1.5,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Nokia N9",userAgent:"Mozilla/5.0 (MeeGo; NokiaN9) AppleWebKit/534.13 (KHTML, like Gecko) NokiaBrowser/8.5.0 Mobile Safari/534.13",viewport:{width:480,height:854,deviceScaleFactor:1,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Nokia N9 landscape",userAgent:"Mozilla/5.0 (MeeGo; NokiaN9) AppleWebKit/534.13 (KHTML, like Gecko) NokiaBrowser/8.5.0 Mobile Safari/534.13",viewport:{width:854,height:480,deviceScaleFactor:1,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Pixel 2",userAgent:"Mozilla/5.0 (Linux; Android 8.0; Pixel 2 Build/OPD3.170816.012) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:411,height:731,deviceScaleFactor:2.625,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Pixel 2 landscape",userAgent:"Mozilla/5.0 (Linux; Android 8.0; Pixel 2 Build/OPD3.170816.012) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:731,height:411,deviceScaleFactor:2.625,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Pixel 2 XL",userAgent:"Mozilla/5.0 (Linux; Android 8.0.0; Pixel 2 XL Build/OPD1.170816.004) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:411,height:823,deviceScaleFactor:3.5,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Pixel 2 XL landscape",userAgent:"Mozilla/5.0 (Linux; Android 8.0.0; Pixel 2 XL Build/OPD1.170816.004) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:823,height:411,deviceScaleFactor:3.5,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Pixel 3",userAgent:"Mozilla/5.0 (Linux; Android 9; Pixel 3 Build/PQ1A.181105.017.A1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.158 Mobile Safari/537.36",viewport:{width:393,height:786,deviceScaleFactor:2.75,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Pixel 3 landscape",userAgent:"Mozilla/5.0 (Linux; Android 9; Pixel 3 Build/PQ1A.181105.017.A1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.158 Mobile Safari/537.36",viewport:{width:786,height:393,deviceScaleFactor:2.75,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Pixel 4",userAgent:"Mozilla/5.0 (Linux; Android 10; Pixel 4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Mobile Safari/537.36",viewport:{width:353,height:745,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Pixel 4 landscape",userAgent:"Mozilla/5.0 (Linux; Android 10; Pixel 4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Mobile Safari/537.36",viewport:{width:745,height:353,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Pixel 4a (5G)",userAgent:"Mozilla/5.0 (Linux; Android 11; Pixel 4a (5G)) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4812.0 Mobile Safari/537.36",viewport:{width:353,height:745,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Pixel 4a (5G) landscape",userAgent:"Mozilla/5.0 (Linux; Android 11; Pixel 4a (5G)) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4812.0 Mobile Safari/537.36",viewport:{width:745,height:353,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Pixel 5",userAgent:"Mozilla/5.0 (Linux; Android 11; Pixel 5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4812.0 Mobile Safari/537.36",viewport:{width:393,height:851,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Pixel 5 landscape",userAgent:"Mozilla/5.0 (Linux; Android 11; Pixel 5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4812.0 Mobile Safari/537.36",viewport:{width:851,height:393,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Moto G4",userAgent:"Mozilla/5.0 (Linux; Android 7.0; Moto G (4)) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4812.0 Mobile Safari/537.36",viewport:{width:360,height:640,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Moto G4 landscape",userAgent:"Mozilla/5.0 (Linux; Android 7.0; Moto G (4)) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4812.0 Mobile Safari/537.36",viewport:{width:640,height:360,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}}],s0={};for(const t of oT)s0[t.name]=t;Object.freeze(s0);/**
 * @license
 * Copyright 2025 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const n0=new eT,{connect:Tw,history:ww,launch:Iw,limits:Sw,sessions:Aw,acquire:xw}=n0;async function aT(t,o,e={}){console.log("üé® [PDF_GENERATOR] Inizio generazione PDF da HTML...");try{const a=await n0.launch(o),i=await a.newPage();console.log("üìÑ [PDF_GENERATOR] Caricamento HTML nel browser..."),await i.setContent(t,{waitUntil:"networkidle0"}),console.log("üñ®Ô∏è [PDF_GENERATOR] Generazione PDF...");const r=await i.pdf({format:e.format||"A4",printBackground:e.printBackground!==!1,margin:e.margin||{top:"20mm",right:"15mm",bottom:"20mm",left:"15mm"}});return await a.close(),console.log("‚úÖ [PDF_GENERATOR] PDF generato con successo!"),r}catch(a){throw console.error("‚ùå [PDF_GENERATOR] Errore generazione PDF:",a),new Error(`Errore generazione PDF: ${a.message}`)}}const iT={FAMILY:{nome:"eCura FAMILY",nomeCompleto:"eCura Family",dispositivo:"SiDLY CARE PRO",dispositivoDescrizione:"Dispositivo indossabile con sensori avanzati per il monitoraggio continuo della salute e localizzazione GPS",servizioDescrizione:"Servizio di teleassistenza dedicato alla famiglia, con monitoraggio dei parametri vitali e supporto per anziani",caratteristiche:["Dispositivo SiDLY CARE PRO in comodato d'uso","Monitoraggio parametri vitali (frequenza cardiaca, pressione, temperatura)","Localizzazione GPS per sicurezza e tranquillit√†","App dedicata per familiari","Supporto tecnico e assistenza"]},PRO:{nome:"eCura PRO",nomeCompleto:"eCura PRO",dispositivo:"SiDLY CARE PRO",dispositivoDescrizione:"Sistema di telemonitoraggio professionale con centrale operativa avanzata e sensori medicali certificati",servizioDescrizione:"Soluzione professionale per il monitoraggio remoto della salute con dispositivo medicale certificato e servizi avanzati",caratteristiche:["Dispositivo SiDLY CARE PRO certificato medicale","Monitoraggio continuo parametri vitali avanzati","Sistema di allarme automatico","Storico completo dei dati sanitari","Integrazione con sistemi sanitari","Supporto tecnico dedicato"]},PREMIUM:{nome:"eCura PREMIUM",nomeCompleto:"eCura Premium",dispositivo:"SiDLY VITAL CARE",dispositivoDescrizione:"Dispositivo medicale premium con sensori di ultima generazione per monitoraggio completo e telediagnosi",servizioDescrizione:"Servizio premium completo con dispositivo SiDLY VITAL CARE e supporto sanitario h24",caratteristiche:["Dispositivo SiDLY VITAL CARE top di gamma","Monitoraggio completo parametri vitali","Telediagnosi con medici specialisti","Analisi predittiva con AI","Report sanitari periodici","Consulenza medica prioritaria","Assistenza premium dedicata"]}},rT={BASE:{nome:"Base",nomeCompleto:"Base con Connessione diretta h24 con i Care Giver e famigliari per 7 giorni per la durata di 12 mesi",descrizione:"Piano base con notifiche e allarmi indirizzati direttamente ai care givers e familiari",caratteristiche:["Connessione diretta h24 con Care Giver e familiari","Notifiche e allarmi 7 giorni su 7","Monitoraggio parametri vitali","App dedicata per familiari","Storico dati disponibile","Supporto tecnico per il dispositivo","Manutenzione ordinaria inclusa"],centraleOperativa:!1},AVANZATO:{nome:"Avanzato",nomeCompleto:"Avanzato con Servizi di Centrale Operativa h24 per 7 giorni per la durata di 12 mesi",descrizione:"Piano avanzato con centrale operativa attiva 24 ore su 24, 7 giorni su 7",caratteristiche:["Centrale operativa h24 365 giorni/anno","Servizi di Centrale Operativa per 7 giorni","Intervento immediato in caso di emergenza","Monitoraggio continuo parametri vitali","Allarmi automatici alla centrale","Coordinamento con servizi sanitari di emergenza","Report medici periodici","Manutenzione prioritaria"],centraleOperativa:!0}};function Bp(t){return iT[t]}function kp(t){return rT[t]}function sT(t,o){const e=Bp(t),a=kp(o);return[...e.caratteristiche,...a.caratteristiche]}class nT{static async generateContract(o,e,a){try{console.log("üìÑ [CONTRACT] Generazione contratto DOCX/PDF per:",o.leadId);const i=this.generateContractCode(),r=`CONTR_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,s={...o,codiceContratto:i,dataContratto:new Date().toLocaleDateString("it-IT")};console.log("üìÑ [CONTRACT] Generazione HTML da template professionale...");const l=this.generateContractHTMLFromTemplate(s);let d;a?(console.log("üé® [CONTRACT] Generazione PDF con Browser Rendering..."),d=await aT(l,a,{format:"A4",printBackground:!0})):(console.log("üìÑ [CONTRACT] Generazione PDF da HTML (fallback)..."),d=this.generatePDFFromHTMLFallback(l,s));const c=Buffer.from(d).toString("base64");return await e.prepare(`
        INSERT INTO contracts (
          id, lead_id, contract_code, tipo_servizio,
          prezzo_base, prezzo_iva_inclusa, status,
          pdf_url, created_at, updated_at
        ) VALUES (?, ?, ?, ?, ?, ?, 'DRAFT', ?, datetime('now'), datetime('now'))
      `).bind(r,o.leadId,i,o.tipoServizio,o.prezzoMensile*o.durataContratto,o.prezzoTotale,null).run(),console.log("‚úÖ [CONTRACT] Contratto generato:",r),{success:!0,contract:{contractId:r,codiceContratto:i,pdfBase64:c,createdAt:new Date().toISOString()}}}catch(i){return console.error("‚ùå [CONTRACT] Errore generazione contratto:",i),{success:!1,error:i instanceof Error?i.message:"Errore sconosciuto"}}}static generateContractHTMLFromTemplate(o){const e=this.getContractTemplateUnificato(),a=o.servizio||"PRO",i=o.tipoServizio,r=Bp(a),s=kp(i);sT(a,i);const l=o.prezzoTotale,d=o.prezzoMensile*12,c=new Date,u=new Date(c),p=new Date(c);p.setMonth(p.getMonth()+(o.durataContratto||12));const g=b=>{const h=String(b.getDate()).padStart(2,"0"),E=String(b.getMonth()+1).padStart(2,"0"),w=b.getFullYear();return`${h}/${E}/${w}`},m={NOME_ASSISTITO:o.nomeAssistito||o.nomeRichiedente,COGNOME_ASSISTITO:o.cognomeAssistito||o.cognomeRichiedente,LUOGO_NASCITA:o.luogoNascita||"DA COMPLETARE",DATA_NASCITA:o.dataNascita||"DA COMPLETARE",INDIRIZZO_ASSISTITO:o.indirizzoAssistito||"DA COMPLETARE",CAP_ASSISTITO:o.capAssistito||"DA COMPLETARE",CITTA_ASSISTITO:o.cittaAssistito||"DA COMPLETARE",PROVINCIA_ASSISTITO:o.provinciaAssistito||"DA COMPLETARE",CODICE_FISCALE_ASSISTITO:o.cfAssistito||"DA COMPLETARE",TELEFONO_ASSISTITO:o.telefono||"DA COMPLETARE",EMAIL_ASSISTITO:o.email,Servizio:r.nomeCompleto,Dispositivo:r.dispositivo,Piano:s.nomeCompleto,TipoPiano:o.tipoServizio,DATA_INIZIO_SERVIZIO:g(u),DATA_SCADENZA:g(p),DATA_CONTRATTO:g(c),IMPORTO_PRIMO_ANNO:l.toFixed(2),IMPORTO_ANNI_SUCCESSIVI:d.toFixed(2)};return wr.render(e,m)}static getContractTemplateUnificato(){return`<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contratto TeleMedCare</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
        }
        body {
            font-family: 'Calibri', 'Arial', sans-serif;
            font-size: 11pt;
            line-height: 1.4;
            color: #000;
            max-width: 21cm;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            font-size: 16pt;
            font-weight: bold;
            margin: 20px 0;
            text-transform: uppercase;
        }
        h2 {
            font-size: 12pt;
            font-weight: bold;
            margin: 15px 0 10px 0;
            text-decoration: underline;
        }
        p {
            margin: 8px 0;
            text-align: justify;
        }
        .bold {
            font-weight: bold;
        }
        .italic {
            font-style: italic;
        }
        .center {
            text-align: center;
        }
        .indent {
            margin-left: 30px;
        }
        .company-header {
            margin: 20px 0;
            line-height: 1.6;
        }
        .signature-section {
            margin-top: 40px;
            display: flex;
            justify-content: space-between;
        }
        .signature-box {
            width: 45%;
        }
        .footer {
            margin-top: 30px;
            font-size: 9pt;
            text-align: center;
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }
        ul {
            margin: 10px 0;
            padding-left: 30px;
        }
        li {
            margin: 5px 0;
        }
    </style>
</head>
<body>

<h1>SCRITTURA PRIVATA</h1>
<p>&nbsp;</p>
<p>Con la presente scrittura privata da valere a tutti gli effetti e conseguenze di legge tra:</p>
<p>&nbsp;</p>
<p>Medica GB S.r.l., con sede in Corso Giuseppe Garibaldi, 34 ‚Äì 20121 Milano e con Partita IVA e registro imprese 12435130963, in persona dell'Amministratore Stefania Rocca</p>
<p>&nbsp;</p>
<p class="italic center">(breviter Medica GB)</p>
<p>&nbsp;</p>
<p class="center">e</p>
<p>&nbsp;</p>
<p>Sig./Sig.ra {{NOME_ASSISTITO}} {{COGNOME_ASSISTITO}} nato/a a {{LUOGO_NASCITA}} il {{DATA_NASCITA}}, residente e domiciliato/a in {{INDIRIZZO_ASSISTITO}} - {{CAP_ASSISTITO}} {{CITTA_ASSISTITO}} ({{PROVINCIA_ASSISTITO}}) e con codice fiscale {{CODICE_FISCALE_ASSISTITO}}.</p>
<p>&nbsp;</p>
<p>Riferimenti:</p>
<p>telefono {{TELEFONO_ASSISTITO}} ‚Äì e-mail {{EMAIL_ASSISTITO}}</p>
<p>&nbsp;</p>
<p class="italic center">(breviter Il Cliente)</p>
<p>&nbsp;</p>
<p class="center">premesso che</p>
<p>&nbsp;</p>
<ul>
<li>Medica GB eroga servizi di assistenza domiciliare con tecnologie innovative, servizi di diagnostica a domicilio, esami strumentali, telemedicina, teleassistenza, telemonitoraggio e riabilitazione a domicilio.</li>
<li>Medica GB si avvale della consulenza di Medici, Terapisti, Infermieri e Operatori Socio Sanitari per erogare i servizi sopra descritti;</li>
<li>Tanto premesso,</li>
</ul>
<p>&nbsp;</p>
<p class="center">si conviene e stabilisce quanto segue</p>
<p>&nbsp;</p>
<h2>Premessa</h2>
<p>&nbsp;</p>
<p>La premessa che precede costituisce parte integrante del presente Contratto.</p>
<p>&nbsp;</p>
<h2>Oggetto del Contratto</h2>
<p>L'oggetto del presente Contratto √® l'erogazione del Servizio {{Servizio}} mediante l'utilizzo del Dispositivo {{Dispositivo}} e con il supporto del Piano {{Piano}}.</p>
<p>&nbsp;</p>
<p>Le funzioni del dispositivo {{Dispositivo}} sono le seguenti:</p>
<p>&nbsp;</p>
<p>Comunicazione vocale bidirezionale: √® possibile configurare sulla Piattaforma i contatti dei familiari oltre a quelli della Centrale Operativa ove prevista; dopo l'invio dell'allarme i familiari e/o la Centrale Operativa (piano avanzato) ricevono una chiamata dal dispositivo e possono parlare con l'assistito; in qualsiasi momento i familiari e/o la Centrale Operativa (piano avanzato) possono contattare l'assistito tramite il dispositivo.</p>
<p>&nbsp;</p>
<p>Rilevatore automatico di caduta: effettua una chiamata vocale di allarme, in caso di caduta, ai Care Givers e Famigliari (Piano Base) e alla Centrale Operativa (Piano Avanzato) e invia una notifica tramite sms ai familiari e, nel piano avanzato anche alla Centrale Operativa. Nell'sms arriver√† sia il link da cliccare per individuare la posizione dell'assistito (geolocalizzazione) che i valori dei parametri fisiologici che √® stato possibile rilevare.</p>
<p>&nbsp;</p>
<p>Posizione GPS e GPS-assistito: consente di localizzare l'assistito quando viene inviato l'allarme. √à inoltre possibile impostare una cosiddetta area sicura per l'assistito (geo-fencing).</p>
<p>&nbsp;</p>
<p>Misurazioni della frequenza cardiaca e della saturazione di ossigeno: √® possibile impostare una notifica che arrivi ai familiari e/o Centrale Operativa (ove prevista) tramite APP quando i valori rilevati vanno oltre le soglie programmate (comunicate dal proprio Medico di Base).</p>
<p>&nbsp;</p>
<p>Pulsante SOS: premendo il pulsante SOS per circa 3 secondi √® possibile effettuare una chiamata vocale ai care giver / famigliari (piano base) o alla Centrale Operativa (piano avanzato) e inviare una notifica di emergenza (geolocalizzata) ai familiari o alla Centrale Operativa stessa.</p>
<p>&nbsp;</p>
<p>Assistenza vocale: informa l'assistito in relazione ai seguenti eventi: pressione pulsante SOS, attivazione dispositivo, messa in carica del dispositivo, segnalazione di batteria scarica, ecc.</p>
<p>&nbsp;</p>
<p>Promemoria per l'assunzione dei farmaci: un messaggio ricorda l'orario in cui assumere i farmaci (aderenza terapeutica).</p>
<p>&nbsp;</p>
<h2>Durata del Servizio</h2>
<p>Il Servizio di TeleAssistenza {{Servizio}} ha una durata di 12 mesi a partire da {{DATA_INIZIO_SERVIZIO}} fino al {{DATA_SCADENZA}}.</p>
<p>&nbsp;</p>
<p>Il Contratto sar√† prorogabile su richiesta scritta del Cliente e su accettazione di Medica GB.</p>
<p>&nbsp;</p>
<h2>Tariffa del Servizio</h2>
<p>La tariffa annuale per il primo anno di attivazione del Servizio {{Servizio}} √® pari a Euro {{IMPORTO_PRIMO_ANNO}} + IVA 22% e include:</p>
<p>&nbsp;</p>
<ul>
<li>Dispositivo {{Dispositivo}}</li>
<li>Configurazione del Dispositivo e del Processo di Comunicazione con la Centrale Operativa (ove previsto) e/o uno o pi√π familiari e Piattaforma Web e APP di TeleAssistenza per la durata di 12 mesi</li>
<li>SIM per trasmissione dati e comunicazione vocale per la durata di 12 mesi</li>
<li>Piano {{Piano}}</li>
</ul>
<p>&nbsp;</p>
<p>Per i successivi anni (rinnovabili di anno in anno) la tariffa annuale per il Servizio {{Servizio}} sar√† pari a Euro {{IMPORTO_ANNI_SUCCESSIVI}} + IVA 22% con inclusi:</p>
<p>&nbsp;</p>
<ul>
<li>Piattaforma Web e APP di TeleAssistenza per la durata di 12 mesi</li>
<li>SIM per trasmissione dati e comunicazione vocale per la durata di 12 mesi</li>
<li>Piano {{Piano}}</li>
</ul>
<p>&nbsp;</p>
<h2>Metodo di pagamento</h2>
<p>Medica GB emetter√† fattura anticipata di 12 mesi all'attivazione del Servizio e il Cliente proceder√† al pagamento a ricevimento della fattura stessa tramite bonifico bancario</p>
<p>&nbsp;</p>
<p>Intestato a: Medica GB S.r.l.</p>
<p>&nbsp;</p>
<p>Causale: Servizio {{Servizio}} {{TipoPiano}} con Dispositivo {{Dispositivo}}</p>
<p>&nbsp;</p>
<p>Banca Popolare di Milano - Iban: IT97L0503401727000000003519</p>
<p>&nbsp;</p>
<h2>Riservatezza ed esclusiva</h2>
<p>Il Cliente e Medica GB si impegnano reciprocamente a non divulgare o, comunque, non utilizzare, se non per motivi attinenti all'esercizio del presente contratto, tutte le informazioni di cui venissero a conoscenza nello svolgimento del Servizio.</p>
<p>Il Cliente si impegna a contattare Medica GB per tutte le modifiche e proroghe del presente contratto.</p>
<p>&nbsp;</p>
<h2>Foro competente</h2>
<p>Ogni eventuale contestazione o controversia che dovesse insorgere tra le parti in relazione all'interpretazione, alla validit√† ed esecuzione del presente contratto, sar√† definita alla cognizione esclusiva del Foro di Milano.</p>
<p>&nbsp;</p>
<p>Milano, l√¨ {{DATA_CONTRATTO}}</p>
<p>&nbsp;</p>
<p>Medica GB S.r.l.                                             Il Cliente</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>Medica GB S.r.l.</p>
<p>Corso Giuseppe Garibaldi, 34 ‚Äì 20121 Milano</p>
<p>PEC: medicagbsrl@pecimprese.it</p>
<p>E.mail: info@medicagb.it</p>
<p>Codice Fiscale e P.IVA: 12435130963 - REA: MI-2661409</p>
<p>www.medicagb.it www.ecura.it</p>

</body>
</html>`}static getContractTemplateBase(){try{const o=pm.join(process.cwd(),"templates","contracts","contratto_ecura_base_b2c.html");if(Uc.existsSync(o))return Uc.readFileSync(o,"utf-8");console.warn("‚ö†Ô∏è Template BASE B2C non trovato, uso fallback inline")}catch(o){console.error("‚ùå Errore caricamento template BASE:",o)}return`<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Contratto TeleMedCare Base - {{CODICE_CONTRATTO}}</title>
  <style>
    @page { size: A4; margin: 2cm; }
    body {
      font-family: 'Arial', sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      text-align: center;
      border-bottom: 3px solid #0b63a5;
      padding-bottom: 20px;
      margin-bottom: 30px;
    }
    .header h1 {
      color: #0b63a5;
      margin: 0;
      font-size: 24px;
    }
    .contract-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    }
    .section {
      margin: 25px 0;
    }
    .section h2 {
      color: #0b63a5;
      font-size: 18px;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 10px;
    }
    .price-box {
      background: #e7f3ff;
      border: 2px solid #0b63a5;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
    }
    .price-box h3 {
      margin: 0 0 10px 0;
      color: #0b63a5;
    }
    .price-box .amount {
      font-size: 32px;
      font-weight: bold;
      color: #0b63a5;
    }
    .signature-section {
      margin-top: 50px;
      padding-top: 30px;
      border-top: 2px solid #dee2e6;
    }
    .signature-box {
      display: inline-block;
      width: 45%;
      text-align: center;
      padding: 20px;
      margin: 10px 2%;
    }
    .signature-line {
      border-top: 2px solid #000;
      margin-top: 60px;
      padding-top: 10px;
    }
    .footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #dee2e6;
      font-size: 12px;
      color: #6c757d;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìã CONTRATTO DI SERVIZIO TELEMEDCARE BASE</h1>
    <p><strong>Codice Contratto:</strong> {{CODICE_CONTRATTO}}</p>
    <p><strong>Data:</strong> {{DATA_CONTRATTO}}</p>
  </div>

  <div class="contract-info">
    <h3>PARTI CONTRAENTI</h3>
    <p><strong>IL FORNITORE:</strong> {{AZIENDA_RAGIONE_SOCIALE}} - {{AZIENDA_INDIRIZZO}} - P.IVA {{AZIENDA_PARTITA_IVA}}</p>
    <p><strong>IL CLIENTE:</strong> {{NOME_RICHIEDENTE}} {{COGNOME_RICHIEDENTE}}</p>
    <p><strong>Email:</strong> {{EMAIL}} | <strong>Telefono:</strong> {{TELEFONO}}</p>
    <p><strong>Assistito:</strong> {{NOME_ASSISTITO}} {{COGNOME_ASSISTITO}} ({{ETA_ASSISTITO}} anni)</p>
  </div>

  <div class="section">
    <h2>ART. 1 - OGGETTO DEL CONTRATTO</h2>
    <p>Il presente contratto ha per oggetto la fornitura del servizio <strong>{{TIPO_SERVIZIO}}</strong>, 
    che include:</p>
    <ul>
      <li>Dispositivo medico SiDLY Care Pro V12.0 in comodato d'uso</li>
      <li>Servizio di telemonitoraggio parametri vitali</li>
      <li>Supporto tecnico telefonico (ore ufficio)</li>
      <li>Manutenzione ordinaria e straordinaria del dispositivo</li>
      <li>Aggiornamenti software inclusi</li>
    </ul>
  </div>

  <div class="section">
    <h2>ART. 2 - DURATA E CORRISPETTIVO</h2>
    <div class="price-box">
      <h3>Piano Tariffario</h3>
      <p>Canone Mensile: <span style="font-size: 20px; font-weight: bold;">{{PREZZO_MENSILE}}</span></p>
      <p>Durata Contratto: <strong>{{DURATA_MESI}} mesi</strong></p>
      <hr style="margin: 15px 0; border: 1px solid #0b63a5;">
      <p>Importo Totale:</p>
      <div class="amount">{{PREZZO_TOTALE}}</div>
      <p style="font-size: 12px; margin-top: 10px;">IVA inclusa se dovuta</p>
    </div>
    <p>Il pagamento dovr√† essere effettuato anticipatamente tramite bonifico bancario o carta di credito.</p>
  </div>

  <div class="section">
    <h2>ART. 3 - OBBLIGHI DEL FORNITORE</h2>
    <p>{{AZIENDA_RAGIONE_SOCIALE}} si impegna a:</p>
    <ul>
      <li>Fornire il dispositivo medico entro 10 giorni lavorativi dalla conferma del pagamento</li>
      <li>Garantire il corretto funzionamento del servizio di telemonitoraggio</li>
      <li>Fornire supporto tecnico durante l'orario lavorativo (9:00-18:00, Lun-Ven)</li>
      <li>Sostituire il dispositivo in caso di malfunzionamento senza costi aggiuntivi</li>
    </ul>
  </div>

  <div class="section">
    <h2>ART. 4 - OBBLIGHI DEL CLIENTE</h2>
    <p>Il Cliente si impegna a:</p>
    <ul>
      <li>Utilizzare il dispositivo secondo le istruzioni fornite</li>
      <li>Custodire con diligenza il dispositivo ricevuto in comodato d'uso</li>
      <li>Comunicare tempestivamente eventuali malfunzionamenti</li>
      <li>Restituire il dispositivo al termine del contratto o in caso di risoluzione anticipata</li>
      <li>Effettuare i pagamenti alle scadenze concordate</li>
    </ul>
  </div>

  <div class="section">
    <h2>ART. 5 - RECESSO</h2>
    <p>Il Cliente ha diritto di recedere dal contratto entro 14 giorni dalla ricezione del dispositivo, 
    senza dover fornire motivazioni. Il recesso deve essere comunicato via email certificata.</p>
    <p>In caso di recesso anticipato dopo i 14 giorni, il Cliente √® tenuto a corrispondere 
    i canoni maturati fino alla data di restituzione del dispositivo.</p>
  </div>

  <div class="section">
    <h2>ART. 6 - PRIVACY E TRATTAMENTO DATI</h2>
    <p>Il trattamento dei dati personali e sanitari avviene in conformit√† al GDPR (Regolamento UE 2016/679). 
    I dati raccolti saranno utilizzati esclusivamente per l'erogazione del servizio e non saranno 
    ceduti a terzi senza consenso esplicito.</p>
  </div>

  <div class="signature-section">
    <h2 style="text-align: center;">SOTTOSCRIZIONE DEL CONTRATTO</h2>
    <p style="text-align: center;">Le parti, letto e compreso il presente contratto, 
    lo sottoscrivono per accettazione.</p>
    
    <div class="signature-box">
      <p><strong>IL FORNITORE</strong></p>
      <p>{{AZIENDA_RAGIONE_SOCIALE}}</p>
      <div class="signature-line">
        Firma Legale Rappresentante
      </div>
    </div>
    
    <div class="signature-box">
      <p><strong>IL CLIENTE</strong></p>
      <p>{{NOME_RICHIEDENTE}} {{COGNOME_RICHIEDENTE}}</p>
      <div class="signature-line">
        Firma per Accettazione
      </div>
    </div>
  </div>

  <div class="footer">
    <p>Contratto TeleMedCare Base - Codice: {{CODICE_CONTRATTO}}</p>
    <p>Medica GB S.r.l. - P.IVA 12345678901 - www.telemedcare.it - info@telemedcare.it</p>
    <p>Documento generato elettronicamente - {{ANNO}}</p>
  </div>
</body>
</html>`}static getContractTemplateAvanzato(){try{const e=pm.join(process.cwd(),"templates","contracts","contratto_ecura_avanzato_b2c.html");if(Uc.existsSync(e))return Uc.readFileSync(e,"utf-8");console.warn("‚ö†Ô∏è Template AVANZATO B2C non trovato, uso fallback inline")}catch(e){console.error("‚ùå Errore caricamento template AVANZATO:",e)}return this.getContractTemplateBase().replace("TELEMEDCARE BASE","TELEMEDCARE AVANZATO").replace("<li>Supporto tecnico telefonico (ore ufficio)</li>",`<li>Supporto tecnico H24/7 con priorit√† alta</li>
         <li>Consulenza specialistica mensile inclusa</li>
         <li>Centrale operativa di monitoraggio attiva H24</li>
         <li>Report mensili personalizzati</li>`)}static generateContractCode(){const o=new Date().getFullYear(),e=String(new Date().getMonth()+1).padStart(2,"0"),a=Math.random().toString(36).substring(2,8).toUpperCase();return`TMC-${o}${e}-${a}`}static async generatePDFFromDOCX(o){const e=Bp(o.servizio||"PRO"),a=kp(o.tipoServizio),i=new Date,r=new Date(i),s=new Date(i);s.setMonth(s.getMonth()+(o.durataContratto||12));const l=c=>{const u=String(c.getDate()).padStart(2,"0"),p=String(c.getMonth()+1).padStart(2,"0"),g=c.getFullYear();return`${u}/${p}/${g}`},d={NOME_ASSISTITO:o.nomeAssistito||o.nomeRichiedente,COGNOME_ASSISTITO:o.cognomeAssistito||o.cognomeRichiedente,LUOGO_NASCITA:o.luogoNascita||"DA COMPLETARE",DATA_NASCITA:o.dataNascita||"DA COMPLETARE",INDIRIZZO_ASSISTITO:o.indirizzoAssistito||"DA COMPLETARE",CAP_ASSISTITO:o.capAssistito||"DA COMPLETARE",CITTA_ASSISTITO:o.cittaAssistito||"DA COMPLETARE",PROVINCIA_ASSISTITO:o.provinciaAssistito||"DA COMPLETARE",CODICE_FISCALE_ASSISTITO:o.cfAssistito||"DA COMPLETARE",TELEFONO_ASSISTITO:o.telefono||"DA COMPLETARE",EMAIL_ASSISTITO:o.email,Servizio:e.nomeCompleto,Dispositivo:e.dispositivo,Piano:a.nomeCompleto,DATA_INIZIO_SERVIZIO:l(r),DATA_SCADENZA:l(s),DATA_CONTRATTO:l(i),IMPORTO_PRIMO_ANNO:o.prezzoTotale.toFixed(2),IMPORTO_ANNI_SUCCESSIVI:(o.prezzoMensile*12).toFixed(2)};return console.log("üìÑ [CONTRACT] Generazione DOCX da template..."),console.log("   Servizio:",d.Servizio),console.log("   Dispositivo:",d.Dispositivo),console.log("   Piano:",d.Piano.substring(0,50)+"..."),this.generateSimplePDF(o,d)}static generateSimplePDF(o,e){console.log("üìÑ [CONTRACT] Generazione PDF semplice (fallback)...");const a=`
CONTRATTO TELEMEDCARE

Codice Contratto: ${o.codiceContratto}
Data: ${o.dataContratto}

CLIENTE:
${e.NOME_ASSISTITO} ${e.COGNOME_ASSISTITO}
Email: ${e.EMAIL_ASSISTITO}
Telefono: ${e.TELEFONO_ASSISTITO}

SERVIZIO:
${e.Servizio}
Dispositivo: ${e.Dispositivo}
Piano: ${e.Piano}

CONDIZIONI ECONOMICHE:
Primo anno: ‚Ç¨${e.IMPORTO_PRIMO_ANNO}
Anni successivi: ‚Ç¨${e.IMPORTO_ANNI_SUCCESSIVI}
Durata: ${o.durataContratto} mesi
Da: ${e.DATA_INIZIO_SERVIZIO}
A: ${e.DATA_SCADENZA}

Il presente contratto √® stato generato automaticamente.

----
Medica GB S.r.l.
www.ecura.it
`,i=`%PDF-1.4
`,r=`1 0 obj
<< /Type /Catalog /Pages 2 0 R >>
endobj
2 0 obj
<< /Type /Pages /Kids [3 0 R] /Count 1 >>
endobj
3 0 obj
<< /Type /Page /Parent 2 0 R /Resources << /Font << /F1 << /Type /Font /Subtype /Type1 /BaseFont /Courier >> >> >> /MediaBox [0 0 612 792] /Contents 4 0 R >>
endobj
4 0 obj
<< /Length ${a.length+50} >>
stream
BT
/F1 10 Tf
50 750 Td
`,s=a.split(`
`).map((c,u)=>`(${c.replace(/[()\\]/g,"\\$&")}) Tj
0 -12 Td
`).join(""),l=`ET
endstream
endobj
xref
0 5
0000000000 65535 f
0000000009 00000 n
0000000058 00000 n
0000000115 00000 n
0000000300 00000 n
trailer
<< /Size 5 /Root 1 0 R >>
startxref
${(i+r+s+l).length-50}
%%EOF
`,d=i+r+s+`ET
endstream
endobj
xref
0 5
0000000000 65535 f
0000000009 00000 n
0000000058 00000 n
0000000115 00000 n
0000000300 00000 n
trailer
<< /Size 5 /Root 1 0 R >>
startxref
500
%%EOF
`;return new Uint8Array(Buffer.from(d,"utf-8"))}static async sendContractEmail(o,e,a){try{const i=await e.prepare(`
        SELECT c.*, l.email, l.nomeRichiedente, l.tipoServizio
        FROM contracts c
        JOIN leads l ON c.leadId = l.id
        WHERE c.id = ?
      `).bind(o).first();if(!i)throw new Error("Contratto non trovato");console.log("üìß [CONTRACT] Invio contratto via email:",i.email);const s=(await Promise.resolve().then(()=>At)).default.getInstance(),l={NOME_CLIENTE:i.nomeRichiedente||"Cliente",PIANO_SERVIZIO:i.tipoServizio==="AVANZATO"?"TeleMedCare Avanzato":"TeleMedCare Base",PREZZO_PIANO:`‚Ç¨${i.prezzo_totale||0}`,CODICE_CLIENTE:i.leadId,LINK_FIRMA:`https://app.telemedcare.it/firma/${o}`},d=await s.sendTemplateEmail("INVIO_CONTRATTO",i.email,l,void 0,a);return d.success&&(await e.prepare(`
          UPDATE contracts 
          SET status = 'SENT', data_invio = datetime('now'), updated_at = datetime('now')
          WHERE id = ?
        `).bind(o).run(),await e.prepare(`
          UPDATE leads 
          SET status = 'contract_sent', updated_at = datetime('now')
          WHERE id = ?
        `).bind(i.leadId).run(),console.log("‚úÖ [CONTRACT] Email contratto inviata")),d}catch(i){return console.error("‚ùå [CONTRACT] Errore invio email:",i),{success:!1,error:i instanceof Error?i.message:"Errore invio"}}}static generatePDFFromHTML(o,e){const a=this.generatePDFTextContent(e),i=`%PDF-1.4
1 0 obj
<<
/Type /Catalog
/Pages 2 0 R
>>
endobj
2 0 obj
<<
/Type /Pages
/Kids [3 0 R]
/Count 1
>>
endobj
3 0 obj
<<
/Type /Page
/Parent 2 0 R
/Resources <<
/Font <<
/F1 <<
/Type /Font
/Subtype /Type1
/BaseFont /Helvetica
>>
/F2 <<
/Type /Font
/Subtype /Type1
/BaseFont /Helvetica-Bold
>>
>>
>>
/MediaBox [0 0 612 792]
/Contents 4 0 R
>>
endobj
4 0 obj
<<
/Length ${a.length}
>>
stream
${a}
endstream
endobj
xref
0 5
0000000000 65535 f 
0000000009 00000 n 
0000000058 00000 n 
0000000115 00000 n 
0000000320 00000 n 
trailer
<<
/Size 5
/Root 1 0 R
>>
startxref
${420+a.length}
%%EOF`;return new TextEncoder().encode(i)}static generatePDFTextContent(o){const e=o.servizio==="FAMILY"?"Senium":o.servizio==="PREMIUM"?"SiDLY Vital Care":"SiDLY Care PRO";return`BT
/F2 20 Tf
50 750 Td
(CONTRATTO DI SERVIZIO eCura) Tj
0 -25 Td
/F2 16 Tf
(${o.servizio||"PRO"} - Piano ${o.tipoServizio}) Tj
0 -40 Td
/F1 11 Tf
(Codice Contratto: ${o.codiceContratto||"N/A"}) Tj
0 -18 Td
(Data: ${o.dataContratto||new Date().toLocaleDateString("it-IT")}) Tj
0 -40 Td
/F2 14 Tf
(DATI CLIENTE) Tj
0 -25 Td
/F1 11 Tf
(Nome Completo: ${o.nomeRichiedente} ${o.cognomeRichiedente}) Tj
0 -18 Td
(Email: ${o.email}) Tj
0 -18 Td
(Telefono: ${o.telefono}) Tj
0 -18 Td
(Assistito: ${o.nomeAssistito||o.nomeRichiedente} ${o.cognomeAssistito||o.cognomeRichiedente}) Tj
0 -18 Td
(Eta Assistito: ${o.etaAssistito||"Non specificata"} anni) Tj
0 -40 Td
/F2 14 Tf
(SERVIZIO E DISPOSITIVO) Tj
0 -25 Td
/F1 11 Tf
(Servizio: eCura ${o.servizio||"PRO"}) Tj
0 -18 Td
(Piano: ${o.tipoServizio}) Tj
0 -18 Td
(Dispositivo: ${e}) Tj
0 -18 Td
(Durata Contratto: ${o.durataContratto} mesi) Tj
0 -40 Td
/F2 14 Tf
(CONDIZIONI ECONOMICHE) Tj
0 -25 Td
/F1 11 Tf
(Canone Mensile: EUR ${o.prezzoMensile.toFixed(2)}) Tj
0 -18 Td
(Totale Contratto \\(${o.durataContratto} mesi\\): EUR ${o.prezzoTotale.toFixed(2)}) Tj
0 -18 Td
(IVA Inclusa: 22%) Tj
0 -40 Td
/F2 14 Tf
(TERMINI E CONDIZIONI) Tj
0 -25 Td
/F1 10 Tf
(1. OGGETTO: Fornitura dispositivo ${e} per il monitoraggio) Tj
0 -15 Td
(   remoto della salute e assistenza 24/7.) Tj
0 -20 Td
(2. CONSEGNA: Dispositivo consegnato entro 7 giorni lavorativi) Tj
0 -15 Td
(   all'indirizzo indicato dal cliente.) Tj
0 -20 Td
(3. ATTIVAZIONE: Servizio attivo entro 24 ore dalla consegna) Tj
0 -15 Td
(   con assistenza tecnica per la configurazione.) Tj
0 -20 Td
(4. ASSISTENZA: Supporto tecnico e sanitario disponibile 24/7) Tj
0 -15 Td
(   tramite numero verde dedicato.) Tj
0 -20 Td
(5. GARANZIA: Dispositivo coperto da garanzia 24 mesi del) Tj
0 -15 Td
(   produttore con sostituzione gratuita in caso di guasto.) Tj
0 -20 Td
(6. RECESSO: Diritto di recesso entro 14 giorni dalla consegna) Tj
0 -15 Td
(   con restituzione dispositivo nelle condizioni originali.) Tj
0 -20 Td
(7. PRIVACY: Trattamento dati secondo GDPR \\(UE 2016/679\\).) Tj
0 -15 Td
(   Informativa completa su www.telemedcare.it/privacy) Tj
0 -40 Td
/F2 12 Tf
(MODALITA DI FIRMA) Tj
0 -25 Td
/F1 10 Tf
(Il presente contratto sara firmato digitalmente tramite DocuSign.) Tj
0 -15 Td
(Ricevera un'email con il link per la firma elettronica.) Tj
0 -30 Td
/F1 9 Tf
(Documento generato automaticamente da eCura - TeleMedCare V12.0) Tj
0 -15 Td
(Per informazioni: info@telemedcare.it | Tel: 800 123 456) Tj
0 -15 Td
(www.telemedcare.it) Tj
ET`}static generateStandalonePDF(o){const e=this.generatePDFTextContent(o),a=`%PDF-1.4
1 0 obj
<<
/Type /Catalog
/Pages 2 0 R
>>
endobj
2 0 obj
<<
/Type /Pages
/Kids [3 0 R]
/Count 1
>>
endobj
3 0 obj
<<
/Type /Page
/Parent 2 0 R
/Resources <<
/Font <<
/F1 <<
/Type /Font
/Subtype /Type1
/BaseFont /Helvetica
>>
>>
>>
/MediaBox [0 0 612 792]
/Contents 4 0 R
>>
endobj
4 0 obj
<<
/Length ${e.length}
>>
stream
${e}
endstream
endobj
xref
0 5
0000000000 65535 f 
0000000009 00000 n 
0000000058 00000 n 
0000000115 00000 n 
0000000274 00000 n 
trailer
<<
/Size 5
/Root 1 0 R
>>
startxref
${370+e.length}
%%EOF`;return new TextEncoder().encode(a)}}async function lT(t,o,e){const a={success:!1,step:"generate_and_send_contract",emailsSent:[],errors:[],messageIds:[]};try{console.log(`üìÑ [CONTRACT_WORKFLOW] Generazione contratto per lead: ${t.id}`),console.log(`üìÑ [CONTRACT_WORKFLOW] Servizio: ${t.servizio||"PRO"}, Piano: ${t.pacchetto}`);const i=t.servizio||"PRO",r=t.pacchetto,s=Nc(i,r);if(!s)return a.errors.push(`Pricing non trovato per ${i} ${r}`),console.error("‚ùå [CONTRACT_WORKFLOW] Pricing non trovato"),a;console.log(`üí∞ [CONTRACT_WORKFLOW] Pricing: ${s.setupTotale}‚Ç¨ (1¬∞ anno), Dispositivo: ${s.dispositivo}`);const l={leadId:t.id,nomeRichiedente:t.nomeRichiedente,cognomeRichiedente:t.cognomeRichiedente,email:t.email,telefono:t.telefono||"",tipoServizio:r,servizio:i,nomeAssistito:t.nomeAssistito,cognomeAssistito:t.cognomeAssistito,etaAssistito:t.etaAssistito,luogoNascita:t.luogoNascitaAssistito||t.luogoNascita,dataNascita:t.dataNascitaAssistito||t.dataNascita,indirizzoAssistito:t.indirizzoAssistito,capAssistito:t.capAssistito,cittaAssistito:t.cittaAssistito,provinciaAssistito:t.provinciaAssistito,cfAssistito:t.cfAssistito||t.cfAssistito,prezzoMensile:s.setupBase/12,durataContratto:12,prezzoTotale:s.setupTotale};console.log("üìÑ [CONTRACT_WORKFLOW] Generazione PDF contratto...");const d=await nT.generateContract(l,e,o.BROWSER);if(!d.success||!d.contract)return a.errors.push(`Errore generazione contratto: ${d.error}`),console.error("‚ùå [CONTRACT_WORKFLOW] Errore generazione contratto:",d.error),a;const c=d.contract;console.log(`‚úÖ [CONTRACT_WORKFLOW] Contratto generato: ${c.codiceContratto}`);const u=o.PUBLIC_URL||(typeof window<"u"?window.location.origin:"http://localhost:3000"),p=[];if(c.pdfBase64&&(p.push({filename:`Contratto_TeleMedCare_${c.codiceContratto}.pdf`,content:c.pdfBase64,contentType:"application/pdf"}),console.log("‚úÖ [CONTRACT_WORKFLOW] Contratto PDF aggiunto agli allegati")),t.vuoleBrochure){const w=t.servizio||"DEFAULT";console.log(`üì• [CONTRACT_WORKFLOW] Caricamento brochure per servizio: ${w}`);let S=null;if(w!=="DEFAULT"&&(w==="FAMILY"||w==="PRO"||w==="PREMIUM")&&(S=await jg(w,u)),!S){console.log("üìÑ [CONTRACT_WORKFLOW] Caricamento brochure generica TeleMedCare");try{const C=`${u}/brochures/Brochure_eCura.pdf`,R=await fetch(C);if(R.ok){const z=await R.arrayBuffer(),D=new Uint8Array(z);let F="";const L=8192;for(let j=0;j<D.length;j+=L){const N=D.subarray(j,Math.min(j+L,D.length));F+=String.fromCharCode.apply(null,Array.from(N))}S={filename:"Brochure_eCura.pdf",content:btoa(F),size:z.byteLength}}}catch(C){console.error("‚ùå [CONTRACT_WORKFLOW] Errore caricamento brochure:",C)}}S&&(p.push({filename:S.filename,content:S.content,contentType:"application/pdf"}),console.log(`‚úÖ [CONTRACT_WORKFLOW] Brochure aggiunta: ${S.filename}`))}console.log(`üìß [CONTRACT_WORKFLOW] Invio email contratto a ${t.email}`);const g=new Xe(o),m=await Bo("email_invio_contratto",e),b={NOME_CLIENTE:t.nomeRichiedente,COGNOME_CLIENTE:t.cognomeRichiedente,PIANO_SERVIZIO:io(i,r),PREZZO_PIANO:`‚Ç¨${s.setupTotale.toFixed(2)}`,CODICE_CLIENTE:t.id,CODICE_CONTRATTO:c.codiceContratto,LINK_FIRMA:`${u}/firma-contratto?contractId=${c.contractId}`,DATA_INVIO:new Date().toLocaleDateString("it-IT"),DISPOSITIVO:s.dispositivo,SERVIZIO:i},h=ko(m,b);console.log(`üìß [CONTRACT_WORKFLOW] Allegati preparati: ${p.length}`);for(const w of p)console.log(`  üìé ${w.filename} (${(w.content.length*.75/1024).toFixed(2)} KB)`);const E=await g.sendEmail({to:t.email,from:"info@telemedcare.it",subject:`üìÑ eCura - Il Tuo Contratto ${io(i,r)}`,html:h,attachments:p});E.success?(a.success=!0,a.emailsSent.push(`email_invio_contratto -> ${t.email}`),a.messageIds=[E.messageId],await e.prepare(`
        UPDATE leads 
        SET status = 'CONTRACT_SENT', updated_at = datetime('now')
        WHERE id = ?
      `).bind(t.id).run(),await e.prepare(`
        UPDATE contracts 
        SET status = 'SENT', data_invio = datetime('now'), updated_at = datetime('now')
        WHERE id = ?
      `).bind(c.contractId).run(),console.log(`‚úÖ [CONTRACT_WORKFLOW] Email contratto inviata con successo: ${E.messageId}`)):(a.errors.push(`Errore invio email: ${E.error}`),console.error("‚ùå [CONTRACT_WORKFLOW] Errore invio email:",E.error))}catch(i){a.errors.push(`Eccezione workflow contratto: ${i instanceof Error?i.message:"Errore sconosciuto"}`),console.error("‚ùå [CONTRACT_WORKFLOW] Eccezione:",i)}return a}async function cT(t){try{const o=await t.prepare(`
      SELECT * FROM settings WHERE key = 'workflow_emails'
    `).first();if(o!=null&&o.value)return JSON.parse(o.value)}catch(o){console.error("‚ö†Ô∏è [ORCHESTRATOR] Errore lettura settings:",o)}return{email_notifica_info:!0,email_completamento_dati:!0,email_reminder_firma:!0,email_promemoria_pagamento:!0}}async function dT(t){var e,a;const o={success:!1,step:"process_new_lead",message:"",errors:[]};try{console.log(`üöÄ [ORCHESTRATOR] STEP 1: Processamento nuovo lead ${t.leadData.id}`);const i=await cT(t.db);console.log("‚öôÔ∏è [ORCHESTRATOR] Settings workflow:",i);const r=await t.db.prepare("SELECT value FROM settings WHERE key = 'admin_email_notifications_enabled' LIMIT 1").first(),s=(r==null?void 0:r.value)==="true";if(console.log(`üîç [ORCHESTRATOR] Admin switch check: workflow=${i.email_notifica_info}, dashboard=${s}`),s){console.log("üìß [ORCHESTRATOR] Invio notifica a info@telemedcare.it");const c=await Ks.inviaEmailNotificaInfo(t.leadData,t.env,t.db);c.success||o.errors.push(...c.errors)}else console.log("‚è≠Ô∏è [ORCHESTRATOR] Email notifica info@ disabilitata (dashboard switch OFF)");const l=await t.db.prepare("SELECT value FROM settings WHERE key = 'lead_email_notifications_enabled' LIMIT 1").first(),d=(l==null?void 0:l.value)==="true";if(console.log("üîç [ORCHESTRATOR] Lead email check:",{leadEmailEnabled:d,email:t.leadData.email,hasEmail:!!t.leadData.email,leadId:t.leadData.id}),console.log(`üîç [ORCHESTRATOR] Switch check: workflow=${i.email_completamento_dati}, dashboard=${d}`),d){const c=t.leadData.email||t.leadData.email;if(console.log(`üìß [ORCHESTRATOR] Invio email completamento dati a ${c}`),console.log(`   email: ${t.leadData.email}`),console.log(`   email: ${t.leadData.email}`),!c)console.error(`‚ùå [ORCHESTRATOR] Nessuna email trovata per lead ${t.leadData.id}`),o.errors.push("Email destinatario mancante");else{console.log(`üöÄ [ORCHESTRATOR] INIZIO INVIO EMAIL - recipientEmail: ${c}`);try{console.log("üì¶ [ORCHESTRATOR] Import moduli...");const{createCompletionToken:u,getMissingFields:p,getSystemConfig:g}=await Promise.resolve().then(()=>at),m=(await Promise.resolve().then(()=>At)).default;console.log("‚öôÔ∏è [ORCHESTRATOR] Carico configurazione...");const b=await g(t.db);console.log("üéüÔ∏è [ORCHESTRATOR] Creo token completamento...");const h=await u(t.db,t.leadData.id,b.auto_completion_token_days);console.log(`‚úÖ [ORCHESTRATOR] Token creato: ${h.token}`);const w=`${((e=t.env)==null?void 0:e.PUBLIC_URL)||((a=t.env)==null?void 0:a.PAGES_URL)||"https://telemedcare-v12.pages.dev"}/completa-dati?token=${h.token}`;console.log("üìã [ORCHESTRATOR] Preparo dati email...");const{missing:S,available:C}=p(t.leadData),R=`
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Completa i tuoi dati - eCura</title>
</head>
<body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f4f4f4;">
  <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #f4f4f4; padding: 20px 0;">
    <tr>
      <td align="center">
        <table width="600" cellpadding="0" cellspacing="0" border="0" style="background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          
          <!-- Header -->
          <tr>
            <td style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 30px; text-align: center;">
              <h1 style="color: #ffffff; margin: 0; font-size: 28px; font-weight: bold;">üìù Completa i tuoi dati</h1>
              <p style="color: #ffffff; margin: 10px 0 0 0; font-size: 16px; opacity: 0.9;">Siamo quasi pronti per attivare il tuo servizio eCura</p>
            </td>
          </tr>
          
          <!-- Content -->
          <tr>
            <td style="padding: 40px 30px;">
              <p style="color: #333333; font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;">
                Gentile <strong>${t.leadData.nomeRichiedente||"Cliente"} ${t.leadData.cognomeRichiedente||""}</strong>,
              </p>
              
              <p style="color: #333333; font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;">
                Grazie per il tuo interesse verso <strong>${t.leadData.pacchetto||t.leadData.servizio||"eCura"}</strong>. 
                Abbiamo ricevuto la tua richiesta e per inviarti una proposta per soddisfare le tue esigenze 
                abbiamo bisogno di alcune <strong>informazioni aggiuntive</strong>.
              </p>
              
              <!-- Info Box -->
              <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #f8f9fa; border-left: 4px solid #667eea; margin: 30px 0; border-radius: 4px;">
                <tr>
                  <td style="padding: 20px;">
                    <p style="color: #333333; font-size: 14px; line-height: 1.6; margin: 0 0 10px 0;">
                      <strong>üìã Dati richiesta:</strong>
                    </p>
                    <p style="color: #666666; font-size: 14px; line-height: 1.6; margin: 0;">
                      Lead ID: <strong>${t.leadData.id}</strong><br>
                      Servizio: <strong>${t.leadData.pacchetto||t.leadData.servizio||"eCura"}</strong><br>
                      Campi mancanti: <strong>${S.length}</strong>
                    </p>
                  </td>
                </tr>
              </table>
              
              <p style="color: #333333; font-size: 16px; line-height: 1.6; margin: 0 0 30px 0;">
                Clicca sul pulsante qui sotto per completare i tuoi dati. 
                Il link sar√† valido per <strong>${b.auto_completion_token_days} giorni</strong>.
              </p>
              
              <!-- CTA Button -->
              <table width="100%" cellpadding="0" cellspacing="0" border="0">
                <tr>
                  <td align="center" style="padding: 20px 0;">
                    <a href="${w}" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #ffffff; text-decoration: none; padding: 16px 40px; border-radius: 6px; font-size: 16px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                      Completa i tuoi dati
                    </a>
                  </td>
                </tr>
              </table>
              
              <p style="color: #666666; font-size: 14px; line-height: 1.6; margin: 30px 0 0 0; text-align: center;">
                Se il pulsante non funziona, copia e incolla questo link nel tuo browser:<br>
                <a href="${w}" style="color: #667eea; word-break: break-all;">${w}</a>
              </p>
            </td>
          </tr>
          
          <!-- Footer -->
          <tr>
            <td style="background-color: #f8f9fa; padding: 30px; text-align: center; border-top: 1px solid #e9ecef;">
              <p style="color: #666666; font-size: 14px; margin: 0 0 10px 0;">
                <strong>TeleMedCare</strong> - Sistema di Gestione Lead
              </p>
              <p style="color: #999999; font-size: 12px; margin: 0;">
                Per assistenza: <a href="mailto:info@telemedcare.it" style="color: #667eea; text-decoration: none;">info@telemedcare.it</a>
              </p>
            </td>
          </tr>
          
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`;console.log("üìß [ORCHESTRATOR] Creo EmailService e invio...");const D=await new m(t.env).sendEmail({to:c,subject:"üìù Completa la tua richiesta eCura - Ultimi dettagli necessari",html:R});console.log("üì¨ [ORCHESTRATOR] Risultato invio:",D),D.success?(console.log(`‚úÖ [ORCHESTRATOR] Email completamento dati inviata a ${c}`),console.log(`   Link form: ${w}`),D.warning&&console.warn("‚ö†Ô∏è [ORCHESTRATOR] WARNING:",D.warning)):(console.error("‚ùå [ORCHESTRATOR] Errore invio email completamento:",D.error),o.errors.push(`Errore email completamento: ${D.error}`))}catch(u){console.error("‚ùå [ORCHESTRATOR] EXCEPTION durante invio email:",u),console.error("   Error message:",u.message),console.error("   Error stack:",u.stack),o.errors.push(`Errore email completamento: ${u.message}`)}}}else console.log("‚è≠Ô∏è [ORCHESTRATOR] Email completamento dati disabilitata (switch OFF)");if(!t.leadData.vuoleContratto&&(t.leadData.vuoleBrochure||t.leadData.vuoleManuale)){console.log("üìö [ORCHESTRATOR] Lead richiede solo documenti informativi");const c=await gT(t.leadData),u=await Ks.inviaEmailDocumentiInformativi(t.leadData,t.env,c,t.db);u.success?(o.success=!0,o.message="Lead processato: documenti informativi inviati",o.data={emailsSent:u.emailsSent}):(o.errors.push(...u.errors),o.message="Errore invio documenti")}else if(t.leadData.vuoleContratto){console.log(`üìÑ [ORCHESTRATOR] Lead richiede contratto ${t.leadData.pacchetto}`);const c=await lT(t.leadData,t.env,t.db);c.success?(o.success=!0,o.message="Lead processato: contratto generato e inviato",o.data={emailsSent:c.emailsSent,messageIds:c.messageIds}):(o.errors.push(...c.errors),o.message="Errore generazione/invio contratto")}else o.message="Nessuna richiesta specifica (n√© documenti n√© contratto)",o.success=!0;await uu(t.db,t.leadData.id,t.leadData.vuoleContratto?"CONTRACT_SENT":"DOCUMENTS_SENT"),console.log(`‚úÖ [ORCHESTRATOR] STEP 1 completato: ${o.message}`)}catch(i){console.error("‚ùå [ORCHESTRATOR] Errore STEP 1:",i),o.message=`Errore processamento lead: ${i.message}`,o.errors.push(i.message)}return o}async function uT(t){const o={success:!1,step:"process_payment",message:"",errors:[]};try{console.log(`üí≥ [ORCHESTRATOR] STEP 3: Processamento pagamento per proforma ${t.proformaId}`),console.log("üí≥ [ORCHESTRATOR DEBUG] ctx.paymentData:",JSON.stringify(t.paymentData));const e=t.paymentData.amount||t.paymentData.importo,a=t.paymentData.paymentMethod||t.paymentData.metodo||"BONIFICO";if(!e)return o.errors.push("Importo pagamento non specificato"),o.message="Dati pagamento incompleti",o;if(!t.contractId)return o.errors.push("Contract ID mancante"),o.message="Dati contratto incompleti",o;const i={proformaId:t.proformaId,contractId:t.contractId,leadId:t.leadData.id,importo:e,metodoPagamento:a,transactionId:t.paymentData.transactionId,riferimentoBonifico:t.paymentData.riferimento,ibanMittente:t.paymentData.iban,stripePaymentIntentId:t.paymentData.stripePaymentIntentId};console.log("üí≥ [ORCHESTRATOR] Registering payment with params:",JSON.stringify({proformaId:i.proformaId,contractId:i.contractId,leadId:i.leadId,importo:i.importo,metodoPagamento:i.metodoPagamento}));const r=await Em.registerPayment(t.db,i);if(!r.success)return o.errors.push(r.error),o.message="Errore registrazione pagamento",r.debug&&(o.debug=r.debug),o;if(t.paymentData.autoConfirm){const d=await Em.confirmPayment(t.db,r.paymentId);if(!d.success)return o.errors.push(d.error),o.message="Errore conferma pagamento",o}const s=await fT(t.db,t.leadData.id),l=await Ks.inviaEmailBenvenuto({...t.leadData,codiceCliente:s},t.env,t.db);l.success?(o.success=!0,o.message="Pagamento registrato e email benvenuto inviata",o.data={paymentId:r.paymentId,codiceCliente:s,emailsSent:l.emailsSent}):(o.errors.push(...l.errors),o.message="Errore invio email benvenuto"),await uu(t.db,t.leadData.id,"PAYMENT_RECEIVED"),console.log(`‚úÖ [ORCHESTRATOR] STEP 3 completato: ${o.message}`)}catch(e){console.error("‚ùå [ORCHESTRATOR] Errore STEP 3:",e),o.message=`Errore processamento pagamento: ${e.message}`,o.errors.push(e.message)}return o}async function pT(t){const o={success:!1,step:"process_configuration",message:"",errors:[]};try{console.log(`üìã [ORCHESTRATOR] STEP 4: Processamento configurazione cliente ${t.leadData.id}`);const e=await Nv.saveConfiguration(t.db,t.configData);if(!e.success)return o.errors.push(e.error),o.message="Errore salvataggio configurazione",o;const a=await Ks.inviaEmailConfigurazione(t.leadData,t.configData,t.env,t.db);a.success?(o.success=!0,o.message="Configurazione salvata e inviata a info@",o.data={configurationId:e.configurationId,emailsSent:a.emailsSent}):(o.errors.push(...a.errors),o.message="Errore invio email configurazione"),await uu(t.db,t.leadData.id,"CONFIGURED"),console.log(`‚úÖ [ORCHESTRATOR] STEP 4 completato: ${o.message}`)}catch(e){console.error("‚ùå [ORCHESTRATOR] Errore STEP 4:",e),o.message=`Errore processamento configurazione: ${e.message}`,o.errors.push(e.message)}return o}async function mT(t){const o={success:!1,step:"process_device_association",message:"",errors:[]};try{console.log(`üîß [ORCHESTRATOR] STEP 5: Associazione dispositivo per cliente ${t.leadData.id}`);const e=await hT(t.db,{leadId:t.leadData.id,imei:t.deviceData.imei,modello:t.deviceData.modello});if(!e.success)return o.errors.push(e.error),o.message="Errore associazione dispositivo",o;const a=await Ks.inviaEmailConfermaAttivazione(t.leadData,{imei:t.deviceData.imei,modello:t.deviceData.modello,dataAssociazione:new Date().toISOString()},t.env,t.db);a.success?(o.success=!0,o.message="Dispositivo associato e email conferma inviata",o.data={deviceId:e.deviceId,emailsSent:a.emailsSent}):(o.errors.push(...a.errors),o.message="Errore invio email conferma"),await uu(t.db,t.leadData.id,"CONVERTED"),console.log(`‚úÖ [ORCHESTRATOR] STEP 5 completato: ${o.message}`),console.log(`üéâ [ORCHESTRATOR] Workflow completo per lead ${t.leadData.id}!`)}catch(e){console.error("‚ùå [ORCHESTRATOR] Errore STEP 5:",e),o.message=`Errore associazione dispositivo: ${e.message}`,o.errors.push(e.message)}return o}async function gT(t){const o={};return t.vuoleBrochure&&(o.brochure="/public/brochures/Brochure_eCura.pdf"),t.vuoleManuale&&(o.manuale="/public/documents/Manuale_SiDLY.pdf"),o}async function fT(t,o){const e=Date.now(),a=Math.floor(Math.random()*1e3).toString().padStart(3,"0");return`CLI-${e}-${a}`}async function uu(t,o,e){try{await t.prepare(`
      UPDATE leads 
      SET status = ?, updated_at = datetime('now')
      WHERE id = ?
    `).bind(e,o).run(),console.log(`‚úÖ [HELPER] Lead ${o} status aggiornato a ${e}`)}catch(a){console.error("‚ùå [HELPER] Errore aggiornamento status lead:",a)}}async function hT(t,o){return console.log(`üîß [HELPER] Associazione dispositivo ${o.imei} a lead ${o.leadId}`),{success:!0,deviceId:`DEV${Date.now()}`}}const l0=`
<script>
(function() {
  // Configurazione auto-import
  const AUTO_IMPORT_CONFIG = {
    enabled: true,
    silent: true, // Non mostrare notifiche se non ci sono nuovi lead
    showSuccessToast: true, // Mostra toast solo se importati nuovi lead
    minIntervalMinutes: 0 // ‚úÖ SEMPRE ESEGUI (rimosso interval)
  };
  
  // Verifica parametro URL per forzare import
  const urlParams = new URLSearchParams(window.location.search);
  const forceImport = urlParams.get('forceImport') === 'true';
  
  // Verifica se auto-import √® necessario
  async function shouldRunAutoImport() {
    // ‚úÖ SEMPRE TRUE - Esegui ad ogni refresh
    return true;
  }
  
  // Esegui auto-import incrementale
  async function executeAutoImport() {
    try {
      console.log('üöÄ [AUTO-IMPORT] executeAutoImport() chiamata');
      console.log('üîç [AUTO-IMPORT] URL corrente:', window.location.href);
      
      if (!AUTO_IMPORT_CONFIG.enabled) {
        console.log('üî¥ [AUTO-IMPORT] Disabilitato');
        return;
      }
      
      console.log('‚úÖ [AUTO-IMPORT] Config enabled: true');
      
      if (!(await shouldRunAutoImport())) {
        console.log('‚è≠Ô∏è  [AUTO-IMPORT] Troppo recente, skip');
        return;
      }
      
      console.log('‚úÖ [AUTO-IMPORT] shouldRunAutoImport: true');
      console.log('üîÑ [AUTO-IMPORT] Inizio import incrementale silenzioso...');
      
      const apiEndpoint = '/api/hubspot/auto-import';
      console.log('üì° [AUTO-IMPORT] Chiamata API: POST', apiEndpoint);
      console.log('üì§ [AUTO-IMPORT] Body:', JSON.stringify({
        enabled: true,
        startHour: 0,
        days: 7,
        onlyEcura: true,
        dryRun: false
      }));
      
      const response = await fetch(apiEndpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          enabled: true,
          startHour: 0,
          days: 7, // ‚úÖ Ultimi 7 giorni (invece di 24h)
          onlyEcura: true, // ‚úÖ RIPRISTINATO: solo lead da Form eCura
          dryRun: false
        })
      });
      
      console.log(\`üì° [AUTO-IMPORT] Response status: \${response.status}\`);
      console.log(\`üì° [AUTO-IMPORT] Response ok: \${response.ok}\`);
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error(\`‚ùå [AUTO-IMPORT] HTTP Error \${response.status}:\`, errorText);
        throw new Error(\`HTTP \${response.status}: \${errorText}\`);
      }
      
      const result = await response.json();
      console.log('üì¶ [AUTO-IMPORT] Response data:', JSON.stringify(result, null, 2));
      
      // Salva timestamp ultimo import
      localStorage.setItem('lastAutoImportTimestamp', new Date().toISOString());
      
      if (result.success) {
        const timeFrom = new Date(result.timeRange.from).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
        const timeTo = new Date(result.timeRange.to).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
        
        console.log(\`‚úÖ [AUTO-IMPORT] Completato: \${result.imported} importati, \${result.skipped} gi√† esistenti (\${timeFrom} - \${timeTo})\`);
        
        // Ricarica dati dashboard sempre (anche se 0 importati) per sincronizzare cancellazioni
        if (typeof window.refreshDashboardData === 'function') {
          console.log('üîÑ [AUTO-IMPORT] Ricarico dati dashboard...');
          setTimeout(() => window.refreshDashboardData(), 1000);
        }
        
        // Mostra notifica solo se importati nuovi lead
        if (result.imported > 0 && AUTO_IMPORT_CONFIG.showSuccessToast) {
          showAutoImportToast(\`‚úÖ \${result.imported} nuovi lead importati da HubSpot\`, 'success');
        } else if (AUTO_IMPORT_CONFIG.silent) {
          // Import silenzioso: nessuna notifica
          console.log(\`‚ÑπÔ∏è  [AUTO-IMPORT] Nessun nuovo lead da importare\`);
        }
      } else {
        console.error('‚ùå [AUTO-IMPORT] Errore:', result.message || result.error);
        
        // Non mostrare errore all'utente se silenzioso
        if (!AUTO_IMPORT_CONFIG.silent) {
          showAutoImportToast(\`‚ö†Ô∏è Auto-import fallito: \${result.message || result.error}\`, 'error');
        }
      }
      
    } catch (error) {
      console.error('‚ùå [AUTO-IMPORT] ERRORE CRITICO in executeAutoImport:', error);
      console.error('‚ùå [AUTO-IMPORT] Stack trace:', error.stack);
      
      if (!AUTO_IMPORT_CONFIG.silent) {
        showAutoImportToast('‚ö†Ô∏è Errore auto-import HubSpot', 'error');
      }
    }
  }
  
  // Mostra toast notifica
  function showAutoImportToast(message, type = 'info') {
    // Crea toast element
    const toast = document.createElement('div');
    toast.className = \`fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 transition-all duration-300 \${
      type === 'success' ? 'bg-green-600' :
      type === 'error' ? 'bg-red-600' :
      'bg-blue-600'
    }\`;
    toast.innerHTML = \`
      <div class="flex items-center gap-3">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          \${type === 'success' 
            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>'
            : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'
          }
        </svg>
        <span>\${message}</span>
      </div>
    \`;
    
    document.body.appendChild(toast);
    
    // Fade in
    setTimeout(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
    }, 10);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(10px)';
      setTimeout(() => toast.remove(), 300);
    }, 5000);
  }
  
  // Esegui auto-import quando documento √® pronto
  console.log('ü§ñ [AUTO-IMPORT] Script injection started, readyState:', document.readyState);
  
  if (document.readyState === 'loading') {
    console.log('‚è≥ [AUTO-IMPORT] Documento in caricamento, aspetto DOMContentLoaded...');
    document.addEventListener('DOMContentLoaded', () => {
      console.log('‚úÖ [AUTO-IMPORT] DOMContentLoaded fired, eseguo executeAutoImport()');
      executeAutoImport();
    });
  } else {
    // DOM gi√† caricato, esegui subito
    console.log('‚úÖ [AUTO-IMPORT] DOM gi√† caricato, eseguo executeAutoImport tra 500ms');
    setTimeout(() => {
      console.log('‚è∞ [AUTO-IMPORT] Timeout scaduto, chiamo executeAutoImport()');
      executeAutoImport();
    }, 500); // Piccolo delay per lasciare caricare la dashboard
  }
  
  // Log status
  console.log('ü§ñ [AUTO-IMPORT] Script caricato e pronto');
  console.log(\`üìä [AUTO-IMPORT] Config: enabled=\${AUTO_IMPORT_CONFIG.enabled}, silent=\${AUTO_IMPORT_CONFIG.silent}, interval=\${AUTO_IMPORT_CONFIG.minIntervalMinutes}min\`);
  
})();
<\/script>
`,c0=`<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Version: 2025-12-29-teal-fix -->
    <title>TeleMedCare V12.0 - Dashboard Principale</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .gradient-hero { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%); }
        .card-hover { 
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .card-hover:hover { 
            transform: translateY(-8px) scale(1.02); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        .icon-bounce:hover {
            animation: bounce 0.5s;
        }
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        /* üìê Responsiveness migliorata */
        @media (max-width: 640px) {
            .container { padding-left: 1rem; padding-right: 1rem; }
        }
        @media (min-width: 1536px) {
            .container { max-width: 1400px; }
        }
        
        /* üìä Layout tabelle migliorato */
        table { border-collapse: separate; border-spacing: 0; }
        .overflow-x-auto { 
            -webkit-overflow-scrolling: touch; 
            scrollbar-width: thin;
        }
        .overflow-x-auto::-webkit-scrollbar {
            height: 6px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5);
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-hero text-white shadow-2xl">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 xl:px-12 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-white bg-opacity-20 backdrop-blur p-3 rounded-xl">
                        <i class="fas fa-heartbeat text-4xl"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold">TeleMedCare V12.0</h1>
                        <p class="text-blue-100">Sistema Modulare Multi-Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="flex items-center bg-green-500 bg-opacity-30 px-4 py-2 rounded-full">
                        <span class="w-2 h-2 bg-green-400 rounded-full mr-2 pulse-dot"></span>
                        <span class="text-sm font-semibold">Sistema Online</span>
                    </span>
                    <div class="text-right">
                        <p class="text-sm font-medium">Medica GB S.r.l.</p>
                        <p class="text-xs text-blue-100">Milano - ISO 27001</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Stats -->
    <section class="container mx-auto px-4 sm:px-6 lg:px-8 xl:px-12 py-8">
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 sm:gap-5 lg:gap-6 mb-8">
            <!-- Lead Oggi -->
            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-100 text-sm mb-1">Lead Oggi</p>
                        <p class="text-3xl font-bold" id="leadsToday">-</p>
                        <p class="text-xs text-green-100 mt-1">Ultime 24h</p>
                    </div>
                    <i class="fas fa-users text-4xl text-green-200"></i>
                </div>
            </div>

            <!-- Contratti Oggi -->
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-100 text-sm mb-1">Contratti Oggi</p>
                        <p class="text-3xl font-bold" id="contractsToday">-</p>
                        <p class="text-xs text-purple-100 mt-1">Ultime 24h</p>
                    </div>
                    <i class="fas fa-file-contract text-4xl text-purple-200"></i>
                </div>
            </div>

            <!-- Proforma Oggi -->
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm mb-1">Proforma Oggi</p>
                        <p class="text-3xl font-bold" id="proformaToday">-</p>
                        <p class="text-xs text-blue-100 mt-1">Ultime 24h</p>
                    </div>
                    <i class="fas fa-file-invoice text-4xl text-blue-200"></i>
                </div>
            </div>

            <!-- Pagamenti Oggi -->
            <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white text-sm mb-1">Pagamenti Oggi</p>
                        <p class="text-3xl font-bold" id="paymentsToday">-</p>
                        <p class="text-xs text-white mt-1">Ultime 24h</p>
                    </div>
                    <i class="fas fa-euro-sign text-4xl text-white opacity-80"></i>
                </div>
            </div>

            <!-- Configurazioni Oggi -->
            <div id="boxConfigurazioni" style="background: linear-gradient(135deg, #ea580c 0%, #dc2626 100%) !important;" class="text-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p style="color: white !important; white-space: nowrap;" class="text-xs mb-1 font-semibold">Configurazioni Oggi</p>
                        <p style="color: white !important;" class="text-3xl font-bold" id="configurationsToday">0</p>
                        <p style="color: white !important;" class="text-xs mt-1 font-medium">Ultime 24h</p>
                    </div>
                    <i style="color: white !important;" class="fas fa-cog text-4xl"></i>
                </div>
            </div>

            <!-- Attivazioni Oggi -->
            <div class="bg-gradient-to-br from-pink-500 to-pink-600 text-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-pink-100 text-sm mb-1">Attivazioni Oggi</p>
                        <p class="text-3xl font-bold" id="activationsToday">-</p>
                        <p class="text-xs text-pink-100 mt-1">Ultime 24h</p>
                    </div>
                    <i class="fas fa-power-off text-4xl text-pink-200"></i>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Cards -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-th-large text-blue-500 mr-3"></i>
                Dashboard Sistema
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Dashboard Operativa -->
                <a href="/dashboard" class="bg-white rounded-xl shadow-md card-hover overflow-hidden border-2 border-transparent hover:border-purple-400">
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 p-6 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <i class="fas fa-chart-line text-5xl"></i>
                            <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-xs font-semibold">
                                PRINCIPALE
                            </span>
                        </div>
                        <h3 class="text-xl font-bold mb-2">Dashboard Operativa</h3>
                        <p class="text-purple-100 text-sm">Centro di controllo staff</p>
                    </div>
                    <div class="p-6">
                        <div class="space-y-3">
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                KPI e Metriche Real-time
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Grafici Servizi e Piani
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Ultimi Lead Ricevuti
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Auto-refresh 30s
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 rounded-lg transition-colors">
                                Accedi <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </a>

                <!-- Dashboard Leads -->
                <a href="/admin/leads-dashboard" class="bg-white rounded-xl shadow-md card-hover overflow-hidden border-2 border-transparent hover:border-green-400">
                    <div class="bg-gradient-to-r from-green-500 to-green-600 p-6 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <i class="fas fa-users text-5xl"></i>
                            <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-xs font-semibold">
                                LEADS
                            </span>
                        </div>
                        <h3 class="text-2xl font-bold mb-2">Dashboard Leads</h3>
                        <p class="text-green-100 text-sm">Analytics e conversioni</p>
                    </div>
                    <div class="p-6">
                        <div class="space-y-3">
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Tasso Conversione Lead
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Breakdown Servizi/Piani
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Statistiche per Canale
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Filtri Avanzati
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg transition-colors">
                                Accedi <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </a>

                <!-- Data Dashboard -->
                <a href="/admin/data-dashboard" class="bg-white rounded-xl shadow-md card-hover overflow-hidden border-2 border-transparent hover:border-blue-400">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-6 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <i class="fas fa-database text-5xl"></i>
                            <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-xs font-semibold">
                                ANALYTICS
                            </span>
                        </div>
                        <h3 class="text-2xl font-bold mb-2">Data Dashboard</h3>
                        <p class="text-blue-100 text-sm">KPI e Revenue aziendali</p>
                    </div>
                    <div class="p-6">
                        <div class="space-y-3">
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                5 KPI Principali
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Performance per Servizio
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Revenue Tracking
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Contratti Generati
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition-colors">
                                Accedi <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </a>

                <!-- Workflow Manager -->
                <a href="/admin/workflow-manager" class="bg-white rounded-xl shadow-md card-hover overflow-hidden border-2 border-transparent hover:border-red-400">
                    <div class="bg-gradient-to-r from-red-500 to-red-600 p-6 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <i class="fas fa-diagram-project text-5xl"></i>
                            <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-xs font-semibold">
                                WORKFLOW
                            </span>
                        </div>
                        <h3 class="text-2xl font-bold mb-2">Workflow Manager</h3>
                        <p class="text-red-100 text-sm">Gestione eventi manuali</p>
                    </div>
                    <div class="p-6">
                        <div class="space-y-3">
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Workflow Completo 6 Step
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Firma Contratto Manuale
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Pagamento Bonifico
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Monitoraggio Stato Lead
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-lg transition-colors">
                                Accedi <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        <!-- Servizi eCura -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-heartbeat text-red-500 mr-3"></i>
                Servizi eCura Disponibili
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- FAMILY -->
                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-blue-600">eCura FAMILY</h3>
                        <i class="fas fa-home text-2xl text-blue-500"></i>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Monitoraggio base per la famiglia</p>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">BASE:</span>
                            <span class="font-bold text-green-600">‚Ç¨390/anno</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">AVANZATO:</span>
                            <span class="font-bold text-green-600">‚Ç¨690/anno</span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500">
                        <i class="fas fa-check mr-1"></i>Dispositivo SiDLY CARE<br>
                        <i class="fas fa-check mr-1"></i>incluso SIM e APP per 12 mesi
                    </div>
                </div>

                <!-- PRO -->
                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-purple-600">eCura PRO</h3>
                        <i class="fas fa-star text-2xl text-purple-500"></i>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">SiDLY CARE PRO - Protezione avanzata con GPS</p>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">BASE:</span>
                            <span class="font-bold text-green-600">‚Ç¨480/anno</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">AVANZATO:</span>
                            <span class="font-bold text-green-600">‚Ç¨840/anno</span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500">
                        <i class="fas fa-check mr-1"></i>SiDLY CARE PRO Classe IIa<br>
                        <i class="fas fa-check mr-1"></i>Rilevamento cadute + GPS<br>
                        <i class="fas fa-check mr-1"></i>Pulsante SOS geolocalizzato
                    </div>
                </div>

                <!-- PREMIUM -->
                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-green-600">eCura PREMIUM</h3>
                        <i class="fas fa-crown text-2xl text-green-500"></i>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">SiDLY VITAL CARE - Monitoraggio completo</p>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">BASE:</span>
                            <span class="font-bold text-green-600">‚Ç¨590/anno</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">AVANZATO:</span>
                            <span class="font-bold text-green-600">‚Ç¨990/anno</span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500">
                        <i class="fas fa-check mr-1"></i>SiDLY VITAL CARE Classe IIa<br>
                        <i class="fas fa-check mr-1"></i>Monitoraggio parametri completo<br>
                        <i class="fas fa-check mr-1"></i>Dashboard famiglia premium
                    </div>
                </div>
            </div>
        </div>

        <!-- System Info -->
        <div class="bg-gradient-to-r from-gray-800 to-gray-900 text-white rounded-xl shadow-lg p-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-2xl font-bold mb-4">Sistema Integrato</h3>
                    <div class="space-y-2">
                        <p class="flex items-center text-gray-300">
                            <i class="fas fa-check-circle text-green-400 mr-3"></i>
                            Template contratti con 19 placeholder
                        </p>
                        <p class="flex items-center text-gray-300">
                            <i class="fas fa-check-circle text-green-400 mr-3"></i>
                            Prezzi aggiornati da www.ecura.it
                        </p>
                        <p class="flex items-center text-gray-300">
                            <i class="fas fa-check-circle text-green-400 mr-3"></i>
                            Generazione PDF automatica
                        </p>
                        <p class="flex items-center text-gray-300">
                            <i class="fas fa-check-circle text-green-400 mr-3"></i>
                            Invio email con brochure
                        </p>
                        <p class="flex items-center text-gray-300">
                            <i class="fas fa-check-circle text-green-400 mr-3"></i>
                            Dashboard real-time integrate
                        </p>
                    </div>
                </div>
                <div>
                    <h3 class="text-2xl font-bold mb-4">Informazioni Sistema</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between border-b border-gray-700 pb-2">
                            <span class="text-gray-400">Versione:</span>
                            <span class="font-mono text-green-400">V12.0 Modular Enterprise</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-700 pb-2">
                            <span class="text-gray-400">Ambiente:</span>
                            <span class="font-mono text-blue-400">Production Ready</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-700 pb-2">
                            <span class="text-gray-400">Database:</span>
                            <span class="font-mono text-purple-400">Cloudflare D1</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-700 pb-2">
                            <span class="text-gray-400">Email Service:</span>
                            <span class="font-mono text-yellow-400">Resend API</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Deployment:</span>
                            <span class="font-mono text-red-400">Cloudflare Workers</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Archivi e Documentazione -->
    <div class="container mx-auto px-6 mb-12">
        <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">
            <i class="fas fa-archive mr-2 text-amber-600"></i>
            Archivi e Documentazione
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
            <!-- Contratti e Proforma Personalizzati -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-4xl text-amber-500 mb-3 icon-bounce">
                        <i class="fas fa-file-contract"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Contratti & Proforma</h3>
                    <p class="text-gray-600 text-sm mb-4">Archivio contratti personalizzati e proforma</p>
                    <a href="/admin/contracts" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded text-sm transition-colors">
                        <i class="fas fa-folder-open mr-1"></i>Gestisci
                    </a>
                </div>
            </div>

            <!-- Contratti Firmati -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-4xl text-emerald-500 mb-3 icon-bounce">
                        <i class="fas fa-file-signature"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Contratti Firmati</h3>
                    <p class="text-gray-600 text-sm mb-4">Archivio contratti definitivi firmati</p>
                    <a href="/admin/signed-contracts" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded text-sm transition-colors">
                        <i class="fas fa-certificate mr-1"></i>Visualizza
                    </a>
                </div>
            </div>

            <!-- Documentazione -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-4xl text-indigo-500 mb-3 icon-bounce">
                        <i class="fas fa-book"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Documentazione</h3>
                    <p class="text-gray-600 text-sm mb-4">Lettura e modifica documentazione sistema</p>
                    <a href="/admin/docs" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded text-sm transition-colors">
                        <i class="fas fa-edit mr-1"></i>Modifica
                    </a>
                </div>
            </div>

            <!-- Template Manager -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-4xl text-pink-500 mb-3 icon-bounce">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Template Manager</h3>
                    <p class="text-gray-600 text-sm mb-4">Gestione template email e documenti</p>
                    <a href="/template-system" class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded text-sm transition-colors">
                        <i class="fas fa-palette mr-1"></i>Gestisci
                    </a>
                </div>
            </div>

            <!-- Magazzino DM -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-4xl text-teal-500 mb-3 icon-bounce">
                        <i class="fas fa-warehouse"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Magazzino DM</h3>
                    <p class="text-gray-600 text-sm mb-4">Gestione completa dispositivi medici e inventario</p>
                    <a href="/admin/warehouse" class="bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded text-sm transition-colors">
                        <i class="fas fa-boxes mr-1"></i>Gestisci
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Testing e Sviluppo -->
    <div class="container mx-auto px-6 mb-12">
        <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">
            <i class="fas fa-flask mr-2 text-red-600"></i>
            Testing e Sviluppo
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Testing Dashboard -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-5xl text-red-500 mb-4 icon-bounce">
                        <i class="fas fa-bug"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Testing Dashboard</h3>
                    <p class="text-gray-600 mb-4">Test funzionali e stress test automatizzati</p>
                    <a href="/admin/testing-dashboard" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-play mr-2"></i>Avvia Test
                    </a>
                </div>
            </div>

            <!-- Email Testing -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-5xl text-orange-500 mb-4 icon-bounce">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Email Testing</h3>
                    <p class="text-gray-600 mb-4">Test template email e invio messaggi</p>
                    <a href="/email-test" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-paper-plane mr-2"></i>Test Email
                    </a>
                </div>
            </div>

            <!-- Contract Testing -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-5xl text-teal-500 mb-4 icon-bounce">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Contract Testing</h3>
                    <p class="text-gray-600 mb-4">Test generazione contratti PDF</p>
                    <a href="/contract-test" class="bg-teal-500 hover:bg-teal-600 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-file-alt mr-2"></i>Test PDF
                    </a>
                </div>
            </div>
        </div>
    </div>

            <!-- Sezione Dispositivi e Sistema -->
            <div class="mb-12">
                <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">
                    <i class="fas fa-microchip mr-2 text-cyan-600"></i>
                    Dispositivi e Sistema
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Device Management -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-5xl text-cyan-500 mb-4 icon-bounce">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Gestione Dispositivi</h3>
                    <p class="text-gray-600 mb-4">Registrazione e monitoring dispositivi SiDLY</p>
                    <a href="/admin/devices" class="bg-cyan-500 hover:bg-cyan-600 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-cogs mr-2"></i>Gestisci
                    </a>
                </div>
            </div>

            <!-- System Status -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-5xl text-gray-500 mb-4 icon-bounce">
                        <i class="fas fa-server"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">System Status</h3>
                    <p class="text-gray-600 mb-4">Monitoraggio stato sistema e API</p>
                    <a href="/admin/system-status" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-heartbeat mr-2"></i>System Status
                    </a>
                </div>
            </div>

            <!-- Sistema Backup -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-5xl text-green-500 mb-4 icon-bounce">
                        <i class="fas fa-cloud-download-alt"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Sistema Backup</h3>
                    <p class="text-gray-600 mb-4">Backup automatico TEST/STAGING/PRODUZIONE</p>
                    <a href="/admin/backup-system" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-save mr-2"></i>Gestisci
                    </a>
                </div>
                </div>
            </div>

        </div>

        <!-- Footer -->
        <div class="bg-gray-800 text-white py-6 mt-16">
            <div class="container mx-auto px-6 text-center">
                <p class="text-lg">
                    <i class="fas fa-shield-alt mr-2 text-blue-400"></i>
                    TeleMedCare V12.0 Enterprise - Sistema Completo di TeleAssistenza
                </p>
                <p class="text-gray-400 mt-2">
                    Ambiente: <span class="text-green-400 font-semibold">Development</span> | 
                    Versione: <span class="text-blue-400 font-semibold">V12.0-Modular-Enterprise</span> |
                    Status: <span class="text-green-400 font-semibold">üü¢ Online</span>
                </p>
            </div>
        </div>

        <script>
            // Helper function to escape single quotes in strings to prevent syntax errors
            function escapeQuotes(str) {
                if (!str) return '';
                return String(str).replace(/'/g, "\\'");
            }
            
            // Effetto hover animato per le cards
            document.querySelectorAll('.card-hover').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-8px) scale(1.02)';
                });
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });

            // Controllo status in tempo reale
            async function checkSystemStatus() {
                try {
                    const response = await fetch('/api/system/status');
                    const status = await response.json();
                    console.log('System Status:', status);
                } catch (error) {
                    console.log('Status check failed:', error);
                }
            }
            
            // Check status ogni 30 secondi
            checkSystemStatus();
            setInterval(checkSystemStatus, 30000);
            
            // Load stats on page load (manteniamo per compatibilit√†)
            async function loadStats() {
            try {
                const response = await fetch('/api/data/stats');
                const stats = await response.json();
                
                // Lead Oggi
                if (stats.leadsToday !== undefined) {
                    document.getElementById('leadsToday').textContent = stats.leadsToday;
                }
                
                // Contratti Oggi
                if (stats.contractsToday !== undefined) {
                    document.getElementById('contractsToday').textContent = stats.contractsToday;
                } else if (stats.totalContracts !== undefined) {
                    // Fallback per compatibilit√†
                    document.getElementById('contractsToday').textContent = stats.totalContracts;
                }
                
                // Proforma Oggi
                if (stats.proformaToday !== undefined) {
                    document.getElementById('proformaToday').textContent = stats.proformaToday;
                }
                
                // Pagamenti Oggi
                if (stats.paymentsToday !== undefined) {
                    document.getElementById('paymentsToday').textContent = stats.paymentsToday;
                }
                
                // Configurazioni Oggi
                if (stats.configurationsToday !== undefined) {
                    document.getElementById('configurationsToday').textContent = stats.configurationsToday;
                }
                
                // Attivazioni Oggi
                if (stats.activationsToday !== undefined) {
                    document.getElementById('activationsToday').textContent = stats.activationsToday;
                }
            } catch (error) {
                console.log('Stats not yet available');
                // Set tutti a 0 in caso di errore
                document.getElementById('leadsToday').textContent = '0';
                document.getElementById('contractsToday').textContent = '0';
                document.getElementById('proformaToday').textContent = '0';
                document.getElementById('paymentsToday').textContent = '0';
                document.getElementById('configurationsToday').textContent = '0';
                document.getElementById('activationsToday').textContent = '0';
            }
        }

        loadStats();
    <\/script>
</body>
</html>
`,vT=`<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Operativa - TeleMedCare V12.0</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-sent { background: #dcfce7; color: #16a34a; }
        .status-pending { background: #fef3c7; color: #ca8a04; }
        .status-error { background: #fee2e2; color: #dc2626; }
        .refresh-btn {
            animation: rotate 1s linear infinite;
            animation-play-state: paused;
        }
        .refresh-btn.rotating {
            animation-play-state: running;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-chart-line text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Dashboard Operativa</h1>
                        <p class="text-purple-100">Centro di controllo staff - TeleMedCare V12.0</p>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <a href="/" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-home mr-2"></i>Home
                    </a>
                    <a href="/admin/leads-dashboard" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-users mr-2"></i>Leads
                    </a>
                    <button onclick="refreshData()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-sync-alt mr-2 refresh-btn" id="refreshIcon"></i>Aggiorna
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 xl:px-12 py-8" style="max-width: 1600px;">
        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Lead Totali</p>
                        <p class="text-3xl font-bold text-blue-600" id="totalLeads">-</p>
                        <p class="text-xs text-gray-500 mt-1">Ultimi 30 giorni</p>
                    </div>
                    <i class="fas fa-users text-3xl text-blue-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Contratti Inviati</p>
                        <p class="text-3xl font-bold text-green-600" id="contractsSent">-</p>
                        <p class="text-xs text-gray-500 mt-1">Ultimi 30 giorni</p>
                    </div>
                    <i class="fas fa-file-contract text-3xl text-green-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Email Inviate</p>
                        <p class="text-3xl font-bold text-purple-600" id="emailsSent">-</p>
                        <p class="text-xs text-gray-500 mt-1">Ultimi 30 giorni</p>
                    </div>
                    <i class="fas fa-envelope text-3xl text-purple-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-orange-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Servizio Pi√π Richiesto</p>
                        <p class="text-xl font-bold text-orange-600" id="topService">-</p>
                        <p class="text-xs text-gray-500 mt-1">Questo mese</p>
                    </div>
                    <i class="fas fa-star text-3xl text-orange-500"></i>
                </div>
            </div>
        </div>

        <!-- Import API Buttons per Canale -->
        <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
            <h3 class="text-lg font-bold text-gray-800 mb-4">
                <i class="fas fa-download mr-2 text-blue-600"></i>Import Lead da Canali
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <button onclick="importFromExcel()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold transition-all shadow-sm hover:shadow-md">
                    <i class="fas fa-file-excel mr-2"></i>Excel
                </button>
                <button onclick="importFromIrbema()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold transition-all shadow-sm hover:shadow-md">
                    <i class="fas fa-building mr-2"></i>Irbema
                </button>
                <button onclick="importFromAON()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold transition-all shadow-sm hover:shadow-md">
                    <i class="fas fa-handshake mr-2"></i>AON
                </button>
                <button onclick="importFromDoubleYou()" class="bg-pink-600 hover:bg-pink-700 text-white px-6 py-3 rounded-lg font-semibold transition-all shadow-sm hover:shadow-md" style="color: white !important; background-color: #db2777 !important;">
                    <i class="fas fa-chart-line mr-2"></i>DoubleYou
                </button>
            </div>
        </div>

        <!-- Settings: Switch ON/OFF - TUTTI E 4 GLI SWITCH SEMPRE VISIBILI -->
        <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
            <h3 class="text-lg font-bold text-gray-800 mb-4">
                <i class="fas fa-cog mr-2 text-purple-600"></i>Impostazioni Sistema
                <span class="ml-3 text-sm text-gray-500">(4 configurazioni attive)</span>
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
                <!-- 1. Import Automatico HubSpot -->
                <div class="p-4 bg-blue-50 rounded-lg border-2 border-blue-200 hover:border-blue-400 transition-all">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üîÑ</span>
                        <h4 class="font-semibold text-gray-800">Import Auto HubSpot</h4>
                    </div>
                    <p class="text-xs text-gray-600 mb-3">Import automatico giornaliero da HubSpot</p>
                    <select id="selectHubspotAuto" class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-medium" onchange="updateSetting('hubspot_auto_import_enabled', this.value)">
                        <option value="false">‚ùå OFF - Disattivato</option>
                        <option value="true">‚úÖ ON - Attivo</option>
                    </select>
                </div>
                
                <!-- 2. Email Automatiche Lead -->
                <div class="p-4 bg-green-50 rounded-lg border-2 border-green-200 hover:border-green-400 transition-all">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üìß</span>
                        <h4 class="font-semibold text-gray-800">Email Automatiche Lead</h4>
                    </div>
                    <p class="text-xs text-gray-600 mb-3">Email brochure, contratto, reminder ai lead</p>
                    <select id="selectLeadEmails" class="w-full px-3 py-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 font-medium" onchange="updateSetting('lead_email_notifications_enabled', this.value)">
                        <option value="false">‚ùå OFF - Disattivato</option>
                        <option value="true">‚úÖ ON - Attivo</option>
                    </select>
                </div>

                <!-- 3. Notifiche Email Admin -->
                <div class="p-4 bg-purple-50 rounded-lg border-2 border-purple-200 hover:border-purple-400 transition-all">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üîî</span>
                        <h4 class="font-semibold text-gray-800">Notifiche Email Admin</h4>
                    </div>
                    <p class="text-xs text-gray-600 mb-3">Abilita notifiche email a info@telemedcare.it</p>
                    <select id="selectAdminEmails" class="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 font-medium" onchange="updateSetting('admin_email_notifications_enabled', this.value)">
                        <option value="false">‚ùå OFF - Disattivato</option>
                        <option value="true">‚úÖ ON - Attivo</option>
                    </select>
                </div>

                <!-- 4. Reminder Automatici Completamento -->
                <div class="p-4 bg-orange-50 rounded-lg border-2 border-orange-200 hover:border-orange-400 transition-all">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">‚è∞</span>
                        <h4 class="font-semibold text-gray-800">Reminder Completamento</h4>
                    </div>
                    <p class="text-xs text-gray-600 mb-3">Reminder automatici per dati mancanti</p>
                    <select id="selectReminderCompletion" class="w-full px-3 py-2 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 font-medium" onchange="updateSetting('reminder_completion_enabled', this.value)">
                        <option value="false">‚ùå OFF - Disattivato</option>
                        <option value="true">‚úÖ ON - Attivo</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Script Settings: Definito QUI per essere disponibile agli handler inline -->
        <script>
            // ‚öôÔ∏è FUNZIONE UPDATE SETTING - Definita prima degli handler
            window.updateSetting = async function(key, value) {
                try {
                    console.log('üîÑ [SETTINGS] Aggiornamento setting:', key, '=', value);
                    
                    const response = await fetch('/api/settings/' + key, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ value: value })
                    });
                    
                    const result = await response.json();
                    
                    console.log('üîÑ [SETTINGS] Response:', result);
                    
                    if (result.success) {
                        alert('‚úÖ Impostazione aggiornata con successo!\\n\\n' + key + ' = ' + value);
                        console.log('‚úÖ [SETTINGS] Setting aggiornato:', key, '=', value);
                    } else {
                        alert('‚ùå Errore: ' + result.error);
                        console.error('‚ùå [SETTINGS] Errore:', result.error);
                    }
                } catch (error) {
                    console.error('‚ùå [SETTINGS] Errore aggiornamento setting:', error);
                    alert('‚ùå Errore di comunicazione: ' + error.message);
                }
            };
            
            console.log('‚úÖ [SETTINGS] Funzione window.updateSetting definita');
            
            // ‚öôÔ∏è FUNZIONE LOAD SETTINGS - Carica i valori dal DB
            window.loadSettings = async function() {
                try {
                    console.log('üì• [SETTINGS] Caricamento settings dal database...');
                    const response = await fetch('/api/settings');
                    const data = await response.json();
                    
                    console.log('üì• [SETTINGS] Response:', data);
                    
                    if (data.success && data.settings) {
                        const settings = data.settings;
                        
                        // Update select states - tutti e 4 i settings
                        if (settings.hubspot_auto_import_enabled) {
                            const value = settings.hubspot_auto_import_enabled.value;
                            console.log('‚úÖ [SETTINGS] HubSpot:', value);
                            const el = document.getElementById('selectHubspotAuto');
                            if (el) el.value = value;
                        }
                        if (settings.lead_email_notifications_enabled) {
                            const value = settings.lead_email_notifications_enabled.value;
                            console.log('‚úÖ [SETTINGS] Lead Emails:', value);
                            const el = document.getElementById('selectLeadEmails');
                            if (el) el.value = value;
                        }
                        if (settings.admin_email_notifications_enabled) {
                            const value = settings.admin_email_notifications_enabled.value;
                            console.log('‚úÖ [SETTINGS] Admin Emails:', value);
                            const el = document.getElementById('selectAdminEmails');
                            if (el) el.value = value;
                        }
                        if (settings.reminder_completion_enabled) {
                            const value = settings.reminder_completion_enabled.value;
                            console.log('‚úÖ [SETTINGS] Reminder:', value);
                            const el = document.getElementById('selectReminderCompletion');
                            if (el) el.value = value;
                        }
                        
                        console.log('‚úÖ [SETTINGS] Tutti e 4 gli switch caricati correttamente');
                    } else {
                        console.error('‚ùå [SETTINGS] Risposta API non valida:', data);
                    }
                } catch (error) {
                    console.error('‚ùå [SETTINGS] Errore caricamento settings:', error);
                }
            };
            
            console.log('‚úÖ [SETTINGS] Funzione window.loadSettings definita');
            
            // Carica settings al caricamento pagina
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', window.loadSettings);
            } else {
                window.loadSettings();
            }
        <\/script>

        <!-- Elenco Assistiti -->
        <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-users text-green-500 mr-2"></i>
                    Assistiti Attivi
                    <span id="assistitiCount" class="ml-3 text-sm bg-green-100 text-green-700 px-3 py-1 rounded-full font-bold">0</span>
                </h3>
                <div class="flex space-x-2">
                    <input 
                        type="text" 
                        id="searchAssistitoCognome" 
                        class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-56" 
                        placeholder="üîç Cerca assistito..."
                        onkeyup="filterAssistiti()"
                    />
                    <button onclick="nuovoAssistito()" class="flex items-center px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-user-plus mr-2"></i>
                        Nuovo Assistito
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-200 text-left">
                            <th class="pb-3 text-sm font-semibold text-gray-600">Assistito</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">IMEI Dispositivo</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Email</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Telefono</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Servizio</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Piano</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Prezzo</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Status</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="assistitiTable">
                        <tr>
                            <td colspan="9" class="py-8 text-center text-gray-400">
                                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                <p>Caricamento assistiti...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analisi Lead: Servizi, Piani e Fonti (Compattati su 1 riga) -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 sm:gap-6 lg:gap-8 mb-8">
            <!-- Distribuzione Servizi -->
            <div class="bg-white p-5 sm:p-6 lg:p-7 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-pie text-purple-500 mr-2"></i>
                    Distribuzione Servizi
                </h3>
                <div id="servicesChart" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Piano BASE vs AVANZATO -->
            <div class="bg-white p-5 sm:p-6 lg:p-7 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-bar text-blue-500 mr-2"></i>
                    Piano BASE vs AVANZATO
                </h3>
                <div id="plansChart" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
            </div>


            <!-- Distribuzione per Fonte -->
            <div class="bg-white p-5 sm:p-6 lg:p-7 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-source text-teal-500 mr-2"></i>
                    Distribuzione per Fonte
                </h3>
                <div id="fontesDistribution" class="space-y-3">
                    <!-- Distribuzione fonti verr√† popolata dinamicamente -->
                </div>
            </div>
        </div>

        <!-- Ultimi Lead Ricevuti -->
        <div class="bg-white rounded-xl shadow-sm p-5 sm:p-6 lg:p-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-clock text-green-500 mr-2"></i>
                    Ultimi Lead Ricevuti
                </h3>
                <span class="text-sm text-gray-500" id="lastUpdate">Aggiornato ora</span>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full table-auto">
                    <thead>
                        <tr class="border-b-2 border-gray-200 text-left">
                            <th class="pb-3 px-2 text-sm font-semibold text-gray-600 whitespace-nowrap">Lead ID</th>
                            <th class="pb-3 px-2 text-sm font-semibold text-gray-600 min-w-[180px]">Cliente</th>
                            <th class="pb-3 px-2 text-sm font-semibold text-gray-600 whitespace-nowrap">Telefono</th>
                            <th class="pb-3 px-2 text-sm font-semibold text-gray-600 whitespace-nowrap">Servizio</th>
                            <th class="pb-3 px-2 text-sm font-semibold text-gray-600 whitespace-nowrap">Piano</th>
                            <th class="pb-3 px-2 text-sm font-semibold text-gray-600 whitespace-nowrap">Dispositivo</th>
                            <th class="pb-3 px-2 text-sm font-semibold text-gray-600 whitespace-nowrap">Prezzo</th>
                            <th class="pb-3 px-2 text-sm font-semibold text-gray-600 whitespace-nowrap">Contratto</th>
                            <th class="pb-3 px-2 text-sm font-semibold text-gray-600 whitespace-nowrap">Data</th>
                        </tr>
                    </thead>
                    <tbody id="leadsTable">
                        <tr>
                            <td colspan="9" class="py-8 text-center text-gray-400">
                                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                <p>Caricamento dati...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Helper function to escape HTML special characters
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        let refreshInterval;
        let isLoading = false;

        // Carica dati iniziali
        loadDashboardData();

        // Auto-refresh ogni 30 secondi (solo se non sta gi√† caricando)
        refreshInterval = setInterval(() => {
            if (!isLoading) {
                loadDashboardData();
            }
        }, 30000);

        async function loadDashboardData() {
            // Previeni chiamate sovrapposte
            if (isLoading) return;
            
            isLoading = true;
            try {
                // MIGRAZIONE AUTOMATICA SCHEMA (eseguita una sola volta)
                try {
                    const migrateResponse = await fetch('/api/migrate-schema', { method: 'POST' });
                    const migrateData = await migrateResponse.json();
                    if (migrateData.success) {
                        console.log('‚úÖ Migrazione schema:', migrateData.migrations);
                    }
                } catch (migrateError) {
                    console.warn('‚ö†Ô∏è Migrazione schema saltata:', migrateError);
                }
                
                // Carica TUTTI i lead (limite massimo 999999)
                // ‚úÖ Aggiungi timestamp per evitare cache del browser
                const cacheBuster = Date.now();
                const allLeadsResponse = await fetch(\`/api/leads?limit=999999&_=\${cacheBuster}\`);
                const allLeadsData = await allLeadsResponse.json();
                const allLeads = allLeadsData.leads || [];
                
                // Carica CONTRATTI reali per conteggio accurato
                const contractsResponse = await fetch('/api/contratti?limit=100');
                const contractsData = await contractsResponse.json();
                const contracts = contractsData.contracts || contractsData.contratti || contractsData.data || [];
                
                // Carica ASSISTITI reali con IMEI
                const assistitiResponse = await fetch('/api/assistiti');
                const assistitiData = await assistitiResponse.json();
                const assistiti = assistitiData.assistiti || [];
                
                // Calcola statistiche reali
                const totalLeads = allLeads.length;
                const contratti = contracts.length; // Conta contratti reali, non lead convertiti
                const topService = 'eCura PRO';
                
                // Aggiorna KPI
                document.getElementById('totalLeads').textContent = totalLeads;
                document.getElementById('contractsSent').textContent = contratti;
                document.getElementById('emailsSent').textContent = '0'; // TODO
                document.getElementById('topService').textContent = topService;

                // Filtra ultimi 3 mesi (90 giorni) e NON convertiti
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setDate(threeMonthsAgo.getDate() - 90);
                
                // REGOLA: Mostra solo lead NON convertiti (senza hardcoding)
                // Un lead √® DAVVERO convertito SOLO se ha:
                // 1. Status: CONVERTED, CONTRACT_SIGNED, ACTIVE
                // 2. Note con parole chiave FORTE: "firmato", "pagato", "consegnato", "attivo"
                // 
                // IMPORTANTE: "inviato contratto" NON significa convertito!
                // Solo quando c'√® conferma di firma/pagamento/consegna
                
                const recentLeads = allLeads.filter(lead => {
                    const leadDate = new Date(lead.created_at || lead.timestamp);
                    const status = (lead.status || '').toUpperCase();
                    const isRecent = leadDate >= threeMonthsAgo;
                    
                    // Controlla se lo status indica conversione REALE
                    const statusConverted = ['CONVERTED', 'CONTRACT_SIGNED', 'ACTIVE'].includes(status);
                    
                    // Controlla se le note indicano conversione REALE (non solo "inviato")
                    const note = (lead.note || lead.notes || '').toLowerCase();
                    const noteConverted = 
                        note.includes('firmato') ||           // Contratto firmato
                        note.includes('pagato') ||            // Pagamento ricevuto
                        note.includes('consegnato') ||        // Dispositivo consegnato
                        note.includes('attivo') ||            // Servizio attivo
                        note.includes('installato') ||        // Dispositivo installato
                        (note.includes('contratto') && note.includes('firmato')) ||  // "contratto firmato"
                        (note.includes('contratto') && note.includes('pagato'));     // "contratto pagato"
                    
                    // Lead √® convertito SOLO se status O note indicano conversione REALE
                    const notConverted = !statusConverted && !noteConverted;
                    
                    return isRecent && notConverted;
                });
                
                // Ultimi 10 lead recenti non convertiti per la tabella (ordinati dal pi√π recente)
                const leads = recentLeads
                    .sort((a, b) => {
                        const dateA = new Date(a.created_at || a.timestamp);
                        const dateB = new Date(b.created_at || b.timestamp);
                        return dateB - dateA; // DESC: pi√π recenti prima
                    })
                    .slice(0, 10);

                // Popola tabella lead
                const tbody = document.getElementById('leadsTable');
                if (leads.length === 0) {
                    tbody.innerHTML = \`
                        <tr>
                            <td colspan="9" class="py-8 text-center text-gray-400">
                                Nessun lead trovato
                            </td>
                        </tr>
                    \`;
                } else {
                    tbody.innerHTML = leads.map(lead => {
                        // ‚úÖ USA SERVIZIO E PREZZO DAL DATABASE
                        const servizio = lead.servizio || lead.tipoServizio || 'eCura PRO';
                        const piano = lead.piano || ((lead.note && lead.note.includes('Piano: AVANZATO')) ? 'AVANZATO' : 'BASE');
                        // Determina dispositivo in base al servizio
                        const servizioType = servizio ? servizio.replace('eCura ', '') : 'PRO';
                        const dispositivo = servizioType.includes('PREMIUM') ? 'SiDLY VITAL CARE' : 'SiDLY CARE PRO';
                        
                        // ‚úÖ CALCOLO PREZZO CORRETTO: considera servizio + piano
                        let prezzoFallback = 480; // Default: PRO BASE
                        if (servizioType.includes('FAMILY')) {
                          prezzoFallback = piano === 'AVANZATO' ? 690 : 390;
                        } else if (servizioType.includes('PREMIUM')) {
                          prezzoFallback = piano === 'AVANZATO' ? 990 : 590;
                        } else {
                          prezzoFallback = piano === 'AVANZATO' ? 840 : 480;
                        }
                        const prezzo = lead.prezzo_anno || prezzoFallback;
                        
                        const statusClass = (lead.vuoleBrochure === 'Si') ? 'status-sent' : 'status-pending';
                        const statusText = (lead.vuoleBrochure === 'Si') ? 'Inviata brochure' : 'Da contattare';
                        const telefono = lead.telefono || 'N/A';
                        const date = new Date(lead.created_at).toLocaleString('it-IT', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        return \`
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="py-3 px-2 text-sm whitespace-nowrap">
                                    <code class="bg-gray-100 px-2 py-1 rounded text-xs" title="\${escapeHtml(lead.id)}">\${formatLeadId(lead.id)}</code>
                                </td>
                                <td class="py-3 px-2 text-sm min-w-[180px]">
                                    <div class="font-medium">\${escapeHtml(lead.nomeRichiedente)} \${escapeHtml(lead.cognomeRichiedente)}</div>
                                    <div class="text-xs text-gray-500">\${escapeHtml(lead.email)}</div>
                                </td>
                                <td class="py-3 px-2 text-sm text-gray-600" whitespace-nowrap>\${telefono}</td>
                                <td class="py-3 px-2 text-sm font-medium text-purple-600" whitespace-nowrap>\${servizio}</td>
                                <td class="py-3 px-2 text-sm" whitespace-nowrap>\${piano}</td>
                                <td class="py-3 px-2 text-sm text-gray-600" whitespace-nowrap>\${dispositivo}</td>
                                <td class="py-3 px-2 text-sm font-bold text-green-600" whitespace-nowrap>‚Ç¨\${prezzo}</td>
                                <td class="py-3 px-2" whitespace-nowrap>
                                    <span class="status-badge \${statusClass}" whitespace-nowrap>\${statusText}</span>
                                </td>
                                <td class="py-3 px-2 text-xs text-gray-500" whitespace-nowrap>\${date}</td>
                            </tr>
                        \`;
                    }).join('');
                }

                // Salva tutti i lead per i grafici
                window.allLeadsData = allLeads;
                
                // Aggiorna grafici: servizi basati su ASSISTITI, piani basati su ASSISTITI
                updateServicesChart(assistiti);  // ‚ö†Ô∏è FIX: usa assistiti non lead
                updatePlansChart(allLeads);
                //                 updateChannelsDistribution(assistiti);  // Analizza solo assistiti attivi
                
                // Renderizza assistiti da API dedicata
                allAssistiti = assistiti;  // Salva per filtri
                renderAssistitiTable(assistiti);

                // Aggiorna timestamp
                document.getElementById('lastUpdate').textContent = \`Aggiornato: \${new Date().toLocaleTimeString('it-IT')}\`;

            } catch (error) {
                console.error('Errore caricamento dashboard:', error);
                // Mostra dettagli errore per debugging
                const errorMsg = error.message || 'Errore sconosciuto';
                document.getElementById('leadsTable').innerHTML = \`
                    <tr>
                        <td colspan="8" class="py-8 text-center text-red-500">
                            <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                            <p class="font-bold">Errore nel caricamento dei dati</p>
                            <p class="text-xs mt-2">\${errorMsg}</p>
                            <button id="retryLoadDashboard" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                <i class="fas fa-redo mr-2"></i>Riprova
                            </button>
                        </td>
                    </tr>
                \`;
                setTimeout(() => {
                    const retryBtn = document.getElementById('retryLoadDashboard');
                    if (retryBtn) retryBtn.addEventListener('click', loadDashboardData);
                }, 0);
            } finally {
                isLoading = false;
            }
        }

        
        function importFromChannel(channel) {
            if (confirm(\`üì• Vuoi importare i lead dal canale \${channel}?\\n\\nQuesta operazione:
- Scaricher√† i nuovi lead da \${channel}
- Aggiorner√† il database
- Sincronizzer√† i dati\\n\\nProcedi?\`)) {
                // Mostra loading
                const btn = event.target.closest('button');
                const originalHTML = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Importazione...';
                
                fetch(\`/api/leads/import/\${channel.toLowerCase()}\`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(res => res.json())
                .then(data => {
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                    
                    if (data.success) {
                        alert('‚úÖ Import completato!\\n\\nCanale: ' + channel + '\\nLead importati: ' + (data.count || 0) + '\\nTotale lead: ' + (data.total || 0));
                        loadDashboardData(); // Ricarica dashboard
                    } else {
                        alert('‚ùå Errore import:\\n\\n' + (data.error || 'Errore sconosciuto'));
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                    alert('‚ùå Errore di comunicazione:\\n\\n' + error.message);
                });
            }
        }

        function refreshData() {
            const icon = document.getElementById('refreshIcon');
            icon.classList.add('rotating');
            loadDashboardData().finally(() => {
                setTimeout(() => icon.classList.remove('rotating'), 1000);
            });
        }

        function getDispositivoForService(servizio) {
            const dispositivi = {
                'FAMILY': 'SiDLY CARE PRO',
                'PRO': 'SiDLY CARE PRO',
                'PREMIUM': 'SiDLY VITAL CARE'
            };
            return dispositivi[servizio] || 'N/A';
        }

        function getPrezzoForService(servizio, piano) {
            const prezzi = {
                'FAMILY': { 'BASE': '390.00', 'AVANZATO': '690.00' },
                'PRO': { 'BASE': '480.00', 'AVANZATO': '840.00' },
                'PREMIUM': { 'BASE': '590.00', 'AVANZATO': '990.00' }
            };
            return prezzi[servizio]?.[piano] || '0.00';
        }

        function updateServicesChart(assistiti) {
            // FIX: Usa assistiti attivi, non lead
            const total = assistiti.length || 1;
            
            // Conta servizi basandosi sui piani degli assistiti
            // eCura PRO BASE e AVANZATO (tutti gli assistiti attuali)
            const serviceCounts = {
                'eCura PRO': total  // Tutti gli assistiti attivi sono eCura PRO
            };

            const colors = {
                'eCura PRO': 'bg-purple-500',
                'eCura FAMILY': 'bg-blue-500',
                'eCura PREMIUM': 'bg-green-500'
            };

            const html = Object.entries(serviceCounts).map(([service, count]) => {
                const percentage = 100; // Sempre 100% per eCura PRO
                const color = colors[service] || 'bg-gray-500';
                return \`
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700">\${service}</span>
                            <span class="text-sm font-bold text-gray-900">\${count} (\${percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="\${color} h-2 rounded-full" style="width: \${percentage}%"></div>
                        </div>
                    </div>
                \`;
            }).join('');

            document.getElementById('servicesChart').innerHTML = html || '<p class="text-gray-400 text-sm">Nessun dato disponibile</p>';
        }

        function updatePlansChart(leads) {
            // USA SOLO ASSISTITI per conteggio piani (non tutti i lead)
            const assistitiResponse = fetch('/api/assistiti').then(r => r.json()).then(data => {
                const assistiti = data.assistiti || [];
                const planCounts = { 'BASE': 0, 'AVANZATO': 0 };
                
                // Conta i piani reali basati sui contratti degli assistiti
                assistiti.forEach(assistito => {
                    const piano = assistito.piano || 'BASE';
                    if (piano === 'AVANZATO') {
                        planCounts.AVANZATO++;
                    } else {
                        planCounts.BASE++;
                    }
                });

                const total = assistiti.length || 1;
                const basePercentage = Math.round((planCounts.BASE / total) * 100);
                const avanzatoPercentage = Math.round((planCounts.AVANZATO / total) * 100);

                document.getElementById('plansChart').innerHTML = \`
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700">BASE</span>
                            <span class="text-sm font-bold text-gray-900">\${planCounts.BASE} (\${basePercentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: \${basePercentage}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700">AVANZATO</span>
                            <span class="text-sm font-bold text-gray-900">\${planCounts.AVANZATO} (\${avanzatoPercentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-purple-500 h-2 rounded-full" style="width: \${avanzatoPercentage}%"></div>
                        </div>
                    </div>
                \`;
            });
        }
        
        // Funzione per formattare ID lead - mostra ID completo in formato LEAD-CANALE-NUMERO
        function formatLeadId(leadId) {
            if (!leadId) return 'N/A';
            const id = leadId.toString();
            
            // Mostra l'ID completo (formato LEAD-IRBEMA-xxxxx)
            return id;
        }
        
        function updateChannelsDistribution(assistiti) {
            // Analizza SOLO gli ASSISTITI ATTIVI per identificare il canale di provenienza
            const channelCounts = {};
            const channelColors = {
                'Irbema': 'bg-blue-500',
                'Excel': 'bg-green-500',
                'Web': 'bg-indigo-600',
                'Networking': 'bg-purple-500',
                'AON': 'bg-orange-500',
                'DoubleYou': 'bg-pink-500'
            };
            
            assistiti.forEach(assistito => {
                let canale = 'Web'; // Default
                
                // Estrai info assistito - prova vari nomi campo
                const leadId = (assistito.id || '').toString().toUpperCase();
                const email = (
                    assistito.email || 
                    assistito.email || 
                    assistito.email_richiedente ||
                    assistito.emailrichiedente ||
                    ''
                ).toLowerCase().trim();
                const nomeCompleto = \`\${escapeHtml(assistito.nomeRichiedente || assistito.nome_richiedente || assistito.nome || '')} \${escapeHtml(assistito.cognomeRichiedente || assistito.cognome_richiedente || assistito.cognome || '')}\`.trim().toLowerCase();
                const canaleField = (assistito.canale || assistito.origine || '').toLowerCase();
                
                // ‚ö° MAPPATURA BASATA SU DATI REALI: Identifica canale da nome assistito
                // PRIORIT√Ä 1: Laura Calvi = Networking (unico caso da stefania.rocca@medicagb.it)
                if (nomeCompleto.includes('laura calvi') || 
                    email.includes('stefania.rocca@medicagb.it')) {
                    canale = 'Networking';
                    console.log('‚úÖ Networking:', nomeCompleto);
                }
                // PRIORIT√Ä 2: Tutti gli altri assistiti attivi = Irbema (da Excel colonna F: info@irbema.com)
                // Lista verificata dall'Excel: Elena Saglia, Paolo Magri, Caterina D'Alterio, 
                // Simona Pizzutto, Elisabetta Cattini, e gli assistiti attuali nel DB
                else if (
                    nomeCompleto.includes('elena') || nomeCompleto.includes('saglia') ||
                    nomeCompleto.includes('paolo') || nomeCompleto.includes('magri') ||
                    nomeCompleto.includes('caterina') || nomeCompleto.includes('alterio') ||
                    nomeCompleto.includes('simona') || nomeCompleto.includes('pizzutto') ||
                    nomeCompleto.includes('elisabetta') || nomeCompleto.includes('cattini') ||
                    nomeCompleto.includes('giuliana') || nomeCompleto.includes('balzarotti') ||
                    nomeCompleto.includes('rita') || nomeCompleto.includes('pennacchio') ||
                    nomeCompleto.includes('maria') || nomeCompleto.includes('capone') ||
                    nomeCompleto.includes('giuseppina') || nomeCompleto.includes('cozzi') ||
                    nomeCompleto.includes('eileen') || nomeCompleto.includes('king')
                ) {
                    canale = 'Irbema';
                    console.log('‚úÖ Irbema:', nomeCompleto, '(da mappatura Excel)');
                }
                // PRIORIT√Ä 3: Altri canali (Excel, AON, DoubleYou) - solo se campo canale popolato
                else if (canaleField.includes('excel') || leadId.includes('LEAD-EXCEL')) {
                    canale = 'Excel';
                } else if (canaleField.includes('aon')) {
                    canale = 'AON';
                } else if (canaleField.includes('doubleyou') || canaleField.includes('double')) {
                    canale = 'DoubleYou';
                } else if (canaleField.includes('network')) {
                    canale = 'Networking';
                } else {
                    // Se non riconosciuto, rimane Web (default)
                    console.log('‚ö†Ô∏è  Web (default):', nomeCompleto);
                }
                
                channelCounts[canale] = (channelCounts[canale] || 0) + 1;
            });
            
            // DEBUG: Mostra distribuzione finale
            console.log('üìä Distribuzione Canali:', channelCounts);
            
            const total = assistiti.length || 1;
            let html = '';
            
            // Ordina per count discendente
            const sortedChannels = Object.entries(channelCounts).sort((a, b) => b[1] - a[1]);
            
            if (sortedChannels.length === 0) {
                html = '<p class="text-gray-400 text-sm text-center py-4">Nessun dato disponibile</p>';
            } else {
                sortedChannels.forEach(([canale, count]) => {
                    const percentage = Math.round((count / total) * 100);
                    const color = channelColors[canale] || 'bg-gray-500';
                    
                    html += \`
                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-medium text-gray-700">\${canale}</span>
                                <span class="text-sm font-bold text-gray-900">\${count} (\${percentage}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="\${color} h-2 rounded-full" style="width: \${percentage}%"></div>
                            </div>
                        </div>
                    \`;
                });
            }
            
            document.getElementById('channelsDistribution').innerHTML = html;
        }

        function updateFontesDistribution(leads) {
            // Analizza le fonti dei lead
            const fonteCounts = {};
            const fonteColors = {
                'Sito www.eCura.it': 'bg-cyan-500',
                'Privati IRBEMA': 'bg-blue-500',
                'Form eCura': 'bg-green-500',
                'Form eCura x Test': 'bg-yellow-500',
                'B2B IRBEMA': 'bg-purple-500',
                'Sito web Medica GB': 'bg-pink-500',
                'NETWORKING': 'bg-indigo-500',
                'Form Contattaci': 'bg-teal-500'
            };
            
            leads.forEach(lead => {
                const fonte = lead.fonte || 'Non specificata';
                fonteCounts[fonte] = (fonteCounts[fonte] || 0) + 1;
            });
            
            console.log('üìä Distribuzione Fonti:', fonteCounts);
            
            const total = leads.length || 1;
            let html = '';
            
            // Ordina per count discendente
            const sortedFontes = Object.entries(fonteCounts).sort((a, b) => b[1] - a[1]);
            
            if (sortedFontes.length === 0) {
                html = '<p class="text-gray-400 text-sm text-center py-4">Nessun dato disponibile</p>';
            } else {
                sortedFontes.forEach(([fonte, count]) => {
                    const percentage = Math.round((count / total) * 100);
                    const color = fonteColors[fonte] || 'bg-gray-500';
                    
                    html += \`
                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-medium text-gray-700">\${fonte}</span>
                                <span class="text-sm font-bold text-gray-900">\${count} (\${percentage}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="\${color} h-2 rounded-full" style="width: \${percentage}%"></div>
                            </div>
                        </div>
                    \`;
                });
            }
            
            document.getElementById('fontesDistribution').innerHTML = html;
        }

        // ========== CRUD ASSISTITI (DEFINITE PRIMA DI renderAssistitiTable) ==========
        
        async function viewAssistito(id) {
            try {
                const response = await fetch('/api/assistiti?id=' + id);
                const data = await response.json();
                
                if (data.success && data.assistiti && data.assistiti.length > 0) {
                    const assistito = data.assistiti[0];
                    
                    // Mostra modal dettagli assistito
                    alert('üìã Dettagli Assistito\\n\\n' +
                        'Nome: ' + (assistito.nome_assistito || '') + ' ' + (assistito.cognome_assistito || '') + '\\n' +
                        'Caregiver: ' + (assistito.nome_caregiver || 'N/A') + ' ' + (assistito.cognome_caregiver || '') + '\\n' +
                        'Parentela: ' + (assistito.parentela_caregiver || 'N/A') + '\\n' +
                        'IMEI: ' + (assistito.imei || 'N/A') + '\\n' +
                        'Email: ' + (assistito.email || 'N/A') + '\\n' +
                        'Telefono: ' + (assistito.telefono || 'N/A') + '\\n' +
                        'Piano: ' + (assistito.piano || 'BASE') + '\\n' +
                        'Contratto: ' + (assistito.codice_contratto || 'Nessuno') + '\\n' +
                        'Status: ' + (assistito.contratto_status || assistito.status || 'N/A')
                    );
                } else {
                    alert('‚ùå Assistito non trovato');
                }
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
            }
        }
        window.viewAssistito = viewAssistito;  // Esponi globalmente
        
        async function editAssistito(id) {
            try {
                const response = await fetch('/api/assistiti?id=' + id);
                const data = await response.json();
                
                if (data.success && data.assistiti && data.assistiti.length > 0) {
                    const assistito = data.assistiti[0];
                    
                    // Richiedi nuovi dati
                    const nuovoNome = prompt('Nome Assistito:', assistito.nome_assistito || '');
                    if (!nuovoNome) return;
                    
                    const nuovoCognome = prompt('Cognome Assistito:', assistito.cognome_assistito || '');
                    if (!nuovoCognome) return;
                    
                    const nuovaEmail = prompt('Email:', assistito.email || '');
                    const nuovoTelefono = prompt('Telefono:', assistito.telefono || '');
                    const nuovoIMEI = prompt('IMEI Dispositivo:', assistito.imei || '');
                    
                    const caregiverNome = prompt('Nome Caregiver:', assistito.nome_caregiver || '');
                    const caregiverCognome = prompt('Cognome Caregiver:', assistito.cognome_caregiver || '');
                    const parentela = prompt('Parentela Caregiver:', assistito.parentela_caregiver || '');
                    
                    // Aggiorna
                    const updateResponse = await fetch(\`/api/assistiti/\${id}\`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            nome_assistito: nuovoNome,
                            cognome_assistito: nuovoCognome,
                            nome_caregiver: caregiverNome,
                            cognome_caregiver: caregiverCognome,
                            parentela_caregiver: parentela,
                            email: nuovaEmail,
                            telefono: nuovoTelefono,
                            imei: nuovoIMEI
                        })
                    });
                    
                    const result = await updateResponse.json();
                    
                    if (result.success) {
                        alert('‚úÖ Assistito aggiornato con successo!');
                        loadDashboardData(); // Ricarica dashboard
                    } else {
                        alert('‚ùå Errore: ' + result.error);
                    }
                } else {
                    alert('‚ùå Assistito non trovato');
                }
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
            }
        }
        window.editAssistito = editAssistito;  // Esponi globalmente
        
        async function deleteAssistito(id) {
            // Trova l'assistito nell'array globale per ottenere il nome
            const assistito = allAssistiti.find(a => a.id === id);
            const nome = assistito ? 
                (assistito.nome || ((assistito.nome_assistito || '') + ' ' + (assistito.cognome_assistito || '')).trim() || 'questo assistito') 
                : 'questo assistito';
            
            if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare l\\'assistito ' + nome + '?\\n\\nQuesta azione non pu√≤ essere annullata!')) {
                return;
            }
            
            try {
                const response = await fetch(\`/api/assistiti/\${id}\`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Assistito ' + nome + ' eliminato con successo!');
                    loadDashboardData(); // Ricarica dashboard
                } else {
                    alert('‚ùå Errore: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
            }
        }
        window.deleteAssistito = deleteAssistito;  // Esponi globalmente
        
        async function editAssistito(id) {
            try {
                const response = await fetch('/api/assistiti?id=' + id);
                const data = await response.json();
                
                if (data.success && data.assistiti && data.assistiti.length > 0) {
                    const assistito = data.assistiti[0];
                    
                    // Verifica che il modal esista
                    const modal = document.getElementById('editAssistitoModal');
                    if (!modal) {
                        console.error('Modal editAssistitoModal non trovato');
                        alert('‚ùå Errore: Modal non trovato. Ricaricare la pagina.');
                        return;
                    }
                    
                    // Popola form modal con controlli
                    const setValueSafe = (id, value) => {
                        const el = document.getElementById(id);
                        if (el) el.value = value || '';
                        else console.warn(\`Elemento \${id} non trovato\`);
                    };
                    
                    setValueSafe('editAssistitoId', id);
                    setValueSafe('editNomeAssistito', assistito.nome_assistito);
                    setValueSafe('editCognomeAssistito', assistito.cognome_assistito);
                    setValueSafe('editEmailAssistito', assistito.email);
                    setValueSafe('editTelefonoAssistito', assistito.telefono);
                    setValueSafe('editIMEI', assistito.imei);
                    setValueSafe('editServizioAssistito', assistito.servizio || 'eCura PRO');
                    setValueSafe('editNomeCaregiver', assistito.nome_caregiver);
                    setValueSafe('editCognomeCaregiver', assistito.cognome_caregiver);
                    setValueSafe('editParentela', assistito.parentela_caregiver);
                    setValueSafe('editPianoAssistito', assistito.piano || 'BASE');
                    
                    // Aggiorna prezzi dinamicamente
                    setTimeout(() => updatePrezziServizio(), 100);
                    
                    // Mostra modal
                    modal.classList.remove('hidden');
                } else {
                    alert('‚ùå Assistito non trovato');
                }
            } catch (error) {
                console.error('Errore editAssistito:', error);
                alert('‚ùå Errore: ' + error.message);
            }
        }
        window.editAssistito = editAssistito;  // Esponi globalmente
        
        async function saveEditAssistito() {
            const id = document.getElementById('editAssistitoId').value;
            const nomeAssistito = document.getElementById('editNomeAssistito').value;
            const cognomeAssistito = document.getElementById('editCognomeAssistito').value;
            const email = document.getElementById('editEmailAssistito').value;
            const telefono = document.getElementById('editTelefonoAssistito').value;
            const imei = document.getElementById('editIMEI').value;
            const servizio = document.getElementById('editServizioAssistito').value;
            const nomeCaregiver = document.getElementById('editNomeCaregiver').value;
            const cognomeCaregiver = document.getElementById('editCognomeCaregiver').value;
            const parentela = document.getElementById('editParentela').value;
            const piano = document.getElementById('editPianoAssistito').value;
            
            // DEBUG: Log dei dati raccolti
            console.log('üìù SAVE EDIT ASSISTITO:', {
                id,
                nomeAssistito,
                cognomeAssistito,
                servizio,
                piano,
                email,
                telefono,
                imei
            });
            
            if (!nomeAssistito || !cognomeAssistito || !imei) {
                alert('‚ö†Ô∏è Campi obbligatori: Nome, Cognome e IMEI');
                return;
            }
            
            const payload = {
                nome_assistito: nomeAssistito,
                cognome_assistito: cognomeAssistito,
                email: email,
                telefono: telefono,
                imei: imei,
                servizio: servizio,
                nome_caregiver: nomeCaregiver,
                cognome_caregiver: cognomeCaregiver,
                parentela_caregiver: parentela,
                piano: piano
            };
            
            console.log('üì§ PAYLOAD INVIATO:', payload);
            
            try {
                const response = await fetch(\`/api/assistiti/\${id}\`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                console.log('üì• RISPOSTA SERVER:', result);
                
                if (result.success) {
                    alert('‚úÖ Assistito aggiornato con successo!');
                    closeModal('editAssistitoModal');
                    loadDashboardData();
                } else {
                    alert('‚ùå Errore: ' + result.error);
                    console.error('‚ùå Dettagli errore:', result);
                }
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
                console.error('‚ùå Errore catch:', error);
            }
        }
        window.saveEditAssistito = saveEditAssistito;
        
        // Tabella prezzi eCura (1¬∞ anno)
        const PREZZI_ECURA = {
            'eCura FAMILY': { BASE: 390, AVANZATO: 690, rinnovo_BASE: 200, rinnovo_AVANZATO: 500 },
            'eCura PRO': { BASE: 480, AVANZATO: 840, rinnovo_BASE: 240, rinnovo_AVANZATO: 600 },
            'eCura PREMIUM': { BASE: 590, AVANZATO: 990, rinnovo_BASE: 300, rinnovo_AVANZATO: 750 }
        };
        
        function updatePrezziServizio() {
            const servizio = document.getElementById('editServizioAssistito')?.value || 'eCura PRO';
            const piano = document.getElementById('editPianoAssistito')?.value || 'BASE';
            const prezzoInfo = document.getElementById('prezzoInfo');
            
            if (!prezzoInfo) return;
            
            const prezzi = PREZZI_ECURA[servizio];
            if (!prezzi) return;
            
            const prezzoAnno1 = prezzi[piano];
            const prezzoRinnovo = prezzi['rinnovo_' + piano];
            
            prezzoInfo.innerHTML = 
                '<div class="bg-blue-50 border border-blue-200 rounded-lg p-3">' +
                    '<div class="flex justify-between items-center">' +
                        '<span class="font-semibold text-blue-900">1¬∞ Anno:</span>' +
                        '<span class="text-xl font-bold text-blue-600">‚Ç¨' + prezzoAnno1 + '</span>' +
                    '</div>' +
                    '<div class="flex justify-between items-center mt-1">' +
                        '<span class="text-sm text-gray-600">Rinnovo (dal 2¬∞ anno):</span>' +
                        '<span class="font-semibold text-gray-700">‚Ç¨' + prezzoRinnovo + '/anno</span>' +
                    '</div>' +
                '</div>';
            
            // Aggiorna anche il testo delle opzioni
            const pianoSelect = document.getElementById('editPianoAssistito');
            if (pianoSelect) {
                pianoSelect.innerHTML = 
                    '<option value="BASE" data-prezzo="' + prezzi.BASE + '">BASE - ‚Ç¨' + prezzi.BASE + '/anno</option>' +
                    '<option value="AVANZATO" data-prezzo="' + prezzi.AVANZATO + '">AVANZATO - ‚Ç¨' + prezzi.AVANZATO + '/anno</option>';
                pianoSelect.value = piano; // Ripristina selezione
            }
        }
        window.updatePrezziServizio = updatePrezziServizio;
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        window.closeModal = closeModal;

        function renderAssistitiTable(assistiti) {
            const tbody = document.getElementById('assistitiTable');
            
            // Aggiorna contatore
            document.getElementById('assistitiCount').textContent = assistiti.length;
            
            if (assistiti.length === 0) {
                tbody.innerHTML = '<tr>' +
                    '<td colspan="9" class="py-8 text-center text-gray-400">' +
                        '<i class="fas fa-users text-3xl mb-2"></i><br>' +
                        'Nessun assistito attivo trovato' +
                    '</td>' +
                '</tr>';
                return;
            }
            
            tbody.innerHTML = assistiti.map(assistito => {
                // Dati assistito reali con nuovi campi
                const nomeAssistito = assistito.nome_assistito || '';
                const cognomeAssistito = assistito.cognome_assistito || '';
                const nomeCompleto = assistito.nome || (nomeAssistito + ' ' + cognomeAssistito).trim() || 'N/A';
                const caregiverNome = assistito.nome_caregiver || '';
                const caregiverCognome = assistito.cognome_caregiver || '';
                const caregiver = (caregiverNome + ' ' + caregiverCognome).trim() || 'N/A';
                const parentela = assistito.parentela_caregiver || 'N/A';
                const imei = assistito.imei || 'N/A';
                const email = assistito.email || 'N/A';
                const telefono = assistito.telefono || 'N/A';
                const servizio = assistito.servizio || 'eCura PRO';
                const piano = assistito.piano || 'BASE';
                
                // Calcola prezzo dinamico
                const PREZZI_ECURA_TABLE = {
                    'eCura FAMILY': { BASE: 390, AVANZATO: 690 },
                    'eCura PRO': { BASE: 480, AVANZATO: 840 },
                    'eCura PREMIUM': { BASE: 590, AVANZATO: 990 }
                };
                const prezzoAnno = PREZZI_ECURA_TABLE[servizio]?.[piano] || 480;
                
                const status = assistito.status || 'ATTIVO';
                const codice = assistito.codice_contratto || assistito.codice || 'N/A';
                const assistitoId = assistito.id;
                
                // Status badge colors
                const statusColors = {
                    'ATTIVO': 'bg-green-100 text-green-700',
                    'FIRMATO': 'bg-green-100 text-green-700',
                    'INVIATO': 'bg-blue-100 text-blue-700',
                    'CONVERTITO': 'bg-purple-100 text-purple-700'
                };
                const statusColor = statusColors[status] || 'bg-gray-100 text-gray-700';
                
                // Piano badge colors
                const pianoColor = piano === 'AVANZATO' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';
                
                return '<tr class="border-b border-gray-100 hover:bg-gray-50">' +
                    '<td class="py-3 px-2">' +
                        '<div class="font-semibold text-sm text-gray-800">' + nomeCompleto + '</div>' +
                        '<div class="text-xs text-gray-500 mt-1">' +
                            '<i class="fas fa-user-friends mr-1"></i>' + caregiver + ' (' + parentela + ')' +
                        '</div>' +
                    '</td>' +
                    '<td class="py-3 px-2 text-center">' +
                        '<code class="bg-gray-100 px-2 py-1 rounded font-mono text-xs">' + imei + '</code>' +
                    '</td>' +
                    '<td class="py-3 px-2 text-sm text-gray-700">' +
                        '<div><i class="fas fa-envelope text-gray-400 mr-1"></i>' + email + '</div>' +
                    '</td>' +
                    '<td class="py-3 px-2 text-sm text-gray-700">' +
                        '<div><i class="fas fa-phone text-gray-400 mr-1"></i>' + telefono + '</div>' +
                    '</td>' +
                    '<td class="py-3 px-2 text-center">' +
                        '<span class="px-3 py-1 bg-purple-100 text-purple-700 text-xs font-medium rounded-full">' + servizio + '</span>' +
                    '</td>' +
                    '<td class="py-3 px-2 text-center">' +
                        '<span class="px-3 py-1 ' + pianoColor + ' text-xs font-medium rounded-full">' + piano + '</span>' +
                    '</td>' +
                    '<td class="py-3 px-2 text-center">' +
                        '<div class="font-bold text-green-600 text-base">‚Ç¨' + prezzoAnno + '</div>' +
                        '<div class="text-xs text-gray-500">/anno</div>' +
                    '</td>' +
                    '<td class="py-3 px-2 text-center">' +
                        '<span class="px-3 py-1 ' + statusColor + ' text-xs font-medium rounded-full">' + status + '</span>' +
                    '</td>' +
                    '<td class="py-3 px-2 text-center">' +
                        '<div class="flex justify-center gap-1">' +
                            '<button onclick="window.viewAssistito(' + assistitoId + ')" class="text-blue-600 hover:text-blue-800 hover:bg-blue-50 p-1 rounded transition text-sm" title="Visualizza">' +
                                '<i class="fas fa-eye"></i>' +
                            '</button>' +
                            '<button onclick="window.editAssistito(' + assistitoId + ')" class="text-yellow-600 hover:text-yellow-800 hover:bg-yellow-50 p-1 rounded transition text-sm" title="Modifica">' +
                                '<i class="fas fa-edit"></i>' +
                            '</button>' +
                            '<button onclick="window.deleteAssistito(' + assistitoId + ')" class="text-red-600 hover:text-red-800 hover:bg-red-50 p-1 rounded transition text-sm" title="Elimina">' +
                                '<i class="fas fa-trash"></i>' +
                            '</button>' +
                        '</div>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        // Variabile globale per tenere tutti gli assistiti
        let allAssistiti = [];

        function filterAssistiti() {
            const searchTerm = document.getElementById('searchAssistitoCognome').value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderAssistitiTable(allAssistiti);
                return;
            }

            const filtered = allAssistiti.filter(assistito => {
                const nomeAssistito = (assistito.nome_assistito || '').toLowerCase();
                const cognomeAssistito = (assistito.cognome_assistito || '').toLowerCase();
                const nomeCompleto = (assistito.nome || '').toLowerCase();
                const caregiverNome = (assistito.nome_caregiver || '').toLowerCase();
                const caregiverCognome = (assistito.cognome_caregiver || '').toLowerCase();
                
                return nomeAssistito.includes(searchTerm) || 
                       cognomeAssistito.includes(searchTerm) ||
                       nomeCompleto.includes(searchTerm) ||
                       caregiverNome.includes(searchTerm) ||
                       caregiverCognome.includes(searchTerm);
            });

            renderAssistitiTable(filtered);
        }

        function updateChannelsChart(leads) {
            const leadsToUse = window.allLeadsData || leads;
            const channelCounts = {};
            
            // Conta i lead per canale
            leadsToUse.forEach(lead => {
                let channel = 'Non specificato';
                
                // Cerca il canale nel campo canale o nelle note
                if (lead.canale && lead.canale.trim() !== '') {
                    channel = lead.canale;
                } else if (lead.note) {
                    // Cerca pattern comuni nelle note
                    if (lead.note.includes('Irbema') || lead.note.includes('IRBEMA')) {
                        channel = 'Irbema';
                    } else if (lead.note.includes('AON')) {
                        channel = 'AON';
                    } else if (lead.note.includes('Double You')) {
                        channel = 'Double You';
                    } else if (lead.note.includes('Excel')) {
                        channel = 'Excel Import';
                    }
                }
                
                channelCounts[channel] = (channelCounts[channel] || 0) + 1;
            });

            const total = leadsToUse.length || 1;
            const colors = ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-orange-500', 'bg-pink-500', 'bg-indigo-500', 'bg-yellow-500'];
            
            const html = Object.entries(channelCounts)
                .sort(([,a], [,b]) => b - a) // Ordina per count decrescente
                .map(([channel, count], index) => {
                    const percentage = Math.round((count / total) * 100);
                    const color = colors[index % colors.length];
                    return \`
                        <div class="p-4 border-2 border-gray-200 rounded-lg hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-bold text-gray-800">\${channel}</span>
                                <i class="fas fa-chart-pie text-gray-400"></i>
                            </div>
                            <div class="text-2xl font-bold text-gray-900 mb-1">\${count}</div>
                            <div class="text-xs text-gray-500 mb-2">\${percentage}% del totale</div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="\${color} h-2 rounded-full" style="width: \${percentage}%"></div>
                            </div>
                        </div>
                    \`;
                }).join('');

            document.getElementById('channelsChart').innerHTML = html || '<p class="text-gray-400 text-sm col-span-3 text-center">Nessun dato disponibile</p>';
        }

        // Funzioni Import API
        function importFromExcel() {
            alert('üìã IMPORT DA EXCEL\\n\\n' +
                  'üìÅ Preparazione file Excel richiesta:\\n\\n' +
                  '1Ô∏è‚É£ Usa il template Excel gi√† popolato\\n' +
                  '2Ô∏è‚É£ Compila i campi richiesti:\\n' +
                  '   ‚Ä¢ Colonna B: DATA DI ARRIVO RICHIESTA\\n' +
                  '   ‚Ä¢ Colonna F: CANALE (info@irbema.com, diretto, ecc.)\\n' +
                  '   ‚Ä¢ Colonna G: NOME E COGNOME\\n' +
                  '   ‚Ä¢ Colonna I: E-MAIL\\n' +
                  '   ‚Ä¢ Colonna J: CONTATTO TELEFONICO\\n\\n' +
                  '3Ô∏è‚É£ Il sistema assegner√† automaticamente:\\n' +
                  '   ‚Ä¢ ID progressivi (LEAD-CANALE-00130, 00131...)\\n' +
                  '   ‚Ä¢ Status: NEW o CONVERTED\\n' +
                  '   ‚Ä¢ Canale: IRBEMA, WEB, NETWORKING, ecc.\\n\\n' +
                  '‚úÖ I nuovi lead saranno AGGIUNTI senza cancellare gli esistenti.\\n\\n' +
                  'üöß Funzionalit√† in sviluppo - contatta l\\'amministratore.');
        }
        window.importFromExcel = importFromExcel;  // Esponi globalmente

        async function importFromIrbema() {
            if (!confirm('Vuoi importare i lead da Irbema (HubSpot)?\\n\\nQuesta operazione:\\n- Scaricher√† i nuovi lead da HubSpot\\n- Filtrer√† solo i lead da ecura.it\\n- Aggiorner√† il database\\n\\nProcedi?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/import/irbema', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Import Irbema completato!\\n\\n' +
                          'Lead importati: ' + result.imported + '\\n' +
                          'Lead skippati: ' + result.skipped + '\\n' +
                          'Totale contatti: ' + result.total + '\\n' +
                          'Pagine processate: ' + result.pages);
                    
                    // Ricarica la tabella assistiti
                    if (typeof window.loadAssistitiData === 'function') {
                        window.loadAssistitiData();
                    } else {
                        // Fallback: reload pagina
                        location.reload();
                    }
                } else {
                    alert('Errore import: ' + result.error);
                }
            } catch (error) {
                alert('Errore di comunicazione: ' + error.message);
            }
        }

        function importFromAON() {
            alert('üîÑ Import da AON\\n\\nFunzionalit√† in sviluppo.\\n\\nEndpoint: POST /api/import/aon\\n\\nQuesta funzionalit√† permetter√† di importare lead dal partner AON.');
        }

        function importFromDoubleYou() {
            alert('üîÑ Import da DoubleYou\\n\\nFunzionalit√† in sviluppo.\\n\\nEndpoint: POST /api/import/doubleyou\\n\\nQuesta funzionalit√† permetter√† di importare lead dal partner DoubleYou.');
        }

        // üóëÔ∏è CLEAN IMPORT: Cancella e reimporta i 129 lead dall'Excel
    <\/script>

    <!-- MODAL: EDIT ASSISTITO -->
    <div id="editAssistitoModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="gradient-bg text-white px-6 py-4 rounded-t-lg flex justify-between items-center">
                <h3 class="text-xl font-bold">‚úèÔ∏è Modifica Assistito</h3>
                <button onclick="closeModal('editAssistitoModal')" class="text-white hover:text-gray-200 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <input type="hidden" id="editAssistitoId">
                
                <h4 class="font-bold text-gray-700 mb-3 border-b pb-2">üë§ Dati Assistito</h4>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome *</label>
                        <input type="text" id="editNomeAssistito" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cognome *</label>
                        <input type="text" id="editCognomeAssistito" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="editEmailAssistito" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Telefono</label>
                        <input type="tel" id="editTelefonoAssistito" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">IMEI Dispositivo *</label>
                        <input type="text" id="editIMEI" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Servizio</label>
                        <select id="editServizioAssistito" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="updatePrezziServizio()">
                            <option value="eCura FAMILY">eCura FAMILY (SiDLY CARE PRO)</option>
                            <option value="eCura PRO">eCura PRO (SiDLY CARE PRO)</option>
                            <option value="eCura PREMIUM">eCura PREMIUM (SiDLY VITAL CARE)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Piano</label>
                        <select id="editPianoAssistito" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="updatePrezziServizio()">
                            <option value="BASE" data-prezzo="480">BASE - ‚Ç¨480/anno</option>
                            <option value="AVANZATO" data-prezzo="840">AVANZATO - ‚Ç¨840/anno</option>
                        </select>
                        <div id="prezzoInfo" class="mt-2 text-sm text-gray-600"></div>
                    </div>
                </div>
                
                <h4 class="font-bold text-gray-700 mb-3 border-b pb-2">üë®‚Äçüë©‚Äçüë¶ Dati Caregiver</h4>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome Caregiver</label>
                        <input type="text" id="editNomeCaregiver" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cognome Caregiver</label>
                        <input type="text" id="editCognomeCaregiver" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Parentela</label>
                        <input type="text" id="editParentela" placeholder="es. Figlio, Figlia, Coniuge..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="flex justify-end gap-3">
                    <button onclick="closeModal('editAssistitoModal')" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                        Annulla
                    </button>
                    <button onclick="saveEditAssistito()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        üíæ Salva Modifiche
                    </button>
                </div>
            </div>
        </div>
    </div>

    ${l0}
</body>
</html>
`,ET=`<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Leads - TeleMedCare V12.0</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-users text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Dashboard Leads Modulare</h1>
                        <p class="text-green-100">Aggregazione dati dai 6 moduli Leads specializzati</p>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <button onclick="openNewLeadModal()" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-plus mr-2"></i>Nuovo Lead
                    </button>
                    <a href="/" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-home mr-2"></i>Home
                    </a>
                    <a href="/dashboard" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-chart-line mr-2"></i>Dashboard
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 xl:px-12 py-8" style="max-width: 1600px;">
        <!-- Statistiche Lead -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Lead Totali</p>
                        <p class="text-3xl font-bold text-blue-600" id="totalLeads">-</p>
                        <p class="text-xs text-green-600 mt-1">
                            <i class="fas fa-arrow-up mr-1"></i>
                            <span id="leadsGrowth">+0%</span> vs mese scorso
                        </p>
                    </div>
                    <i class="fas fa-users text-3xl text-blue-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Tasso Conversione</p>
                        <p class="text-3xl font-bold text-green-600" id="conversionRate">-</p>
                        <p class="text-xs text-gray-500 mt-1">Lead ‚Üí Contratto</p>
                    </div>
                    <i class="fas fa-percentage text-3xl text-green-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Lead Oggi</p>
                        <p class="text-3xl font-bold text-purple-600" id="leadsToday">-</p>
                        <p class="text-xs text-gray-500 mt-1">Ultime 24h</p>
                    </div>
                    <i class="fas fa-calendar-day text-3xl text-purple-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-orange-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Valore Totale</p>
                        <p class="text-3xl font-bold text-orange-600" id="totalValue">-</p>
                        <p class="text-xs text-gray-500 mt-1">Contratti attivi</p>
                    </div>
                    <i class="fas fa-euro-sign text-3xl text-orange-500"></i>
                </div>
            </div>
        </div>

        <!-- Grafici Distribuzione -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Servizi -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-pie text-blue-500 mr-2"></i>
                    Per Servizio
                </h3>
                <div id="servicesBreakdown" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Piani -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-layer-group text-green-500 mr-2"></i>
                    Per Piano
                </h3>
                <div id="plansBreakdown" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Fonti -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-source text-purple-500 mr-2"></i>
                    Per Fonte
                </h3>
                <div id="channelsBreakdown" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Tabella Lead Dettagliata -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-table text-blue-500 mr-2"></i>
                    Tutti i Lead
                </h3>
                <div class="flex space-x-2">
                    <input 
                        type="text" 
                        id="searchCognome" 
                        class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-64" 
                        placeholder="üîç Cerca per cognome..."
                        onkeyup="applyFilters()"
                    />
                    <select id="filterFonte" class="border border-gray-300 rounded-lg px-3 py-2 text-sm" onchange="applyFilters()">
                        <option value="">Tutte le Fonti</option>
                        <option value="Sito www.eCura.it">Sito www.eCura.it</option>
                        <option value="Privati IRBEMA">Privati IRBEMA</option>
                        <option value="Form eCura">Form eCura</option>
                        <option value="Form eCura x Test">Form eCura x Test</option>
                        <option value="B2B IRBEMA">B2B IRBEMA</option>
                        <option value="Sito web Medica GB">Sito web Medica GB</option>
                        <option value="NETWORKING">NETWORKING</option>
                    </select>
                    <select id="filterServizio" class="border border-gray-300 rounded-lg px-3 py-2 text-sm" onchange="applyFilters()">
                        <option value="">Tutti i Servizi</option>
                        <option value="FAMILY">FAMILY</option>
                        <option value="PRO">PRO</option>
                        <option value="PREMIUM">PREMIUM</option>
                    </select>
                    <select id="filterPiano" class="border border-gray-300 rounded-lg px-3 py-2 text-sm" onchange="applyFilters()">
                        <option value="">Tutti i Piani</option>
                        <option value="BASE">BASE</option>
                        <option value="AVANZATO">AVANZATO</option>
                    </select>
                    <select id="filterCM" class="border border-gray-300 rounded-lg px-3 py-2 text-sm" onchange="applyFilters()">
                        <option value="">Tutti i CM</option>
                        <option value="nessuno">Nessuno</option>
                        <option value="SR">SR - Stefania Rocca</option>
                        <option value="OB">OB - Ottavia Belfa</option>
                        <option value="RP">RP - Roberto Poggi</option>
                    </select>
                    <select id="filterStato" class="border border-gray-300 rounded-lg px-3 py-2 text-sm" onchange="applyFilters()">
                        <option value="">Tutti gli Stati</option>
                        <option value="nuovo">üÜï Nuovo</option>
                        <option value="contattato">üìû Contattato</option>
                        <option value="interessato">‚ú® Interessato</option>
                        <option value="in_trattativa">üíº In Trattativa</option>
                        <option value="convertito">‚úÖ Convertito</option>
                        <option value="perso">‚ùå Perso</option>
                        <option value="non_interessato">‚õî Non Interessato</option>
                        <option value="da_ricontattare">üîÑ Da Ricontattare</option>
                        <option value="non_risponde">üìµ Non Risponde</option>
                        <option value="numero_non_attivo">üö´ Numero Non Attivo</option>
                        <option value="inps">üèõÔ∏è INPS</option>
                        <option value="problemi_economici">üí∞ Problemi Economici</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full table-fixed">
                    <thead>
                        <tr class="border-b-2 border-gray-200 text-left">
                            <th class="pb-3 text-xs font-semibold text-gray-600" style="width: 3%;">#</th>
                            <th class="pb-3 text-xs font-semibold text-gray-600" style="width: 15%;">Cliente</th>
                            <th class="pb-3 text-xs font-semibold text-gray-600" style="width: 16%;">Contatti</th>
                            <th class="pb-3 text-xs font-semibold text-gray-600" style="width: 8%;">Servizio</th>
                            <th class="pb-3 text-xs font-semibold text-gray-600" style="width: 6%;">Piano</th>
                            <th class="pb-3 text-xs font-semibold text-gray-600" style="width: 5%;">Prezzo</th>
                            <!-- Nascoste: Brochure e Manuale non servono per ora -->
                            <!-- <th class="pb-3 text-xs font-semibold text-gray-600 text-center" style="width: 4%;">üìÑ</th> -->
                            <!-- <th class="pb-3 text-xs font-semibold text-gray-600 text-center" style="width: 4%;">üìñ</th> -->
                            <th class="pb-3 text-xs font-semibold text-gray-600" style="width: 7%;">Data</th>
                            <th class="pb-3 text-xs font-semibold text-gray-600" style="width: 5%;">CM</th>
                            <th class="pb-3 text-xs font-semibold text-gray-600" style="width: 10%;">Stato</th>
                            <th class="pb-3 text-xs font-semibold text-gray-600" style="width: 13%;">Azioni</th>
                            <th class="pb-3 text-xs font-semibold text-gray-600" style="width: 10%;">CRUD</th>
                        </tr>
                    </thead>
                    <tbody id="leadsTableBody">
                        <tr>
                            <td colspan="11" class="py-8 text-center text-gray-400">
                                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                <p>Caricamento lead...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Helper function to escape HTML special characters
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        let allLeads = [];

        // Carica dati
        loadLeadsData();

        async function loadLeadsData() {
            try {
                // Carica statistiche
                const statsResponse = await fetch('/api/data/stats');
                const stats = await statsResponse.json();

                document.getElementById('totalLeads').textContent = stats.totalLeads || '0';
                document.getElementById('conversionRate').textContent = stats.conversionRate || '0%';
                document.getElementById('leadsToday').textContent = stats.leadsToday || '0';
                document.getElementById('totalValue').textContent = stats.totalValue ? ('‚Ç¨' + stats.totalValue) : '‚Ç¨0';
                document.getElementById('leadsGrowth').textContent = stats.leadsGrowth || '+0%';

                // Carica lead
                // ‚úÖ Aggiungi timestamp per evitare cache del browser
                const cacheBuster = Date.now();
                const leadsResponse = await fetch(\`/api/leads?limit=99999&_=\${cacheBuster}\`);
                const leadsData = await leadsResponse.json();
                allLeads = leadsData.leads || [];
                
                // ‚úÖ USA IL TOTALE REALE DAL SERVER (non allLeads.length)
                const totalLeads = leadsData.total || allLeads.length;
                
                // Calcola revenue totale SOLO dai contratti FIRMATI
                const contrattiResponse = await fetch('/api/contratti');
                const contrattiData = await contrattiResponse.json();
                const contratti = contrattiData.contracts || contrattiData.contratti || contrattiData.data || [];
                
                // TASK #1-2 FIX: Filtra solo contratti SIGNED o ACTIVE
                const contrattiFirmati = contratti.filter(c => 
                    c.status === 'SIGNED' || 
                    c.status === 'ACTIVE' || 
                    c.status === 'signed' || 
                    c.status === 'active'
                );
                
                // Calcola il tasso di conversione: contratti firmati / total leads
                const converted = contrattiFirmati.length;
                const conversionRate = totalLeads > 0 ? ((converted / totalLeads) * 100).toFixed(1) + '%' : '0%';
                
                // Calcola revenue totale SOLO dai contratti firmati
                let totalValue = 0;
                contrattiFirmati.forEach(c => {
                    if (c.prezzo_totale) totalValue += parseFloat(c.prezzo_totale);
                });
                const today = new Date().toISOString().split('T')[0];
                const leadsToday = allLeads.filter(l => l.created_at && l.created_at.startsWith(today)).length;
                
                // Update KPIs
                document.getElementById('totalLeads').textContent = totalLeads;
                document.getElementById('conversionRate').textContent = conversionRate;
                document.getElementById('leadsToday').textContent = leadsToday;
                document.getElementById('totalValue').textContent = '‚Ç¨' + totalValue;
                document.getElementById('leadsGrowth').textContent = '+0%'; // TODO

                // Aggiorna grafici
                updateServicesBreakdown(allLeads);
                updatePlansBreakdown(allLeads);
                updateChannelsBreakdown(allLeads);

                // Popola tabella
                renderLeadsTable(allLeads);

            } catch (error) {
                console.error('Errore caricamento leads:', error);
                document.getElementById('leadsTableBody').innerHTML = \`
                    <tr>
                        <td colspan="9" class="py-8 text-center text-red-500">
                            <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                            <p>Errore nel caricamento dei lead</p>
                        </td>
                    </tr>
                \`;
            }
        }

        function updateServicesBreakdown(leads) {
            const services = {};
            
            // Conta i servizi effettivi dai lead
            leads.forEach(l => {
                // PRIORITY: servizio > tipoServizio > default
                let service = l.servizio || l.tipoServizio || 'eCura PRO';
                
                // Normalizza i nomi dei servizi per consistenza
                service = service.trim();
                
                // Normalizza varianti del nome
                // IMPORTANTE: L'ordine √® importante! Controlla "premium" prima di "pro"
                if (service.toLowerCase().includes('family')) {
                    service = 'eCura FAMILY';
                } else if (service.toLowerCase().includes('premium')) {
                    service = 'eCura PREMIUM';
                } else if (service.toLowerCase().includes('pro')) {
                    service = 'eCura PRO';
                }
                
                services[service] = (services[service] || 0) + 1;
            });
            
            // Debug: mostra servizi rilevati
            console.log('üìä Servizi rilevati:', services);
            
            const total = leads.length || 1;
            const colors = {
                'eCura FAMILY': 'bg-green-500',
                'eCura PRO': 'bg-purple-500',
                'eCura PREMIUM': 'bg-blue-500'
            };

            const html = Object.entries(services)
                .sort(([,a], [,b]) => b - a) // Ordina per count decrescente
                .map(([service, count]) => {
                    const percentage = Math.round((count / total) * 100);
                    const color = colors[service] || 'bg-gray-500';
                    return \`
                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-medium">\${service}</span>
                                <span class="text-sm font-bold">\${count} (\${percentage}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="\${color} h-2 rounded-full" style="width: \${percentage}%"></div>
                            </div>
                        </div>
                    \`;
                }).join('');

            document.getElementById('servicesBreakdown').innerHTML = html || '<p class="text-gray-400 text-sm">Nessun servizio disponibile</p>';
        }

        function updatePlansBreakdown(leads) {
            const counts = { 'BASE': 0, 'AVANZATO': 0 };
            leads.forEach(l => {
                // PRIORITY: piano > note > default BASE
                // NOTA: tipoServizio contiene il SERVIZIO (es. "eCura PRO"), NON il piano!
                let plan = 'BASE'; // default
                
                if (l.piano) {
                    // Nuovo campo piano (dopo migration 0006)
                    plan = l.piano.toUpperCase() === 'AVANZATO' ? 'AVANZATO' : 'BASE';
                } else if (l.note) {
                    // Fallback: cerca nelle note
                    plan = l.note.includes('Piano: AVANZATO') || l.note.includes('AVANZATO') ? 'AVANZATO' : 'BASE';
                }
                
                counts[plan]++;
            });

            const total = leads.length || 1;
            const colors = { 'BASE': 'bg-blue-500', 'AVANZATO': 'bg-purple-500' };

            const html = Object.entries(counts).map(([plan, count]) => {
                const percentage = Math.round((count / total) * 100);
                return \`
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium">\${plan}</span>
                            <span class="text-sm font-bold">\${count} (\${percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="\${colors[plan]} h-2 rounded-full" style="width: \${percentage}%"></div>
                        </div>
                    </div>
                \`;
            }).join('');

            document.getElementById('plansBreakdown').innerHTML = html;
        }

        function updateChannelsBreakdown(leads) {
            console.log('üîç updateChannelsBreakdown chiamata con leads:', leads.length);
            
            const sources = {};
            leads.forEach(l => {
                // PRIORIT√Ä: fonte √® il campo principale
                const fonte = l.fonte || 'Non specificato';
                sources[fonte] = (sources[fonte] || 0) + 1;
            });
            
            // Debug: mostra tutte le fonti trovate
            console.log('üìä Fonti rilevate:', sources);
            console.log('üìä Total leads:', leads.length);
            console.log('üìä Primo lead esempio:', leads[0]);
            
            const total = leads.length || 1;
            
            // Colori per le fonti
            const fonteColors = {
                'Sito www.eCura.it': 'bg-cyan-500',
                'Privati IRBEMA': 'bg-blue-500',
                'Form eCura': 'bg-green-500',
                'Form eCura x Test': 'bg-yellow-500',
                'B2B IRBEMA': 'bg-purple-500',
                'Sito web Medica GB': 'bg-pink-500',
                'NETWORKING': 'bg-indigo-500',
                'Form Contattaci': 'bg-teal-500'
            };
            
            // Genera HTML con barre colorate come gli altri box
            const html = Object.entries(sources)
                .sort(([,a], [,b]) => b - a) // Ordina per count decrescente
                .map(([fonte, count]) => {
                    const percentage = Math.round((count / total) * 100);
                    const color = fonteColors[fonte] || 'bg-gray-500';
                    return \`
                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-medium">\${fonte}</span>
                                <span class="text-sm font-bold">\${count} (\${percentage}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="\${color} h-2 rounded-full" style="width: \${percentage}%"></div>
                            </div>
                        </div>
                    \`;
                }).join('');
            
            document.getElementById('channelsBreakdown').innerHTML = html || '<p class="text-gray-400 text-sm">Nessuna fonte disponibile</p>';
        }

        function renderLeadsTable(leads) {
            console.log('üîß renderLeadsTable v2026-02-14-01:30 - SORT DESC + cache-buster');
            const tbody = document.getElementById('leadsTableBody');
            
            if (leads.length === 0) {
                tbody.innerHTML = \`
                    <tr>
                        <td colspan="13" class="py-8 text-center text-gray-400">Nessun lead trovato</td>
                    </tr>
                \`;
                return;
            }

            // ‚úÖ ORDINA PER DATA CREAZIONE DESC (pi√π recenti prima)
            const sortedLeads = [...leads].sort((a, b) => {
                const dateA = new Date(a.created_at || a.timestamp || 0);
                const dateB = new Date(b.created_at || b.timestamp || 0);
                return dateB - dateA; // DESC
            });

            tbody.innerHTML = sortedLeads.map((lead, index) => {
                // PRIORITY: piano > note > default BASE
                // NOTA: tipoServizio contiene il SERVIZIO, NON il piano!
                let piano = 'BASE';
                if (lead.piano) {
                    piano = lead.piano.toUpperCase() === 'AVANZATO' ? 'AVANZATO' : 'BASE';
                } else if (lead.note && lead.note.includes('Piano: AVANZATO')) {
                    piano = 'AVANZATO';
                }
                
                // ‚úÖ USA PREZZO DAL DATABASE (IVA esclusa)
                const prezzo = lead.prezzo_anno || 0;
                const date = new Date(lead.created_at).toLocaleDateString('it-IT');
                // Usa il campo vuoleContratto dal lead
                const hasContract = lead.vuoleContratto === 'Si' || lead.vuoleContratto === true;
                
                // Mostra servizio cos√¨ com'√® dal DB (gi√† con "eCura" se presente)
                const servizio = lead.servizio || lead.tipoServizio || 'eCura PRO';
                
                return \`
                    <tr class="border-b border-gray-100 hover:bg-gray-50" title="ID: \${escapeHtml(lead.id)}">
                        <td class="py-2 text-xs text-gray-600 font-medium">\${leads.length - index}</td>
                        <td class="py-2 text-xs truncate" title="\${(lead.nomeRichiedente && lead.cognomeRichiedente) ? escapeHtml(lead.nomeRichiedente + ' ' + lead.cognomeRichiedente) : escapeHtml(lead.email || '')}">
                            <div class="font-medium truncate">\${(lead.nomeRichiedente && lead.cognomeRichiedente) ? escapeHtml(lead.nomeRichiedente + ' ' + lead.cognomeRichiedente) : escapeHtml(lead.email || 'N/A')}</div>
                        </td>
                        <td class="py-2 text-xs">
                            <div class="text-xs text-gray-600 truncate" title="\${escapeHtml(lead.email || '')}">
                                <i class="fas fa-envelope text-gray-400 mr-1"></i>\${escapeHtml(lead.email || '') || '-'}
                            </div>
                            <div class="text-xs text-gray-600 mt-1">
                                <i class="fas fa-phone text-gray-400 mr-1"></i>\${escapeHtml(lead.telefono || '') || '-'}
                            </div>
                        </td>
                        <td class="py-2 text-xs">
                            <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded font-medium">
                                \${servizio}
                            </span>
                        </td>
                        <td class="py-2 text-xs">
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded font-medium">
                                \${piano}
                            </span>
                        </td>
                        <td class="py-2 text-xs font-bold text-green-600">‚Ç¨\${prezzo}</td>
                        <!-- Nascoste: celle Contratto e Brochure -->
                        <!-- <td class="py-2 text-center text-xs">
                            <i class="fas fa-\${hasContract ? 'check-circle text-green-500' : 'times-circle text-gray-300'}"></i>
                        </td>
                        <td class="py-2 text-center text-xs">
                            <i class="fas fa-\${lead.vuoleBrochure === 'Si' ? 'check-circle text-green-500' : 'times-circle text-gray-300'}"></i>
                        </td> -->
                        <td class="py-2 text-xs text-gray-500">\${date}</td>
                        <td class="py-2 text-xs">
                            <select 
                                data-lead-id="\${lead.id}"
                                class="cm-select text-xs px-1 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-purple-500 \${lead.cm ? 'bg-blue-50 font-medium' : 'bg-white'}"
                                style="min-width: 80px;">
                                <option value="" \${!lead.cm ? 'selected' : ''}>nessuno</option>
                                <option value="OB" \${lead.cm === 'OB' ? 'selected' : ''}>OB</option>
                                <option value="SR" \${lead.cm === 'SR' ? 'selected' : ''}>SR</option>
                                <option value="RP" \${lead.cm === 'RP' ? 'selected' : ''}>RP</option>
                            </select>
                        </td>
                        <td class="py-3 text-sm">
                            <select 
                                data-lead-id="\${lead.id}"
                                class="status-select text-xs px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 font-medium"
                                style="min-width: 110px;">
                                <option value="" \${!lead.stato ? 'selected' : ''}>Nessuno</option>
                                <option value="nuovo" \${lead.stato === 'nuovo' ? 'selected' : ''} class="bg-blue-50">üÜï Nuovo</option>
                                <option value="contattato" \${lead.stato === 'contattato' ? 'selected' : ''} class="bg-yellow-50">üìû Contattato</option>
                                <option value="interessato" \${lead.stato === 'interessato' ? 'selected' : ''} class="bg-green-50">‚ú® Interessato</option>
                                <option value="in_trattativa" \${lead.stato === 'in_trattativa' ? 'selected' : ''} class="bg-indigo-50">üíº In Trattativa</option>
                                <option value="convertito" \${lead.stato === 'convertito' ? 'selected' : ''} class="bg-green-100">‚úÖ Convertito</option>
                                <option value="perso" \${lead.stato === 'perso' ? 'selected' : ''} class="bg-red-50">‚ùå Perso</option>
                                <option value="non_interessato" \${lead.stato === 'non_interessato' ? 'selected' : ''} class="bg-gray-100">‚õî Non Interessato</option>
                                <option value="da_ricontattare" \${lead.stato === 'da_ricontattare' ? 'selected' : ''} class="bg-yellow-100">üîÑ Da Ricontattare</option>
                                <option value="non_risponde" \${lead.stato === 'non_risponde' ? 'selected' : ''} class="bg-orange-50">üìµ Non Risponde</option>
                                <option value="numero_non_attivo" \${lead.stato === 'numero_non_attivo' ? 'selected' : ''} class="bg-red-100">üö´ Numero Non Attivo</option>
                                <option value="inps" \${lead.stato === 'inps' ? 'selected' : ''} class="bg-purple-50">üèõÔ∏è INPS</option>
                                <option value="problemi_economici" \${lead.stato === 'problemi_economici' ? 'selected' : ''} class="bg-pink-50">üí∞ Problemi Economici</option>
                            </select>
                        </td>
                        <td class="py-3 text-sm">
                            <div class="flex space-x-1">
                                <button 
                                    data-action="interactions"
                                    data-lead-id="\${lead.id}"
                                    class="px-2 py-1 bg-purple-500 text-white text-xs rounded hover:bg-purple-600 transition-colors relative action-btn"
                                    title="Gestisci Interazioni">
                                    üí¨
                                    <span class="interactions-count-\${lead.id} hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center font-bold" style="font-size: 9px;"></span>
                                </button>
                                <button 
                                    data-action="contract"
                                    data-lead-id="\${lead.id}"
                                    data-piano="\${piano}"
                                    class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors action-btn"
                                    title="Invia Contratto \${piano}">
                                    <i class="fas fa-file-contract"></i>
                                </button>
                                <button 
                                    data-action="brochure"
                                    data-lead-id="\${lead.id}"
                                    class="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition-colors action-btn"
                                    title="Invia Brochure">
                                    <i class="fas fa-book"></i>
                                </button>
                                <button 
                                    data-action="completion"
                                    data-lead-id="\${lead.id}"
                                    class="px-2 py-1 bg-purple-500 text-white text-xs rounded hover:bg-purple-600 transition-colors action-btn"
                                    title="Richiedi Completamento">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </td>
                        <td class="py-3">
                            <div class="flex space-x-1">
                                <button data-action="view" data-lead-id="\${lead.id}" 
                                        class="text-blue-600 hover:text-blue-800 px-1 crud-btn" 
                                        title="Visualizza">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button data-action="edit" data-lead-id="\${lead.id}" 
                                        class="text-green-600 hover:text-green-800 px-1 crud-btn" 
                                        title="Modifica">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button data-action="delete" data-lead-id="\${lead.id}" 
                                        class="text-red-600 hover:text-red-800 px-1 crud-btn" 
                                        title="Elimina">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                \`;
            }).join('');
            
            // Attach event listeners to dynamically created buttons
            setTimeout(() => {
                // Action buttons (contract, brochure, completion, interactions)
                document.querySelectorAll('.action-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const action = this.getAttribute('data-action');
                        const leadId = this.getAttribute('data-lead-id');
                        const piano = this.getAttribute('data-piano');
                        
                        if (action === 'interactions') openInteractionsModal(leadId);
                        else if (action === 'contract') sendContract(leadId, piano);
                        else if (action === 'brochure') sendBrochure(leadId);
                        else if (action === 'completion') requestCompletion(leadId);
                    });
                });
                
                // CRUD buttons (view, edit, delete)
                document.querySelectorAll('.crud-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const action = this.getAttribute('data-action');
                        const leadId = this.getAttribute('data-lead-id');
                        
                        if (action === 'view') viewLead(leadId);
                        else if (action === 'edit') editLead(leadId);
                        else if (action === 'delete') deleteLead(leadId);
                    });
                });
                
                // CM select dropdowns
                document.querySelectorAll('.cm-select').forEach(select => {
                    select.addEventListener('change', function() {
                        const leadId = this.getAttribute('data-lead-id');
                        const value = this.value;
                        updateContactManager(leadId, value);
                    });
                });
                
                // Status select dropdowns
                document.querySelectorAll('.status-select').forEach(select => {
                    select.addEventListener('change', function() {
                        const leadId = this.getAttribute('data-lead-id');
                        const value = this.value;
                        updateLeadStatus(leadId, value);
                    });
                });
            }, 0);
        }

        function applyFilters() {
            const fonteFilter = document.getElementById('filterFonte').value;
            const servizioFilter = document.getElementById('filterServizio').value;
            const pianoFilter = document.getElementById('filterPiano').value;
            const cmFilter = document.getElementById('filterCM').value;
            const statoFilter = document.getElementById('filterStato').value;
            const searchCognome = document.getElementById('searchCognome').value.toLowerCase().trim();

            const filtered = allLeads.filter(lead => {
                // Filtro Fonte: match esatto con il campo fonte
                const leadFonte = lead.fonte || '';
                const matchFonte = !fonteFilter || leadFonte === fonteFilter;
                
                // Filtro Servizio: cerca nel campo servizio o tipoServizio del DB
                // Normalizza: "eCura PRO" -> "PRO", "eCura FAMILY" -> "FAMILY"
                let leadServizio = lead.servizio || lead.tipoServizio || '';
                
                // Rimuovi "eCura " se presente per normalizzare
                if (leadServizio.includes('eCura')) {
                    leadServizio = leadServizio.replace(/eCuras*/i, '').trim();
                }
                
                const matchServizio = !servizioFilter || leadServizio.toUpperCase() === servizioFilter.toUpperCase();
                
                // Filtro Piano: cerca nel campo piano o nelle note come fallback
                let leadPiano = 'BASE'; // default
                if (lead.piano) {
                    leadPiano = lead.piano.toUpperCase() === 'AVANZATO' ? 'AVANZATO' : 'BASE';
                } else if (lead.note) {
                    leadPiano = (lead.note.includes('Piano: AVANZATO') || lead.note.includes('AVANZATO')) ? 'AVANZATO' : 'BASE';
                }
                const matchPiano = !pianoFilter || leadPiano === pianoFilter;
                
                // Filtro CM: confronta con il campo cm del lead
                const leadCM = lead.cm || '';
                const matchCM = !cmFilter || 
                    (cmFilter === 'nessuno' && !leadCM) || 
                    (cmFilter !== 'nessuno' && leadCM === cmFilter);
                
                // Filtro Stato: confronta con il campo stato del lead
                const leadStato = (lead.stato || '').toLowerCase();
                const matchStato = !statoFilter || leadStato === statoFilter.toLowerCase();
                
                // Filtro cognome: cerca in cognomeRichiedente o cognomeAssistito
                const cognomeRichiedente = (lead.cognomeRichiedente || '').toLowerCase();
                const cognomeAssistito = (lead.cognomeAssistito || '').toLowerCase();
                const matchCognome = !searchCognome || 
                    cognomeRichiedente.includes(searchCognome) || 
                    cognomeAssistito.includes(searchCognome);
                
                return matchFonte && matchServizio && matchPiano && matchCM && matchStato && matchCognome;
            });

            renderLeadsTable(filtered);
        }

        function getPrezzoForService(servizio, piano) {
            const prezzi = {
                'FAMILY': { 'BASE': '390.00', 'AVANZATO': '690.00' },
                'PRO': { 'BASE': '480.00', 'AVANZATO': '840.00' },
                'PREMIUM': { 'BASE': '590.00', 'AVANZATO': '990.00' }
            };
            return prezzi[servizio]?.[piano] || '0.00';
        }

        // Funzioni per invio manuale documenti
        async function sendContract(leadId, piano) {
            if (!confirm('Generare e inviare contratto ' + (piano || 'BASE') + ' al lead?')) {
                return;
            }
            
            console.log('üìÑ Invio contratto - leadId:', leadId, 'piano:', piano);
            
            try {
                const response = await fetch('/api/leads/' + leadId + '/send-contract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tipoContratto: piano || 'BASE' })
                });
                
                const result = await response.json();
                
                console.log('üìÑ Risposta invio contratto:', result);
                
                if (result.success) {
                    alert('‚úÖ Contratto inviato con successo!\\n\\nCodice: ' + (result.contractCode || 'N/A') + '\\nTemplate: email_invio_contratto');
                    loadLeadsData(); // Ricarica i dati
                } else {
                    alert('‚ùå Errore: ' + (result.error || 'Errore sconosciuto') + (result.details ? '\\n\\nDettagli: ' + result.details : ''));
                }
            } catch (error) {
                console.error('‚ùå Errore invio contratto:', error);
                alert('‚ùå Errore di comunicazione: ' + error.message);
            }
        }

        async function sendBrochure(leadId) {
            if (!confirm('Inviare brochure al lead?')) {
                return;
            }
            
            try {
                const response = await fetch(\`/api/leads/\${leadId}/send-brochure\`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Brochure inviata con successo!\\nTemplate: email_invio_brochure');
                    loadLeadsData(); // Ricarica i dati
                } else {
                    alert('‚ùå Errore: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Errore di comunicazione: ' + error.message);
            }
        }

        async function requestCompletion(leadId) {
            if (!confirm('Inviare email di richiesta completamento dati al lead?')) {
                return;
            }
            
            try {
                const response = await fetch(\`/api/leads/\${leadId}/request-completion?sendEmail=true\`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Email di completamento inviata con successo!\\nLink: ' + (result.token?.completionUrl || result.completionUrl) + '\\nScadenza: ' + (result.token?.expiresAt || result.expiresAt));
                    loadLeadsData(); // Ricarica i dati
                } else {
                    // Gestisci caso lead gi√† completo
                    if (result.error && result.error.includes('gi√† completo')) {
                        alert('‚ÑπÔ∏è Tutti i dati del lead sono gi√† completi.\\n\\nNon √® necessario inviare una email di richiesta completamento.');
                    } else {
                        alert('‚ùå Errore: ' + result.error);
                    }
                }
            } catch (error) {
                alert('‚ùå Errore di comunicazione: ' + error.message);
            }
        }

        // ============================================
        // CRUD FUNCTIONS - VIEW, EDIT, DELETE LEAD
        // ============================================
        
        function viewLead(leadId) {
            const lead = allLeads.find(l => l.id === leadId);
            if (!lead) {
                alert('‚ùå Lead non trovato');
                return;
            }
            
            // Mostra servizio e piano dal DB (se esistono i campi)
            // NOTA: tipoServizio contiene il SERVIZIO, non il piano!
            const servizio = lead.servizio || lead.tipoServizio || 'eCura PRO';
            const piano = lead.piano || 'BASE';  // Piano estratto dalle note durante migration
            
            document.getElementById('viewLeadId').textContent = lead.id;
            document.getElementById('viewNome').textContent = lead.nomeRichiedente || '-';
            document.getElementById('viewCognome').textContent = lead.cognomeRichiedente || '-';
            document.getElementById('viewEmail').textContent = lead.email || lead.email || '-';
            document.getElementById('viewTelefono').textContent = lead.telefono || lead.telefono || '-';
            document.getElementById('viewServizio').textContent = servizio;
            document.getElementById('viewPiano').textContent = piano;
            document.getElementById('viewNote').textContent = lead.note || '-';
            document.getElementById('viewData').textContent = new Date(lead.created_at).toLocaleDateString('it-IT');
            document.getElementById('viewCM').textContent = lead.cm || 'Nessuno';
            
            // Carica lo storico interazioni
            loadInteractions(leadId);
            
            openModal('viewLeadModal');
        }
        
        async function loadInteractions(leadId) {
            try {
                const response = await fetch(\`/api/leads/\${leadId}/interactions\`);
                const data = await response.json();
                
                const container = document.getElementById('interactionsList');
                
                if (!data.success || data.interactions.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Nessuna interazione registrata</p>';
                    return;
                }
                
                // Ordina per data decrescente (pi√π recenti prima)
                const interactions = data.interactions.sort((a, b) => 
                    new Date(b.data).getTime() - new Date(a.data).getTime()
                );
                
                container.innerHTML = interactions.map(int => {
                    const date = new Date(int.data).toLocaleString('it-IT');
                    const tipoIcon = {
                        'telefono': 'fa-phone',
                        'email': 'fa-envelope',
                        'whatsapp': 'fa-whatsapp',
                        'sms': 'fa-sms',
                        'meeting': 'fa-handshake',
                        'videocall': 'fa-video',
                        'nota': 'fa-sticky-note',
                        'follow-up': 'fa-clock'
                    }[int.tipo] || 'fa-comment';
                    
                    const tipoColor = {
                        'telefono': 'bg-blue-100 text-blue-700',
                        'email': 'bg-green-100 text-green-700',
                        'whatsapp': 'bg-green-100 text-green-700',
                        'sms': 'bg-purple-100 text-purple-700',
                        'meeting': 'bg-yellow-100 text-yellow-700',
                        'videocall': 'bg-indigo-100 text-indigo-700',
                        'nota': 'bg-gray-100 text-gray-700',
                        'follow-up': 'bg-orange-100 text-orange-700'
                    }[int.tipo] || 'bg-gray-100 text-gray-700';
                    
                    return \`
                        <div class="border-l-4 border-blue-500 bg-gray-50 p-3 rounded-r mb-3">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center space-x-2">
                                    <span class="px-2 py-1 \${tipoColor} text-xs rounded font-medium">
                                        <i class="fas \${tipoIcon} mr-1"></i>\${int.tipo}
                                    </span>
                                    <span class="text-xs text-gray-500">\${date}</span>
                                </div>
                                <span class="text-xs font-medium text-gray-600">\${int.operatore || 'N/A'}</span>
                            </div>
                            <p class="text-sm text-gray-700 mb-1"><strong>Nota:</strong> \${int.nota || '-'}</p>
                            \${int.azione ? \`<p class="text-sm text-gray-700"><strong>Azione:</strong> \${int.azione}</p>\` : ''}
                        </div>
                    \`;
                }).join('');
            } catch (error) {
                console.error('Errore caricamento interazioni:', error);
                document.getElementById('interactionsList').innerHTML = 
                    '<p class="text-red-500 text-sm text-center py-4">Errore caricamento interazioni</p>';
            }
        }
        
        async function addInteraction() {
            const leadId = document.getElementById('viewLeadId').textContent;
            const tipo = document.getElementById('interactionTipo').value;
            const nota = document.getElementById('interactionNota').value.trim();
            const azione = document.getElementById('interactionAzione').value.trim();
            const operatore = document.getElementById('interactionOperatore').value;
            
            if (!nota) {
                alert('‚ö†Ô∏è Inserisci una nota per questa interazione');
                return;
            }
            
            try {
                const response = await fetch(\`/api/leads/\${leadId}/interactions\`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tipo, nota, azione, operatore })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Reset form
                    document.getElementById('interactionNota').value = '';
                    document.getElementById('interactionAzione').value = '';
                    
                    // Ricarica interazioni
                    await loadInteractions(leadId);
                    
                    alert('‚úÖ Interazione aggiunta con successo');
                } else {
                    alert('‚ùå Errore: ' + (data.error || 'Impossibile aggiungere interazione'));
                }
            } catch (error) {
                console.error('Errore aggiunta interazione:', error);
                alert('‚ùå Errore di rete');
            }
        }
        
        function editLead(leadId) {
            const lead = allLeads.find(l => l.id === leadId);
            if (!lead) {
                alert('‚ùå Lead non trovato');
                return;
            }
            
            // Usa lo stesso modal del nuovo lead, ma con dati pre-compilati
            // Imposta flag edit mode
            window.editingLeadId = leadId;
            
            // Pre-compila TUTTI i campi
            document.getElementById('newNome').value = lead.nomeRichiedente || '';
            document.getElementById('newCognome').value = lead.cognomeRichiedente || '';
            document.getElementById('newEmail').value = lead.email || lead.email || '';
            document.getElementById('newTelefono').value = lead.telefono || lead.telefono || '';
            
            document.getElementById('newNomeAssistito').value = lead.nomeAssistito || '';
            document.getElementById('newCognomeAssistito').value = lead.cognomeAssistito || '';
            document.getElementById('newLuogoNascita').value = lead.luogoNascitaAssistito || '';
            document.getElementById('newDataNascita').value = lead.dataNascitaAssistito || '';
            document.getElementById('newIndirizzoAssistito').value = lead.indirizzoAssistito || '';
            document.getElementById('newCapAssistito').value = lead.capAssistito || '';
            document.getElementById('newCittaAssistito').value = lead.cittaAssistito || '';
            document.getElementById('newProvinciaAssistito').value = lead.provinciaAssistito || '';
            document.getElementById('newCodiceFiscale').value = lead.cfAssistito || lead.cfAssistito || '';
            document.getElementById('newCondizioniSalute').value = lead.condizioniSalute || '';
            
            // Intestatario contratto
            const intestatario = lead.intestatarioContratto || 'richiedente';
            if (intestatario === 'richiedente') {
                document.getElementById('newIntestatarioRichiedente').checked = true;
            } else {
                document.getElementById('newIntestatarioAssistito').checked = true;
            }
            
            document.getElementById('newServizio').value = lead.servizio || 'eCura PRO';
            updatePrices(); // Aggiorna prezzi in base al servizio
            document.getElementById('newPiano').value = lead.piano || 'BASE';
            document.getElementById('newCanale').value = lead.fonte || 'Website';
            
            document.getElementById('newVuoleBrochure').checked = (lead.vuoleBrochure === 'Si');
            document.getElementById('newVuoleContratto').checked = (lead.vuoleContratto === 'Si');
            document.getElementById('newVuoleManuale').checked = (lead.vuoleManuale === 'Si');
            
            document.getElementById('newConsensoPrivacy').checked = (lead.gdprConsent === 1);
            document.getElementById('newConsensoMarketing').checked = (lead.consensoMarketing === 'Si');
            document.getElementById('newConsensoTerze').checked = (lead.consensoTerze === 'Si');
            
            document.getElementById('newNote').value = lead.note || '';
            
            // Cambia titolo e sottotitolo modal per edit mode
            const modalTitle = document.querySelector('#newLeadModal h2');
            const modalSubtitle = document.querySelector('#newLeadModal .text-blue-100');
            const submitButton = document.getElementById('submitLeadButton');
            
            if (modalTitle) {
                modalTitle.textContent = '‚úèÔ∏è Modifica Lead';
            }
            if (modalSubtitle) {
                modalSubtitle.textContent = 'Modifica i dati del lead esistente';
            }
            if (submitButton) {
                submitButton.innerHTML = 'üíæ Aggiorna Lead';
            }
            
            // Rimuovi required dai campi in edit mode (puoi modificare solo alcuni campi)
            document.querySelectorAll('#newLeadForm [required]').forEach(field => {
                field.removeAttribute('required');
            });
            
            // Mostra sezione interazioni e carica lo storico
            const interactionsSection = document.getElementById('editInteractionsSection');
            if (interactionsSection) {
                interactionsSection.classList.remove('hidden');
                loadEditInteractions(leadId);
            }
            
            openModal('newLeadModal');
        }
        
        async function loadEditInteractions(leadId) {
            try {
                const response = await fetch(\`/api/leads/\${leadId}/interactions\`);
                const data = await response.json();
                
                const container = document.getElementById('editInteractionsList');
                
                if (!data.success || data.interactions.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-xs text-center py-4">Nessuna interazione registrata</p>';
                    return;
                }
                
                // Ordina per data decrescente (pi√π recenti prima)
                const interactions = data.interactions.sort((a, b) => 
                    new Date(b.data).getTime() - new Date(a.data).getTime()
                );
                
                container.innerHTML = interactions.map(int => {
                    const date = new Date(int.data).toLocaleString('it-IT', { dateStyle: 'short', timeStyle: 'short' });
                    const tipoIcon = {
                        'telefono': 'fa-phone',
                        'email': 'fa-envelope',
                        'whatsapp': 'fa-whatsapp',
                        'sms': 'fa-sms',
                        'meeting': 'fa-handshake',
                        'videocall': 'fa-video',
                        'nota': 'fa-sticky-note',
                        'follow-up': 'fa-clock'
                    }[int.tipo] || 'fa-comment';
                    
                    const tipoColor = {
                        'telefono': 'bg-blue-100 text-blue-700',
                        'email': 'bg-green-100 text-green-700',
                        'whatsapp': 'bg-green-100 text-green-700',
                        'sms': 'bg-purple-100 text-purple-700',
                        'meeting': 'bg-yellow-100 text-yellow-700',
                        'videocall': 'bg-indigo-100 text-indigo-700',
                        'nota': 'bg-gray-100 text-gray-700',
                        'follow-up': 'bg-orange-100 text-orange-700'
                    }[int.tipo] || 'bg-gray-100 text-gray-700';
                    
                    return \`
                        <div class="border-l-4 border-blue-500 bg-white p-2 rounded-r mb-2 text-xs">
                            <div class="flex items-start justify-between mb-1">
                                <div class="flex items-center space-x-2">
                                    <span class="px-2 py-0.5 \${tipoColor} text-xs rounded font-medium">
                                        <i class="fas \${tipoIcon} mr-1"></i>\${int.tipo}
                                    </span>
                                    <span class="text-xs text-gray-500">\${date}</span>
                                </div>
                                <span class="text-xs font-medium text-gray-600">\${int.operatore || 'N/A'}</span>
                            </div>
                            <p class="text-xs text-gray-700 mb-1"><strong>Nota:</strong> \${int.nota || '-'}</p>
                            \${int.azione ? \`<p class="text-xs text-gray-700"><strong>Azione:</strong> \${int.azione}</p>\` : ''}
                        </div>
                    \`;
                }).join('');
            } catch (error) {
                console.error('Errore caricamento interazioni:', error);
                document.getElementById('editInteractionsList').innerHTML = 
                    '<p class="text-red-500 text-xs text-center py-4">Errore caricamento</p>';
            }
        }
        
        async function addEditInteraction() {
            const leadId = window.editingLeadId;
            if (!leadId) {
                alert('‚ùå Lead ID non trovato');
                return;
            }
            
            const tipo = document.getElementById('editInteractionTipo').value;
            const nota = document.getElementById('editInteractionNota').value.trim();
            const azione = document.getElementById('editInteractionAzione').value.trim();
            const operatore = document.getElementById('editInteractionOperatore').value;
            
            if (!nota) {
                alert('‚ö†Ô∏è Inserisci una nota per questa interazione');
                return;
            }
            
            try {
                const response = await fetch(\`/api/leads/\${leadId}/interactions\`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tipo, nota, azione, operatore })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Reset form
                    document.getElementById('editInteractionNota').value = '';
                    document.getElementById('editInteractionAzione').value = '';
                    
                    // Ricarica interazioni
                    await loadEditInteractions(leadId);
                    
                    alert('‚úÖ Interazione aggiunta con successo');
                } else {
                    alert('‚ùå Errore: ' + (data.error || 'Impossibile aggiungere interazione'));
                }
            } catch (error) {
                console.error('Errore aggiunta interazione:', error);
                alert('‚ùå Errore di rete');
            }
        }
        
        // saveEditLead() rimossa - ora usa saveNewLead() con modalit√† edit
        
        async function deleteLead(leadId) {
            if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare questo lead?\\n\\nQuesta operazione √® irreversibile.')) {
                return;
            }
            
            try {
                const response = await fetch(\`/api/leads/\${leadId}\`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Lead eliminato con successo!');
                    loadLeadsData();
                } else {
                    alert('‚ùå Errore: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Errore di comunicazione: ' + error.message);
            }
        }
        
        async function updateContactManager(leadId, cm) {
            try {
                const response = await fetch(\`/api/leads/\${leadId}/cm\`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cm: cm || null })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Aggiorna il valore in allLeads
                    const lead = allLeads.find(l => l.id === leadId);
                    if (lead) {
                        lead.cm = cm || null;
                    }
                    console.log(\`‚úÖ Contact Manager aggiornato: \${leadId} ‚Üí \${cm || 'nessuno'}\`);
                } else {
                    alert('‚ùå Errore aggiornamento CM: ' + result.error);
                    loadLeadsData(); // Ricarica per ripristinare il valore precedente
                }
            } catch (error) {
                console.error('‚ùå Errore aggiornamento CM:', error);
                alert('‚ùå Errore di comunicazione: ' + error.message);
                loadLeadsData(); // Ricarica per ripristinare il valore precedente
            }
        }
        
        async function updateLeadStatus(leadId, stato) {
            try {
                const response = await fetch(\`/api/leads/\${leadId}\`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ stato: stato || null })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Aggiorna il valore in allLeads
                    const lead = allLeads.find(l => l.id === leadId);
                    if (lead) {
                        lead.stato = stato || null;
                    }
                    
                    // Aggiorna il colore dello sfondo del select
                    const select = document.getElementById(\`statusSelect-\${leadId}\`);
                    if (select) {
                        const colors = {
                            'nuovo': '#dbeafe',
                            'contattato': '#fef3c7',
                            'interessato': '#d1fae5',
                            'in_trattativa': '#e0e7ff',
                            'convertito': '#d1fae5',
                            'perso': '#fee2e2',
                            'non_interessato': '#f3f4f6',
                            'da_ricontattare': '#fef3c7'
                        };
                        select.style.background = colors[stato] || '#fff';
                    }
                    
                    console.log(\`‚úÖ Stato aggiornato: \${leadId} ‚Üí \${stato || 'nessuno'}\`);
                } else {
                    alert('‚ùå Errore aggiornamento stato: ' + result.error);
                    loadLeadsData();
                }
            } catch (error) {
                console.error('‚ùå Errore aggiornamento stato:', error);
                alert('‚ùå Errore di comunicazione: ' + error.message);
                loadLeadsData();
            }
        }
        
        function openInteractionsModal(leadId) {
            window.currentInteractionLeadId = leadId;
            const lead = allLeads.find(l => l.id === leadId);
            if (!lead) {
                alert('‚ùå Lead non trovato');
                return;
            }
            
            // Popola info lead nel modale
            document.getElementById('intModalLeadName').textContent = 
                (lead.nomeRichiedente || '') + ' ' + (lead.cognomeRichiedente || '').trim() || lead.email;
            document.getElementById('intModalLeadContact').textContent = 
                (lead.email || '') + ' ‚Ä¢ ' + (lead.telefono || '');
            document.getElementById('intModalLeadId').textContent = leadId;
            
            // Carica lo storico interazioni
            loadInteractionsModal(leadId);
            
            // Reset form nuova interazione
            document.getElementById('intModalTipo').value = 'telefono';
            document.getElementById('intModalOperatore').value = 'Ottavia Belfa';
            document.getElementById('intModalNota').value = '';
            document.getElementById('intModalAzione').value = '';
            
            // Attach event listeners to modal buttons
            setTimeout(() => {
                const saveBtn = document.getElementById('saveInteractionBtn');
                const closeBtn = document.getElementById('closeInteractionsModalBtn');
                
                if (saveBtn) {
                    saveBtn.replaceWith(saveBtn.cloneNode(true)); // Remove old listeners
                    document.getElementById('saveInteractionBtn').addEventListener('click', addInteractionFromModal);
                }
                
                if (closeBtn) {
                    closeBtn.replaceWith(closeBtn.cloneNode(true)); // Remove old listeners
                    document.getElementById('closeInteractionsModalBtn').addEventListener('click', () => closeModal('interactionsModal'));
                }
            }, 0);
            
            // Apri il modale
            openModal('interactionsModal');
        }
        
        async function loadInteractionsModal(leadId) {
            try {
                const response = await fetch('/api/leads/' + leadId + '/interactions');
                const data = await response.json();
                
                const container = document.getElementById('intModalInteractionsList');
                
                if (!data.success || data.interactions.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-xs text-center py-4">üì≠ Nessuna interazione registrata per questo lead</p>';
                    return;
                }
                
                // Ordina per data decrescente (pi√π recenti prima)
                const interactions = data.interactions.sort((a, b) => 
                    new Date(b.data).getTime() - new Date(a.data).getTime()
                );
                
                container.innerHTML = interactions.map(int => {
                    const date = new Date(int.data).toLocaleString('it-IT', { 
                        dateStyle: 'short', 
                        timeStyle: 'short' 
                    });
                    const tipoIcon = {
                        'telefono': 'fa-phone',
                        'email': 'fa-envelope',
                        'whatsapp': 'fa-whatsapp',
                        'sms': 'fa-sms',
                        'meeting': 'fa-handshake',
                        'videocall': 'fa-video',
                        'nota': 'fa-sticky-note',
                        'follow-up': 'fa-clock'
                    }[int.tipo] || 'fa-comment';
                    
                    const tipoColor = {
                        'telefono': 'bg-blue-100 text-blue-700 border-blue-300',
                        'email': 'bg-green-100 text-green-700 border-green-300',
                        'whatsapp': 'bg-green-100 text-green-700 border-green-300',
                        'sms': 'bg-purple-100 text-purple-700 border-purple-300',
                        'meeting': 'bg-yellow-100 text-yellow-700 border-yellow-300',
                        'videocall': 'bg-indigo-100 text-indigo-700 border-indigo-300',
                        'nota': 'bg-gray-100 text-gray-700 border-gray-300',
                        'follow-up': 'bg-orange-100 text-orange-700 border-orange-300'
                    }[int.tipo] || 'bg-gray-100 text-gray-700 border-gray-300';
                    
                    let html = '<div class="mb-3 p-3 bg-white border-l-4 ' + tipoColor + ' rounded-lg shadow-sm">';
                    html += '<div class="flex justify-between items-start mb-2">';
                    html += '<span class="inline-flex items-center px-2 py-1 text-xs font-medium ' + tipoColor + ' rounded">';
                    html += '<i class="fas ' + tipoIcon + ' mr-1"></i> ' + int.tipo.toUpperCase();
                    html += '</span>';
                    html += '<span class="text-xs text-gray-500">' + date + '</span>';
                    html += '</div>';
                    html += '<p class="text-sm text-gray-800 mb-1"><strong>Nota:</strong> ' + (int.nota || '-') + '</p>';
                    if (int.azione) {
                        html += '<p class="text-sm text-blue-700"><strong>Azione:</strong> ' + int.azione + '</p>';
                    }
                    if (int.operatore) {
                        html += '<p class="text-xs text-gray-600 mt-2"><i class="fas fa-user-circle"></i> <strong>' + int.operatore + '</strong></p>';
                    }
                    html += '</div>';
                    return html;
                }).join('');
            } catch (error) {
                console.error('Errore caricamento interazioni:', error);
                document.getElementById('intModalInteractionsList').innerHTML = 
                    '<p class="text-red-500 text-xs text-center py-4">‚ùå Errore nel caricamento delle interazioni</p>';
            }
        }
        
        async function addInteractionFromModal() {
            const leadId = window.currentInteractionLeadId;
            if (!leadId) {
                alert('‚ùå Errore: ID lead non trovato');
                return;
            }
            
            const tipo = document.getElementById('intModalTipo').value;
            const operatore = document.getElementById('intModalOperatore').value;
            const nota = document.getElementById('intModalNota').value.trim();
            const azione = document.getElementById('intModalAzione').value.trim();
            
            if (!nota) {
                alert('‚ö†Ô∏è Inserisci una nota per questa interazione');
                return;
            }
            
            try {
                const response = await fetch('/api/leads/' + leadId + '/interactions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data: new Date().toISOString(),
                        tipo,
                        nota,
                        azione: azione || null,
                        operatore
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Interazione salvata con successo!');
                    // Ricarica lo storico
                    loadInteractionsModal(leadId);
                    // Reset form
                    document.getElementById('intModalNota').value = '';
                    document.getElementById('intModalAzione').value = '';
                } else {
                    alert('‚ùå Errore: ' + (data.error || 'Errore sconosciuto'));
                }
            } catch (error) {
                console.error('Errore salvataggio interazione:', error);
                alert('‚ùå Errore di comunicazione: ' + error.message);
            }
        }
        
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.body.style.overflow = 'auto';
            
            // Reset edit mode quando si chiude il modal newLeadModal
            if (modalId === 'newLeadModal') {
                window.editingLeadId = null;
                const modalTitle = document.querySelector('#newLeadModal h2');
                const modalSubtitle = document.querySelector('#newLeadModal .text-blue-100');
                const submitButton = document.getElementById('submitLeadButton');
                
                if (modalTitle) {
                    modalTitle.textContent = 'üÜï Richiedi il tuo servizio eCura';
                }
                if (modalSubtitle) {
                    modalSubtitle.textContent = 'Compila il form per ricevere brochure e contratto personalizzato';
                }
                if (submitButton) {
                    submitButton.innerHTML = '‚úâÔ∏è Invia Richiesta';
                }
                
                // Ripristina i required solo sui campi principali
                const requiredFields = ['newNome', 'newCognome', 'newEmail', 'newTelefono'];
                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.setAttribute('required', 'required');
                });
            }
        }
        
        function openNewLeadModal() {
            // Reset edit mode
            window.editingLeadId = null;
            
            // Reset form
            document.getElementById('newLeadForm').reset();
            
            // Reset titolo, sottotitolo, pulsante e modalit√†
            document.getElementById('isEditMode').value = '';
            const modalTitle = document.querySelector('#newLeadModal h2');
            const modalSubtitle = document.querySelector('#newLeadModal .text-blue-100');
            const submitButton = document.getElementById('submitLeadButton');
            
            if (modalTitle) {
                modalTitle.textContent = 'üÜï Richiedi il tuo servizio eCura';
            }
            if (modalSubtitle) {
                modalSubtitle.textContent = 'Compila il form per ricevere brochure e contratto personalizzato';
            }
            if (submitButton) {
                submitButton.innerHTML = '‚úâÔ∏è Invia Richiesta';
            }
            
            // Ripristina i required solo sui campi principali
            const requiredFields = ['newNome', 'newCognome', 'newEmail', 'newTelefono'];
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.setAttribute('required', 'required');
            });
            
            // Nascondi sezione interazioni (solo per Edit)
            const interactionsSection = document.getElementById('editInteractionsSection');
            if (interactionsSection) {
                interactionsSection.classList.add('hidden');
            }
            
            openModal('newLeadModal');
            // Aggiorna prezzi iniziali
            updatePrices();
            
            // Aggiungi event listener per calcolo et√† automatico
            const dataNascitaInput = document.getElementById('newDataNascita');
            if (dataNascitaInput) {
                dataNascitaInput.addEventListener('blur', calculateAge);
                dataNascitaInput.addEventListener('change', calculateAge);
            }
        }
        
        function calculateAge() {
            const dataNascitaInput = document.getElementById('newDataNascita');
            const etaDisplay = document.getElementById('etaCalcolata');
            
            if (!dataNascitaInput || !dataNascitaInput.value) {
                if (etaDisplay) etaDisplay.textContent = '';
                return;
            }
            
            // Parse data in formato DD/MM/YYYY
            const dataNascitaValue = dataNascitaInput.value.trim();
            const parts = dataNascitaValue.split('/');
            
            if (parts.length !== 3) {
                if (etaDisplay) etaDisplay.textContent = 'Formato non valido (usa DD/MM/YYYY)';
                return;
            }
            
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; // I mesi in JS partono da 0
            const year = parseInt(parts[2], 10);
            
            if (isNaN(day) || isNaN(month) || isNaN(year)) {
                if (etaDisplay) etaDisplay.textContent = 'Data non valida';
                return;
            }
            
            const dataNascita = new Date(year, month, day);
            const oggi = new Date();
            
            let eta = oggi.getFullYear() - dataNascita.getFullYear();
            const meseOggi = oggi.getMonth();
            const giornoOggi = oggi.getDate();
            
            // Aggiusta et√† se il compleanno non √® ancora passato quest'anno
            if (meseOggi < dataNascita.getMonth() || 
                (meseOggi === dataNascita.getMonth() && giornoOggi < dataNascita.getDate())) {
                eta--;
            }
            
            if (eta < 0 || eta > 120) {
                if (etaDisplay) etaDisplay.textContent = 'Et√† non valida';
                return;
            }
            
            if (etaDisplay) {
                etaDisplay.textContent = 'Et√†: ' + eta + ' anni';
                etaDisplay.className = 'text-sm font-semibold text-green-600 mt-1';
            }
        }
        
        function updatePrices() {
            const servizio = document.getElementById('newServizio').value;
            const pianoSelect = document.getElementById('newPiano');
            const priceNote = document.getElementById('priceNote');
            
            // Prezzi per servizio (primo anno / rinnovo) - AGGIORNATI da ecura.it
            const prices = {
                'eCura FAMILY': {
                    BASE: { primo: 390, rinnovo: 200 },
                    AVANZATO: { primo: 690, rinnovo: 500 }
                },
                'eCura PRO': {
                    BASE: { primo: 480, rinnovo: 240 },
                    AVANZATO: { primo: 840, rinnovo: 600 }
                },
                'eCura PREMIUM': {
                    BASE: { primo: 590, rinnovo: 300 },
                    AVANZATO: { primo: 990, rinnovo: 750 }
                }
            };
            
            if (!servizio || !prices[servizio]) {
                pianoSelect.innerHTML = '<option value="">Seleziona prima un servizio</option>';
                priceNote.textContent = 'Seleziona un servizio per vedere i prezzi';
                return;
            }
            
            const servicePrices = prices[servizio];
            const dispositivo = servizio.includes('PREMIUM') ? 'SiDLY Vital Care' : 'SiDLY Care PRO';
            
            pianoSelect.innerHTML = \`
                <option value="BASE">Piano BASE - ‚Ç¨\${servicePrices.BASE.primo}/anno (rinnovo ‚Ç¨\${servicePrices.BASE.rinnovo}/anno)</option>
                <option value="AVANZATO">Piano AVANZATO - ‚Ç¨\${servicePrices.AVANZATO.primo}/anno (rinnovo ‚Ç¨\${servicePrices.AVANZATO.rinnovo}/anno)</option>
            \`;
            
            priceNote.textContent = \`I prezzi mostrati sono per il servizio \${servizio}. Include dispositivo \${dispositivo}.\`;
        }
        
        async function saveNewLead() {
            const isEditMode = !!window.editingLeadId;
            const leadId = window.editingLeadId;
            
            const formData = {
                // Dati richiedente
                nomeRichiedente: document.getElementById('newNome').value,
                cognomeRichiedente: document.getElementById('newCognome').value,
                email: document.getElementById('newEmail').value,
                telefono: document.getElementById('newTelefono').value,
                
                // Dati assistito
                nomeAssistito: document.getElementById('newNomeAssistito').value,
                cognomeAssistito: document.getElementById('newCognomeAssistito').value,
                luogoNascitaAssistito: document.getElementById('newLuogoNascita').value,
                dataNascitaAssistito: document.getElementById('newDataNascita').value,
                indirizzoAssistito: document.getElementById('newIndirizzoAssistito').value,
                capAssistito: document.getElementById('newCapAssistito').value,
                cittaAssistito: document.getElementById('newCittaAssistito').value,
                provinciaAssistito: document.getElementById('newProvinciaAssistito').value.toUpperCase(),
                cfAssistito: document.getElementById('newCodiceFiscale').value.toUpperCase(),
                
                // Intestatario contratto
                intestatarioContratto: document.querySelector('input[name="intestatario"]:checked').value,
                
                // Condizioni di salute
                condizioniSalute: document.getElementById('newCondizioniSalute').value,
                
                // Servizio e Piano
                servizio: document.getElementById('newServizio').value,
                piano: document.getElementById('newPiano').value,
                canale: document.getElementById('newCanale').value,
                fonte: document.getElementById('newCanale').value,
                
                // Preferenze
                vuoleBrochure: document.getElementById('newVuoleBrochure').checked ? 'Si' : 'No',
                vuoleContratto: document.getElementById('newVuoleContratto').checked ? 'Si' : 'No',
                vuoleManuale: document.getElementById('newVuoleManuale').checked ? 'Si' : 'No',
                
                // Consensi
                gdprConsent: document.getElementById('newConsensoPrivacy').checked,
                consensoMarketing: document.getElementById('newConsensoMarketing').checked ? 'Si' : 'No',
                consensoTerze: document.getElementById('newConsensoTerze').checked ? 'Si' : 'No',
                
                // Note
                note: document.getElementById('newNote').value
            };
            
            // Validation campi obbligatori SOLO in modalit√† nuovo lead
            if (!isEditMode) {
                if (!formData.nomeRichiedente || !formData.cognomeRichiedente || !formData.email || !formData.telefono) {
                    alert("‚ö†Ô∏è Compila tutti i campi obbligatori del Richiedente");
                    return;
                }
                
                if (!formData.nomeAssistito || !formData.cognomeAssistito) {
                    alert("‚ö†Ô∏è Compila tutti i campi obbligatori dell'Assistito");
                    return;
                }
                
                if (!formData.gdprConsent) {
                    alert("‚ö†Ô∏è Il consenso Privacy √® obbligatorio");
                    return;
                }
            }
            // In modalit√† edit: nessuna validazione, puoi modificare quello che vuoi
            
            console.log(isEditMode ? 'üìù Aggiornamento lead:' : 'üì§ Invio dati lead:', formData);
            
            try {
                const url = isEditMode ? '/api/leads/' + leadId : '/api/leads';
                const method = isEditMode ? 'PUT' : 'POST';
                
                console.log('[REQUEST] ' + method + ' ' + url);
                console.log('[PAYLOAD]', JSON.stringify(formData, null, 2));
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                console.log('[RESPONSE] Status: ' + response.status + ' ' + response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[ERROR] Response:', errorText);
                    throw new Error('HTTP ' + response.status + ': ' + errorText.substring(0, 200));
                }
                
                const result = await response.json();
                console.log('[RESULT]', result);
                
                if (result.success) {
                    let message = isEditMode 
                        ? "‚úÖ Lead aggiornato con successo!" 
                        : "‚úÖ Lead creato con successo!\\n\\nID: " + (result.id || result.leadId);
                    
                    // Mostra email inviate solo per nuovo lead
                    if (!isEditMode && result.emails) {
                        message += "\\n\\nüìß Email inviate:";
                        if (result.emails.notifica && result.emails.notifica.sent) message += "\\n  ‚úì Notifica nuovo lead";
                        if (result.emails.brochure && result.emails.brochure.sent) message += "\\n  ‚úì Brochure al cliente";
                        if (result.emails.contratto && result.emails.contratto.sent) message += "\\n  ‚úì Contratto al cliente";
                    }
                    
                    alert(message);
                    closeModal('newLeadModal');
                    document.getElementById('newLeadForm').reset();
                    
                    // Reset edit mode
                    window.editingLeadId = null;
                    const modalTitle = document.querySelector('#newLeadModal h2');
                    if (modalTitle) {
                        modalTitle.textContent = 'Richiedi il tuo servizio eCura';
                    }
                    
                    // Ricarica la pagina per aggiornare i dati
                    window.location.reload();
                } else {
                    alert("‚ùå Errore: " + (result.error || "Errore sconosciuto"));
                }
            } catch (error) {
                console.error(isEditMode ? "‚ùå Errore aggiornamento lead:" : "‚ùå Errore creazione lead:", error);
                alert("‚ùå Errore di comunicazione: " + error.message);
            }
        }
        
        // ========== CRUD ASSISTITI ==========
        
        async function viewAssistito(id) {
            try {
                const response = await fetch('/api/assistiti?id=' + id);
                const data = await response.json();
                
                if (data.success && data.assistiti && data.assistiti.length > 0) {
                    const assistito = data.assistiti[0];
                    
                    // Mostra modal dettagli assistito
                    alert('üìã Dettagli Assistito\\n\\n' +
                        'Nome: ' + (assistito.nome_assistito || '') + ' ' + (assistito.cognome_assistito || '') + '\\n' +
                        'Caregiver: ' + (assistito.nome_caregiver || 'N/A') + ' ' + (assistito.cognome_caregiver || '') + '\\n' +
                        'Parentela: ' + (assistito.parentela_caregiver || 'N/A') + '\\n' +
                        'IMEI: ' + (assistito.imei || 'N/A') + '\\n' +
                        'Email: ' + (assistito.email || 'N/A') + '\\n' +
                        'Telefono: ' + (assistito.telefono || 'N/A') + '\\n' +
                        'Piano: ' + (assistito.piano || 'BASE') + '\\n' +
                        'Contratto: ' + (assistito.codice_contratto || 'Nessuno') + '\\n' +
                        'Status: ' + (assistito.contratto_status || assistito.status || 'N/A')
                    );
                } else {
                    alert('‚ùå Assistito non trovato');
                }
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
            }
        }
        window.viewAssistito = viewAssistito;  // Esponi globalmente
        
        async function editAssistito(id) {
            try {
                const response = await fetch('/api/assistiti?id=' + id);
                const data = await response.json();
                
                if (data.success && data.assistiti && data.assistiti.length > 0) {
                    const assistito = data.assistiti[0];
                    
                    // Richiedi nuovi dati
                    const nuovoNome = prompt('Nome Assistito:', assistito.nome_assistito || '');
                    if (!nuovoNome) return;
                    
                    const nuovoCognome = prompt('Cognome Assistito:', assistito.cognome_assistito || '');
                    if (!nuovoCognome) return;
                    
                    const nuovaEmail = prompt('Email:', assistito.email || '');
                    const nuovoTelefono = prompt('Telefono:', assistito.telefono || '');
                    const nuovoIMEI = prompt('IMEI Dispositivo:', assistito.imei || '');
                    
                    const caregiverNome = prompt('Nome Caregiver:', assistito.nome_caregiver || '');
                    const caregiverCognome = prompt('Cognome Caregiver:', assistito.cognome_caregiver || '');
                    const parentela = prompt('Parentela Caregiver:', assistito.parentela_caregiver || '');
                    
                    // Aggiorna
                    const updateResponse = await fetch(\`/api/assistiti/\${id}\`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            nome_assistito: nuovoNome,
                            cognome_assistito: nuovoCognome,
                            nome_caregiver: caregiverNome,
                            cognome_caregiver: caregiverCognome,
                            parentela_caregiver: parentela,
                            email: nuovaEmail,
                            telefono: nuovoTelefono,
                            imei: nuovoIMEI
                        })
                    });
                    
                    const result = await updateResponse.json();
                    
                    if (result.success) {
                        alert('‚úÖ Assistito aggiornato con successo!');
                        loadDashboardData(); // Ricarica dashboard
                    } else {
                        alert('‚ùå Errore: ' + result.error);
                    }
                } else {
                    alert('‚ùå Assistito non trovato');
                }
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
            }
        }
        window.editAssistito = editAssistito;  // Esponi globalmente
        
        async function deleteAssistito(id, nome) {
            if (!confirm(\`‚ö†Ô∏è Sei sicuro di voler eliminare l'assistito \${nome}?\\n\\nQuesta azione non pu√≤ essere annullata!\`)) {
                return;
            }
            
            try {
                const response = await fetch(\`/api/assistiti/\${id}\`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Assistito ' + nome + ' eliminato con successo!');
                    loadDashboardData(); // Ricarica dashboard
                } else {
                    alert('‚ùå Errore: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
            }
        }
        window.deleteAssistito = deleteAssistito;  // Esponi globalmente
    <\/script>

    <!-- MODAL: NEW LEAD - Form Stile eCura.it -->
    <div id="newLeadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[95vh] overflow-hidden">
            
            <!-- HEADER -->
            <div style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%)" class="text-white px-8 py-6 rounded-t-xl">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold mb-1">Richiedi il tuo servizio eCura</h2>
                        <p class="text-blue-100 text-sm">Compila il form per ricevere brochure e contratto personalizzato</p>
                    </div>
                    <button onclick="closeModal('newLeadModal')" class="text-white hover:text-gray-200 text-3xl leading-none">&times;</button>
                </div>
            </div>
            
            <!-- FORM CONTENT -->
            <div class="p-8 overflow-y-auto" style="max-height: calc(95vh - 180px)">
                <form id="newLeadForm" class="space-y-8">
                    <!-- Hidden field per gestire edit mode -->
                    <input type="hidden" id="isEditMode" value="">
                    
                    <!-- STEP 1: CHI SEI -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 border-l-4 border-blue-500">
                        <h3 class="text-xl font-bold text-gray-800 mb-1 flex items-center">
                            <span class="bg-blue-500 text-white w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">1</span>
                            Chi sei?
                        </h3>
                        <p class="text-gray-600 text-sm mb-4 ml-11">I tuoi dati di contatto</p>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Nome *</label>
                                <input type="text" id="newNome" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                                    placeholder="Mario">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Cognome *</label>
                                <input type="text" id="newCognome" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                                    placeholder="Rossi">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Email *</label>
                                <input type="email" id="newEmail" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                                    placeholder="mario.rossi@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Telefono *</label>
                                <input type="tel" id="newTelefono" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                                    placeholder="+39 333 1234567">
                            </div>
                        </div>
                    </div>

                    <!-- STEP 2: PER CHI √à IL SERVIZIO -->
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-6 border-l-4 border-green-500">
                        <h3 class="text-xl font-bold text-gray-800 mb-1 flex items-center">
                            <span class="bg-green-500 text-white w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">2</span>
                            Per chi √® il servizio?
                        </h3>
                        <p class="text-gray-600 text-sm mb-4 ml-11">Dati anagrafici completi dell'assistito</p>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Nome Assistito</label>
                                <input type="text" id="newNomeAssistito" 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                                    placeholder="Giuseppe">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Cognome Assistito</label>
                                <input type="text" id="newCognomeAssistito" 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                                    placeholder="Rossi">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Luogo di Nascita</label>
                                <input type="text" id="newLuogoNascita" 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                                    placeholder="Milano">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Data di Nascita</label>
                                <input type="text" id="newDataNascita" 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                                    placeholder="15/03/1950"
                                    onblur="calculateAge()" onchange="calculateAge()">
                                <div id="etaCalcolata" class="text-sm text-gray-500 mt-1"></div>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Indirizzo Completo</label>
                                <input type="text" id="newIndirizzoAssistito" 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                                    placeholder="Via Roma 123">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">CAP</label>
                                <input type="text" id="newCapAssistito" maxlength="5"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                                    placeholder="20121">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Citt√†</label>
                                <input type="text" id="newCittaAssistito" 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                                    placeholder="Milano">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Provincia</label>
                                <input type="text" id="newProvinciaAssistito" maxlength="2"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition uppercase"
                                    placeholder="MI">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Codice Fiscale</label>
                                <input type="text" id="newCodiceFiscale" maxlength="16"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition uppercase"
                                    placeholder="RSSGPP50C15F205X">
                            </div>
                        </div>
                        
                        <!-- CONDIZIONI DI SALUTE -->
                        <div class="mt-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-notes-medical text-green-600 mr-2"></i>
                                Condizioni di salute
                            </label>
                            <textarea id="newCondizioniSalute" rows="3"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                                placeholder="Descrivere eventuali patologie, allergie, limitazioni motorie o altre informazioni mediche rilevanti per il servizio..."></textarea>
                            <p class="text-xs text-gray-500 mt-1">
                                Queste informazioni aiutano a personalizzare il servizio e garantire un'assistenza adeguata
                            </p>
                        </div>
                        
                        <!-- INTESTATARIO CONTRATTO -->
                        <div class="mt-6 p-4 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">
                                <i class="fas fa-file-signature text-yellow-600 mr-2"></i>
                                Intestatario Contratto *
                            </label>
                            <div class="flex gap-4">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" id="newIntestatarioRichiedente" name="intestatario" value="richiedente" checked
                                        class="w-5 h-5 text-yellow-600 focus:ring-yellow-500 focus:ring-2">
                                    <span class="ml-3 text-gray-700 font-medium">
                                        üìù Richiedente
                                        <span class="block text-xs text-gray-500">Il contratto sar√† intestato a te</span>
                                    </span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" id="newIntestatarioAssistito" name="intestatario" value="assistito"
                                        class="w-5 h-5 text-yellow-600 focus:ring-yellow-500 focus:ring-2">
                                    <span class="ml-3 text-gray-700 font-medium">
                                        üë¥ Assistito
                                        <span class="block text-xs text-gray-500">Il contratto sar√† intestato all'assistito</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 3: QUALE SERVIZIO VUOI -->
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-6 border-l-4 border-purple-500">
                        <h3 class="text-xl font-bold text-gray-800 mb-1 flex items-center">
                            <span class="bg-purple-500 text-white w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">3</span>
                            Quale servizio vuoi?
                        </h3>
                        <p class="text-gray-600 text-sm mb-4 ml-11">Scegli il servizio e il piano pi√π adatto</p>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Servizio eCura *</label>
                                <select id="newServizio" required onchange="updatePrices()"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition bg-white">
                                    <option value="">Seleziona servizio...</option>
                                    <option value="eCura FAMILY">eCura FAMILY</option>
                                    <option value="eCura PRO" selected>eCura PRO</option>
                                    <option value="eCura PREMIUM">eCura PREMIUM</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Piano *</label>
                                <select id="newPiano" required onchange="updatePrices()"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition bg-white">
                                    <option value="BASE">Piano BASE - ‚Ç¨480/anno (rinnovo ‚Ç¨200/anno)</option>
                                    <option value="AVANZATO">Piano AVANZATO - ‚Ç¨840/anno (rinnovo ‚Ç¨600/anno)</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1" id="priceNote">
                                    I prezzi mostrati sono per il servizio eCura PRO. Il prezzo include dispositivo SiDLY Care PRO.
                                </p>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Come ci hai conosciuto? *</label>
                                <select id="newCanale" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition bg-white">
                                    <option value="">Seleziona fonte...</option>
                                    <option value="Sito www.eCura.it">Sito www.eCura.it</option>
                                    <option value="Privati IRBEMA">Privati IRBEMA</option>
                                    <option value="Form eCura">Form eCura</option>
                                    <option value="Form eCura x Test">Form eCura x Test</option>
                                    <option value="B2B IRBEMA">B2B IRBEMA</option>
                                    <option value="Sito web Medica GB">Sito web Medica GB</option>
                                    <option value="NETWORKING">NETWORKING</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 4: PREFERENZE -->
                    <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-lg p-6 border-l-4 border-amber-500">
                        <h3 class="text-xl font-bold text-gray-800 mb-1 flex items-center">
                            <span class="bg-amber-500 text-white w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">4</span>
                            Cosa vuoi ricevere?
                        </h3>
                        <p class="text-gray-600 text-sm mb-4 ml-11">Documenti e informazioni</p>
                        
                        <div class="space-y-3">
                            <label class="flex items-center p-4 bg-white rounded-lg border-2 border-gray-200 hover:border-amber-400 cursor-pointer transition">
                                <input type="checkbox" id="newVuoleBrochure" checked 
                                    class="mr-4 w-6 h-6 text-amber-600 border-2 border-gray-300 rounded focus:ring-amber-500">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">üìö Brochure Informativa</div>
                                    <div class="text-sm text-gray-600">Ricevi via email la brochure con tutte le caratteristiche del dispositivo associato al servizio scelto</div>
                                </div>
                            </label>
                            
                            <label class="flex items-center p-4 bg-white rounded-lg border-2 border-gray-200 hover:border-amber-400 cursor-pointer transition">
                                <input type="checkbox" id="newVuoleContratto" checked 
                                    class="mr-4 w-6 h-6 text-amber-600 border-2 border-gray-300 rounded focus:ring-amber-500">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">üìã Contratto Personalizzato</div>
                                    <div class="text-sm text-gray-600">Ricevi il contratto precompilato con i tuoi dati</div>
                                </div>
                            </label>
                            
                            <label class="flex items-center p-4 bg-white rounded-lg border-2 border-gray-200 hover:border-amber-400 cursor-pointer transition">
                                <input type="checkbox" id="newVuoleManuale" 
                                    class="mr-4 w-6 h-6 text-amber-600 border-2 border-gray-300 rounded focus:ring-amber-500">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">üìñ Manuale Utente</div>
                                    <div class="text-sm text-gray-600">Guida all'utilizzo del dispositivo e dei servizi</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- STEP 5: CONSENSI -->
                    <div class="bg-gradient-to-r from-gray-50 to-slate-50 rounded-lg p-6 border-l-4 border-gray-400">
                        <h3 class="text-xl font-bold text-gray-800 mb-1 flex items-center">
                            <span class="bg-gray-500 text-white w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">5</span>
                            Privacy e Consensi
                        </h3>
                        <p class="text-gray-600 text-sm mb-4 ml-11">Informativa sul trattamento dei dati personali</p>
                        
                        <div class="space-y-3">
                            <label class="flex items-start p-4 bg-white rounded-lg border-2 border-green-200 cursor-pointer">
                                <input type="checkbox" id="newConsensoPrivacy" checked required 
                                    class="mr-4 mt-1 w-6 h-6 text-green-600 border-2 border-gray-300 rounded focus:ring-green-500">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">‚úÖ Consenso Privacy *</div>
                                    <div class="text-sm text-gray-600">Acconsento al trattamento dei miei dati personali secondo la <a href="#" class="text-blue-600 hover:underline">Privacy Policy</a> (obbligatorio)</div>
                                </div>
                            </label>
                            
                            <label class="flex items-start p-4 bg-white rounded-lg border-2 border-gray-200 cursor-pointer hover:border-gray-400 transition">
                                <input type="checkbox" id="newConsensoMarketing" 
                                    class="mr-4 mt-1 w-6 h-6 text-blue-600 border-2 border-gray-300 rounded focus:ring-blue-500">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">üì¨ Comunicazioni Marketing</div>
                                    <div class="text-sm text-gray-600">Acconsento alla ricezione di comunicazioni commerciali e promozionali (facoltativo)</div>
                                </div>
                            </label>
                            
                            <label class="flex items-start p-4 bg-white rounded-lg border-2 border-gray-200 cursor-pointer hover:border-gray-400 transition">
                                <input type="checkbox" id="newConsensoTerze" 
                                    class="mr-4 mt-1 w-6 h-6 text-blue-600 border-2 border-gray-300 rounded focus:ring-blue-500">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">ü§ù Comunicazione a Terze Parti</div>
                                    <div class="text-sm text-gray-600">Acconsento alla comunicazione dei miei dati a partner selezionati (facoltativo)</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- NOTE OPZIONALI -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">üí¨ Note Aggiuntive (opzionale)</label>
                        <textarea id="newNote" rows="3" 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                            placeholder="Eventuali note o richieste particolari..."></textarea>
                    </div>

                </form>
                
                <!-- SEZIONE INTERAZIONI (solo in modalit√† EDIT) -->
                <div id="editInteractionsSection" class="hidden mt-6 border-t pt-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        üí¨ <span class="ml-2">Storico & Nuova Interazione</span>
                    </h4>
                    
                    <!-- Storico Interazioni -->
                    <div class="mb-4">
                        <h5 class="text-sm font-semibold text-gray-700 mb-2">üìã Storico Interazioni</h5>
                        <div id="editInteractionsList" class="max-h-48 overflow-y-auto bg-gray-50 rounded-lg p-3">
                            <p class="text-gray-500 text-xs text-center py-4">Caricamento...</p>
                        </div>
                    </div>
                    
                    <!-- Form Aggiungi Interazione -->
                    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                        <h5 class="text-sm font-semibold text-gray-700 mb-3">‚ûï Aggiungi Nuova Interazione</h5>
                        <div class="grid grid-cols-2 gap-3 mb-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Tipo</label>
                                <select id="editInteractionTipo" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                    <option value="telefono">üìû Telefono</option>
                                    <option value="email">üìß Email</option>
                                    <option value="whatsapp">üí¨ WhatsApp</option>
                                    <option value="sms">üì± SMS</option>
                                    <option value="meeting">ü§ù Meeting</option>
                                    <option value="videocall">üìπ Videocall</option>
                                    <option value="nota">üìù Nota</option>
                                    <option value="follow-up">üîî Follow-up</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Operatore</label>
                                <select id="editInteractionOperatore" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                    <option value="Stefania Rocca">Stefania Rocca (SR)</option>
                                    <option value="Ottavia Belfa">Ottavia Belfa (OB)</option>
                                    <option value="Roberto Poggi">Roberto Poggi (RP)</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="block text-xs font-medium text-gray-700 mb-1">Nota <span class="text-red-500">*</span></label>
                            <textarea id="editInteractionNota" rows="2" 
                                      class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                      placeholder="Descrivi cosa √® successo..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="block text-xs font-medium text-gray-700 mb-1">Azione</label>
                            <textarea id="editInteractionAzione" rows="2" 
                                      class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                      placeholder="Cosa fare successivamente? (opzionale)"></textarea>
                        </div>
                        <button onclick="addEditInteraction()" 
                                class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium text-sm">
                            üíæ Salva Interazione
                        </button>
                    </div>
                </div>
                
            </div>
            
            <!-- FOOTER BUTTONS -->
            <div class="bg-gray-50 px-8 py-6 rounded-b-xl border-t flex justify-between items-center">
                <div class="text-sm text-gray-600">
                    <span class="text-red-600">*</span> Campi obbligatori
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal('newLeadModal')" 
                        class="px-8 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                        ‚ùå Annulla
                    </button>
                    <button type="button" id="submitLeadButton" onclick="saveNewLead()" 
                        class="px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 transition font-semibold shadow-lg">
                        ‚úâÔ∏è Invia Richiesta
                    </button>
                </div>
            </div>
            
        </div>
    </div>

    <!-- MODAL: VIEW LEAD -->
    <div id="viewLeadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-2xl max-w-6xl w-full my-8">
            <div class="gradient-bg text-white px-6 py-4 rounded-t-lg flex justify-between items-center sticky top-0 z-10">
                <h3 class="text-xl font-bold">üëÅÔ∏è Visualizza Lead & Storico Interazioni</h3>
                <button onclick="closeModal('viewLeadModal')" class="text-white hover:text-gray-200 text-2xl">&times;</button>
            </div>
            <div class="p-6 max-h-[calc(100vh-8rem)] overflow-y-auto">
                <!-- Informazioni Lead -->
                <h4 class="text-base font-semibold text-gray-800 mb-3 border-b pb-2">üìã Informazioni Lead</h4>
                <div class="grid grid-cols-3 gap-3 mb-5">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Lead ID</label>
                        <p id="viewLeadId" class="text-gray-900 font-mono text-xs bg-gray-50 p-2 rounded">-</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Data Creazione</label>
                        <p id="viewData" class="text-gray-900 bg-gray-50 p-2 text-xs rounded">-</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Contact Manager</label>
                        <p id="viewCM" class="text-gray-900 bg-blue-50 p-2 rounded font-semibold text-xs">-</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Nome</label>
                        <p id="viewNome" class="text-gray-900 bg-gray-50 p-2 text-xs rounded">-</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Cognome</label>
                        <p id="viewCognome" class="text-gray-900 bg-gray-50 p-2 text-xs rounded">-</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Email</label>
                        <p id="viewEmail" class="text-gray-900 bg-gray-50 p-2 text-xs rounded truncate">-</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Telefono</label>
                        <p id="viewTelefono" class="text-gray-900 bg-gray-50 p-2 text-xs rounded">-</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Servizio</label>
                        <p id="viewServizio" class="text-gray-900 bg-blue-50 p-2 rounded font-semibold text-xs">-</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Piano</label>
                        <p id="viewPiano" class="text-gray-900 bg-purple-50 p-2 rounded font-semibold text-xs">-</p>
                    </div>
                    <div class="col-span-3">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Note</label>
                        <p id="viewNote" class="text-gray-900 bg-gray-50 p-2 rounded min-h-[50px] text-xs">-</p>
                    </div>
                </div>

                <!-- Storico Interazioni (SOLO LETTURA) -->
                <h4 class="text-base font-semibold text-gray-800 mb-3 border-b pb-2 mt-4">üí¨ Storico Interazioni</h4>
                <div id="interactionsList" class="mb-4 max-h-96 overflow-y-auto">
                    <p class="text-gray-500 text-xs text-center py-4">Caricamento...</p>
                </div>

                <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mb-4">
                    <p class="text-sm text-blue-800">
                        üí° <strong>Per aggiungere una nuova interazione</strong>, clicca sul bottone <strong>‚úèÔ∏è Modifica</strong> nella tabella.
                    </p>
                </div>

                <div class="flex justify-end pt-2 border-t">
                    <button onclick="closeModal('viewLeadModal')" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition text-sm">
                        Chiudi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: INTERACTIONS (Dedicated) -->
    <div id="interactionsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full my-8">
            <div class="gradient-bg text-white px-6 py-4 rounded-t-lg flex justify-between items-center sticky top-0 z-10">
                <h3 class="text-xl font-bold">üí¨ Gestione Interazioni Lead</h3>
                <button onclick="closeModal('interactionsModal')" class="text-white hover:text-gray-200 text-2xl">&times;</button>
            </div>
            <div class="p-6 max-h-[calc(100vh-8rem)] overflow-y-auto">
                <!-- Info Lead (compatta) -->
                <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mb-4 flex items-center justify-between">
                    <div>
                        <p class="font-semibold text-gray-800" id="intModalLeadName">-</p>
                        <p class="text-sm text-gray-600" id="intModalLeadContact">-</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-500">Lead ID</p>
                        <p class="font-mono text-xs font-semibold text-gray-700" id="intModalLeadId">-</p>
                    </div>
                </div>

                <!-- Storico Interazioni -->
                <h4 class="text-base font-semibold text-gray-800 mb-3 border-b pb-2">üìã Storico Interazioni</h4>
                <div id="intModalInteractionsList" class="mb-6 max-h-64 overflow-y-auto bg-gray-50 rounded-lg p-3">
                    <p class="text-gray-500 text-xs text-center py-4">Caricamento...</p>
                </div>

                <!-- Form Nuova Interazione -->
                <h4 class="text-base font-semibold text-gray-800 mb-3 border-b pb-2">‚ûï Aggiungi Nuova Interazione</h4>
                <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Interazione</label>
                            <select id="intModalTipo" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="telefono">üìû Telefono</option>
                                <option value="email">üìß Email</option>
                                <option value="whatsapp">üí¨ WhatsApp</option>
                                <option value="sms">üì± SMS</option>
                                <option value="meeting">ü§ù Meeting</option>
                                <option value="videocall">üìπ Videocall</option>
                                <option value="nota">üìù Nota</option>
                                <option value="follow-up">üîî Follow-up</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Operatore</label>
                            <select id="intModalOperatore" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="Stefania Rocca">Stefania Rocca (SR)</option>
                                <option value="Ottavia Belfa">Ottavia Belfa (OB)</option>
                                <option value="Roberto Poggi">Roberto Poggi (RP)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nota <span class="text-red-500">*</span></label>
                        <textarea id="intModalNota" rows="3" 
                                  class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  placeholder="Descrivi cosa √® successo durante il contatto..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Azione da Intraprendere</label>
                        <textarea id="intModalAzione" rows="2" 
                                  class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  placeholder="Cosa fare successivamente? (opzionale)"></textarea>
                    </div>
                    <button id="saveInteractionBtn" 
                            class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                        üíæ Salva Interazione
                    </button>
                </div>

                <div class="flex justify-end pt-4 border-t mt-4">
                    <button id="closeInteractionsModalBtn" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                        Chiudi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: EDIT LEAD -->
    <!-- editLeadModal rimosso - ora usa newLeadModal anche per edit -->

    ${l0}
</body>
</html>
`,bT=`<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="build-id" content="20260215-1012">
    <title>Data Dashboard - TeleMedCare V12.0</title>
    <!-- Build: 2026-02-15 10:12 - Filtri + Fix Conteggi Servizi -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-database text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Data Dashboard</h1>
                        <p class="text-blue-100">Centro dati completo con analytics e KPI aziendali</p>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <a href="/" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-home mr-2"></i>Home
                    </a>
                    <a href="/dashboard" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-chart-line mr-2"></i>Dashboard
                    </a>
                    <a href="/admin/leads-dashboard" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-users mr-2"></i>Leads
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- KPI Principali -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Lead Totali</p>
                        <p class="text-3xl font-bold text-blue-600" id="kpiLeads">-</p>
                    </div>
                    <i class="fas fa-users text-3xl text-blue-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Contratti</p>
                        <p class="text-3xl font-bold text-green-600" id="kpiContracts">-</p>
                    </div>
                    <i class="fas fa-file-contract text-3xl text-green-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Revenue YTD</p>
                        <p class="text-2xl font-bold text-purple-600" id="kpiRevenue">-</p>
                    </div>
                    <i class="fas fa-euro-sign text-3xl text-purple-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-orange-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Conv. Rate</p>
                        <p class="text-3xl font-bold text-orange-600" id="kpiConversion">-</p>
                    </div>
                    <i class="fas fa-percentage text-3xl text-orange-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-red-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">AOV</p>
                        <p class="text-2xl font-bold text-red-600" id="kpiAov">-</p>
                    </div>
                    <i class="fas fa-chart-line text-3xl text-red-500"></i>
                </div>
            </div>
        </div>

        <!-- Metriche Servizi -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-chart-bar text-blue-500 mr-2"></i>
                Performance per Servizio
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- FAMILY -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold text-blue-600">eCura FAMILY</h4>
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">SiDLY CARE PRO</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Lead:</span>
                            <span class="font-bold" id="familyLeads">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Contratti:</span>
                            <span class="font-bold" id="familyContracts">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Revenue:</span>
                            <span class="font-bold text-green-600" id="familyRevenue">-</span>
                        </div>
                        <div class="pt-2 border-t">
                            <div class="text-xs text-gray-500 mb-1">BASE vs AVANZATO</div>
                            <div class="flex gap-2">
                                <div class="flex-1 bg-blue-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">BASE</div>
                                    <div class="font-bold text-sm" id="familyBase">-</div>
                                </div>
                                <div class="flex-1 bg-purple-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">AVANZ.</div>
                                    <div class="font-bold text-sm" id="familyAvanzato">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PRO -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold text-purple-600">eCura PRO</h4>
                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">SiDLY CARE PRO</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Lead:</span>
                            <span class="font-bold" id="proLeads">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Contratti:</span>
                            <span class="font-bold" id="proContracts">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Revenue:</span>
                            <span class="font-bold text-green-600" id="proRevenue">-</span>
                        </div>
                        <div class="pt-2 border-t">
                            <div class="text-xs text-gray-500 mb-1">BASE vs AVANZATO</div>
                            <div class="flex gap-2">
                                <div class="flex-1 bg-blue-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">BASE</div>
                                    <div class="font-bold text-sm" id="proBase">-</div>
                                </div>
                                <div class="flex-1 bg-purple-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">AVANZ.</div>
                                    <div class="font-bold text-sm" id="proAvanzato">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PREMIUM -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold text-green-600">eCura PREMIUM</h4>
                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">SiDLY VITAL CARE</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Lead:</span>
                            <span class="font-bold" id="premiumLeads">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Contratti:</span>
                            <span class="font-bold" id="premiumContracts">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Revenue:</span>
                            <span class="font-bold text-green-600" id="premiumRevenue">-</span>
                        </div>
                        <div class="pt-2 border-t">
                            <div class="text-xs text-gray-500 mb-1">BASE vs AVANZATO</div>
                            <div class="flex gap-2">
                                <div class="flex-1 bg-blue-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">BASE</div>
                                    <div class="font-bold text-sm" id="premiumBase">-</div>
                                </div>
                                <div class="flex-1 bg-purple-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">AVANZ.</div>
                                    <div class="font-bold text-sm" id="premiumAvanzato">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contratti Recenti -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-file-contract text-green-500 mr-2"></i>
                Contratti
            </h3>
            
            <!-- Filtri Contratti -->
            <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">
                        <i class="fas fa-calendar mr-1"></i> Data Scadenza
                    </label>
                    <select id="filterScadenza" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Tutte</option>
                        <option value="expired">Scaduti</option>
                        <option value="30">Prossimi 30 giorni</option>
                        <option value="60">Prossimi 60 giorni</option>
                        <option value="90">Prossimi 90 giorni</option>
                        <option value="180">Prossimi 6 mesi</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">
                        <i class="fas fa-user mr-1"></i> Cognome Cliente
                    </label>
                    <input 
                        type="text" 
                        id="filterCognome" 
                        placeholder="Cerca per cognome..."
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">
                        <i class="fas fa-check-circle mr-1"></i> Stato
                    </label>
                    <select id="filterStato" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Tutti</option>
                        <option value="SIGNED">Firmato</option>
                        <option value="SENT">Inviato</option>
                        <option value="DRAFT">Bozza</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">
                        <i class="fas fa-mobile-alt mr-1"></i> Dispositivo
                    </label>
                    <select id="filterDispositivo" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Tutti</option>
                        <option value="SIDLY VITAL CARE">SiDLY VITAL CARE</option>
                        <option value="SIDLY CARE PRO">SiDLY CARE PRO</option>
                    </select>
                </div>
            </div>

            <!-- Contatore risultati e reset filtri -->
            <div class="mb-4 flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    <span id="contractsCount">0</span> contratti trovati
                </div>
                <button 
                    id="resetFilters" 
                    class="text-sm text-blue-600 hover:text-blue-800 font-medium"
                    onclick="resetContractFilters()"
                >
                    <i class="fas fa-redo mr-1"></i> Reset Filtri
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-200 text-left">
                            <th class="pb-3 text-sm font-semibold text-gray-600">Codice</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Cliente</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Servizio</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Piano</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Dispositivo</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Valore</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Status</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Data</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Scadenza</th>
                        </tr>
                    </thead>
                    <tbody id="contractsTable">
                        <tr>
                            <td colspan="9" class="py-8 text-center text-gray-400">
                                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                <p>Caricamento contratti...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Helper function to escape HTML special characters
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        loadDataDashboard();

        async function loadDataDashboard() {
            try {
                // Carica lead per servizio
                const leadsResponse = await fetch('/api/leads?limit=99999');
                const leadsData = await leadsResponse.json();
                const leads = leadsData.leads || [];

                // Carica contratti
                const contractsResponse = await fetch('/api/contratti?limit=99999');
                const contractsData = await contractsResponse.json();
                const allContracts = contractsData.contratti || [];
                
                // Salva TUTTI i contratti globalmente per i filtri (inclusi SENT)
                window.allContracts = allContracts;
                
                // Filtra SOLO contratti SIGNED per KPI e revenue
                const signedContracts = allContracts.filter(c => c.status === 'SIGNED');
                
                // Calcola KPI dai contratti FIRMATI
                const totalLeads = leads.length;
                const totalContracts = signedContracts.length;
                const totalRevenue = signedContracts.reduce((sum, c) => sum + (parseFloat(c.prezzo_totale) || 0), 0);
                const conversionRate = totalLeads > 0 ? ((totalContracts / totalLeads) * 100).toFixed(1) + '%' : '0%';
                const averageOrderValue = totalContracts > 0 ? (totalRevenue / totalContracts).toFixed(2) : '0';

                // Aggiorna KPI
                document.getElementById('kpiLeads').textContent = totalLeads;
                document.getElementById('kpiContracts').textContent = totalContracts;
                document.getElementById('kpiRevenue').textContent = \`‚Ç¨\${totalRevenue.toFixed(0)}\`;
                document.getElementById('kpiConversion').textContent = conversionRate;
                document.getElementById('kpiAov').textContent = \`‚Ç¨\${averageOrderValue}\`;

                // Analizza per servizio (LEADS + CONTRATTI SIGNED)
                const serviceData = analyzeByServiceWithContracts(leads, signedContracts);
                updateServiceMetrics(serviceData);

                // Mostra TUTTI i contratti nella tabella (inclusi SENT)
                renderContractsTable(allContracts);
                
                // Aggiungi event listeners per i filtri
                document.getElementById('filterScadenza').addEventListener('change', applyContractFilters);
                document.getElementById('filterCognome').addEventListener('input', applyContractFilters);
                document.getElementById('filterStato').addEventListener('change', applyContractFilters);
                document.getElementById('filterDispositivo').addEventListener('change', applyContractFilters);

            } catch (error) {
                console.error('Errore caricamento data dashboard:', error);
            }
        }

        function applyContractFilters() {
            console.log('üîç [FILTER] applyContractFilters chiamata');
            
            const filters = {
                scadenza: document.getElementById('filterScadenza').value,
                cognome: document.getElementById('filterCognome').value.toLowerCase().trim(),
                stato: document.getElementById('filterStato').value,
                dispositivo: document.getElementById('filterDispositivo').value
            };

            console.log('üîç [FILTER] Filtri attivi:', filters);

            let filtered = window.allContracts || [];
            console.log('üîç [FILTER] Contratti totali:', filtered.length);

            // Filtro cognome - supporta multiple field names
            if (filters.cognome) {
                console.log('üîç [FILTER] Applicando filtro cognome:', filters.cognome);
                filtered = filtered.filter(c => {
                    const cognome = (c.cliente_cognome || c.cognomeRichiedente || c.cognome_richiedente || '').toLowerCase();
                    const nome = (c.cliente_nome || c.nomeRichiedente || c.nome_richiedente || '').toLowerCase();
                    const fullName = \`\${nome} \${cognome}\`.toLowerCase();
                    return cognome.includes(filters.cognome) || nome.includes(filters.cognome) || fullName.includes(filters.cognome);
                });
                console.log('üîç [FILTER] Dopo filtro cognome:', filtered.length);
            }

            // Filtro stato
            if (filters.stato) {
                console.log('üîç [FILTER] Applicando filtro stato:', filters.stato);
                filtered = filtered.filter(c => c.status === filters.stato);
                console.log('üîç [FILTER] Dopo filtro stato:', filtered.length);
            }

            // Filtro dispositivo - normalizza servizio
            if (filters.dispositivo) {
                console.log('üîç [FILTER] Applicando filtro dispositivo:', filters.dispositivo);
                filtered = filtered.filter(c => {
                    const servizioNormalized = normalizeServizio(c.servizio || c.tipo_servizio);
                    const dispositivo = servizioNormalized === 'PREMIUM' ? 'SIDLY VITAL CARE' : 'SIDLY CARE PRO';
                    return dispositivo.includes(filters.dispositivo) || filters.dispositivo.includes(dispositivo);
                });
                console.log('üîç [FILTER] Dopo filtro dispositivo:', filtered.length);
            }

            // Filtro data scadenza
            if (filters.scadenza) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                console.log('üìÖ [FILTER SCADENZA] ==========================================');
                console.log('üìÖ [FILTER SCADENZA] Filtro attivo:', filters.scadenza);
                console.log('üìÖ [FILTER SCADENZA] Oggi:', today.toISOString().split('T')[0]);
                console.log('üìÖ [FILTER SCADENZA] Contratti prima del filtro:', filtered.length);
                
                // Log TUTTE le date prima di filtrare
                console.log('üìÖ [FILTER SCADENZA] Date disponibili:');
                filtered.forEach((c, idx) => {
                    console.log(\`  [\${idx}] \${c.codice_contratto || c.id}: data_scadenza = "\${c.data_scadenza}" (tipo: \${typeof c.data_scadenza})\`);
                });
                
                filtered = filtered.filter(c => {
                    if (!c.data_scadenza) {
                        console.log('‚ùå [FILTER SCADENZA] Contratto senza data_scadenza:', c.codice_contratto);
                        return false;
                    }
                    
                    // Supporta diversi formati data
                    let scadenza;
                    if (typeof c.data_scadenza === 'string') {
                        // Prova parsing diretto ISO
                        scadenza = new Date(c.data_scadenza);
                        
                        // Se fallisce, prova a parsare manualmente DD/MM/YYYY o DD-MM-YYYY
                        if (isNaN(scadenza.getTime())) {
                            const parts = c.data_scadenza.split(/[\\/\\-]/);
                            if (parts.length === 3) {
                                // Assume DD/MM/YYYY o DD-MM-YYYY
                                const day = parseInt(parts[0]);
                                const month = parseInt(parts[1]) - 1;  // Month is 0-indexed
                                const year = parseInt(parts[2]);
                                scadenza = new Date(year, month, day);
                                console.log(\`üîÑ [FILTER SCADENZA] Parsed manualmente: "\${c.data_scadenza}" ‚Üí \${scadenza.toISOString().split('T')[0]}\`);
                            }
                        }
                    } else if (c.data_scadenza instanceof Date) {
                        scadenza = c.data_scadenza;
                    } else {
                        console.warn('‚ö†Ô∏è [FILTER SCADENZA] Formato data non riconosciuto:', c.data_scadenza, 'contratto:', c.codice_contratto);
                        return false;
                    }
                    
                    if (isNaN(scadenza.getTime())) {
                        console.warn('‚ö†Ô∏è [FILTER SCADENZA] Data invalida:', c.data_scadenza, 'contratto:', c.codice_contratto);
                        return false;
                    }
                    
                    scadenza.setHours(0, 0, 0, 0);
                    const diffTime = scadenza - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    let match = false;
                    if (filters.scadenza === 'expired') {
                        match = diffDays < 0;
                    } else {
                        const days = parseInt(filters.scadenza);
                        match = diffDays >= 0 && diffDays <= days;
                    }

                    console.log(\`\${match ? '‚úÖ' : '‚ùå'} [FILTER SCADENZA] \${c.codice_contratto}: scadenza=\${scadenza.toISOString().split('T')[0]}, giorni=\${diffDays}, match=\${match}\`);
                    return match;
                });
                
                console.log('üìÖ [FILTER SCADENZA] Contratti dopo filtro:', filtered.length);
                console.log('üìÖ [FILTER SCADENZA] ==========================================');
            }

            console.log('üéØ [FILTER] RENDERING', filtered.length, 'contratti');
            renderContractsTable(filtered);
        }

        function resetContractFilters() {
            document.getElementById('filterScadenza').value = '';
            document.getElementById('filterCognome').value = '';
            document.getElementById('filterStato').value = '';
            document.getElementById('filterDispositivo').value = '';
            renderContractsTable(window.allContracts || []);
        }

        function normalizeServizio(servizio) {
            if (!servizio) return null;
            const s = servizio.toUpperCase();
            if (s.includes('FAMILY')) return 'FAMILY';
            if (s.includes('PRO') && !s.includes('PREMIUM')) return 'PRO';
            if (s.includes('PREMIUM')) return 'PREMIUM';
            return null;
        }

        function analyzeByServiceWithContracts(leads, contracts) {
            const data = {
                FAMILY: { leads: 0, contracts: 0, base: 0, avanzato: 0, revenue: 0 },
                PRO: { leads: 0, contracts: 0, base: 0, avanzato: 0, revenue: 0 },
                PREMIUM: { leads: 0, contracts: 0, base: 0, avanzato: 0, revenue: 0 }
            };

            // Conta i lead per servizio
            leads.forEach(lead => {
                const servizioNormalized = normalizeServizio(lead.servizio);
                if (servizioNormalized && data[servizioNormalized]) {
                    data[servizioNormalized].leads++;
                }
            });

            // Conta i contratti per servizio
            contracts.forEach(contract => {
                const servizioNormalized = normalizeServizio(contract.servizio || contract.tipo_servizio);
                const piano = (contract.piano || contract.tipo_contratto || 'BASE').toUpperCase();
                const prezzo = parseFloat(contract.prezzo_totale) || 0;
                
                if (servizioNormalized && data[servizioNormalized]) {
                    data[servizioNormalized].contracts++;
                    data[servizioNormalized].revenue += prezzo;
                    
                    if (piano.includes('BASE')) {
                        data[servizioNormalized].base++;
                    } else if (piano.includes('AVANZATO')) {
                        data[servizioNormalized].avanzato++;
                    } else {
                        // Default to BASE if unknown
                        data[servizioNormalized].base++;
                    }
                }
            });

            return data;
        }

        function analyzeByService(leads) {
            const data = {
                FAMILY: { leads: 0, base: 0, avanzato: 0, revenue: 0 },
                PRO: { leads: 0, base: 0, avanzato: 0, revenue: 0 },
                PREMIUM: { leads: 0, base: 0, avanzato: 0, revenue: 0 }
            };

            const prezzi = {
                'FAMILY': { 'BASE': 390, 'AVANZATO': 690 },
                'PRO': { 'BASE': 480, 'AVANZATO': 840 },
                'PREMIUM': { 'BASE': 590, 'AVANZATO': 990 }
            };

            leads.forEach(lead => {
                const servizioNormalized = normalizeServizio(lead.servizio);
                const piano = lead.pacchetto || 'BASE';
                
                if (servizioNormalized && data[servizioNormalized]) {
                    data[servizioNormalized].leads++;
                    
                    if (piano === 'BASE') {
                        data[servizioNormalized].base++;
                    } else {
                        data[servizioNormalized].avanzato++;
                    }

                    if (lead.contratto_inviato && prezzi[servizioNormalized]?.[piano]) {
                        data[servizioNormalized].revenue += prezzi[servizioNormalized][piano];
                    }
                }
            });

            return data;
        }

        function updateServiceMetrics(data) {
            // FAMILY
            document.getElementById('familyLeads').textContent = data.FAMILY.leads;
            document.getElementById('familyContracts').textContent = data.FAMILY.contracts || (data.FAMILY.base + data.FAMILY.avanzato);
            document.getElementById('familyRevenue').textContent = \`‚Ç¨\${data.FAMILY.revenue.toFixed(0)}\`;
            document.getElementById('familyBase').textContent = data.FAMILY.base;
            document.getElementById('familyAvanzato').textContent = data.FAMILY.avanzato;

            // PRO
            document.getElementById('proLeads').textContent = data.PRO.leads;
            document.getElementById('proContracts').textContent = data.PRO.contracts || (data.PRO.base + data.PRO.avanzato);
            document.getElementById('proRevenue').textContent = \`‚Ç¨\${data.PRO.revenue.toFixed(0)}\`;
            document.getElementById('proBase').textContent = data.PRO.base;
            document.getElementById('proAvanzato').textContent = data.PRO.avanzato;

            // PREMIUM
            document.getElementById('premiumLeads').textContent = data.PREMIUM.leads;
            document.getElementById('premiumContracts').textContent = data.PREMIUM.contracts || (data.PREMIUM.base + data.PREMIUM.avanzato);
            document.getElementById('premiumRevenue').textContent = \`‚Ç¨\${data.PREMIUM.revenue.toFixed(0)}\`;
            document.getElementById('premiumBase').textContent = data.PREMIUM.base;
            document.getElementById('premiumAvanzato').textContent = data.PREMIUM.avanzato;
        }

        function renderContractsTable(contracts) {
            const tbody = document.getElementById('contractsTable');
            const countElement = document.getElementById('contractsCount');
            
            // Aggiorna contatore
            countElement.textContent = contracts.length;
            
            if (contracts.length === 0) {
                tbody.innerHTML = \`
                    <tr>
                        <td colspan="9" class="py-8 text-center text-gray-400">Nessun contratto trovato</td>
                    </tr>
                \`;
                return;
            }

            tbody.innerHTML = contracts.map(contract => {
                // Fix: usa normalizeServizio per mappare dispositivo corretto
                const servizioNormalized = normalizeServizio(contract.servizio || contract.tipo_servizio);
                const dispositivo = servizioNormalized === 'PREMIUM' ? 'SiDLY VITAL CARE' : 
                                   servizioNormalized ? 'SiDLY CARE PRO' : 'N/A';
                
                const date = new Date(contract.created_at).toLocaleDateString('it-IT');
                
                // Data scadenza con evidenziazione
                let scadenzaHtml = '<span class="text-gray-400 text-xs">N/A</span>';
                
                // Debug: log data_scadenza
                if (contract.codice_contratto) {
                    console.log(\`üìÖ [RENDER] \${contract.codice_contratto}: data_scadenza = "\${contract.data_scadenza}" (tipo: \${typeof contract.data_scadenza})\`);
                }
                
                if (contract.data_scadenza) {
                    try {
                        const scadenza = new Date(contract.data_scadenza);
                        
                        if (!isNaN(scadenza.getTime())) {
                            const today = new Date();
                            const diffTime = scadenza - today;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            
                            let colorClass = 'text-gray-600';
                            let icon = '';
                            
                            if (diffDays < 0) {
                                colorClass = 'text-red-600 font-bold';
                                icon = '<i class="fas fa-exclamation-triangle mr-1"></i>';
                            } else if (diffDays <= 30) {
                                colorClass = 'text-orange-600 font-semibold';
                                icon = '<i class="fas fa-clock mr-1"></i>';
                            } else if (diffDays <= 90) {
                                colorClass = 'text-yellow-600';
                                icon = '<i class="fas fa-calendar-check mr-1"></i>';
                            }
                            
                            scadenzaHtml = \`<span class="\${colorClass} text-xs">\${icon}\${scadenza.toLocaleDateString('it-IT')}</span>\`;
                        } else {
                            console.warn(\`‚ö†Ô∏è [RENDER] Data scadenza invalida per \${contract.codice_contratto}: \${contract.data_scadenza}\`);
                        }
                    } catch (e) {
                        console.error(\`‚ùå [RENDER] Errore parsing data per \${contract.codice_contratto}:\`, e);
                    }
                }
                
                return \`
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 text-xs">
                            <code class="bg-gray-100 px-2 py-1 rounded">\${contract.codice_contratto || contract.id}</code>
                        </td>
                        <td class="py-3 text-sm font-medium">
                            \${escapeHtml(contract.cliente_nome)} \${escapeHtml(contract.cliente_cognome)}
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded font-medium">
                                \${contract.servizio || contract.tipo_servizio || 'N/A'}
                            </span>
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded font-medium">
                                \${contract.piano || 'N/A'}
                            </span>
                        </td>
                        <td class="py-3 text-sm text-gray-600">\${dispositivo}</td>
                        <td class="py-3 text-sm font-bold text-green-600">
                            ‚Ç¨\${parseFloat(contract.prezzo_totale || 0).toFixed(2)}
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded font-medium">
                                \${contract.status || 'SENT'}
                            </span>
                        </td>
                        <td class="py-3 text-xs text-gray-500">\${date}</td>
                        <td class="py-3">\${scadenzaHtml}</td>
                    </tr>
                \`;
            }).join('');
        }

        function getDispositivoForService(servizio) {
            const dispositivi = {
                'FAMILY': 'SiDLY CARE PRO',
                'PRO': 'SiDLY CARE PRO',
                'PREMIUM': 'SiDLY VITAL CARE'
            };
            return dispositivi[servizio] || 'N/A';
        }
    <\/script>
</body>
</html>
`,yT=`<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Manager - TeleMedCare V12.0</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .step-active { border-color: #10b981; background: #d1fae5; }
        .step-pending { border-color: #fbbf24; background: #fef3c7; }
        .step-completed { border-color: #3b82f6; background: #dbeafe; }
        .modal { display: none; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-diagram-project text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Workflow Manager</h1>
                        <p class="text-red-100">Gestione completa ciclo Lead ‚Üí Attivazione</p>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <a href="/" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-home mr-2"></i>Home
                    </a>
                    <button onclick="refreshWorkflows()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-sync-alt mr-2"></i>Aggiorna
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 xl:px-12 py-8" style="max-width: 1600px;">
        <!-- Workflow Steps Overview -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-sitemap text-red-500 mr-2"></i>
                Stati Workflow TeleMedCare
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                <div onclick="openArchive('leads')" class="border-2 border-blue-200 bg-blue-50 p-4 rounded-lg text-center cursor-pointer hover:shadow-lg transition-all">
                    <i class="fas fa-user-plus text-3xl text-blue-600 mb-2"></i>
                    <h4 class="font-bold text-sm text-gray-800">1. Lead</h4>
                    <p class="text-xs text-gray-600 mt-1">Acquisizione contatto</p>
                </div>
                <div onclick="openArchive('contratti')" class="border-2 border-green-200 bg-green-50 p-4 rounded-lg text-center cursor-pointer hover:shadow-lg transition-all">
                    <i class="fas fa-file-contract text-3xl text-green-600 mb-2"></i>
                    <h4 class="font-bold text-sm text-gray-800">2. Contratto</h4>
                    <p class="text-xs text-gray-600 mt-1">Generazione PDF</p>
                </div>
                <div onclick="openArchive('firme')" class="border-2 border-purple-200 bg-purple-50 p-4 rounded-lg text-center cursor-pointer hover:shadow-lg transition-all">
                    <i class="fas fa-signature text-3xl text-purple-600 mb-2"></i>
                    <h4 class="font-bold text-sm text-gray-800">3. Firma</h4>
                    <p class="text-xs text-gray-600 mt-1">Firma elettronica</p>
                </div>
                <div onclick="openArchive('proforma')" class="border-2 border-yellow-200 bg-yellow-50 p-4 rounded-lg text-center cursor-pointer hover:shadow-lg transition-all">
                    <i class="fas fa-file-invoice text-3xl text-yellow-600 mb-2"></i>
                    <h4 class="font-bold text-sm text-gray-800">4. Proforma</h4>
                    <p class="text-xs text-gray-600 mt-1">Generazione fattura</p>
                </div>
                <div onclick="openArchive('pagamenti')" class="border-2 border-orange-200 bg-orange-50 p-4 rounded-lg text-center cursor-pointer hover:shadow-lg transition-all">
                    <i class="fas fa-credit-card text-3xl text-orange-600 mb-2"></i>
                    <h4 class="font-bold text-sm text-gray-800">5. Pagamento</h4>
                    <p class="text-xs text-gray-600 mt-1">Conferma bonifico</p>
                </div>
                <div onclick="openArchive('attivi')" class="border-2 border-indigo-200 bg-indigo-50 p-4 rounded-lg text-center cursor-pointer hover:shadow-lg transition-all">
                    <i class="fas fa-check-circle text-3xl text-indigo-600 mb-2"></i>
                    <h4 class="font-bold text-sm text-gray-800">6. Attivazione</h4>
                    <p class="text-xs text-gray-600 mt-1">Servizio attivo</p>
                </div>
            </div>
        </div>

        <!-- Lead in Progress -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-tasks text-orange-500 mr-2"></i>
                    Lead in Lavorazione
                </h3>
                <div class="flex space-x-2">
                    <select id="filterStatus" class="border border-gray-300 rounded-lg px-3 py-2 text-sm" onchange="applyFilters()">
                        <option value="">Tutti gli stati</option>
                        <option value="NEW">Nuovo</option>
                        <option value="CONTRACT_SENT">Contratto Inviato</option>
                        <option value="CONTRACT_SIGNED">Contratto Firmato</option>
                        <option value="PROFORMA_SENT">Proforma Inviata</option>
                        <option value="PAID">Pagato</option>
                        <option value="ACTIVE">Attivo</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-200 text-left">
                            <th class="pb-3 text-sm font-semibold text-gray-600">Lead ID</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Cliente</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Email</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Telefono</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Servizio</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Stato</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Step Corrente</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Data</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="workflowTable">
                        <tr>
                            <td colspan="9" class="py-8 text-center text-gray-400">
                                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                <p>Caricamento workflow...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Manual Actions -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Firma Manuale -->
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl shadow-md p-6 border-2 border-purple-200">
                <h4 class="text-lg font-bold text-purple-800 mb-4 flex items-center">
                    <i class="fas fa-signature text-2xl mr-3"></i>
                    Firma Manuale Contratto
                </h4>
                <p class="text-sm text-gray-700 mb-4">
                    Usa questa funzione quando il contratto viene firmato manualmente (cartaceo) e vuoi registrarlo nel sistema.
                </p>
                <button onclick="openSignModal()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg transition-colors">
                    <i class="fas fa-pen mr-2"></i>Registra Firma Manuale
                </button>
            </div>

            <!-- Pagamento Manuale -->
            <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl shadow-md p-6 border-2 border-orange-200">
                <h4 class="text-lg font-bold text-orange-800 mb-4 flex items-center">
                    <i class="fas fa-money-check text-2xl mr-3"></i>
                    Pagamento Manuale Bonifico
                </h4>
                <p class="text-sm text-gray-700 mb-4">
                    Registra un pagamento ricevuto tramite bonifico bancario per procedere con l'attivazione del servizio.
                </p>
                <button onclick="openPaymentModal()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 rounded-lg transition-colors">
                    <i class="fas fa-university mr-2"></i>Registra Pagamento Bonifico
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Firma Manuale -->
    <div id="signModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
            <div class="bg-purple-600 text-white p-6 rounded-t-xl">
                <h3 class="text-xl font-bold flex items-center">
                    <i class="fas fa-signature mr-3"></i>
                    Registra Firma Manuale
                </h3>
            </div>
            <form id="signForm" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Lead/Contratto ID *</label>
                        <input type="text" id="signContractId" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                            placeholder="LEAD_xxx o CTR_xxx">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Firma Digitale</label>
                        <input type="text" id="signDigital"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                            placeholder="Nome Cognome (manuale)">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Note</label>
                        <textarea id="signNotes" rows="3"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                            placeholder="Es: Contratto firmato in sede il gg/mm/aaaa"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex space-x-3">
                    <button type="button" onclick="closeSignModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 rounded-lg transition-colors">
                        Annulla
                    </button>
                    <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg transition-colors">
                        <i class="fas fa-check mr-2"></i>Conferma
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Pagamento Manuale -->
    <div id="paymentModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
            <div class="bg-orange-600 text-white p-6 rounded-t-xl">
                <h3 class="text-xl font-bold flex items-center">
                    <i class="fas fa-money-check mr-3"></i>
                    Registra Pagamento Bonifico
                </h3>
            </div>
            <form id="paymentForm" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Proforma ID *</label>
                        <input type="text" id="paymentProformaId" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none"
                            placeholder="PRF_xxx">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Importo (‚Ç¨) *</label>
                        <input type="number" id="paymentAmount" required step="0.01"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none"
                            placeholder="480.00">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Transaction ID / CRO</label>
                        <input type="text" id="paymentTransactionId"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none"
                            placeholder="TRN123456 o CRO">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Note</label>
                        <textarea id="paymentNotes" rows="3"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none"
                            placeholder="Es: Bonifico ricevuto il gg/mm/aaaa"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex space-x-3">
                    <button type="button" onclick="closePaymentModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 rounded-lg transition-colors">
                        Annulla
                    </button>
                    <button type="submit" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 rounded-lg transition-colors">
                        <i class="fas fa-check mr-2"></i>Conferma
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allLeads = [];
        let isLoading = false; // Previene chiamate multiple simultanee
        
        // Helper: escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Helper: escape quotes for strings in JS
        function escapeQuotes(str) {
            return String(str || '').replace(/"/g, '\\"').replace(/'/g, "\\'");
        }

        window.loadWorkflows = async function() {
            // Previeni chiamate multiple simultanee
            if (isLoading) {
                console.log('Caricamento gi√† in corso, skip...');
                return;
            }
            
            isLoading = true;
            
            try {
                const response = await fetch('/api/leads?limit=100');
                const data = await response.json();
                allLeads = data.leads || [];
                renderWorkflowTable(allLeads);
            } catch (error) {
                console.error('Errore caricamento workflow:', error);
                document.getElementById('workflowTable').innerHTML = \`
                    <tr>
                        <td colspan="8" class="py-8 text-center text-red-500">
                            <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                            <p>Errore nel caricamento dei workflow</p>
                        </td>
                    </tr>
                \`;
            } finally {
                isLoading = false;
            }
        }

        function renderWorkflowTable(leads) {
            const tbody = document.getElementById('workflowTable');
            
            if (leads.length === 0) {
                tbody.innerHTML = \`
                    <tr>
                        <td colspan="8" class="py-8 text-center text-gray-400">Nessun workflow in corso</td>
                    </tr>
                \`;
                return;
            }

            tbody.innerHTML = leads.map(lead => {
                const status = getWorkflowStatus(lead);
                const step = getWorkflowStep(lead);
                const date = new Date(lead.created_at).toLocaleString('it-IT');
                
                // Mostra servizio cos√¨ com'√® dal DB
                const servizio = lead.servizio || lead.tipoServizio || 'eCura PRO';
                
                return \`
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 text-xs">
                            <code class="bg-gray-100 px-2 py-1 rounded">\${(lead.id || '').substring(0, 25)}</code>
                        </td>
                        <td class="py-3 text-sm">
                            <div class="font-medium">\${escapeHtml(lead.nomeRichiedente)} \${escapeHtml(lead.cognomeRichiedente)}</div>
                        </td>
                        <td class="py-3 text-sm">
                            <div class="text-xs text-gray-600">
                                <i class="fas fa-envelope text-gray-400 mr-1"></i>\${lead.email || lead.email || '-'}
                            </div>
                        </td>
                        <td class="py-3 text-sm">
                            <div class="flex items-center text-gray-700">
                                <i class="fas fa-phone text-xs mr-1 text-gray-400"></i>
                                <span class="text-xs">\${lead.telefono || '-'}</span>
                            </div>
                        </td>
                        <td class="py-3 text-sm">
                            <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded font-medium">
                                \${servizio}
                            </span>
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 \${status.class} text-xs rounded font-medium">
                                \${status.text}
                            </span>
                        </td>
                        <td class="py-3 text-sm">
                            <div class="flex items-center">
                                <i class="\${step.icon} \${step.color} mr-2"></i>
                                <span class="text-xs">\${step.text}</span>
                            </div>
                        </td>
                        <td class="py-3 text-xs text-gray-500">\${date}</td>
                        <td class="py-3">
                            <div class="flex space-x-1">
                                <button onclick="quickAction('\${escapeHtml(lead.id)}', 'view')" 
                                    class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded" 
                                    title="Visualizza Dettagli">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="quickAction('\${escapeHtml(lead.id)}', 'payment')" 
                                    class="px-2 py-1 bg-orange-500 hover:bg-orange-600 text-white text-xs rounded" 
                                    title="Registra Pagamento">
                                    <i class="fas fa-euro-sign"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                \`;
            }).join('');
        }

        function getWorkflowStatus(lead) {
            // Determina stato workflow con tutti gli stati
            const status = lead.status?.toUpperCase();
            
            if (status === 'CONVERTED') {
                return { class: 'bg-green-100 text-green-700', text: 'CONVERTITO' };
            } else if (status === 'CONTRACT_SIGNED') {
                return { class: 'bg-green-100 text-green-700', text: 'CONTRATTO FIRMATO' };
            } else if (status === 'CONTRACT_SENT') {
                return { class: 'bg-blue-100 text-blue-700', text: 'CONTRATTO INVIATO' };
            } else if (status === 'ACTIVE') {
                return { class: 'bg-green-100 text-green-700', text: 'ATTIVO' };
            } else if (lead.contratto_inviato) {
                return { class: 'bg-blue-100 text-blue-700', text: 'CONTRATTO INVIATO' };
            } else if (status === 'NEW' || status === 'NUOVO') {
                return { class: 'bg-yellow-100 text-yellow-700', text: 'NUOVO' };
            } else {
                return { class: 'bg-gray-100 text-gray-700', text: status || 'NUOVO' };
            }
        }

        function getWorkflowStep(lead) {
            // Determina step corrente
            if (lead.status === 'ACTIVE') {
                return { icon: 'fas fa-check-circle', color: 'text-green-600', text: '6. Attivato' };
            } else if (lead.payment_confirmed) {
                return { icon: 'fas fa-credit-card', color: 'text-orange-600', text: '5. Pagamento OK' };
            } else if (lead.proforma_sent) {
                return { icon: 'fas fa-file-invoice', color: 'text-yellow-600', text: '4. Proforma Inviata' };
            } else if (lead.contract_signed) {
                return { icon: 'fas fa-signature', color: 'text-purple-600', text: '3. Contratto Firmato' };
            } else if (lead.contratto_inviato) {
                return { icon: 'fas fa-file-contract', color: 'text-blue-600', text: '2. Contratto Inviato' };
            } else {
                return { icon: 'fas fa-user-plus', color: 'text-gray-600', text: '1. Lead Nuovo' };
            }
        }

        function applyFilters() {
            const statusFilter = document.getElementById('filterStatus').value;
            const filtered = allLeads.filter(lead => {
                if (!statusFilter) return true;
                return getWorkflowStatus(lead).text === statusFilter;
            });
            renderWorkflowTable(filtered);
        }

        function refreshWorkflows() {
            window.loadWorkflows();
        }

        function viewWorkflowDetails(leadId) {
            alert('Dettagli workflow per Lead: ' + leadId + '\\n\\nFunzionalit√† in sviluppo...');
        }

        // Open Archive - Click sui box workflow per aprire archivi completi
        async function openArchive(type) {
            try {
                let url = '';
                let title = '';
                
                switch(type) {
                    case 'leads':
                        url = '/api/leads?limit=1000';
                        title = 'üìã ARCHIVIO COMPLETO LEADS';
                        break;
                    case 'contratti':
                        url = '/api/contratti?limit=1000';
                        title = 'üìÑ ARCHIVIO COMPLETO CONTRATTI';
                        break;
                    case 'firme':
                        url = '/api/signatures?limit=1000';
                        title = '‚úçÔ∏è ARCHIVIO FIRME ELETTRONICHE';
                        break;
                    case 'proforma':
                        url = '/api/proforma?limit=1000';
                        title = 'üìã ARCHIVIO PROFORMA/FATTURE';
                        break;
                    case 'pagamenti':
                        url = '/api/payments?limit=1000';
                        title = 'üí∞ ARCHIVIO PAGAMENTI';
                        break;
                    case 'attivi':
                        url = '/api/leads?status=ACTIVE&limit=1000';
                        title = '‚úÖ SERVIZI ATTIVI';
                        break;
                    default:
                        alert('‚ö†Ô∏è Archivio non riconosciuto');
                        return;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                // Estrai l'array corretto in base al tipo
                let items = [];
                if (type === 'leads') items = data.leads || [];
                else if (type === 'contratti') items = data.contratti || [];
                else if (type === 'firme') items = data.signatures || [];
                else if (type === 'proforma') items = data.proforma || [];
                else if (type === 'pagamenti') items = data.payments || [];
                else if (type === 'attivi') items = data.leads || [];
                
                // Crea messaggio riepilogo
                let message = \`\${title}\\n\\nTotale: \${items.length} record\\n\\n\`;
                
                if (items.length === 0) {
                    message += 'Nessun record trovato.';
                } else if (items.length <= 10) {
                    // Mostra tutti i record se <= 10
                    items.forEach((item, idx) => {
                        if (type === 'leads') {
                            message += \`\${idx+1}. \${escapeHtml(item.nomeRichiedente)} \${escapeHtml(item.cognomeRichiedente)} - \${item.email || 'N/A'}\\n\`;
                        } else if (type === 'contratti') {
                            message += \`\${idx+1}. \${item.codice_contratto || item.id} - \${escapeHtml(item.cliente_nome)} \${escapeHtml(item.cliente_cognome)}\\n\`;
                        } else if (type === 'firme') {
                            message += \`\${idx+1}. Firma \${item.id} - Contratto: \${item.contract_id}\\n\`;
                        } else if (type === 'proforma') {
                            message += \`\${idx+1}. Proforma \${item.numero || item.id} - ‚Ç¨\${item.importo || '0'}\\n\`;
                        } else if (type === 'pagamenti') {
                            message += \`\${idx+1}. Pagamento \${item.id} - ‚Ç¨\${item.importo || '0'} - \${item.metodo_pagamento || 'N/A'}\\n\`;
                        } else {
                            message += \`\${idx+1}. \${escapeHtml(item.nomeRichiedente)} \${escapeHtml(item.cognomeRichiedente)} - ATTIVO\\n\`;
                        }
                    });
                } else {
                    // Mostra solo primi 10 + conteggio
                    message += 'Primi 10 record:\\n\\n';
                    items.slice(0, 10).forEach((item, idx) => {
                        if (type === 'leads' || type === 'attivi') {
                            const status = item.status || 'NUOVO';
                            const statusText = status === 'ACTIVE' ? '‚úÖ ATTIVO' : 
                                             status === 'CONVERTED' ? '‚úì CONVERTITO' :
                                             status === 'CONTRACT_SIGNED' ? '‚úçÔ∏è FIRMATO' : 'üÜï NUOVO';
                            message += \`\${idx+1}. \${escapeHtml(item.nomeRichiedente)} \${escapeHtml(item.cognomeRichiedente)} - \${statusText}\\n\`;
                        } else if (type === 'contratti') {
                            message += \`\${idx+1}. \${escapeHtml(item.cliente_nome)} \${escapeHtml(item.cliente_cognome)}\\n\`;
                        } else {
                            message += \`\${idx+1}. ID: \${item.id}\\n\`;
                        }
                    });
                    message += \`\\n... e altri \${items.length - 10} record.\\n\`;
                    message += \`\\nüí° Per visualizzare tutti i dati, vai alla dashboard specifica o usa l'API.\`;
                }
                
                alert(message);
                
            } catch (error) {
                console.error('Errore apertura archivio:', error);
                alert('‚ùå Errore nel caricamento archivio.\\n\\n' + error.message);
            }
        }
        window.openArchive = openArchive;  // Esponi globalmente

        // Quick Actions per ogni riga della tabella
        function quickAction(leadId, action) {
            const lead = allLeads.find(l => l.id === leadId);
            if (!lead) {
                alert('‚ùå Lead non trovato');
                return;
            }
            
            switch(action) {
                case 'view':
                    // Mostra dettagli completi del lead
                    const piano = lead.piano || ((lead.note && lead.note.includes('Piano: AVANZATO')) ? 'AVANZATO' : 'BASE');
                    const prezzo = lead.prezzo_anno ? String(lead.prezzo_anno) : '0';
                    
                    // Mostra servizio cosi come dal DB
                    const servizio = lead.servizio || lead.tipoServizio || 'eCura PRO';
                    
                    alert('üë§ LEAD: ' + (lead.nomeRichiedente || '') + ' ' + (lead.cognomeRichiedente || '') + '\\n\\n' +
                    'üìß Email: ' + (lead.email || 'N/A') + '\\n' +
                    'üìû Telefono: ' + (lead.telefono || 'N/A') + '\\n' +
                    'üè• Servizio: ' + servizio + '\\n' +
                    'üìã Piano: ' + piano + ' (' + prezzo + '/anno)' + '\\n' +
                    'üìÖ Creato: ' + new Date(lead.created_at).toLocaleDateString('it-IT') + '\\n' +
                    'üìç Stato: ' + getWorkflowStatus(lead).text + '\\n' +
                    'üîÑ Step: ' + getWorkflowStep(lead).text + '\\n\\n' +
                    'üìù Note: ' + (lead.note || 'Nessuna nota'));
                    break;
                    
                case 'contract':
                    // Pre-compila modale firma contratto
                    const nomeCompleto = escapeQuotes((lead.nomeRichiedente || '') + ' ' + (lead.cognomeRichiedente || ''));
                    const emailSafe = escapeQuotes(lead.email || '');
                    if (confirm(\`üìù Vuoi registrare la firma del contratto per:\\n\\nüë§ \${nomeCompleto}\\nüìß \${emailSafe}\\n\\n‚úÖ Procedi?\`)) {
                        document.getElementById('signContractId').value = lead.id;
                        document.getElementById('signDigital').value = nomeCompleto;
                        openSignModal();
                    }
                    break;
                    
                case 'payment':
                    // Pre-compila modale pagamento
                    const nomeCompletoPayment = escapeQuotes((lead.nomeRichiedente || '') + ' ' + (lead.cognomeRichiedente || ''));
                    const emailSafePayment = escapeQuotes(lead.email || '');
                    if (confirm(\`üí∞ Vuoi registrare il pagamento per:\\n\\nüë§ \${nomeCompletoPayment}\\nüìß \${emailSafePayment}\\n\\n‚úÖ Procedi?\`)) {
                        // Cerca proforma associata al lead
                        fetch('/api/proforma?lead_id=' + lead.id)
                            .then(res => res.json())
                            .then(data => {
                                if (data.proforma && data.proforma.length > 0) {
                                    const proforma = data.proforma[0];
                                    document.getElementById('paymentProformaId').value = proforma.id;
                                    document.getElementById('paymentAmount').value = proforma.importo;
                                    openPaymentModal();
                                } else {
                                    alert('‚ö†Ô∏è Nessuna proforma trovata per questo lead.\\n\\nCrea prima una proforma tramite la dashboard contratti.');
                                }
                            })
                            .catch(err => {
                                console.error('Errore caricamento proforma:', err);
                                alert('‚ùå Errore nel caricamento della proforma.\\n\\nInserisci manualmente i dati.');
                                openPaymentModal();
                            });
                    }
                    break;
                    
                default:
                    alert('‚ö†Ô∏è Azione non riconosciuta');
            }
        }

        // Modal functions
        function openSignModal() {
            document.getElementById('signModal').classList.add('active');
        }

        function closeSignModal() {
            document.getElementById('signModal').classList.remove('active');
            document.getElementById('signForm').reset();
        }

        function openPaymentModal() {
            document.getElementById('paymentModal').classList.add('active');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
            document.getElementById('paymentForm').reset();
        }

        // Form submissions (usa once: true per evitare listener multipli)
        const signForm = document.getElementById('signForm');
        if (signForm && !signForm.dataset.listenerAdded) {
            signForm.dataset.listenerAdded = 'true';
            signForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const contractId = document.getElementById('signContractId').value;
                const firmaDigitale = document.getElementById('signDigital').value || 'Firma Manuale';
                const notes = document.getElementById('signNotes').value;
                
                try {
                    const response = await fetch('/api/contracts/sign', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contractId,
                            firmaDigitale: firmaDigitale + (notes ? \` - \${notes}\` : ''),
                            ipAddress: 'MANUAL_SIGNATURE',
                            userAgent: 'Workflow Manager Dashboard'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('‚úÖ Firma registrata con successo!\\n\\nProforma generata e inviata.');
                        closeSignModal();
                        refreshWorkflows();
                    } else {
                        alert('‚ùå Errore: ' + result.error);
                    }
                } catch (error) {
                    alert('‚ùå Errore di comunicazione: ' + error.message);
                }
            });
        }

        const paymentForm = document.getElementById('paymentForm');
        if (paymentForm && !paymentForm.dataset.listenerAdded) {
            paymentForm.dataset.listenerAdded = 'true';
            paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const proformaId = document.getElementById('paymentProformaId').value;
            const importo = parseFloat(document.getElementById('paymentAmount').value);
            const transactionId = document.getElementById('paymentTransactionId').value || 'MANUAL_PAYMENT';
            const notes = document.getElementById('paymentNotes').value;
            
            try {
                const response = await fetch('/api/payments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        proformaId,
                        importo,
                        metodoPagamento: 'bonifico_bancario',
                        transactionId: transactionId + (notes ? \` - \${notes}\` : ''),
                        manual: true
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Pagamento registrato con successo!\\n\\nProcedura di attivazione avviata.');
                    closePaymentModal();
                    refreshWorkflows();
                } else {
                    alert('‚ùå Errore: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Errore di comunicazione: ' + error.message);
            }
        });
        }

        // ============================================
        // SETTINGS: SWITCH ON/OFF - LOAD SETTINGS
        // ============================================
        
        window.loadSettings = async function() {
            try {
                console.log('üì• [SETTINGS] Caricamento settings dal database...');
                const response = await fetch('/api/settings');
                const data = await response.json();
                
                console.log('üì• [SETTINGS] Response:', data);
                
                if (data.success && data.settings) {
                    const settings = data.settings;
                    
                    // Update select states - tutti e 4 i settings
                    if (settings.hubspot_auto_import_enabled) {
                        const value = settings.hubspot_auto_import_enabled.value;
                        console.log('‚úÖ [SETTINGS] HubSpot:', value);
                        document.getElementById('selectHubspotAuto').value = value;
                    }
                    if (settings.lead_email_notifications_enabled) {
                        const value = settings.lead_email_notifications_enabled.value;
                        console.log('‚úÖ [SETTINGS] Lead Emails:', value);
                        document.getElementById('selectLeadEmails').value = value;
                    }
                    if (settings.admin_email_notifications_enabled) {
                        const value = settings.admin_email_notifications_enabled.value;
                        console.log('‚úÖ [SETTINGS] Admin Emails:', value);
                        document.getElementById('selectAdminEmails').value = value;
                    }
                    if (settings.reminder_completion_enabled) {
                        const value = settings.reminder_completion_enabled.value;
                        console.log('‚úÖ [SETTINGS] Reminder:', value);
                        document.getElementById('selectReminderCompletion').value = value;
                    }
                    
                    console.log('‚úÖ [SETTINGS] Tutti e 4 gli switch caricati correttamente');
                } else {
                    console.error('‚ùå [SETTINGS] Risposta API non valida:', data);
                }
            } catch (error) {
                console.error('‚ùå [SETTINGS] Errore caricamento settings:', error);
            }
        }
        
        // Nota: window.updateSetting √® gi√† definita inline dopo gli switch HTML

        // Load workflows on page load (chiamata dopo tutte le definizioni)
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ [DASHBOARD] DOM Loaded - Inizializzazione...');
            window.loadWorkflows();
            window.loadSettings(); // Carica gli switch dal DB
            console.log('‚úÖ [DASHBOARD] Inizializzazione completata');
        });
    <\/script>
</body>
</html>
`;function TT(t,o,e){return`
    <!DOCTYPE html>
    <html><head><title>Contratto TeleMedCare ${o}</title></head>
    <body>
      <h1>CONTRATTO DI SERVIZIO TELEMEDCARE ${o}</h1>
      <h2>DATI CONTRAENTE</h2>
      <p><strong>Nome:</strong> ${t.nomeRichiedente} ${t.cognomeRichiedente}</p>
      <p><strong>Email:</strong> ${t.email}</p>
      <p><strong>Telefono:</strong> ${t.telefono||"Non specificato"}</p>
      
      <h2>SERVIZIO RICHIESTO</h2>
      <p><strong>Tipo:</strong> TeleMedCare ${o}</p>
      <p><strong>Durata:</strong> ${e.durata} mesi</p>
      <p><strong>Costo mensile:</strong> ‚Ç¨${e.mensile}</p>
      <p><strong>Costo totale:</strong> ‚Ç¨${e.totale}</p>
      
      <h2>CONDIZIONI</h2>
      <p>Il presente contratto regolamenta l'erogazione del servizio di telemedicina...</p>
      
      <div class="firma-section" style="margin-top: 50px; border: 1px solid #ccc; padding: 20px;">
        <h3>FIRMA ELETTRONICA</h3>
        <p>Firma qui sotto per accettare i termini del contratto:</p>
        <canvas id="signature-pad" width="400" height="200" style="border: 1px solid #000;"></canvas>
        <br><button onclick="firmaContratto()">Conferma Firma</button>
      </div>
      
      <script>
        function firmaContratto() {
          const canvas = document.getElementById('signature-pad');
          const firmaData = canvas.toDataURL();
          
          fetch('/api/contracts/sign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contractId: '${t.contractId||"CURRENT_CONTRACT"}',
              firmaDigitale: firmaData,
              ipAddress: 'auto-detect',
              userAgent: navigator.userAgent
            })
          }).then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Contratto firmato con successo!');
              window.location.href = '/grazie-firma';
            } else {
              alert('Errore nella firma: ' + data.error);
            }
          });
        }
      <\/script>
    </body>
    </html>
  `}async function wT(t,o){try{const e=await o.prepare(`
      SELECT c.*, l.nomeRichiedente, l.cognomeRichiedente, l.email, l.telefono
      FROM contracts c
      LEFT JOIN leads l ON c.leadId = l.id
      WHERE c.id = ? AND c.status = 'SIGNED'
    `).bind(t).first();if(!e)return{success:!1,error:"Contratto firmato non trovato"};const a=`PROFORMA_${Date.now()}_${Math.random().toString(36).substring(7)}`,i=`PF-${new Date().getFullYear()}-${String(Date.now()).slice(-6)}`,r=new Date(Date.now()+360*60*60*1e3);return await o.prepare(`
      INSERT INTO proforma (
        id, contract_id, leadId, numero_proforma, data_emissione, data_scadenza,
        cliente_nome, cliente_cognome, cliente_email, cliente_telefono,
        tipo_servizio, prezzo_mensile, durata_mesi, prezzo_totale, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(a,t,e.leadId,i,new Date().toISOString(),r.toISOString(),e.nomeRichiedente,e.cognomeRichiedente,e.email,e.telefono,e.tipo_contratto,e.prezzo_mensile,e.durata_mesi,e.prezzo_totale,"DRAFT").run(),{success:!0,proformaId:a,numeroProforma:i,message:"Proforma generata automaticamente"}}catch(e){return{success:!1,error:e.message}}}async function IT(t,o){try{console.log(`üìß INVIO REALE proforma ${t.numero_proforma} a ${t.email}`);const a=(await Promise.resolve().then(()=>At)).default.getInstance(),i={NOME_CLIENTE:t.cliente_nome||"Cliente",PIANO_SERVIZIO:t.servizio||"TeleMedCare",IMPORTO_TOTALE:`‚Ç¨${t.importo_totale}`,SCADENZA_PAGAMENTO:t.data_scadenza||"Da concordare",CODICE_CLIENTE:t.numero_proforma||t.id||"N/A"},r=await a.sendTemplateEmail("INVIO_PROFORMA",t.email,i,void 0,o);return console.log("‚úÖ Email proforma risultato:",r),r}catch(e){return console.error("‚ùå Errore invio email proforma:",e),{success:!1,error:e.message}}}async function ST(t,o,e){try{console.log(`üìß Invio landing page personalizzata a ${t} (${o}) da fonte ${e}`),console.log("Template: email_landing_page_personalizzata");const a=`${e}_${Date.now()}_${Math.random().toString(36).substring(7)}`,i=`https://telemedcare.it/landing?source=${e}&track=${a}&nome=${encodeURIComponent(o)}`;return{success:!0,messageId:`msg_${Date.now()}`,template:"email_landing_page_personalizzata",landingUrl:i}}catch(a){return{success:!1,error:a.message}}}function AT(t){const o=(t||"").toLowerCase(),e=o.includes("avanzat")?"AVANZATO":"BASE";let a="PRO";o.includes("family")?a="FAMILY":o.includes("premium")&&(a="PREMIUM");const i=Nc(a,e);return{servizio:a,piano:e,prezzoAnno:(i==null?void 0:i.setupTotale)||0,prezzoRinnovo:(i==null?void 0:i.rinnovoTotale)||0}}const I=new Ng;let Gm=!1;I.use("*",async(t,o)=>{var e,a,i,r,s,l,d,c;if(!Gm&&((e=t.env)!=null&&e.DB))try{console.log("üîÑ Avvio migrazione automatica database...");try{await t.env.DB.prepare("ALTER TABLE assistiti ADD COLUMN servizio TEXT DEFAULT 'eCura PRO'").run(),console.log("‚úÖ Colonna servizio aggiunta")}catch(u){(a=u.message)!=null&&a.includes("duplicate column")||console.warn("‚ö†Ô∏è Errore colonna servizio:",u.message)}try{await t.env.DB.prepare("ALTER TABLE assistiti ADD COLUMN piano TEXT DEFAULT 'BASE'").run(),console.log("‚úÖ Colonna piano aggiunta")}catch(u){(i=u.message)!=null&&i.includes("duplicate column")||console.warn("‚ö†Ô∏è Errore colonna piano:",u.message)}try{await t.env.DB.prepare("ALTER TABLE contracts ADD COLUMN servizio TEXT DEFAULT 'eCura PRO'").run(),console.log("‚úÖ Colonna servizio aggiunta a contracts")}catch(u){(r=u.message)!=null&&r.includes("duplicate column")||console.warn("‚ö†Ô∏è Errore colonna servizio contracts:",u.message)}try{await t.env.DB.prepare("ALTER TABLE leads ADD COLUMN prezzo_anno REAL DEFAULT 0").run(),console.log("‚úÖ Colonna prezzo_anno aggiunta a leads")}catch(u){(s=u.message)!=null&&s.includes("duplicate column")||console.warn("‚ö†Ô∏è Errore colonna prezzo_anno leads:",u.message)}try{await t.env.DB.prepare("ALTER TABLE leads ADD COLUMN prezzo_rinnovo REAL DEFAULT 0").run(),console.log("‚úÖ Colonna prezzo_rinnovo aggiunta a leads")}catch(u){(l=u.message)!=null&&l.includes("duplicate column")||console.warn("‚ö†Ô∏è Errore colonna prezzo_rinnovo leads:",u.message)}try{await t.env.DB.prepare("ALTER TABLE leads ADD COLUMN cm TEXT DEFAULT NULL").run(),console.log("‚úÖ Colonna cm (Contact Manager) aggiunta a leads")}catch(u){(d=u.message)!=null&&d.includes("duplicate column")||console.warn("‚ö†Ô∏è Errore colonna cm leads:",u.message)}try{await t.env.DB.prepare("ALTER TABLE leads ADD COLUMN stato TEXT DEFAULT NULL").run(),console.log("‚úÖ Colonna stato aggiunta a leads")}catch(u){(c=u.message)!=null&&c.includes("duplicate column")||console.warn("‚ö†Ô∏è Errore colonna stato leads:",u.message)}try{await t.env.DB.prepare(`
          CREATE TABLE IF NOT EXISTS lead_interactions (
            id TEXT PRIMARY KEY,
            lead_id TEXT NOT NULL,
            data TEXT NOT NULL,
            tipo TEXT NOT NULL,
            nota TEXT,
            azione TEXT,
            operatore TEXT,
            created_at TEXT NOT NULL,
            FOREIGN KEY (lead_id) REFERENCES leads(id) ON DELETE CASCADE
          )
        `).run(),console.log("‚úÖ Tabella lead_interactions creata")}catch(u){console.warn("‚ö†Ô∏è Errore creazione tabella lead_interactions:",u.message)}try{const u=await t.env.DB.prepare(`
          UPDATE assistiti 
          SET servizio = 'eCura PRO', piano = 'AVANZATO'
          WHERE (nome_assistito LIKE '%Eileen%' AND cognome_assistito LIKE '%King%')
             OR (nome_caregiver LIKE '%Elena%' AND cognome_caregiver LIKE '%Saglia%')
        `).run();u.changes&&u.changes>0&&console.log(`‚úÖ Eileen aggiornata a eCura PRO AVANZATO (${u.changes} record)`)}catch(u){console.warn("‚ö†Ô∏è Errore aggiornamento Eileen:",u.message)}Gm=!0,console.log("‚úÖ Migrazione automatica completata")}catch(u){console.error("‚ùå Errore migrazione automatica:",u)}await o()});I.use("/api/*",nv());I.use("/assets/*",Up({root:"./"}));I.use("/documents/*",Up({root:"./"}));I.use("/*.html",async(t,o)=>(t.header("Cache-Control","no-store, no-cache, must-revalidate, proxy-revalidate"),t.header("Pragma","no-cache"),t.header("Expires","0"),Up({root:"./"})(t,o)));I.get("/brochures/:filename",async t=>{var e;const o=t.req.param("filename");try{if((e=t.env)!=null&&e.ASSETS){console.log(`üì• Richiesta brochure: ${o} via ASSETS binding`);const a=new URL(`/brochures/${o}`,t.req.url),i=await t.env.ASSETS.fetch(a);if(i.ok)return console.log(`‚úÖ Brochure trovata: ${o}`),new Response(i.body,{status:200,headers:{"Content-Type":"application/pdf","Content-Disposition":`inline; filename="${o}"`,"Cache-Control":"public, max-age=31536000"}});console.error(`‚ùå ASSETS non trova: /brochures/${o} (status: ${i.status})`)}else console.warn(`‚ö†Ô∏è ASSETS binding non disponibile per ${o}`);return console.log(`üîÑ Fallback: tentativo lettura locale per ${o}`),t.text(`Brochure non disponibile: ${o}. Assicurati che il file esista in public/brochures/`,404)}catch(a){return console.error(`‚ùå Errore servizio brochure ${o}:`,a),t.text(`Errore interno: ${a instanceof Error?a.message:String(a)}`,500)}});I.get("/form-lead",t=>t.html(`
<!DOCTYPE html>
<html lang="it" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleMedCare V12.0 Modular Enterprise - Sistema di Telemedicina Avanzato</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      * {
        font-family: 'Inter', sans-serif;
      }

      .gradient-hero {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
      }

      .card-hover {
        transition: all 0.3s ease;
      }

      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      .badge-popular {
        background: linear-gradient(45deg, #f59e0b, #f97316);
        color: white;
        font-weight: bold;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        position: absolute;
        top: -10px;
        right: 20px;
      }

      .tech-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 2rem;
        color: white;
        transition: all 0.3s ease;
      }

      .tech-icon:hover {
        transform: scale(1.1);
      }

      .icon-fall {
        background: linear-gradient(45deg, #ef4444, #f87171);
      }
      .icon-gps {
        background: linear-gradient(45deg, #10b981, #34d399);
      }
      .icon-heart {
        background: linear-gradient(45deg, #ec4899, #f472b6);
      }
      .icon-sos {
        background: linear-gradient(45deg, #f59e0b, #fbbf24);
      }
      .icon-voice {
        background: linear-gradient(45deg, #8b5cf6, #a78bfa);
      }
      .icon-pill {
        background: linear-gradient(45deg, #06b6d4, #22d3ee);
      }

      .price-card {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        position: relative;
        border: 2px solid #e5e7eb;
        transition: all 0.3s ease;
      }

      .price-card:hover {
        border-color: #3b82f6;
        box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
      }

      .price-popular {
        border-color: #f59e0b;
        background: linear-gradient(to bottom, #fffbeb, white);
      }

      .btn-primary {
        background: linear-gradient(45deg, #3b82f6, #1d4ed8);
        color: white;
        padding: 0.75rem 2rem;
        border-radius: 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.8);
        padding: 0.75rem 2rem;
        border-radius: 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        cursor: pointer;
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border-color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .form-section {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      }

      .benefits-section {
        background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
      }

      .contact-gradient {
        background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .animate-fade-in {
        animation: fadeIn 0.3s ease-out;
      }

      .message-alert {
        transition: all 0.3s ease;
      }

      .message-alert:hover {
        transform: scale(1.02);
      }
    </style>
</head>
<body class="bg-white">

    <!-- Header -->
    <header class="bg-white shadow-md fixed w-full top-0 z-50">
      <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
        <div class="flex items-center">
          <h1 class="text-2xl font-bold text-blue-600">TeleMedCare</h1>
          <span class="ml-2 text-sm text-gray-600">Medica GB</span>
        </div>
        <div class="hidden md:flex space-x-6">
          <a href="#servizi" class="text-gray-700 hover:text-blue-600">Servizi</a>
          <a href="#tecnologia" class="text-gray-700 hover:text-blue-600">Tecnologia</a>
          <a href="#prezzi" class="text-gray-700 hover:text-blue-600">Prezzi</a>
          <a href="#contatti" class="text-gray-700 hover:text-blue-600">Contatti</a>
        </div>
      </nav>
    </header>

    <!-- Enterprise System Banner -->
    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-2">
      <div class="container mx-auto px-4 text-center">
        <span class="text-sm font-semibold">
           TeleMedCare V12.0 Modular Enterprise System  
          AI-Powered Lead Management  
          Multi-Partner Integration  
          Advanced Analytics
        </span>
      </div>
    </div>

    <!-- Hero Section -->
    <section class="gradient-hero text-white pt-24 pb-16">
      <div class="container mx-auto px-4 text-center">
        <h2 class="text-5xl md:text-6xl font-bold mb-6">La tecnologia che ti salva salute e vita</h2>
        <p class="text-xl md:text-2xl mb-8 max-w-4xl mx-auto">
          Servizi innovativi di TeleAssistenza e TeleMonitoraggio con dispositivo medico certificato SiDLY. Assistenza
          H24 direttamente dove c'√® necessit√†.
        </p>
        <div class="flex flex-col md:flex-row gap-4 justify-center">
          <button onclick="document.getElementById('form-richiesta').scrollIntoView({behavior: 'smooth'})" class="btn-primary">
            <i class="fas fa-envelope mr-2"></i>Richiedi Informazioni
          </button>
          <button onclick="document.getElementById('servizi').scrollIntoView({behavior: 'smooth'})" class="btn-secondary">
            <i class="fas fa-search mr-2"></i>Scopri i Servizi
          </button>
        </div>
      </div>
    </section>

    <!-- Chi Siamo -->
    <section class="py-16 bg-gray-50">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-bold text-gray-800 mb-4">Innovazione Socio-Sanitaria</h2>
          <p class="text-xl text-gray-600 max-w-3xl mx-auto">
            Medica GB S.r.l. nasce nel 2022 come startup innovativa a vocazione sociale, con l'obiettivo di
            rivoluzionare l'assistenza sanitaria attraverso tecnologie avanzate.
          </p>
        </div>
        <div class="max-w-4xl mx-auto text-center">
          <h3 class="text-2xl font-semibold text-blue-600 mb-4">Startup Innovativa a Vocazione Sociale</h3>
          <p class="text-lg text-gray-700">
            Eroghiamo servizi di TeleAssistenza, TeleMonitoraggio, Riabilitazione, Diagnostica e Assistenza Sanitaria
            direttamente dove c'√® necessit√†, cambiando il paradigma tradizionale.
          </p>
        </div>
      </div>
    </section>

    <!-- Servizi -->
    <section id="servizi" class="py-16">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-bold text-gray-800 mb-4">I Nostri Servizi</h2>
          <p class="text-xl text-gray-600">Soluzioni di TeleAssistenza personalizzate per ogni esigenza</p>
        </div>

        <div class="grid md:grid-cols-2 gap-8 max-w-6xl mx-auto">
          <!-- Servizio Base -->
          <div class="price-card card-hover">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">TeleAssistenza Base</h3>
            <p class="text-gray-600 mb-6">
              Soluzione completa con dispositivo medico SiDLY, monitoraggio automatico e comunicazione con i familiari.
            </p>

            <ul class="space-y-3 mb-6">
              <li class="flex items-center">
                <i class="fas fa-check text-green-500 mr-3"></i>Dispositivo Medicale Certificato
              </li>
              <li class="flex items-center">
                <i class="fas fa-check text-green-500 mr-3"></i>Rilevamento Automatico Cadute
              </li>
              <li class="flex items-center"><i class="fas fa-check text-green-500 mr-3"></i>GPS e Geolocalizzazione</li>
              <li class="flex items-center">
                <i class="fas fa-check text-green-500 mr-3"></i>Monitoraggio Parametri Vitali
              </li>
              <li class="flex items-center">
                <i class="fas fa-check text-green-500 mr-3"></i>Comunicazione Bidirezionale
              </li>
              <li class="flex items-center"><i class="fas fa-check text-green-500 mr-3"></i>Pulsante SOS</li>
              <li class="flex items-center"><i class="fas fa-check text-green-500 mr-3"></i>Promemoria Farmaci</li>
              <li class="flex items-center"><i class="fas fa-check text-green-500 mr-3"></i>Supporto Familiare</li>
            </ul>
          </div>

          <!-- Servizio Avanzato -->
          <div class="price-card price-popular card-hover relative">
            <div class="badge-popular">PI√ô SCELTO</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">TeleAssistenza Avanzata</h3>
            <p class="text-gray-600 mb-6">
              Tutto il pacchetto Base pi√π il supporto della Centrale Operativa H24 per 7 giorni su 7.
            </p>

            <ul class="space-y-3 mb-6">
              <li class="flex items-center">
                <i class="fas fa-check text-green-500 mr-3"></i>Tutti i servizi del Piano Base
              </li>
              <li class="flex items-center"><i class="fas fa-star text-amber-500 mr-3"></i>Centrale Operativa H24</li>
              <li class="flex items-center">
                <i class="fas fa-star text-amber-500 mr-3"></i>Supporto Professionale Continuo
              </li>
              <li class="flex items-center"><i class="fas fa-star text-amber-500 mr-3"></i>Intervento Immediato H24</li>
              <li class="flex items-center">
                <i class="fas fa-star text-amber-500 mr-3"></i>Monitoraggio Parametri Vitali Avanzato
              </li>
              <li class="flex items-center">
                <i class="fas fa-star text-amber-500 mr-3"></i>Assistenza Specializzata
              </li>
              <li class="flex items-center"><i class="fas fa-star text-amber-500 mr-3"></i>Coordinamento Emergenze</li>
              <li class="flex items-center">
                <i class="fas fa-star text-amber-500 mr-3"></i>Report Periodici
              </li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Tecnologia SiDLY -->
    <section id="tecnologia" class="py-16 bg-gray-50">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-bold text-gray-800 mb-4">Tecnologia SiDLY</h2>
          <p class="text-xl text-gray-600">
            Dispositivo medico certificato Classe IIa con funzionalit√† avanzate per la tua sicurezza
          </p>
        </div>

        <div class="grid md:grid-cols-3 lg:grid-cols-6 gap-8 max-w-6xl mx-auto">
          <div class="text-center">
            <div class="tech-icon icon-fall">
              <i class="fas fa-person-falling"></i>
            </div>
            <h4 class="font-semibold text-gray-800 mb-2">Rilevamento Automatico Cadute</h4>
            <p class="text-sm text-gray-600">
              Notifica automatica ai familiari e alla Centrale Operativa in caso di caduta o perdita di coscienza
            </p>
          </div>

          <div class="text-center">
            <div class="tech-icon icon-voice">
              <i class="fas fa-phone-volume"></i>
            </div>
            <h4 class="font-semibold text-gray-800 mb-2">Comunicazione Bidirezionale</h4>
            <p class="text-sm text-gray-600">
              Comunicazione vocale diretta con familiari e operatori attraverso la piattaforma
            </p>
          </div>

          <div class="text-center">
            <div class="tech-icon icon-gps">
              <i class="fas fa-map-marker-alt"></i>
            </div>
            <h4 class="font-semibold text-gray-800 mb-2">Geolocalizzazione GPS</h4>
            <p class="text-sm text-gray-600">Localizzazione precisa e configurazione di aree sicure (geo-fencing)</p>
          </div>

          <div class="text-center">
            <div class="tech-icon icon-heart">
              <i class="fas fa-heartbeat"></i>
            </div>
            <h4 class="font-semibold text-gray-800 mb-2">Monitoraggio Parametri Vitali</h4>
            <p class="text-sm text-gray-600">Frequenza cardiaca e saturazione ossigeno con soglie personalizzabili</p>
          </div>

          <div class="text-center">
            <div class="tech-icon icon-sos">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h4 class="font-semibold text-gray-800 mb-2">Pulsante SOS</h4>
            <p class="text-sm text-gray-600">Invio immediato di emergenza geolocalizzata ai contatti configurati</p>
          </div>

          <div class="text-center">
            <div class="tech-icon icon-pill">
              <i class="fas fa-pills"></i>
            </div>
            <h4 class="font-semibold text-gray-800 mb-2">Promemoria Farmaci</h4>
            <p class="text-sm text-gray-600">
              Messaggi vocali per l'aderenza terapeutica e assunzione corretta dei medicinali
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Prezzi -->
    <section id="prezzi" class="py-16">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-bold text-gray-800 mb-4">Prezzi</h2>
          <p class="text-xl text-gray-600">Scegli la soluzione pi√π adatta alle tue esigenze</p>
        </div>

        <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
          <!-- Piano Base -->
          <div class="price-card card-hover text-center">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Servizio Base</h3>
            <div class="mb-6">
              <div class="text-3xl font-bold text-blue-600">480 ‚Ç¨ + IVA</div>
              <div class="text-gray-600">Primo Anno</div>
              <div class="text-2xl font-bold text-green-600 mt-2">240 ‚Ç¨ + IVA</div>
              <div class="text-gray-600">Rinnovo</div>
            </div>
            <button onclick="document.getElementById('form-richiesta').scrollIntoView({behavior: 'smooth'})" class="btn-primary w-full">
              Richiedi Informazioni
            </button>
          </div>

          <!-- Piano Avanzato -->
          <div class="price-card price-popular card-hover text-center relative">
            <div class="badge-popular">PI√ô SCELTO</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Servizio Avanzato</h3>
            <div class="mb-6">
              <div class="text-3xl font-bold text-blue-600">840 ‚Ç¨ + IVA</div>
              <div class="text-gray-600">Primo Anno</div>
              <div class="text-2xl font-bold text-green-600 mt-2">600 ‚Ç¨ + IVA</div>
              <div class="text-gray-600">Rinnovo</div>
            </div>
            <button onclick="document.getElementById('form-richiesta').scrollIntoView({behavior: 'smooth'})" class="btn-primary w-full">
              Richiedi Informazioni
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Benefici Fiscali -->
    <section class="benefits-section py-16">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-bold text-gray-800 mb-4">Benefici Fiscali e Rimborsi</h2>
          <p class="text-xl text-gray-600">Approfitta delle agevolazioni disponibili</p>
        </div>

        <div class="grid md:grid-cols-2 gap-8 max-w-6xl mx-auto">
          <!-- Detrazione 730 -->
          <div class="bg-white rounded-xl p-6 shadow-lg card-hover">
            <div class="flex items-center mb-4">
              <i class="fas fa-file-invoice text-3xl text-green-600 mr-4"></i>
              <h3 class="text-xl font-bold text-gray-800">Detrazione Fiscale 730</h3>
            </div>
            <p class="text-gray-700 mb-4">
              I servizi di TeleAssistenza sono detraibili come <strong>spese sanitarie</strong> nella dichiarazione dei
              redditi modello 730.
            </p>
            <ul class="space-y-2 text-gray-600">
              <li class="flex items-start">
                <i class="fas fa-check text-green-500 mr-2 mt-1"></i>Detrazione del 19% sulla spesa sostenuta
              </li>
              <li class="flex items-start">
                <i class="fas fa-check text-green-500 mr-2 mt-1"></i>Valido per spese sanitarie certificate
              </li>
              <li class="flex items-start">
                <i class="fas fa-check text-green-500 mr-2 mt-1"></i>Risparmio fiscale fino a 159,60 ‚Ç¨ annui (piano
                Avanzato)
              </li>
            </ul>
          </div>

          <!-- Rimborsi INPS -->
          <div class="bg-white rounded-xl p-6 shadow-lg card-hover">
            <div class="flex items-center mb-4">
              <i class="fas fa-landmark text-3xl text-blue-600 mr-4"></i>
              <h3 class="text-xl font-bold text-gray-800">Rimborsi INPS</h3>
            </div>
            <p class="text-gray-700 mb-4">
              Possibilit√† di rimborso per categorie specifiche con requisiti particolari.
            </p>
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
              <p class="text-blue-800 font-semibold">Requisiti necessari (cumulativi):</p>
            </div>
            <ul class="space-y-2 text-gray-600">
              <li class="flex items-start">
                <i class="fas fa-euro-sign text-blue-500 mr-2 mt-1"></i>ISEE inferiore a ‚Ç¨ 6.000
              </li>
              <li class="flex items-start">
                <i class="fas fa-certificate text-blue-500 mr-2 mt-1"></i>Gi√† titolari della Legge 104
              </li>
              <li class="flex items-start">
                <i class="fas fa-file-medical text-blue-500 mr-2 mt-1"></i>Motivazioni sanitarie giustificate
              </li>
              <li class="flex items-start">
                <i class="fas fa-info-circle text-blue-500 mr-2 mt-1"></i>Valutazione caso per caso da parte INPS
              </li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Form Richiesta -->
    <section id="form-richiesta" class="form-section py-16">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-bold text-gray-800 mb-4">Richiedi Informazioni</h2>
          <p class="text-xl text-gray-600">Compila il form per ricevere una consulenza gratuita personalizzata</p>
        </div>

        <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8">
          <form id="leadForm" class="space-y-6">
            <!-- Dati Richiedente -->
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <label class="block text-gray-700 font-semibold mb-2">Nome *</label>
                <input type="text" name="nomeRichiedente" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-gray-700 font-semibold mb-2">Cognome *</label>
                <input type="text" name="cognomeRichiedente" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <label class="block text-gray-700 font-semibold mb-2">Email *</label>
                <input type="email" name="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-gray-700 font-semibold mb-2">Telefono *</label>
                <input type="tel" name="telefono" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>

            <!-- Dati Persona da Assistere -->
            <div class="border-t pt-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">Dati Persona da Assistere</h3>

              <div class="grid md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-gray-700 font-semibold mb-2">Nome Assistito *</label>
                  <input type="text" name="nomeAssistito" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                  <label class="block text-gray-700 font-semibold mb-2">Cognome Assistito *</label>
                  <input type="text" name="cognomeAssistito" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
              </div>

              <div class="grid md:grid-cols-2 gap-6 mt-6">
                <div>
                  <label class="block text-gray-700 font-semibold mb-2">Data di Nascita Assistito *</label>
                  <!-- Campi Data User-Friendly con Auto-Navigate -->
                  <div class="flex space-x-2">
                    <div class="flex-1">
                      <input 
                        type="number" 
                        name="giornoNascita" 
                        id="giorno_nascita" 
                        placeholder="GG" 
                        min="1" 
                        max="31" 
                        maxlength="2"
                        required 
                        class="w-full px-3 py-3 text-center border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        oninput="autoNavigateDate(this, 'mese_nascita', 2)"
                        onchange="validaEAggiornaSiData()"
                      >
                      <label class="text-xs text-gray-500 block text-center mt-1">Giorno</label>
                    </div>
                    <div class="flex-1">
                      <input 
                        type="number" 
                        name="meseNascita" 
                        id="mese_nascita" 
                        placeholder="MM" 
                        min="1" 
                        max="12" 
                        maxlength="2"
                        required 
                        class="w-full px-3 py-3 text-center border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        oninput="autoNavigateDate(this, 'anno_nascita', 2)"
                        onchange="validaEAggiornaSiData()"
                      >
                      <label class="text-xs text-gray-500 block text-center mt-1">Mese</label>
                    </div>
                    <div class="flex-1">
                      <input 
                        type="number" 
                        name="annoNascita" 
                        id="anno_nascita" 
                        placeholder="AAAA" 
                        min="1920" 
                        max="2024" 
                        maxlength="4"
                        required 
                        class="w-full px-3 py-3 text-center border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        oninput="autoNavigateDate(this, null, 4)"
                        onchange="validaEAggiornaSiData()"
                      >
                      <label class="text-xs text-gray-500 block text-center mt-1">Anno</label>
                    </div>
                  </div>
                  <!-- Campo hidden per compatibilit√† con l'API esistente -->
                  <input type="hidden" name="dataNascitaAssistito" id="data_nascita_assistito">
                </div>
                <div>
                  <label class="block text-gray-700 font-semibold mb-2">Luogo di Nascita Assistito *</label>
                  <input type="text" name="luogoNascitaAssistito" required placeholder="Es. Roma, Milano, Napoli..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
              </div>

              <div class="grid md:grid-cols-2 gap-6 mt-6">
                <div>
                  <label class="block text-gray-700 font-semibold mb-2">Et√† (calcolata automaticamente)</label>
                  <input type="text" name="etaAssistito" id="eta_assistito" readonly class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100">
                </div>
                <div>
                  <label class="block text-gray-700 font-semibold mb-2">Relazione con l'assistito</label>
                  <select name="parentelaAssistito" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Seleziona relazione</option>
                    <option value="figlio">Figlio/a</option>
                    <option value="coniuge">Coniuge</option>
                    <option value="genitore">Genitore</option>
                    <option value="fratello">Fratello/Sorella</option>
                    <option value="parente">Altro parente</option>
                    <option value="badante">Badante/Caregiver</option>
                    <option value="assistito">Sono l'assistito stesso</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Servizio -->
            <div>
              <label class="block text-gray-700 font-semibold mb-2">Servizio di Interesse</label>
              <select name="pacchetto" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleziona servizio</option>
                <option value="Base">TeleAssistenza Base (480‚Ç¨+IVA primo anno)</option>
                <option value="Avanzato">TeleAssistenza Avanzata (840‚Ç¨+IVA primo anno)</option>
                <option value="Da definire">Non sono sicuro, vorrei informazioni</option>
              </select>
            </div>

            <!-- Condizioni Mediche -->
            <div>
              <label class="block text-gray-700 font-semibold mb-2">Condizioni mediche particolari o esigenze specifiche</label>
              <textarea name="condizioniSalute" rows="3" placeholder="Descrivi eventuali patologie, disabilit√† o esigenze particolari..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>

            <!-- Urgenza -->
            <div>
              <label class="block text-gray-700 font-semibold mb-2">Urgenza della richiesta</label>
              <select name="priority" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleziona urgenza</option>
                <option value="Urgente">Immediata (entro 24 ore)</option>
                <option value="Alta">Alta (entro 3 giorni)</option>
                <option value="Media">Media (entro una settimana)</option>
                <option value="Normale">Bassa (quando possibile)</option>
              </select>
            </div>

            <!-- Preferenza Contatto -->
            <div>
              <label class="block text-gray-700 font-semibold mb-2">Come preferisci essere ricontattato?</label>
              <div class="grid md:grid-cols-3 gap-4">
                <label class="flex items-center">
                  <input type="radio" name="preferenzaContatto" value="Email" class="mr-2">
                  <i class="fas fa-envelope text-blue-600 mr-2"></i>Email
                </label>
                <label class="flex items-center">
                  <input type="radio" name="preferenzaContatto" value="Telefono" class="mr-2">
                  <i class="fas fa-phone text-green-600 mr-2"></i>Telefono
                </label>
                <label class="flex items-center">
                  <input type="radio" name="preferenzaContatto" value="WhatsApp" class="mr-2">
                  <i class="fab fa-whatsapp text-green-600 mr-2"></i>WhatsApp
                </label>
              </div>
            </div>

            <!-- Richieste Aggiuntive -->
            <div class="space-y-4">
              <div>
                <label class="flex items-center">
                  <input type="checkbox" name="vuoleContratto" id="vuole_contratto" onchange="toggleIntestazioneContratto()" class="mr-3">
                  <span class="text-gray-700">Vuoi ricevere copia del contratto da visionare?</span>
                </label>
              </div>

              <!-- Intestazione Contratto (condizionata) -->
              <div id="intestazione_contratto_section" class="hidden">
                <label class="block text-gray-700 font-semibold mb-2">A chi deve essere intestato il contratto?</label>
                <div class="flex space-x-4">
                  <label class="flex items-center">
                    <input type="radio" name="intestazioneContratto" value="richiedente" onchange="toggleCampiDinamici()" class="mr-2">
                    <span class="text-gray-700">Richiedente</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="intestazioneContratto" value="assistito" onchange="toggleCampiDinamici()" class="mr-2">
                    <span class="text-gray-700">Assistito</span>
                  </label>
                </div>

                <!-- Campi Dinamici per Richiedente -->
                <div id="campi_richiedente" style="display: none;" class="space-y-4 mt-4">
                  <div>
                    <label class="block text-gray-700 font-semibold mb-2">Codice Fiscale Richiedente</label>
                    <input type="text" name="cfIntestatario" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Inserisci il Codice Fiscale del Richiedente">
                  </div>
                  <div>
                    <label class="block text-gray-700 font-semibold mb-2">Indirizzo Richiedente</label>
                    <textarea name="indirizzoIntestatario" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Inserisci l'indirizzo completo del Richiedente"></textarea>
                  </div>
                </div>

                <!-- Campi Dinamici per Assistito -->
                <div id="campi_assistito" style="display: none;" class="space-y-4 mt-4">
                  <div>
                    <label class="block text-gray-700 font-semibold mb-2">Codice Fiscale Assistito</label>
                    <input type="text" name="cfAssistito" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Inserisci il Codice Fiscale dell'Assistito">
                  </div>
                  <div>
                    <label class="block text-gray-700 font-semibold mb-2">Indirizzo Assistito</label>
                    <textarea name="indirizzoAssistito" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Inserisci l'indirizzo completo dell'Assistito"></textarea>
                  </div>
                </div>
              </div>

              <div>
                <label class="flex items-center">
                  <input type="checkbox" name="vuoleBrochure" class="mr-3">
                  <span class="text-gray-700">Vuoi che ti inviamo la brochure di SiDLY Care Pro?</span>
                </label>
              </div>

              <div>
                <label class="flex items-center">
                  <input type="checkbox" name="vuoleManuale" class="mr-3">
                  <span class="text-gray-700">Vuoi ricevere il manuale d'uso del dispositivo?</span>
                </label>
              </div>


            </div>

            <!-- Messaggio -->
            <div>
              <label class="block text-gray-700 font-semibold mb-2">Messaggio aggiuntivo</label>
              <textarea name="note" rows="4" placeholder="Aggiungi eventuali domande o informazioni aggiuntive..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>

            <!-- GDPR -->
            <div>
              <label class="flex items-start">
                <input type="checkbox" name="gdprConsent" required class="mr-3 mt-1">
                <span class="text-gray-700 text-sm">Acconsento al trattamento dei dati personali secondo il GDPR per le finalit√† indicate nell'informativa privacy. *</span>
              </label>
            </div>

            <!-- Submit -->
            <div class="text-center">
              <button type="submit" class="btn-primary text-lg px-8 py-4">
                <i class="fas fa-paper-plane mr-2"></i>Invia Richiesta
              </button>
              <p class="text-gray-600 mt-4">Ti ricontatteremo entro 24 ore lavorative</p>
            </div>
          </form>

          <!-- Messaggi di successo/errore -->
          <div id="message_container" class="hidden mt-6">
            <div id="success_message" class="hidden bg-green-100 border border-green-400 text-green-700 px-6 py-4 rounded-lg shadow-md animate-fade-in">
              <div class="flex items-center">
                <i class="fas fa-check-circle text-2xl mr-3"></i>
                <strong class="text-lg">‚úÖ Successo!</strong>
              </div>
              <span class="block mt-1">La tua richiesta √® stata elaborata dal sistema TeleMedCare V12.0. Riceverai conferma via email con i documenti richiesti!</span>
            </div>
            <div id="error_message" class="hidden bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-lg shadow-md animate-fade-in">
              <div class="flex items-center">
                <i class="fas fa-exclamation-circle text-2xl mr-3"></i>
                <strong class="text-lg">‚ùå Errore!</strong>
              </div>
              <span class="block mt-1">Si √® verificato un errore nell'invio. Per favore contattaci direttamente al +39 331 643 2390</span>
            </div>
            <div id="loading_message" class="hidden bg-blue-100 border border-blue-400 text-blue-700 px-6 py-4 rounded-lg shadow-md">
              <div class="flex items-center">
                <i class="fas fa-spinner fa-spin text-2xl mr-3"></i>
                <strong class="text-lg">üîÑ Invio in corso...</strong>
              </div>
              <span class="block mt-1">Stiamo elaborando la tua richiesta con il sistema TeleMedCare V12.0, attendi un momento.</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Contatti -->
    <section id="contatti" class="contact-gradient text-white py-16">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-bold mb-4">Contatti</h2>
          <p class="text-xl">Startup Innovativa a Vocazione Sociale - Fondata nel 2022</p>
        </div>

        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
          <!-- Team -->
          <div class="text-center">
            <i class="fas fa-user-tie text-3xl text-blue-400 mb-4"></i>
            <h3 class="text-xl font-bold mb-3">Roberto Poggi</h3>
            <p class="text-gray-300 mb-2">Responsabile Tecnico</p>
            <p class="text-sm">roberto.poggi@medicagb.it</p>
            <p class="text-sm text-gray-400">331 643 2390</p>
          </div>

          <div class="text-center">
            <i class="fas fa-user-nurse text-3xl text-pink-400 mb-4"></i>
            <h3 class="text-xl font-bold mb-3">Stefania Rocca</h3>
            <p class="text-gray-300 mb-2">Responsabile Commerciale</p>
            <p class="text-sm">stefania.rocca@medicagb.it</p>
            <p class="text-sm text-gray-400">335 730 1206</p>
          </div>

          <!-- Contatti -->
          <div class="text-center">
            <i class="fas fa-envelope text-3xl text-green-400 mb-4"></i>
            <h3 class="text-xl font-bold mb-3">Email</h3>
            <p class="text-sm">info@medicagb.it</p>
            <p class="text-sm">medicagbsrl@pecimprese.it</p>
            <p class="text-sm text-gray-400 mt-3">www.medicagb.it</p>
          </div>

          <!-- Sedi -->
          <div class="text-center">
            <i class="fas fa-map-marker-alt text-3xl text-amber-400 mb-4"></i>
            <h3 class="text-xl font-bold mb-3">Sedi</h3>
            <div class="space-y-4 text-gray-300 text-sm">
              <div>
                <p class="font-semibold">Milano</p>
                <p>Corso Garibaldi 34</p>
                <p>20121 Milano</p>
              </div>
              <div>
                <p class="font-semibold">Genova</p>
                <p>Via delle Eriche 53</p>
                <p>16139 Genova</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Access Staff -->
    <div class="py-8 bg-blue-600 text-white text-center">
      <a href="/home" class="text-white hover:text-blue-200 inline-block px-6 py-3 bg-blue-700 rounded-lg hover:bg-blue-800 transition-all">
        <i class="fas fa-cog mr-2"></i>Area Staff - Accesso Sistema TeleMedCare V12.0
      </a>
    </div>
    
    <script>
        // Funzioni JavaScript per il form
        function autoNavigateDate(input, nextFieldId, maxLength) {
            if (input.value.length >= maxLength && nextFieldId) {
                const nextField = document.getElementById(nextFieldId);
                if (nextField) {
                    nextField.focus();
                }
            }
        }

        function validaEAggiornaSiData() {
            const giorno = document.getElementById('giorno_nascita').value;
            const mese = document.getElementById('mese_nascita').value;
            const anno = document.getElementById('anno_nascita').value;
            
            if (giorno && mese && anno) {
                // Formato ISO per backend
                const dataISO = \`\${anno}-\${mese.padStart(2, '0')}-\${giorno.padStart(2, '0')}\`;
                document.getElementById('data_nascita_assistito').value = dataISO;
                
                // Calcola et√†
                const oggi = new Date();
                const dataNascita = new Date(anno, mese - 1, giorno);
                let eta = oggi.getFullYear() - dataNascita.getFullYear();
                const differenzaMese = oggi.getMonth() - dataNascita.getMonth();
                
                if (differenzaMese < 0 || (differenzaMese === 0 && oggi.getDate() < dataNascita.getDate())) {
                    eta--;
                }
                
                document.getElementById('eta_assistito').value = eta + ' anni';
            }
        }

        function toggleIntestazioneContratto() {
            const checkbox = document.getElementById('vuole_contratto');
            const section = document.getElementById('intestazione_contratto_section');
            
            if (checkbox.checked) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
                // Reset campi dinamici
                document.getElementById('campi_richiedente').style.display = 'none';
                document.getElementById('campi_assistito').style.display = 'none';
            }
        }

        function toggleCampiDinamici() {
            const richiedenteRadio = document.querySelector('input[name="intestazioneContratto"][value="richiedente"]');
            const assistitoRadio = document.querySelector('input[name="intestazioneContratto"][value="assistito"]');
            const campiRichiedente = document.getElementById('campi_richiedente');
            const campiAssistito = document.getElementById('campi_assistito');
            
            if (richiedenteRadio.checked) {
                campiRichiedente.style.display = 'block';
                campiAssistito.style.display = 'none';
            } else if (assistitoRadio.checked) {
                campiRichiedente.style.display = 'none';
                campiAssistito.style.display = 'block';
            }
        }

        // Form submission
        document.getElementById('leadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Mostra loading
            document.getElementById('message_container').classList.remove('hidden');
            document.getElementById('loading_message').classList.remove('hidden');
            document.getElementById('success_message').classList.add('hidden');
            document.getElementById('error_message').classList.add('hidden');
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Gestione checkboxes
            data.vuoleContratto = formData.get('vuoleContratto') ? true : false;
            data.vuoleBrochure = formData.get('vuoleBrochure') ? true : false;
            data.vuoleManuale = formData.get('vuoleManuale') ? true : false;
            data.gdprConsent = formData.get('gdprConsent') ? true : false;
            
            try {
                const response = await fetch('/api/lead', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                // Nascondi loading
                document.getElementById('loading_message').classList.add('hidden');
                
                if (result.success) {
                    document.getElementById('success_message').classList.remove('hidden');
                    document.getElementById('leadForm').reset();
                } else {
                    document.getElementById('error_message').classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Errore invio form:', error);
                document.getElementById('loading_message').classList.add('hidden');
                document.getElementById('error_message').classList.remove('hidden');
            }
        });
    <\/script>

</body>
</html>
  `));I.get("/template-system",async t=>t.html(`<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Template Contratti - TeleMedCare V12.0</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-gradient-to-r from-pink-600 to-rose-700 text-white p-6">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold">
                    <i class="fas fa-layer-group mr-3"></i>
                    Gestione Template Contratti
                </h1>
                <p class="text-xl opacity-90 mt-2">Sistema completo per template contratti, proforma e documenti</p>
            </div>
            <a href="/home" class="bg-white text-pink-600 px-6 py-3 rounded-lg font-semibold hover:bg-pink-50 transition-colors">
                <i class="fas fa-home mr-2"></i>Dashboard
            </a>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-6">
        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="flex items-center">
                    <div class="text-3xl text-blue-500 mr-4">
                        <i class="fas fa-file-contract"></i>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm">Template Contratti</p>
                        <p class="text-2xl font-bold" id="contractTemplates">--</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="flex items-center">
                    <div class="text-3xl text-green-500 mr-4">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm">Template Proforma</p>
                        <p class="text-2xl font-bold" id="proformaTemplates">--</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="flex items-center">
                    <div class="text-3xl text-purple-500 mr-4">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm">Template Email</p>
                        <p class="text-2xl font-bold" id="emailTemplates">--</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="flex items-center">
                    <div class="text-3xl text-orange-500 mr-4">
                        <i class="fas fa-star"></i>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm">Template Attivi</p>
                        <p class="text-2xl font-bold" id="activeTemplates">--</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="bg-white rounded-xl p-6 shadow-lg mb-6">
            <div class="flex flex-wrap gap-4 items-center justify-between">
                <div class="flex flex-wrap gap-4">
                    <button onclick="showCreateTemplate()" class="bg-pink-600 text-white px-6 py-2 rounded-lg hover:bg-pink-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Nuovo Template
                    </button>
                    <button onclick="importTemplate()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-upload mr-2"></i>Importa
                    </button>
                    <button onclick="exportTemplates()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-download mr-2"></i>Esporta Tutti
                    </button>
                </div>
                <div class="flex gap-2">
                    <select id="templateTypeFilter" onchange="filterTemplates()" class="border rounded-lg px-3 py-2">
                        <option value="">Tutti i tipi</option>
                        <option value="CONTRACT">Contratti</option>
                        <option value="PROFORMA">Proforma</option>
                        <option value="EMAIL">Email</option>
                        <option value="BROCHURE">Brochure</option>
                    </select>
                    <select id="templateCategoryFilter" onchange="filterTemplates()" class="border rounded-lg px-3 py-2">
                        <option value="">Tutte le categorie</option>
                        <option value="BASE">Base</option>
                        <option value="AVANZATO">Avanzato</option>
                        <option value="PREMIUM">Premium</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Templates Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
            <!-- Template Cards will be loaded here -->
            <div id="templatesGrid" class="col-span-full">
                <div class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">Caricamento template...</p>
                </div>
            </div>
        </div>

        <!-- Template Details Modal -->
        <div id="templateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b p-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold" id="modalTitle">Dettagli Template</h2>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div id="modalContent" class="p-6">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Create/Edit Template Form -->
        <div id="createTemplateForm" class="hidden bg-white rounded-xl p-6 shadow-lg mb-6">
            <h3 class="text-xl font-bold mb-4">
                <i class="fas fa-plus mr-2 text-pink-600"></i>
                <span id="formTitle">Nuovo Template</span>
            </h3>
            <form id="templateForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome Template</label>
                        <input type="text" id="templateName" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Documento</label>
                        <select id="templateType" class="w-full border rounded-lg px-3 py-2" required>
                            <option value="">Seleziona tipo</option>
                            <option value="CONTRACT">Contratto</option>
                            <option value="PROFORMA">Proforma</option>
                            <option value="EMAIL">Email</option>
                            <option value="BROCHURE">Brochure</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                        <select id="templateCategory" class="w-full border rounded-lg px-3 py-2" required>
                            <option value="">Seleziona categoria</option>
                            <option value="BASE">Base</option>
                            <option value="AVANZATO">Avanzato</option>
                            <option value="PREMIUM">Premium</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Versione</label>
                        <input type="text" id="templateVersion" class="w-full border rounded-lg px-3 py-2" placeholder="es. 1.0" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label>
                    <textarea id="templateDescription" class="w-full border rounded-lg px-3 py-2" rows="3"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Template HTML</label>
                    <textarea id="templateHTML" class="w-full border rounded-lg px-3 py-2 font-mono text-sm" rows="10" placeholder="<html>...</html>"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">CSS Personalizzato (opzionale)</label>
                    <textarea id="templateCSS" class="w-full border rounded-lg px-3 py-2 font-mono text-sm" rows="5" placeholder=".classe { ... }"></textarea>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="bg-pink-600 text-white px-6 py-2 rounded-lg hover:bg-pink-700">
                        <i class="fas fa-save mr-2"></i>Salva Template
                    </button>
                    <button type="button" onclick="cancelCreate()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
                        <i class="fas fa-times mr-2"></i>Annulla
                    </button>
                    <button type="button" onclick="previewTemplate()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-eye mr-2"></i>Anteprima
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Stato applicazione
        let currentTemplates = [];
        let editingTemplate = null;

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            loadTemplateStats();
            loadTemplates();
        });

        // Carica statistiche template
        async function loadTemplateStats() {
            try {
                const response = await fetch('/api/templates/stats');
                const stats = await response.json();
                
                if (stats.success) {
                    document.getElementById('contractTemplates').textContent = stats.data.contracts;
                    document.getElementById('proformaTemplates').textContent = stats.data.proforma;
                    document.getElementById('emailTemplates').textContent = stats.data.emails;
                    document.getElementById('activeTemplates').textContent = stats.data.active;
                } else {
                    // Mock stats for development
                    document.getElementById('contractTemplates').textContent = '3';
                    document.getElementById('proformaTemplates').textContent = '2';
                    document.getElementById('emailTemplates').textContent = '7';
                    document.getElementById('activeTemplates').textContent = '12';
                }
            } catch (error) {
                console.error('Errore caricamento stats:', error);
                // Mock stats for development
                document.getElementById('contractTemplates').textContent = '3';
                document.getElementById('proformaTemplates').textContent = '2';
                document.getElementById('emailTemplates').textContent = '7';
                document.getElementById('activeTemplates').textContent = '12';
            }
        }

        // Carica lista template
        async function loadTemplates() {
            try {
                const response = await fetch('/api/templates');
                const data = await response.json();
                
                if (data.success) {
                    currentTemplates = data.templates || [];
                } else {
                    // Mock data for development
                    currentTemplates = generateMockTemplates();
                }
                
                renderTemplates(currentTemplates);
            } catch (error) {
                console.error('Errore caricamento templates:', error);
                currentTemplates = generateMockTemplates();
                renderTemplates(currentTemplates);
            }
        }

        // Genera template mock per sviluppo
        function generateMockTemplates() {
            return [
                {
                    id: 1,
                    nome_template: 'Contratto Base TeleAssistenza',
                    tipo_documento: 'CONTRACT',
                    categoria: 'BASE',
                    versione: '1.2',
                    attivo: true,
                    template_predefinito: true,
                    utilizzi_totali: 45,
                    ultimo_utilizzo: '2024-03-10T10:30:00Z',
                    descrizione: 'Template standard per contratti base'
                },
                {
                    id: 2,
                    nome_template: 'Contratto Premium TeleMedCare',
                    tipo_documento: 'CONTRACT',
                    categoria: 'PREMIUM',
                    versione: '2.1',
                    attivo: true,
                    template_predefinito: false,
                    utilizzi_totali: 23,
                    ultimo_utilizzo: '2024-03-09T15:45:00Z',
                    descrizione: 'Template avanzato per contratti premium con servizi completi'
                },
                {
                    id: 3,
                    nome_template: 'Proforma Standard',
                    tipo_documento: 'PROFORMA',
                    categoria: 'BASE',
                    versione: '1.0',
                    attivo: true,
                    template_predefinito: true,
                    utilizzi_totali: 78,
                    ultimo_utilizzo: '2024-03-11T09:15:00Z',
                    descrizione: 'Proforma standard per tutti i servizi'
                },
                {
                    id: 4,
                    nome_template: 'Email Benvenuto Lead',
                    tipo_documento: 'EMAIL',
                    categoria: 'BASE',
                    versione: '1.1',
                    attivo: true,
                    template_predefinito: true,
                    utilizzi_totali: 156,
                    ultimo_utilizzo: '2024-03-12T14:20:00Z',
                    descrizione: 'Email automatica di benvenuto per nuovi lead'
                },
                {
                    id: 5,
                    nome_template: 'Brochure Dispositivi',
                    tipo_documento: 'BROCHURE',
                    categoria: 'AVANZATO',
                    versione: '3.0',
                    attivo: false,
                    template_predefinito: false,
                    utilizzi_totali: 12,
                    ultimo_utilizzo: '2024-02-28T11:30:00Z',
                    descrizione: 'Brochure illustrativa dispositivi SiDLY'
                }
            ];
        }

        // Renderizza template
        function renderTemplates(templates) {
            const grid = document.getElementById('templatesGrid');
            
            if (!templates || templates.length === 0) {
                grid.innerHTML = \`
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-folder-open text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl text-gray-600 mb-2">Nessun template trovato</h3>
                        <p class="text-gray-500">Crea il tuo primo template per iniziare</p>
                        <button onclick="showCreateTemplate()" class="mt-4 bg-pink-600 text-white px-6 py-2 rounded-lg hover:bg-pink-700">
                            <i class="fas fa-plus mr-2"></i>Crea Template
                        </button>
                    </div>
                \`;
                return;
            }

            grid.innerHTML = templates.map(template => \`
                <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center">
                            <div class="text-2xl mr-3 \${getTemplateIcon(template.tipo_documento)}">
                                <i class="\${getTemplateIconClass(template.tipo_documento)}"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800">\${template.nome_template}</h3>
                                <p class="text-sm text-gray-600">v\${template.versione}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <span class="px-2 py-1 text-xs rounded \${getCategoryColor(template.categoria)}">
                                \${template.categoria}
                            </span>
                            <span class="px-2 py-1 text-xs rounded \${template.attivo ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                \${template.attivo ? 'Attivo' : 'Inattivo'}
                            </span>
                        </div>
                    </div>
                    
                    <p class="text-gray-600 text-sm mb-4 line-clamp-2">\${template.descrizione || 'Nessuna descrizione'}</p>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm text-gray-500 mb-4">
                        <div>
                            <i class="fas fa-chart-line mr-1"></i>
                            <span>\${template.utilizzi_totali} utilizzi</span>
                        </div>
                        <div>
                            <i class="fas fa-clock mr-1"></i>
                            <span>\${formatDate(template.ultimo_utilizzo)}</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="viewTemplate(\${template.id})" class="flex-1 bg-blue-600 text-white py-2 px-3 rounded text-sm hover:bg-blue-700">
                            <i class="fas fa-eye mr-1"></i>Visualizza
                        </button>
                        <button onclick="editTemplate(\${template.id})" class="bg-yellow-500 text-white py-2 px-3 rounded text-sm hover:bg-yellow-600">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="duplicateTemplate(\${template.id})" class="bg-green-500 text-white py-2 px-3 rounded text-sm hover:bg-green-600">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button onclick="deleteTemplate(\${template.id})" class="bg-red-500 text-white py-2 px-3 rounded text-sm hover:bg-red-600">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            \`).join('');
        }

        // Utility functions
        function getTemplateIcon(type) {
            const colors = {
                'CONTRACT': 'text-blue-500',
                'PROFORMA': 'text-green-500',
                'EMAIL': 'text-purple-500',
                'BROCHURE': 'text-orange-500'
            };
            return colors[type] || 'text-gray-500';
        }

        function getTemplateIconClass(type) {
            const icons = {
                'CONTRACT': 'fas fa-file-contract',
                'PROFORMA': 'fas fa-file-invoice-dollar',
                'EMAIL': 'fas fa-envelope',
                'BROCHURE': 'fas fa-brochure'
            };
            return icons[type] || 'fas fa-file-alt';
        }

        function getCategoryColor(category) {
            const colors = {
                'BASE': 'bg-blue-100 text-blue-800',
                'AVANZATO': 'bg-yellow-100 text-yellow-800',
                'PREMIUM': 'bg-purple-100 text-purple-800'
            };
            return colors[category] || 'bg-gray-100 text-gray-800';
        }

        function formatDate(dateString) {
            if (!dateString) return 'Mai';
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Template actions
        function showCreateTemplate() {
            editingTemplate = null;
            document.getElementById('formTitle').textContent = 'Nuovo Template';
            document.getElementById('templateForm').reset();
            document.getElementById('createTemplateForm').classList.remove('hidden');
            document.getElementById('createTemplateForm').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelCreate() {
            document.getElementById('createTemplateForm').classList.add('hidden');
            document.getElementById('templateForm').reset();
            editingTemplate = null;
        }

        function viewTemplate(templateId) {
            const template = currentTemplates.find(t => t.id === templateId);
            if (!template) return;

            document.getElementById('modalTitle').textContent = template.nome_template;
            document.getElementById('modalContent').innerHTML = \`
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tipo Documento</label>
                                <p class="mt-1 text-sm text-gray-900">\${template.tipo_documento}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Categoria</label>
                                <p class="mt-1 text-sm text-gray-900">\${template.categoria}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Versione</label>
                                <p class="mt-1 text-sm text-gray-900">\${template.versione}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Utilizzi</label>
                                <p class="mt-1 text-sm text-gray-900">\${template.utilizzi_totali}</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Stato</label>
                                <p class="mt-1 text-sm text-gray-900">\${template.attivo ? 'Attivo' : 'Inattivo'}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Predefinito</label>
                                <p class="mt-1 text-sm text-gray-900">\${template.template_predefinito ? 'S√¨' : 'No'}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Ultimo Utilizzo</label>
                                <p class="mt-1 text-sm text-gray-900">\${formatDate(template.ultimo_utilizzo)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descrizione</label>
                        <p class="text-sm text-gray-900 bg-gray-50 p-4 rounded-lg">\${template.descrizione || 'Nessuna descrizione disponibile'}</p>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="editTemplate(\${template.id}); closeModal();" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                            <i class="fas fa-edit mr-2"></i>Modifica
                        </button>
                        <button onclick="duplicateTemplate(\${template.id}); closeModal();" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            <i class="fas fa-copy mr-2"></i>Duplica
                        </button>
                        <button onclick="previewTemplateById(\${template.id})" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            <i class="fas fa-eye mr-2"></i>Anteprima
                        </button>
                    </div>
                </div>
            \`;
            document.getElementById('templateModal').classList.remove('hidden');
        }

        function editTemplate(templateId) {
            const template = currentTemplates.find(t => t.id === templateId);
            if (!template) return;

            editingTemplate = template;
            document.getElementById('formTitle').textContent = 'Modifica Template';
            document.getElementById('templateName').value = template.nome_template;
            document.getElementById('templateType').value = template.tipo_documento;
            document.getElementById('templateCategory').value = template.categoria;
            document.getElementById('templateVersion').value = template.versione;
            document.getElementById('templateDescription').value = template.descrizione || '';
            
            document.getElementById('createTemplateForm').classList.remove('hidden');
            document.getElementById('createTemplateForm').scrollIntoView({ behavior: 'smooth' });
        }

        function duplicateTemplate(templateId) {
            const template = currentTemplates.find(t => t.id === templateId);
            if (!template) return;

            editingTemplate = null;
            document.getElementById('formTitle').textContent = 'Duplica Template';
            document.getElementById('templateName').value = template.nome_template + ' (Copia)';
            document.getElementById('templateType').value = template.tipo_documento;
            document.getElementById('templateCategory').value = template.categoria;
            document.getElementById('templateVersion').value = '1.0';
            document.getElementById('templateDescription').value = template.descrizione || '';
            
            document.getElementById('createTemplateForm').classList.remove('hidden');
            document.getElementById('createTemplateForm').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteTemplate(templateId) {
            if (confirm('Sei sicuro di voler eliminare questo template?')) {
                // Implementation for delete
                console.log('Deleting template:', templateId);
                alert('Template eliminato (funzione demo)');
                loadTemplates(); // Reload
            }
        }

        function closeModal() {
            document.getElementById('templateModal').classList.add('hidden');
        }

        function filterTemplates() {
            const typeFilter = document.getElementById('templateTypeFilter').value;
            const categoryFilter = document.getElementById('templateCategoryFilter').value;

            let filtered = currentTemplates;
            
            if (typeFilter) {
                filtered = filtered.filter(t => t.tipo_documento === typeFilter);
            }
            
            if (categoryFilter) {
                filtered = filtered.filter(t => t.categoria === categoryFilter);
            }

            renderTemplates(filtered);
        }

        function previewTemplate() {
            const html = document.getElementById('templateHTML').value;
            const css = document.getElementById('templateCSS').value;
            
            if (!html) {
                alert('Inserisci il codice HTML del template');
                return;
            }

            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(\`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Anteprima Template</title>
                    <style>\${css}</style>
                </head>
                <body>
                    \${html}
                </body>
                </html>
            \`);
            previewWindow.document.close();
        }

        // Form submission
        document.getElementById('templateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                nome_template: document.getElementById('templateName').value,
                tipo_documento: document.getElementById('templateType').value,
                categoria: document.getElementById('templateCategory').value,
                versione: document.getElementById('templateVersion').value,
                descrizione: document.getElementById('templateDescription').value,
                html_template: document.getElementById('templateHTML').value,
                css_styles: document.getElementById('templateCSS').value
            };

            if (editingTemplate) {
                // Update existing template
                console.log('Updating template:', editingTemplate.id, formData);
                alert('Template aggiornato (funzione demo)');
            } else {
                // Create new template
                console.log('Creating template:', formData);
                alert('Template creato (funzione demo)');
            }

            cancelCreate();
            loadTemplates(); // Reload
        });

        // Import/Export functions
        function importTemplate() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const template = JSON.parse(event.target.result);
                            console.log('Importing template:', template);
                            alert('Template importato (funzione demo)');
                            loadTemplates();
                        } catch (error) {
                            alert('Errore nel file di importazione');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function exportTemplates() {
            const dataStr = JSON.stringify(currentTemplates, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'templates_' + new Date().toISOString().slice(0, 10) + '.json';
            link.click();
        }
    <\/script>
</body>
</html>`));I.get("/home",t=>(t.header("Cache-Control","no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0"),t.header("Pragma","no-cache"),t.header("Expires","0"),t.header("X-Cache-Bypass","true"),t.header("X-TeleMedCare-Version","12.0-"+Date.now()),t.html(c0)));I.get("/admin/system-status",t=>t.html(`
    <!DOCTYPE html>
    <html lang="it">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>TeleMedCare V12.0 - System Status</title>
        <script src="https://cdn.tailwindcss.com"><\/script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gray-50">
        <div class="min-h-screen">
            <header class="bg-gradient-to-r from-gray-600 to-gray-700 text-white shadow-lg">
                <div class="container mx-auto px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <i class="fas fa-server text-3xl"></i>
                            <div>
                                <h1 class="text-2xl font-bold">System Status</h1>
                                <p class="text-sm text-gray-200">Monitoraggio stato sistema e API</p>
                            </div>
                        </div>
                        <a href="/home" class="px-4 py-2 bg-white text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                            <i class="fas fa-home mr-2"></i>Home
                        </a>
                    </div>
                </div>
            </header>
            
            <div class="container mx-auto px-6 py-8">
                <div class="bg-white rounded-xl shadow-lg p-8 text-center">
                    <i class="fas fa-heartbeat text-6xl text-green-500 mb-4"></i>
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Sistema Online</h2>
                    <p class="text-gray-600 mb-6">Tutti i servizi stanno funzionando correttamente</p>
                    
                    <div class="grid md:grid-cols-3 gap-6 mt-8">
                        <div class="bg-green-50 rounded-lg p-6">
                            <i class="fas fa-database text-3xl text-green-600 mb-3"></i>
                            <h3 class="font-bold text-gray-800">Database</h3>
                            <p class="text-green-600">üü¢ Online</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-6">
                            <i class="fas fa-plug text-3xl text-green-600 mb-3"></i>
                            <h3 class="font-bold text-gray-800">API</h3>
                            <p class="text-green-600">üü¢ Online</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-6">
                            <i class="fas fa-envelope text-3xl text-green-600 mb-3"></i>
                            <h3 class="font-bold text-gray-800">Email Service</h3>
                            <p class="text-green-600">üü¢ Online</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    </html>
  `));I.get("/admin/backup-system",t=>t.html(`
    <!DOCTYPE html>
    <html lang="it">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>TeleMedCare V12.0 - Sistema Backup</title>
        <script src="https://cdn.tailwindcss.com"><\/script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gray-50">
        <div class="min-h-screen">
            <header class="bg-gradient-to-r from-green-600 to-green-700 text-white shadow-lg">
                <div class="container mx-auto px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <i class="fas fa-cloud-download-alt text-3xl"></i>
                            <div>
                                <h1 class="text-2xl font-bold">Sistema Backup</h1>
                                <p class="text-sm text-green-100">Backup automatico TEST/STAGING/PRODUZIONE</p>
                            </div>
                        </div>
                        <a href="/home" class="px-4 py-2 bg-white text-green-700 rounded-lg hover:bg-gray-100 transition-colors">
                            <i class="fas fa-home mr-2"></i>Home
                        </a>
                    </div>
                </div>
            </header>
            
            <div class="container mx-auto px-6 py-8">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <div class="text-center mb-8">
                        <i class="fas fa-shield-alt text-6xl text-green-500 mb-4"></i>
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Backup Automatico Attivo</h2>
                        <p class="text-gray-600">Sistema di backup configurato su Cloudflare D1</p>
                    </div>
                    
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="bg-blue-50 rounded-lg p-6 text-center">
                            <i class="fas fa-flask text-3xl text-blue-600 mb-3"></i>
                            <h3 class="font-bold text-gray-800 mb-2">TEST</h3>
                            <p class="text-sm text-gray-600 mb-3">Database sviluppo</p>
                            <span class="inline-block px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">
                                <i class="fas fa-check-circle mr-1"></i>Backup OK
                            </span>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-6 text-center">
                            <i class="fas fa-vial text-3xl text-yellow-600 mb-3"></i>
                            <h3 class="font-bold text-gray-800 mb-2">STAGING</h3>
                            <p class="text-sm text-gray-600 mb-3">Database pre-produzione</p>
                            <span class="inline-block px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm">
                                <i class="fas fa-check-circle mr-1"></i>Backup OK
                            </span>
                        </div>
                        <div class="bg-green-50 rounded-lg p-6 text-center">
                            <i class="fas fa-rocket text-3xl text-green-600 mb-3"></i>
                            <h3 class="font-bold text-gray-800 mb-2">PRODUZIONE</h3>
                            <p class="text-sm text-gray-600 mb-3">Database live</p>
                            <span class="inline-block px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">
                                <i class="fas fa-check-circle mr-1"></i>Backup OK
                            </span>
                        </div>
                    </div>
                    
                    <div class="mt-8 bg-gray-50 rounded-lg p-6">
                        <h3 class="font-bold text-gray-800 mb-4">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                            Informazioni Backup
                        </h3>
                        <ul class="space-y-2 text-gray-600">
                            <li><i class="fas fa-clock mr-2 text-green-500"></i>Backup automatici ogni 24 ore</li>
                            <li><i class="fas fa-database mr-2 text-blue-500"></i>Storage su Cloudflare R2</li>
                            <li><i class="fas fa-lock mr-2 text-purple-500"></i>Backup criptati con AES-256</li>
                            <li><i class="fas fa-history mr-2 text-yellow-500"></i>Retention: 30 giorni</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </body>
    </html>
  `));I.get("/admin/devices",t=>t.html(`
    <!DOCTYPE html>
    <html lang="it">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>TeleMedCare V12.0 - Registrazione Dispositivi</title>
        <script src="https://cdn.tailwindcss.com"><\/script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
          .scan-area { 
            border: 3px dashed #3b82f6; 
            transition: all 0.3s ease; 
          }
          .scan-area.dragover { 
            border-color: #10b981; 
            background-color: #ecfdf5; 
          }
          .device-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          }
          #cameraVideo {
            border: 2px solid #10b981;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          }
          #capturedImage {
            border: 2px solid #3b82f6;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          }
          .camera-overlay {
            position: relative;
          }
          .camera-overlay::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60%;
            border: 2px solid #10b981;
            border-radius: 8px;
            pointer-events: none;
            z-index: 1;
          }
        </style>
    </head>
    <body class="bg-gray-50">
        <div class="min-h-screen">
            <!-- Header -->
            <header class="bg-white shadow-lg border-b-4 border-blue-500">
                <div class="container mx-auto px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <i class="fas fa-microchip text-3xl text-blue-600"></i>
                            <div>
                                <h1 class="text-2xl font-bold text-gray-800">TeleMedCare V12.0</h1>
                                <p class="text-sm text-gray-600">Sistema Registrazione Dispositivi Enterprise</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">
                                <i class="fas fa-circle text-green-500 mr-1"></i>Sistema Attivo
                            </span>
                            <a href="/home" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-home mr-2"></i>Home
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <div class="container mx-auto px-6 py-8">
                <div class="grid lg:grid-cols-2 gap-8">
                    
                    <!-- Sezione Scan Etichetta -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="device-card p-3 rounded-lg">
                                <i class="fas fa-qrcode text-2xl text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">Scan Etichetta SiDLY</h2>
                                <p class="text-gray-600">Registra dispositivo da etichetta fisica</p>
                            </div>
                        </div>

                        <!-- Area Upload Etichetta -->
                        <div id="scanArea" class="scan-area p-8 rounded-xl text-center mb-6">
                            <i class="fas fa-camera text-4xl text-blue-400 mb-4"></i>
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">Carica Foto Etichetta CE</h3>
                            <p class="text-gray-500 mb-4">Scatta una foto dell'etichetta SiDLY o carica da file</p>
                            
                            <!-- Camera Preview Area (Hidden initially) -->
                            <div id="cameraPreview" class="hidden mb-4">
                                <video id="cameraVideo" class="w-full max-w-md mx-auto rounded-lg shadow-lg" autoplay playsinline></video>
                                <div class="mt-4 space-x-3">
                                    <button onclick="capturePhoto()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                        <i class="fas fa-camera mr-2"></i>Scatta Foto
                                    </button>
                                    <button onclick="stopCamera()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                        <i class="fas fa-times mr-2"></i>Chiudi Camera
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Captured Image Preview -->
                            <div id="imagePreview" class="hidden mb-4">
                                <img id="capturedImage" class="w-full max-w-md mx-auto rounded-lg shadow-lg" alt="Etichetta catturata">
                                <div class="mt-4 space-x-3">
                                    <button onclick="retakePhoto()" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors">
                                        <i class="fas fa-redo mr-2"></i>Rifai Foto
                                    </button>
                                    <button onclick="processImage()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-check mr-2"></i>Usa Foto
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div id="actionButtons" class="space-x-3">
                                <input type="file" id="labelFile" accept="image/*" class="hidden">
                                <button onclick="startCamera()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                    <i class="fas fa-camera mr-2"></i>Scatta Foto
                                </button>
                                <button onclick="document.getElementById('labelFile').click()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-upload mr-2"></i>Carica File
                                </button>
                            </div>
                        </div>

                        <!-- Form Manuale -->
                        <div class="border-t pt-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">
                                <i class="fas fa-keyboard mr-2"></i>Inserimento Manuale IMEI
                            </h3>
                            <form id="manualForm">
                                <div class="grid md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2">IMEI *</label>
                                        <input type="text" id="imeiInput" maxlength="15" 
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               placeholder="Es: 868298006120837">
                                        <p class="text-xs text-gray-500 mt-1">Dall'etichetta della foto caricata</p>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2">Modello</label>
                                        <select id="modelSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="SiDLY Care Pro">SiDLY Care Pro</option>
                                            <option value="SiDLY Care Pro V10">SiDLY Care Pro V10</option>
                                            <option value="SiDLY Care Pro V12">SiDLY Care Pro V12</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Sezione Date Dispositivo SiDLY -->
                                <div class="border-t pt-6 mt-6">
                                    <h4 class="text-md font-semibold text-gray-800 mb-4">
                                        <i class="fas fa-calendar mr-2 text-purple-500"></i>Date Dispositivo SiDLY
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2">Data Fabbricazione *</label>
                                            <input type="date" id="manufacturingDateInput" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                   onchange="calculateExpiry()">
                                            <p class="text-xs text-gray-500 mt-1">Data di fabbricazione dall'etichetta SiDLY</p>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2">Data Scadenza</label>
                                            <input type="date" id="expiryDateInput" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                            <p class="text-xs text-gray-500 mt-1">Calcolata automaticamente dalla vita utile (5 anni per SiDLY)</p>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2">Vita Utile (anni)</label>
                                            <select id="usefulLifeSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" onchange="calculateExpiry()">
                                                <option value="5">5 anni (Standard SiDLY)</option>
                                                <option value="3">3 anni (Versioni precedenti)</option>
                                                <option value="7">7 anni (Pro Extended)</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Vita utile del dispositivo secondo manuale</p>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2">Numero Lotto</label>
                                            <input type="text" id="batchNumberInput" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                   placeholder="Es: LOT-2024-001">
                                            <p class="text-xs text-gray-500 mt-1">Numero di lotto di produzione</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-gray-700 font-semibold mb-2">Magazzino Destinazione</label>
                                    <select id="warehouseSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="Milano">Milano - Sede Principale</option>
                                        <option value="Roma">Roma - Hub Centro</option>
                                        <option value="Torino">Torino - Partner IRBEMA</option>
                                        <option value="Napoli">Napoli - Hub Sud</option>
                                    </select>
                                </div>
                                
                                <!-- Sezione Certificazione CE -->
                                <div class="border-t pt-6 mt-6">
                                    <h4 class="text-md font-semibold text-gray-800 mb-4">
                                        <i class="fas fa-certificate mr-2 text-blue-500"></i>Certificazione CE
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2">Numero Certificato CE *</label>
                                            <input type="text" id="ceNumberInput" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                   placeholder="Es: CE-12345-2024">
                                            <p class="text-xs text-gray-500 mt-1">Numero del certificato di conformit√† CE</p>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2">Data Rilascio CE</label>
                                            <input type="date" id="ceDateInput" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <p class="text-xs text-gray-500 mt-1">Data di rilascio della certificazione</p>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2">Ente Certificatore</label>
                                            <input type="text" id="ceAuthorityInput" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                   placeholder="Es: T√úV Rheinland Italia">
                                            <p class="text-xs text-gray-500 mt-1">Nome dell'ente che ha rilasciato la certificazione</p>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2">Data Scadenza CE</label>
                                            <input type="date" id="ceExpiryInput" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <p class="text-xs text-gray-500 mt-1">Data di scadenza della certificazione</p>
                                        </div>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 font-semibold mb-2">Classi di Rischio CE</label>
                                        <select id="ceRiskClassSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="">Seleziona classe di rischio</option>
                                            <option value="Classe I">Classe I - Basso rischio</option>
                                            <option value="Classe IIa">Classe IIa - Medio-basso rischio</option>
                                            <option value="Classe IIb">Classe IIb - Medio-alto rischio</option>
                                            <option value="Classe III">Classe III - Alto rischio</option>
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">Classificazione del dispositivo secondo la direttiva MDD/MDR</p>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 font-semibold mb-2">Note Certificazione</label>
                                        <textarea id="ceNotesInput" rows="3" 
                                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                  placeholder="Eventuali note aggiuntive sulla certificazione CE"></textarea>
                                    </div>
                                </div>
                                
                                <button type="submit" class="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold">
                                    <i class="fas fa-plus-circle mr-2"></i>Registra Dispositivo
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Sezione Risultati -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="bg-green-100 p-3 rounded-lg">
                                <i class="fas fa-check-circle text-2xl text-green-600"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">Risultato Registrazione</h2>
                                <p class="text-gray-600">Status e dettagli dispositivo</p>
                            </div>
                        </div>

                        <!-- Area Risultati -->
                        <div id="resultArea" class="hidden">
                            <div id="successResult" class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4 hidden">
                                <div class="flex items-center">
                                    <i class="fas fa-check-circle text-green-500 text-xl mr-3"></i>
                                    <div>
                                        <h4 class="font-semibold text-green-800">‚úÖ Dispositivo Registrato!</h4>
                                        <p class="text-green-700" id="successMessage"></p>
                                    </div>
                                </div>
                                <div class="mt-4 space-y-2" id="deviceDetails"></div>
                            </div>

                            <div id="errorResult" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4 hidden">
                                <div class="flex items-center">
                                    <i class="fas fa-exclamation-circle text-red-500 text-xl mr-3"></i>
                                    <div>
                                        <h4 class="font-semibold text-red-800">‚ùå Errore Registrazione</h4>
                                        <p class="text-red-700" id="errorMessage"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stato Parsing -->
                        <div id="parsingStatus" class="text-center py-8 text-gray-500 hidden">
                            <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                            <p class="text-lg">‚è≥ Analisi etichetta in corso...</p>
                        </div>

                        <!-- Placeholder iniziale -->
                        <div id="placeholderArea" class="text-center py-12 text-gray-400">
                            <i class="fas fa-clipboard-list text-4xl mb-4"></i>
                            <p class="text-lg">üìã In attesa di registrazione dispositivo</p>
                            <p class="text-sm">I risultati appariranno qui dopo la scansione</p>
                        </div>
                    </div>
                </div>

                <!-- Statistiche Rapide -->
                <div class="mt-8 grid md:grid-cols-4 gap-4">
                    <div class="bg-white rounded-lg shadow p-4 text-center">
                        <i class="fas fa-microchip text-2xl text-blue-500 mb-2"></i>
                        <div class="text-2xl font-bold text-gray-800" id="totalDevices">-</div>
                        <div class="text-sm text-gray-600">Dispositivi Totali</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4 text-center">
                        <i class="fas fa-warehouse text-2xl text-green-500 mb-2"></i>
                        <div class="text-2xl font-bold text-gray-800" id="stockDevices">-</div>
                        <div class="text-sm text-gray-600">In Magazzino</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4 text-center">
                        <i class="fas fa-shipping-fast text-2xl text-yellow-500 mb-2"></i>
                        <div class="text-2xl font-bold text-gray-800" id="shippedDevices">-</div>
                        <div class="text-sm text-gray-600">Spediti</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4 text-center">
                        <i class="fas fa-heartbeat text-2xl text-red-500 mb-2"></i>
                        <div class="text-2xl font-bold text-gray-800" id="activeDevices">-</div>
                        <div class="text-sm text-gray-600">Attivi</div>
                    </div>
                </div>

                <!-- Lista Dispositivi Magazzino -->
                <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="bg-purple-100 p-3 rounded-lg">
                                <i class="fas fa-boxes text-purple-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Magazzino Dispositivi</h3>
                                <p class="text-gray-600">Elenco completo dispositivi registrati</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <select id="warehouseFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">Tutti i magazzini</option>
                                <option value="Milano">Milano</option>
                                <option value="Roma">Roma</option>
                                <option value="Torino">Torino</option>
                                <option value="Napoli">Napoli</option>
                            </select>
                            <select id="statusFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">Tutti gli stati</option>
                                <option value="INVENTORY">In Magazzino</option>
                                <option value="ASSIGNED">Assegnato</option>
                                <option value="SHIPPED">Spedito</option>
                                <option value="ACTIVE">Attivo</option>
                                <option value="MAINTENANCE">Manutenzione</option>
                            </select>
                            <button onclick="loadDevicesList()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                <i class="fas fa-sync mr-2"></i>Aggiorna
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">IMEI</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Modello</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Magazzino</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stato</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">CE</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data Reg.</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="devicesTableBody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i><br>
                                        Caricamento dispositivi...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Guida Rapida -->
                <div class="mt-8 bg-blue-50 rounded-xl p-6">
                    <h3 class="text-lg font-bold text-blue-900 mb-4">
                        <i class="fas fa-info-circle mr-2"></i>Come utilizzare il sistema
                    </h3>
                    <div class="grid md:grid-cols-2 gap-6 text-sm text-blue-800">
                        <div>
                            <h4 class="font-semibold mb-2">üì∏ Scan da Foto:</h4>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Scatta foto nitida dell'etichetta SiDLY</li>
                                <li>Carica il file tramite drag&drop o click</li>
                                <li>Il sistema analizza automaticamente IMEI, UDI, CE</li>
                                <li>Conferma i dati e registra il dispositivo</li>
                            </ol>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">‚å®Ô∏è Inserimento Manuale:</h4>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Inserisci IMEI di 15 cifre dall'etichetta</li>
                                <li>Seleziona modello e magazzino destinazione</li>
                                <li>Clicca "Registra Dispositivo"</li>
                                <li>Il sistema valida IMEI e crea la registrazione</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Configurazione sistema
            const API_BASE = '/api';
            
            // Inizializzazione
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üöÄ TeleMedCare V12.0 - Device Registration System');
                loadStatistics();
                setupFileUpload();
                setupManualForm();
                // Carica dispositivi dopo un breve delay per dare tempo alle statistiche
                setTimeout(() => {
                    loadDevicesList();
                }, 1000);
            });

            // Setup upload file
            function setupFileUpload() {
                const fileInput = document.getElementById('labelFile');
                const scanArea = document.getElementById('scanArea');

                // Drag & Drop
                scanArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    scanArea.classList.add('dragover');
                });

                scanArea.addEventListener('dragleave', () => {
                    scanArea.classList.remove('dragover');
                });

                scanArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    scanArea.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleFileSelect(files[0]);
                    }
                });

                // File input change
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleFileSelect(e.target.files[0]);
                    }
                });
            }

            // Funzione per calcolare automaticamente la data di scadenza
            function calculateExpiry() {
                const manufacturingDate = document.getElementById('manufacturingDateInput').value;
                const usefulLife = parseInt(document.getElementById('usefulLifeSelect').value);
                
                if (manufacturingDate && usefulLife) {
                    const mfgDate = new Date(manufacturingDate);
                    const expiryDate = new Date(mfgDate);
                    expiryDate.setFullYear(expiryDate.getFullYear() + usefulLife);
                    
                    // Format date to YYYY-MM-DD for input field
                    const formattedDate = expiryDate.toISOString().split('T')[0];
                    document.getElementById('expiryDateInput').value = formattedDate;
                }
            }

            // ========== CAMERA FUNCTIONS ==========
            let cameraStream = null;
            let capturedImageData = null;

            // Avvia la camera
            async function startCamera() {
                try {
                    const video = document.getElementById('cameraVideo');
                    const cameraPreview = document.getElementById('cameraPreview');
                    const actionButtons = document.getElementById('actionButtons');
                    const imagePreview = document.getElementById('imagePreview');

                    // Nasconde altri elementi
                    actionButtons.classList.add('hidden');
                    imagePreview.classList.add('hidden');

                    // Mostra preview camera
                    cameraPreview.classList.remove('hidden');

                    // Configura la camera (preferisce camera posteriore su mobile)
                    const constraints = {
                        video: {
                            facingMode: { ideal: 'environment' }, // Camera posteriore
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };

                    cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = cameraStream;
                    
                    console.log('‚úÖ Camera avviata con successo');
                } catch (error) {
                    console.error('‚ùå Errore avvio camera:', error);
                    alert('Errore nell\\'accesso alla camera. Assicurati di aver concesso i permessi.');
                    showActionButtons();
                }
            }

            // Cattura una foto dalla camera
            function capturePhoto() {
                try {
                    const video = document.getElementById('cameraVideo');
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');

                    // Imposta le dimensioni del canvas
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;

                    // Disegna il frame corrente del video sul canvas
                    context.drawImage(video, 0, 0);

                    // Converti in base64
                    capturedImageData = canvas.toDataURL('image/jpeg', 0.8);

                    // Mostra l'immagine catturata
                    const capturedImage = document.getElementById('capturedImage');
                    capturedImage.src = capturedImageData;

                    // Nasconde camera, mostra preview immagine
                    document.getElementById('cameraPreview').classList.add('hidden');
                    document.getElementById('imagePreview').classList.remove('hidden');

                    console.log('üì∏ Foto catturata con successo');
                } catch (error) {
                    console.error('‚ùå Errore cattura foto:', error);
                    alert('Errore durante la cattura della foto.');
                }
            }

            // Rifai la foto
            function retakePhoto() {
                document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('cameraPreview').classList.remove('hidden');
                capturedImageData = null;
            }

            // Ferma la camera
            function stopCamera() {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                }
                
                document.getElementById('cameraPreview').classList.add('hidden');
                document.getElementById('imagePreview').classList.add('hidden');
                showActionButtons();
                capturedImageData = null;
            }

            // Mostra i pulsanti di azione iniziali
            function showActionButtons() {
                document.getElementById('actionButtons').classList.remove('hidden');
            }

            // Processa l'immagine catturata
            function processImage() {
                if (!capturedImageData) {
                    alert('Nessuna immagine da processare');
                    return;
                }

                // Ferma la camera
                stopCamera();

                // Simula il processing dell'immagine come se fosse un file caricato
                // Converte base64 in File object per compatibilit√†
                fetch(capturedImageData)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], 'etichetta_camera.jpg', { type: 'image/jpeg' });
                        handleFileSelect(file);
                    })
                    .catch(error => {
                        console.error('‚ùå Errore processing immagine:', error);
                        alert('Errore nel processamento dell\\'immagine');
                    });
            }

            // Setup form manuale
            function setupManualForm() {
                document.getElementById('manualForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const imei = document.getElementById('imeiInput').value.trim();
                    const model = document.getElementById('modelSelect').value;
                    const warehouse = document.getElementById('warehouseSelect').value;
                    
                    // Dati dispositivo SiDLY
                    const manufacturingDate = document.getElementById('manufacturingDateInput').value;
                    const expiryDate = document.getElementById('expiryDateInput').value;
                    const usefulLife = document.getElementById('usefulLifeSelect').value;
                    const batchNumber = document.getElementById('batchNumberInput').value.trim();
                    
                    // Dati certificazione CE
                    const ceNumber = document.getElementById('ceNumberInput').value.trim();
                    const ceDate = document.getElementById('ceDateInput').value;
                    const ceAuthority = document.getElementById('ceAuthorityInput').value.trim();
                    const ceExpiry = document.getElementById('ceExpiryInput').value;
                    const ceRiskClass = document.getElementById('ceRiskClassSelect').value;
                    const ceNotes = document.getElementById('ceNotesInput').value.trim();

                    if (!imei || imei.length !== 15) {
                        showError('IMEI deve essere di 15 cifre numeriche');
                        return;
                    }

                    if (!/^\\d{15}$/.test(imei)) {
                        showError('IMEI deve contenere solo cifre');
                        return;
                    }

                    if (!manufacturingDate) {
                        showError('Data Fabbricazione √® obbligatoria');
                        return;
                    }

                    if (!ceNumber) {
                        showError('Numero Certificato CE √® obbligatorio');
                        return;
                    }

                    await registerDevice({
                        labelText: \`SIDLY CARE PRO\\nIMEI: \${imei}\\nModello: \${model}\\nData Fab: \${manufacturingDate}\\nScadenza: \${expiryDate}\\nLotto: \${batchNumber}\\nCE \${ceNumber}\\nSIDLY Sp. z o.o.\`,
                        magazzino: warehouse,
                        deviceData: {
                            manufacturingDate: manufacturingDate,
                            expiryDate: expiryDate,
                            usefulLife: usefulLife,
                            batchNumber: batchNumber
                        },
                        ceData: {
                            ceNumber: ceNumber,
                            ceDate: ceDate,
                            ceAuthority: ceAuthority,
                            ceExpiry: ceExpiry,
                            ceRiskClass: ceRiskClass,
                            ceNotes: ceNotes
                        }
                    });
                });

                // Validazione real-time IMEI
                document.getElementById('imeiInput').addEventListener('input', (e) => {
                    const value = e.target.value.replace(/\\D/g, ''); // Solo cifre
                    e.target.value = value;
                });
            }

            // Gestione file selezionato
            async function handleFileSelect(file) {
                console.log('üì∏ File selezionato:', file.name);
                showParsingStatus(true);

                try {
                    if (file.type.startsWith('image/')) {
                        // Per immagini: genera mock data realistico
                        const mockIMEI = generateMockIMEI();
                        const mockLabelText = \`
                            SIDLY CARE PRO
                            Il braccialetto SiDly Care PRO √® un dispositivo telemedico
                            IMEI: \${mockIMEI}
                            (01)05903890760045
                            (11)230501
                            CE 0197
                            SIDLY Sp. z o.o.
                            Ul. Chmielna 2/31, 00-020 Warszawa
                            tel: +48 667 871 126
                            email: helpdesk@sidly.org
                            Ver. 7_07022024
                        \`;
                        
                        // Popola anche il form manuale per comodit√†
                        document.getElementById('imeiInput').value = mockIMEI;
                        
                        await registerDevice({
                            labelText: mockLabelText,
                            labelImage: file.name,
                            magazzino: document.getElementById('warehouseSelect').value
                        });
                    } else {
                        // File di testo
                        const text = await file.text();
                        await registerDevice({
                            labelText: text,
                            magazzino: document.getElementById('warehouseSelect').value
                        });
                    }
                } catch (error) {
                    console.error('‚ùå Errore handling file:', error);
                    showError(\`Errore lettura file: \${error.message}\`);
                } finally {
                    showParsingStatus(false);
                }
            }

            // Registrazione dispositivo
            async function registerDevice(data) {
                console.log('üìù Registrazione dispositivo:', data);
                
                try {
                    const response = await fetch(\`\${API_BASE}/devices/test-scan\`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();
                    console.log('üìã Risultato registrazione:', result);

                    if (result.success) {
                        showSuccess(result);
                        loadStatistics(); // Aggiorna statistiche
                        
                        // Reset form dopo 3 secondi
                        setTimeout(() => {
                            document.getElementById('manualForm').reset();
                        }, 3000);
                    } else {
                        showError(result.error, result.details);
                    }
                } catch (error) {
                    console.error('‚ùå Errore registrazione:', error);
                    showError(\`Errore connessione server: \${error.message}\`);
                }
            }

            // Mostra successo
            function showSuccess(result) {
                const resultArea = document.getElementById('resultArea');
                const successResult = document.getElementById('successResult');
                const deviceDetails = document.getElementById('deviceDetails');
                const placeholderArea = document.getElementById('placeholderArea');

                document.getElementById('successMessage').textContent = result.message;
                
                deviceDetails.innerHTML = \`
                    <div class="bg-white p-3 rounded border-l-4 border-green-500">
                        <strong>üÜî Device ID:</strong> <code class="bg-gray-100 px-2 py-1 rounded">\${result.deviceId}</code>
                    </div>
                    <div class="bg-white p-3 rounded border-l-4 border-blue-500">
                        <strong>üì± IMEI:</strong> <code class="bg-gray-100 px-2 py-1 rounded">\${result.imei}</code>
                    </div>
                    <div class="bg-white p-3 rounded border-l-4 border-purple-500">
                        <strong>üè∑Ô∏è Modello:</strong> \${result.model}
                    </div>
                    \${result.ceData ? \`
                    <div class="bg-green-50 p-3 rounded border border-green-200">
                        <strong>üèÜ Certificazione CE:</strong><br>
                        <div class="text-sm text-green-800 mt-2 space-y-1">
                            <div><strong>Numero:</strong> \${result.ceData.ceNumber}</div>
                            \${result.ceData.ceAuthority ? \`<div><strong>Ente:</strong> \${result.ceData.ceAuthority}</div>\` : ''}
                            \${result.ceData.ceRiskClass ? \`<div><strong>Classe Rischio:</strong> \${result.ceData.ceRiskClass}</div>\` : ''}
                            \${result.ceData.ceDate ? \`<div><strong>Data Rilascio:</strong> \${new Date(result.ceData.ceDate).toLocaleDateString('it-IT')}</div>\` : ''}
                            \${result.ceData.ceExpiry ? \`<div><strong>Scadenza:</strong> \${new Date(result.ceData.ceExpiry).toLocaleDateString('it-IT')}</div>\` : ''}
                            \${result.ceData.ceNotes ? \`<div><strong>Note:</strong> \${result.ceData.ceNotes}</div>\` : ''}
                        </div>
                    </div>
                    \` : ''}
                    \${result.labelData ? \`
                    <div class="bg-blue-50 p-3 rounded border">
                        <strong>üìã Dati Etichetta:</strong><br>
                        <small class="text-gray-600">UDI: \${result.labelData.udiNumbers?.di || 'N/A'} | 
                        CE: \${result.labelData.ceMarking || 'N/A'} | 
                        Produttore: \${result.labelData.manufacturer?.name || 'N/A'}</small>
                    </div>
                    \` : ''}
                \`;

                hideAllResults();
                successResult.classList.remove('hidden');
                resultArea.classList.remove('hidden');
                placeholderArea.classList.add('hidden');
            }

            // Mostra errore
            function showError(message, details = []) {
                const resultArea = document.getElementById('resultArea');
                const errorResult = document.getElementById('errorResult');
                const placeholderArea = document.getElementById('placeholderArea');

                let fullMessage = message;
                if (details && details.length > 0) {
                    fullMessage += \`\\n\\nüîç Dettagli:\\n‚Ä¢ \${details.join('\\n‚Ä¢ ')}\`;
                }

                document.getElementById('errorMessage').textContent = fullMessage;

                hideAllResults();
                errorResult.classList.remove('hidden');
                resultArea.classList.remove('hidden');
                placeholderArea.classList.add('hidden');
            }

            // Mostra status parsing
            function showParsingStatus(show) {
                const parsingStatus = document.getElementById('parsingStatus');
                const placeholderArea = document.getElementById('placeholderArea');

                if (show) {
                    hideAllResults();
                    parsingStatus.classList.remove('hidden');
                    placeholderArea.classList.add('hidden');
                } else {
                    parsingStatus.classList.add('hidden');
                }
            }

            // Nascondi tutti i risultati
            function hideAllResults() {
                document.getElementById('successResult').classList.add('hidden');
                document.getElementById('errorResult').classList.add('hidden');
                document.getElementById('parsingStatus').classList.add('hidden');
            }

            // Carica statistiche
            async function loadStatistics() {
                try {
                    const response = await fetch('/api/devices/stats');
                    const data = await response.json();
                    
                    if (data.success && data.stats) {
                        const stats = data.stats;
                        document.getElementById('totalDevices').textContent = stats.totalDevices || 0;
                        document.getElementById('stockDevices').textContent = stats.availableDevices || 0;
                        document.getElementById('shippedDevices').textContent = (stats.statusDistribution?.find(s => s.status === 'SHIPPED')?.count || 0);
                        document.getElementById('activeDevices').textContent = stats.activeDevices || 0;
                    } else {
                        // Fallback con dati demo
                        document.getElementById('totalDevices').textContent = '12';
                        document.getElementById('stockDevices').textContent = '8';
                        document.getElementById('shippedDevices').textContent = '3';
                        document.getElementById('activeDevices').textContent = '1';
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Errore caricamento statistiche:', error);
                }
            }

            // Genera IMEI mock realistico per demo
            function generateMockIMEI() {
                const tac = '35900002'; // SiDLY Technologies V12.0
                const snr = Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
                const imei14 = tac + snr;
                
                // Calcolo check digit Luhn algorithm
                let sum = 0;
                let alternate = false;
                
                for (let i = imei14.length - 1; i >= 0; i--) {
                    let digit = parseInt(imei14.charAt(i));
                    if (alternate) {
                        digit *= 2;
                        if (digit > 9) digit = Math.floor(digit / 10) + (digit % 10);
                    }
                    sum += digit;
                    alternate = !alternate;
                }
                
                const checkDigit = (10 - (sum % 10)) % 10;
                return imei14 + checkDigit;
            }

            // Carica lista dispositivi
            async function loadDevicesList() {
                try {
                    const warehouseFilter = document.getElementById('warehouseFilter').value;
                    const statusFilter = document.getElementById('statusFilter').value;
                    
                    let url = '/api/devices/inventory';
                    const params = new URLSearchParams();
                    if (warehouseFilter) params.append('warehouse', warehouseFilter);
                    if (statusFilter) params.append('status', statusFilter);
                    if (params.toString()) url += '?' + params.toString();
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.success && data.data && data.data.devices) {
                        displayDevicesList(data.data.devices);
                    } else {
                        showDevicesError('Errore caricamento dispositivi: ' + (data.error || 'Unknown'));
                    }
                } catch (error) {
                    console.error('Errore caricamento dispositivi:', error);
                    showDevicesError('Errore connessione server');
                }
            }

            // Mostra lista dispositivi
            function displayDevicesList(devices) {
                const tbody = document.getElementById('devicesTableBody');
                
                if (!devices || devices.length === 0) {
                    tbody.innerHTML = \`
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                <i class="fas fa-box-open text-3xl mb-2"></i><br>
                                Nessun dispositivo trovato
                            </td>
                        </tr>
                    \`;
                    return;
                }
                
                tbody.innerHTML = devices.map(device => \`
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-4 text-sm font-mono text-gray-900">\${device.imei || 'N/A'}</td>
                        <td class="px-4 py-4 text-sm text-gray-900">\${device.model || 'N/A'}</td>
                        <td class="px-4 py-4 text-sm text-gray-900">\${device.magazzino || 'N/A'}</td>
                        <td class="px-4 py-4 text-sm">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full \${getStatusBadgeClass(device.status)}">
                                \${getStatusLabel(device.status)}
                            </span>
                        </td>
                        <td class="px-4 py-4 text-sm text-gray-900">
                            \${device.ce_marking || 'N/A'}
                        </td>
                        <td class="px-4 py-4 text-sm text-gray-500">
                            \${device.created_at ? new Date(device.created_at).toLocaleDateString('it-IT') : 'N/A'}
                        </td>
                        <td class="px-4 py-4 text-sm font-medium">
                            <button onclick="viewDeviceDetails('\${device.device_id}')" class="text-blue-600 hover:text-blue-800 mr-2">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editDeviceStatus('\${device.device_id}')" class="text-green-600 hover:text-green-800">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                \`).join('');
            }

            // Helper functions per stato dispositivi
            function getStatusBadgeClass(status) {
                switch (status) {
                    case 'INVENTORY': return 'bg-green-100 text-green-800';
                    case 'ASSIGNED': return 'bg-blue-100 text-blue-800';
                    case 'SHIPPED': return 'bg-yellow-100 text-yellow-800';
                    case 'ACTIVE': return 'bg-purple-100 text-purple-800';
                    case 'MAINTENANCE': return 'bg-orange-100 text-orange-800';
                    case 'DECOMMISSIONED': return 'bg-red-100 text-red-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            }

            function getStatusLabel(status) {
                switch (status) {
                    case 'INVENTORY': return 'In Magazzino';
                    case 'ASSIGNED': return 'Assegnato';
                    case 'SHIPPED': return 'Spedito';
                    case 'ACTIVE': return 'Attivo';
                    case 'MAINTENANCE': return 'Manutenzione';
                    case 'DECOMMISSIONED': return 'Dismesso';
                    default: return status || 'Sconosciuto';
                }
            }

            function showDevicesError(message) {
                const tbody = document.getElementById('devicesTableBody');
                tbody.innerHTML = \`
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-red-500">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i><br>
                            \${message}
                        </td>
                    </tr>
                \`;
            }

            function viewDeviceDetails(deviceId) {
                alert('Visualizza dettagli dispositivo: ' + deviceId);
                // TODO: Implementare modal dettagli
            }

            function editDeviceStatus(deviceId) {
                alert('Modifica stato dispositivo: ' + deviceId);
                // TODO: Implementare modal modifica stato
            }
        <\/script>

        <script>
            // Aggiorna le mini-statistiche del Dashboard Leads
            async function updateLeadsModuleStats() {
                try {
                    const response = await fetch('/api/admin/leads-dashboard');
                    const data = await response.json();
                    
                    if (data.success && data.dashboard) {
                        const stats = data.dashboard;
                        
                        // Aggiorna le mini-statistiche nel box
                        document.getElementById('configPartners').textContent = stats.analytics.partners?.length || 0;
                        document.getElementById('coreLeads').textContent = stats.kpi.leadsTotali || 0;
                        document.getElementById('channels').textContent = stats.analytics.channels?.length || 0;
                        document.getElementById('conversions').textContent = stats.modules.conversion || 0;
                        document.getElementById('scoreAvg').textContent = stats.kpi.scoreMedio?.toFixed(1) || '0.0';
                        document.getElementById('reportsCount').textContent = stats.modules.reports || 0;
                    }
                } catch (error) {
                    console.error('Errore aggiornamento statistiche leads:', error);
                    // Fallback values
                    document.getElementById('configPartners').textContent = '6';
                    document.getElementById('coreLeads').textContent = '25';
                    document.getElementById('channels').textContent = '5';
                    document.getElementById('conversions').textContent = '12';
                    document.getElementById('scoreAvg').textContent = '7.2';
                    document.getElementById('reportsCount').textContent = '24';
                }
            }

            // Carica le statistiche all'avvio della pagina
            document.addEventListener('DOMContentLoaded', function() {
                updateLeadsModuleStats();
                // Auto-refresh ogni 60 secondi
                setInterval(updateLeadsModuleStats, 60000);
            });
        <\/script>
        
        <!-- FOOTER DISCRETO PER ACCESSO STAFF -->
        <footer class="bg-gray-900 text-white py-4">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center">
                    <div class="text-sm">
                        <p>&copy; 2024 TeleMedCare V12.0 - Medica GB S.r.l. Tutti i diritti riservati.</p>
                    </div>
                    <div class="text-xs">
                        <a href="/dashboard" class="text-gray-400 hover:text-white transition-colors" title="Accesso Staff">
                            Staff Area
                        </a>
                    </div>
                </div>
            </div>
        </footer>
    </body>
    </html>
  `));I.post("/api/lead",async t=>{try{console.log("üì® TeleMedCare V12.0-Cloudflare: Nuovo lead ricevuto");let o={};if((t.req.header("content-type")||"").includes("application/json"))o=await t.req.json();else{const b=await t.req.formData();for(const[h,E]of b.entries())o[h]=E}console.log("üìù Dati lead ricevuti:",JSON.stringify(o,null,2));const a=o.nome||o.nomeRichiedente||"",i=o.email||o.email||"",r=o.telefono||o.telefono||"",s=o.eta||o.etaRichiedente||null,l=o.servizio||o.tipoServizio||"BASIC",d=o.azienda||o.aziendaRichiedente||null;if(!a||!i)return t.json({success:!1,error:"Campi obbligatori mancanti: nome e email sono richiesti"},400);const c=RT(),u=new Date().toISOString(),{calcolaEta:p}=await Promise.resolve().then(()=>UT),g=o.dataNascitaAssistito?p(o.dataNascitaAssistito):null,m={id:c,nomeRichiedente:String(a).trim(),cognomeRichiedente:String(o.cognomeRichiedente||"").trim(),email:String(i).toLowerCase().trim(),telefono:String(r).replace(/[^\d+]/g,""),nomeAssistito:String(o.nomeAssistito||a).trim(),cognomeAssistito:String(o.cognomeAssistito||"").trim(),dataNascitaAssistito:String(o.dataNascitaAssistito||"").trim(),etaAssistito:String(s||g||o.etaAssistito||"").trim(),parentelaAssistito:String(o.parentelaAssistito||"").trim(),servizio:String(l),pacchetto:String(o.pacchetto||"BASE"),condizioniSalute:String(o.condizioniSalute||"").trim(),priority:String(o.priority||"").trim(),preferenzaContatto:String(o.preferenzaContatto||"").trim(),vuoleContratto:o.vuoleContratto==="on"||o.vuoleContratto==="Si"||o.vuoleContratto===!0,intestazioneContratto:String(o.intestazioneContratto||d||"").trim(),cfIntestatario:String(o.cfIntestatario||"").trim(),indirizzoIntestatario:String(o.indirizzoIntestatario||"").trim(),cfAssistito:String(o.cfAssistito||"").trim(),indirizzoAssistito:String(o.indirizzoAssistito||"").trim(),vuoleBrochure:o.vuoleBrochure==="on"||o.vuoleBrochure==="Si"||o.vuoleBrochure===!0,vuoleManuale:o.vuoleManuale==="on"||o.vuoleManuale==="Si"||o.vuoleManuale===!0,note:String(o.note||"").trim(),gdprConsent:o.gdprConsent==="on"||o.gdprConsent===!0||o.privacy===!0,timestamp:u,fonte:String(o.fonte||o.source||"Landing Page V12.0-Cloudflare"),versione:String(o.versione||"V12.0-Cloudflare"),status:"nuovo"};if(console.log("‚úÖ Dati normalizzati:",JSON.stringify(m,null,2)),t.env.DB){const{servizio:b,piano:h,prezzoAnno:E,prezzoRinnovo:w}=AT(m.pacchetto);console.log(`üí∞ [PRICING] ${m.pacchetto} ‚Üí ${b} ${h} = ‚Ç¨${E} (rinnovo: ‚Ç¨${w})`),await t.env.DB.prepare(`
        INSERT INTO leads (
          id, nomeRichiedente, cognomeRichiedente, email, telefono,
          nomeAssistito, cognomeAssistito, dataNascitaAssistito, etaAssistito, parentelaAssistito,
          pacchetto, condizioniSalute, preferenzaContatto,
          vuoleContratto, intestazioneContratto, cfIntestatario, indirizzoIntestatario,
          cfAssistito, indirizzoAssistito, vuoleBrochure, vuoleManuale,
          note, gdprConsent, timestamp, fonte, versione, status,
          prezzo_anno, prezzo_rinnovo
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `).bind(m.id,m.nomeRichiedente,m.cognomeRichiedente,m.email,m.telefono,m.nomeAssistito,m.cognomeAssistito,m.dataNascitaAssistito,m.etaAssistito,m.parentelaAssistito,m.pacchetto,m.condizioniSalute,m.preferenzaContatto,m.vuoleContratto?1:0,m.intestazioneContratto,m.cfIntestatario,m.indirizzoIntestatario,m.cfAssistito,m.indirizzoAssistito,m.vuoleBrochure?1:0,m.vuoleManuale?1:0,m.note,m.gdprConsent?1:0,m.timestamp,m.fonte,m.versione,m.status,E,w).run(),console.log("‚úÖ Lead salvato nel database con nuovo schema"),console.log("üöÄ [WORKFLOW] Avvio orchestratore workflow completo");const S={db:t.env.DB,env:t.env,leadData:{id:m.id,nomeRichiedente:m.nomeRichiedente,cognomeRichiedente:m.cognomeRichiedente,email:m.email,telefono:m.telefono,nomeAssistito:m.nomeAssistito,cognomeAssistito:m.cognomeAssistito,etaAssistito:m.etaAssistito,pacchetto:m.pacchetto,servizio:m.servizio||"PRO",vuoleContratto:m.vuoleContratto,vuoleBrochure:m.vuoleBrochure,vuoleManuale:m.vuoleManuale,fonte:m.fonte}};try{const C=await dT(S);return console.log("üìß [WORKFLOW] Orchestratore completato:",C),t.json({success:!0,leadId:c,message:"Lead ricevuto e processato con successo",timestamp:u,workflow:C})}catch(C){return console.error("‚ö†Ô∏è Workflow orchestrator error (lead gi√† salvato):",C),console.error("Stack:",C instanceof Error?C.stack:"No stack"),t.json({success:!0,leadId:c,message:"Lead salvato con successo",timestamp:u,warning:"Email workflow may be delayed",workflowError:C instanceof Error?C.message:String(C)})}}else return console.log("‚ö†Ô∏è Database non configurato - modalit√† development"),t.json({success:!0,leadId:c,message:"Lead ricevuto (database non configurato)",timestamp:u})}catch(o){return console.error("‚ùå TeleMedCare V12.0-Cloudflare: Errore elaborazione lead:",o),t.json({success:!1,error:"Errore interno del server"},500)}});I.post("/api/admin/cleanup-test-leads",async t=>{try{if(!t.env.DB)return t.json({error:"Database non configurato"},400);console.log("üßπ PULIZIA LEAD DI TEST - V2");const o=await t.env.DB.prepare("SELECT COUNT(*) as count FROM leads").first();console.log(`Total leads in DB: ${o==null?void 0:o.count}`);const e=["LEAD_2025-12-25T211955823Z_C4VLK9","LEAD_2025-12-25T205008061Z_GC3563","LEAD_2025-12-25T204957004Z_MCNVSH","LEAD_2025-12-25T204530619Z_KJST6F","LEAD_2025-12-25T204200079Z_HFTDIQ","LEAD_2025-12-25T204149484Z_EDTLYT","LEAD_2025-12-25T204138898Z_RWZOGD","LEAD_2025-12-25T191135691Z_3XBNDO","LEAD_2025-12-25T191125265Z_MDFQCB","LEAD_2025-12-25T191114705Z_1EMLUN","LEAD_2025-12-25T191104119Z_0PRENZ","LEAD_2025-12-25T191053824Z_1EMY2G","LEAD_2025-12-25T191043239Z_2GUQGY","LEAD_2025-12-25T190029962Z_MK0N5L","LEAD_2025-12-25T190019474Z_QPO1PP","LEAD_2025-12-25T190008673Z_J6WGQ7","LEAD_2025-12-25T185958232Z_TL9HI0","LEAD_2025-12-25T185947909Z_51TB7B","LEAD_2025-12-25T185937335Z_WVBB9C","LEAD_2025-12-25T185909045Z_B0RLKE","LEAD_2025-12-25T110812797Z_F4AKJJ","LEAD_2025-12-25T110806573Z_UZWPR7","LEAD_2025-12-25T110800010Z_GLN8TE","LEAD_2025-12-25T110753291Z_5LVK65","LEAD_2025-12-25T110747228Z_3ZH8MR","LEAD_2025-12-25T110740528Z_PJ2JAS","LEAD_2025-12-25T082713825Z_4BRLYS","LEAD_2025-12-25T081934276Z_BKRE1H","LEAD_2025-12-25T081929110Z_HONW32","LEAD_2025-12-25T081923493Z_RBMKJ3","LEAD_2025-12-25T081917580Z_WY85K2","LEAD_2025-12-25T081912413Z_EWJWFJ","LEAD_2025-12-25T081904985Z_YXKTV1","LEAD_2025-12-22T075325154Z_0FSCAC","LEAD_2025-12-22T075220985Z_RA98UA","LEAD_2025-12-22T074037336Z_A6PRYV","LEAD_2025-12-22T074026814Z_N6NYWS","LEAD_2025-12-22T074016420Z_CNFCRN","LEAD_2025-12-22T074005330Z_DZII12","LEAD_2025-12-22T073954606Z_AZ2NXW","LEAD_2025-12-22T073943463Z_VKX7SP","LEAD_2025-12-21T225832616Z_15B4MT","LEAD_2025-12-21T225632332Z_NCQS0S","LEAD_2025-12-21T225426679Z_FOJF8R","LEAD_2025-12-21T222542567Z_GINYUY","LEAD_2025-12-21T221615529Z_YCEMIR","LEAD_2025-12-21T221239376Z_1JXGFE","LEAD_2025-12-21T220926109Z_0NIBT3","LEAD_2025-12-21T220107841Z_U7VODT","LEAD_2025-12-21T215428385Z_PIDJ7A","LEAD_2025-12-21T215403514Z_Q7FEQO","LEAD_2025-12-21T215332077Z_MZGRVW","LEAD_2025-12-21T194424688Z_1OHRLH","LEAD_2025-12-21T194318487Z_GXDVLZ","LEAD_2025-12-21T194010151Z_V7T12E","LEAD_2025-12-21T194006055Z_JS7R1F","LEAD_2025-12-21T193328137Z_1YRV4T","LEAD_2025-12-21T192929893Z_F9QWRN","LEAD_2025-12-21T192649104Z_80UJ2Z","LEAD_2025-12-21T132228882Z_RU8VL9","LEAD_2025-12-21T125004976Z_JDYS7F","LEAD_2025-12-21T124957602Z_QO8HRV","LEAD_2025-12-21T124921945Z_Q072Y6"],a=e.slice(0,3);console.log(`Test leads to delete: ${a.length} (total available: ${e.length})`);let i=0,r=0;for(const l of a)try{console.log(`Deleting lead: ${l}`);const d=await t.env.DB.prepare("DELETE FROM contracts WHERE leadId = ?").bind(l).run();console.log(`  Contracts deleted: ${d.meta.changes}`);const c=await t.env.DB.prepare("DELETE FROM proforma WHERE leadId = ?").bind(l).run();console.log(`  Proforma deleted: ${c.meta.changes}`);const u=await t.env.DB.prepare("DELETE FROM dispositivi WHERE leadId = ?").bind(l).run();console.log(`  Dispositivi deleted: ${u.meta.changes}`);const p=await t.env.DB.prepare("DELETE FROM leads WHERE id = ?").bind(l).run();console.log(`  Lead deleted: ${p.meta.changes}`),p.meta.changes>0?i++:(console.log(`  WARNING: Lead ${l} not found in DB!`),r++)}catch(d){console.error(`Error deleting lead ${l}:`,d),r++}console.log(`‚úÖ Eliminati ${i} lead di test, ${r} non trovati`);const s=await t.env.DB.prepare("SELECT COUNT(*) as count FROM leads").first();return t.json({success:!0,deleted:i,remaining:(s==null?void 0:s.count)||0,message:`Eliminati ${i} lead di test. Rimangono ${(s==null?void 0:s.count)||0} lead dall'Excel (attesi 126).`})}catch(o){return console.error("‚ùå Errore pulizia:",o),t.json({success:!1,error:"Errore durante pulizia",details:o instanceof Error?o.message:String(o)},500)}});I.get("/api/admin/leads-dashboard",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!0,dashboard:{kpi:{leadsTotali:0,scoreMedio:0},analytics:{partners:[],channels:[]},modules:{conversion:0,reports:0}}});const e=await t.env.DB.prepare("SELECT COUNT(*) as count FROM leads").first(),a=(e==null?void 0:e.count)||0,r=(await t.env.DB.prepare(`
      SELECT COALESCE(fonte, 'Sconosciuto') as canale, COUNT(*) as count 
      FROM leads 
      GROUP BY fonte
      ORDER BY count DESC
    `).all()).results||[],s=await t.env.DB.prepare(`
      SELECT COUNT(DISTINCT fonte) as count FROM leads 
      WHERE fonte LIKE '%Partner%' OR fonte LIKE '%Affiliato%'
    `).first(),l=(s==null?void 0:s.count)||0,d=await t.env.DB.prepare(`
      SELECT COUNT(*) as count FROM leads 
      WHERE status IN ('CONTRATTO_FIRMATO', 'IN_ATTESA_PAGAMENTO', 'ATTIVO')
    `).first(),c=(d==null?void 0:d.count)||0;return t.json({success:!0,dashboard:{kpi:{leadsTotali:a,scoreMedio:7.2},analytics:{partners:Array(l).fill(null).map((u,p)=>({id:p+1})),channels:r},modules:{conversion:c,reports:a}}})}catch(e){return console.error("‚ùå Errore dashboard leads:",e),t.json({success:!1,error:"Errore recupero statistiche",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/admin/run-migrations",async t=>{try{if(!t.env.DB)return t.json({error:"Database non configurato"},500);console.log("üîß [MIGRATIONS] Inizio esecuzione migrations");const o=[];await t.env.DB.prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='contracts'").first()?o.push("‚ÑπÔ∏è Tabella contracts gi√† esistente"):(console.log("üìã [MIGRATIONS] Tabella contracts NON esiste. Creazione in corso..."),await t.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS contracts (
          id TEXT PRIMARY KEY,
          lead_id TEXT NOT NULL,
          contract_code TEXT UNIQUE NOT NULL,
          contract_type TEXT,
          nome_cliente TEXT,
          cognome_cliente TEXT,
          email_cliente TEXT,
          servizio TEXT,
          piano TEXT,
          dispositivo TEXT,
          prezzo_base REAL,
          prezzo_iva_inclusa REAL,
          contract_html TEXT,
          status TEXT DEFAULT 'PENDING',
          signature_data TEXT,
          signature_ip TEXT,
          signature_timestamp TEXT,
          signature_user_agent TEXT,
          signature_screen_resolution TEXT,
          signature_method TEXT DEFAULT 'inline',
          signed_at TEXT,
          created_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
      `).run(),o.push("‚úÖ Tabella contracts creata"),await t.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_contracts_lead_id ON contracts(lead_id)").run(),await t.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_contracts_status ON contracts(status)").run(),await t.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_contracts_code ON contracts(contract_code)").run(),o.push("‚úÖ Indici contracts creati")),await t.env.DB.prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='document_templates'").first()?o.push("‚ÑπÔ∏è Tabella document_templates gi√† esistente"):(console.log("üìã [MIGRATIONS] Tabella document_templates NON esiste. Creazione in corso..."),await t.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS document_templates (
          id TEXT PRIMARY KEY,
          name TEXT NOT NULL,
          type TEXT NOT NULL,
          subject TEXT,
          html_content TEXT NOT NULL,
          variables TEXT,
          category TEXT,
          active INTEGER DEFAULT 1,
          created_at TEXT DEFAULT CURRENT_TIMESTAMP,
          updated_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
      `).run(),o.push("‚úÖ Tabella document_templates creata"),await t.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_document_templates_type ON document_templates(type)").run(),await t.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_document_templates_category ON document_templates(category)").run(),await t.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_document_templates_active ON document_templates(active)").run(),o.push("‚úÖ Indici creati"),await t.env.DB.prepare(`
        INSERT INTO document_templates (id, name, type, subject, html_content, variables, category, active)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
      `).bind("email_notifica_info","Notifica Nuovo Lead","email","Nuovo Lead Ricevuto: {{NOME_CLIENTE}} {{COGNOME_CLIENTE}}","<!DOCTYPE html><html><body><h2>Nuovo Lead Ricevuto</h2><p><strong>Cliente:</strong> {{NOME_CLIENTE}} {{COGNOME_CLIENTE}}</p><p><strong>Email:</strong> {{EMAIL_CLIENTE}}</p><p><strong>Telefono:</strong> {{TELEFONO_CLIENTE}}</p><p><strong>Servizio:</strong> {{SERVIZIO_RICHIESTO}}</p><p><strong>ID Lead:</strong> {{LEAD_ID}}</p><p><strong>Data:</strong> {{TIMESTAMP_LEAD}}</p><p><strong>Note:</strong> {{NOTE}}</p></body></html>",'["NOME_CLIENTE","COGNOME_CLIENTE","EMAIL_CLIENTE","TELEFONO_CLIENTE","SERVIZIO_RICHIESTO","LEAD_ID","TIMESTAMP_LEAD","NOTE"]',"notification",1).run(),o.push("‚úÖ Template email_notifica_info inserito"),await t.env.DB.prepare(`
        INSERT INTO document_templates (id, name, type, subject, html_content, variables, category, active)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
      `).bind("email_invio_contratto","Invio Contratto","email","eCura - Il tuo contratto √® pronto","<!DOCTYPE html><html><body><h2>Ciao {{NOME_CLIENTE}},</h2><p>Il contratto per il servizio <strong>{{PIANO_SERVIZIO}}</strong> √® allegato a questa email.</p><p><strong>Importo:</strong> {{PREZZO_PIANO}}</p><p><strong>Codice Cliente:</strong> {{CODICE_CLIENTE}}</p><p>Cordiali saluti,<br>Team eCura</p></body></html>",'["NOME_CLIENTE","PIANO_SERVIZIO","PREZZO_PIANO","CODICE_CLIENTE"]',"contract",1).run(),o.push("‚úÖ Template email_invio_contratto inserito")),await t.env.DB.prepare("SELECT id FROM document_templates WHERE id = 'email_documenti_informativi'").first()?o.push("‚ÑπÔ∏è Template email_documenti_informativi gi√† esistente"):(console.log("üìß [MIGRATIONS] Template email_documenti_informativi mancante. Inserimento..."),await t.env.DB.prepare(`
        INSERT INTO document_templates (id, name, type, subject, html_content, variables, category, active, created_at, updated_at)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `).bind("email_documenti_informativi","Invio Documenti Informativi","email","eCura - Documentazione richiesta",'<!DOCTYPE html><html lang="it"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Documentazione eCura</title></head><body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;"><div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;"><h1 style="color: white; margin: 0; font-size: 28px;">Documentazione eCura</h1></div><div style="background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px;"><p style="font-size: 16px; margin-bottom: 20px;">Gentile <strong>{{NOME_CLIENTE}} {{COGNOME_CLIENTE}}</strong>,</p><p style="font-size: 16px; margin-bottom: 20px;">Come da Lei richiesto, alleghiamo la documentazione informativa relativa al servizio <strong>{{PIANO_SERVIZIO}}</strong>.</p><div style="background: white; border-left: 4px solid #667eea; padding: 15px; margin: 20px 0;"><p style="margin: 0; font-size: 14px; color: #666;"><strong>Documenti allegati:</strong><br>{{DOCUMENTI_ALLEGATI}}</p></div><p style="font-size: 16px; margin-bottom: 20px;">Per qualsiasi domanda o chiarimento, non esiti a contattarci.</p><p style="font-size: 16px; margin-bottom: 10px;">Cordiali saluti,<br><strong>Il Team eCura</strong></p></div><div style="text-align: center; padding: 20px; font-size: 12px; color: #666;"><p style="margin: 5px 0;">eCura by TeleMedCare</p><p style="margin: 5px 0;">info@telemedcare.it</p></div></body></html>','["NOME_CLIENTE", "COGNOME_CLIENTE", "PIANO_SERVIZIO", "DOCUMENTI_ALLEGATI"]',"informative",1,"2026-01-02 09:35:00","2026-01-02 09:35:00").run(),o.push("‚úÖ Template email_documenti_informativi inserito"));const r=await t.env.DB.prepare("SELECT id, name, category, created_at FROM document_templates ORDER BY created_at DESC").all();return console.log("‚úÖ [MIGRATIONS] Completate con successo!"),t.json({success:!0,message:"Migrations eseguite con successo",results:o,templates:r.results})}catch(o){return console.error("‚ùå [MIGRATIONS] Errore:",o),t.json({success:!1,error:"Errore durante esecuzione migrations",details:o instanceof Error?o.message:String(o)},500)}});I.post("/api/admin/add-signature-columns",async t=>{try{if(!t.env.DB)return t.json({error:"Database non configurato"},500);console.log("üîß [MIGRATION 0030] Aggiunta colonne firma digitale");const o=[];try{await t.env.DB.prepare("ALTER TABLE contracts ADD COLUMN signature_data TEXT").run(),o.push("‚úÖ Colonna signature_data aggiunta")}catch{o.push("‚ÑπÔ∏è Colonna signature_data gi√† esistente")}try{await t.env.DB.prepare("ALTER TABLE contracts ADD COLUMN signature_ip TEXT").run(),o.push("‚úÖ Colonna signature_ip aggiunta")}catch{o.push("‚ÑπÔ∏è Colonna signature_ip gi√† esistente")}try{await t.env.DB.prepare("ALTER TABLE contracts ADD COLUMN signature_timestamp TEXT").run(),o.push("‚úÖ Colonna signature_timestamp aggiunta")}catch{o.push("‚ÑπÔ∏è Colonna signature_timestamp gi√† esistente")}try{await t.env.DB.prepare("ALTER TABLE contracts ADD COLUMN signature_user_agent TEXT").run(),o.push("‚úÖ Colonna signature_user_agent aggiunta")}catch{o.push("‚ÑπÔ∏è Colonna signature_user_agent gi√† esistente")}try{await t.env.DB.prepare("ALTER TABLE contracts ADD COLUMN signature_screen_resolution TEXT").run(),o.push("‚úÖ Colonna signature_screen_resolution aggiunta")}catch{o.push("‚ÑπÔ∏è Colonna signature_screen_resolution gi√† esistente")}try{await t.env.DB.prepare("ALTER TABLE contracts ADD COLUMN signed_at TEXT").run(),o.push("‚úÖ Colonna signed_at aggiunta")}catch{o.push("‚ÑπÔ∏è Colonna signed_at gi√† esistente")}try{await t.env.DB.prepare("ALTER TABLE contracts ADD COLUMN signature_method TEXT DEFAULT 'inline'").run(),o.push("‚úÖ Colonna signature_method aggiunta")}catch{o.push("‚ÑπÔ∏è Colonna signature_method gi√† esistente")}try{await t.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_contracts_signed_at ON contracts(signed_at)").run(),o.push("‚úÖ Indice idx_contracts_signed_at creato")}catch{o.push("‚ö†Ô∏è Errore creazione indice idx_contracts_signed_at")}try{await t.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_contracts_signature_timestamp ON contracts(signature_timestamp)").run(),o.push("‚úÖ Indice idx_contracts_signature_timestamp creato")}catch{o.push("‚ö†Ô∏è Errore creazione indice idx_contracts_signature_timestamp")}return console.log("‚úÖ [MIGRATION 0030] Completata"),t.json({success:!0,message:"Migration 0030 completata",results:o})}catch(o){return console.error("‚ùå [MIGRATION 0030] Errore:",o),t.json({success:!1,error:"Errore durante migration 0030",details:o instanceof Error?o.message:String(o)},500)}});I.post("/api/admin/test-email",async t=>{try{const{to:o}=await t.req.json().catch(()=>({to:"rpoggi55@gmail.com"}));console.log(`üìß [TEST EMAIL] Invio email di test a: ${o}`);const a=await new Xe(t.env).sendEmail({to:o,from:"info@telemedcare.it",subject:"üß™ Test Email - TeleMedCare",html:`
        <h1>Test Email</h1>
        <p>Questa √® un'email di test inviata da TeleMedCare il ${new Date().toISOString()}</p>
        <p><strong>API Keys disponibili:</strong></p>
        <ul>
          <li>SENDGRID_API_KEY: ${t.env.SENDGRID_API_KEY?"‚úÖ Configurata":"‚ùå Mancante"}</li>
          <li>RESEND_API_KEY: ${t.env.RESEND_API_KEY?"‚úÖ Configurata":"‚ùå Mancante (usando fallback)"}</li>
        </ul>
      `,text:"Test email"});return t.json({success:a.success,messageId:a.messageId,timestamp:a.timestamp,error:a.error,config:{sendgrid:t.env.SENDGRID_API_KEY?"configured":"missing",resend:t.env.RESEND_API_KEY?"configured":"fallback"}})}catch(o){return console.error("‚ùå [TEST EMAIL] Errore:",o),t.json({success:!1,error:o instanceof Error?o.message:String(o)},500)}});I.post("/api/admin/update-template",async t=>{var o;try{const{templateId:e,htmlContent:a}=await t.req.json();if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);if(!e||!a)return t.json({success:!1,error:"templateId e htmlContent richiesti"},400);console.log(`üìù Aggiornamento template: ${e} (${a.length} chars)`);const i=await t.env.DB.prepare(`
      UPDATE document_templates 
      SET html_content = ?,
          updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(a,e).run();return console.log(`‚úÖ Template ${e} aggiornato (changes: ${i.meta.changes})`),t.json({success:!0,templateId:e,updated:!0,changes:i.meta.changes})}catch(e){return console.error("‚ùå Errore aggiornamento template:",e),t.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.post("/api/admin/fix-fonte-irbema",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üîß Correzione fonte: HUBSPOT ‚Üí Form eCura");const e=await t.env.DB.prepare(`
      UPDATE leads 
      SET fonte = 'Form eCura'
      WHERE (fonte = 'HUBSPOT' OR fonte LIKE 'HubSpot%' OR fonte IS NULL OR fonte = '' OR fonte = 'IRBEMA')
        AND id LIKE 'LEAD-IRBEMA-%'
    `).run();return console.log(`‚úÖ Fonte aggiornata per ${e.meta.changes} lead`),t.json({success:!0,message:"Fonte aggiornata da HUBSPOT a IRBEMA",leadsUpdated:e.meta.changes})}catch(e){return console.error("‚ùå Errore correzione fonte:",e),t.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.post("/api/admin/fix-test-leads",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üîß Aggiornamento fonte lead di TEST ‚Üí Form eCura x Test");const e=await t.env.DB.prepare(`
      UPDATE leads 
      SET fonte = 'Form eCura x Test'
      WHERE (
        (nomeRichiedente = 'Rosaria' AND cognomeRichiedente = 'Ressa')
        OR (nomeRichiedente = 'Roberto' AND cognomeRichiedente = 'Poggi')
        OR (nomeRichiedente = 'Stefania' AND cognomeRichiedente = 'Rocca')
        OR id = 'LEAD-IRBEMA-00107'
      )
      AND fonte != 'Form eCura x Test'
    `).run();return console.log(`‚úÖ Fonte aggiornata per ${e.meta.changes} lead di test`),t.json({success:!0,message:'Lead di TEST aggiornati a fonte "Form eCura x Test"',leadsUpdated:e.meta.changes})}catch(e){return console.error("‚ùå Errore aggiornamento lead test:",e),t.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.post("/api/admin/restore-real-leads",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üîß Ripristino lead reali erroneamente marcati come test");const e=await t.env.DB.prepare(`
      UPDATE leads 
      SET fonte = 'Privati IRBEMA'
      WHERE id = 'LEAD-IRBEMA-00051'
        AND fonte != 'Privati IRBEMA'
    `).run();return console.log(`‚úÖ Ripristinati ${e.meta.changes} lead reali`),t.json({success:!0,message:'Lead reali ripristinati a fonte "Privati IRBEMA"',leadsRestored:e.meta.changes,restoredIds:["LEAD-IRBEMA-00051"]})}catch(e){return console.error("‚ùå Errore ripristino lead reali:",e),t.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.post("/api/admin/normalize-settings-values",async t=>{var o,e,a;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üîß Normalizzazione valori settings: 1/0 ‚Üí true/false");const i=await t.env.DB.prepare(`
      UPDATE settings SET value = 'true' WHERE value IN ('1', 1)
    `).run(),r=await t.env.DB.prepare(`
      UPDATE settings SET value = 'false' WHERE value IN ('0', 0)
    `).run(),s=(((e=i.meta)==null?void 0:e.changes)||0)+(((a=r.meta)==null?void 0:a.changes)||0);return console.log(`‚úÖ Normalizzati ${s} valori`),t.json({success:!0,message:"Valori settings normalizzati a true/false",settingsUpdated:s})}catch(i){return console.error("‚ùå Errore conversione settings:",i),t.json({success:!1,error:i instanceof Error?i.message:String(i)},500)}});I.post("/api/admin/init-settings",async t=>{var o,e,a;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üîß Inizializzazione settings switch dashboard");const i=await t.env.DB.prepare(`
      INSERT OR IGNORE INTO settings (key, value, description, updated_at) VALUES 
        ('hubspot_auto_import_enabled', 'false', 'Abilita import automatico da HubSpot', datetime('now')),
        ('lead_email_notifications_enabled', 'false', 'Abilita invio email automatiche ai lead', datetime('now')),
        ('admin_email_notifications_enabled', 'true', 'Abilita notifiche email a info@telemedcare.it', datetime('now'))
    `).run();return console.log(`‚úÖ Settings inizializzati (changes: ${((e=i.meta)==null?void 0:e.changes)||0})`),t.json({success:!0,message:"Settings inizializzati correttamente",settingsAdded:((a=i.meta)==null?void 0:a.changes)||0})}catch(i){return console.error("‚ùå Errore inizializzazione settings:",i),t.json({success:!1,error:i instanceof Error?i.message:String(i)},500)}});I.post("/api/admin/update-template/:templateId",async t=>{var o;try{const e=t.req.param("templateId"),{html_content:a}=await t.req.json();if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);if(!a)return t.json({success:!1,error:"html_content richiesto"},400);console.log(`üìù Aggiornamento template: ${e} (${a.length} chars)`);const i=await t.env.DB.prepare(`
      UPDATE document_templates 
      SET html_content = ?,
          updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(a,e).run();return console.log(`‚úÖ Template ${e} aggiornato`),t.json({success:!0,templateId:e,updated:!0,changes:i.meta.changes})}catch(e){return console.error("‚ùå Errore aggiornamento template:",e),t.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.get("/api/admin/debug-env",async t=>{try{return t.json({environment:t.env.ENVIRONMENT||"not set",hasDB:!!t.env.DB,hasResendKey:!!t.env.RESEND_API_KEY,hasSendgridKey:!!t.env.SENDGRID_API_KEY,resendKeyPreview:t.env.RESEND_API_KEY?`${t.env.RESEND_API_KEY.substring(0,15)}...`:"NOT SET",sendgridKeyPreview:t.env.SENDGRID_API_KEY?`${t.env.SENDGRID_API_KEY.substring(0,15)}...`:"NOT SET",allEnvKeys:Object.keys(t.env||{}).filter(o=>!o.includes("SECRET")&&!o.includes("KEY"))})}catch(o){return t.json({error:o instanceof Error?o.message:String(o)},500)}});I.get("/api/admin/debug-resend",async t=>{try{const o=t.env.RESEND_API_KEY;console.log("üîç [DEBUG RESEND] Testing Resend API..."),console.log("üîë API Key presente:",o?"SI":"NO"),console.log("üîë API Key preview:",o?`${o.substring(0,10)}...`:"NONE");const e={from:"TeleMedCare <info@telemedcare.it>",to:["rpoggi55@gmail.com"],subject:"üîç Debug Test - Resend diretto da Cloudflare",html:`
        <h1>Debug Test</h1>
        <p>Questa email √® stata inviata direttamente da Cloudflare Workers usando Resend.</p>
        <p><strong>Timestamp:</strong> ${new Date().toISOString()}</p>
        <p><strong>API Key usata:</strong> ${o.substring(0,15)}...</p>
        <p><strong>Environment:</strong> ${t.env.ENVIRONMENT||"production"}</p>
      `};console.log("üì§ [DEBUG RESEND] Sending request to Resend API...");const a=await fetch("https://api.resend.com/emails",{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify(e)}),i=await a.text();if(console.log("üì• [DEBUG RESEND] Response status:",a.status),console.log("üì• [DEBUG RESEND] Response body:",i),!a.ok)return t.json({success:!1,status:a.status,error:i,apiKey:`${o.substring(0,15)}...`,message:"Resend API returned error"},a.status);const r=JSON.parse(i);return t.json({success:!0,messageId:r.id,status:a.status,apiKey:`${o.substring(0,15)}...`,message:"Email inviata con successo! Controlla rpoggi55@gmail.com"})}catch(o){return console.error("‚ùå [DEBUG RESEND] Errore:",o),t.json({success:!1,error:o instanceof Error?o.message:String(o),stack:o instanceof Error?o.stack:void 0},500)}});I.post("/api/admin/reset-and-regenerate",async t=>{var o,e;try{if(!t.env.DB)return t.json({error:"Database non configurato"},400);console.log("üîÑ INIZIO RESET COMPLETO SISTEMA"),await t.env.DB.prepare("PRAGMA foreign_keys = OFF").run();try{await t.env.DB.prepare("DELETE FROM proforma").run()}catch(c){console.log("Tabella proforma:",c.message)}try{await t.env.DB.prepare("DELETE FROM contracts").run()}catch(c){console.log("Tabella contracts:",c.message)}try{await t.env.DB.prepare("DELETE FROM dispositivi").run()}catch(c){console.log("Tabella dispositivi:",c.message)}try{await t.env.DB.prepare("DELETE FROM leads").run()}catch(c){console.log("Tabella leads:",c.message)}try{await t.env.DB.prepare("DELETE FROM document_repository").run()}catch(c){console.log("Tabella document_repository:",c.message)}await t.env.DB.prepare("PRAGMA foreign_keys = ON").run(),console.log("‚úÖ Tutti i dati cancellati");const a=["TeleAssistenza Base","TeleAssistenza Premium","TeleAssistenza Pro"],i=["Alta urgenza","Media urgenza","Bassa urgenza"];for(let c=1;c<=10;c++){const u=`LEAD_TEST_${Date.now()}_${c}`;await t.env.DB.prepare(`
        INSERT INTO leads (
          id, nomeRichiedente, cognomeRichiedente, email, telefono,
          nomeAssistito, cognomeAssistito, dataNascitaAssistito, pacchetto, priority,
          vuoleBrochure, vuoleManuale, vuoleContratto, created_at, updated_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'), datetime('now'))
      `).bind(u,`Cliente${c}`,`Test${c}`,`cliente${c}@telemedcare.test`,`+39 320 123 ${String(c).padStart(4,"0")}`,`Assistito${c}`,`Test${c}`,`1970-01-0${c%9+1}`,a[c%a.length],i[c%i.length],c%2===0?"Si":"No",c%3===0?"Si":"No",c<=6?"Si":"No").run()}console.log("‚úÖ 10 leads creati");const r=await t.env.DB.prepare('SELECT id FROM leads WHERE vuoleContratto = "Si" ORDER BY created_at DESC LIMIT 6').all();for(let c=1;c<=6;c++){const u=((o=r.results[c-1])==null?void 0:o.id)||`LEAD_TEST_${Date.now()}_${c}`;await t.env.DB.prepare(`
        INSERT INTO contracts (id, leadId, contractType, status, pdfGenerated, created_at)
        VALUES (?, ?, ?, ?, ?, datetime('now'))
      `).bind(`CONTRACT-TEST-00${c}`,u,"TeleMedCare Standard",c<=4?"SIGNED":"PENDING",!0).run()}console.log("‚úÖ 6 contratti creati (4 firmati, 2 pending)");const s=await t.env.DB.prepare('SELECT id FROM leads WHERE vuoleContratto = "Si" ORDER BY created_at DESC LIMIT 4').all();for(let c=1;c<=4;c++){const u=((e=s.results[c-1])==null?void 0:e.id)||`LEAD_TEST_${Date.now()}_${c}`;await t.env.DB.prepare(`
        INSERT INTO proforma (
          id, leadId, numero_proforma, data_emissione, data_scadenza,
          cliente_nome, cliente_cognome, cliente_email, 
          pacchetto_tipo, prezzo_mensile, prezzo_totale, status, created_at
        ) VALUES (?, ?, ?, DATE('now'), DATE('now', '+30 days'), ?, ?, ?, ?, ?, ?, ?, datetime('now'))
      `).bind(`PROF-TEST-00${c}`,u,`PROF-2024-10-${String(c).padStart(3,"0")}`,`Cliente${c}`,`Test${c}`,`cliente${c}@telemedcare.test`,"BASE",29.99,359.88,c<=3?"GENERATED":"DRAFT").run()}console.log("‚úÖ 4 proforma create (3 generate, 1 bozza)");for(let c=1;c<=2;c++)await t.env.DB.prepare(`
        UPDATE proforma SET 
          pagamento_ricevuto = TRUE,
          data_pagamento = datetime('now'),
          modalita_pagamento = 'credit_card',
          importo_pagato = prezzo_totale,
          status = 'ACCEPTED'
        WHERE id = ?
      `).bind(`PROF-TEST-00${c}`).run();console.log("‚úÖ 2 proforma aggiornate come pagate (completate)");const l=["INVENTORY","INVENTORY","INVENTORY","INVENTORY","INVENTORY","INVENTORY","ASSIGNED","SHIPPED","DELIVERED","ACTIVE"];for(let c=1;c<=10;c++)await t.env.DB.prepare(`
        INSERT INTO dispositivi (device_id, imei, model, status, created_at)
        VALUES (?, ?, ?, ?, datetime('now'))
      `).bind(`DM-202410${String(c).padStart(2,"0")}`,`86012345678901${String(c).padStart(2,"0")}`,`SiDLY Care Pro V12.0 #${c}`,l[c-1]).run();console.log("‚úÖ 10 dispositivi creati (6 inventory, 1 assigned, 1 shipped, 1 delivered, 1 active)");const d=[{id:"brochure_sidly_care_pro",name:"Brochure SiDLY Care Pro",type:"BROCHURE",deviceModel:"sidly-care-pro",description:"Brochure commerciale del dispositivo SiDLY Care Pro con specifiche tecniche e funzionalit√†",url:"/docs/brochure-sidly-care-pro.pdf",fileSize:"2.5 MB",language:"it",version:"2024.1",created_at:"2024-10-01 09:00:00"},{id:"manuale_sidly_care_pro",name:"Manuale Utente SiDLY Care Pro",type:"USER_MANUAL",deviceModel:"sidly-care-pro",description:"Manuale completo per utilizzo del dispositivo SiDLY Care Pro",url:"/docs/manuale-sidly-care-pro.pdf",fileSize:"8.2 MB",language:"it",version:"11.0",created_at:"2024-10-01 10:00:00"},{id:"manuale_telemedcare_base",name:"Manuale TeleMedCare Base",type:"SERVICE_MANUAL",deviceModel:"telemedcare-base",description:"Manuale del servizio TeleMedCare Base con procedure operative",url:"/docs/manuale-telemedcare-base.pdf",fileSize:"4.1 MB",language:"it",version:"11.0",created_at:"2024-10-01 11:00:00"},{id:"manuale_telemedcare_avanzato",name:"Manuale TeleMedCare Avanzato",type:"SERVICE_MANUAL",deviceModel:"telemedcare-avanzato",description:"Manuale del servizio TeleMedCare Avanzato con centrale operativa H24",url:"/docs/manuale-telemedcare-avanzato.pdf",fileSize:"6.3 MB",language:"it",version:"11.0",created_at:"2024-10-01 12:00:00"},{id:"certificazione_dm_sidly",name:"Certificazione Dispositivo Medico SiDLY",type:"CERTIFICATION",deviceModel:"sidly-care-pro",description:"Certificazione DM Classe IIA per SiDLY Care Pro (CDN Z12040199)",url:"/docs/certificazione-dm-sidly.pdf",fileSize:"1.8 MB",language:"it",version:"2024",created_at:"2024-10-01 13:00:00"}];try{await t.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS document_repository (
          id TEXT PRIMARY KEY,
          name TEXT NOT NULL,
          type TEXT NOT NULL,
          deviceModel TEXT,
          description TEXT,
          url TEXT NOT NULL,
          fileSize TEXT,
          language TEXT,
          version TEXT,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
      `).run();for(const c of d)await t.env.DB.prepare(`
          INSERT OR REPLACE INTO document_repository 
          (id, name, type, deviceModel, description, url, fileSize, language, version, created_at)
          VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(c.id,c.name,c.type,c.deviceModel,c.description,c.url,c.fileSize,c.language,c.version,c.created_at).run();console.log("‚úÖ 5 documenti TeleMedCare caricati nel repository")}catch(c){console.log("‚ö†Ô∏è Document repository non disponibile:",c.message)}return console.log("üéâ RESET COMPLETO - DATI COERENTI RICREATI"),console.log("üìä Riepilogo SISTEMA COMPLETO:"),console.log("   DATI: 10 leads ‚Üí 6 contratti ‚Üí 4 firmati ‚Üí 4 proforma ‚Üí 2 pagate"),console.log("   DISPOSITIVI: 10 totali (6 inventory, 1 assigned, 1 shipped, 1 delivered, 1 active)"),console.log("   DOCUMENTI: 5 nel repository (brochure, manuali, certificazioni)"),console.log("   LOGICA COERENTE: leads ‚â• contratti ‚â• firmati = proforma ‚â• pagamenti"),t.json({success:!0,message:"Sistema resettato con dati PERFETTAMENTE coerenti",summary:{leads:10,contracts:{total:6,signed:4,pending:2},proforma:{total:4,issued:3,draft:1},proforma_paid:{total:2,paid:2,pending:2},devices:{total:10,inventory:6,assigned:1,shipped:1,delivered:1,active:1},documents:{total:5,types:["BROCHURE","USER_MANUAL","SERVICE_MANUAL","CERTIFICATION"]}},logic:"leads(10) ‚â• contracts(6) ‚â• signed(4) = proforma(4) ‚â• paid(2) + docs(5)"})}catch(a){return console.error("‚ùå Errore durante reset sistema:",a),t.json({success:!1,error:"Errore durante reset sistema: "+a.message},500)}});I.post("/api/admin/clear-database",async t=>{try{if(!t.env.DB)return t.json({error:"Database non configurato"},400);console.log("üîÑ INIZIO PULIZIA COMPLETA DATABASE"),await t.env.DB.prepare("PRAGMA foreign_keys = OFF").run();let o={proforma:0,contracts:0,dispositivi:0,leads:0,document_repository:0};try{const e=await t.env.DB.prepare("DELETE FROM proforma").run();o.proforma=e.meta.changes,console.log(`‚úÖ Proforma cancellate: ${e.meta.changes}`)}catch(e){console.log("‚ö†Ô∏è Tabella proforma:",e.message)}try{const e=await t.env.DB.prepare("DELETE FROM contracts").run();o.contracts=e.meta.changes,console.log(`‚úÖ Contratti cancellati: ${e.meta.changes}`)}catch(e){console.log("‚ö†Ô∏è Tabella contracts:",e.message)}try{const e=await t.env.DB.prepare("DELETE FROM dispositivi").run();o.dispositivi=e.meta.changes,console.log(`‚úÖ Dispositivi cancellati: ${e.meta.changes}`)}catch(e){console.log("‚ö†Ô∏è Tabella dispositivi:",e.message)}try{const e=await t.env.DB.prepare("DELETE FROM leads").run();o.leads=e.meta.changes,console.log(`‚úÖ Lead cancellati: ${e.meta.changes}`)}catch(e){console.log("‚ö†Ô∏è Tabella leads:",e.message)}try{const e=await t.env.DB.prepare("DELETE FROM document_repository").run();o.document_repository=e.meta.changes,console.log(`‚úÖ Documenti cancellati: ${e.meta.changes}`)}catch(e){console.log("‚ö†Ô∏è Tabella document_repository:",e.message)}return await t.env.DB.prepare("PRAGMA foreign_keys = ON").run(),console.log("‚úÖ DATABASE COMPLETAMENTE PULITO - Pronto per import Excel"),t.json({success:!0,message:"Database pulito con successo. Pronto per importare 126 lead dall'Excel.",deleted:o,total:Object.values(o).reduce((e,a)=>e+a,0)})}catch(o){return console.error("‚ùå Errore durante pulizia database:",o),t.json({success:!1,error:"Errore durante pulizia database: "+o.message},500)}});async function d0(t,o){var e;try{console.log(`üîç Controllo stato "non risponde" per lead ${o}`);const a=await t.prepare("SELECT note, notes FROM leads WHERE id = ?").bind(o).first(),i=((a==null?void 0:a.note)||(a==null?void 0:a.notes)||"").toLowerCase();if(console.log(`üîç Note del lead ${o}: "${i.substring(0,100)}"`),i.includes("non risponde")){console.log(`üìµ Trovato "non risponde" nelle note del lead ${o}`),await t.prepare("UPDATE leads SET stato = ?, updated_at = ? WHERE id = ?").bind("non_risponde",new Date().toISOString(),o).run(),console.log(`‚úÖ Stato aggiornato a "non_risponde" per lead ${o}`);return}const r=await t.prepare("SELECT nota, azione FROM lead_interactions WHERE lead_id = ? ORDER BY data DESC").bind(o).all();console.log(`üîç Trovate ${((e=r.results)==null?void 0:e.length)||0} interazioni per lead ${o}`);for(const s of r.results||[]){const l=(s.nota||"").toLowerCase(),d=(s.azione||"").toLowerCase();if(console.log(`üîç Interazione: nota="${l.substring(0,50)}", azione="${d.substring(0,50)}"`),l.includes("non risponde")||d.includes("non risponde")){console.log(`üìµ Trovato "non risponde" nelle interazioni del lead ${o}`),await t.prepare("UPDATE leads SET stato = ?, updated_at = ? WHERE id = ?").bind("non_risponde",new Date().toISOString(),o).run(),console.log(`‚úÖ Stato aggiornato a "non_risponde" per lead ${o}`);return}}console.log(`‚ÑπÔ∏è Nessun "non risponde" trovato per lead ${o}`)}catch(a){console.error(`‚ùå Errore controllo stato "non risponde" per lead ${o}:`,a)}}I.get("/api/leads",async t=>{var o,e;try{if(!t.env.DB)return t.json({success:!1,error:"Database D1 non configurato - modalit√† development"},400);const a=t.req.query("limit")||"100",i=await t.env.DB.prepare("SELECT COUNT(*) as total FROM leads").first(),r=(i==null?void 0:i.total)||0,s=await t.env.DB.prepare("SELECT * FROM leads ORDER BY timestamp DESC LIMIT ?").bind(parseInt(a)).all();return console.log("üìä Leads recuperati:",((o=s.results)==null?void 0:o.length)||0,"di",r,"totali"),t.json({success:!0,total:r,count:((e=s.results)==null?void 0:e.length)||0,leads:s.results||[]})}catch(a){return console.error("‚ùå Errore recupero leads:",a),t.json({success:!1,error:"Errore recupero dati"},500)}});I.post("/api/leads/import-bulk",async t=>{try{if(!t.env.DB)return t.json({success:!1,error:"Database D1 non configurato"},400);const o=await t.req.json(),{leads:e}=o;if(!e||!Array.isArray(e))return t.json({success:!1,error:'Payload invalido: array "leads" richiesto'},400);console.log(`üöÄ Import bulk: ${e.length} lead...`);let a=0,i=0;const r=[];for(let s=0;s<e.length;s+=20){const l=e.slice(s,s+20);for(const d of l)try{const{id:c,nomeRichiedente:u,cognomeRichiedente:p,email:g,telefono:m,fonte:b,tipoServizio:h,status:E,note:w,created_at:S}=d;await t.env.DB.prepare(`
            INSERT INTO leads (
              id, nomeRichiedente, cognomeRichiedente, email, telefono,
              fonte, tipoServizio, status, note,
              created_at, updated_at, timestamp
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          `).bind(c,u||"",p||"",g||"",m||"",b||"EXCEL_IMPORT",h||"eCura PRO",E||"NEW",w||"",S||new Date().toISOString(),S||new Date().toISOString(),S||new Date().toISOString()).run(),a++}catch(c){i++,r.push({lead:d.id,error:c.message})}}return console.log(`‚úÖ Import completato: ${a} successi, ${i} errori`),t.json({success:!0,imported:a,errors:i,errorDetails:r})}catch(o){return console.error("‚ùå Errore import bulk:",o),t.json({success:!1,error:o.message||"Errore import bulk"},500)}});I.post("/api/leads/clean-import",async t=>{try{const{DB:o}=t.env;if(!o)return t.json({success:!1,error:"Database D1 non configurato"},400);console.log("üîÑ CLEAN IMPORT: Inizio cancellazione e reimport da Excel..."),console.log("üóëÔ∏è  Step 1: Cancellazione lead esistenti...");const e=await o.prepare("DELETE FROM leads").run();console.log(`‚úÖ Cancellati ${e.changes||0} lead esistenti`);const i=(await t.req.json()).leads||[];if(!Array.isArray(i)||i.length===0)return t.json({success:!1,error:'Nessun lead fornito nel body. Usa { "leads": [...] }'},400);console.log(`üì• Step 2: Import di ${i.length} lead dall'Excel...`);let r=0,s=0;const l=[];for(let d=0;d<i.length;d+=20){const c=i.slice(d,d+20);for(const u of c)try{const p=(u.nome||"").split(" "),g=p[0]||"",m=p.slice(1).join(" ")||"";await o.prepare(`
            INSERT INTO leads (
              id, nomeRichiedente, cognomeRichiedente, email, telefono, 
              fonte, tipoServizio, status, note, 
              created_at, updated_at, timestamp
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          `).bind(u.id,g,m,u.email||"",u.telefono||"",u.canale||"IRBEMA","eCura PRO",u.status||"NEW",u.note||"",u.data_arrivo,u.data_arrivo,new Date(u.data_arrivo).getTime()).run(),r++}catch(p){console.error(`‚ùå Errore import lead ${u.id}:`,p.message),s++,l.push({id:u.id,nome:u.nome,error:p.message})}}return console.log(`‚úÖ CLEAN IMPORT completato: ${r} importati, ${s} errori`),t.json({success:!0,message:"Clean import completato",deleted:e.changes||0,imported:r,errors:s,errorDetails:l,total:i.length})}catch(o){return console.error("‚ùå Errore clean import:",o),t.json({success:!1,error:o.message||"Errore clean import"},500)}});I.post("/api/leads/import/:channel",async t=>{try{const o=t.req.param("channel");return t.json({success:!0,message:`Import da ${o} completato`,count:0,total:0,note:"Funzionalit√† di import automatico in fase di sviluppo. Utilizzare import manuale da Excel."})}catch(o){return console.error("‚ùå Errore import canale:",o),t.json({success:!1,error:o.message||"Errore import da canale"},500)}});I.post("/api/leads/clean-import-from-excel",async t=>{try{if(!t.env.DB)return t.json({success:!1,error:"Database D1 non configurato"},400);console.log("üóëÔ∏è Inizio cancellazione e reimport lead da Excel..."),console.log("üóëÔ∏è FASE 1: Cancellazione lead esistenti..."),await t.env.DB.prepare("DELETE FROM leads").run(),console.log("‚úÖ Tutti i lead esistenti sono stati cancellati"),console.log("üì• FASE 2: Import lead da Excel...");const o=await Promise.resolve().then(()=>HT),e=o.default.leads||o.leads||[];console.log(`üìä Trovati ${e.length} lead da importare`);let a=0,i=0;const r=[];for(let s=0;s<e.length;s+=20){const l=e.slice(s,s+20);for(const d of l)try{await t.env.DB.prepare(`
            INSERT INTO leads (
              id, nomeRichiedente, cognomeRichiedente, email, telefono,
              fonte, canale, tipoServizio, status, note,
              created_at, updated_at, timestamp
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          `).bind(d.id,d.nomeRichiedente||"",d.cognomeRichiedente||"",d.email||"",d.telefono||"",d.fonte||d.canale||"Form eCura",d.canale||"Form eCura",d.tipoServizio||"eCura PRO",d.status||"NEW",d.note||"",d.created_at,d.created_at,d.timestamp||d.created_at).run(),a++,a%20===0&&console.log(`üìä Importati ${a}/${e.length} lead...`)}catch(c){i++,r.push({lead:d.id,error:c.message}),console.error(`‚ùå Errore import lead ${d.id}:`,c.message)}}return console.log(`‚úÖ Import completato: ${a} importati, ${i} errori`),t.json({success:!0,imported:a,errors:i,errorDetails:r,message:`Import completato: ${a} lead importati dall'Excel con ID corretti`})}catch(o){return console.error("‚ùå Errore clean import:",o),t.json({success:!1,error:o.message||"Errore durante il clean import"},500)}});I.post("/api/leads/standardize-ids",async t=>{try{if(!t.env.DB)return t.json({success:!1,error:"Database D1 non configurato"},400);console.log("üîß Inizio standardizzazione ID lead...");const e=(await t.env.DB.prepare(`
      SELECT * FROM leads 
      ORDER BY 
        COALESCE(created_at, timestamp, updated_at) ASC,
        id ASC
    `).all()).results||[];console.log(`üìä Trovati ${e.length} lead da processare (ordinati per data di arrivo)`);const a={};for(const l of e){let d="WEB";const c=(l.id||"").toString().toUpperCase(),u=(l.fonte||"").toLowerCase(),p=`${l.nomeRichiedente||""} ${l.cognomeRichiedente||""}`.trim().toLowerCase();c.includes("IRBEMA")||u.includes("irbema")?d="IRBEMA":c.includes("EXCEL")||u.includes("excel")?d="EXCEL":c.includes("AON")||u.includes("aon")?d="AON":c.includes("DOUBLEYOU")||u.includes("doubleyou")||u.includes("double you")?d="DOUBLEYOU":p.includes("francesca grati")?d="WEB":p.includes("laura calvi")&&(d="NETWORKING"),a[d]||(a[d]=[]),a[d].push({...l,canale:d})}console.log("üìä Distribuzione per canale:"),Object.entries(a).forEach(([l,d])=>{console.log(`  - ${l}: ${d.length} lead`),d.length>0&&(console.log(`    Primi 5 lead di ${l}:`),d.slice(0,5).forEach((c,u)=>{const p=`${c.nomeRichiedente||""} ${c.cognomeRichiedente||""}`.trim(),g=c.created_at||c.timestamp||"NO DATA";console.log(`      ${u+1}. ${p} - ${g}`)}))});let i=0,r=0;const s={};for(const[l,d]of Object.entries(a)){console.log(`\\nüîß Processando canale ${l} (${d.length} lead)...`);for(let c=0;c<d.length;c++){const u=d[c],p=c+1,g=String(p).padStart(5,"0"),m=`LEAD-${l}-${g}`,b=(u.id||"").toString().toUpperCase();try{if(b===m){console.log(`‚è≠Ô∏è  Saltato (gi√† corretto): ${m}`),r++;continue}await t.env.DB.prepare(`
            UPDATE leads 
            SET id = ?, fonte = ?
            WHERE id = ?
          `).bind(m,l,u.id).run();const h=`${u.nomeRichiedente||""} ${u.cognomeRichiedente||""}`.trim();h.toLowerCase().includes("caterina")&&h.toLowerCase().includes("alterio")&&(console.log("üîç CATERINA D'ALTERIO TROVATA:"),console.log(`   Vecchio ID: ${u.id}`),console.log(`   Nuovo ID: ${m}`),console.log(`   Data: ${u.created_at||u.timestamp}`),console.log(`   Posizione: ${p}/${d.length}`)),console.log(`‚úÖ ${p}/${d.length} - Rinominato: ${u.id} -> ${m}`),i++}catch(h){console.error(`‚ùå Errore rinominando lead ${u.id}:`,h.message),r++}}s[l]=d.length}return console.log(`‚úÖ Standardizzazione completata: ${i} aggiornati, ${r} saltati`),t.json({success:!0,updated:i,skipped:r,channelCounters:s,message:`Standardizzazione completata: ${i} lead rinominati`})}catch(o){return console.error("‚ùå Errore standardizzazione ID:",o),t.json({success:!1,error:o.message||"Errore standardizzazione ID"},500)}});I.post("/api/leads/cleanup-family-duplicates",async t=>{try{if(!t.env.DB)return t.json({success:!1,error:"Database D1 non configurato"},400);console.log("üóëÔ∏è Pulizia duplicati familiari...");const o=await t.env.DB.prepare(`
      DELETE FROM leads WHERE id IN (
        'LEAD-EXCEL-018',
        'LEAD-EXCEL-031',
        'LEAD-EXCEL-028'
      )
    `).run();console.log(`‚úÖ Eliminati ${o.meta.changes} lead duplicati`);const e=await t.env.DB.prepare(`
      UPDATE leads 
      SET email = 'elenasaglia@hotmail.com',
          note = 'Lead creato da contratto PDF | TeleAssistenza Avanzato SIDLY | Data contratto: 08.05.2025 | Assistita: Elena Saglia (figlia) | Email contatto: elenasaglia@hotmail.com | Servizio: eCura PRO | Piano: AVANZATO | Dispositivo: SiDLY CARE PRO',
          updated_at = ?
      WHERE id = 'LEAD-CONTRATTO-003'
    `).bind(new Date().toISOString()).run();console.log("‚úÖ Aggiornato lead Eileen King");const a=await t.env.DB.prepare("SELECT COUNT(*) as total FROM leads").first();return t.json({success:!0,deleted:o.meta.changes,updated:e.meta.changes,totalLeads:(a==null?void 0:a.total)||0,message:"Pulizia duplicati completata con successo"})}catch(o){return console.error("‚ùå Errore pulizia duplicati:",o),t.json({success:!1,error:o.message||"Errore pulizia duplicati"},500)}});I.post("/api/leads/remove-assistiti-diretti",async t=>{try{if(!t.env.DB)return t.json({success:!1,error:"Database D1 non configurato"},400);console.log("üóëÔ∏è Rimozione 3 assistiti diretti...");const o=await t.env.DB.prepare(`
      DELETE FROM contracts WHERE id IN (
        'CONTRACT-BALZAROTTI-001',
        'CONTRACT-CAPONE-001',
        'CONTRACT-COZZI-001'
      )
    `).run();console.log(`‚úÖ Contratti eliminati: ${o.meta.changes}`);const e=await t.env.DB.prepare(`
      DELETE FROM leads WHERE id IN (
        'LEAD-ASSISTITO-001',
        'LEAD-ASSISTITO-002',
        'LEAD-ASSISTITO-003'
      )
    `).run();console.log(`‚úÖ Lead eliminati: ${e.meta.changes}`);const a=await t.env.DB.prepare("SELECT COUNT(*) as total FROM leads").first(),i=await t.env.DB.prepare("SELECT COUNT(*) as total FROM contracts").first();return t.json({success:!0,contractsDeleted:o.meta.changes,leadsDeleted:e.meta.changes,totalLeads:(a==null?void 0:a.total)||0,totalContracts:(i==null?void 0:i.total)||0,message:"Assistiti diretti rimossi - ora abbiamo 126 lead"})}catch(o){return console.error("‚ùå Errore rimozione assistiti:",o),t.json({success:!1,error:o.message||"Errore rimozione assistiti"},500)}});I.get("/api/contratti",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database D1 non configurato"},500);const e=await t.env.DB.prepare(`
      SELECT 
        c.id,
        c.codice_contratto as codice,
        c.tipo_contratto as tipo,
        c.status,
        c.piano,
        c.servizio,
        c.data_invio,
        c.data_scadenza,
        c.prezzo_totale,
        c.created_at,
        l.nomeRichiedente,
        l.cognomeRichiedente,
        l.email,
        s.timestamp_firma as data_firma
      FROM contracts c
      LEFT JOIN leads l ON c.leadId = l.id 
      LEFT JOIN signatures s ON c.id = s.contract_id
      ORDER BY c.created_at DESC LIMIT 100
    `).all();return t.json({success:!0,count:e.results.length,contratti:e.results.map(a=>({...a,codice_contratto:a.codice,tipo_contratto:a.tipo,cliente_nome:a.nomeRichiedente,cliente_cognome:a.cognomeRichiedente,data_firma:a.data_firma||null,data_scadenza:a.data_scadenza||null,status_italiano:a.status==="SIGNED"?"Firmato":a.status==="SENT"?"Inviato":a.status==="DRAFT"?"Bozza":"In attesa"}))})}catch(e){return console.error("‚ùå Errore recupero contratti:",e),t.json({success:!1,error:"Errore recupero contratti"},500)}});I.delete("/api/setup-real-contracts",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=t.env.DB,a=["CTR-KING-2025","CTR-BALZAROTTI-2025","CTR-PIZZUTTO-G-2025","CTR-PENNACCHIO-2025","CTR-COZZI-2025","CTR-POGGI-2025","CTR-DANDRAIA-2025","CTR-DESTRO-2025","CTR-CAPONE-2025"];let i=0;for(const r of a){const s=await e.prepare("SELECT id FROM contracts WHERE codice_contratto = ?").bind(r).first();s&&(await e.prepare("DELETE FROM signatures WHERE contract_id = ?").bind(s.id).run(),await e.prepare("DELETE FROM contracts WHERE id = ?").bind(s.id).run(),i++,console.log(`Rimosso contratto ${r}`))}return t.json({success:!0,message:`Rimossi ${i} contratti`,removed:i})}catch(e){return console.error("Errore rimozione contratti:",e),t.json({success:!1,error:"Errore durante la rimozione dei contratti",details:e.message},500)}});I.post("/api/setup-real-contracts",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=[{codice:"CTR-KING-2025",email_caregiver:"elenasaglia@hotmail.com",intestatario_nome:"Eileen",intestatario_cognome:"King",assistito_nome:"Eileen",assistito_cognome:"King",tipo:"AVANZATO",piano:"AVANZATO",servizio:"PRO",prezzo:840,data_invio:"2025-05-08",data_firma:"2025-05-10",status:"SIGNED",pdf:"/contratti/08.05.2025_Contratto Medica GB_TeleAssistenza Avanzato SIDLY FIRMATO_Eileen King.pdf",note:"Assistito: Eileen King - Caregiver: Elena Saglia (figlia) - Contratto AVANZATO firmato 10/05/2025"},{codice:"CTR-BALZAROTTI-2025",email_caregiver:"paolo@paolomagri.com",intestatario_nome:"Giuliana",intestatario_cognome:"Balzarotti",assistito_nome:"Giuliana",assistito_cognome:"Balzarotti",tipo:"BASE",piano:"BASE",servizio:"PRO",prezzo:480,data_invio:"2025-06-13",data_firma:"2025-06-16",status:"SIGNED",pdf:"/contratti/13.06.2025_Contratto Medica GB_TeleAssistenza SIDLY BASE - Paolo Magri.pdf",note:"Assistito: Giuliana Balzarotti - Caregiver: Paolo Magri (figlio) - Contratto BASE firmato 16/06/2025"},{codice:"CTR-PIZZUTTO-G-2025",email_caregiver:"simona.pizzutto@coopbarbarab.it",cognome_fallback:"Pizzutto",intestatario_nome:"Gianni Paolo",intestatario_cognome:"Pizzutto",assistito_nome:"Gianni Paolo",assistito_cognome:"Pizzutto",tipo:"BASE",piano:"BASE",servizio:"PRO",prezzo:480,data_invio:"2025-05-08",data_firma:"2025-05-15",status:"SIGNED",pdf:"/contratti/12.05.2025_Contratto Medica GB_TeleAssistenza SIDLY BASE_Gianni Paolo Pizzutto_firmato.pdf",note:"Assistito: Gianni Paolo Pizzutto - Caregiver: Simona Pizzutto (figlia) - Contratto BASE firmato 15/05/2025"},{codice:"CTR-PENNACCHIO-2025",email_caregiver:"caterinadalterio108@gmail.com",intestatario_nome:"Rita",intestatario_cognome:"Pennacchio",assistito_nome:"Rita",assistito_cognome:"Pennacchio",tipo:"BASE",piano:"BASE",servizio:"PRO",prezzo:480,data_invio:"2025-05-08",data_firma:"2025-05-14",status:"SIGNED",pdf:"/contratti/12.05.2025_Contratto firmato SIDLY BASE_Pennacchio Rita - Contratto firmato.pdf",note:"Assistito: Rita Pennacchio - Caregiver: Caterina D'Alterio - Contratto BASE firmato 14/05/2025"},{codice:"CTR-COZZI-2025",email_caregiver:"elisabettacattini@gmail.com",intestatario_nome:"Giuseppina",intestatario_cognome:"Cozzi",assistito_nome:"Giuseppina",assistito_cognome:"Cozzi",tipo:"BASE",piano:"BASE",servizio:"PRO",prezzo:480,data_invio:"2025-07-10",data_firma:"2025-07-15",status:"SIGNED",pdf:"/contratti/Contratto_Giuseppina_Cozzi.pdf",note:"Assistito: Giuseppina Cozzi - Caregiver: Elisabetta Cattini (figlia) - Contratto BASE firmato 15/07/2025"},{codice:"CTR-POGGI-2025",email_caregiver:"manuela.poggi1@icloud.com",intestatario_nome:"Manuela",intestatario_cognome:"Poggi",assistito_nome:"Manuela",assistito_cognome:"Poggi",tipo:"BASE",piano:"BASE",servizio:"PRO",prezzo:480,data_invio:"2025-05-08",data_firma:null,status:"SENT",pdf:"/contratti/08.05.2025_Contratto Medica GB_TeleAssistenza base SIDLY_Sig.ra Manuela Poggi.pdf",note:"Assistito: Manuela Poggi - Contratto BASE inviato 08/05/2025 - NON FIRMATO"},{codice:"CTR-DANDRAIA-2025",email_caregiver:"dandraia.g@gmail.com",intestatario_nome:"Giovanni",intestatario_cognome:"Dandraia",assistito_nome:"Giovanni",assistito_cognome:"Dandraia",tipo:"BASE",piano:"BASE",servizio:"PRO",prezzo:480,data_invio:"2025-09-15",data_firma:null,status:"SENT",pdf:"/contratti/Contratto Medica GB_SIDLY_Signor Giovanni Dandraia.pdf",note:"Assistito: Giovanni Dandraia - Contratto BASE inviato - NON FIRMATO"},{codice:"CTR-DESTRO-2025",email_caregiver:"ettoredestro@gmail.com",intestatario_nome:"Ettore",intestatario_cognome:"Destro",assistito_nome:"Ettore",assistito_cognome:"Destro",tipo:"AVANZATO",piano:"AVANZATO",servizio:"PRO",prezzo:840,data_invio:"2025-09-23",data_firma:null,status:"SENT",pdf:"/contratti/23.09.2025_Contratto Medica GB_SIDLY_Ettore Destro_2 Servizi AVANZATI.pdf",note:"Assistito: Ettore Destro - 2 Servizi AVANZATI - Contratto inviato 23/09/2025 - NON FIRMATO"},{codice:"CTR-CAPONE-2025",email_caregiver:"gr@ecotorino.it",cognome_fallback:"Riela",intestatario_nome:"Maria",intestatario_cognome:"Capone",assistito_nome:"Maria",assistito_cognome:"Capone",tipo:"BASE",piano:"BASE",servizio:"PRO",prezzo:480,data_invio:"2025-06-28",data_firma:"2025-06-28",status:"SIGNED",pdf:"/contratti/28.06.2025_Contratto_Medica_GB_bracciale_SiDLY_Maria_Capone.pdf",note:"Assistito: Maria Capone - Caregiver: Giorgio Riela (figlio) - Contratto BASE firmato 28/06/2025"}],a=[];let i=0,r=0;for(const c of e)try{console.log(`
üîç Contratto ${c.codice}:`),console.log(`   üìß Email caregiver: ${c.email_caregiver}`),console.log(`   üë§ Intestatario: ${c.intestatario_nome} ${c.intestatario_cognome}`);let u=null,p="";if(c.email_caregiver&&(console.log(`   1Ô∏è‚É£ Ricerca per EMAIL: ${c.email_caregiver}`),u=await t.env.DB.prepare("SELECT id, email, nomeRichiedente, cognomeRichiedente, nomeAssistito, cognomeAssistito FROM leads WHERE LOWER(email) = LOWER(?)").bind(c.email_caregiver).first(),u?(p="EMAIL",console.log(`   ‚úÖ Lead trovato via EMAIL: ${u.nomeRichiedente} ${u.cognomeRichiedente}`)):console.log("   ‚ùå Email non trovata nel database")),!u&&c.intestatario_cognome&&(console.log(`   2Ô∏è‚É£ Fallback COGNOME ASSISTITO: ${c.intestatario_cognome}`),u=await t.env.DB.prepare("SELECT id, email, nomeRichiedente, cognomeRichiedente, nomeAssistito, cognomeAssistito FROM leads WHERE LOWER(cognomeAssistito) = LOWER(?) LIMIT 1").bind(c.intestatario_cognome).first(),u?(p="COGNOME_ASSISTITO",console.log(`   ‚úÖ Lead trovato via COGNOME: ${u.nomeAssistito} ${u.cognomeAssistito} (caregiver: ${u.nomeRichiedente})`)):console.log("   ‚ùå Cognome assistito non trovato")),!u&&c.intestatario_cognome&&(console.log(`   3Ô∏è‚É£ Ultimo tentativo COGNOME RICHIEDENTE: ${c.intestatario_cognome}`),u=await t.env.DB.prepare("SELECT id, email, nomeRichiedente, cognomeRichiedente, nomeAssistito, cognomeAssistito FROM leads WHERE LOWER(cognomeRichiedente) = LOWER(?) LIMIT 1").bind(c.intestatario_cognome).first(),u&&(p="COGNOME_RICHIEDENTE",console.log(`   ‚úÖ Lead trovato via COGNOME RICHIEDENTE: ${u.nomeRichiedente} ${u.cognomeRichiedente}`))),!u){const L=`Lead non trovato - email: ${c.email_caregiver||"N/A"}, cognome: ${c.intestatario_cognome||"N/A"}`;console.log(`   ‚ö†Ô∏è  SKIP ${c.codice}: ${L}`),a.push({codice:c.codice,success:!1,error:L}),r++;continue}console.log(`   üéØ Lead associato: ${u.id} (trovato via ${p})`);const g=c.intestatario_nome||u.nomeRichiedente||"",m=c.intestatario_cognome||u.cognomeRichiedente||"",b=`CONTRACT_${c.codice}_${Date.now()}`,h=new Date().toISOString(),E=c.tipo==="AVANZATO"?"Template_Contratto_Avanzato_TeleMedCare":"Template_Contratto_Base_TeleMedCare",w=`<html><body>
          <h1>Contratto ${c.tipo} - ${c.codice}</h1>
          <p><strong>Intestatario:</strong> ${g} ${m}</p>
          <p><strong>Assistito:</strong> ${c.assistito_nome||g} ${c.assistito_cognome||m}</p>
          <p><strong>PDF:</strong> ${c.pdf}</p>
        </body></html>`,S=new Date(c.data_invio),C=new Date(S.getTime()+720*60*60*1e3).toISOString();let R=c.prezzo||0;if(!R){const L=Nc(c.servizio,c.piano);if(!L){a.push({codice:c.codice,success:!1,error:`Pricing non trovato per ${c.servizio} ${c.piano}`}),r++;continue}R=L.setupTotale}const z=Math.round(R/12),D=`eCura ${c.servizio}`;try{console.log(`   üì¶ Preparazione INSERT per ${c.codice}:`),console.log(`      - Lead ID: ${u.id}`),console.log(`      - Intestatario: ${g} ${m}`),console.log(`      - Prezzo: ‚Ç¨${R} (‚Ç¨${z}/mese)`),console.log(`      - Status: ${c.status}`),await t.env.DB.prepare(`
            INSERT INTO contracts (
              id, leadId, codice_contratto, tipo_contratto, template_utilizzato,
              contenuto_html, pdf_url, pdf_generated, 
              prezzo_mensile, durata_mesi, prezzo_totale,
              status, data_invio, data_scadenza,
              email_sent, email_template_used,
              piano, servizio,
              created_at, updated_at
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          `).bind(b,u.id,c.codice,c.tipo,E,w,c.pdf,1,z,12,R,c.status,c.data_invio,C,1,"email_invio_contratto",c.piano,D,h,h).run(),console.log(`   ‚úÖ Contratto inserito: ${c.codice}`)}catch(L){console.error(`   ‚ùå Errore INSERT contratto ${c.codice}:`,L),console.error("   ‚ùå Dettagli errore:",{message:L instanceof Error?L.message:String(L),contractId:b,leadId:u.id,codice:c.codice}),a.push({codice:c.codice,success:!1,error:`Errore DB: ${L instanceof Error?L.message:String(L)}`}),r++;continue}const F=c.status==="SIGNED"?"CONTRACT_SIGNED":"CONTRACT_SENT";await t.env.DB.prepare("UPDATE leads SET status = ?, updated_at = ? WHERE id = ?").bind(F,h,u.id).run(),c.status==="SIGNED"&&c.data_firma&&await t.env.DB.prepare(`
            INSERT INTO signatures (
              contract_id, firma_digitale, tipo_firma,
              ip_address, user_agent, timestamp_firma,
              hash_documento, certificato_firma, valida
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
          `).bind(b,"FIRMA_PDF_ESISTENTE","ELETTRONICA","0.0.0.0","Import from PDF",c.data_firma,`hash_${c.codice}`,"Contratto firmato importato da PDF",1).run(),a.push({codice:c.codice,success:!0,contractId:b,leadId:u.id,email:c.email_caregiver,signed:c.status==="SIGNED"}),i++,console.log(`‚úÖ Contratto ${c.codice} creato per lead ${u.id}`)}catch(u){console.error(`‚ùå Errore creazione contratto ${c.codice}:`,u),a.push({codice:c.codice,success:!1,error:u.message}),r++}const s=a.filter(c=>c.success&&c.signed).length,l=e.filter(c=>c.status==="SIGNED").reduce((c,u)=>c+(u.prezzo||0),0),d=a.filter(c=>c.success).map(c=>{const u=e.find(p=>p.codice===c.codice);return{codice:c.codice,intestatario:`${u.intestatario_nome} ${u.intestatario_cognome}`,cognome:u.intestatario_cognome,caregiver:u.email_caregiver,piano:u.piano,servizio:u.servizio,prezzo:u.prezzo,status:u.status,data_invio:u.data_invio,data_firma:u.data_firma}});return t.json({success:!0,message:`Creati ${i} contratti su ${e.length}`,creati:i,errori:r,firmati:s,revenue:l,conversionRate:"5.4%",aov:Math.round(l/(s||1)),risultati:a,contratti:d})}catch(e){return console.error("‚ùå Errore generale setup contratti:",e),t.json({success:!1,error:"Errore durante la creazione dei contratti",details:e.message},500)}});I.post("/api/contracts",async t=>{var o;try{const{leadId:e,tipoContratto:a="BASE"}=await t.req.json();if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const i=await t.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(e).first();if(!i)return t.json({success:!1,error:"Lead non trovato"},404);const r=`CONTRACT_${Date.now()}_${Math.random().toString(36).substring(7)}`,s=Date.now(),l=(i.cognomeAssistito||i.cognomeRichiedente||"UNKNOWN").toUpperCase().replace(/[^A-Z]/g,""),d=new Date().getFullYear(),c=`CONTRACT_CTR-${l}-${d}_${s}`,u={BASE:{mensile:39,totale:468,durata:12},AVANZATO:{mensile:69,totale:828,durata:12}},p=u[a]||u.BASE,g=a==="AVANZATO"?"Template_Contratto_Avanzato_TeleMedCare":"Template_Contratto_Base_TeleMedCare",m=TT(i,a,p);return await t.env.DB.prepare(`
      INSERT INTO contracts (
        id, leadId, codice_contratto, tipo_contratto, template_utilizzato,
        contenuto_html, prezzo_mensile, durata_mesi, prezzo_totale,
        status, data_scadenza, created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(r,e,c,a,g,m,p.mensile,p.durata,p.totale,"DRAFT",new Date(Date.now()+720*60*60*1e3).toISOString(),new Date().toISOString()).run(),await t.env.DB.prepare("UPDATE leads SET status = ? WHERE id = ?").bind("CONTRACT_GENERATED",e).run(),t.json({success:!0,contract:{id:r,codice:c,tipo:a,prezzo_totale:p.totale,status:"DRAFT"},message:"Contratto generato. Usare /api/contracts/send per inviarlo"})}catch(e){return console.error("‚ùå Errore creazione contratto:",e),t.json({success:!1,error:e.message},500)}});I.post("/api/documents/generate",async t=>{var o;try{const{leadId:e}=await t.req.json();if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log(`üìÑ Richiesta generazione documenti per lead ${e}`);const{generateDocumentsForLead:a}=await Promise.resolve().then(()=>WT),i=await a(t.env.DB,e);return i.success?t.json({success:!0,message:"Documenti generati con successo",data:{contractId:i.contractId,contractPdfUrl:i.contractPdfUrl,proformaId:i.proformaId,proformaPdfUrl:i.proformaPdfUrl,tipoServizio:i.tipoServizio,prezzoBase:i.prezzoBase,prezzoIvaInclusa:i.prezzoIvaInclusa}}):t.json({success:!1,errors:i.errors},400)}catch(e){return console.error("‚ùå Errore generazione documenti:",e),t.json({success:!1,error:e instanceof Error?e.message:"Errore sconosciuto"},500)}});I.post("/api/contracts/send",async t=>{var o;try{const{contractId:e}=await t.req.json();if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const a=await t.env.DB.prepare(`
      SELECT * FROM contracts WHERE id = ?
    `).bind(e).first();if(!a)return t.json({success:!1,error:"Contratto non trovato"},404);const i=await t.env.DB.prepare(`
      SELECT * FROM leads WHERE id = ?
    `).bind(a.leadId).first();if(!i)return t.json({success:!1,error:"Lead non trovato"},404);const r={contractId:a.id,contractCode:a.codice_contratto,contractPdfUrl:a.pdf_url||"",tipoServizio:a.tipo_contratto||a.piano,servizio:a.servizio,prezzoBase:a.prezzo_totale||480,prezzoIvaInclusa:(a.prezzo_totale||480)*1.22},l={brochure:(a.servizio||"").replace(/^eCura\s+/i,"").trim().toUpperCase()==="PREMIUM"?"/brochures/Medica-GB-SiDLY_Vital_Care_ITA-compresso.pdf":"/brochures/Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf",manuale:""},d=await inviaEmailContratto(i,r,t.env,l,t.env.DB);return d.success?(await t.env.DB.prepare(`
        UPDATE contracts SET 
          status = 'SENT', 
          data_invio = ?, 
          email_sent = true, 
          email_template_used = 'email_invio_contratto'
        WHERE id = ?
      `).bind(new Date().toISOString(),e).run(),await t.env.DB.prepare("UPDATE leads SET status = ? WHERE id = ?").bind("CONTRACT_SENT",a.leadId).run(),await t.env.DB.prepare(`
        INSERT INTO email_logs (leadId, contract_id, recipient_email, template_used, subject, status, provider_used, sent_at)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
      `).bind(a.leadId,e,a.email,"email_invio_contratto",`TeleMedCare - Contratto ${a.codice_contratto}`,"SENT","RESEND",new Date().toISOString()).run(),t.json({success:!0,message:`Contratto ${a.codice_contratto} inviato a ${a.email}`,email_status:d})):t.json({success:!1,error:"Errore invio email: "+d.error},500)}catch(e){return console.error("‚ùå Errore invio contratto:",e),t.json({success:!1,error:e.message},500)}});I.post("/api/proforma",async t=>{try{const{contractId:o}=await t.req.json(),e=await wT(o,t.env.DB);return t.json(e)}catch(o){return console.error("‚ùå Errore generazione proforma:",o),t.json({success:!1,error:o.message},500)}});I.post("/api/proforma/send",async t=>{var o;try{const{proformaId:e}=await t.req.json();if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const a=await t.env.DB.prepare(`
      SELECT p.*, l.nomeRichiedente, l.cognomeRichiedente, l.email
      FROM proforma p
      LEFT JOIN contracts c ON p.contract_id = c.id
      LEFT JOIN leads l ON c.leadId = l.id
      WHERE p.id = ?
    `).bind(e).first();if(!a)return t.json({success:!1,error:"Proforma non trovata"},404);const i=await IT(a);return i.success?(await t.env.DB.prepare(`
        UPDATE proforma SET 
          status = 'SENT',
          data_invio = ?,
          email_sent = true
        WHERE id = ?
      `).bind(new Date().toISOString(),e).run(),t.json({success:!0,message:`Proforma ${a.numero_proforma} inviata a ${a.email}`})):t.json({success:!1,error:"Errore invio email: "+i.error},500)}catch(e){return console.error("‚ùå Errore invio proforma:",e),t.json({success:!1,error:e.message},500)}});I.post("/api/payments",async t=>{var o;try{const{proformaId:e,importo:a,metodoPagamento:i,transactionId:r,stripePaymentIntentId:s}=await t.req.json();if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const l=await t.env.DB.prepare(`
      SELECT p.*, c.leadId, c.id as contract_id
      FROM proforma p
      LEFT JOIN contracts c ON p.contract_id = c.id
      WHERE p.id = ?
    `).bind(e).first();if(!l)return t.json({success:!1,error:"Proforma non trovata"},404);const d=await t.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(l.leadId).first();if(!d)return t.json({success:!1,error:"Lead non trovato"},404);console.log("üí≥ [ENDPOINT] Payment request data:",JSON.stringify({proformaId:e,importo:a,metodoPagamento:i,transactionId:r,proforma_contract_id:l.contract_id,leadId:d.id}));const c={db:t.env.DB,env:t.env,leadData:{id:d.id,nomeRichiedente:d.nomeRichiedente,cognomeRichiedente:d.cognomeRichiedente,email:d.email,telefono:d.telefono,nomeAssistito:d.nomeAssistito||d.nomeRichiedente,cognomeAssistito:d.cognomeAssistito||d.cognomeRichiedente,etaAssistito:d.etaAssistito?String(d.etaAssistito):null,pacchetto:d.tipoServizio||"BASE",vuoleContratto:!0,vuoleBrochure:d.vuoleBrochure==="Si",vuoleManuale:d.vuoleManuale==="Si",fonte:d.fonte||"LANDING_PAGE"},proformaId:e,contractId:l.contract_id,paymentData:{amount:a,paymentMethod:i,transactionId:r,stripePaymentIntentId:s}},u=await uT(c);return u.success?t.json({success:!0,message:u.message,data:u.data}):t.json({success:!1,error:u.message,errors:u.errors,debug:u.debug},400)}catch(e){return console.error("‚ùå Errore registrazione pagamento:",e),t.json({success:!1,error:e.message},500)}});I.get("/api/proforma",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!0,proforma:[]});const e=await t.env.DB.prepare(`
      SELECT 
        p.*,
        l.nomeRichiedente,
        l.cognomeRichiedente,
        l.email as cliente_email
      FROM proforma p
      LEFT JOIN contracts c ON p.contract_id = c.id
      LEFT JOIN leads l ON c.leadId = l.id
      ORDER BY p.created_at DESC
      LIMIT 100
    `).all();return t.json({success:!0,count:e.results.length,proforma:e.results.map(a=>({...a,cliente_nome:`${a.nomeRichiedente} ${a.cognomeRichiedente}`}))})}catch(e){return console.error("‚ùå Errore recupero proforma:",e),t.json({success:!1,error:"Errore recupero proforma"},500)}});I.get("/api/proforma/:id",async t=>{var e;const o=t.req.param("id");try{if(!((e=t.env)!=null&&e.DB))return t.json({success:!0,proforma:{id:o,numero_proforma:"PRO-MOCK-"+o,importo:480,status:"SENT"}});const a=await t.env.DB.prepare(`
      SELECT 
        p.*,
        l.nomeRichiedente,
        l.cognomeRichiedente,
        l.email as cliente_email,
        l.telefono as cliente_telefono
      FROM proforma p
      LEFT JOIN contracts c ON p.contract_id = c.id
      LEFT JOIN leads l ON c.leadId = l.id
      WHERE p.id = ?
    `).bind(o).first();return a?t.json({success:!0,proforma:a}):t.json({success:!1,error:"Proforma non trovata"},404)}catch(a){return console.error("‚ùå Errore recupero proforma:",a),t.json({success:!1,error:"Errore recupero proforma",details:a instanceof Error?a.message:String(a)},500)}});I.put("/api/proforma/:id",async t=>{var e;const o=t.req.param("id");try{const a=await t.req.json();if(!((e=t.env)!=null&&e.DB))return t.json({success:!0,message:"Proforma aggiornata (mock)"});if(!await t.env.DB.prepare("SELECT * FROM proforma WHERE id = ?").bind(o).first())return t.json({success:!1,error:"Proforma non trovata"},404);const r=[],s=[],l={status:"status",importo:"importo",note:"note",data_invio:"data_invio",data_scadenza:"data_scadenza"};for(const[c,u]of Object.entries(l))a[c]!==void 0&&(r.push(`${u} = ?`),s.push(a[c]));if(r.length===0)return t.json({success:!1,error:"Nessun campo da aggiornare"},400);r.push("updated_at = ?"),s.push(new Date().toISOString()),s.push(o);const d=`UPDATE proforma SET ${r.join(", ")} WHERE id = ?`;return await t.env.DB.prepare(d).bind(...s).run(),console.log("‚úÖ Proforma aggiornata:",o),t.json({success:!0,message:"Proforma aggiornata con successo",id:o})}catch(a){return console.error("‚ùå Errore aggiornamento proforma:",a),t.json({success:!1,error:"Errore aggiornamento proforma",details:a instanceof Error?a.message:String(a)},500)}});I.delete("/api/proforma/:id",async t=>{var e;const o=t.req.param("id");try{if(!((e=t.env)!=null&&e.DB))return t.json({success:!0,message:"Proforma eliminata (mock)"});const a=await t.env.DB.prepare("SELECT * FROM proforma WHERE id = ?").bind(o).first();return a?a.status==="PAID"?t.json({success:!1,error:"Impossibile eliminare una proforma pagata",isPaid:!0},400):(await t.env.DB.prepare("DELETE FROM proforma WHERE id = ?").bind(o).run(),await t.env.DB.prepare("DELETE FROM payments WHERE proforma_id = ?").bind(o).run(),console.log("‚úÖ Proforma eliminata:",o),t.json({success:!0,message:"Proforma eliminata con successo",id:o})):t.json({success:!1,error:"Proforma non trovata"},404)}catch(a){return console.error("‚ùå Errore eliminazione proforma:",a),t.json({success:!1,error:"Errore eliminazione proforma",details:a instanceof Error?a.message:String(a)},500)}});I.post("/api/configurations",async t=>{var o;try{const e=await t.req.json(),{leadId:a,contattiEmergenza:i,datiMedici:r,preferenzeUtilizzo:s}=e;if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const l=await t.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(a).first();if(!l)return t.json({success:!1,error:"Lead non trovato"},404);const d=Date.now(),c=Math.floor(Math.random()*1e3).toString().padStart(3,"0"),u=`CLI-${d}-${c}`,p={db:t.env.DB,env:t.env,leadData:{id:l.id,nomeRichiedente:l.nomeRichiedente,cognomeRichiedente:l.cognomeRichiedente,email:l.email,telefono:l.telefono,nomeAssistito:l.nomeAssistito||l.nomeRichiedente,cognomeAssistito:l.cognomeAssistito||l.cognomeRichiedente,etaAssistito:l.etaAssistito?String(l.etaAssistito):null,pacchetto:l.tipoServizio||"BASE",vuoleContratto:!0,vuoleBrochure:l.vuoleBrochure==="Si",vuoleManuale:l.vuoleManuale==="Si",fonte:l.fonte||"LANDING_PAGE"},configData:{leadId:a,codiceCliente:u,contattiEmergenza:i,datiMedici:r,preferenzeUtilizzo:s,nomeCompletoAssistito:`${l.nomeAssistito||l.nomeRichiedente} ${l.cognomeAssistito||l.cognomeRichiedente}`,dataNascitaAssistito:l.dataNascitaAssistito||"",indirizzoCompletoAssistito:l.indirizzoAssistito||"",cittaAssistito:l.cittaAssistito||"",capAssistito:l.capAssistito||"",provinciaAssistito:l.provinciaAssistito||"",compilazioneTimestamp:new Date().toISOString()}},g=await pT(p);return g.success?t.json({success:!0,message:g.message,data:g.data}):t.json({success:!1,error:g.message,errors:g.errors},400)}catch(e){return console.error("‚ùå Errore salvataggio configurazione:",e),t.json({success:!1,error:e.message},500)}});I.post("/api/devices/associate",async t=>{var o;try{const{leadId:e,deviceId:a,deviceImei:i,configurationId:r}=await t.req.json();if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const s=await t.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(e).first();if(!s)return t.json({success:!1,error:"Lead non trovato"},404);const l={db:t.env.DB,env:t.env,leadData:{id:s.id,nomeRichiedente:s.nomeRichiedente,cognomeRichiedente:s.cognomeRichiedente,email:s.email,telefono:s.telefono,nomeAssistito:s.nomeAssistito||s.nomeRichiedente,cognomeAssistito:s.cognomeAssistito||s.cognomeRichiedente,etaAssistito:s.etaAssistito?String(s.etaAssistito):null,pacchetto:s.tipoServizio||"BASE",vuoleContratto:!0,vuoleBrochure:s.vuoleBrochure==="Si",vuoleManuale:s.vuoleManuale==="Si",fonte:s.fonte||"LANDING_PAGE"},deviceData:{deviceId:a,deviceImei:i,configurationId:r}},d=await mT(l);return d.success?t.json({success:!0,message:d.message,data:d.data}):t.json({success:!1,error:d.message,errors:d.errors},400)}catch(e){return console.error("‚ùå Errore associazione dispositivo:",e),t.json({success:!1,error:e.message},500)}});I.post("/api/leads/external",async t=>{var o;try{const{fonte:e,leads:a}=await t.req.json();if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const i=[];for(const r of a)try{const s=`LEAD_${e}_${Date.now()}_${Math.random().toString(36).substring(7)}`;await t.env.DB.prepare(`
          INSERT INTO leads (
            id, nomeRichiedente, cognomeRichiedente, email, telefono,
            fonte, tipoServizio, vuoleContratto, gdprConsent, status,
            external_source_id, external_data
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(s,r.nome,r.cognome,r.email,r.telefono||"",e,r.tipoServizio||"BASE","Si",!0,"NEW",r.externalId||null,JSON.stringify(r)).run();const l=await ST(r.email,r.nome,e);i.push({leadId:s,email:r.email,email_sent:l.success,status:"CREATED"})}catch(s){i.push({email:r.email,error:s.message,status:"ERROR"})}return t.json({success:!0,processed:i.length,results:i,message:`${i.filter(r=>r.status==="CREATED").length} leads creati da fonte ${e}`})}catch(e){return console.error("‚ùå Errore creazione leads esterni:",e),t.json({success:!1,error:e.message},500)}});I.post("/api/webhooks/hubspot",async t=>{try{console.log("üì• Webhook HubSpot ricevuto da eCura");const{handleHubSpotWebhook:o}=await Promise.resolve().then(()=>KT),e=await o(t.req.raw,t.env);return new Response(e.body,{status:e.status,headers:e.headers})}catch(o){return console.error("‚ùå Errore webhook HubSpot:",o),t.json({success:!1,error:o instanceof Error?o.message:"Errore sconosciuto"},500)}});I.post("/api/webhooks/docusign",async t=>{try{console.log("üì• [WEBHOOK] DocuSign evento ricevuto");const o=await t.req.json(),e=t.env.DB,{DocuSignWebhookHandler:a}=await Promise.resolve().then(()=>YT),i=await a.handleWebhook(o,e,t.env);return console.log("‚úÖ [WEBHOOK] DocuSign processato:",i),t.json({success:i.success,message:i.message,envelopeId:i.envelopeId,status:i.status,actions:i.actions})}catch(o){return console.error("‚ùå [WEBHOOK] Errore DocuSign:",o),t.json({success:!1,error:o instanceof Error?o.message:"Errore webhook DocuSign"},500)}});I.post("/api/webhooks/stripe",async t=>{try{console.log("üì• [WEBHOOK] Stripe evento ricevuto");const o=await t.req.json(),e=t.env.DB,{StripeWebhookHandler:a}=await Promise.resolve().then(()=>XT),i=await a.processWebhook(o,e);return console.log("‚úÖ [WEBHOOK] Stripe processato:",i),t.json({success:i.success,message:i.message,eventType:o.type})}catch(o){return console.error("‚ùå [WEBHOOK] Errore Stripe:",o),t.json({success:!1,error:o instanceof Error?o.message:"Errore webhook Stripe"},500)}});I.get("/api/contratti/:id/view",async t=>{var e;const o=t.req.param("id");try{if(!((e=t.env)!=null&&e.DB))return t.html(`
        <!DOCTYPE html>
        <html>
        <head><title>Contratto TMC-2024-${o.padStart(3,"0")}</title></head>
        <body style="font-family: Arial; padding: 20px;">
          <h1>Contratto TeleMedCare</h1>
          <p><strong>Codice:</strong> TMC-2024-${o.padStart(3,"0")}</p>
          <p><strong>Tipo:</strong> Base</p>
          <p><strong>Data:</strong> ${new Date().toLocaleDateString("it-IT")}</p>
          <h2>Dettagli Servizio</h2>
          <p>Servizio di telemedicina per assistenza sanitaria domiciliare.</p>
          <p><strong>Status:</strong> Firmato</p>
        </body>
        </html>
      `);const a=await t.env.DB.prepare(`
      SELECT c.*, l.name as cliente_nome, l.email as cliente_email
      FROM contracts c 
      LEFT JOIN leads l ON c.lead_id = l.id 
      WHERE c.id = ?
    `).bind(o).first();return a?t.html(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>Contratto ${a.codice}</title>
        <style>body { font-family: Arial; padding: 20px; }</style>
      </head>
      <body>
        <h1>Contratto TeleMedCare</h1>
        <p><strong>Codice:</strong> ${a.codice}</p>
        <p><strong>Cliente:</strong> ${a.cliente_nome}</p>
        <p><strong>Email:</strong> ${a.cliente_email}</p>
        <p><strong>Tipo:</strong> ${a.tipo}</p>
        <p><strong>Data Firma:</strong> ${new Date(a.data_firma).toLocaleDateString("it-IT")}</p>
        <h2>Dettagli Servizio</h2>
        <p>${a.dettagli||"Servizio di telemedicina per assistenza sanitaria domiciliare."}</p>
        <p><strong>Status:</strong> ${a.status}</p>
      </body>
      </html>
    `):t.html("<h1>Contratto non trovato</h1>",404)}catch(a){return console.error("‚ùå Errore visualizzazione contratto:",a),t.html("<h1>Errore visualizzazione contratto</h1>",500)}});I.get("/api/contratti/:id/download",async t=>{var e;const o=t.req.param("id");try{if(!((e=t.env)!=null&&e.DB)){const i=`%PDF-1.4
1 0 obj
<< /Type /Catalog /Pages 2 0 R >>
endobj
2 0 obj
<< /Type /Pages /Kids [3 0 R] /Count 1 >>
endobj
3 0 obj
<< /Type /Page /Parent 2 0 R /Resources << /Font << /F1 << /Type /Font /Subtype /Type1 /BaseFont /Helvetica >> >> >> /MediaBox [0 0 612 792] /Contents 4 0 R >>
endobj
4 0 obj
<< /Length 55 >>
stream
BT
/F1 12 Tf
100 700 Td
(Contratto TeleMedCare TMC-2024-${o.padStart(3,"0")}) Tj
ET
endstream
endobj
xref
0 5
0000000000 65535 f 
0000000009 00000 n 
0000000058 00000 n 
0000000115 00000 n 
0000000281 00000 n 
trailer
<< /Size 5 /Root 1 0 R >>
startxref
386
%%EOF`;return new Response(i,{headers:{"Content-Type":"application/pdf","Content-Disposition":`attachment; filename="contratto-TMC-2024-${o.padStart(3,"0")}.pdf"`}})}const a=await t.env.DB.prepare("SELECT * FROM contracts WHERE id = ?").bind(o).first();return a?a.pdf_url?t.redirect(a.pdf_url):a.contenuto_html?t.html(a.contenuto_html):t.json({error:"PDF e HTML non disponibili per questo contratto"},404):t.json({error:"Contratto non trovato"},404)}catch(a){return console.error("‚ùå Errore download contratto:",a),t.json({error:"Errore download contratto"},500)}});I.get("/api/contratti/:id",async t=>{var e;const o=t.req.param("id");try{if(!((e=t.env)!=null&&e.DB))return t.json({success:!0,contratto:{id:o,codice_contratto:"TMC-MOCK-"+o,tipo_contratto:"BASE",status:"SENT"}});const a=await t.env.DB.prepare(`
      SELECT 
        c.*,
        l.nomeRichiedente,
        l.cognomeRichiedente,
        l.email as cliente_email,
        l.telefono as cliente_telefono
      FROM contracts c
      LEFT JOIN leads l ON c.leadId = l.id
      WHERE c.id = ?
    `).bind(o).first();return a?t.json({success:!0,contratto:a}):t.json({success:!1,error:"Contratto non trovato"},404)}catch(a){return console.error("‚ùå Errore recupero contratto:",a),t.json({success:!1,error:"Errore recupero contratto",details:a instanceof Error?a.message:String(a)},500)}});I.put("/api/contratti/:id",async t=>{var e;const o=t.req.param("id");try{const a=await t.req.json();if(!((e=t.env)!=null&&e.DB))return t.json({success:!0,message:"Contratto aggiornato (mock)"});if(!await t.env.DB.prepare("SELECT * FROM contracts WHERE id = ?").bind(o).first())return t.json({success:!1,error:"Contratto non trovato"},404);const r=[],s=[],l={status:"status",tipo_contratto:"tipo_contratto",prezzo_totale:"prezzo_totale",note:"note",data_invio:"data_invio"};for(const[c,u]of Object.entries(l))a[c]!==void 0&&(r.push(`${u} = ?`),s.push(a[c]));if(r.length===0)return t.json({success:!1,error:"Nessun campo da aggiornare"},400);r.push("updated_at = ?"),s.push(new Date().toISOString()),s.push(o);const d=`UPDATE contracts SET ${r.join(", ")} WHERE id = ?`;return await t.env.DB.prepare(d).bind(...s).run(),console.log("‚úÖ Contratto aggiornato:",o),t.json({success:!0,message:"Contratto aggiornato con successo",id:o})}catch(a){return console.error("‚ùå Errore aggiornamento contratto:",a),t.json({success:!1,error:"Errore aggiornamento contratto",details:a instanceof Error?a.message:String(a)},500)}});I.delete("/api/contratti/:id",async t=>{var e;const o=t.req.param("id");try{if(!((e=t.env)!=null&&e.DB))return t.json({success:!0,message:"Contratto eliminato (mock)"});const a=await t.env.DB.prepare("SELECT * FROM contracts WHERE id = ?").bind(o).first();return a?a.status==="SIGNED"?t.json({success:!1,error:"Impossibile eliminare un contratto firmato",isSigned:!0},400):(await t.env.DB.prepare("DELETE FROM contracts WHERE id = ?").bind(o).run(),await t.env.DB.prepare("DELETE FROM signatures WHERE contract_id = ?").bind(o).run(),console.log("‚úÖ Contratto eliminato:",o),t.json({success:!0,message:"Contratto eliminato con successo",id:o})):t.json({success:!1,error:"Contratto non trovato"},404)}catch(a){return console.error("‚ùå Errore eliminazione contratto:",a),t.json({success:!1,error:"Errore eliminazione contratto",details:a instanceof Error?a.message:String(a)},500)}});I.post("/api/leads/:id/send-contract",async t=>{var e;const o=t.req.param("id");try{if(!((e=t.env)!=null&&e.DB))return t.json({success:!1,error:"Database non configurato"},500);const a=await t.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(o).first();if(!a)return t.json({success:!1,error:"Lead non trovato"},404);if(console.log("üìÑ Creazione contratto per lead:",o),console.log("üìÑ Lead data:",{email:a.email,nome:a.nomeRichiedente,cognome:a.cognomeRichiedente,servizio:a.servizio,piano:a.piano}),!a.email)return console.error("‚ùå Email mancante per lead:",o),t.json({success:!1,error:"Email mancante",details:"Il lead non ha un indirizzo email valido. Impossibile inviare il contratto."},400);if(!a.nomeRichiedente||!a.cognomeRichiedente)return console.error("‚ùå Nome/Cognome mancante per lead:",o),t.json({success:!1,error:"Dati incompleti",details:"Nome o cognome del richiedente mancanti. Completa il profilo del lead prima di inviare il contratto."},400);const i=await t.req.json().catch(()=>({})),r=i.tipoContratto||i.piano,s=Date.now(),l=(a.cognomeAssistito||a.cognomeRichiedente||"UNKNOWN").toUpperCase().replace(/[^A-Z]/g,""),d=new Date().getFullYear(),c=`CONTRACT_CTR-${l}-${d}_${s}`,u=`CTR-${l}-${d}`,p=a.servizio||"eCura PRO",g=r||a.piano||"BASE";console.log("üìÑ Piano contratto:",g,"(richiesto:",r,"lead:",a.piano,")");const m={id:o,nomeRichiedente:a.nomeRichiedente,cognomeRichiedente:a.cognomeRichiedente,email:a.email,telefono:a.telefono||"",nomeAssistito:a.nomeAssistito||a.nomeRichiedente,cognomeAssistito:a.cognomeAssistito||a.cognomeRichiedente,luogoNascitaAssistito:a.luogoNascitaAssistito||"",dataNascitaAssistito:a.dataNascitaAssistito||"",indirizzoAssistito:a.indirizzoAssistito||"",capAssistito:a.capAssistito||"",cittaAssistito:a.cittaAssistito||"",provinciaAssistito:a.provinciaAssistito||"",cfAssistito:a.cfAssistito||"",condizioniSalute:a.condizioniSalute||"",pacchetto:g,servizio:p,intestatarioContratto:a.intestatarioContratto||"richiedente",vuoleBrochure:!0,vuoleManuale:!1,vuoleContratto:!0},b=p.replace("eCura ","").trim().toUpperCase(),h=g.toUpperCase(),{calculatePrice:E}=await Promise.resolve().then(()=>sr),w=E(b,h),S={contractId:c,contractCode:u,contractPdfUrl:"",tipoServizio:g,servizio:p,prezzoBase:w.setupBase,prezzoIvaInclusa:w.setupTotale};console.log("üìß Import workflow-email-manager...");const{inviaEmailContratto:C}=await Promise.resolve().then(()=>Pc),R={};p.includes("PRO")||p.includes("FAMILY")?R.brochure="/brochures/Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf":p.includes("PREMIUM")&&(R.brochure="/brochures/Medica-GB-SiDLY_Vital_Care_ITA-compresso.pdf"),console.log("üìß Chiamata inviaEmailContratto con:",{leadId:m.id,email:m.email,servizio:S.servizio,piano:S.tipoServizio,documentUrls:R});let z;try{z=await C(m,S,t.env,R,t.env.DB),console.log("üìß Risultato invio email contratto:",z)}catch(D){return console.error("‚ùå ERRORE in inviaEmailContratto:",D),console.error("‚ùå Stack:",D instanceof Error?D.stack:"N/A"),t.json({success:!1,error:"Errore durante invio email",details:D instanceof Error?D.message:String(D)},500)}return z.success?(await t.env.DB.prepare(`
        UPDATE leads SET 
          vuoleContratto = 'Si',
          status = 'CONTRACT_SENT',
          updated_at = ?
        WHERE id = ?
      `).bind(new Date().toISOString(),o).run(),console.log("‚úÖ Lead aggiornato, contratto inviato con successo"),t.json({success:!0,message:"Contratto inviato con successo",contractId:c,contractCode:u})):(console.error("‚ùå Errore invio email contratto:",z.errors),t.json({success:!1,error:"Errore invio contratto",details:z.errors&&z.errors.length>0?z.errors.join(", "):"Errore sconosciuto durante invio email"},500))}catch(a){return console.error("‚ùå Errore invio contratto (catch):",a),console.error("‚ùå Stack trace:",a instanceof Error?a.stack:"N/A"),t.json({success:!1,error:"Errore invio contratto",details:a instanceof Error?a.message:String(a)},500)}});I.post("/api/leads/:id/send-brochure",async t=>{var e;const o=t.req.param("id");try{if(!((e=t.env)!=null&&e.DB))return t.json({success:!1,error:"Database non configurato"},500);const a=await t.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(o).first();if(!a)return t.json({success:!1,error:"Lead non trovato"},404);const i=(a.servizio||"eCura PRO").replace("eCura ","").toUpperCase(),r=(a.piano||"BASE").toUpperCase();console.log(`üì• [BROCHURE] Invio brochure per ${i} ${r}`);const s=[];let l="";if(i==="PRO"||i==="FAMILY"?l="Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf":i==="PREMIUM"&&(l="Medica-GB-SiDLY_Vital_Care_ITA-compresso.pdf"),l)try{const E=`/brochures/${l}`;console.log(`üì• [BROCHURE] Fetch brochure da: ${E}`);const w=await fetch(new URL(E,t.req.url).toString());if(w.ok){const S=await w.arrayBuffer(),C=Buffer.from(S).toString("base64");s.push({filename:l,content:C,contentType:"application/pdf"}),console.log(`üìé [BROCHURE] Allegato: ${(C.length*.75/1024).toFixed(2)} KB`)}else return console.error("‚ùå [BROCHURE] Brochure non trovata:",w.status),t.json({success:!1,error:`Brochure non disponibile (${w.status})`},500)}catch(E){return console.error("‚ùå [BROCHURE] Errore caricamento brochure:",E),t.json({success:!1,error:"Brochure non disponibile"},500)}else return t.json({success:!1,error:"Servizio non valido"},400);const d=(await Promise.resolve().then(()=>At)).default,{loadEmailTemplate:c,renderTemplate:u}=await Promise.resolve().then(()=>Pa),p=await c("email_brochure",t.env.DB,t.env),g={NOME_CLIENTE:a.nomeRichiedente||"Cliente",COGNOME_CLIENTE:a.cognomeRichiedente||"",LEAD_ID:o,SERVIZIO:`eCura ${i}`,PIANO:r==="AVANZATO"?"Avanzato":"Base",NOME_ASSISTITO:a.nomeAssistito||a.nomeRichiedente||"",COGNOME_ASSISTITO:a.cognomeAssistito||a.cognomeRichiedente||""},m=u(p,g);console.log("üìß [BROCHURE] Invio email con allegato brochure..."),console.log("üìß [BROCHURE] HTML content length:",m.length),console.log("üìß [BROCHURE] To:",a.email);const h=await new d(t.env).sendEmail({to:a.email,from:t.env.EMAIL_FROM||"notifiche@telemedcare.it",subject:`eCura - Brochure ${i}`,html:m,attachments:s});return h.demoMode&&(console.error("üö® [BROCHURE] ‚ö†Ô∏è DEMO MODE ATTIVO - Email NON inviata realmente!"),console.error("üö® [BROCHURE] Configura RESEND_API_KEY o SENDGRID_API_KEY su Cloudflare Pages"),console.error("üö® [BROCHURE] Warning:",h.warning),console.error("üö® [BROCHURE] Errors:",JSON.stringify(h.errors,null,2))),h.success?(await t.env.DB.prepare(`
        UPDATE leads SET 
          vuoleBrochure = 'Si',
          status = CASE 
            WHEN status = 'NEW' THEN 'BROCHURE_SENT'
            ELSE status
          END,
          updated_at = ?
        WHERE id = ?
      `).bind(new Date().toISOString(),o).run(),await t.env.DB.prepare(`
        INSERT INTO email_logs (
          leadId, recipient_email, template_used, 
          subject, status, provider_used, sent_at
        ) VALUES (?, ?, ?, ?, ?, 'RESEND', ?)
      `).bind(o,a.email,"email_brochure",`eCura - Brochure ${i}`,h.success?"SENT":"SIMULATED",new Date().toISOString()).run(),console.log("‚úÖ [BROCHURE] Brochure inviata con successo"),t.json({success:!0,message:`Brochure ${l} inviata a ${a.email}`,emailStatus:h.success?"sent":"simulated",attachments:s.length,demoMode:h.demoMode||!1,warning:h.demoMode?"‚ö†Ô∏è DEMO MODE: Email NON inviata realmente! Configura RESEND_API_KEY":void 0})):t.json({success:!1,error:"Errore invio email: "+h.error},500)}catch(a){return console.error("‚ùå [BROCHURE] Errore invio brochure:",a),t.json({success:!1,error:"Errore invio brochure",details:a instanceof Error?a.message:String(a)},500)}});I.get("/api/form/:leadId",async t=>{try{const{FORM_HTML:o}=await Promise.resolve().then(()=>tw);return t.header("Content-Type","text/html; charset=utf-8"),t.header("Cache-Control","no-store"),t.html(o)}catch(o){return console.error("Error loading form:",o),t.text("Form non disponibile",500)}});I.get("/api/leads/:id",async t=>{var e;const o=t.req.param("id");try{if(console.log(`üìã GET /api/leads/${o}`),!((e=t.env)!=null&&e.DB))return t.json({id:parseInt(o),name:`Lead Mock ${o}`,email:`lead${o}@example.com`,phone:`+39 123 456 7${o}${o}`,status:"new"});const a=await t.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(o).first();return a?(console.log(`‚úÖ Lead ${o} recuperato`),t.json(a)):(console.log(`‚ùå Lead ${o} non trovato`),t.json({error:"Lead non trovato"},404))}catch(a){return console.error("‚ùå Errore recupero lead:",a),t.json({error:"Errore recupero lead",details:a instanceof Error?a.message:String(a)},500)}});I.post("/api/leads/:id/complete",async t=>{var e,a,i,r,s;const o=t.req.param("id");try{const l=t.req.header("content-type")||"";let d;if(l.includes("application/json"))d=await t.req.json();else{const E=await t.req.formData();d={};for(const[w,S]of E.entries())d[w]=S}if(console.log(`üìù [COMPLETE] Lead ${o} - Dati ricevuti:`,JSON.stringify(d,null,2)),console.log("üìù [COMPLETE] Content-Type:",l),console.log("üìù [COMPLETE] DB disponibile:",!!((e=t.env)!=null&&e.DB)),!((a=t.env)!=null&&a.DB))return t.text("‚úÖ Grazie! I tuoi dati sono stati salvati con successo. Ti contatteremo presto.",200,{"Content-Type":"text/html; charset=utf-8"});const c=[],u=[],p={nomeRichiedente:"nomeRichiedente",cognomeRichiedente:"cognomeRichiedente",email:"email",telefono:"telefono",cfIntestatario:"cfIntestatario",indirizzoIntestatario:"indirizzoIntestatario",capIntestatario:"capIntestatario",cittaIntestatario:"cittaIntestatario",nomeAssistito:"nomeAssistito",cognomeAssistito:"cognomeAssistito",dataNascitaAssistito:"dataNascitaAssistito",luogoNascitaAssistito:"luogoNascitaAssistito",cittaAssistito:"cittaAssistito",cfAssistito:"cfAssistito",cfAssistito:"cfAssistito",indirizzoAssistito:"indirizzoAssistito",capAssistito:"capAssistito",condizioniSalute:"condizioniSalute",servizio:"servizio",piano:"piano",note:"note",gdprConsent:"gdprConsent"};for(const[E,w]of Object.entries(p))d[E]!==void 0&&d[E]!==""&&(c.push(`${w} = ?`),E==="gdprConsent"?u.push(d[E]==="1"||d[E]==="true"||d[E]===!0?1:0):u.push(d[E]));const g=d.email||d.email;g&&(c.some(E=>E.startsWith("email ="))||(c.push("email = ?"),u.push(g)),c.some(E=>E.startsWith("email ="))||(c.push("email = ?"),u.push(g)));const m=d.telefono||d.telefono;if(m&&(c.some(E=>E.startsWith("telefono ="))||(c.push("telefono = ?"),u.push(m)),c.some(E=>E.startsWith("telefono ="))||(c.push("telefono = ?"),u.push(m))),console.log("üîç [COMPLETE] Fields to update:",c),console.log("üîç [COMPLETE] Values:",u),c.length===0)return t.text("‚ùå Nessun dato da aggiornare",400);u.push(o);const b=`UPDATE leads SET ${c.join(", ")}, updated_at = datetime('now') WHERE id = ?`;console.log("üîç [COMPLETE] Query UPDATE:",b),console.log("üîç [COMPLETE] Binds:",u),console.log("üîç [COMPLETE] Lead ID:",o);let h;try{h=await t.env.DB.prepare(b).bind(...u).run(),console.log("‚úÖ [COMPLETE] UPDATE eseguito con successo")}catch(E){throw console.error("‚ùå [COMPLETE] ERRORE UPDATE DATABASE:",E),console.error("‚ùå [COMPLETE] Query che ha fallito:",b),console.error("‚ùå [COMPLETE] Binds:",JSON.stringify(u)),new Error(`Errore aggiornamento database: ${E instanceof Error?E.message:String(E)}`)}if(console.log("üîç Update result:",JSON.stringify(h)),console.log("üîç Rows affected:",((i=h.meta)==null?void 0:i.changes)||0),((r=h.meta)==null?void 0:r.changes)===0)return console.error("‚ùå Nessun lead aggiornato - ID non trovato:",o),t.json({success:!1,error:"Lead non trovato",message:`Impossibile trovare il lead con ID: ${o}`},404);try{console.log("üîî [COMPLETAMENTO] Verifico se inviare contratto automaticamente...");const E=await t.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(o).first();if(console.log(`üîç [COMPLETAMENTO] Lead aggiornato trovato: ${!!E}`),E){const{inviaEmailContratto:w}=await Promise.resolve().then(()=>Pc),{isLeadComplete:S}=await Promise.resolve().then(()=>at);console.log("üîç [COMPLETAMENTO] Verifica completezza lead...");const C=S(E);if(console.log(`üîç [COMPLETAMENTO] isLeadComplete() = ${C}`),C){console.log("‚úÖ [COMPLETAMENTO] Lead completo ‚Üí Invio contratto e brochure automatico");{const R=Date.now(),z=(E.cognomeAssistito||E.cognomeRichiedente||"UNKNOWN").toUpperCase().replace(/[^A-Z]/g,""),D=new Date().getFullYear(),F=`CONTRACT_CTR-${z}-${D}_${R}`,L=`CTR-${z}-${D}`,M=E.servizio||"eCura PRO",j=E.piano||"BASE",{getPricing:N}=await Promise.resolve().then(()=>Ug),A=N(M,j),x={contractId:F,contractCode:L,contractPdfUrl:"",tipoServizio:j,servizio:M,prezzoBase:A.setupBase,prezzoIvaInclusa:A.setupTotale},P={};M.includes("PRO")||M.includes("FAMILY")?P.brochure="/brochures/Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf":M.includes("PREMIUM")&&(P.brochure="/brochures/Medica-GB-SiDLY_Vital_Care_ITA-compresso.pdf");const B=await w(E,x,t.env,P,t.env.DB);B.success?(console.log("‚úÖ [COMPLETAMENTO] Contratto e brochure inviati con successo!"),await t.env.DB.prepare(`
                UPDATE leads SET 
                  vuoleContratto = 'Si',
                  vuoleBrochure = 'Si',
                  status = 'CONTRACT_SENT',
                  updated_at = ?
                WHERE id = ?
              `).bind(new Date().toISOString(),o).run()):console.error("‚ùå [COMPLETAMENTO] Errore invio contratto:",B.errors)}}else console.log("‚ÑπÔ∏è [COMPLETAMENTO] Lead non ancora completo, contratto non inviato")}}catch(E){console.error("‚ö†Ô∏è [COMPLETAMENTO] Errore trigger contratto:",E)}return t.json({success:!0,message:"Dati salvati con successo",updated:((s=h.meta)==null?void 0:s.changes)||0})}catch(l){return console.error("‚ùå Errore completamento lead:",l),t.json({success:!1,error:"Errore salvataggio dati",message:l instanceof Error?l.message:String(l)},500)}});I.post("/api/lead/:id/complete",async t=>{var e,a,i,r;const o=t.req.param("id");console.log(`üîÑ [ALIAS SINGOLARE] /api/lead/${o}/complete ‚Üí Eseguo logica di /api/leads/:id/complete`);try{const s=t.req.header("content-type")||"";let l;if(s.includes("application/json"))l=await t.req.json();else{const h=await t.req.formData();l={};for(const[E,w]of h.entries())l[E]=w}if(console.log(`üìù [COMPLETE ALIAS] Lead ${o} - Dati ricevuti:`,JSON.stringify(l,null,2)),console.log("üìù [COMPLETE ALIAS] Content-Type:",s),console.log("üìù [COMPLETE ALIAS] DB disponibile:",!!((e=t.env)!=null&&e.DB)),!((a=t.env)!=null&&a.DB))return t.text("‚úÖ Grazie! I tuoi dati sono stati salvati con successo. Ti contatteremo presto.",200,{"Content-Type":"text/html; charset=utf-8"});const d=[],c=[],u={nomeRichiedente:"nomeRichiedente",cognomeRichiedente:"cognomeRichiedente",email:"email",telefono:"telefono",cfIntestatario:"cfIntestatario",indirizzoIntestatario:"indirizzoIntestatario",capIntestatario:"capIntestatario",cittaIntestatario:"cittaIntestatario",nomeAssistito:"nomeAssistito",cognomeAssistito:"cognomeAssistito",dataNascitaAssistito:"dataNascitaAssistito",luogoNascitaAssistito:"luogoNascitaAssistito",cittaAssistito:"cittaAssistito",cfAssistito:"cfAssistito",cfAssistito:"cfAssistito",indirizzoAssistito:"indirizzoAssistito",capAssistito:"capAssistito",condizioniSalute:"condizioniSalute",servizio:"servizio",piano:"piano",note:"note",gdprConsent:"gdprConsent"};for(const[h,E]of Object.entries(u))l[h]!==void 0&&l[h]!==""&&(d.push(`${E} = ?`),h==="gdprConsent"?c.push(l[h]==="1"||l[h]==="true"||l[h]===!0?1:0):c.push(l[h]));const p=l.email||l.email;p&&(d.some(h=>h.startsWith("email ="))||(d.push("email = ?"),c.push(p)),d.some(h=>h.startsWith("email ="))||(d.push("email = ?"),c.push(p)));const g=l.telefono||l.telefono;if(g&&(d.some(h=>h.startsWith("telefono ="))||(d.push("telefono = ?"),c.push(g)),d.some(h=>h.startsWith("telefono ="))||(d.push("telefono = ?"),c.push(g))),console.log("üîç [COMPLETE ALIAS] Fields to update:",d),console.log("üîç [COMPLETE ALIAS] Values:",c),d.length===0)return t.text("‚ùå Nessun dato da aggiornare",400);c.push(o);const m=`UPDATE leads SET ${d.join(", ")}, updated_at = datetime('now') WHERE id = ?`;console.log("üîç [COMPLETE ALIAS] Query UPDATE:",m),console.log("üîç [COMPLETE ALIAS] Binds:",c);let b;try{b=await t.env.DB.prepare(m).bind(...c).run(),console.log("‚úÖ [COMPLETE ALIAS] UPDATE eseguito con successo")}catch(h){throw console.error("‚ùå [COMPLETE ALIAS] ERRORE UPDATE:",h),new Error(`Errore aggiornamento database: ${h instanceof Error?h.message:String(h)}`)}if(((i=b.meta)==null?void 0:i.changes)===0)return t.json({success:!1,error:"Lead non trovato"},404);try{const h=await t.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(o).first();if(h){const{inviaEmailContratto:E}=await Promise.resolve().then(()=>Pc),{isLeadComplete:w}=await Promise.resolve().then(()=>at);if(w(h)){const S=Date.now(),C=(lead.cognomeAssistito||lead.cognomeRichiedente||"UNKNOWN").toUpperCase().replace(/[^A-Z]/g,""),R=new Date().getFullYear(),z=`CONTRACT_CTR-${C}-${R}_${S}`,D=`CTR-${C}-${R}`,F=h.servizio||"eCura PRO",L=h.piano||"BASE",M=F.replace("eCura ","").trim().toUpperCase(),j=L.toUpperCase(),{calculatePrice:N}=await Promise.resolve().then(()=>sr),A=N(M,j);console.log(`üí∞ [CONTRATTO] Prezzi calcolati per ${M} ${j}:`,{setupBase:A.setupBase,setupTotale:A.setupTotale});const x={contractId:z,contractCode:D,contractPdfUrl:"",tipoServizio:L,servizio:F,prezzoBase:A.setupBase,prezzoIvaInclusa:A.setupTotale},P={};F.includes("PRO")||F.includes("FAMILY")?P.brochure="/brochures/Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf":F.includes("PREMIUM")&&(P.brochure="/brochures/Medica-GB-SiDLY_Vital_Care_ITA-compresso.pdf"),await E(h,x,t.env,P,t.env.DB)}}}catch(h){console.error("‚ö†Ô∏è [COMPLETE ALIAS] Errore trigger contratto:",h)}return t.json({success:!0,message:"Dati salvati con successo",updated:((r=b.meta)==null?void 0:r.changes)||0})}catch(s){return console.error("‚ùå [COMPLETE ALIAS] Errore:",s),t.json({success:!1,error:"Errore salvataggio dati",message:s instanceof Error?s.message:String(s)},500)}});I.put("/api/leads/:id",async t=>{var e,a;const o=t.req.param("id");try{const i=await t.req.json();if(console.log(`üìù UPDATE Lead ${o}:`,JSON.stringify(i,null,2)),!((e=t.env)!=null&&e.DB))return t.json({success:!0,message:"Lead aggiornato (mock)"});const r=[],s=[],l={nomeRichiedente:"nomeRichiedente",cognomeRichiedente:"cognomeRichiedente",email:"email",telefono:"telefono",cfIntestatario:"cfIntestatario",indirizzoIntestatario:"indirizzoIntestatario",nomeAssistito:"nomeAssistito",cognomeAssistito:"cognomeAssistito",luogoNascitaAssistito:"luogoNascitaAssistito",dataNascitaAssistito:"dataNascitaAssistito",indirizzoAssistito:"indirizzoAssistito",capAssistito:"capAssistito",cittaAssistito:"cittaAssistito",provinciaAssistito:"provinciaAssistito",cfAssistito:"cfAssistito",cfAssistito:"cfAssistito",servizio:"servizio",piano:"piano",canale:"fonte",fonte:"fonte",vuoleBrochure:"vuoleBrochure",vuoleContratto:"vuoleContratto",vuoleManuale:"vuoleManuale",gdprConsent:"gdprConsent",consensoMarketing:"consensoMarketing",consensoTerze:"consensoTerze",cm:"cm",stato:"stato",external_source_id:"external_source_id",condizioniSalute:"condizioniSalute",intestatarioContratto:"intestatarioContratto",note:"note",status:"status"};for(const[u,p]of Object.entries(l))i[u]!==void 0&&(r.push(`${p} = ?`),s.push(i[u]));if(i.servizio||i.piano)try{const u=await t.env.DB.prepare("SELECT servizio, piano FROM leads WHERE id = ?").bind(o).first(),p=i.servizio||(u==null?void 0:u.servizio)||"eCura PRO",g=i.piano||(u==null?void 0:u.piano)||"BASE",m=p.replace("eCura ","").toUpperCase();console.log(`üí∞ [UPDATE] Ricalcolo prezzi per ${p} ${g}`);const{calculatePrice:b}=await Promise.resolve().then(()=>sr),h=b(m,g);r.push("prezzo_anno = ?","prezzo_rinnovo = ?"),s.push(h.setupBase,h.rinnovoBase),console.log(`‚úÖ [UPDATE] Prezzi calcolati: ‚Ç¨${h.setupBase}/anno, ‚Ç¨${h.rinnovoBase}/rinnovo`)}catch(u){console.error("‚ö†Ô∏è [UPDATE] Errore calcolo prezzi:",u)}r.push("updated_at = ?"),s.push(new Date().toISOString()),s.push(o);const d=`UPDATE leads SET ${r.join(", ")} WHERE id = ?`;console.log("üîç Query SQL:",d),console.log("üîç Binds:",s);const c=await t.env.DB.prepare(d).bind(...s).run();return console.log("‚úÖ Lead aggiornato:",o,"- Rows affected:",((a=c.meta)==null?void 0:a.changes)||0),await d0(t.env.DB,o),t.json({success:!0,message:"Lead aggiornato con successo"})}catch(i){return console.error("‚ùå Errore aggiornamento lead:",i),console.error("‚ùå Error details:",i instanceof Error?i.message:String(i)),t.json({success:!1,error:"Errore aggiornamento lead",details:i instanceof Error?i.message:String(i)},500)}});I.post("/api/leads/:id/convert",async t=>{var e;const o=t.req.param("id");try{if(!((e=t.env)!=null&&e.DB))return t.json({success:!0,message:"Lead convertito (mock)"});const a=await t.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(o).first();if(!a)return t.json({error:"Lead non trovato"},404);const i=`ASS-${Date.now()}-${Math.random().toString(36).substr(2,9).toUpperCase()}`;return await t.env.DB.prepare(`
      INSERT INTO assistiti (codice, nome, email, telefono, status, lead_id, created_at)
      VALUES (?, ?, ?, ?, 'attivo', ?, ?)
    `).bind(i,a.name,a.email,a.phone,o,new Date().toISOString()).run(),await t.env.DB.prepare("UPDATE leads SET status = ? WHERE id = ?").bind("converted",o).run(),t.json({success:!0,message:"Lead convertito in assistito con successo",codice_assistito:i})}catch(a){return console.error("‚ùå Errore conversione lead:",a),t.json({error:"Errore conversione lead"},500)}});I.post("/api/admin/leads/:oldId/change-id",async t=>{var e;const o=t.req.param("oldId");try{const{newId:a,fonte:i}=await t.req.json();if(console.log(`üîÑ ADMIN: Cambio ID lead da ${o} a ${a}`),!((e=t.env)!=null&&e.DB))return t.json({success:!1,error:"Database non disponibile"},500);const r=await t.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(o).first();if(!r)return t.json({success:!1,error:"Lead originale non trovato"},404);if(await t.env.DB.prepare("SELECT id FROM leads WHERE id = ?").bind(a).first())return t.json({success:!1,error:"Nuovo ID gi√† esistente"},400);const l=Object.keys(r).filter(p=>p!=="id"),d=l.join(", "),c=l.map(()=>"?").join(", "),u=l.map(p=>p==="fonte"?i||r.fonte:p==="updated_at"?new Date().toISOString():r[p]);return await t.env.DB.prepare(`
      INSERT INTO leads (id, ${d})
      VALUES (?, ${c})
    `).bind(a,...u).run(),await t.env.DB.prepare("DELETE FROM leads WHERE id = ?").bind(o).run(),console.log(`‚úÖ Lead ${o} ‚Üí ${a}, fonte: ${i}`),t.json({success:!0,message:`Lead ID cambiato da ${o} a ${a}`,oldId:o,newId:a,fonte:i})}catch(a){return console.error("‚ùå Errore cambio ID lead:",a),t.json({error:"Errore cambio ID lead",details:a.message},500)}});I.post("/api/leads/:id/interactions",async t=>{var e;const o=t.req.param("id");try{const{tipo:a,nota:i,azione:r,operatore:s}=await t.req.json();if(!((e=t.env)!=null&&e.DB))return t.json({success:!1,error:"Database non disponibile"},500);if(!await t.env.DB.prepare("SELECT id FROM leads WHERE id = ?").bind(o).first())return t.json({success:!1,error:"Lead non trovato"},404);const d=`INT-${Date.now()}`,c=new Date().toISOString();return await t.env.DB.prepare(`
      INSERT INTO lead_interactions (id, lead_id, data, tipo, nota, azione, operatore, created_at)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(d,o,c,a,i||null,r||null,s||null,c).run(),console.log(`‚úÖ Interazione ${d} creata per lead ${o}`),await d0(t.env.DB,o),t.json({success:!0,interaction:{id:d,lead_id:o,data:c,tipo:a,nota:i,azione:r,operatore:s}})}catch(a){return console.error("‚ùå Errore creazione interazione:",a),t.json({error:"Errore creazione interazione"},500)}});I.get("/api/leads/:id/interactions",async t=>{var e;const o=t.req.param("id");try{if(!((e=t.env)!=null&&e.DB))return t.json({interactions:[]});const a=await t.env.DB.prepare(`
      SELECT * FROM lead_interactions 
      WHERE lead_id = ?
      ORDER BY data DESC
    `).bind(o).all();return t.json({success:!0,interactions:a.results||[]})}catch(a){return console.error("‚ùå Errore recupero interazioni:",a),t.json({error:"Errore recupero interazioni"},500)}});I.put("/api/leads/:id/cm",async t=>{var e;const o=t.req.param("id");try{const{cm:a}=await t.req.json();return(e=t.env)!=null&&e.DB?(await t.env.DB.prepare(`
      UPDATE leads 
      SET cm = ?, updated_at = ?
      WHERE id = ?
    `).bind(a||null,new Date().toISOString(),o).run(),console.log(`‚úÖ Contact Manager aggiornato per lead ${o}: ${a}`),t.json({success:!0,leadId:o,cm:a})):t.json({success:!1,error:"Database non disponibile"},500)}catch(a){return console.error("‚ùå Errore aggiornamento CM:",a),t.json({error:"Errore aggiornamento Contact Manager"},500)}});I.post("/api/admin/import-interactions",async t=>{var o;try{const a=(await t.req.formData()).get("file");if(!a)return t.json({success:!1,error:"Nessun file caricato"},400);if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non disponibile"},500);const i=await a.arrayBuffer(),r=new Uint8Array(i),s=btoa(String.fromCharCode(...r)),l=[];let d=0,c=0,u=[];return t.json({success:!1,error:"Funzionalit√† in sviluppo. Per ora, usa il formato JSON per importare interazioni.",message:'Endpoint disponibile: POST /api/admin/import-interactions-json con body: { "interactions": [...] }',format:{data:"2026-01-12",nome_azienda:"Maria Carla Morroni",contatto:"3314563888",tipo_attivita:"Telefonata",esito:"Non risponde",prossimo_step:"Email inviata",note:"Da ricontattare"}},501)}catch(e){return console.error("‚ùå Errore import interazioni:",e),t.json({error:"Errore durante l'importazione"},500)}});I.post("/api/admin/import-interactions-json",async t=>{var o;try{const{interactions:e,operatore:a}=await t.req.json();if(!Array.isArray(e)||e.length===0)return t.json({success:!1,error:"Nessuna interazione da importare"},400);if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non disponibile"},500);let i=0,r=0;const s=[];for(const l of e)try{const{data:d,nome_azienda:c,contatto:u,tipo_attivita:p,esito:g,prossimo_step:m,note:b}=l;if(!c&&!u){r++,s.push("Riga senza nome/contatto saltata");continue}let h=null;if(u&&u.includes("@")){const M=await t.env.DB.prepare(`
            SELECT id FROM leads WHERE email = ? LIMIT 1
          `).bind(u).first();M&&(h=M.id)}if(!h&&u){const M=u.toString().replace(/[\s\-\+]/g,""),j=await t.env.DB.prepare(`
            SELECT id FROM leads 
            WHERE REPLACE(REPLACE(REPLACE(telefono, ' ', ''), '-', ''), '+', '') LIKE ?
            LIMIT 1
          `).bind(`%${M}%`).first();j&&(h=j.id)}if(!h&&c){const M=c.trim().split(/\s+/);if(M.length>=2){const j=M[0],N=M.slice(1).join(" "),A=await t.env.DB.prepare(`
              SELECT id FROM leads 
              WHERE (nomeRichiedente LIKE ? AND cognomeRichiedente LIKE ?)
                 OR (nomeAssistito LIKE ? AND cognomeAssistito LIKE ?)
              LIMIT 1
            `).bind(`%${j}%`,`%${N}%`,`%${j}%`,`%${N}%`).first();A&&(h=A.id)}}if(!h){r++,s.push(`Lead non trovato per: ${c||u}`);continue}const w={Telefonata:"telefono",Email:"email","Email ":"email",WhatsApp:"whatsapp",SMS:"sms",Meeting:"meeting",Videocall:"videocall"}[p]||"telefono";let S="";g&&(S+=`Esito: ${g}. `),m&&(S+=`Prossimo step: ${m}. `),b&&(S+=`Note: ${b}`),S||(S=p||"Contatto registrato");const C=`INT-${Date.now()}-${i}`,R=d?new Date(d).toISOString():new Date().toISOString();await t.env.DB.prepare(`
          INSERT INTO lead_interactions (id, lead_id, data, tipo, nota, azione, operatore, created_at)
          VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(C,h,R,w,S,m||null,a||"Ottavia Belfa",new Date().toISOString()).run();const D=g&&{"Non risponde":"Da Ricontattare",Inviata:"Contattato","Da ricontattare":"Da Ricontattare",Interessato:"Interessato",Interessata:"Interessato",Intressata:"Interessato","Non interessato":"Non Interessato","Non interessata":"Non Interessato","numero non attivo":"Perso","da richiamare":"Da Ricontattare"}[g]||null,F=[],L=[];a&&a.includes("Ottavia")&&(F.push("cm = ?"),L.push("OB")),D&&(F.push("stato = ?"),L.push(D)),F.length>0&&(L.push(h),await t.env.DB.prepare(`
            UPDATE leads SET ${F.join(", ")} WHERE id = ?
          `).bind(...L).run()),i++}catch(d){r++,s.push(`Errore riga: ${d.message}`)}return console.log(`‚úÖ Import interazioni completato: ${i} importate, ${r} saltate`),t.json({success:!0,imported:i,skipped:r,total:e.length,errors:s.length>0?s.slice(0,10):[]})}catch(e){return console.error("‚ùå Errore import interazioni JSON:",e),t.json({error:"Errore durante l'importazione"},500)}});I.get("/firma-contratto",async t=>t.req.query("contractId")?t.html(`
    <!DOCTYPE html>
    <html lang="it">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Firma Contratto TeleMedCare</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
            .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
            .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
            .header h1 { font-size: 28px; margin-bottom: 10px; }
            .content { padding: 40px; }
            .loading { text-align: center; padding: 60px; color: #667eea; font-size: 18px; }
            .error { background: #fee; border: 2px solid #e74c3c; color: #c0392b; padding: 20px; border-radius: 10px; margin: 20px 0; }
            .contract-box { background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 10px; padding: 20px; margin: 20px 0; max-height: 400px; overflow-y: auto; }
            .signature-box { border: 3px dashed #667eea; border-radius: 10px; margin: 30px 0; padding: 20px; background: #f8f9fa; }
            canvas { border: 2px solid #667eea; border-radius: 8px; cursor: crosshair; display: block; width: 100%; max-width: 600px; margin: 0 auto; background: white; }
            .button-group { display: flex; gap: 15px; margin-top: 20px; justify-content: center; flex-wrap: wrap; }
            button { padding: 15px 30px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
            .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
            .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4); }
            .btn-secondary { background: #6c757d; color: white; }
            .btn-secondary:hover { background: #5a6268; }
            .checkbox-group { margin: 20px 0; padding: 15px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; }
            label { display: flex; align-items: flex-start; cursor: pointer; }
            input[type="checkbox"] { margin-right: 10px; margin-top: 3px; width: 20px; height: 20px; }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>‚úçÔ∏è Firma Digitale Contratto</h1>
                <p>TeleMedCare - Servizio eCura</p>
            </div>
            
            <div class="content">
                <div id="loading" class="loading">
                    ‚è≥ Caricamento contratto in corso...
                </div>
                
                <div id="error" class="error" style="display:none;"></div>
                
                <div id="contractContent" style="display:none;">
                    <div class="contract-info">
                        <h2>üìÑ Dettagli Contratto</h2>
                        <p><strong>Cliente:</strong> <span id="clientName"></span></p>
                        <p><strong>Servizio:</strong> <span id="serviceName"></span></p>
                        <p><strong>Piano:</strong> <span id="planName"></span></p>
                        <p><strong>Dispositivo:</strong> <span id="deviceName"></span></p>
                        <p><strong>Investimento:</strong> <span id="price"></span></p>
                        <p><strong>Codice Contratto:</strong> <strong id="contractCode"></strong></p>
                    </div>
                    
                    <div class="contract-box" id="contractHtml"></div>
                    
                    <div class="button-group" style="margin-top: 20px;">
                        <button type="button" class="btn-secondary" onclick="printContract()">
                            üñ®Ô∏è Stampa Contratto
                        </button>
                        <button type="button" class="btn-secondary" onclick="downloadContract()">
                            üì• Scarica PDF
                        </button>
                    </div>
                    
                    <div class="signature-box">
                        <h3 style="margin-bottom: 15px;">‚úçÔ∏è Firma qui sotto con il mouse o il dito</h3>
                        <canvas id="signatureCanvas" width="600" height="200"></canvas>
                        <div class="button-group">
                            <button type="button" class="btn-secondary" id="clearBtn">üóëÔ∏è Cancella Firma</button>
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="consentCheckbox" required>
                            <span>Dichiaro di aver letto e compreso il contratto. Confermo la mia firma digitale.</span>
                        </label>
                    </div>
                    
                    <div class="button-group">
                        <button type="button" class="btn-primary" id="signButton">‚úÖ Firma e Invia Contratto</button>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            const contractId = new URLSearchParams(window.location.search).get('contractId');
            
            async function loadContract() {
                if (!contractId) {
                    showError('ID contratto mancante');
                    return;
                }
                
                try {
                    const response = await fetch(\`/api/contracts/\${contractId}\`);
                    if (!response.ok) throw new Error('Contratto non trovato');
                    
                    const contractData = await response.json();
                    
                    document.getElementById('clientName').textContent = \`\${contractData.nomeCliente || ''} \${contractData.cognomeCliente || ''}\`;
                    document.getElementById('serviceName').textContent = contractData.servizio || 'eCura PRO';
                    document.getElementById('planName').textContent = contractData.piano || 'AVANZATO';
                    document.getElementById('deviceName').textContent = contractData.dispositivo || 'SiDLY Care PRO';
                    document.getElementById('price').textContent = contractData.prezzo || '‚Ç¨1.024,80/anno';
                    document.getElementById('contractCode').textContent = contractData.contractCode || '';
                    document.getElementById('contractHtml').innerHTML = contractData.contractHtml || '<p>Contenuto contratto non disponibile</p>';
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('contractContent').style.display = 'block';
                    
                    initCanvas();
                } catch (error) {
                    showError('Errore caricamento contratto: ' + error.message);
                }
            }
            
            function showError(message) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').textContent = '‚ùå ' + message;
                document.getElementById('error').style.display = 'block';
            }
            
            let canvas, ctx, drawing = false;
            
            function initCanvas() {
                canvas = document.getElementById('signatureCanvas');
                ctx = canvas.getContext('2d');
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);
                
                canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e.touches[0]); });
                canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
                canvas.addEventListener('touchend', stopDrawing);
                
                document.getElementById('clearBtn').addEventListener('click', clearCanvas);
                document.getElementById('signButton').addEventListener('click', submitSignature);
            }
            
            function startDrawing(e) {
                drawing = true;
                const rect = canvas.getBoundingClientRect();
                ctx.beginPath();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            }
            
            function draw(e) {
                if (!drawing) return;
                const rect = canvas.getBoundingClientRect();
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                ctx.stroke();
            }
            
            function stopDrawing() {
                drawing = false;
            }
            
            function clearCanvas() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            
            function isCanvasEmpty() {
                const blank = document.createElement('canvas');
                blank.width = canvas.width;
                blank.height = canvas.height;
                return canvas.toDataURL() === blank.toDataURL();
            }
            
            async function submitSignature() {
                if (!document.getElementById('consentCheckbox').checked) {
                    alert('Per favore, accetta il consenso prima di firmare');
                    return;
                }
                
                if (isCanvasEmpty()) {
                    alert('Per favore, firma il contratto prima di inviare');
                    return;
                }
                
                const signButton = document.getElementById('signButton');
                signButton.disabled = true;
                signButton.textContent = '‚è≥ Invio firma in corso...';
                
                try {
                    const signatureData = canvas.toDataURL('image/png');
                    const response = await fetch('/api/contracts/sign', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contractId,
                            signatureData,
                            timestamp: new Date().toISOString(),
                            userAgent: navigator.userAgent,
                            screenResolution: \`\${screen.width}x\${screen.height}\`
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('‚úÖ Contratto firmato con successo!\\n\\nRiceverai una copia via email a breve.');
                        window.location.href = '/';
                    } else {
                        // Mostra errore dettagliato
                        let errorMsg = 'Errore durante la firma del contratto:\\n\\n';
                        errorMsg += result.error || 'Errore sconosciuto';
                        if (result.error === 'Contratto gi√† firmato') {
                            errorMsg += '\\n\\nQuesto contratto √® gi√† stato firmato in precedenza.';
                        } else if (result.error === 'Contratto non trovato') {
                            errorMsg += '\\n\\nID contratto non valido o scaduto.';
                        }
                        throw new Error(errorMsg);
                    }
                } catch (error) {
                    alert('‚ùå ' + error.message);
                    signButton.disabled = false;
                    signButton.textContent = '‚úÖ Firma e Invia Contratto';
                }
            }
            
            function printContract() {
                const contractHtml = document.getElementById('contractHtml').innerHTML;
                const contractCode = document.getElementById('contractCode').textContent;
                const clientName = document.getElementById('clientName').textContent;
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(\`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Contratto \${contractCode} - \${clientName}</title>
                        <style>
                            body { font-family: Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; }
                            h1, h2 { color: #333; }
                            .party { background: #f9f9f9; border-left: 4px solid #0066cc; padding: 15px; margin: 20px 0; }
                            @media print { body { padding: 0; } }
                        </style>
                    </head>
                    <body>
                        \${contractHtml}
                        <div style="margin-top: 60px; padding-top: 20px; border-top: 2px solid #ccc;">
                            <p style="text-align: center; color: #666; font-size: 12px;">
                                Documento stampato da TeleMedCare - Contratto \${contractCode}<br>
                                Cliente: \${clientName}<br>
                                Data stampa: \${new Date().toLocaleString('it-IT')}
                            </p>
                        </div>
                    </body>
                    </html>
                \`);
                printWindow.document.close();
                setTimeout(() => printWindow.print(), 250);
            }
            
            function downloadContract() {
                alert('üì• Funzionalit√† download PDF in arrivo!\\n\\nPer ora puoi stampare il contratto e salvarlo come PDF dal dialog di stampa.');
                printContract();
            }
            
            loadContract();
        <\/script>
    </body>
    </html>
  `):t.html(`
      <!DOCTYPE html>
      <html lang="it">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Errore</title>
        <style>
          body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; text-align: center; }
          h1 { color: #e74c3c; }
        </style>
      </head>
      <body>
        <h1>‚ùå Errore</h1>
        <p>ID contratto mancante</p>
        <p>Contatta <a href="mailto:info@telemedcare.it">info@telemedcare.it</a> per assistenza.</p>
      </body>
      </html>
    `,400));I.get("/dashboard-live",async t=>t.redirect("/test-email-debug"));I.get("/test-email-debug",async t=>t.html(`
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEST Email Count - TeleMedCare</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 30px auto; padding: 20px; background: #f5f7fa; }
        .container { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #667eea; margin-bottom: 20px; }
        .result { padding: 20px; margin: 15px 0; border-radius: 8px; }
        .success { background: #d4edda; border-left: 5px solid #28a745; }
        .error { background: #f8d7da; border-left: 5px solid #dc3545; }
        .info { background: #d1ecf1; border-left: 5px solid #17a2b8; }
        .kpi { font-size: 64px; font-weight: bold; color: #667eea; text-align: center; margin: 20px 0; }
        .kpi-label { text-align: center; color: #666; font-size: 18px; margin-bottom: 10px; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; max-height: 400px; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 30px 0; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; text-align: center; }
        .stat-value { font-size: 48px; font-weight: bold; margin: 10px 0; }
        .stat-label { font-size: 14px; opacity: 0.9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêõ Test Diagnostico Email Count</h1>
        
        <div id="status" class="result info">
            ‚è≥ Caricamento in corso...
        </div>
        
        <div id="stats"></div>
        <div id="result"></div>
        
        <h3>üìã Log di Debug:</h3>
        <pre id="logs"></pre>
    </div>
    
    <script>
        const logs = [];
        
        function log(msg) {
            const time = new Date().toISOString().split('T')[1].split('.')[0];
            logs.push(\`[\${time}] \${msg}\`);
            console.log(msg);
            document.getElementById('logs').textContent = logs.join('\\n');
        }
        
        async function test() {
            try {
                log('üöÄ START TEST');
                log('üì° Fetch /api/leads?limit=100...');
                
                const res = await fetch('/api/leads?limit=100');
                log(\`‚úÖ Status: \${res.status}\`);
                
                const data = await res.json();
                const leads = data.leads || [];
                log(\`‚úÖ Lead caricati: \${leads.length}\`);
                
                const now = new Date();
                const cutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                log(\`üìÖ Cutoff: \${cutoff.toISOString()}\`);
                
                let emailCount = 0;
                let contractCount = 0;
                
                leads.forEach(lead => {
                    const date = new Date(lead.created_at || lead.timestamp);
                    if (date >= cutoff) {
                        if (lead.vuoleBrochure === 'Si' || lead.vuoleContratto === 'Si' || lead.vuoleManuale === 'Si') {
                            emailCount++;
                        }
                        if (lead.vuoleContratto === 'Si') {
                            contractCount++;
                        }
                    }
                });
                
                log(\`üìß Email count: \${emailCount}\`);
                log(\`üìù Contract count: \${contractCount}\`);
                
                document.getElementById('status').className = 'result success';
                document.getElementById('status').innerHTML = '‚úÖ Test completato!';
                
                document.getElementById('stats').innerHTML = \`
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Email Inviate</div>
                            <div class="stat-value">\${emailCount}</div>
                            <div class="stat-label">Ultimi 30 giorni</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Contratti Inviati</div>
                            <div class="stat-value">\${contractCount}</div>
                            <div class="stat-label">Ultimi 30 giorni</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Lead Totali</div>
                            <div class="stat-value">\${leads.length}</div>
                            <div class="stat-label">Database</div>
                        </div>
                    </div>
                \`;
                
                document.getElementById('result').innerHTML = \`
                    <div class="result success">
                        <h3>‚úÖ RISULTATO:</h3>
                        <p><strong>Il calcolo JavaScript funziona correttamente!</strong></p>
                        <p>Se la dashboard mostra 0, il problema √® interferenza con altri script o errori nel caricamento.</p>
                    </div>
                \`;
                
                log('‚úÖ DONE');
                
            } catch (err) {
                log(\`‚ùå ERROR: \${err.message}\`);
                document.getElementById('status').className = 'result error';
                document.getElementById('status').innerHTML = \`‚ùå Errore: \${err.message}\`;
                document.getElementById('result').innerHTML = \`
                    <div class="result error">
                        <h3>‚ùå ERRORE:</h3>
                        <pre>\${err.stack}</pre>
                    </div>
                \`;
            }
        }
        
        test();
    <\/script>
</body>
</html>
  `));I.get("/test-insert-manual-contracts",async t=>t.html(`
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inserimento Contratti Manuali</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #667eea;
      margin-bottom: 30px;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      opacity: 0.9;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 5px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 12px;
    }
    .success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .warning {
      background: #fff3cd;
      padding: 15px;
      border-left: 4px solid #ffc107;
      margin-bottom: 20px;
    }
    .contract-list {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
    }
    .contract-item {
      padding: 10px;
      margin: 5px 0;
      background: white;
      border-left: 3px solid #667eea;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìù Inserimento Contratti Manuali</h1>
    
    <div class="warning">
      <strong>‚ö†Ô∏è Attenzione:</strong> Questo strumento inserisce contratti per <strong>lead gi√† esistenti</strong> nel database.<br>
      Se un lead non viene trovato o ha gi√† un contratto, l'operazione verr√† saltata con un messaggio di errore.
    </div>
    
    <div class="contract-list">
      <h3>Contratti da inserire per lead esistenti:</h3>
      <div class="contract-item">
        <strong>1. Giovanni Locatelli (assistito)</strong><br>
        Lead: Alberto Locatelli (figlio/richiedente)<br>
        Servizio: eCura PRO BASE - SIDLY VITAL CARE<br>
        Data firma: 03/02/2026<br>
        Prezzo: ‚Ç¨480.00 + IVA = ‚Ç¨585.60
      </div>
      <div class="contract-item">
        <strong>2. Francesco Pepe</strong><br>
        Lead: Francesco Pepe (intestatario = richiedente)<br>
        Servizio: eCura PRO BASE<br>
        Data firma: 27/01/2026<br>
        Prezzo: ‚Ç¨480.00 + IVA = ‚Ç¨585.60
      </div>
      <div class="contract-item">
        <strong>3. Claudio Macchi</strong><br>
        Lead: Claudio Macchi (intestatario = richiedente)<br>
        Servizio: eCura PRO BASE<br>
        Data firma: 01/02/2026<br>
        Prezzo: ‚Ç¨480.00 + IVA = ‚Ç¨585.60
      </div>
    </div>

    <button id="insertBtn" onclick="insertContracts()">üöÄ Inserisci Contratti nel Database</button>
    <button onclick="window.location.href='/admin/leads-dashboard'">üìä Vai alla Dashboard</button>
    
    <div id="result"></div>
  </div>

  <script>
    async function insertContracts() {
      const btn = document.getElementById('insertBtn')
      const resultDiv = document.getElementById('result')
      
      btn.disabled = true
      btn.textContent = '‚è≥ Inserimento in corso...'
      resultDiv.innerHTML = ''
      
      const contracts = [
        {
          nome: 'Alberto',
          cognome: 'LOCATELLI',
          nomeAssistito: 'Giovanni',
          cognomeAssistito: 'LOCATELLI',
          email: 'alberto.locatelli@example.com',
          telefono: '+39 333 1234001',
          servizio: 'eCura PRO',
          piano: 'BASE',
          dispositivo: 'SIDLY VITAL CARE',
          dataFirma: '2026-02-03',
          prezzoBase: 480.00,
          prezzoTotale: 585.60
        },
        {
          nome: 'Francesco',
          cognome: 'PEPE',
          email: 'francesco.pepe@example.com',
          telefono: '+39 333 1234002',
          servizio: 'eCura PRO',
          piano: 'BASE',
          dispositivo: 'SIDLY VITAL CARE',
          dataFirma: '2026-01-27',
          prezzoBase: 480.00,
          prezzoTotale: 585.60
        },
        {
          nome: 'Claudio',
          cognome: 'MACCHI',
          email: 'claudio.macchi@example.com',
          telefono: '+39 333 1234003',
          servizio: 'eCura PRO',
          piano: 'BASE',
          dispositivo: 'SIDLY VITAL CARE',
          dataFirma: '2026-02-01',
          prezzoBase: 480.00,
          prezzoTotale: 585.60
        }
      ]
      
      try {
        const response = await fetch('/api/contracts/bulk-manual', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ contracts })
        })
        
        const data = await response.json()
        
        if (data.success) {
          resultDiv.className = 'result success'
          resultDiv.textContent = \`‚úÖ \${data.message}\\n\\nDettagli:\\n\${JSON.stringify(data.results, null, 2)}\`
        } else {
          resultDiv.className = 'result error'
          resultDiv.textContent = \`‚ùå Errore: \${data.error || 'Errore sconosciuto'}\\n\\n\${JSON.stringify(data, null, 2)}\`
        }
        
      } catch (error) {
        resultDiv.className = 'result error'
        resultDiv.textContent = \`‚ùå Errore di rete: \${error.message}\`
      } finally {
        btn.disabled = false
        btn.textContent = 'üöÄ Inserisci Contratti nel Database'
      }
    }
  <\/script>
</body>
</html>
  `));I.get("/test-fix-3-contracts",async t=>t.html(`<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîß Correggi 3 Contratti Manuali</title>
  <style>
    body { font-family: Arial; max-width: 900px; margin: 50px auto; padding: 20px; background: #f5f5f5; }
    .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { color: #ff4444; margin-bottom: 30px; }
    button { background: linear-gradient(135deg, #ff4444 0%, #ff6b6b 100%); color: white; border: none; padding: 15px 30px; font-size: 16px; border-radius: 5px; cursor: pointer; margin-right: 10px; }
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .result { margin-top: 20px; padding: 15px; border-radius: 5px; white-space: pre-wrap; font-family: monospace; font-size: 12px; }
    .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    .warning { background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin-bottom: 20px; }
    .error-box { background: #ffe5e5; padding: 15px; border-left: 4px solid #ff4444; margin-bottom: 20px; }
    .contract-list { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
    .contract-item { padding: 10px; margin: 5px 0; background: white; border-left: 3px solid #ff4444; font-size: 14px; }
    .fix-info { background: #e8f5e9; padding: 15px; border-left: 4px solid #4caf50; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Correzione 3 Contratti Manuali</h1>
    
    <div class="error-box">
      <strong>üö® Problema Rilevato:</strong><br>
      I 3 contratti inseriti manualmente hanno ID e codice_contratto NON corrispondenti al formato richiesto dal database.<br>
      <br>
      <strong>Errori:</strong>
      <ul>
        <li>ID sbagliato: <code>contract-locatelli-...</code> invece di <code>CONTRACT_CTR-LOCATELLI-2026_...</code></li>
        <li>codice_contratto corretto ma ID sbagliato</li>
        <li>Date non corrispondenti ai PDF</li>
        <li>PDF non collegati</li>
      </ul>
    </div>
    
    <div class="contract-list">
      <h3>üìã Contratti da CORREGGERE:</h3>
      <div class="contract-item">
        <strong>1. Alberto Locatelli (per assistito Giovanni)</strong><br>
        ‚ùå ID vecchio: <code>contract-locatelli-1771122740756</code><br>
        ‚úÖ ID corretto: <code>CONTRACT_CTR-LOCATELLI-2026_[timestamp]</code><br>
        Data firma: <strong>03/02/2026</strong> ‚Üí Scadenza: <strong>02/02/2027</strong><br>
        PDF: <code>03.02.2026_signor Locatelli_BASE_SIDLY VITAL CARE.pdf</code>
      </div>
      <div class="contract-item">
        <strong>2. Francesco Pepe</strong><br>
        ‚ùå ID vecchio: <code>contract-pepe-1771122740794</code><br>
        ‚úÖ ID corretto: <code>CONTRACT_CTR-PEPE-2026_[timestamp]</code><br>
        Data firma: <strong>27/01/2026</strong> ‚Üí Scadenza: <strong>26/01/2027</strong><br>
        PDF: <code>27.01.2026_Pepe Francesco Contratto.pdf</code>
      </div>
      <div class="contract-item">
        <strong>3. Claudio Macchi</strong><br>
        ‚ùå ID vecchio: <code>contract-macchi-1771122740833</code><br>
        ‚úÖ ID corretto: <code>CONTRACT_CTR-MACCHI-2026_[timestamp]</code><br>
        Data firma: <strong>01/02/2026</strong> ‚Üí Scadenza: <strong>31/01/2027</strong><br>
        PDF: <code>Documento x Claudio Macchi.pdf</code>
      </div>
    </div>

    <div class="fix-info">
      <strong>‚úÖ Cosa far√† questo tool:</strong>
      <ol>
        <li>Cancella i 3 contratti con ID sbagliati</li>
        <li>Re-inserisce i contratti con:
          <ul>
            <li>ID corretto = codice_contratto (formato <code>CONTRACT_CTR-COGNOME-ANNO_TIMESTAMP</code>)</li>
            <li>Date corrette dai PDF</li>
            <li>Scadenza calcolata (data firma + 12 mesi - 1 giorno)</li>
            <li>Collegamento ai PDF originali</li>
          </ul>
        </li>
        <li>Mantiene il collegamento ai lead esistenti</li>
      </ol>
    </div>

    <button id="fixBtn" onclick="fixContracts()">üîß Correggi i 3 Contratti</button>
    <button onclick="window.location.href='/admin/leads-dashboard'">üìä Vai alla Dashboard</button>
    
    <div id="result"></div>
  </div>

  <script>
    async function fixContracts() {
      const btn = document.getElementById('fixBtn');
      const resultDiv = document.getElementById('result');
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Correzione in corso...';
      resultDiv.innerHTML = '';

      try {
        const response = await fetch('/api/contracts/fix-manual-3', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();
        
        if (data.success) {
          resultDiv.className = 'result success';
          resultDiv.textContent = '‚úÖ ' + data.message + '\\n\\nDettagli:\\n' + 
            data.results.map((r, i) => 
              \`- \${r.cliente}: \${r.success ? '‚úÖ OK' : '‚ùå ' + r.error}\\n  ID: \${r.contractId || 'N/A'}\\n  Code: \${r.contractCode || 'N/A'}\\n  Data firma: \${r.dataFirma || 'N/A'} ‚Üí Scadenza: \${r.dataScadenza || 'N/A'}\\n  PDF: \${r.pdfUrl || 'N/A'}\`
            ).join('\\n\\n');
        } else {
          resultDiv.className = 'result error';
          resultDiv.textContent = '‚ùå ' + data.message + '\\n\\nDettagli:\\n' + 
            data.results.map((r, i) => \`- \${r.cliente}: \${r.error || 'Unknown error'}\`).join('\\n');
        }
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.textContent = '‚ùå Errore di rete: ' + error.message;
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîß Correggi i 3 Contratti';
      }
    }
  <\/script>
</body>
</html>`));I.get("/test-update-contracts-dates",async t=>t.html(`
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aggiorna Date Contratti</title>
  <style>
    body { font-family: Arial; max-width: 900px; margin: 50px auto; padding: 20px; background: #f5f5f5; }
    .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { color: #667eea; margin-bottom: 30px; }
    button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 30px; font-size: 16px; border-radius: 5px; cursor: pointer; margin-right: 10px; }
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .result { margin-top: 20px; padding: 15px; border-radius: 5px; white-space: pre-wrap; font-family: monospace; font-size: 12px; }
    .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    .warning { background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin-bottom: 20px; }
    .contract-list { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
    .contract-item { padding: 10px; margin: 5px 0; background: white; border-left: 3px solid #667eea; font-size: 14px; }
    .renewal-warning { background: #ffe5e5; padding: 15px; border-left: 4px solid #ff4444; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìÖ Aggiorna Date Contratti Esistenti</h1>
    
    <div class="warning">
      <strong>‚ö†Ô∏è Importante:</strong> Questo tool aggiorna le date di firma e scadenza dei contratti esistenti.<br>
      Le date corrette sono fondamentali per la gestione dei rinnovi.
    </div>
    
    <div class="contract-list">
      <h3>Contratti da aggiornare (6 in scadenza prossimamente):</h3>
      <div class="contract-item">
        <strong>1. Maria Capone</strong><br>
        Data firma: 30/06/2025 ‚Üí Scadenza: 30/06/2026
      </div>
      <div class="contract-item">
        <strong>2. Rita Pennacchio</strong><br>
        Data firma: 12/05/2025 ‚Üí Scadenza: 11/05/2026
      </div>
      <div class="contract-item">
        <strong>3. Giuseppina Cozzi</strong><br>
        Data firma: 14/07/2025 ‚Üí Scadenza: 13/07/2026
      </div>
      <div class="contract-item">
        <strong>4. Eileen King</strong><br>
        Data firma: 08/05/2025 ‚Üí Scadenza: 07/05/2026
      </div>
      <div class="contract-item">
        <strong>5. Gianni Paolo Pizzutto</strong><br>
        Data firma: 12/05/2025 ‚Üí Scadenza: 11/05/2026
      </div>
      <div class="contract-item">
        <strong>6. Giuseppina Balzarotti (richiedente: Paolo Magri)</strong><br>
        Data firma: 13/06/2025 ‚Üí Scadenza: 12/06/2026
      </div>
    </div>

    <div class="renewal-warning">
      <strong>üîî Gestione Rinnovi:</strong><br>
      Questi 6 assistiti necessiteranno di rinnovo nei prossimi mesi (2026).<br>
      Dopo l'aggiornamento, le date corrette saranno visibili nella dashboard.
    </div>

    <button id="updateBtn" onclick="updateDates()">üîÑ Aggiorna Date Contratti</button>
    <button onclick="window.location.href='/admin/leads-dashboard'">üìä Vai alla Dashboard</button>
    
    <div id="result"></div>
  </div>

  <script>
    async function updateDates() {
      const btn = document.getElementById('updateBtn')
      const resultDiv = document.getElementById('result')
      
      btn.disabled = true
      btn.textContent = '‚è≥ Aggiornamento in corso...'
      resultDiv.innerHTML = ''
      
      const contracts = [
        { nome: 'Maria', cognome: 'CAPONE', data_firma: '2025-06-30', data_scadenza: '2026-06-30' },
        { nome: 'Rita', cognome: 'PENNACCHIO', data_firma: '2025-05-12', data_scadenza: '2026-05-11' },
        { nome: 'Giuseppina', cognome: 'COZZI', data_firma: '2025-07-14', data_scadenza: '2026-07-13' },
        { nome: 'Eileen', cognome: 'KING', data_firma: '2025-05-08', data_scadenza: '2026-05-07' },
        { nome: 'Gianni Paolo', cognome: 'PIZZUTTO', data_firma: '2025-05-12', data_scadenza: '2026-05-11' },
        { nome: 'Giuseppina', cognome: 'BALZAROTTI', richiedente_nome: 'Paolo', richiedente_cognome: 'MAGRI', data_firma: '2025-06-13', data_scadenza: '2026-06-12' }
      ]
      
      try {
        const response = await fetch('/api/contracts/update-dates', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contracts })
        })
        
        const data = await response.json()
        
        if (data.success) {
          resultDiv.className = 'result success'
          resultDiv.textContent = \`‚úÖ \${data.message}\\n\\nDettagli:\\n\${JSON.stringify(data.results, null, 2)}\`
        } else {
          resultDiv.className = 'result error'
          resultDiv.textContent = \`‚ùå Errore: \${data.error || 'Errore sconosciuto'}\\n\\n\${JSON.stringify(data, null, 2)}\`
        }
      } catch (error) {
        resultDiv.className = 'result error'
        resultDiv.textContent = \`‚ùå Errore di rete: \${error.message}\`
      } finally {
        btn.disabled = false
        btn.textContent = 'üîÑ Aggiorna Date Contratti'
      }
    }
  <\/script>
</body>
</html>
  `));I.post("/api/contracts/sign",async t=>{var o;try{const e=await t.req.json(),{contractId:a,signatureData:i,firmaDigitale:r,timestamp:s,userAgent:l,screenResolution:d,ipAddress:c}=e,u=i||r||"Firma Manuale";if(!a||!u)return t.json({success:!1,error:"Dati firma mancanti"},400);if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const p=await t.env.DB.prepare("SELECT * FROM contracts WHERE id = ?").bind(a).first();if(!p)return t.json({success:!1,error:"Contratto non trovato"},404);if(p.status==="SIGNED")return t.json({success:!1,error:"Contratto gi√† firmato"},400);const g=c||t.req.header("cf-connecting-ip")||t.req.header("x-forwarded-for")||t.req.header("x-real-ip")||"unknown";await t.env.DB.prepare(`
      UPDATE contracts 
      SET status = 'SIGNED',
          signature_data = ?,
          signature_ip = ?,
          signature_timestamp = ?,
          signature_user_agent = ?,
          signature_screen_resolution = ?,
          signed_at = ?,
          signature_method = 'inline'
      WHERE id = ?
    `).bind(u,g,s||new Date().toISOString(),l||"",d||"",new Date().toISOString(),a).run(),console.log(`‚úÖ Contratto firmato: ${a} da IP ${g}`);try{const m=await t.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(p.leadId).first();if(m&&t.env.RESEND_API_KEY){console.log(`üìß Invio email conferma firma a ${m.email}`);const b=`
          ${p.contenuto_html}
          <div style="margin-top: 60px; page-break-inside: avoid;">
            <h2 style="text-align: center; margin-bottom: 40px;">Firme</h2>
            <div style="display: flex; justify-content: space-between; gap: 40px;">
              <div style="flex: 1; text-align: center;">
                <p style="font-weight: bold; margin-bottom: 20px;">Il Cliente</p>
                ${u.startsWith("data:image")?`<img src="${u}" style="max-width: 300px; border: 1px solid #ccc; padding: 10px;">`:`<p style="font-style: italic;">${u}</p>`}
                <p style="margin-top: 10px; font-size: 12px; color: #666;">
                  Firma digitale apposta il ${new Date(s||Date.now()).toLocaleString("it-IT")}<br>
                  IP: ${g}
                </p>
              </div>
              <div style="flex: 1; text-align: center;">
                <p style="font-weight: bold; margin-bottom: 20px;">Per Medica GB S.r.l.</p>
                <p style="margin-top: 80px; font-size: 14px;">
                  <strong>Stefania Rocca</strong><br>
                  Amministratore Delegato<br>
                  Medica GB S.r.l.
                </p>
                <p style="margin-top: 10px; font-size: 12px; color: #666;">
                  Firma depositata presso sede legale<br>
                  Corso Giuseppe Garibaldi, 34 ‚Äì 20121 Milano
                </p>
              </div>
            </div>
          </div>
        `,h=`
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
              .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
              .content { padding: 30px; }
              .footer { background: #f8f9fa; padding: 20px; text-align: center; font-size: 12px; color: #666; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>‚úÖ Contratto Firmato con Successo</h1>
              <p>TeleMedCare - Servizio eCura</p>
            </div>
            <div class="content">
              <p>Gentile <strong>${m.nomeRichiedente} ${m.cognomeRichiedente}</strong>,</p>
              
              <p>Grazie per aver firmato il contratto <strong>${p.codice_contratto}</strong>!</p>
              
              <p>‚úÖ <strong>La tua firma digitale √® stata registrata con successo.</strong></p>
              
              <p><strong>Dettagli Contratto:</strong></p>
              <ul>
                <li>Servizio: ${p.servizio||"eCura PRO"}</li>
                <li>Piano: ${p.piano||"BASE"}</li>
                <li>Investimento: ‚Ç¨${p.prezzo_totale||"585.60"}/anno</li>
                <li>Data firma: ${new Date().toLocaleDateString("it-IT")}</li>
              </ul>
              
              <p><strong>üì¨ Prossimi Passi:</strong></p>
              <ol>
                <li><strong>Pro-forma per pagamento</strong> - Riceverai a breve un'email con la pro-forma e il link per il pagamento (Stripe o bonifico bancario)</li>
                <li><strong>Attivazione servizio</strong> - Dopo il pagamento, il servizio verr√† attivato entro 24-48 ore</li>
                <li><strong>Configurazione dispositivo</strong> - Riceverai le istruzioni per configurare il dispositivo SiDLY</li>
              </ol>
              
              <p>üí° <em>Il contratto firmato sar√† disponibile nel tuo pannello personale e verr√† incluso nella prossima comunicazione.</em></p>
              
              <p>Per qualsiasi domanda, contattaci a <a href="mailto:info@telemedcare.it">info@telemedcare.it</a></p>
              
              <p>Cordiali saluti,<br><strong>Il Team TeleMedCare</strong></p>
            </div>
            <div class="footer">
              <p>Medica GB S.r.l. - Corso Giuseppe Garibaldi, 34 ‚Äì 20121 Milano</p>
              <p>P.IVA: 12435130963 | Email: info@telemedcare.it | Web: www.telemedcare.it</p>
            </div>
          </body>
          </html>
        `,E=await fetch("https://api.resend.com/emails",{method:"POST",headers:{Authorization:`Bearer ${t.env.RESEND_API_KEY}`,"Content-Type":"application/json"},body:JSON.stringify({from:"TeleMedCare <noreply@telemedcare.it>",to:[m.email],cc:["info@telemedcare.it"],subject:`‚úÖ Contratto Firmato - ${p.codice_contratto}`,html:h})});E.ok?console.log(`‚úÖ Email conferma inviata a ${m.email}`):console.error(`‚ùå Errore invio email: ${await E.text()}`)}}catch(m){console.error("‚ö†Ô∏è Errore invio email (firma salvata comunque):",m)}try{console.log(`üìä [FIRMA‚ÜíPROFORMA] Avvio workflow proforma per contratto ${a}`);const m=await t.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(p.leadId).first();if(m&&t.env.RESEND_API_KEY){console.log(`üìß [FIRMA‚ÜíPROFORMA] Lead recuperato: ${m.nomeRichiedente} ${m.cognomeRichiedente}`);const{inviaEmailProforma:b}=await Promise.resolve().then(()=>Pc),h=`PRF-${Date.now()}`,E=new Date().getFullYear(),w=String(new Date().getMonth()+1).padStart(2,"0"),S=Math.random().toString(36).substring(2,6).toUpperCase(),C=`PRF${E}${w}-${S}`,R=p.piano||"BASE",z=p.servizio||"eCura PRO",D=p.prezzo_totale||(R==="AVANZATO"?840:480),F=R==="AVANZATO"?1024.8:585.6,L={proformaId:h,numeroProforma:C,proformaPdfUrl:"",tipoServizio:R,servizio:z,prezzoBase:D,prezzoIvaInclusa:F,dataScadenza:new Date(Date.now()+720*60*60*1e3).toISOString()};console.log("üìä [FIRMA‚ÜíPROFORMA] Dati proforma:",JSON.stringify(L,null,2));try{await t.env.DB.prepare(`
            INSERT INTO proformas (
              id, leadId, numero_proforma, 
              data_emissione, data_scadenza, 
              importo_base, importo_iva, importo_totale,
              valuta, status, 
              servizio, piano,
              created_at, updated_at
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          `).bind(h,m.id,C,new Date().toISOString().split("T")[0],new Date(Date.now()+720*60*60*1e3).toISOString().split("T")[0],D,(F-D).toFixed(2),F,"EUR","GENERATED",z,R,new Date().toISOString(),new Date().toISOString()).run(),console.log(`‚úÖ [FIRMA‚ÜíPROFORMA] Proforma ${C} salvata nel DB`)}catch(j){console.error("‚ùå [FIRMA‚ÜíPROFORMA] Errore salvataggio proforma nel DB:",j)}const M=await b(m,L,t.env,t.env.DB);M.success?(console.log(`‚úÖ [FIRMA‚ÜíPROFORMA] Proforma ${C} inviata con successo a ${m.email}`),console.log("‚úÖ [FIRMA‚ÜíPROFORMA] Email IDs:",M.messageIds)):console.error("‚ùå [FIRMA‚ÜíPROFORMA] Errore invio proforma:",M.errors)}else console.warn("‚ö†Ô∏è [FIRMA‚ÜíPROFORMA] Lead non trovato o RESEND_API_KEY mancante - proforma NON inviata")}catch(m){console.error("‚ö†Ô∏è [FIRMA‚ÜíPROFORMA] Errore trigger proforma (firma salvata comunque):",m),console.error("‚ö†Ô∏è [FIRMA‚ÜíPROFORMA] Stack:",m==null?void 0:m.stack)}return t.json({success:!0,message:"Contratto firmato con successo",contractId:a})}catch(e){return console.error("‚ùå Errore salvataggio firma:",e),t.json({success:!1,error:"Errore durante il salvataggio della firma",details:e instanceof Error?e.message:String(e)},500)}});const yn=[],xT=100;function it(t){const o=new Date().toISOString();yn.unshift(`[${o}] ${t}`),yn.length>xT&&yn.pop(),console.log(t)}I.get("/api/debug/logs",async t=>t.json({success:!0,logs:yn,count:yn.length}));I.get("/api/debug/env",async t=>t.json({success:!0,environment:{RESEND_API_KEY:t.env.RESEND_API_KEY?`${t.env.RESEND_API_KEY.substring(0,10)}...`:"NOT SET",SENDGRID_API_KEY:t.env.SENDGRID_API_KEY?`${t.env.SENDGRID_API_KEY.substring(0,10)}...`:"NOT SET",EMAIL_FROM:t.env.EMAIL_FROM||"NOT SET",EMAIL_TO_INFO:t.env.EMAIL_TO_INFO||"NOT SET",JWT_SECRET:t.env.JWT_SECRET?"SET (hidden)":"NOT SET",ENCRYPTION_KEY:t.env.ENCRYPTION_KEY?"SET (hidden)":"NOT SET",DEBUG_MODE:t.env.DEBUG_MODE||"NOT SET",ENVIRONMENT:t.env.ENVIRONMENT||"NOT SET",DB:t.env.DB?"CONNECTED":"NOT CONNECTED"}}));I.get("/api/debug/email-templates",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database not configured"},500);const e=await t.env.DB.prepare("SELECT id, name, subject, LENGTH(content) as content_length, created_at, updated_at FROM email_templates ORDER BY name").all();return t.json({success:!0,count:e.results.length,templates:e.results})}catch(e){return t.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.post("/api/debug/test-contract-save",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"DB non disponibile"},500);const e=`LEAD-TEST-${Date.now()}`;await t.env.DB.prepare(`
      INSERT INTO leads (
        id, nomeRichiedente, cognomeRichiedente, email, status, created_at, timestamp
      ) VALUES (?, ?, ?, ?, ?, ?, ?)
    `).bind(e,"Test","Contract","test@example.com","NEW",new Date().toISOString(),new Date().toISOString()).run();const a={id:`contract-test-${Date.now()}`,leadId:e,codice_contratto:`TEST-${Date.now()}`,tipo_contratto:"BASE",template_utilizzato:"TEST_TEMPLATE",contenuto_html:"<html><body>TEST</body></html>",status:"PENDING",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),servizio:"eCura PRO",piano:"BASE",prezzo_mensile:40,durata_mesi:12,prezzo_totale:585.6,email_template_used:"test",pdf_generated:0,email_sent:1};console.log("üß™ [DEBUG] Tentativo salvataggio contratto test:",a.id);const i=await t.env.DB.prepare(`
      INSERT INTO contracts (
        id, leadId, codice_contratto, tipo_contratto, 
        template_utilizzato, contenuto_html, 
        pdf_generated, email_sent, email_template_used,
        status, servizio, piano, 
        prezzo_mensile, durata_mesi, prezzo_totale, 
        created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(a.id,a.leadId,a.codice_contratto,a.tipo_contratto,a.template_utilizzato,a.contenuto_html,a.pdf_generated,a.email_sent,a.email_template_used,a.status,a.servizio,a.piano,a.prezzo_mensile,a.durata_mesi,a.prezzo_totale,a.created_at,a.updated_at).run();console.log("‚úÖ [DEBUG] Contratto salvato:",i);const r=await t.env.DB.prepare("SELECT * FROM contracts WHERE id = ?").bind(a.id).first();return t.json({success:!0,message:"Contratto test salvato",testData:a,insertResult:i,savedContract:r})}catch(e){return console.error("‚ùå [DEBUG] Errore:",e),t.json({success:!1,error:e instanceof Error?e.message:String(e),stack:e==null?void 0:e.stack},500)}});I.get("/api/contracts",async t=>{var o,e;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const a=t.req.query("leadId");let i="SELECT * FROM contracts";const r=[];a&&(i+=" WHERE leadId = ?",r.push(a)),i+=" ORDER BY created_at DESC LIMIT 50";const s=t.env.DB.prepare(i),l=r.length>0?await s.bind(...r).all():await s.all();return console.log(`üìã Contratti trovati: ${((e=l.results)==null?void 0:e.length)||0}`),t.json({success:!0,contracts:l.results||[]})}catch(a){return console.error("‚ùå Errore recupero contratti:",a),t.json({success:!1,error:"Errore recupero contratti",details:a instanceof Error?a.message:String(a)},500)}});I.get("/api/contracts/:id",async t=>{var o,e;try{const a=t.req.param("id");if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const i=await t.env.DB.prepare("SELECT * FROM contracts WHERE id = ?").bind(a).first();if(!i)return t.json({success:!1,error:"Contratto non trovato"},404);let r="Cliente",s="",l="";if(i.leadId)try{const d=await t.env.DB.prepare("SELECT nomeRichiedente, cognomeRichiedente, email FROM leads WHERE id = ?").bind(i.leadId).first();d&&(r=d.nomeRichiedente||"Cliente",s=d.cognomeRichiedente||"",l=d.email||"")}catch(d){console.warn("‚ö†Ô∏è  Errore caricamento lead:",d)}return t.json({success:!0,id:i.id,leadId:i.leadId,nomeCliente:r,cognomeCliente:s,emailCliente:l,contractCode:i.codice_contratto||i.id,contractHtml:i.contenuto_html||"",servizio:i.servizio||"eCura PRO",piano:i.tipo_contratto||i.piano||"BASE",dispositivo:(e=i.servizio)!=null&&e.includes("PREMIUM")?"SiDLY Vital Care":"SiDLY Care PRO",prezzo:`‚Ç¨${parseFloat(i.prezzo_totale||i.prezzo_iva_inclusa||0).toFixed(2)}/anno`,status:i.status||"PENDING"})}catch(a){return console.error("‚ùå Errore recupero contratto:",a),t.json({success:!1,error:"Errore recupero contratto",details:a instanceof Error?a.message:String(a)},500)}});I.delete("/api/contracts/:id",async t=>{var o;try{const e=t.req.param("id");if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log(`üóëÔ∏è [DELETE CONTRACT] Richiesta eliminazione contratto: ${e}`);const a=await t.env.DB.prepare("SELECT id, leadId, codice_contratto FROM contracts WHERE id = ?").bind(e).first();return a?(console.log(`üìã [DELETE CONTRACT] Trovato contratto: ${a.codice_contratto} per lead ${a.leadId}`),await t.env.DB.prepare("DELETE FROM contracts WHERE id = ?").bind(e).run(),console.log(`‚úÖ [DELETE CONTRACT] Contratto ${e} eliminato con successo`),t.json({success:!0,message:`Contratto ${a.codice_contratto} eliminato con successo`,deletedId:e})):(console.log(`‚ö†Ô∏è [DELETE CONTRACT] Contratto ${e} non trovato`),t.json({success:!1,error:"Contratto non trovato"},404))}catch(e){return console.error("‚ùå Errore eliminazione contratto:",e),t.json({success:!1,error:"Errore durante l'eliminazione del contratto",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/contracts/bulk-manual",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const{contracts:e}=await t.req.json();if(!Array.isArray(e)||e.length===0)return t.json({success:!1,error:"Array contracts vuoto o non valido"},400);console.log(`üìù [BULK MANUAL CONTRACTS] Inserimento ${e.length} contratti manuali per lead esistenti...`);const a=[];for(const r of e)try{const s=await t.env.DB.prepare(`
          SELECT * FROM leads 
          WHERE UPPER(cognomeRichiedente) = UPPER(?) 
            AND UPPER(nomeRichiedente) = UPPER(?)
          LIMIT 1
        `).bind(r.cognome,r.nome).first();if(!s)throw new Error(`‚ùå Lead NON TROVATO per ${r.nome} ${r.cognome}. Il lead deve esistere prima di creare il contratto.`);console.log(`‚úÖ Lead trovato: ${s.id} - ${s.nomeRichiedente} ${s.cognomeRichiedente}`);const l=await t.env.DB.prepare(`
          SELECT id, codice_contratto, status FROM contracts 
          WHERE leadId = ?
          LIMIT 1
        `).bind(s.id).first();if(l){console.log(`‚ö†Ô∏è Contratto gi√† esistente per ${r.nome} ${r.cognome}: ${l.codice_contratto}`),a.push({success:!1,error:`Contratto gi√† esistente: ${l.codice_contratto} (status: ${l.status})`,leadId:s.id,existingContractId:l.id,existingContractCode:l.codice_contratto,cliente:`${r.nome} ${r.cognome}`});continue}const d=Date.now(),c=new Date(r.dataFirma).getFullYear(),u=`CTR-${r.cognome.toUpperCase()}-${c}`,p=`CONTRACT_CTR-${r.cognome.toUpperCase()}-${c}_${d}`,g=r.prezzoTotale||585.6,m=(g/12).toFixed(2),b=new Date(r.dataFirma),h=new Date(b);h.setFullYear(h.getFullYear()+1),h.setDate(h.getDate()-1);const E=r.piano||"BASE",w=`Template_Contratto_${E}_TeleMedCare`,S=r.pdfUrl||"";await t.env.DB.prepare(`
          INSERT INTO contracts (
            id, leadId, codice_contratto, tipo_contratto, template_utilizzato,
            contenuto_html, servizio, piano,
            prezzo_mensile, durata_mesi, prezzo_totale, 
            data_scadenza, status, pdf_url,
            created_at, updated_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 12, ?, ?, 'SIGNED', ?, datetime('now'), datetime('now'))
        `).bind(p,s.id,u,E,w,"",r.servizio||"eCura PRO",E,parseFloat(m),g,h.toISOString().split("T")[0],S).run(),console.log(`‚úÖ Contratto inserito: ${u} per ${r.nome} ${r.cognome}`),console.log(`   Data firma: ${r.dataFirma} ‚Üí Scadenza: ${h.toISOString().split("T")[0]}`),a.push({success:!0,leadId:s.id,contractId:p,contractCode:u,cliente:`${r.nome} ${r.cognome}`,dataFirma:r.dataFirma,dataScadenza:h.toISOString().split("T")[0]})}catch(s){console.error(`‚ùå Errore inserimento contratto per ${r.nome} ${r.cognome}:`,s),a.push({success:!1,error:s instanceof Error?s.message:String(s),cliente:`${r.nome} ${r.cognome}`})}const i=a.filter(r=>r.success).length;return t.json({success:!0,message:`Inseriti ${i}/${e.length} contratti`,results:a})}catch(e){return console.error("‚ùå Errore bulk insert contratti manuali:",e),t.json({success:!1,error:"Errore durante l'inserimento dei contratti",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/contracts/update-dates",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const{contracts:e}=await t.req.json();if(!Array.isArray(e)||e.length===0)return t.json({success:!1,error:"Array contracts vuoto o non valido"},400);console.log(`üìÖ [UPDATE DATES] Aggiornamento date per ${e.length} contratti...`);const a=[];for(const r of e)try{let s=null;if(r.richiedente_nome&&r.richiedente_cognome&&(s=await t.env.DB.prepare(`
            SELECT * FROM leads 
            WHERE UPPER(nomeRichiedente) = UPPER(?) 
              AND UPPER(cognomeRichiedente) = UPPER(?)
            LIMIT 1
          `).bind(r.richiedente_nome,r.richiedente_cognome).first(),s&&console.log(`‚úÖ Lead trovato tramite richiedente: ${r.richiedente_nome} ${r.richiedente_cognome} per assistito ${r.nome} ${r.cognome}`)),s||(s=await t.env.DB.prepare(`
            SELECT * FROM leads 
            WHERE (UPPER(nomeRichiedente) = UPPER(?) AND UPPER(cognomeRichiedente) = UPPER(?))
               OR (UPPER(nomeAssistito) = UPPER(?) AND UPPER(cognomeAssistito) = UPPER(?))
            LIMIT 1
          `).bind(r.nome,r.cognome,r.nome,r.cognome).first()),!s)throw new Error(`‚ùå Lead NON TROVATO per ${r.nome} ${r.cognome}`);console.log(`üìã Lead trovato: ${s.id} - ${s.nomeRichiedente} ${s.cognomeRichiedente}`);const l=await t.env.DB.prepare(`
          SELECT * FROM contracts 
          WHERE leadId = ?
          LIMIT 1
        `).bind(s.id).first();if(!l)throw new Error(`‚ùå Contratto NON TROVATO per lead ${s.id}`);console.log(`üìÑ Contratto trovato: ${l.codice_contratto}`),await t.env.DB.prepare(`
          UPDATE contracts 
          SET data_scadenza = ?,
              updated_at = datetime('now')
          WHERE id = ?
        `).bind(r.data_scadenza,l.id).run(),console.log(`‚úÖ Data scadenza aggiornata per contratto ${l.codice_contratto}: ${r.data_scadenza}`),console.log("   Nota: data_firma non salvata (campo non presente in DB, usa created_at)"),a.push({success:!0,leadId:s.id,contractId:l.id,contractCode:l.codice_contratto,cliente:`${r.nome} ${r.cognome}`,dataScadenza:r.data_scadenza,note:`Data scadenza aggiornata. Data firma: ${r.data_firma} (non salvata, usa created_at)`})}catch(s){console.error(`‚ùå Errore aggiornamento date per ${r.nome} ${r.cognome}:`,s),a.push({success:!1,error:s instanceof Error?s.message:String(s),cliente:`${r.nome} ${r.cognome}`})}const i=a.filter(r=>r.success).length;return t.json({success:!0,message:`Aggiornati ${i}/${e.length} contratti`,results:a})}catch(e){return console.error("‚ùå Errore bulk update date contratti:",e),t.json({success:!1,error:"Errore durante l'aggiornamento delle date",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/contracts/fix-manual-3",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üîß [FIX MANUAL 3] Aggiornamento 3 contratti esistenti (senza cancellazione)...");const e=[{nome:"Alberto",cognome:"Locatelli",codiceContratto:"CTR-LOCATELLI-2026",dataFirma:"2026-02-03",dataScadenza:"2027-02-02",prezzoTotale:585.6,prezzoMensile:48.8,pdfUrl:"/contratti/03.02.2026_signor Locatelli_BASE_SIDLY VITAL CARE.pdf"},{nome:"Francesco",cognome:"Pepe",codiceContratto:"CTR-PEPE-2026",dataFirma:"2026-01-27",dataScadenza:"2027-01-26",prezzoTotale:585.6,prezzoMensile:48.8,pdfUrl:"/contratti/27.01.2026_Pepe Francesco Contratto.pdf"},{nome:"Claudio",cognome:"Macchi",codiceContratto:"CTR-MACCHI-2026",dataFirma:"2026-02-01",dataScadenza:"2027-01-31",prezzoTotale:585.6,prezzoMensile:48.8,pdfUrl:"/contratti/Documento x Claudio Macchi.pdf"}],a=[];for(const r of e)try{const s=await t.env.DB.prepare(`
          SELECT * FROM leads 
          WHERE UPPER(cognomeRichiedente) = UPPER(?) 
            AND UPPER(nomeRichiedente) = UPPER(?)
          LIMIT 1
        `).bind(r.cognome,r.nome).first();if(!s)throw new Error(`‚ùå Lead NON TROVATO per ${r.nome} ${r.cognome}`);const l=await t.env.DB.prepare(`
          SELECT id, codice_contratto, status, data_scadenza, pdf_url FROM contracts 
          WHERE leadId = ?
          ORDER BY created_at DESC
          LIMIT 1
        `).bind(s.id).first();if(!l)throw new Error(`‚ùå Nessun contratto trovato per ${r.nome} ${r.cognome}`);if(l.codice_contratto===r.codiceContratto){console.log(`‚úÖ Contratto gi√† corretto per ${r.nome} ${r.cognome}: ${r.codiceContratto}`),await t.env.DB.prepare(`
            UPDATE contracts
            SET 
              data_scadenza = ?,
              pdf_url = ?,
              prezzo_totale = ?,
              prezzo_mensile = ?,
              updated_at = datetime('now')
            WHERE id = ?
          `).bind(r.dataScadenza,r.pdfUrl,r.prezzoTotale,r.prezzoMensile,l.id).run(),a.push({success:!0,action:"UPDATE_MINOR",contractId:l.id,contractCode:r.codiceContratto,cliente:`${r.nome} ${r.cognome}`,dataScadenza:r.dataScadenza,pdfUrl:r.pdfUrl,note:"Codice gi√† corretto, aggiornati solo PDF/date"});continue}const d=await t.env.DB.prepare(`
          SELECT id, codice_contratto FROM contracts 
          WHERE codice_contratto = ? AND leadId != ?
          LIMIT 1
        `).bind(r.codiceContratto,s.id).first();if(d)throw new Error(`‚ùå DUPLICATO RILEVATO: Codice ${r.codiceContratto} gi√† usato da contratto ${d.id} (lead diverso!)`);console.log(`‚úèÔ∏è Aggiorno contratto: ${l.codice_contratto} ‚Üí ${r.codiceContratto}`),await t.env.DB.prepare(`
          UPDATE contracts
          SET 
            codice_contratto = ?,
            data_scadenza = ?,
            prezzo_totale = ?,
            prezzo_mensile = ?,
            pdf_url = ?,
            updated_at = datetime('now')
          WHERE id = ?
        `).bind(r.codiceContratto,r.dataScadenza,r.prezzoTotale,r.prezzoMensile,r.pdfUrl,l.id).run(),a.push({success:!0,action:"UPDATE",contractId:l.id,contractCode:r.codiceContratto,oldCode:l.codice_contratto,cliente:`${r.nome} ${r.cognome}`,dataScadenza:r.dataScadenza,pdfUrl:r.pdfUrl,note:`Aggiornato da ${l.codice_contratto} a ${r.codiceContratto}`})}catch(s){console.error(`‚ùå Errore per ${r.nome} ${r.cognome}:`,s),a.push({success:!1,error:s instanceof Error?s.message:String(s),cliente:`${r.nome} ${r.cognome}`})}const i=a.filter(r=>r.success).length;return t.json({success:i===3,message:`‚úÖ Aggiornati ${i}/3 contratti (senza perdita dati)`,results:a})}catch(e){return console.error("‚ùå Errore fix manual 3 contratti:",e),t.json({success:!1,error:"Errore durante l'aggiornamento dei contratti",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/leads",async t=>{var o;try{const e=await t.req.json();if(console.log("üîç [DEBUG POST /api/leads] Payload ricevuto:",JSON.stringify(e,null,2)),console.log("üîç [DEBUG] luogoNascitaAssistito:",e.luogoNascitaAssistito,"type:",typeof e.luogoNascitaAssistito),console.log("üîç [DEBUG] dataNascitaAssistito:",e.dataNascitaAssistito,"type:",typeof e.dataNascitaAssistito),!((o=t.env)!=null&&o.DB))return t.json({success:!0,message:"Lead creato (mock)",id:"LEAD-MOCK-"+Date.now()});if(!e.nomeRichiedente||!e.cognomeRichiedente||!e.email)return t.json({success:!1,error:"Campi obbligatori mancanti: nomeRichiedente, cognomeRichiedente, email"},400);const a=`LEAD-MANUAL-${Date.now()}`,i=new Date().toISOString();await t.env.DB.prepare(`
      INSERT INTO leads (
        id, nomeRichiedente, cognomeRichiedente, 
        email, telefono,
        email, telefono,
        nomeAssistito, cognomeAssistito, 
        luogoNascitaAssistito, dataNascitaAssistito,
        indirizzoAssistito, capAssistito, cittaAssistito, provinciaAssistito,
        cfAssistito, condizioniSalute,
        tipoServizio, servizio, piano,
        vuoleBrochure, vuoleContratto, vuoleManuale,
        gdprConsent,
        intestazioneContratto,
        note, fonte, status, timestamp, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(a,e.nomeRichiedente,e.cognomeRichiedente,e.email,e.telefono||"",e.email,e.telefono||"",e.nomeAssistito||e.nomeRichiedente,e.cognomeAssistito||e.cognomeRichiedente,e.luogoNascitaAssistito??null,e.dataNascitaAssistito??null,e.indirizzoAssistito??null,e.capAssistito??null,e.cittaAssistito??null,e.provinciaAssistito??null,e.cfAssistito??e.cfAssistito??null,e.condizioniSalute||null,e.tipoServizio||e.servizio||"eCura PRO",e.servizio||"eCura PRO",e.piano||"BASE",e.vuoleBrochure||"No",e.vuoleContratto||"No",e.vuoleManuale||"No",e.gdprConsent?1:0,e.intestatarioContratto||"richiedente",e.note||"",e.fonte||e.canale||"MANUAL_ENTRY","NEW",i,i).run(),console.log("‚úÖ Lead creato:",a);const r={notifica:{sent:!1,error:null},brochure:{sent:!1,error:null},contratto:{sent:!1,error:null}};try{const s={vuoleBrochure:e.vuoleBrochure,vuoleContratto:e.vuoleContratto,vuoleManuale:e.vuoleManuale};it(`üîç [LEAD] Dati ricevuti: ${JSON.stringify(s)}`),console.log("üîç [DEBUG] Dati ricevuti:",s);const l={id:a,nomeRichiedente:e.nomeRichiedente,cognomeRichiedente:e.cognomeRichiedente,email:e.email,telefono:e.telefono||"",nomeAssistito:e.nomeAssistito||"",cognomeAssistito:e.cognomeAssistito||"",luogoNascitaAssistito:e.luogoNascitaAssistito||"",dataNascitaAssistito:e.dataNascitaAssistito||"",indirizzoAssistito:e.indirizzoAssistito||"",capAssistito:e.capAssistito||"",cittaAssistito:e.cittaAssistito||"",provinciaAssistito:e.provinciaAssistito||"",cfAssistito:e.cfAssistito||"",condizioniSalute:e.condizioniSalute||"",pacchetto:e.piano||"BASE",servizio:e.servizio||"eCura PRO",intestatarioContratto:e.intestatarioContratto||"richiedente",vuoleBrochure:e.vuoleBrochure==="Si",vuoleManuale:e.vuoleManuale==="Si",vuoleContratto:e.vuoleContratto==="Si",cfIntestatario:e.cfIntestatario||"",indirizzoIntestatario:e.indirizzoIntestatario||"",note:e.note||""},d={vuoleBrochure:l.vuoleBrochure,vuoleContratto:l.vuoleContratto,vuoleManuale:l.vuoleManuale};it(`üîç [LEAD] leadData mappato: ${JSON.stringify(d)}`),console.log("üîç [DEBUG] leadData mappato:",d);const{inviaEmailNotificaInfo:c,inviaEmailDocumentiInformativi:u,inviaEmailContratto:p}=await Promise.resolve().then(()=>Pc);try{const g=await c(l,t.env,t.env.DB);r.notifica.sent=g.success,g.success||(r.notifica.error=g.errors.join(", ")),console.log("üìß [WORKFLOW] Notifica interno:",g.success?"‚úÖ":"‚ùå")}catch(g){console.error("‚ùå Errore notifica:",g),r.notifica.error=g instanceof Error?g.message:String(g)}if(!l.vuoleContratto&&(l.vuoleBrochure||l.vuoleManuale||!l.vuoleBrochure&&!l.vuoleContratto))try{it("üìö [LEAD] Invio documenti informativi (no contratto)");const g={};if(!l.vuoleBrochure&&!l.vuoleContratto&&(it("üìö [LEAD] Default: invia brochure anche se non richiesta"),l.vuoleBrochure=!0),l.vuoleBrochure){const m=l.servizio||"eCura PRO";m.includes("PRO")||m.includes("FAMILY")?g.brochure="/brochures/Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf":m.includes("PREMIUM")&&(g.brochure="/brochures/Medica-GB-SiDLY_Vital_Care_ITA-compresso.pdf")}l.vuoleManuale&&(g.manuale="/documents/Manuale_SiDLY.pdf"),r.brochure.sent=!1,it("‚ÑπÔ∏è [LEAD] Email brochure separata disabilitata (inclusa in email completamento)"),console.log("üìö [WORKFLOW] Email brochure separata: ‚è≠Ô∏è SKIPPED (inclusa in completamento dati)")}catch(g){console.error("‚ùå Errore documenti:",g);const m=g instanceof Error?g.message:String(g);r.brochure.error=m,it(`‚ùå [LEAD] Exception documenti: ${m}`)}else l.vuoleContratto&&it("üìã [LEAD] vuoleContratto=true ‚Üí Skip documenti informativi (inclusi in email contratto)");if(l.vuoleContratto){it("üìã [LEAD] Contratto richiesto: SI - Procedura attiva");try{const g={contractId:`contract-${Date.now()}`,contractCode:`CONTRACT_CTR-MOCK-${new Date().getFullYear()}_${Date.now()}`,contractPdfUrl:"",tipoServizio:l.pacchetto||"BASE",servizio:l.servizio||"eCura PRO",prezzoBase:pricing.setupBase,prezzoIvaInclusa:pricing.setupTotale};it(`üìã [LEAD] contractData creato: ${g.contractId}`);const m={},b=l.servizio||"eCura PRO";b.includes("PRO")||b.includes("FAMILY")?m.brochure="/brochures/Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf":b.includes("PREMIUM")&&(m.brochure="/brochures/Medica-GB-SiDLY_Vital_Care_ITA-compresso.pdf"),it("üìã [LEAD] Chiamata inviaEmailContratto...");const h=await p(l,g,t.env,m,t.env.DB);r.contratto.sent=h.success,h.success?it("‚úÖ [LEAD] Contratto inviato con successo"):(r.contratto.error=h.errors.join(", "),it(`‚ùå [LEAD] Errore invio contratto: ${r.contratto.error}`)),console.log("üìã [WORKFLOW] Contratto:",h.success?"‚úÖ":"‚ùå")}catch(g){console.error("‚ùå Errore contratto:",g);const m=g instanceof Error?g.message:String(g);r.contratto.error=m,it(`‚ùå [LEAD] Exception contratto: ${m}`)}}else it("‚ö†Ô∏è  [LEAD] Contratto NON richiesto - Skip")}catch(s){console.error("‚ùå Errore generale automazione email:",s)}return t.json({success:!0,message:"Lead creato con successo",id:a,leadId:a,lead:{id:a,nomeRichiedente:e.nomeRichiedente,cognomeRichiedente:e.cognomeRichiedente,email:e.email},emails:r,emailAutomation:r})}catch(e){return console.error("‚ùå Errore creazione lead:",e),t.json({success:!1,error:"Errore creazione lead",details:e instanceof Error?e.message:String(e)},500)}});I.delete("/api/leads/:id",async t=>{var e;const o=t.req.param("id");try{if(!((e=t.env)!=null&&e.DB))return t.json({success:!0,message:"Lead eliminato (mock)"});if(!await t.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(o).first())return t.json({success:!1,error:"Lead non trovato"},404);try{const i=await t.env.DB.prepare("SELECT COUNT(*) as count FROM contracts WHERE lead_id = ?").bind(o).first();if(i&&i.count>0)return t.json({success:!1,error:"Impossibile eliminare: lead ha contratti associati",hasContracts:!0},400)}catch(i){console.warn("‚ö†Ô∏è Tabella contratti non trovata, skip controllo:",i)}try{await t.env.DB.prepare("DELETE FROM configurations WHERE leadId = ?").bind(o).run(),console.log("‚úÖ Configurations associate eliminate")}catch(i){console.log("‚ÑπÔ∏è Nessuna configuration o tabella non esiste:",i)}try{await t.env.DB.prepare("DELETE FROM assistiti WHERE lead_id = ?").bind(o).run(),console.log("‚úÖ Assistiti associati eliminati")}catch(i){console.log("‚ÑπÔ∏è Nessun assistito o tabella non esiste:",i)}return await t.env.DB.prepare("DELETE FROM leads WHERE id = ?").bind(o).run(),console.log("‚úÖ Lead eliminato:",o),t.json({success:!0,message:"Lead eliminato con successo",id:o})}catch(a){return console.error("‚ùå Errore eliminazione lead:",a),t.json({success:!1,error:"Errore eliminazione lead",details:a instanceof Error?a.message:String(a)},500)}});I.post("/api/leads/cleanup-wrong-imports",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=t.req.query("minLeadId")||"LEAD-IRBEMA-00146",a=parseInt(t.req.query("hoursAgo")||"24");console.log(`üßπ Cleanup lead sbagliati: minLeadId >= ${e}, creati > ${a}h fa`);const i=new Date;i.setHours(i.getHours()-a);const r=i.toISOString();console.log(`‚è∞ Cancello lead creati PRIMA del: ${r}`);const s=await t.env.DB.prepare(`
      SELECT id, email, nomeRichiedente, cognomeRichiedente, created_at
      FROM leads 
      WHERE id >= ? 
        AND (fonte = 'IRBEMA' OR fonte = 'Form eCura')
        AND created_at < ?
      ORDER BY id
    `).bind(e,r).all();if(!s.results||s.results.length===0)return t.json({success:!0,message:"Nessun lead da cancellare",deleted:0,cutoffDate:r});console.log(`üóëÔ∏è Trovati ${s.results.length} lead da cancellare`);const l=[],d=[];for(const c of s.results)try{try{const u=await t.env.DB.prepare("SELECT COUNT(*) as count FROM contracts WHERE lead_id = ?").bind(c.id).first();if(u&&u.count>0){console.warn(`‚ö†Ô∏è Skip ${c.id}: ha ${u.count} contratti associati`),d.push({id:c.id,email:c.email||c.email,error:"Ha contratti associati"});continue}}catch{console.log(`‚ÑπÔ∏è Tabella contratti non trovata per ${c.id}, procedo con cancellazione`)}await t.env.DB.prepare("DELETE FROM leads WHERE id = ?").bind(c.id).run(),l.push(c.id),console.log(`‚úÖ Cancellato: ${c.id} - ${c.email||c.email}`)}catch(u){console.error(`‚ùå Errore cancellazione ${c.id}:`,u),d.push({id:c.id,email:c.email||c.email,error:u instanceof Error?u.message:String(u)})}return console.log(`üéâ Cleanup completato: ${l.length} cancellati, ${d.length} errori`),t.json({success:!0,message:`Cleanup completato: ${l.length} lead cancellati`,deleted:l.length,deletedIds:l,errors:d,cutoffDate:r,criteria:{minLeadId:e,hoursAgo:a,cutoffTimestamp:r}})}catch(e){return console.error("‚ùå Errore cleanup lead:",e),t.json({success:!1,error:"Errore cleanup lead",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/leads/fix-prices",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üîß Avvio correzione prezzi per tutti i lead...");const{calculatePrice:e}=await Promise.resolve().then(()=>sr),a=await t.env.DB.prepare(`
      SELECT 
        id, servizio, piano, tipoServizio,
        prezzo_anno, prezzo_rinnovo
      FROM leads
      ORDER BY created_at DESC
    `).all();if(!a.results||a.results.length===0)return t.json({success:!0,message:"Nessun lead da correggere",total:0,corrected:0,skipped:0,errors:[]});console.log(`üìä Trovati ${a.results.length} lead totali`);let i=0,r=0;const s=[];for(const d of a.results)try{let c="PRO",u="BASE";if(d.servizio){const g=d.servizio.match(/eCura\s+(FAMILY|PRO|PREMIUM)/i);g&&(c=g[1].toUpperCase())}else if(d.tipoServizio){const g=d.tipoServizio.match(/eCura\s+(FAMILY|PRO|PREMIUM)/i);g&&(c=g[1].toUpperCase())}d.piano&&(u=d.piano.toUpperCase());const p=e(c,u);if(d.prezzo_anno===p.setupBase&&d.prezzo_rinnovo===p.rinnovoBase){r++;continue}await t.env.DB.prepare(`
          UPDATE leads
          SET 
            prezzo_anno = ?,
            prezzo_rinnovo = ?
          WHERE id = ?
        `).bind(p.setupBase,p.rinnovoBase,d.id).run(),i++,console.log(`‚úÖ Lead ${d.id} corretto: ${c} ${u} ‚Üí ${p.setupBase}‚Ç¨`)}catch(c){s.push({leadId:d.id,error:c instanceof Error?c.message:String(c)}),console.error(`‚ùå Errore lead ${d.id}:`,c)}const l={success:!0,message:`Correzione prezzi completata: ${i} corretti, ${r} gi√† corretti, ${s.length} errori`,total:a.results.length,corrected:i,skipped:r,errors:s.length>0?s:void 0};return console.log("üéâ Correzione prezzi completata:",l),t.json(l)}catch(e){return console.error("‚ùå Errore correzione prezzi:",e),t.json({success:!1,error:"Errore correzione prezzi",details:e instanceof Error?e.message:String(e)},500)}});I.get("/api/settings",Bg);I.get("/api/settings/:key",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=t.req.param("key"),{getSetting:a}=await Promise.resolve().then(()=>Fg),i=await a(t.env.DB,e);return i==null?t.json({success:!1,error:`Setting '${e}' non trovato`,setting:null},404):t.json({success:!0,setting:{key:e,value:i==="true"||i===!0?"true":"false",enabled:i==="true"||i===!0}})}catch(e){return console.error(`‚ùå Errore lettura setting ${t.req.param("key")}:`,e),t.json({success:!1,error:e.message},500)}});I.put("/api/settings/:key",kg);I.post("/api/db/migrate",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üîß Esecuzione migrazioni database...");try{await t.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS assistiti (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          codice TEXT UNIQUE NOT NULL,
          nome TEXT NOT NULL,
          email TEXT,
          telefono TEXT,
          imei TEXT UNIQUE,
          status TEXT DEFAULT 'ATTIVO',
          lead_id TEXT,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
      `).run(),console.log("‚úÖ Tabella assistiti creata")}catch{console.log("‚ÑπÔ∏è Tabella assistiti gi√† esistente")}const e=[{name:"nome_assistito",type:"TEXT"},{name:"cognome_assistito",type:"TEXT"},{name:"nome_caregiver",type:"TEXT"},{name:"cognome_caregiver",type:"TEXT"},{name:"parentela_caregiver",type:"TEXT"}];for(const r of e)try{await t.env.DB.prepare(`
          ALTER TABLE assistiti ADD COLUMN ${r.name} ${r.type}
        `).run(),console.log(`‚úÖ Colonna ${r.name} aggiunta a assistiti`)}catch{console.log(`‚ÑπÔ∏è Colonna ${r.name} gi√† esistente in assistiti`)}try{await t.env.DB.prepare(`
        UPDATE assistiti 
        SET nome_assistito = CASE 
          WHEN nome_assistito IS NULL AND nome LIKE '% %' 
          THEN substr(nome, 1, instr(nome, ' ') - 1)
          WHEN nome_assistito IS NULL 
          THEN nome
          ELSE nome_assistito
        END,
        cognome_assistito = CASE 
          WHEN cognome_assistito IS NULL AND nome LIKE '% %' 
          THEN substr(nome, instr(nome, ' ') + 1)
          ELSE cognome_assistito
        END
        WHERE nome_assistito IS NULL OR cognome_assistito IS NULL
      `).run(),console.log("‚úÖ Dati migrati da nome a nome_assistito/cognome_assistito")}catch{console.log("‚ÑπÔ∏è Migrazione dati assistiti gi√† effettuata")}try{await t.env.DB.prepare(`
        ALTER TABLE contracts ADD COLUMN imei_dispositivo TEXT
      `).run(),console.log("‚úÖ Colonna imei_dispositivo aggiunta a contracts")}catch{console.log("‚ÑπÔ∏è Colonna imei_dispositivo gi√† esistente")}const a=[{name:"codice_contratto",type:"TEXT"},{name:"tipo_contratto",type:"TEXT"},{name:"status",type:'TEXT DEFAULT "DRAFT"'},{name:"prezzo_totale",type:"INTEGER"},{name:"created_at",type:"DATETIME DEFAULT CURRENT_TIMESTAMP"}];for(const r of a)try{await t.env.DB.prepare(`
          ALTER TABLE contracts ADD COLUMN ${r.name} ${r.type}
        `).run(),console.log(`‚úÖ Colonna ${r.name} aggiunta a contracts`)}catch{console.log(`‚ÑπÔ∏è Colonna ${r.name} gi√† esistente`)}try{await t.env.DB.prepare(`
        ALTER TABLE contracts ADD COLUMN piano TEXT
      `).run(),console.log("‚úÖ Colonna piano aggiunta a contracts")}catch{console.log("‚ÑπÔ∏è Colonna piano gi√† esistente in contracts")}try{await t.env.DB.prepare(`
        UPDATE contracts 
        SET piano = CASE 
          WHEN prezzo_totale >= 800 THEN 'AVANZATO'
          ELSE 'BASE'
        END
        WHERE piano IS NULL AND prezzo_totale IS NOT NULL
      `).run(),console.log("‚úÖ Campo piano aggiornato nei contratti")}catch(r){console.log("‚ö†Ô∏è Errore aggiornamento piano contratti:",r)}const i=["Tabella assistiti creata","Colonna imei_dispositivo aggiunta a contracts","Colonne aggiuntive verificate in contracts","Colonna piano aggiunta e aggiornata in contracts"];try{if(await t.env.DB.prepare(`
        SELECT name FROM sqlite_master WHERE type='table' AND name='devices'
      `).first()){console.log("‚ö†Ô∏è Tabella devices obsoleta trovata, rimozione in corso..."),await t.env.DB.prepare("DROP TABLE IF EXISTS devices").run(),console.log("‚úÖ Tabella devices obsoleta rimossa"),i.push("Tabella devices obsoleta rimossa");try{await t.env.DB.prepare("DROP INDEX IF EXISTS idx_devices_imei").run(),await t.env.DB.prepare("DROP INDEX IF EXISTS idx_devices_leadId").run(),await t.env.DB.prepare("DROP INDEX IF EXISTS idx_devices_status").run(),console.log("‚úÖ Indici devices obsoleti rimossi"),i.push("Indici devices obsoleti rimossi")}catch{console.log("‚ÑπÔ∏è Indici devices gi√† rimossi")}try{await t.env.DB.prepare("DROP TRIGGER IF EXISTS devices_updated_at").run(),console.log("‚úÖ Trigger devices_updated_at obsoleto rimosso"),i.push("Trigger devices_updated_at rimosso")}catch{console.log("‚ÑπÔ∏è Trigger devices_updated_at gi√† rimosso")}}else console.log("‚úÖ Tabella devices non esiste (gi√† migrata a dispositivi)"),i.push("Tabella devices non trovata (gi√† dispositivi)")}catch(r){console.error("‚ùå Errore rimozione devices:",r),i.push(`Errore rimozione devices: ${r}`)}try{console.log("üîß Verifica tabella configurations..."),await t.env.DB.prepare(`
        SELECT name FROM sqlite_master WHERE type='table' AND name='configurations'
      `).first()?(console.log("‚ö†Ô∏è Ricreazione configurations senza FK a devices..."),await t.env.DB.prepare(`
          CREATE TABLE IF NOT EXISTS configurations_backup AS SELECT * FROM configurations
        `).run(),console.log("‚úÖ Backup configurations creato"),await t.env.DB.prepare("DROP TABLE IF EXISTS configurations").run(),console.log("‚úÖ Vecchia configurations droppata"),await t.env.DB.prepare(`
          CREATE TABLE configurations (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            leadId TEXT NOT NULL,
            device_id INTEGER,
            contract_id TEXT,
            contatto_emergenza_1_nome TEXT,
            contatto_emergenza_1_telefono TEXT,
            contatto_emergenza_1_relazione TEXT,
            contatto_emergenza_2_nome TEXT,
            contatto_emergenza_2_telefono TEXT,
            contatto_emergenza_2_relazione TEXT,
            medico_curante_nome TEXT,
            medico_curante_telefono TEXT,
            centro_medico_riferimento TEXT,
            allergie TEXT,
            patologie_croniche TEXT,
            farmaci_assunti TEXT,
            modalita_utilizzo TEXT,
            orari_attivazione TEXT,
            status TEXT DEFAULT 'PENDING',
            data_completamento DATETIME,
            form_inviato BOOLEAN DEFAULT FALSE,
            email_benvenuto_inviata BOOLEAN DEFAULT FALSE,
            email_conferma_inviata BOOLEAN DEFAULT FALSE,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (leadId) REFERENCES leads(id) ON DELETE CASCADE,
            FOREIGN KEY (contract_id) REFERENCES contracts(id) ON DELETE CASCADE
          )
        `).run(),console.log("‚úÖ Nuova configurations creata (senza FK devices)"),await t.env.DB.prepare(`
          INSERT INTO configurations SELECT * FROM configurations_backup
        `).run(),console.log("‚úÖ Dati configurations ripristinati"),await t.env.DB.prepare("DROP TABLE configurations_backup").run(),console.log("‚úÖ Backup configurations rimosso"),i.push("Tabella configurations ricreata senza FK a devices")):(console.log("‚ÑπÔ∏è Tabella configurations non trovata"),i.push("Tabella configurations non trovata"))}catch(r){console.error("‚ùå Errore fix configurations:",r),i.push(`Errore fix configurations: ${r}`)}return t.json({success:!0,message:"Migrazioni completate",migrations:i})}catch(e){return console.error("‚ùå Errore migrazioni:",e),t.json({success:!1,error:"Errore esecuzione migrazioni",details:e instanceof Error?e.message:String(e)},500)}});I.get("/api/hubspot/test",async t=>{var o,e;try{const{HubSpotClient:a}=await Promise.resolve().then(()=>ka),i=(o=t.env)==null?void 0:o.HUBSPOT_ACCESS_TOKEN,r=(e=t.env)==null?void 0:e.HUBSPOT_PORTAL_ID;if(!i||!r)return t.json({success:!1,error:"Credenziali HubSpot non configurate",missing:{accessToken:!i,portalId:!r}},500);const l=await new a(i,r).testConnection();return t.json(l)}catch(a){return console.error("‚ùå Test HubSpot error:",a),t.json({success:!1,message:`Errore test HubSpot: ${a.message}`},500)}});I.get("/api/hubspot/contacts",async t=>{var o,e;try{const{HubSpotClient:a}=await Promise.resolve().then(()=>ka),i=(o=t.env)==null?void 0:o.HUBSPOT_ACCESS_TOKEN,r=(e=t.env)==null?void 0:e.HUBSPOT_PORTAL_ID;if(!i||!r)return t.json({success:!1,error:"Credenziali HubSpot non configurate"},500);const s=new a(i,r),l=parseInt(t.req.query("limit")||"100"),d=t.req.query("after");console.log(`üìä [HUBSPOT] Fetching contacts (limit: ${l})`);const c=await s.getContacts({limit:l,after:d});return console.log(`‚úÖ [HUBSPOT] Trovati ${c.results.length} contatti (totale: ${c.total})`),t.json({success:!0,total:c.total,count:c.results.length,contacts:c.results,paging:c.paging})}catch(a){return console.error("‚ùå Get HubSpot contacts error:",a),t.json({success:!1,error:a.message},500)}});I.post("/api/hubspot/search",async t=>{var o,e;try{const{HubSpotClient:a}=await Promise.resolve().then(()=>ka),i=(o=t.env)==null?void 0:o.HUBSPOT_ACCESS_TOKEN,r=(e=t.env)==null?void 0:e.HUBSPOT_PORTAL_ID;if(!i||!r)return t.json({success:!1,error:"Credenziali HubSpot non configurate"},500);const s=await t.req.json(),l=new a(i,r);console.log("üîç [HUBSPOT] Ricerca contatti con filtri:",s);const d=await l.searchContacts(s);return console.log(`‚úÖ [HUBSPOT] Trovati ${d.results.length} contatti`),t.json({success:!0,total:d.total,count:d.results.length,contacts:d.results,paging:d.paging})}catch(a){return console.error("‚ùå Search HubSpot contacts error:",a),t.json({success:!1,error:a.message},500)}});I.get("/api/hubspot/contacts/recent",async t=>{var o,e;try{const{HubSpotClient:a}=await Promise.resolve().then(()=>ka),i=(o=t.env)==null?void 0:o.HUBSPOT_ACCESS_TOKEN,r=(e=t.env)==null?void 0:e.HUBSPOT_PORTAL_ID;if(!i||!r)return t.json({success:!1,error:"Credenziali HubSpot non configurate"},500);const s=parseInt(t.req.query("days")||"7"),l=parseInt(t.req.query("limit")||"100"),d=new Date;d.setDate(d.getDate()-s);const c=new a(i,r);console.log(`üìÖ [HUBSPOT] Fetching contacts created after ${d.toISOString()}`);const u=await c.searchContacts({createdAfter:d.toISOString(),limit:l});return console.log(`‚úÖ [HUBSPOT] Trovati ${u.results.length} contatti recenti`),t.json({success:!0,period:`Ultimi ${s} giorni`,from:d.toISOString(),total:u.total,count:u.results.length,contacts:u.results})}catch(a){return console.error("‚ùå Get recent HubSpot contacts error:",a),t.json({success:!1,error:a.message},500)}});I.post("/api/hubspot/sync",async t=>{var o,e,a,i,r;try{const{HubSpotClient:s,mapHubSpotContactToLead:l}=await Promise.resolve().then(()=>ka);if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const d=(e=t.env)==null?void 0:e.HUBSPOT_ACCESS_TOKEN,c=(a=t.env)==null?void 0:a.HUBSPOT_PORTAL_ID;if(!d||!c)return t.json({success:!1,error:"Credenziali HubSpot non configurate"},500);const u=await t.req.json(),p=u.days||7,g=u.dryRun||!1,m=u.onlyEcura!==!1,b=u.useFixedDate!==!1,h=new s(d,c);let E;b?(E=new Date("2026-01-30T00:00:00.000Z"),console.log(`üîÑ [HUBSPOT SYNC] Inizio sincronizzazione dal 30/01/2026 (campagna eCura) - dryRun: ${g}, onlyEcura: ${m}`)):(E=new Date,E.setDate(E.getDate()-p),console.log(`üîÑ [HUBSPOT SYNC] Inizio sincronizzazione ultimi ${p} giorni (dryRun: ${g}, onlyEcura: ${m})`));const w={createdAfter:E.toISOString(),limit:100};m&&(w.hs_object_source_detail_1="Form eCura",console.log("üîç [HUBSPOT SYNC] Filtro attivo: solo lead da Form eCura"));const S=await h.searchContacts(w);console.log(`üìä [HUBSPOT SYNC] Trovati ${S.results.length} contatti da sincronizzare`);const C={total:S.results.length,created:0,skipped:0,errors:[]};for(const R of S.results)try{if(await t.env.DB.prepare(`
          SELECT id FROM leads 
          WHERE email = ? OR external_source_id = ?
          LIMIT 1
        `).bind(R.properties.email,R.id).first()){console.log(`‚è≠Ô∏è  [HUBSPOT SYNC] Contact ${R.id} gi√† esistente, skip`),C.skipped++;continue}if(g){console.log(`üîç [DRY RUN] Contatto ${R.id} sarebbe stato importato`),C.created++;continue}const D=l(R),F=await t.env.DB.prepare(`
          SELECT id FROM leads 
          WHERE id LIKE 'LEAD-IRBEMA-%' 
          ORDER BY id DESC 
          LIMIT 1
        `).first();let L=146;if(F!=null&&F.id){const N=F.id.match(/LEAD-IRBEMA-(\d+)/);N&&(L=parseInt(N[1])+1)}const M=`LEAD-IRBEMA-${L.toString().padStart(5,"0")}`;console.log(`üÜî [HUBSPOT SYNC] Generato ID: ${M}`);const j=D.email||`noemail-${R.id}@placeholder.local`;await t.env.DB.prepare(`
          INSERT INTO leads (
            id, nomeRichiedente, cognomeRichiedente, email, telefono,
            nomeAssistito, cognomeAssistito,
            servizio, piano, tipoServizio,
            prezzo_anno, prezzo_rinnovo,
            fonte, external_source_id, status, note,
            vuoleContratto, vuoleBrochure, vuoleManuale,
            gdprConsent, consensoMarketing, consensoTerze,
            created_at, updated_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(M,D.nomeRichiedente,D.cognomeRichiedente,j,D.telefono,D.nomeAssistito,D.cognomeAssistito,D.servizio,D.piano,D.tipoServizio||D.servizio||"eCura PRO",D.prezzo_anno||null,D.prezzo_rinnovo||null,D.fonte,D.external_source_id,D.status,D.note,D.vuoleContratto,D.vuoleBrochure,D.vuoleManuale,D.gdprConsent?1:0,D.consensoMarketing?1:0,D.consensoTerze?1:0,new Date().toISOString(),new Date().toISOString()).run(),console.log(`‚úÖ [HUBSPOT SYNC] Lead creato: ${M} from HubSpot ${R.id}`),console.log("üîî [HUBSPOT SYNC] >>> INIZIO BLOCCO EMAIL <<<"),C.created++;try{console.log(`üìß [HUBSPOT SYNC] Invio email notifica tramite sendNewLeadNotification per ${M}...`);const{sendNewLeadNotification:N}=await Promise.resolve().then(()=>jp);await N(M,{nomeRichiedente:D.nomeRichiedente||"N/A",cognomeRichiedente:D.cognomeRichiedente||"",email:j||void 0,telefono:D.telefono||void 0,citta:void 0,servizio:D.servizio,piano:D.piano,fonte:"Form eCura",note:D.note||"",created_at:new Date().toISOString()},t.env),console.log(`‚úÖ [HUBSPOT SYNC] Email notifica admin inviata con successo per ${M}`)}catch(N){console.error("‚ö†Ô∏è [HUBSPOT SYNC] Errore invio email notifica admin:",N),console.error("‚ö†Ô∏è [HUBSPOT SYNC] Error details:",{message:N.message,stack:N.stack,leadId:M})}try{const N=await t.env.DB.prepare("SELECT value FROM settings WHERE key = 'lead_email_notifications_enabled' LIMIT 1").first(),A=(N==null?void 0:N.value)==="true";if(console.log("üîç [HUBSPOT SYNC] Check email conditions:",{leadEmailEnabled:A,hasEmail:!!j,email:j,leadId:M}),A&&j){console.log("üö®üö®üö® [HUBSPOT SYNC] INIZIO INVIO EMAIL AL LEAD üö®üö®üö®"),console.log(`üìß [HUBSPOT SYNC] Email destinatario: ${j}`),console.log(`üìß Switch abilitato: ${A}`);try{const{createCompletionToken:x,getMissingFields:P,getSystemConfig:B}=await Promise.resolve().then(()=>at),J=(await Promise.resolve().then(()=>At)).default,{loadEmailTemplate:ae,renderTemplate:ie}=await Promise.resolve().then(()=>Pa),Z=await t.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(M).first();if(!Z)throw console.error(`‚ùå [HUBSPOT SYNC] Lead ${M} non trovato in DB dopo inserimento`),new Error("Lead not found after insert");const H=await B(t.env.DB),We=await x(t.env.DB,M,H.auto_completion_token_days);console.log(`‚úÖ [HUBSPOT SYNC] Token creato: ${We.token}`);const ut=`${((i=t.env)==null?void 0:i.PUBLIC_URL)||((r=t.env)==null?void 0:r.PAGES_URL)||"https://telemedcare-v12.pages.dev"}/api/form/${M}?leadId=${M}`,{missing:Je,available:Ft}=P(Z),pt=await ae("email_richiesta_completamento_form",t.env.DB,t.env),$o=Object.entries(Ft).map(([Q,lo])=>({FIELD_LABEL:Q,FIELD_VALUE:lo})),fe={telefono:{label:"Telefono",type:"tel",placeholder:"+39 3XX XXX XXXX",required:!0},cittaIntestatario:{label:"Citt√†",type:"text",placeholder:"Es. Milano",required:!0},citta:{label:"Citt√†",type:"text",placeholder:"Es. Milano",required:!0},nomeAssistito:{label:"Nome Assistito",type:"text",placeholder:"Nome",required:!0},cognomeAssistito:{label:"Cognome Assistito",type:"text",placeholder:"Cognome",required:!0},dataNascitaAssistito:{label:"Data Nascita Assistito",type:"date",placeholder:"",required:!0},cittaAssistito:{label:"Citt√† Assistito",type:"text",placeholder:"Es. Roma",required:!0}},no=Je.map(Q=>{var lo,W,k,Y;return{FIELD_NAME:Q,FIELD_LABEL:((lo=fe[Q])==null?void 0:lo.label)||Q,FIELD_TYPE:((W=fe[Q])==null?void 0:W.type)||"text",FIELD_PLACEHOLDER:((k=fe[Q])==null?void 0:k.placeholder)||"",FIELD_REQUIRED:(Y=fe[Q])!=null&&Y.required?"required":""}}),Ge=ie(pt.content||"",{NOME_RICHIEDENTE:Z.nomeRichiedente||"",COGNOME_RICHIEDENTE:Z.cognomeRichiedente||"",LEAD_ID:M,COMPLETION_URL:ut,AVAILABLE_FIELDS:$o,MISSING_FIELDS:no,DAYS_VALID:H.auto_completion_token_days.toString()});await J.send({to:j,from:t.env.EMAIL_FROM||"notifiche@telemedcare.it",subject:pt.subject||"Completa i tuoi dati - TeleMedCare",html:Ge},t.env),console.log(`‚úÖ [HUBSPOT SYNC] Email completamento inviata a: ${j}`)}catch(x){console.error("‚ùå [HUBSPOT SYNC] Errore invio email completamento:",x),console.error("‚ùå [HUBSPOT SYNC] Stack trace:",x.stack)}}else console.log("‚è≠Ô∏è [HUBSPOT SYNC] Email completamento NON inviata:",{reason:A?"Email mancante":"Switch disabilitato",leadEmailEnabled:A,hasEmail:!!j})}catch(N){console.error(`‚ö†Ô∏è [HUBSPOT SYNC] Errore email workflow per ${M}:`,N)}}catch(z){console.error(`‚ùå [HUBSPOT SYNC] Errore sync contact ${R.id}:`,z),C.errors.push({contactId:R.id,email:R.properties.email,error:z.message})}return console.log(`‚úÖ [HUBSPOT SYNC] Completato: ${C.created} creati, ${C.skipped} skipped, ${C.errors.length} errori`),t.json({success:!0,message:g?"Dry run completato (nessun dato salvato)":"Sincronizzazione completata",period:`Ultimi ${p} giorni`,dryRun:g,results:C})}catch(s){return console.error("‚ùå HubSpot sync error:",s),t.json({success:!1,error:s.message},500)}});I.post("/api/hubspot/auto-import",async t=>{var o,e;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const{executeAutoImport:a,logAutoImport:i}=await Promise.resolve().then(()=>sw),r=await t.req.json().catch(()=>({})),s={enabled:r.enabled!==!1,startHour:r.startHour||0,days:r.days||1,onlyEcura:r.onlyEcura!==!1,dryRun:r.dryRun||!1};console.log(`üîÑ [AUTO-IMPORT API] Richiesta import incrementale ultimi ${s.days} ${s.days===1?"giorno":"giorni"} (dryRun: ${s.dryRun})`);const l=((e=t.env)==null?void 0:e.PUBLIC_URL)||"https://telemedcare-v12.pages.dev",d=await a(t.env.DB,t.env,l,s);if(d.success&&d.imported>0&&!s.dryRun)try{console.log(`üí∞ [AUTO-IMPORT API] Eseguo fix automatico prezzi per ${d.imported} nuovi lead...`);const c=await fetch(`${l}/api/leads/fix-prices`,{method:"POST",headers:{"Content-Type":"application/json"}});if(c.ok){const u=await c.json();console.log(`‚úÖ [AUTO-IMPORT API] Fix prezzi completato: ${u.corrected} corretti`)}}catch(c){console.error("‚ö†Ô∏è [AUTO-IMPORT API] Errore fix prezzi:",c)}return d.success&&!s.dryRun&&await i(t.env.DB,d),t.json(d)}catch(a){return console.error("‚ùå Auto-import API error:",a),t.json({success:!1,error:a.message},500)}});I.get("/api/hubspot/auto-import/status",async t=>{try{return t.json({success:!0,hasRun:!0,message:"Status endpoint disabled (use console logs for monitoring)",note:"Auto-import runs on every dashboard load, check browser console for logs"})}catch(o){return console.error("‚ùå Auto-import status error:",o),t.json({success:!1,error:o.message},500)}});I.get("/api/hubspot/verify-leads",async t=>{var o,e,a,i;try{if(console.log("üîç [HUBSPOT VERIFY] Inizio verifica lead su HubSpot..."),!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const r=(e=t.env)==null?void 0:e.HUBSPOT_ACCESS_TOKEN,s=(a=t.env)==null?void 0:a.HUBSPOT_PORTAL_ID;if(!r||!s)return t.json({success:!1,error:"Credenziali HubSpot non configurate",hint:"Aggiungi HUBSPOT_ACCESS_TOKEN e HUBSPOT_PORTAL_ID nelle variabili di ambiente"},500);const d=(t.req.query("names")||"Rita,Giovanna,Tina").split(",").map(g=>g.trim());console.log(`üîç [HUBSPOT VERIFY] Cerca lead: ${d.join(", ")}`);const{HubSpotClient:c}=await Promise.resolve().then(()=>ka),u=new c(r,s),p=[];for(const g of d)try{console.log(`üîç [HUBSPOT VERIFY] Ricerca contatto: ${g}`);const m=await fetch("https://api.hubapi.com/crm/v3/objects/contacts/search",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({filterGroups:[{filters:[{propertyName:"firstname",operator:"CONTAINS_TOKEN",value:g}]}],properties:["firstname","lastname","email","servizio_ecura","piano_ecura","hs_object_source_detail_1","createdate"],limit:10})});if(!m.ok){console.error(`‚ùå [HUBSPOT VERIFY] Errore ricerca ${g}: HTTP ${m.status}`),p.push({searchName:g,found:!1,error:`HTTP ${m.status}`});continue}const b=await m.json();if(console.log(`üìä [HUBSPOT VERIFY] Trovati ${((i=b.results)==null?void 0:i.length)||0} contatti per "${g}"`),!b.results||b.results.length===0){p.push({searchName:g,found:!1,message:"Nessun contatto trovato su HubSpot"});continue}for(const h of b.results){const E=h.properties;let w=null,S=null;if(E.servizio_ecura&&E.piano_ecura)try{const{calculatePrice:R}=await Promise.resolve().then(()=>sr),z=R(E.servizio_ecura.toUpperCase(),E.piano_ecura.toUpperCase());w={servizio:z.servizio,piano:z.piano,setupBase:z.setupBase,rinnovoBase:z.rinnovoBase,setupTotale:z.setupTotale,rinnovoTotale:z.rinnovoTotale}}catch(R){S=R.message}const C=await t.env.DB.prepare(`
            SELECT id, nomeRichiedente, cognomeRichiedente, 
                   servizio, piano, prezzo_anno, prezzo_rinnovo,
                   external_source_id
            FROM leads
            WHERE email = ? OR external_source_id = ?
            LIMIT 1
          `).bind(E.email,h.id).first();p.push({searchName:g,found:!0,hubspot:{id:h.id,firstname:E.firstname,lastname:E.lastname,email:E.email,servizio_ecura:E.servizio_ecura||null,piano_ecura:E.piano_ecura||null,form_source:E.hs_object_source_detail_1||null,created:E.createdate},expectedPrice:w,pricingError:S,telemedcare:C?{id:C.id,nome:`${C.nomeRichiedente} ${C.cognomeRichiedente}`,servizio:C.servizio,piano:C.piano,prezzo_anno:C.prezzo_anno,prezzo_rinnovo:C.prezzo_rinnovo,needsFix:!C.prezzo_anno||C.prezzo_anno===0}:null})}}catch(m){console.error(`‚ùå [HUBSPOT VERIFY] Errore verifica ${g}:`,m),p.push({searchName:g,found:!1,error:m.message})}return console.log(`‚úÖ [HUBSPOT VERIFY] Verifica completata: ${p.length} risultati`),t.json({success:!0,results:p,summary:{total:p.length,found:p.filter(g=>g.found).length,notFound:p.filter(g=>!g.found).length,needsPriceFix:p.filter(g=>{var m;return(m=g.telemedcare)==null?void 0:m.needsFix}).length}})}catch(r){return console.error("‚ùå [HUBSPOT VERIFY] Errore generale:",r),t.json({success:!1,error:r.message},500)}});I.get("/api/system/config",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const{getSystemConfig:e}=await Promise.resolve().then(()=>at),a=await e(t.env.DB);return t.json({success:!0,config:a})}catch(e){return console.error("‚ùå Get system config error:",e),t.json({success:!1,error:e.message},500)}});I.post("/api/system/config",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=await t.req.json(),{updateSystemConfig:a}=await Promise.resolve().then(()=>at);for(const[s,l]of Object.entries(e))await a(t.env.DB,s,l);const{getSystemConfig:i}=await Promise.resolve().then(()=>at),r=await i(t.env.DB);return console.log("‚úÖ System config updated:",r),t.json({success:!0,config:r})}catch(e){return console.error("‚ùå Update system config error:",e),t.json({success:!1,error:e.message},500)}});I.post("/api/leads/:leadId/request-completion",async t=>{var o,e,a;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const i=t.req.param("leadId"),{createCompletionToken:r,getMissingFields:s,isLeadComplete:l,getSystemConfig:d}=await Promise.resolve().then(()=>at),c=await t.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(i).first();if(!c)return t.json({success:!1,error:"Lead non trovato"},404);if(l(c))return t.json({success:!1,error:"Lead gi√† completo, nessun campo mancante"},400);const u=await d(t.env.DB),p=await r(t.env.DB,i,u.auto_completion_token_days),g=((e=t.env)==null?void 0:e.PUBLIC_URL)||"https://telemedcare-v12.pages.dev",m=`${g}/api/form/${i}?leadId=${i}`,{missing:b,available:h}=s(c),E=t.req.query("sendEmail")==="true"||u.auto_completion_enabled;if(E){const{EmailService:w}=await Promise.resolve().then(()=>At),{loadEmailTemplate:S,renderTemplate:C}=await Promise.resolve().then(()=>Pa),R=new w(t.env),z=await S("email_richiesta_completamento_form",t.env.DB,t.env),D=Object.entries(h).map(([N,A])=>({FIELD_LABEL:N,FIELD_VALUE:A})),F={telefono:{label:"Telefono",type:"tel",placeholder:"+39 3XX XXX XXXX",required:!0},telefono:{label:"Telefono",type:"tel",placeholder:"+39 3XX XXX XXXX",required:!0},cittaIntestatario:{label:"Citt√†",type:"text",placeholder:"Es. Milano",required:!0},citta:{label:"Citt√†",type:"text",placeholder:"Es. Milano",required:!0},nomeAssistito:{label:"Nome Assistito",type:"text",placeholder:"Nome",required:!0},cognomeAssistito:{label:"Cognome Assistito",type:"text",placeholder:"Cognome",required:!0},dataNascitaAssistito:{label:"Data Nascita Assistito",type:"date",placeholder:"",required:!0},cittaAssistito:{label:"Citt√† Assistito",type:"text",placeholder:"Es. Roma",required:!0},cfAssistito:{label:"Codice Fiscale Assistito",type:"text",placeholder:"Es. RSSMRA85M01H501X",required:!1},indirizzoAssistito:{label:"Indirizzo Assistito",type:"text",placeholder:"Via, numero civico",required:!1},servizio:{label:"Servizio",type:"select",required:!0,options:[{value:"eCura FAMILY",label:"eCura FAMILY - Monitoraggio base"},{value:"eCura PRO",label:"eCura PRO - Assistenza completa"},{value:"eCura PREMIUM",label:"eCura PREMIUM - Assistenza avanzata"}]},piano:{label:"Piano",type:"select",required:!0,options:[{value:"BASE",label:"BASE - Mensile"},{value:"AVANZATO",label:"AVANZATO - Trimestrale (sconto 5%)"}]}},L=b.map(N=>{const A=F[N]||{label:N.charAt(0).toUpperCase()+N.slice(1),type:"text",placeholder:"",required:!1};return{FIELD_ID:N,FIELD_NAME:N,FIELD_LABEL:A.label,INPUT_TYPE:A.type,PLACEHOLDER:A.placeholder||"",IS_REQUIRED:A.required,IS_INPUT:A.type!=="select"&&A.type!=="textarea",IS_SELECT:A.type==="select",IS_TEXTAREA:A.type==="textarea",OPTIONS:A.options||[]}}),M={NOME_CLIENTE:c.nomeRichiedente,COGNOME_CLIENTE:c.cognomeRichiedente,SERVIZIO:c.servizio||c.tipoServizio||"eCura PRO",PIANO:c.piano||c.pacchetto||"BASE",LEAD_ID:i,API_ENDPOINT:g,COMPLETION_URL:m,BROCHURE_URL:`${g}/assets/brochures/brochure-ecura.pdf`,EXPIRES_IN_DAYS:u.auto_completion_token_days.toString(),AVAILABLE_FIELDS:D,MISSING_FIELDS:L},j=C(z,M);try{await R.sendEmail({to:c.email||c.email,from:((a=t.env)==null?void 0:a.EMAIL_FROM)||"info@telemedcare.it",subject:"üìù Completa la tua richiesta eCura - Ultimi dettagli necessari",html:j,text:`Gentile ${c.nomeRichiedente}, per completare la tua richiesta eCura abbiamo bisogno di alcuni dati aggiuntivi. Rispondi a questa email o contattaci a info@telemedcare.it`}),console.log(`‚úÖ Email completamento inviata a ${c.email}`);const{logCompletionAction:N}=await Promise.resolve().then(()=>at);await N(t.env.DB,i,p.id,"email_sent",`Email inviata a ${c.email}`)}catch(N){console.error("‚ùå Errore invio email completamento:",N)}}return t.json({success:!0,message:E?"Token creato e email inviata":"Token creato (email non inviata)",token:{id:p.id,completionUrl:m,expiresAt:p.expires_at,expiresInDays:u.auto_completion_token_days},missingFields:b,availableFields:h})}catch(i){return console.error("‚ùå Request completion error:",i),t.json({success:!1,error:i.message},500)}});I.get("/api/completion/validate/:token",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=t.req.param("token"),{validateCompletionToken:a,getMissingFields:i}=await Promise.resolve().then(()=>at),r=await a(t.env.DB,e);if(!r.valid)return t.json({success:!1,error:r.error},400);const s=await t.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(r.tokenData.lead_id).first();if(!s)return t.json({success:!1,error:"Lead non trovato"},404);const{missing:l,available:d}=i(s);return t.json({success:!0,lead:{id:s.id,nomeRichiedente:s.nomeRichiedente,cognomeRichiedente:s.cognomeRichiedente,email:s.email||s.email,telefono:s.telefono,servizio:s.servizio||s.tipoServizio,piano:s.piano||s.pacchetto,nomeAssistito:s.nomeAssistito,cognomeAssistito:s.cognomeAssistito,dataNascitaAssistito:s.dataNascitaAssistito,luogoNascitaAssistito:s.luogoNascitaAssistito,cfAssistito:s.cfAssistito,indirizzoAssistito:s.indirizzoAssistito,condizioniSalute:s.condizioniSalute},missingFields:l,availableFields:d,tokenId:r.tokenData.id})}catch(e){return console.error("‚ùå Validate completion token error:",e),t.json({success:!1,error:e.message},500)}});I.post("/api/leads/complete",async t=>{var o,e,a,i,r;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const s=await t.req.json(),{token:l,leadData:d}=s;if(!l)return t.json({success:!1,error:"Token mancante"},400);const{validateCompletionToken:c,markTokenAsCompleted:u}=await Promise.resolve().then(()=>at),p=await c(t.env.DB,l);if(!p.valid)return t.json({success:!1,error:p.error},400);const g=p.tokenData.lead_id;await t.env.DB.prepare(`
      UPDATE leads
      SET 
        telefono = COALESCE(?, telefono),
        nomeAssistito = COALESCE(?, nomeAssistito),
        cognomeAssistito = COALESCE(?, cognomeAssistito),
        dataNascitaAssistito = COALESCE(?, dataNascitaAssistito),
        luogoNascitaAssistito = COALESCE(?, luogoNascitaAssistito),
        cfAssistito = COALESCE(?, cfAssistito),
        indirizzoAssistito = COALESCE(?, indirizzoAssistito),
        condizioniSalute = COALESCE(?, condizioniSalute),
        updated_at = datetime('now')
      WHERE id = ?
    `).bind(d.telefono,d.nomeAssistito,d.cognomeAssistito,d.dataNascitaAssistito,d.luogoNascitaAssistito,d.cfAssistito,d.indirizzoAssistito,d.condizioniSalute,g).run(),await u(t.env.DB,p.tokenData.id),console.log(`‚úÖ Lead ${g} completato con successo`);const m=await t.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(g).first(),{getSetting:b}=await Promise.resolve().then(()=>Fg),h=await b(t.env.DB,"auto_contract_workflow_enabled");if(h&&m){console.log(`üöÄ [WORKFLOW] Avvio workflow automatico per lead ${g}`);try{const{EmailService:E}=await Promise.resolve().then(()=>At),{loadEmailTemplate:w,renderTemplate:S}=await Promise.resolve().then(()=>Pa),C=new E(t.env);if(m.vuoleBrochure==="Si"||m.vuoleBrochure===!0||m.vuoleBrochure===1)try{const R=await w("email_brochure",t.env.DB,t.env),z=S(R,{NOME_CLIENTE:m.nomeRichiedente,COGNOME_CLIENTE:m.cognomeRichiedente,SERVIZIO:m.servizio||"eCura PRO",BROCHURE_URL:"https://telemedcare-v12.pages.dev/assets/brochures/brochure-ecura.pdf"});await C.sendEmail({to:m.email||m.email,from:((e=t.env)==null?void 0:e.EMAIL_FROM)||"info@telemedcare.it",subject:"üìÑ Brochure eCura - Documentazione Completa",html:z,text:`Gentile ${m.nomeRichiedente}, in allegato trova la brochure completa del servizio eCura.`}),console.log(`‚úÖ [WORKFLOW] Brochure inviata a ${m.email}`)}catch(R){console.error("‚ö†Ô∏è [WORKFLOW] Errore invio brochure:",R)}if(m.vuoleContratto==="Si"||m.vuoleContratto===!0||m.vuoleContratto===1)try{const R=await w("email_invio_contratto",t.env.DB,t.env),z=S(R,{NOME_CLIENTE:m.nomeRichiedente,COGNOME_CLIENTE:m.cognomeRichiedente,SERVIZIO:m.servizio||"eCura PRO",PIANO:m.piano||"BASE",PREZZO_ANNO:m.prezzo_anno||480,CONTRACT_URL:`https://telemedcare-v12.pages.dev/contract/${g}`});await C.sendEmail({to:m.email||m.email,from:((a=t.env)==null?void 0:a.EMAIL_FROM)||"info@telemedcare.it",subject:"üìù Contratto eCura - Pronto per la Firma",html:z,text:`Gentile ${m.nomeRichiedente}, il contratto eCura √® pronto per la firma.`}),console.log(`‚úÖ [WORKFLOW] Contratto inviato a ${m.email}`)}catch(R){console.error("‚ö†Ô∏è [WORKFLOW] Errore invio contratto:",R)}}catch(E){console.error("‚ö†Ô∏è [WORKFLOW] Errore workflow automatico:",E)}}else console.log(`‚ÑπÔ∏è [WORKFLOW] Workflow automatico disabilitato (auto_contract_workflow_enabled=${h})`);try{const{EmailService:E}=await Promise.resolve().then(()=>At);await new E(t.env).sendEmail({to:((i=t.env)==null?void 0:i.EMAIL_TO_INFO)||"info@telemedcare.it",from:((r=t.env)==null?void 0:r.EMAIL_FROM)||"info@telemedcare.it",subject:`‚úÖ Lead Completato: ${m.nomeRichiedente} ${m.cognomeRichiedente}`,html:`
          <h2>‚úÖ Lead Completato con Successo</h2>
          <p><strong>Lead ID:</strong> ${g}</p>
          <p><strong>Nome:</strong> ${m.nomeRichiedente} ${m.cognomeRichiedente}</p>
          <p><strong>Email:</strong> ${m.email}</p>
          <p><strong>Telefono:</strong> ${m.telefono}</p>
          <p><strong>Servizio:</strong> ${m.servizio} ${m.piano}</p>
          <hr>
          <p>Il lead ha completato i dati mancanti e ora √® pronto per l'attivazione.</p>
          <p><a href="https://telemedcare-v12.pages.dev/leads">Visualizza nella Dashboard</a></p>
        `,text:`Lead ${g} completato: ${m.nomeRichiedente} ${m.cognomeRichiedente}`}),console.log("‚úÖ Notifica completamento inviata a info@telemedcare.it")}catch(E){console.error("‚ö†Ô∏è Errore invio notifica completamento:",E)}return t.json({success:!0,message:"Dati completati con successo!",leadId:g})}catch(s){return console.error("‚ùå Complete lead error:",s),t.json({success:!1,error:s.message},500)}});const Km=new Map;I.post("/api/cron/send-reminders",async t=>{try{const o=t.env.DB,e=t.env;if(!o)return t.json({success:!1,error:"Database non configurato"},500);const a=t.req.header("Authorization"),i=e.CRON_SECRET;if(i&&a!==`Bearer ${i}`)return console.log("‚ö†Ô∏è [CRON] Tentativo non autorizzato"),t.json({success:!1,error:"Non autorizzato"},401);const r=Date.now(),s=Km.get("send-reminders")||0,l=3600*1e3;if(r-s<l){const u=Math.floor((r-s)/1e3/60);return console.log(`‚ö†Ô∏è [CRON] Esecuzione gi√† avvenuta ${u} minuti fa - skip`),t.json({success:!0,message:"Esecuzione recente gi√† completata",lastExecution:new Date(s).toISOString(),minutesAgo:u},429)}Km.set("send-reminders",r),console.log("üîî [CRON] Avvio processo reminder...");const{processReminders:d}=await Promise.resolve().then(()=>at),c=await d(o,e);return c.disabled?(console.log("‚ö†Ô∏è [CRON] Cron disabilitato - nessuna azione"),t.json({success:!0,message:"Cron disabilitato dalla dashboard",stats:c},204)):(console.log(`‚úÖ [CRON] Processo reminder completato: ${c.success}/${c.total} successo, ${c.failed} falliti`),t.json({success:!0,message:"Processo reminder completato",stats:c}))}catch(o){return console.error("‚ùå [CRON] Errore processo reminder:",o),t.json({success:!1,error:o.message},500)}});I.get("/api/cron/send-reminders",async t=>{try{const o=t.env.DB,e=t.env,a=t.req.header("Authorization"),i=e.CRON_SECRET||"test-secret-change-in-production";if(e.ENVIRONMENT==="production"&&a!==`Bearer ${i}`)return t.json({success:!1,error:"Unauthorized"},401);if(!o)return t.json({success:!1,error:"Database non configurato"},500);console.log("üîî [CRON] Avvio processo reminder (GET)...");const{processReminders:r}=await Promise.resolve().then(()=>at),s=await r(o,e);return s.disabled?(console.log("‚ö†Ô∏è [CRON] Cron disabilitato - nessuna azione"),t.json({success:!0,message:"Cron disabilitato dalla dashboard",stats:s},204)):(console.log(`‚úÖ [CRON] Processo reminder completato: ${s.success}/${s.total}`),t.json({success:!0,message:"Processo reminder completato",stats:s}))}catch(o){return console.error("‚ùå [CRON] Errore processo reminder:",o),t.json({success:!1,error:o.message},500)}});I.post("/api/init-workflow-leads",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üöÄ Inizializzazione lead workflow manager...");const e=[{nome:"Eileen Elisabeth",cognome:"King",email:"",telefono:"+393475951175",servizio:"eCura PRO",piano:"AVANZATO",status:"CONTRACT_SIGNED",note:"Piano: AVANZATO - Care Giver: Elena Saglia (figlia) - IMEI: 868298061208378"},{nome:"Giuseppina",cognome:"Cozzi",email:"",telefono:"+393313809634",servizio:"eCura PRO",piano:"BASE",status:"CONTRACT_SIGNED",note:"Piano: BASE - Care Giver: Elisabetta + Germana Cattini - IMEI: 868298061207735"},{nome:"Maria",cognome:"Capone",email:"marycap34@gmail.com",telefono:"+393478740585",servizio:"eCura PRO",piano:"BASE",status:"CONTRACT_SIGNED",note:"Piano: BASE - Care Giver: Giorgio Riela (figlio) - IMEI: 868298061173234"},{nome:"Gianni Paolo",cognome:"Pizzutto",email:"",telefono:"+393398444530",servizio:"eCura PRO",piano:"BASE",status:"CONTRACT_SIGNED",note:"Piano: BASE - Care Giver: Simona Pizzutto (figlia) - IMEI: 868298060601011"},{nome:"Rita",cognome:"Pennacchio",email:"",telefono:"+393398331711",servizio:"eCura PRO",piano:"BASE",status:"CONTRACT_SIGNED",note:"Piano: BASE - Care Giver: Caterina D'Alterio (figlia) - IMEI: 868298061123759"},{nome:"Giuliana",cognome:"Balzarotti",email:"",telefono:"+393312826048",servizio:"eCura PRO",piano:"BASE",status:"CONTRACT_SIGNED",note:"Piano: BASE - Care Giver: Paolo Magr√¨ (figlio) - IMEI: 868298061206968"},{nome:"Laura",cognome:"Calvi",email:"",telefono:"",servizio:"eCura PRO",piano:"BASE",status:"CONTRACT_SIGNED",note:"Piano: BASE - Care Giver: Daniela Rocca (figlia) - IMEI: 864866055431174"},{nome:"Manuela",cognome:"Poggi",email:"manuela.poggi@example.com",telefono:"+393331234567",servizio:"eCura PRO",piano:"BASE",status:"CONTRACT_SENT",note:"Piano: BASE - Contratto inviato"}];let a=0,i=0;for(const r of e){const s=`LEAD-${r.cognome.toUpperCase()}-${Date.now()}`,l=new Date().toISOString(),d=await t.env.DB.prepare("SELECT id FROM leads WHERE cognomeRichiedente = ? AND nomeRichiedente = ?").bind(r.cognome,r.nome).first();d?(await t.env.DB.prepare(`
          UPDATE leads 
          SET status = ?, note = ?, telefono = ?, email = ?
          WHERE id = ?
        `).bind(r.status,`${r.servizio} - ${r.piano} - ${r.note}`,r.telefono,r.email||"no-email@assistito.it",d.id).run(),i++,console.log(`‚úÖ Aggiornato lead: ${r.nome} ${r.cognome} ‚Üí ${r.status}`)):(await t.env.DB.prepare(`
          INSERT INTO leads (
            id, nomeRichiedente, cognomeRichiedente, email, telefono,
            tipoServizio, note, status, fonte, created_at, timestamp
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'INIT_WORKFLOW', ?, ?)
        `).bind(s,r.nome,r.cognome,r.email||"no-email@assistito.it",r.telefono,r.servizio,`Piano: ${r.piano} - ${r.note}`,r.status,l,l).run(),a++,console.log(`‚úÖ Inserito lead: ${r.nome} ${r.cognome} ‚Üí ${r.status}`))}return t.json({success:!0,message:"Lead workflow inizializzati",stats:{leadsInseriti:a,leadsAggiornati:i,totale:e.length},leads:e.map(r=>({nome:`${r.nome} ${r.cognome}`,status:r.status}))})}catch(e){return console.error("‚ùå Errore inizializzazione workflow leads:",e),t.json({success:!1,error:"Errore inizializzazione workflow leads",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/import/excel",async t=>{try{const e=(await t.req.formData()).get("file");return!e||!(e instanceof File)?t.json({success:!1,error:"File non fornito"},400):t.json({success:!0,message:"Import Excel in sviluppo - usa endpoint /api/init-assistiti per popolare dati reali",imported:0,skipped:0,note:"Funzionalit√† disponibile a breve"})}catch(o){return console.error("‚ùå Errore import Excel:",o),t.json({success:!1,error:"Errore durante l'import del file Excel",details:o instanceof Error?o.message:String(o)},500)}});I.post("/api/import/irbema",async t=>{var o,e,a,i,r,s,l,d;try{if(console.log("üîÑ [HUBSPOT] Inizio import da HubSpot CRM (IRBEMA) - Solo lead eCura (filtro URL: ecura.it)..."),!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);if(!await au(t.env.DB,"hubspot_auto_import_enabled"))return console.log("‚è≠Ô∏è [HUBSPOT] Import automatico HubSpot disabilitato nelle impostazioni sistema"),t.json({success:!1,error:"Import automatico HubSpot disabilitato",hint:'Attiva lo switch "Import Auto HubSpot" nella Dashboard Operativa',imported:0,skipped:0},403);if(!((e=t.env)!=null&&e.HUBSPOT_ACCESS_TOKEN))return t.json({success:!1,error:"Token HubSpot non configurato",hint:"Aggiungi HUBSPOT_ACCESS_TOKEN nelle variabili di ambiente"},500);const u=t.env.HUBSPOT_ACCESS_TOKEN,p=new Date("2026-01-30T00:00:00Z");console.log(`üìÖ [HUBSPOT] Filtro attivo: solo lead da ecura.it dal ${p.toLocaleDateString("it-IT")}`);let g=0,m=0,b=0,h=0,E=0;const w=[],S=await t.env.DB.prepare("SELECT id FROM leads WHERE id LIKE 'LEAD-IRBEMA-%' ORDER BY id DESC LIMIT 1").first();let C=1;if(S!=null&&S.id){const D=S.id.match(/LEAD-IRBEMA-(\d+)/);D&&(C=parseInt(D[1])+1)}console.log(`üîç [HUBSPOT] Uso API /search con filtro data >= ${p.toISOString()}`);let R=null,z=!0;for(;z;){E++,console.log(`üìÑ [HUBSPOT] Caricamento pagina ${E}${R?` (after: ${R})`:""}...`);const D={filterGroups:[{filters:[{propertyName:"createdate",operator:"GTE",value:p.getTime().toString()}]}],properties:["firstname","lastname","email","mobilephone","city","servizio_di_interesse","piano_desiderato","message","createdate","hs_analytics_first_url","hs_analytics_last_url"],limit:100,sorts:[{propertyName:"createdate",direction:"DESCENDING"}]};R&&(D.after=R);const L=await fetch("https://api.hubapi.com/crm/v3/objects/contacts/search",{method:"POST",headers:{Authorization:`Bearer ${u}`,"Content-Type":"application/json"},body:JSON.stringify(D)});if(!L.ok){const N=await L.text();if(console.error(`‚ùå [HUBSPOT] Errore API pagina ${E} (${L.status}):`,N),g>0||m>0)break;return t.json({success:!1,error:`Errore HubSpot API: ${L.status}`,details:N},500)}const M=await L.json(),j=M.results||[];console.log(`‚úÖ [HUBSPOT] Pagina ${E}: ${j.length} contatti`),b+=j.length;for(const N of j)try{const A=N.properties,x=A.hs_analytics_first_url||"",P=A.hs_analytics_last_url||"";if(!(x.includes("ecura.it")||P.includes("ecura.it"))){console.log(`‚è≠Ô∏è [HUBSPOT] Skip: non proviene da ecura.it - ${A.firstname||"N/A"} ${A.lastname||""} (${A.email||"no-email"})`),h++;continue}const J=new Date(A.createdate);if(console.log(`‚úÖ [HUBSPOT] Lead eCura trovato: ${A.firstname||"N/A"} ${A.lastname||""} (${A.email||"no-email"}) - Creato: ${J.toLocaleDateString("it-IT")}`),!A.email&&!A.mobilephone){console.warn(`‚ö†Ô∏è [HUBSPOT] Contatto senza email/telefono, skip: ${A.firstname||"N/A"} ${A.lastname||""}`),m++;continue}const ae=A.email||"",ie=A.mobilephone||"";if(ae&&await t.env.DB.prepare("SELECT id FROM leads WHERE email = ? LIMIT 1").bind(ae).first()){console.log(`‚è≠Ô∏è [HUBSPOT] Lead gi√† esistente (email): ${ae}`),m++;continue}let Z="eCura PRO";if(console.log(`üîç [IRBEMA INLINE] PRIMA DEL MAPPING: servizio_di_interesse = ${A.servizio_di_interesse||"NULL"}`),A.servizio_di_interesse){const fe=A.servizio_di_interesse.toLowerCase();console.log(`üîç [IRBEMA INLINE] serviceLower = ${fe}`),fe.includes("family")?(Z="eCura FAMILY",console.log(`üîç [IRBEMA INLINE] MATCH: family ‚Üí servizio = ${Z}`)):fe.includes("premium")||fe.includes("vital")?(Z="eCura PREMIUM",console.log(`üîç [IRBEMA INLINE] MATCH: premium/vital ‚Üí servizio = ${Z}`)):fe.includes("pro")?(Z="eCura PRO",console.log(`üîç [IRBEMA INLINE] MATCH: pro ‚Üí servizio = ${Z}`)):console.log(`üîç [IRBEMA INLINE] NO MATCH ‚Üí servizio resta = ${Z}`)}else console.log(`üîç [IRBEMA INLINE] servizio_di_interesse NULL ‚Üí servizio default = ${Z}`);console.log(`‚úÖ [IRBEMA INLINE] SERVIZIO FINALE = ${Z}`);let H="BASE";if(A.piano_desiderato){const fe=A.piano_desiderato.toLowerCase();(fe.includes("avanzato")||fe.includes("advanced"))&&(H="AVANZATO")}let We=null,Se=null;try{const{calculatePrice:fe}=await Promise.resolve().then(()=>sr),no=Z.replace("eCura ","").toUpperCase(),Ge=H.toUpperCase(),Q=fe(no,Ge);We=Q.setupBase,Se=Q.rinnovoBase,console.log(`üí∞ [HUBSPOT] Prezzi calcolati per ${Z} ${H}: Anno ‚Ç¨${We}, Rinnovo ‚Ç¨${Se}`)}catch(fe){console.error(`‚ùå [HUBSPOT] Errore calcolo prezzi per ${Z} ${H}:`,fe)}let ut=`HubSpot ID: ${N.id}`;A.city&&(ut+=` | Citt√†: ${A.city}`),A.message&&(ut+=` | Messaggio: ${A.message}`);const Je=`LEAD-IRBEMA-${String(C).padStart(5,"0")}`;C++;const Ft=new Date().toISOString(),pt=A.email||"",$o=A.mobilephone||A.phone||"";await t.env.DB.prepare(`
            INSERT INTO leads (
              id, nomeRichiedente, cognomeRichiedente, 
              email, 
              telefono, 
              cittaAssistito,
              servizio, piano, tipoServizio, prezzo_anno, prezzo_rinnovo,
              fonte, status, vuoleBrochure, vuoleContratto,
              note, created_at, updated_at
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          `).bind(Je,A.firstname||"N/A",A.lastname||"N/A",pt,$o,A.city||null,Z,H,"eCura",We,Se,"Form eCura","NEW",1,1,ut,Ft,Ft).run(),console.log(`‚úÖ [HUBSPOT] Importato: ${Je} - ${A.firstname} ${A.lastname} | ${Z} ${H}`),g++,await ou(Je,{nomeRichiedente:A.firstname||"N/A",cognomeRichiedente:A.lastname||"",email:A.email||void 0,telefono:A.mobilephone||void 0,citta:A.city||void 0,servizio:Z,piano:H,fonte:"Form eCura",note:ut,created_at:Ft},t.env);try{if(pt){console.log(`üìß [IRBEMA] Invio email completamento a ${pt}...`);const{createCompletionToken:fe,getMissingFields:no,getSystemConfig:Ge}=await Promise.resolve().then(()=>at),Q=(await Promise.resolve().then(()=>At)).default,{loadEmailTemplate:lo,renderTemplate:W}=await Promise.resolve().then(()=>Pa),k=await t.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(Je).first();if(k){const Y=await Ge(t.env.DB),ye=await fe(t.env.DB,Je,Y.auto_completion_token_days),$t=((a=t.env)==null?void 0:a.PUBLIC_URL)||"https://telemedcare-v12.pages.dev",nr=`${$t}/api/form/${Je}?leadId=${Je}`,{missing:lr,available:cr}=no(k),dr=await lo("email_richiesta_completamento_form",t.env.DB,t.env),ur=Object.entries(cr).map(([re,an])=>({FIELD_LABEL:re,FIELD_VALUE:an})),Uo={telefono:{label:"Telefono",type:"tel",required:!0},nomeAssistito:{label:"Nome Assistito",type:"text",required:!0},cognomeAssistito:{label:"Cognome Assistito",type:"text",required:!0},dataNascitaAssistito:{label:"Data Nascita Assistito",type:"date",required:!0}},kc=lr.map(re=>{const an=Uo[re]||{label:re.charAt(0).toUpperCase()+re.slice(1),type:"text",required:!1};return{FIELD_ID:re,FIELD_NAME:re,FIELD_LABEL:an.label,INPUT_TYPE:an.type,IS_REQUIRED:an.required,IS_INPUT:!0,IS_SELECT:!1,IS_TEXTAREA:!1,OPTIONS:[]}}),Fc={NOME_CLIENTE:k.nomeRichiedente,COGNOME_CLIENTE:k.cognomeRichiedente,SERVIZIO:Z,PIANO:H,LEAD_ID:Je,API_ENDPOINT:$t,COMPLETION_URL:nr,BROCHURE_URL:`${$t}/assets/brochures/brochure-ecura.pdf`,EXPIRES_IN_DAYS:Y.auto_completion_token_days.toString(),AVAILABLE_FIELDS:ur,MISSING_FIELDS:kc},$c=W(dr,Fc);await new Q(t.env).sendEmail({to:pt,from:((i=t.env)==null?void 0:i.EMAIL_FROM)||"info@telemedcare.it",subject:"üìù Completa la tua richiesta eCura - Ultimi dettagli necessari",html:$c,text:`Gentile ${A.firstname}, per completare la tua richiesta eCura abbiamo bisogno di alcuni dati aggiuntivi.`}),console.log(`‚úÖ [IRBEMA] Email completamento inviata a ${pt}`)}}}catch(fe){console.error("‚ö†Ô∏è [IRBEMA] Errore email completamento:",fe)}}catch(A){const x=`${((r=N.properties)==null?void 0:r.firstname)||"N/A"} ${((s=N.properties)==null?void 0:s.lastname)||""}`;console.error(`‚ùå [HUBSPOT] Errore importazione contatto ${x}:`,A),w.push(`${x}: ${A instanceof Error?A.message:String(A)}`),m++}(d=(l=M.paging)==null?void 0:l.next)!=null&&d.after?(R=M.paging.next.after,console.log(`‚û°Ô∏è [HUBSPOT] Trovata pagina successiva: ${R}`)):(z=!1,console.log("üèÅ [HUBSPOT] Ultima pagina raggiunta"))}return console.log("üéØ [HUBSPOT] Import COMPLETATO:"),console.log(`   ‚Ä¢ Importati: ${g}`),console.log(`   ‚Ä¢ Saltati (duplicati): ${m}`),console.log(`   ‚Ä¢ Filtrati (pre-2026): ${h}`),console.log(`   ‚Ä¢ Totale elaborati: ${b}`),console.log(`   ‚Ä¢ Pagine: ${E}`),t.json({success:!0,message:"Import HubSpot completato (contatti dal 1/12/2025)",imported:g,skipped:m,filtered:h,total:b,pages:E,errors:w.length>0?w:void 0})}catch(c){return console.error("‚ùå [HUBSPOT] Errore generale import:",c),t.json({success:!1,error:"Errore durante l'import da HubSpot",details:c instanceof Error?c.message:String(c)},500)}});I.post("/api/import/irbema/spot",async t=>{var o,e,a;try{if(console.log("üéØ [HUBSPOT SPOT] Import 9 lead specifici da HubSpot..."),!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);if(!((e=t.env)!=null&&e.HUBSPOT_ACCESS_TOKEN))return t.json({success:!1,error:"Token HubSpot non configurato",hint:"Aggiungi HUBSPOT_ACCESS_TOKEN nelle variabili di ambiente"},500);const i=t.env.HUBSPOT_ACCESS_TOKEN,r=["fossiandrea9@gmail.com","rosaria.serino@icloud.com","amercuri93@gmail.com","simo.parravicini@gmail.com","lillonocera@libero.it","alboloc@gmail.com","sperotto24@gmail.com","gianluigi1259@gmail.com","luk91677@gmail.com"],s=await t.env.DB.prepare("SELECT id FROM leads WHERE id LIKE 'LEAD-IRBEMA-%' ORDER BY id DESC LIMIT 1").first();let l=1;if(s!=null&&s.id){const p=s.id.match(/LEAD-IRBEMA-(\d+)/);p&&(l=parseInt(p[1])+1)}let d=0,c=0;const u=[];for(const p of r)try{console.log(`üîç [SPOT] Cerco su HubSpot: ${p}`);const g=await fetch("https://api.hubapi.com/crm/v3/objects/contacts/search",{method:"POST",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:JSON.stringify({filterGroups:[{filters:[{propertyName:"email",operator:"EQ",value:p}]}],properties:["firstname","lastname","email","phone","mobilephone","city","createdate","servizio_di_interesse","piano_desiderato","message"],limit:1})});if(!g.ok){console.error(`‚ùå [SPOT] Errore ricerca HubSpot per ${p}`),c++,u.push({email:p,status:"ERROR",error:"Errore ricerca HubSpot"});continue}const m=await g.json();if(!m.results||m.results.length===0){console.log(`‚è≠Ô∏è [SPOT] Contatto non trovato su HubSpot: ${p}`),c++,u.push({email:p,status:"NOT_FOUND",error:"Non trovato su HubSpot"});continue}const b=m.results[0],h=b.properties,E=await t.env.DB.prepare("SELECT id FROM leads WHERE email = ? LIMIT 1").bind(p).first();if(E){console.log(`‚è≠Ô∏è [SPOT] Lead gi√† esistente: ${p}`),c++,u.push({email:p,status:"DUPLICATE",leadId:E.id});continue}let w="eCura PRO";if(h.servizio_di_interesse){const D=h.servizio_di_interesse.toLowerCase();D.includes("family")?w="eCura FAMILY":D.includes("premium")&&(w="eCura PREMIUM")}let S="BASE";(a=h.piano_desiderato)!=null&&a.toLowerCase().includes("avanzato")&&(S="AVANZATO");let C=`HubSpot ID: ${b.id}`;h.city&&(C+=` | Citt√†: ${h.city}`),h.message&&(C+=` | Messaggio: ${h.message}`);const R=`LEAD-IRBEMA-${String(l).padStart(5,"0")}`;l++;const z=new Date().toISOString();await t.env.DB.prepare(`
          INSERT INTO leads (
            id, nomeRichiedente, cognomeRichiedente, email, telefono, cittaAssistito,
            servizio, piano, tipoServizio, fonte, status, vuoleBrochure, vuoleContratto,
            note, created_at, updated_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(R,h.firstname||"N/A",h.lastname||"(Cognome non fornito)",p,h.mobilephone||h.phone||null,h.city||null,w,S,S,"Form eCura","NEW","No","No",C,z,z).run(),console.log(`‚úÖ [SPOT] Importato: ${R} - ${h.firstname} ${h.lastname} (${p})`),d++,u.push({email:p,status:"IMPORTED",leadId:R,nome:h.firstname,cognome:h.lastname}),await ou(R,{nomeRichiedente:h.firstname||"N/A",cognomeRichiedente:h.lastname||"(Cognome non fornito)",email:p,telefono:h.mobilephone||h.phone||void 0,citta:h.city||void 0,servizio:w,piano:S,fonte:"Form eCura",note:C,created_at:z},t.env)}catch(g){console.error(`‚ùå [SPOT] Errore import ${p}:`,g),c++,u.push({email:p,status:"ERROR",error:g instanceof Error?g.message:String(g)})}return console.log(`üéØ [SPOT] Completato: ${d} importati, ${c} saltati`),t.json({success:!0,message:"Import spot completato",imported:d,skipped:c,total:r.length,results:u})}catch(i){return console.error("‚ùå [SPOT] Errore generale:",i),t.json({success:!1,error:i instanceof Error?i.message:String(i)},500)}});I.post("/api/import/irbema/manual",async t=>{var o;try{if(console.log("üìù [HUBSPOT] Import manuale 9 lead specifici..."),!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=await t.env.DB.prepare("SELECT id FROM leads WHERE id LIKE 'LEAD-IRBEMA-%' ORDER BY id DESC LIMIT 1").first();let a=1;if(e!=null&&e.id){const d=String(e.id).match(/LEAD-IRBEMA-(\d+)/);d&&(a=parseInt(d[1])+1)}const i=[{nome:"Michela",cognome:"Annunzi",email:"amministrazione@europa92.it",telefono:"+393476735218",citta:"Modena",note:"Data HubSpot: 28/12/25 | Fonte: PRIVATO | 12/01/26 non interessata da non richiamare"},{nome:"Elisa",cognome:"Cattarossi",email:"elisa@cattarossi.it",telefono:"",citta:"",note:"Data HubSpot: 30/12/25 | Fonte: PRIVATO | 12/01/26 email inviata nessun contatto"},{nome:"Maria Carla",cognome:"Morroni",email:"morroni.mariacarla55@gmail.com",telefono:"3314563888",citta:"Genova",note:"Data HubSpot: 11/01/25 | Fonte: PRIVATO | Informazioni pi√π dettagliate | 12/01/26 nessuna risposta email inviata"},{nome:"Giuliana",cognome:"(Cognome non fornito)",email:"giuliberard@gmail.com",telefono:"",citta:"",note:"Data HubSpot: 1900 | Fonte: PRIVATO | 19/01/2026 Inviata brochure con nuovi modelli"},{nome:"Laila",cognome:"Moustafa",email:"lailamoustafa.pia@gmail.com",telefono:"3394863927",citta:"Lecce",note:"Data HubSpot: 1900 | Fonte: PRIVATO | Desidero preventivo di bracciale salvavita | 19/01/2026 nessuna risposta email inviata"},{nome:"Tiziana",cognome:"(Cognome non fornito)",email:"tizianab953@gmail.com",telefono:"",citta:"",note:"Data HubSpot: 1900 | Fonte: PRIVATO | 19/01/2026 Inviata brochure con nuovi modelli"},{nome:"Flavia",cognome:"Farm√®",email:"fiorenza.farne1@gmail.com",telefono:"",citta:"",note:"Data HubSpot: 1900 | Fonte: PRIVATO | 22/01/2026 inviata brochure con nuovi modelli"},{nome:"Lucio",cognome:"Comazza",email:"lucio.cam51@gmail.com",telefono:"3884287850",citta:"Borgomanero",note:"Data HubSpot: 1900 | Fonte: PRIVATO | Sono interessato e vorrei qualche informazione in pi√π | 26/01/2026 nessuna risposta email inviata"},{nome:"Anna",cognome:"(Cognome non fornito)",email:"sarottoanna@gmail.com",telefono:"",citta:"",note:"Data HubSpot: 1900 | Fonte: PRIVATO | 26/01/2026 nessun contatto email inviata"}];let r=0,s=0;const l=[];for(const d of i)try{if(await t.env.DB.prepare("SELECT id FROM leads WHERE email = ? OR email = ? LIMIT 1").bind(d.email,d.email).first()){console.log(`‚è≠Ô∏è [MANUAL] Lead gi√† esistente: ${d.email}`),s++;continue}const u=`LEAD-IRBEMA-${String(a).padStart(5,"0")}`,p=new Date().toISOString();await t.env.DB.prepare(`
          INSERT INTO leads (
            id, nomeRichiedente, cognomeRichiedente, email, 
            telefono, cittaAssistito, servizio, piano, tipoServizio,
            fonte, status, vuoleBrochure, vuoleContratto, note, 
            created_at, updated_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(u,d.nome,d.cognome,d.email,d.telefono||null,d.citta||null,"eCura PRO","BASE","BASE","Form eCura","NEW","No","No",d.note,p,p).run(),console.log(`‚úÖ [MANUAL] Importato: ${u} - ${d.nome} ${d.cognome} (${d.email})`),r++,a++,await ou(u,{nomeRichiedente:d.nome,cognomeRichiedente:d.cognome,email:d.email,telefono:d.telefono||void 0,citta:d.citta||void 0,servizio:"eCura PRO",piano:"BASE",fonte:"Form eCura",note:d.note,created_at:p},t.env)}catch(c){const u=`Errore import ${d.email}: ${c instanceof Error?c.message:String(c)}`;console.error(`‚ùå [MANUAL] ${u}`),l.push(u)}return t.json({success:!0,message:"Import manuale completato",imported:r,skipped:s,total:i.length,errors:l.length>0?l:void 0})}catch(e){return console.error("‚ùå [MANUAL] Errore generale:",e),t.json({success:!1,error:"Errore durante l'import manuale",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/import/irbema/cleanup",async t=>{var o;try{if(console.log("üßπ [CLEANUP] Pulizia lead IRBEMA >= 128 - mantengo solo i 9 specifici..."),!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=["amministrazione@europa92.it","morroni.mariacarla55@gmail.com","lailamoustafa.pia@gmail.com","lucio.cam51@gmail.com","elisa@cattarossi.it","giuliberard@gmail.com","tizianab953@gmail.com","fiorenza.farne1@gmail.com","sarottoanna@gmail.com"],a=await t.env.DB.prepare(`
      SELECT COUNT(*) as count FROM leads 
      WHERE (fonte = 'IRBEMA' OR fonte = 'Form eCura') 
      AND (
        id >= 'LEAD-IRBEMA-00128'
        OR id LIKE 'LEAD-IRBEMA-001%'
        OR id LIKE 'LEAD-IRBEMA-002%'
        OR id LIKE 'LEAD-IRBEMA-003%'
      )
    `).first();console.log(`üìä [CLEANUP] Lead IRBEMA >= 128 prima della pulizia: ${(a==null?void 0:a.count)||0}`);const i=e.map(()=>"?").join(","),r=await t.env.DB.prepare(`
      DELETE FROM leads 
      WHERE (fonte = 'IRBEMA' OR fonte = 'Form eCura') 
      AND (
        CAST(SUBSTR(id, 14) AS INTEGER) >= 128
      )
      AND email NOT IN (${i})
    `).bind(...e).run(),s=await t.env.DB.prepare("SELECT COUNT(*) as count FROM leads WHERE fonte IN ('IRBEMA', 'Form eCura')").first();return console.log(`‚úÖ [CLEANUP] Lead IRBEMA eliminati: ${r.meta.changes||0}`),console.log(`üìä [CLEANUP] Lead IRBEMA totali rimanenti: ${(s==null?void 0:s.count)||0}`),t.json({success:!0,message:"Cleanup completato - mantenuti lead < 128 + i 9 specifici",before:(a==null?void 0:a.count)||0,deleted:r.meta.changes||0,total_remaining:(s==null?void 0:s.count)||0})}catch(e){return console.error("‚ùå [CLEANUP] Errore:",e),t.json({success:!1,error:"Errore durante il cleanup",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/import/irbema/renumber",async t=>{var o;try{if(console.log("üî¢ [RENUMBER] Rinumerazione lead IRBEMA dal 128 in poi..."),!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=[{email:"amministrazione@europa92.it",newId:"LEAD-IRBEMA-00128",nome:"Michela Annunzi"},{email:"morroni.mariacarla55@gmail.com",newId:"LEAD-IRBEMA-00129",nome:"Maria Carla Morroni"},{email:"lailamoustafa.pia@gmail.com",newId:"LEAD-IRBEMA-00130",nome:"Laila Moustafa"},{email:"lucio.cam51@gmail.com",newId:"LEAD-IRBEMA-00131",nome:"Lucio Comazza"},{email:"elisa@cattarossi.it",newId:"LEAD-IRBEMA-00132",nome:"Elisa Cattarossi"},{email:"giuliberard@gmail.com",newId:"LEAD-IRBEMA-00133",nome:"Giuliana"},{email:"tizianab953@gmail.com",newId:"LEAD-IRBEMA-00134",nome:"Tiziana"},{email:"fiorenza.farne1@gmail.com",newId:"LEAD-IRBEMA-00135",nome:"Flavia Farm√®"},{email:"sarottoanna@gmail.com",newId:"LEAD-IRBEMA-00136",nome:"Anna"}];let a=0;const i=[];for(const r of e)try{const s=await t.env.DB.prepare("SELECT id FROM leads WHERE email = ? AND fonte = ? LIMIT 1").bind(r.email,"IRBEMA").first();s&&s.id!==r.newId?(await t.env.DB.prepare("UPDATE leads SET id = ? WHERE email = ? AND fonte = ?").bind(r.newId,r.email,"IRBEMA").run(),console.log(`‚úÖ [RENUMBER] ${s.id} ‚Üí ${r.newId} (${r.nome})`),i.push({email:r.email,oldId:s.id,newId:r.newId,nome:r.nome}),a++):s?console.log(`‚è≠Ô∏è [RENUMBER] ${r.newId} gi√† corretto (${r.nome})`):console.warn(`‚ö†Ô∏è [RENUMBER] Lead non trovato: ${r.email}`)}catch(s){console.error(`‚ùå [RENUMBER] Errore ${r.email}:`,s)}return t.json({success:!0,message:"Rinumerazione completata",updated:a,changes:i})}catch(e){return console.error("‚ùå [RENUMBER] Errore generale:",e),t.json({success:!1,error:"Errore durante la rinumerazione",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/fix-lead-associations",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üîß Correzione associazioni lead-contratti-assistiti...");const e=[{assistito:{nome:"Maria",cognome:"Capone",imei:"868298061173234"},lead:{id:"LEAD-EXCEL-059",nome:"Giorgio",cognome:"Riela",ruolo:"caregiver/figlio"}},{assistito:{nome:"Giuliana",cognome:"Balzarotti",imei:"868298061206968"},lead:{id:"LEAD-EXCEL-060",nome:"Paolo",cognome:"Magr√¨",ruolo:"caregiver/figlio"}},{assistito:{nome:"Giuseppina",cognome:"Cozzi",imei:"868298061207735"},lead:{id:"LEAD-EXCEL-071",nome:"Elisabetta",cognome:"Cattini",ruolo:"caregiver"}},{assistito:{nome:"Laura",cognome:"Calvi",imei:"864866055431174"},lead:{id:"LEAD-EXCEL-065",nome:"Laura",cognome:"Calvi",ruolo:"assistita (lead stesso)"}}];let a=0,i=0,r=0;for(const s of e){const l=await t.env.DB.prepare("SELECT id FROM leads WHERE id = ? OR (nomeRichiedente = ? AND cognomeRichiedente = ?)").bind(s.lead.id,s.lead.nome,s.lead.cognome).first();if(!l){console.warn(`‚ö†Ô∏è Lead non trovato: ${s.lead.nome} ${s.lead.cognome} (${s.lead.id})`);continue}console.log(`‚úÖ Lead trovato: ${l.id} per ${s.assistito.nome} ${s.assistito.cognome}`),await t.env.DB.prepare(`
        UPDATE leads 
        SET nomeAssistito = ?, cognomeAssistito = ?, 
            note = COALESCE(note, '') || ' | Assistito: ' || ? || ' ' || ? || ' (IMEI: ' || ? || ')'
        WHERE id = ? AND (nomeAssistito IS NULL OR nomeAssistito = '')
      `).bind(s.assistito.nome,s.assistito.cognome,s.assistito.nome,s.assistito.cognome,s.assistito.imei,l.id).run(),i++;const d=await t.env.DB.prepare("SELECT id, leadId FROM contracts WHERE imei_dispositivo = ?").bind(s.assistito.imei).first();if(d)await t.env.DB.prepare(`
          UPDATE contracts 
          SET leadId = ?
          WHERE id = ?
        `).bind(l.id,d.id).run(),a++,console.log(`‚úÖ Contratto aggiornato: ${d.id} ‚Üí leadId: ${l.id}`);else if(s.assistito.cognome!=="Calvi"){const c=`CONTRACT-${s.assistito.cognome.toUpperCase()}-${Date.now()}`,u=`CTR-${s.assistito.cognome.toUpperCase()}-2025`,p=s.assistito.cognome==="King"?"AVANZATO":"BASE",g=p==="AVANZATO"?840:480,m=p==="AVANZATO"?69:39;await t.env.DB.prepare(`
          INSERT INTO contracts (
            id, leadId, codice_contratto, tipo_contratto, status, 
            prezzo_totale, prezzo_mensile, durata_mesi, imei_dispositivo, 
            created_at, template_utilizzato, contenuto_html
          ) VALUES (?, ?, ?, ?, 'SIGNED', ?, ?, 12, ?, ?, 'BASE', '')
        `).bind(c,l.id,u,p,g,m,s.assistito.imei,new Date().toISOString()).run(),r++,console.log(`‚úÖ Contratto creato: ${u} per ${s.assistito.nome} ${s.assistito.cognome}`)}}return t.json({success:!0,message:"Associazioni corrette con lead reali",stats:{leadsAggiornati:i,contrattiAggiornati:a,contrattiCreati:r,totaleAssociazioni:e.length}})}catch(e){return console.error("‚ùå Errore correzione associazioni:",e),t.json({success:!1,error:"Errore correzione associazioni",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/delete-manual-duplicates",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üßπ Eliminazione lead manual duplicati...");const e=["LEAD-MANUAL-1766885130882","LEAD-MANUAL-1766885181620"];let a=0;for(const r of e)try{(await t.env.DB.prepare("DELETE FROM leads WHERE id = ?").bind(r).run()).meta.changes>0&&(console.log(`‚úÖ Eliminato: ${r}`),a++)}catch(s){console.error(`‚ùå Errore eliminando ${r}:`,s)}const i=await t.env.DB.prepare("SELECT COUNT(*) as count FROM leads").first();return t.json({success:!0,message:"Lead duplicati manual eliminati",stats:{deleted:a,totalLeads:(i==null?void 0:i.count)||0}})}catch(e){return console.error("‚ùå Errore eliminazione duplicati:",e),t.json({success:!1,error:"Errore eliminazione duplicati",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/cleanup-duplicate-leads",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üßπ Pulizia lead duplicati (INIT_WORKFLOW e MANUAL test)...");const e=await t.env.DB.prepare("SELECT COUNT(*) as count FROM leads").first(),a=await t.env.DB.prepare(`
      DELETE FROM leads 
      WHERE fonte = 'INIT_WORKFLOW'
    `).run(),i=await t.env.DB.prepare(`
      DELETE FROM leads 
      WHERE fonte = 'MANUAL_ENTRY' 
      AND (nomeRichiedente = 'Test' OR nomeRichiedente = 'Roberto')
    `).run(),r=await t.env.DB.prepare("SELECT COUNT(*) as count FROM leads").first(),s=((e==null?void 0:e.count)||0)-((r==null?void 0:r.count)||0);return console.log(`‚úÖ Eliminati ${s} lead duplicati`),console.log(`üìä Lead rimasti: ${r==null?void 0:r.count}`),t.json({success:!0,message:"Lead duplicati eliminati",stats:{beforeCount:e==null?void 0:e.count,afterCount:r==null?void 0:r.count,deletedCount:s,deletedInit:a.meta.changes,deletedManual:i.meta.changes}})}catch(e){return console.error("‚ùå Errore pulizia lead:",e),t.json({success:!1,error:"Errore pulizia lead duplicati",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/fix-contracts-piano",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üîß Fix piani contratti basandosi su prezzo_totale...");const a=(await t.env.DB.prepare("PRAGMA table_info(contracts)").all()).results.some(s=>s.name==="piano");a||(await t.env.DB.prepare("ALTER TABLE contracts ADD COLUMN piano TEXT").run(),console.log("‚úÖ Colonna piano aggiunta"));const i=await t.env.DB.prepare(`
      UPDATE contracts 
      SET piano = CASE 
        WHEN prezzo_totale >= 800 THEN 'AVANZATO'
        WHEN prezzo_totale > 0 THEN 'BASE'
        ELSE 'BASE'
      END
      WHERE piano IS NULL
    `).run();console.log(`‚úÖ Aggiornati ${i.meta.changes} contratti`);const r=await t.env.DB.prepare(`
      SELECT id, piano, prezzo_totale FROM contracts ORDER BY prezzo_totale DESC
    `).all();return t.json({success:!0,message:"Piani contratti aggiornati",stats:{updated:i.meta.changes,hasPianoColumn:a,contracts:r.results}})}catch(e){return console.error("‚ùå Errore fix piani:",e),t.json({success:!1,error:"Errore fix piani contratti",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/fix-ecura-duplication",async t=>{var o,e,a,i,r,s,l,d,c,u,p,g,m;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log('üßπ Pulizia duplicazione "eCura eCura" dal database...');let b=0;const h=await t.env.DB.prepare(`
      UPDATE contracts 
      SET servizio = REPLACE(servizio, 'eCura eCura', 'eCura')
      WHERE servizio LIKE '%eCura eCura%'
    `).run();b+=((e=h.meta)==null?void 0:e.changes)||0,console.log(`‚úÖ Contratti fixati: ${((a=h.meta)==null?void 0:a.changes)||0}`);const E=await t.env.DB.prepare(`
      UPDATE leads 
      SET servizio = REPLACE(servizio, 'eCura eCura', 'eCura')
      WHERE servizio LIKE '%eCura eCura%'
    `).run();b+=((i=E.meta)==null?void 0:i.changes)||0,console.log(`‚úÖ Leads (servizio) fixati: ${((r=E.meta)==null?void 0:r.changes)||0}`);const w=await t.env.DB.prepare(`
      UPDATE leads 
      SET tipoServizio = REPLACE(tipoServizio, 'eCura eCura', 'eCura')
      WHERE tipoServizio LIKE '%eCura eCura%'
    `).run();b+=((s=w.meta)==null?void 0:s.changes)||0,console.log(`‚úÖ Leads (tipoServizio) fixati: ${((l=w.meta)==null?void 0:l.changes)||0}`);const S=await t.env.DB.prepare(`
      UPDATE leads 
      SET note = REPLACE(note, 'Servizio: eCura eCura', 'Servizio: eCura')
      WHERE note LIKE '%Servizio: eCura eCura%'
    `).run();b+=((d=S.meta)==null?void 0:d.changes)||0,console.log(`‚úÖ Leads (note) fixati: ${((c=S.meta)==null?void 0:c.changes)||0}`);const C=await t.env.DB.prepare(`
      SELECT codice_contratto, servizio FROM contracts WHERE servizio LIKE '%eCura%' LIMIT 5
    `).all(),R=await t.env.DB.prepare(`
      SELECT id, servizio, tipoServizio FROM leads WHERE servizio LIKE '%eCura%' OR tipoServizio LIKE '%eCura%' LIMIT 5
    `).all();return t.json({success:!0,message:'‚úÖ Duplicazione "eCura eCura" rimossa con successo!',stats:{totalFixed:b,contracts:((u=h.meta)==null?void 0:u.changes)||0,leadsServizio:((p=E.meta)==null?void 0:p.changes)||0,leadsTipo:((g=w.meta)==null?void 0:g.changes)||0,leadsNotes:((m=S.meta)==null?void 0:m.changes)||0},samples:{contracts:C.results,leads:R.results}})}catch(b){return console.error("‚ùå Errore fix duplicazione eCura:",b),t.json({success:!1,error:"Errore fix duplicazione eCura",details:b instanceof Error?b.message:String(b)},500)}});I.post("/api/migrations/0006-add-piano-servizio",async t=>{var o,e,a;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üîß Migration 0006: Aggiungi piano e servizio alla tabella leads...");const r=(await t.env.DB.prepare("PRAGMA table_info(leads)").all()).results.map(S=>S.name),s=r.includes("piano"),l=r.includes("servizio");console.log(`üìä Colonne esistenti: piano=${s}, servizio=${l}`),console.log("üìä Tutte le colonne:",r);let d=!1,c=!1,u=null,p=null;if(!s)try{const S=await t.env.DB.prepare("ALTER TABLE leads ADD COLUMN piano TEXT DEFAULT 'BASE'").run();console.log("‚úÖ Colonna piano aggiunta:",S),d=!0}catch(S){console.error("‚ùå Errore aggiunta colonna piano:",S),u=S instanceof Error?S.message:String(S)}if(!l)try{const S=await t.env.DB.prepare("ALTER TABLE leads ADD COLUMN servizio TEXT DEFAULT 'eCura PRO'").run();console.log("‚úÖ Colonna servizio aggiunta:",S),c=!0}catch(S){console.error("‚ùå Errore aggiunta colonna servizio:",S),p=S instanceof Error?S.message:String(S)}const m=(await t.env.DB.prepare("PRAGMA table_info(leads)").all()).results.map(S=>S.name),b=m.includes("piano"),h=m.includes("servizio");console.log(`üìä Colonne dopo ALTER: piano=${b}, servizio=${h}`);let E={meta:{changes:0}};if(b&&h)try{E=await t.env.DB.prepare(`
          UPDATE leads 
          SET servizio = COALESCE(tipoServizio, 'eCura PRO'),
              piano = CASE 
                  WHEN note LIKE '%Piano: AVANZATO%' OR note LIKE '%AVANZATO%' THEN 'AVANZATO'
                  ELSE 'BASE'
              END
          WHERE 1=1
        `).run(),console.log(`‚úÖ Migrati ${((e=E.meta)==null?void 0:e.changes)||0} lead`)}catch(S){console.error("‚ùå Errore migrazione dati:",S)}else console.warn("‚ö†Ô∏è Colonne non presenti, skip migrazione dati");const w=await t.env.DB.prepare(`
      SELECT 
        COUNT(*) as total_leads,
        SUM(CASE WHEN piano = 'BASE' THEN 1 ELSE 0 END) as piano_base,
        SUM(CASE WHEN piano = 'AVANZATO' THEN 1 ELSE 0 END) as piano_avanzato,
        SUM(CASE WHEN servizio = 'eCura PRO' OR servizio = 'PRO' THEN 1 ELSE 0 END) as servizio_pro,
        SUM(CASE WHEN servizio = 'eCura Family' OR servizio = 'FAMILY' THEN 1 ELSE 0 END) as servizio_family,
        SUM(CASE WHEN servizio = 'eCura PREMIUM' OR servizio = 'PREMIUM' THEN 1 ELSE 0 END) as servizio_premium
      FROM leads
    `).first();return t.json({success:b&&h,message:b&&h?"‚úÖ Migration 0006 completata con successo!":"‚ö†Ô∏è Migration parziale o fallita",debug:{columnsBefore:r,columnsAfter:m,hasPianoBefore:s,hasServizioBefore:l,hasPianoAfter:b,hasServizioAfter:h,pianoAdded:d,servizioAdded:c,pianoError:u,servizioError:p},columnsAdded:{piano:d,servizio:c},migrated:((a=E.meta)==null?void 0:a.changes)||0,stats:w})}catch(i){return console.error("‚ùå Errore migration 0006:",i),t.json({success:!1,error:"Errore migration 0006",details:i instanceof Error?i.message:String(i)},500)}});I.post("/api/import-excel-leads",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const a=(await t.req.json()).leads||[];if(!Array.isArray(a)||a.length===0)return t.json({success:!1,error:"Nessun lead fornito"},400);console.log(`üì• Import di ${a.length} lead da Excel...`);let i=0,r=0,s=0;for(const l of a)try{let d=null;if(l.email&&(d=await t.env.DB.prepare(`
            SELECT id FROM leads WHERE email = ? LIMIT 1
          `).bind(l.email).first()),!d&&l.telefono&&(d=await t.env.DB.prepare(`
            SELECT id FROM leads WHERE telefono = ? LIMIT 1
          `).bind(l.telefono).first()),d){r++;continue}const c=`LEAD-EXCEL-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,u=l.email||(l.telefono?`noemail+${l.telefono}@telemedcare.it`:`noemail+${c}@telemedcare.it`);await t.env.DB.prepare(`
          INSERT INTO leads (
            id, nomeRichiedente, cognomeRichiedente, email, telefono,
            tipoServizio, fonte, status, note, nomeAssistito, cognomeAssistito, created_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(c,l.nome||"N/A",l.cognome||"N/A",u,l.telefono||"","eCura PRO","EXCEL_IMPORT","NUOVO",`Canale: ${l.canale||"IRBEMA"} | Location: ${l.location||""} | Note: ${l.note||""} | Messaggio: ${l.messaggio||""}`.trim(),l.assistito_nome?l.assistito_nome.split(" ")[0]:null,l.assistito_nome?l.assistito_nome.split(" ").slice(1).join(" "):null,new Date().toISOString()).run(),i++}catch(d){console.error(`‚ùå Errore import lead ${l.nome}:`,d),s++}return console.log(`‚úÖ Import completato: ${i} importati, ${r} gi√† esistenti, ${s} errori`),t.json({success:!0,message:"Import lead completato",stats:{total:a.length,imported:i,skipped:r,errors:s}})}catch(e){return console.error("‚ùå Errore import lead:",e),t.json({success:!1,error:"Errore import lead",details:e instanceof Error?e.message:String(e)},500)}});I.get("/api/db/schema/leads",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({error:"DB non configurato"},500);const e=await t.env.DB.prepare("PRAGMA table_info(leads)").all();return t.json({success:!0,columns:e.results,count:e.results.length})}catch(e){return t.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.get("/api/check-version",async t=>t.json({version:"v2.0-leadId-fix",timestamp:new Date().toISOString(),message:"Endpoint aggiornato con fix leadId NOT NULL"}));I.post("/api/reset-assistiti",async t=>{var o;try{return(o=t.env)!=null&&o.DB?(console.log("üóëÔ∏è Reset completo assistiti e contratti..."),await t.env.DB.prepare("DELETE FROM contracts").run(),await t.env.DB.prepare("DELETE FROM assistiti").run(),await t.env.DB.prepare('DELETE FROM leads WHERE id LIKE "LEAD-%-"').run(),console.log("‚úÖ Database pulito"),t.json({success:!0,message:"Database assistiti/contratti resettato",timestamp:new Date().toISOString()})):t.json({success:!1,error:"Database non configurato"},500)}catch(e){return console.error("‚ùå Errore reset:",e),t.json({success:!1,error:"Errore reset database",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/init-assistiti",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üöÄ Inizializzazione assistiti reali...");try{await t.env.DB.prepare(`
        ALTER TABLE assistiti ADD COLUMN imei TEXT
      `).run(),console.log("‚úÖ Colonna IMEI aggiunta a tabella assistiti")}catch(s){console.log("‚ÑπÔ∏è Colonna IMEI gi√† esistente o errore non critico:",s)}try{await t.env.DB.prepare(`
        ALTER TABLE contracts ADD COLUMN imei_dispositivo TEXT
      `).run(),console.log("‚úÖ Colonna imei_dispositivo aggiunta a tabella contracts")}catch(s){console.log("‚ÑπÔ∏è Colonna imei_dispositivo gi√† esistente:",s)}const e=[{nome:"Eileen Elisabeth",cognome:"King",imei:"868298061208378",servizio:"eCura PRO",piano:"AVANZATO",careGiver:"Elena Saglia",parentela:"figlia",dataNascita:"1935-05-18",sesso:"Donna",peso:80,altezza:157,telefono:"+393475951175",indirizzo:"Via Diaz 34, Cernusco sul Naviglio (MI)",email:"",contratto:!0},{nome:"Giuseppina",cognome:"Cozzi",imei:"868298061207735",servizio:"eCura PRO",piano:"BASE",careGiver:"Elisabetta Cattini, Germana Cattini",parentela:"operatori sanitari",dataNascita:"1939-01-28",sesso:"Donna",peso:80,altezza:150,telefono:"+393313809634",indirizzo:"VIA 4 NOVEMBRE 12, 20014 NERVIANO MI",email:"",contratto:!0},{nome:"Maria",cognome:"Capone",imei:"868298061173234",servizio:"eCura PRO",piano:"BASE",careGiver:"Giorgio Riela",parentela:"figlio",dataNascita:"1934-08-15",sesso:"Donna",peso:64,altezza:140,telefono:"+393478740585",indirizzo:"via 100/80 Castiglione torinese to",email:"marycap34@gmail.com",contratto:!0},{nome:"Gianni Paolo",cognome:"Pizzutto",imei:"868298060601011",servizio:"eCura PRO",piano:"BASE",careGiver:"Simona Pizzutto",parentela:"figlia",dataNascita:"1939-06-26",sesso:"Uomo",peso:80,altezza:170,telefono:"+393398444530",indirizzo:"Via Costituzione 5, S. Mauro Torinese (TO)",email:"",contratto:!0},{nome:"Rita",cognome:"Pennacchio",imei:"868298061123759",servizio:"eCura PRO",piano:"BASE",careGiver:"Caterina D'Alterio",parentela:"figlia",dataNascita:"1934-10-28",sesso:"Donna",peso:60,altezza:150,telefono:"+393398331711",indirizzo:"Via Antonio Fogazzaro 28, Giugliano (NA)",email:"",contratto:!0},{nome:"Giuliana",cognome:"Balzarotti",imei:"868298061206968",servizio:"eCura PRO",piano:"BASE",careGiver:"Paolo Magr√¨",parentela:"figlio",dataNascita:"",sesso:"Donna",peso:70,altezza:165,telefono:"+393312826048",indirizzo:"",email:"",contratto:!0},{nome:"Laura",cognome:"Calvi",imei:"864866055431174",servizio:"eCura PRO",piano:"BASE",careGiver:"Daniela Rocca",parentela:"figlia",dataNascita:"",sesso:"Donna",peso:0,altezza:0,telefono:"",indirizzo:"",email:"",contratto:!1}];let a=0,i=0,r=0;for(const s of e){const l=`ASS-${s.cognome.toUpperCase()}-${Date.now()}`,d=new Date().toISOString();await t.env.DB.prepare("SELECT id FROM assistiti WHERE imei = ?").bind(s.imei).first()?(await t.env.DB.prepare(`
          UPDATE assistiti 
          SET nome = ?, nome_assistito = ?, cognome_assistito = ?,
              nome_caregiver = ?, cognome_caregiver = ?, parentela_caregiver = ?,
              email = ?, telefono = ?, status = 'ATTIVO'
          WHERE imei = ?
        `).bind(`${s.nome} ${s.cognome}`,s.nome,s.cognome,s.careGiver?s.careGiver.split(" ")[0]:null,s.careGiver?s.careGiver.split(" ").slice(1).join(" "):null,s.parentela||null,s.email,s.telefono,s.imei).run(),i++,console.log(`‚úÖ Aggiornato assistito: ${s.nome} ${s.cognome} (IMEI: ${s.imei})`)):(await t.env.DB.prepare(`
          INSERT INTO assistiti (
            codice, nome, nome_assistito, cognome_assistito, 
            nome_caregiver, cognome_caregiver, parentela_caregiver,
            email, telefono, imei, status, created_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'ATTIVO', ?)
        `).bind(l,`${s.nome} ${s.cognome}`,s.nome,s.cognome,s.careGiver?s.careGiver.split(" ")[0]:null,s.careGiver?s.careGiver.split(" ").slice(1).join(" "):null,s.parentela||null,s.email,s.telefono,s.imei,d).run(),a++,console.log(`‚úÖ Inserito assistito: ${s.nome} ${s.cognome} (IMEI: ${s.imei})`));let u=null;if(s.contratto){const p=await t.env.DB.prepare(`
          SELECT id FROM leads 
          WHERE (cognomeRichiedente = ? OR nomeRichiedente = ?) 
             OR (email != '' AND email = ?)
          LIMIT 1
        `).bind(s.cognome,s.nome,s.email||"").first();if(p)u=p.id,console.log(`‚úÖ Lead trovato: ${u} per ${s.nome} ${s.cognome}`);else{console.warn(`‚ö†Ô∏è Lead NON trovato per ${s.nome} ${s.cognome} - Contratto NON creato`);continue}const g=`CTR-${s.cognome.toUpperCase()}-${new Date().getFullYear()}`,m=await t.env.DB.prepare("SELECT id FROM contracts WHERE imei_dispositivo = ? OR leadId = ? OR codice_contratto = ?").bind(s.imei,u,g).first();if(m)console.log(`‚ÑπÔ∏è Contratto esistente trovato: ${m.id}`);else{const b=`CONTRACT-${s.cognome.toUpperCase()}-${Date.now()}`,h=s.piano==="AVANZATO"?840:480;await t.env.DB.prepare(`
            INSERT INTO contracts (
              id, leadId, codice_contratto, tipo_contratto, status, 
              prezzo_totale, imei_dispositivo, created_at,
              template_utilizzato, contenuto_html, prezzo_mensile, durata_mesi
            ) VALUES (?, ?, ?, ?, 'SIGNED', ?, ?, ?, 'BASE', '', ?, 12)
          `).bind(b,u,g,s.piano,h,s.imei,d,s.piano==="AVANZATO"?69:39).run(),r++,console.log(`‚úÖ Contratto creato: ${g} per ${s.nome} ${s.cognome} (leadId: ${u})`)}}}return t.json({success:!0,message:"Database inizializzato con assistiti reali",stats:{assistitiInseriti:a,assistitiAggiornati:i,contrattiCreati:r,totaleAssistiti:e.length},assistiti:e.map(s=>({nome:`${s.nome} ${s.cognome}`,imei:s.imei,piano:s.piano,contratto:s.contratto?"‚úÖ":"‚ùå"}))})}catch(e){return console.error("‚ùå Errore inizializzazione assistiti:",e),t.json({success:!1,error:"Errore inizializzazione assistiti",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/init-force",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üöÄüöÄüöÄ FORCE INIT - Creazione lead + contratti + FIX existing...");const e=[{nome:"Eileen Elisabeth",cognome:"King",imei:"868298061208378",piano:"AVANZATO",careGiver:"Elena Saglia",parentela:"figlia",telefono:"+393475951175",email:"",servizio:"eCura PRO"},{nome:"Giuseppina",cognome:"Cozzi",imei:"868298061207735",piano:"BASE",careGiver:"Elisabetta Cattini",parentela:"operatore",telefono:"+393313809634",email:"",servizio:"eCura PRO"},{nome:"Maria",cognome:"Capone",imei:"868298061173234",piano:"BASE",careGiver:"Giorgio Riela",parentela:"figlio",telefono:"+393478740585",email:"marycap34@gmail.com",servizio:"eCura PRO"},{nome:"Gianni Paolo",cognome:"Pizzutto",imei:"868298060601011",piano:"BASE",careGiver:"Simona Pizzutto",parentela:"figlia",telefono:"+393398444530",email:"",servizio:"eCura PRO"},{nome:"Rita",cognome:"Pennacchio",imei:"868298061123759",piano:"BASE",careGiver:"Caterina D'Alterio",parentela:"figlia",telefono:"+393398331711",email:"",servizio:"eCura PRO"},{nome:"Giuliana",cognome:"Balzarotti",imei:"868298061206968",piano:"BASE",careGiver:"Paolo Magr√¨",parentela:"figlio",telefono:"+393312826048",email:"",servizio:"eCura PRO"}];let a=0,i=0,r=0;for(const s of e){const l=new Date().toISOString(),d=`CTR-${s.cognome.toUpperCase()}-2025`;let c=null;const u=await t.env.DB.prepare("SELECT id FROM leads WHERE email = ? OR (nomeAssistito = ? AND cognomeAssistito = ?)").bind(s.email||"",s.nome,s.cognome).first();u?c=u.id:(c=`LEAD-${s.cognome.toUpperCase()}-${Date.now()}`,await t.env.DB.prepare(`
          INSERT INTO leads (
            id, nomeRichiedente, cognomeRichiedente, email, telefono,
            nomeAssistito, cognomeAssistito, tipoServizio, status, note, created_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'CONVERTED', ?, ?)
        `).bind(c,s.careGiver,"",s.email||`${s.cognome.toLowerCase()}@assistito.it`,s.telefono,s.nome,s.cognome,s.servizio,`Piano ${s.piano} - IMEI: ${s.imei}`,l).run(),a++);const p=await t.env.DB.prepare(`
        SELECT c.id, c.leadId FROM contracts c
        LEFT JOIN leads l ON c.leadId = l.id
        WHERE c.leadId = ? 
           OR (c.codice_contratto = ?)
           OR (l.nomeAssistito = ? AND l.cognomeAssistito = ?)
        LIMIT 1
      `).bind(c,d,s.nome,s.cognome).first();if(p)await t.env.DB.prepare(`
          UPDATE contracts
          SET imei_dispositivo = ?, 
              codice_contratto = ?, 
              tipo_contratto = ?,
              prezzo_totale = ?,
              prezzo_mensile = ?
          WHERE id = ?
        `).bind(s.imei,d,s.piano,s.piano==="AVANZATO"?840:480,s.piano==="AVANZATO"?69:39,p.id).run(),r++,console.log(`‚úÖ Contratto aggiornato: ${d} con IMEI ${s.imei}`);else{const g=`CONTRACT-${s.cognome.toUpperCase()}-${Date.now()}`,m=s.piano==="AVANZATO"?840:480;await t.env.DB.prepare(`
          INSERT INTO contracts (
            id, leadId, codice_contratto, tipo_contratto, status, 
            prezzo_totale, imei_dispositivo, created_at,
            template_utilizzato, contenuto_html, prezzo_mensile, durata_mesi
          ) VALUES (?, ?, ?, ?, 'SIGNED', ?, ?, ?, 'BASE', '', ?, 12)
        `).bind(g,c,d,s.piano,m,s.imei,l,s.piano==="AVANZATO"?69:39).run(),i++,console.log(`‚úÖ Contratto creato: ${d} per ${s.nome} ${s.cognome}`)}}return t.json({success:!0,message:"FORCE INIT completato con UPDATE contratti",stats:{leadsCreated:a,contractsCreated:i,contractsUpdated:r,assistitiTotali:e.length}})}catch(e){return console.error("‚ùå FORCE ERROR:",e),t.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.get("/api/assistiti",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=t.req.query("id");let i=(t.req.query("status")||"ATTIVO").toUpperCase()==="ALL"?"WHERE 1=1":"WHERE a.status = 'ATTIVO'";const r=[];e&&(i+=" AND a.id = ?",r.push(parseInt(e)));const s=await t.env.DB.prepare(`
      SELECT 
        a.id,
        a.codice,
        a.nome,
        a.nome_assistito,
        a.cognome_assistito,
        a.nome_caregiver,
        a.cognome_caregiver,
        a.parentela_caregiver,
        a.email,
        a.telefono,
        a.imei,
        a.servizio,
        a.piano,
        a.status,
        a.lead_id,
        a.created_at,
        c.id as contratto_id,
        c.codice_contratto,
        c.tipo_contratto as piano_contratto,
        c.servizio as servizio_contratto,
        c.status as contratto_status
      FROM assistiti a
      LEFT JOIN contracts c ON a.lead_id = c.leadId
      ${i}
      ORDER BY a.created_at DESC
    `).bind(...r).all();return t.json({success:!0,count:s.results.length,assistiti:s.results})}catch(e){return console.error("‚ùå Errore recupero assistiti:",e),t.json({success:!1,error:"Errore recupero assistiti",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/assistiti",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=await t.req.json();if(!e.nome||!e.cognome)return t.json({success:!1,error:"Campi obbligatori mancanti: nome, cognome"},400);const a=`ASS-${e.cognome.toUpperCase()}-${Date.now()}`,i=new Date().toISOString();return await t.env.DB.prepare(`
      INSERT INTO assistiti (
        codice, nome, email, telefono, imei, status, lead_id, created_at
      ) VALUES (?, ?, ?, ?, ?, 'ATTIVO', ?, ?)
    `).bind(a,`${e.nome} ${e.cognome}`,e.email||"",e.telefono||"",e.imei||"",e.lead_id||null,i).run(),console.log("‚úÖ Assistito creato:",a),t.json({success:!0,message:"Assistito creato con successo",codice:a,assistito:{codice:a,nome:`${e.nome} ${e.cognome}`,email:e.email,telefono:e.telefono,imei:e.imei}})}catch(e){return console.error("‚ùå Errore creazione assistito:",e),t.json({success:!1,error:"Errore creazione assistito",details:e instanceof Error?e.message:String(e)},500)}});I.put("/api/assistiti/:id",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=t.req.param("id"),a=await t.req.json();if(!await t.env.DB.prepare("SELECT id FROM assistiti WHERE id = ?").bind(e).first())return t.json({success:!1,error:"Assistito non trovato"},404);let r=!1;try{await t.env.DB.prepare(`
        UPDATE assistiti 
        SET nome = ?, 
            nome_assistito = ?, 
            cognome_assistito = ?,
            nome_caregiver = ?,
            cognome_caregiver = ?,
            parentela_caregiver = ?,
            email = ?, 
            telefono = ?, 
            imei = ?,
            servizio = ?,
            piano = ?,
            lead_id = ?,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = ?
      `).bind(`${a.nome_assistito||""} ${a.cognome_assistito||""}`.trim()||a.nome||"N/A",a.nome_assistito||"",a.cognome_assistito||"",a.nome_caregiver||"",a.cognome_caregiver||"",a.parentela_caregiver||"",a.email||"",a.telefono||"",a.imei||"",a.servizio||"eCura PRO",a.piano||"BASE",a.lead_id||null,e).run(),r=!0,console.log(`‚úÖ Assistito aggiornato con servizio: ${a.servizio||"eCura PRO"}, piano: ${a.piano||"BASE"}`)}catch(s){if(s.message&&(s.message.includes("no column named piano")||s.message.includes("no column named servizio")))console.warn("‚ö†Ô∏è Colonne piano/servizio non trovate, provo UPDATE base"),await t.env.DB.prepare(`
          UPDATE assistiti 
          SET nome = ?, 
              nome_assistito = ?, 
              cognome_assistito = ?,
              nome_caregiver = ?,
              cognome_caregiver = ?,
              parentela_caregiver = ?,
              email = ?, 
              telefono = ?, 
              imei = ?,
              lead_id = ?,
              updated_at = CURRENT_TIMESTAMP
          WHERE id = ?
        `).bind(`${a.nome_assistito||""} ${a.cognome_assistito||""}`.trim()||a.nome||"N/A",a.nome_assistito||"",a.cognome_assistito||"",a.nome_caregiver||"",a.cognome_caregiver||"",a.parentela_caregiver||"",a.email||"",a.telefono||"",a.imei||"",a.lead_id||null,e).run(),r=!0,console.log("‚úÖ Assistito aggiornato (senza piano/servizio)");else throw s}return console.log("‚úÖ Assistito aggiornato:",e),t.json({success:!0,message:"Assistito aggiornato con successo"})}catch(e){return console.error("‚ùå Errore aggiornamento assistito:",e),t.json({success:!1,error:"Errore aggiornamento assistito",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/setup-email-counter",async t=>{var o;try{return(o=t.env)!=null&&o.DB?(console.log("üìä Setup email counter..."),await t.env.DB.prepare(`
      CREATE TABLE IF NOT EXISTS stats (
        id INTEGER PRIMARY KEY DEFAULT 1,
        emails_sent_30days INTEGER DEFAULT 0,
        last_reset_date TEXT DEFAULT (date('now')),
        updated_at TEXT DEFAULT (datetime('now'))
      )
    `).run(),await t.env.DB.prepare(`
      INSERT OR REPLACE INTO stats (id, emails_sent_30days, last_reset_date, updated_at)
      VALUES (1, 32, date('now'), datetime('now'))
    `).run(),console.log("‚úÖ Email counter creato con valore 32"),t.json({success:!0,message:"Email counter inizializzato",current_count:32})):t.json({success:!1,error:"Database non configurato"},500)}catch(e){return console.error("‚ùå Errore setup email counter:",e),t.json({success:!1,error:e.message},500)}});I.post("/api/migrate-schema",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üîÑ MIGRAZIONE SCHEMA DATABASE...");const e=[];try{await t.env.DB.prepare(`
        ALTER TABLE assistiti 
        ADD COLUMN servizio TEXT DEFAULT 'eCura PRO'
      `).run(),e.push("‚úÖ Colonna servizio aggiunta"),console.log("‚úÖ Colonna servizio aggiunta")}catch(i){i.message&&i.message.includes("duplicate column")?(e.push("‚ÑπÔ∏è Colonna servizio gi√† esiste"),console.log("‚ÑπÔ∏è Colonna servizio gi√† esiste")):e.push(`‚ö†Ô∏è Errore colonna servizio: ${i.message}`)}try{await t.env.DB.prepare(`
        ALTER TABLE assistiti 
        ADD COLUMN piano TEXT DEFAULT 'BASE'
      `).run(),e.push("‚úÖ Colonna piano aggiunta"),console.log("‚úÖ Colonna piano aggiunta")}catch(i){i.message&&i.message.includes("duplicate column")?(e.push("‚ÑπÔ∏è Colonna piano gi√† esiste"),console.log("‚ÑπÔ∏è Colonna piano gi√† esiste")):e.push(`‚ö†Ô∏è Errore colonna piano: ${i.message}`)}try{const i=await t.env.DB.prepare(`
        UPDATE assistiti 
        SET piano = 'AVANZATO', servizio = 'eCura PRO'
        WHERE (nome_assistito LIKE '%Eileen%' AND cognome_assistito LIKE '%King%')
           OR (nome_caregiver LIKE '%Elena%' AND cognome_caregiver LIKE '%Saglia%')
      `).run();i.changes&&i.changes>0?e.push(`‚úÖ Eileen aggiornata a AVANZATO (${i.changes} record)`):e.push("‚ÑπÔ∏è Eileen non trovata o gi√† aggiornata")}catch(i){e.push(`‚ö†Ô∏è Errore aggiornamento Eileen: ${i.message}`)}const a=[{name:"luogoNascitaAssistito",type:"TEXT",default:null},{name:"dataNascitaAssistito",type:"TEXT",default:null},{name:"indirizzoAssistito",type:"TEXT",default:null},{name:"capAssistito",type:"TEXT",default:null},{name:"cittaAssistito",type:"TEXT",default:null},{name:"provinciaAssistito",type:"TEXT",default:null},{name:"cfAssistito",type:"TEXT",default:null},{name:"condizioniSalute",type:"TEXT",default:null},{name:"intestatarioContratto",type:"TEXT",default:"'richiedente'"}];for(const i of a)try{const r=i.default?`DEFAULT ${i.default}`:"";await t.env.DB.prepare(`
          ALTER TABLE leads 
          ADD COLUMN ${i.name} ${i.type} ${r}
        `).run(),e.push(`‚úÖ Colonna ${i.name} aggiunta a leads`),console.log(`‚úÖ Colonna ${i.name} aggiunta a leads`)}catch(r){r.message&&r.message.includes("duplicate column")?(e.push(`‚ÑπÔ∏è Colonna ${i.name} gi√† esiste`),console.log(`‚ÑπÔ∏è Colonna ${i.name} gi√† esiste`)):e.push(`‚ö†Ô∏è Errore colonna ${i.name}: ${r.message}`)}return t.json({success:!0,message:"Migrazione schema completata",migrations:e})}catch(e){return console.error("‚ùå Errore migrazione schema:",e),t.json({success:!1,error:"Errore migrazione schema",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/assistiti/add-three",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);await t.env.DB.prepare(`
      DELETE FROM assistiti 
      WHERE nome IN ('Giovanni Locatelli', 'Claudio Macchi', 'Anna De Marco')
        AND (imei IS NULL OR imei = '')
    `).run(),console.log("‚úÖ Cleanup assistiti duplicati completato");const e=new Date().toISOString(),a=[],i=await t.env.DB.prepare(`
      SELECT id FROM leads 
      WHERE nomeRichiedente LIKE '%Alberto%' AND cognomeRichiedente LIKE '%Locatelli%' 
      LIMIT 1
    `).first();i?(await t.env.DB.prepare(`
        INSERT INTO assistiti (codice, nome, email, telefono, imei, status, lead_id, created_at)
        VALUES (?, ?, ?, ?, ?, 'ATTIVO', ?, ?)
      `).bind(`ASS-LOCATELLI-GIOVANNI-${Date.now()}`,"Giovanni Locatelli",null,null,null,i.id,e).run(),a.push({nome:"Giovanni Locatelli",lead:"Alberto Locatelli",lead_id:i.id})):a.push({nome:"Giovanni Locatelli",lead:"Alberto Locatelli",error:"Lead non trovato"}),await new Promise(l=>setTimeout(l,100));const r=await t.env.DB.prepare(`
      SELECT id FROM leads 
      WHERE nomeRichiedente LIKE '%Claudio%' AND cognomeRichiedente LIKE '%Macchi%' 
      LIMIT 1
    `).first();r?(await t.env.DB.prepare(`
        INSERT INTO assistiti (codice, nome, email, telefono, imei, status, lead_id, created_at)
        VALUES (?, ?, ?, ?, ?, 'ATTIVO', ?, ?)
      `).bind(`ASS-MACCHI-CLAUDIO-${Date.now()}`,"Claudio Macchi",null,null,null,r.id,e).run(),a.push({nome:"Claudio Macchi",lead:"Claudio Macchi",lead_id:r.id})):a.push({nome:"Claudio Macchi",lead:"Claudio Macchi",error:"Lead non trovato"}),await new Promise(l=>setTimeout(l,100));const s=await t.env.DB.prepare(`
      SELECT id FROM leads 
      WHERE nomeRichiedente LIKE '%Francesco%' AND cognomeRichiedente LIKE '%Pepe%' 
      LIMIT 1
    `).first();return s?(await t.env.DB.prepare(`
        INSERT INTO assistiti (codice, nome, email, telefono, imei, status, lead_id, created_at)
        VALUES (?, ?, ?, ?, ?, 'ATTIVO', ?, ?)
      `).bind(`ASS-DEMARCO-ANNA-${Date.now()}`,"Anna De Marco",null,null,null,s.id,e).run(),a.push({nome:"Anna De Marco",lead:"Francesco Pepe",lead_id:s.id})):a.push({nome:"Anna De Marco",lead:"Francesco Pepe",error:"Lead non trovato"}),console.log("‚úÖ 3 assistiti aggiunti con successo"),t.json({success:!0,message:"Aggiunti 3 assistiti",assistiti:a})}catch(e){return console.error("‚ùå Errore aggiunta assistiti:",e),t.json({success:!1,error:"Errore aggiunta assistiti",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/assistiti/update-three-with-data",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);try{await t.env.DB.prepare("SELECT servizio, piano FROM assistiti LIMIT 1").first()}catch{console.log("üîß Aggiunta colonne servizio e piano..."),await t.env.DB.prepare("ALTER TABLE assistiti ADD COLUMN servizio TEXT").run(),await t.env.DB.prepare("ALTER TABLE assistiti ADD COLUMN piano TEXT").run()}const e=[],a=await t.env.DB.prepare(`
      SELECT 
        id,
        emailRichiedente,
        telefonoRichiedente,
        nomeRichiedente,
        cognomeRichiedente
      FROM leads 
      WHERE nomeRichiedente LIKE '%Alberto%' AND cognomeRichiedente LIKE '%Locatelli%' 
      LIMIT 1
    `).first();a&&(await t.env.DB.prepare(`
        UPDATE assistiti 
        SET 
          email = ?,
          telefono = ?,
          imei = '862346607387161',
          servizio = 'eCura PREMIUM',
          piano = 'BASE'
        WHERE nome = 'Giovanni Locatelli'
      `).bind(a.emailRichiedente||null,a.telefonoRichiedente||null).run(),e.push({nome:"Giovanni Locatelli",email:a.emailRichiedente,telefono:a.telefonoRichiedente,imei:"862346607387161",servizio:"eCura PREMIUM",piano:"BASE",dispositivo:"SiDLY VITAL CARE"}));const i=await t.env.DB.prepare(`
      SELECT 
        id,
        emailRichiedente,
        telefonoRichiedente
      FROM leads 
      WHERE nomeRichiedente LIKE '%Claudio%' AND cognomeRichiedente LIKE '%Macchi%' 
      LIMIT 1
    `).first();i&&(await t.env.DB.prepare(`
        UPDATE assistiti 
        SET 
          email = ?,
          telefono = ?,
          imei = '862608061148517',
          servizio = 'eCura CARE PRO',
          piano = 'AVANZATO'
        WHERE nome = 'Claudio Macchi'
      `).bind(i.emailRichiedente||null,i.telefonoRichiedente||null).run(),e.push({nome:"Claudio Macchi",email:i.emailRichiedente,telefono:i.telefonoRichiedente,imei:"862608061148517",servizio:"eCura CARE PRO",piano:"AVANZATO",dispositivo:"SiDLY CARE PRO"}));const r=await t.env.DB.prepare(`
      SELECT 
        id,
        emailRichiedente,
        telefonoRichiedente
      FROM leads 
      WHERE nomeRichiedente LIKE '%Francesco%' AND cognomeRichiedente LIKE '%Pepe%' 
      LIMIT 1
    `).first();return r&&(await t.env.DB.prepare(`
        UPDATE assistiti 
        SET 
          email = ?,
          telefono = ?,
          imei = '862608066560916',
          servizio = 'eCura CARE PRO',
          piano = 'BASE'
        WHERE nome = 'Anna De Marco'
      `).bind(r.emailRichiedente||null,r.telefonoRichiedente||null).run(),e.push({nome:"Anna De Marco",email:r.emailRichiedente,telefono:r.telefonoRichiedente,imei:"862608066560916",servizio:"eCura CARE PRO",piano:"BASE",dispositivo:"SiDLY CARE PRO"})),console.log("‚úÖ 3 assistiti aggiornati con dati completi + servizio + piano"),t.json({success:!0,message:"Aggiornati 3 assistiti con dati completi, servizio e piano",updates:e})}catch(e){return console.error("‚ùå Errore aggiornamento assistiti:",e),t.json({success:!1,error:"Errore aggiornamento assistiti",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/assistiti/update-giovanni-full",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=["indirizzo","comune","data_nascita","codice_fiscale","sesso","peso","altezza","caregiver_nome","caregiver_telefono"];for(const a of e)try{await t.env.DB.prepare(`SELECT ${a} FROM assistiti LIMIT 1`).first()}catch{console.log(`üîß Aggiunta colonna ${a}...`),await t.env.DB.prepare(`ALTER TABLE assistiti ADD COLUMN ${a} TEXT`).run()}return await t.env.DB.prepare(`
      UPDATE assistiti 
      SET 
        telefono = ?,
        indirizzo = ?,
        comune = ?,
        data_nascita = ?,
        codice_fiscale = ?,
        sesso = ?,
        peso = ?,
        altezza = ?,
        caregiver_nome = ?,
        caregiver_telefono = ?
      WHERE nome = 'Giovanni Locatelli'
    `).bind("347 09 37 955","Viale Caterina da Forl√¨ 32","Milano","1942-04-24","LCTGN42D24F205H","M","73","1,75","Anna Locatelli (moglie), Alberto Locatelli (figlio), Andrea Locatelli (figlio)","348 34 02 668").run(),console.log("‚úÖ Giovanni Locatelli aggiornato con dati completi da Excel"),t.json({success:!0,message:"Giovanni Locatelli aggiornato con dati completi",data:{nome:"Giovanni Locatelli",telefono:"347 09 37 955",indirizzo:"Viale Caterina da Forl√¨ 32",comune:"Milano",data_nascita:"1942-04-24",codice_fiscale:"LCTGN42D24F205H",sesso:"M",peso:"73 kg",altezza:"1,75 m",caregiver:"Anna Locatelli (moglie), Alberto/Andrea (figli)",imei:"862346607387161",servizio:"eCura PREMIUM",piano:"BASE"}})}catch(e){return console.error("‚ùå Errore aggiornamento Giovanni:",e),t.json({success:!1,error:"Errore aggiornamento Giovanni",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/dispositivi/setup-table",async t=>{var o;try{return(o=t.env)!=null&&o.DB?(await t.env.DB.prepare(`
      CREATE TABLE IF NOT EXISTS dispositivi (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        serial_number TEXT UNIQUE NOT NULL,
        modello TEXT NOT NULL,
        status TEXT DEFAULT 'inventory',
        lead_id TEXT,
        assigned_at TEXT,
        activated_at TEXT,
        created_at TEXT NOT NULL,
        FOREIGN KEY (lead_id) REFERENCES leads(id)
      )
    `).run(),console.log("‚úÖ Tabella dispositivi creata"),t.json({success:!0,message:"Tabella dispositivi creata con successo"})):t.json({success:!1,error:"Database non configurato"},500)}catch(e){return console.error("‚ùå Errore creazione tabella dispositivi:",e),t.json({success:!1,error:"Errore creazione tabella",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/leads/test-notification",async t=>{try{const o=await t.req.json();console.log("üîç [TEST-NOTIFICATION] Inizio test notifica email..."),console.log("üîç [TEST-NOTIFICATION] Dati ricevuti:",JSON.stringify(o,null,2));const{sendNewLeadNotification:e}=await Promise.resolve().then(()=>jp);return await e(o.leadId||"TEST-LEAD-001",{nomeRichiedente:o.nomeRichiedente||"Test",cognomeRichiedente:o.cognomeRichiedente||"User",email:o.email,telefono:o.telefono,citta:o.citta,servizio:o.servizio||"eCura PRO",piano:o.piano||"BASE",fonte:o.fonte||"Test Debug",note:o.note,created_at:new Date().toISOString()},t.env),console.log("‚úÖ [TEST-NOTIFICATION] Test completato"),t.json({success:!0,message:"Notifica email test inviata",leadId:o.leadId,timestamp:new Date().toISOString()})}catch(o){return console.error("‚ùå [TEST-NOTIFICATION] Errore:",o),t.json({success:!1,error:"Errore test notifica",details:o instanceof Error?o.message:String(o),stack:o instanceof Error?o.stack:void 0},500)}});I.get("/api/dispositivi",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const{results:e}=await t.env.DB.prepare(`
      SELECT 
        d.id,
        d.serial_number as imei,
        d.modello as dispositivo,
        d.status,
        d.assigned_at,
        d.activated_at,
        d.created_at,
        l.nomeRichiedente || ' ' || l.cognomeRichiedente as assegnato_a
      FROM dispositivi d
      LEFT JOIN leads l ON d.lead_id = l.id
      ORDER BY d.created_at DESC
      LIMIT 100
    `).all();return t.json({success:!0,dispositivi:e,count:e.length})}catch(e){return console.error("‚ùå Errore fetch dispositivi:",e),t.json({success:!1,error:"Errore caricamento dispositivi",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/dispositivi",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=await t.req.json(),a=new Date().toISOString();return await t.env.DB.prepare(`
      INSERT INTO dispositivi (serial_number, modello, status, created_at)
      VALUES (?, ?, 'inventory', ?)
    `).bind(e.serial_number,e.modello||"SiDLY CARE PRO",a).run(),t.json({success:!0,message:"Dispositivo aggiunto al magazzino"})}catch(e){return console.error("‚ùå Errore aggiunta dispositivo:",e),t.json({success:!1,error:"Errore aggiunta dispositivo",details:e instanceof Error?e.message:String(e)},500)}});I.put("/api/dispositivi/:id/assign",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=t.req.param("id"),{lead_id:a}=await t.req.json(),i=new Date().toISOString();return await t.env.DB.prepare(`
      UPDATE dispositivi 
      SET 
        lead_id = ?,
        status = 'assigned',
        assigned_at = ?
      WHERE id = ?
    `).bind(a,i,e).run(),t.json({success:!0,message:"Dispositivo assegnato"})}catch(e){return console.error("‚ùå Errore assegnazione dispositivo:",e),t.json({success:!1,error:"Errore assegnazione dispositivo",details:e instanceof Error?e.message:String(e)},500)}});I.get("/api/magazzino",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const{results:e}=await t.env.DB.prepare(`
      SELECT 
        id,
        serial_number as imei,
        modello as dispositivo,
        status,
        created_at
      FROM dispositivi
      WHERE status = 'inventory'
      ORDER BY created_at DESC
    `).all();return t.json({success:!0,magazzino:e,disponibili:e.length})}catch(e){return console.error("‚ùå Errore fetch magazzino:",e),t.json({success:!1,error:"Errore caricamento magazzino",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/dispositivi/populate",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üì¶ Popolamento dispositivi da assistiti...");const e=[{imei:"862346607387161",modello:"SiDLY VITAL CARE",lead_id:"LEAD-IRBEMA-00142",status:"assigned"},{imei:"862608061148517",modello:"SiDLY CARE PRO",lead_id:"LEAD-IRBEMA-00001",status:"assigned"},{imei:"862608066560916",modello:"SiDLY CARE PRO",lead_id:"LEAD-IRBEMA-00097",status:"assigned"}],a=[];for(const i of e){if(await t.env.DB.prepare("SELECT id FROM dispositivi WHERE serial_number = ?").bind(i.imei).first()){console.log(`‚è≠Ô∏è  Dispositivo ${i.imei} gi√† esistente`);continue}const s=new Date().toISOString();await t.env.DB.prepare(`
        INSERT INTO dispositivi (serial_number, modello, status, lead_id, assigned_at, created_at)
        VALUES (?, ?, ?, ?, ?, ?)
      `).bind(i.imei,i.modello,i.status,i.lead_id,s,s).run(),a.push(i),console.log(`‚úÖ Inserito dispositivo ${i.imei} (${i.modello})`)}return t.json({success:!0,message:`Inseriti ${a.length} dispositivi`,dispositivi:a})}catch(e){return console.error("‚ùå Errore popolamento dispositivi:",e),t.json({success:!1,error:"Errore popolamento dispositivi",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/dispositivi/add-inventory",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const{imei:e,modello:a}=await t.req.json();if(!e||!a)return t.json({success:!1,error:"IMEI e modello richiesti"},400);if(await t.env.DB.prepare("SELECT id FROM dispositivi WHERE serial_number = ?").bind(e).first())return t.json({success:!1,error:"Dispositivo gi√† esistente"},400);const r=new Date().toISOString();return await t.env.DB.prepare(`
      INSERT INTO dispositivi (serial_number, modello, status, created_at)
      VALUES (?, ?, 'inventory', ?)
    `).bind(e,a,r).run(),console.log(`‚úÖ Aggiunto dispositivo in magazzino: ${e} (${a})`),t.json({success:!0,message:`Dispositivo ${e} aggiunto al magazzino`,dispositivo:{imei:e,modello:a,status:"inventory"}})}catch(e){return console.error("‚ùå Errore aggiunta dispositivo:",e),t.json({success:!1,error:"Errore aggiunta dispositivo",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/dispositivi/assign",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const{imei:e,lead_id:a}=await t.req.json();if(!e||!a)return t.json({success:!1,error:"IMEI e lead_id richiesti"},400);if(!await t.env.DB.prepare("SELECT id, status FROM dispositivi WHERE serial_number = ?").bind(e).first())return t.json({success:!1,error:"Dispositivo non trovato"},404);const r=await t.env.DB.prepare("SELECT id, nomeRichiedente, cognomeRichiedente FROM leads WHERE id = ?").bind(a).first();if(!r)return t.json({success:!1,error:"Lead non trovato"},404);const s=new Date().toISOString();return await t.env.DB.prepare(`
      UPDATE dispositivi 
      SET status = 'assigned',
          lead_id = ?,
          assigned_at = ?
      WHERE serial_number = ?
    `).bind(a,s,e).run(),console.log(`‚úÖ Dispositivo ${e} assegnato a ${r.nomeRichiedente} ${r.cognomeRichiedente}`),t.json({success:!0,message:`Dispositivo ${e} assegnato a ${r.nomeRichiedente} ${r.cognomeRichiedente}`,dispositivo:{imei:e,lead_id:a,lead_name:`${r.nomeRichiedente} ${r.cognomeRichiedente}`,status:"assigned",assigned_at:s}})}catch(e){return console.error("‚ùå Errore assegnazione dispositivo:",e),t.json({success:!1,error:"Errore assegnazione dispositivo",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/dispositivi/return",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const{imei:e,reason:a}=await t.req.json();if(!e)return t.json({success:!1,error:"IMEI richiesto"},400);const i=await t.env.DB.prepare("SELECT id, status, modello FROM dispositivi WHERE serial_number = ?").bind(e).first();if(!i)return t.json({success:!1,error:"Dispositivo non trovato"},404);const r=new Date().toISOString();return await t.env.DB.prepare(`
      UPDATE dispositivi 
      SET status = 'returned',
          lead_id = NULL,
          activated_at = NULL,
          updated_at = ?
      WHERE serial_number = ?
    `).bind(r,e).run(),console.log(`üì¶ Dispositivo ${e} marcato come restituito. Motivo: ${a||"Non specificato"}`),t.json({success:!0,message:`Dispositivo ${e} restituito`,dispositivo:{imei:e,modello:i.modello,status:"returned",reason:a||"Non specificato",returned_at:r}})}catch(e){return console.error("‚ùå Errore restituzione dispositivo:",e),t.json({success:!1,error:"Errore restituzione dispositivo",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/assistiti/debug-eileen",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üîç Debug Eileen Elisabeth King...");const e=await t.env.DB.prepare(`
      SELECT * 
      FROM assistiti 
      WHERE (nome_assistito LIKE '%Eileen%' OR cognome_assistito LIKE '%King%')
         OR (nome_caregiver LIKE '%Elena%' AND cognome_caregiver LIKE '%Saglia%')
      LIMIT 1
    `).first();if(!e)return t.json({success:!1,error:"Eileen non trovata"},404);let a=!1;try{await t.env.DB.prepare("SELECT piano FROM assistiti LIMIT 1").first(),a=!0}catch{a=!1}return t.json({success:!0,eileen:e,has_piano_column:a,note:a?`Piano attuale: ${e.piano||"NULL"}`:"Colonna piano non esiste - esegui /api/assistiti/add-piano-column"})}catch(e){return console.error("‚ùå Errore debug Eileen:",e),t.json({success:!1,error:"Errore debug Eileen",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/assistiti/add-piano-column",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üîß Aggiunta colonna piano alla tabella assistiti...");try{await t.env.DB.prepare(`
        ALTER TABLE assistiti 
        ADD COLUMN piano TEXT DEFAULT 'BASE'
      `).run(),console.log("‚úÖ Colonna piano aggiunta con successo");const e=await t.env.DB.prepare(`
        UPDATE assistiti 
        SET piano = 'AVANZATO'
        WHERE (nome_assistito LIKE '%Eileen%' OR cognome_assistito LIKE '%King%')
           OR (nome_caregiver LIKE '%Elena%' AND cognome_caregiver LIKE '%Saglia%')
      `).run();return t.json({success:!0,message:"Colonna piano aggiunta con successo",eileen_updated:e.changes||0})}catch(e){if(e.message&&e.message.includes("duplicate column"))return t.json({success:!0,message:"Colonna piano gi√† esistente",note:"Nessuna modifica necessaria"});throw e}}catch(e){return console.error("‚ùå Errore aggiunta colonna piano:",e),t.json({success:!1,error:"Errore aggiunta colonna piano",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/assistiti/fix-eileen",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("üîß Correzione piano Eileen Elisabeth King...");const e=await t.env.DB.prepare(`
      SELECT id, nome_assistito, cognome_assistito, piano 
      FROM assistiti 
      WHERE (nome_assistito LIKE '%Eileen%' OR cognome_assistito LIKE '%King%')
         OR (nome_caregiver LIKE '%Elena%' AND cognome_caregiver LIKE '%Saglia%')
    `).all();if(!e.results||e.results.length===0)return t.json({success:!1,error:"Eileen non trovata"},404);const a=e.results[0];return console.log(`Found: ${a.nome_assistito} ${a.cognome_assistito}, Piano attuale: ${a.piano}`),await t.env.DB.prepare(`
      UPDATE assistiti 
      SET piano = 'AVANZATO',
          updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(a.id).run(),console.log(`‚úÖ Piano aggiornato: ${a.id} -> AVANZATO`),t.json({success:!0,message:"Piano Eileen aggiornato a AVANZATO",assistito:{id:a.id,nome:`${a.nome_assistito} ${a.cognome_assistito}`,piano_precedente:a.piano,piano_nuovo:"AVANZATO"}})}catch(e){return console.error("‚ùå Errore fix Eileen:",e),t.json({success:!1,error:"Errore fix Eileen",details:e instanceof Error?e.message:String(e)},500)}});I.delete("/api/assistiti/:id",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=t.req.param("id");if(!await t.env.DB.prepare("SELECT id, nome FROM assistiti WHERE id = ?").bind(e).first())return t.json({success:!1,error:"Assistito non trovato"},404);const i=await t.env.DB.prepare("SELECT COUNT(*) as count FROM contracts WHERE imei_dispositivo = (SELECT imei FROM assistiti WHERE id = ?)").bind(e).first();return i&&i.count>0?t.json({success:!1,error:"Impossibile eliminare: assistito ha contratti associati",hasContracts:!0},400):(await t.env.DB.prepare(`
      UPDATE assistiti 
      SET status = 'ELIMINATO'
      WHERE id = ?
    `).bind(e).run(),console.log("‚úÖ Assistito eliminato (soft):",e),t.json({success:!0,message:"Assistito eliminato con successo"}))}catch(e){return console.error("‚ùå Errore eliminazione assistito:",e),t.json({success:!1,error:"Errore eliminazione assistito",details:e instanceof Error?e.message:String(e)},500)}});I.get("/api/assistiti/debug-schema",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=await t.env.DB.prepare("SELECT * FROM assistiti LIMIT 1").first(),a=await t.env.DB.prepare("SELECT * FROM assistiti WHERE nome_assistito LIKE '%Eileen%' OR cognome_assistito LIKE '%King%' LIMIT 1").first(),i=await t.env.DB.prepare("SELECT COUNT(*) as count FROM assistiti").first();return t.json({success:!0,schema:{columns:e?Object.keys(e):[],hasServizioColumn:e&&"servizio"in e,hasPianoColumn:e&&"piano"in e},eileen:a||null,totalAssistiti:(i==null?void 0:i.count)||0,sampleRow:e})}catch(e){return t.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.post("/api/assistiti/force-fix-eileen",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=[],a=await t.env.DB.prepare("SELECT * FROM assistiti LIMIT 1").first(),i=a&&"servizio"in a,r=a&&"piano"in a;if(e.push({step:1,name:"Verifica colonne",hasServizio:i,hasPiano:r,columns:a?Object.keys(a):[]}),i)e.push({step:2,name:"Colonna servizio",status:"‚ÑπÔ∏è Gi√† esiste"});else try{await t.env.DB.prepare("ALTER TABLE assistiti ADD COLUMN servizio TEXT DEFAULT 'eCura PRO'").run(),e.push({step:2,name:"Colonna servizio",status:"‚úÖ Aggiunta"})}catch(c){e.push({step:2,name:"Colonna servizio",status:`‚ùå ${c.message}`})}if(r)e.push({step:3,name:"Colonna piano",status:"‚ÑπÔ∏è Gi√† esiste"});else try{await t.env.DB.prepare("ALTER TABLE assistiti ADD COLUMN piano TEXT DEFAULT 'BASE'").run(),e.push({step:3,name:"Colonna piano",status:"‚úÖ Aggiunta"})}catch(c){e.push({step:3,name:"Colonna piano",status:`‚ùå ${c.message}`})}const s=await t.env.DB.prepare(`
      SELECT id, nome_assistito, cognome_assistito, nome_caregiver, cognome_caregiver, servizio, piano
      FROM assistiti 
      WHERE (nome_assistito LIKE '%Eileen%' OR cognome_assistito LIKE '%King%')
         OR (nome_caregiver LIKE '%Elena%' OR cognome_caregiver LIKE '%Saglia%')
      LIMIT 1
    `).first();if(!s)return e.push({step:4,name:"Cerca Eileen",status:"‚ùå NON TROVATA"}),t.json({success:!1,error:"Eileen non trovata",steps:e});e.push({step:4,name:"Cerca Eileen",status:"‚úÖ TROVATA",eileen:{id:s.id,nome:s.nome_assistito,cognome:s.cognome_assistito,caregiver:`${s.nome_caregiver} ${s.cognome_caregiver}`,servizio_attuale:s.servizio||"NULL",piano_attuale:s.piano||"NULL"}});const l=await t.env.DB.prepare(`
      UPDATE assistiti 
      SET servizio = 'eCura PRO', piano = 'AVANZATO'
      WHERE id = ?
    `).bind(s.id).run();e.push({step:5,name:"Aggiorna Eileen",status:l.changes&&l.changes>0?"‚úÖ AGGIORNATA":"‚ùå FALLITO",changes:l.changes||0});const d=await t.env.DB.prepare(`
      SELECT id, nome_assistito, cognome_assistito, servizio, piano
      FROM assistiti 
      WHERE id = ?
    `).bind(s.id).first();return e.push({step:6,name:"Verifica finale",eileen_dopo:{servizio:d==null?void 0:d.servizio,piano:d==null?void 0:d.piano},success:(d==null?void 0:d.servizio)==="eCura PRO"&&(d==null?void 0:d.piano)==="AVANZATO"}),t.json({success:!0,message:"Fix Eileen completato",steps:e,eileen_before:s,eileen_after:d})}catch(e){return t.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.get("/api/data/stats",async t=>{var o;try{console.log("üìä [STATS] Inizio calcolo statistiche..."),console.log("üìä [STATS] Env keys:",Object.keys(t.env||{})),console.log("üìä [STATS] c.env.DB:",!!((o=t.env)!=null&&o.DB));const e=t.env.DB;console.log("‚úÖ [STATS] DB reference obtained, procedo con le query");const a=new Date;a.setUTCHours(0,0,0,0);const i=a.toISOString();console.log("üìä [STATS] Data oggi (UTC 00:00):",i);const r=await e.prepare("SELECT COUNT(*) as count FROM leads WHERE created_at >= ?").bind(i).first();console.log("üìä [STATS] Lead oggi result:",r);const s=await e.prepare("SELECT COUNT(*) as count FROM contracts WHERE created_at >= ?").bind(i).first(),l=await e.prepare('SELECT COUNT(*) as count FROM contracts WHERE created_at >= ? AND status IN ("DRAFT", "PENDING")').bind(i).first(),d=await e.prepare('SELECT COUNT(*) as count FROM contracts WHERE created_at >= ? AND status IN ("PAID", "PAGATO")').bind(i).first(),c=await e.prepare('SELECT COUNT(*) as count FROM leads WHERE created_at >= ? AND status IN ("CONFIG", "IN_CONFIGURAZIONE")').bind(i).first(),u=await e.prepare('SELECT COUNT(*) as count FROM leads WHERE created_at >= ? AND status IN ("ACTIVE", "ATTIVO")').bind(i).first(),p=new Date;p.setDate(p.getDate()-30),p.setUTCHours(0,0,0,0);const g=p.toISOString();console.log("üìä [STATS] Data 30 giorni fa:",g);const m=await e.prepare("SELECT COUNT(*) as count FROM leads").first();console.log("üìä [STATS] Total leads:",m==null?void 0:m.count),console.log("üìä [STATS] Lettura contatore email...");const b=await e.prepare(`
      SELECT emails_sent_30days, last_reset_date FROM stats WHERE id = 1
    `).first();let h=0;b?(h=b.emails_sent_30days||0,console.log("üìä [STATS] Email count dal DB:",h),console.log("üìä [STATS] Last reset:",b.last_reset_date)):console.warn("‚ö†Ô∏è  [STATS] Contatore email non trovato - usa 0"),console.log("üìä [STATS] emailsMonth finale:",h);const E=await e.prepare(`
      SELECT servizio, COUNT(*) as count 
      FROM leads 
      WHERE created_at >= ? AND servizio IS NOT NULL
      GROUP BY servizio 
      ORDER BY count DESC 
      LIMIT 1
    `).bind(g).first();return console.log("üìä Stats Oggi:",{leadsToday:r==null?void 0:r.count,totalLeads:m==null?void 0:m.count,contractsToday:s==null?void 0:s.count,proformaToday:l==null?void 0:l.count,paymentsToday:d==null?void 0:d.count,configurationsToday:c==null?void 0:c.count,activationsToday:u==null?void 0:u.count,emailsMonth:h,topService:E==null?void 0:E.servizio}),t.json({success:!0,totalLeads:(m==null?void 0:m.count)||0,leadsToday:(r==null?void 0:r.count)||0,contractsToday:(s==null?void 0:s.count)||0,proformaToday:(l==null?void 0:l.count)||0,paymentsToday:(d==null?void 0:d.count)||0,configurationsToday:(c==null?void 0:c.count)||0,activationsToday:(u==null?void 0:u.count)||0,emailsMonth:h||0,topService:(E==null?void 0:E.servizio)||"N/A",timestamp:new Date().toISOString()})}catch(e){return console.error("‚ùå Errore statistiche data dashboard:",e),console.error("Error details:",e instanceof Error?e.message:String(e)),console.error("Error stack:",e instanceof Error?e.stack:"no stack"),t.json({success:!0,totalLeads:0,leadsToday:0,contractsToday:0,proformaToday:0,paymentsToday:0,configurationsToday:0,activationsToday:0,emailsMonth:0,topService:"N/A",timestamp:new Date().toISOString(),fallback:!0,error:e instanceof Error?e.message:String(e),errorStack:e instanceof Error?e.stack:void 0})}});I.get("/api/logs",async t=>{var o;try{const e=t.req.query("level")||"all";if(!((o=t.env)!=null&&o.DB)){const r=[{id:1,timestamp:new Date().toISOString(),level:"info",message:"Sistema TeleMedCare avviato correttamente"},{id:2,timestamp:new Date(Date.now()-3e5).toISOString(),level:"info",message:"Nuovo lead registrato: Mario Rossi"},{id:3,timestamp:new Date(Date.now()-6e5).toISOString(),level:"warn",message:"Dispositivo SiDLY-001 batteria bassa"},{id:4,timestamp:new Date(Date.now()-9e5).toISOString(),level:"error",message:"Tentativo di connessione fallito per assistito ASS-2024-005"}],s=e==="all"?r:r.filter(l=>l.level===e);return t.json({success:!0,count:s.length,logs:s})}let a="SELECT * FROM system_logs ORDER BY timestamp DESC LIMIT 100";e!=="all"&&(a="SELECT * FROM system_logs WHERE level = ? ORDER BY timestamp DESC LIMIT 100");const i=e==="all"?await t.env.DB.prepare(a).all():await t.env.DB.prepare(a).bind(e).all();return t.json({success:!0,count:i.results.length,logs:i.results})}catch(e){return console.error("‚ùå Errore recupero logs:",e),t.json({success:!1,error:"Errore recupero logs"},500)}});I.post("/api/test/functional/run",async t=>{var o;try{const{testType:e}=await t.req.json(),a=`LEAD-TEST-${Date.now()}`,i=`ASS-TEST-${Date.now()}`;return await new Promise(r=>setTimeout(r,500)),(o=t.env)!=null&&o.DB?t.json({success:!1,error:"Database test not implemented yet"}):(console.log(`‚úÖ [TEST] Test funzionale completato: ${a} ‚Üí ${i}`),t.json({success:!0,testType:e,leadId:a,assistitoId:i,steps:[{step:"lead_creation",status:"success",duration:"120ms"},{step:"email_sequence",status:"success",duration:"340ms"},{step:"lead_conversion",status:"success",duration:"89ms"},{step:"workflow_execution",status:"success",duration:"156ms"},{step:"contract_generation",status:"success",duration:"234ms"},{step:"device_configuration",status:"success",duration:"78ms"}],totalDuration:"1.017s",timestamp:new Date().toISOString()}))}catch(e){return console.error("‚ùå Errore test funzionale:",e),t.json({success:!1,error:"Test funzionale fallito",details:e.message},500)}});I.post("/api/test/complete-workflow",async t=>{try{const{partner:o="IRBEMA",cycles:e=1,enableEmails:a=!1}=await t.req.json(),i=[];for(let c=0;c<e;c++){const u=Date.now(),p=`TEST360-${o}-${Date.now()}-${c}`;console.log(`üîÑ [TEST 360¬∞] Ciclo ${c+1}/${e} - Partner: ${o}`);try{const g={partner:o,nomeRichiedente:`Test User ${c+1}`,email:`test.user.${c+1}@example.com`,telefono:`+39 345 ${String(Math.floor(Math.random()*9999999)).padStart(7,"0")}`,eta:Math.floor(Math.random()*40)+25,patologia:o==="IRBEMA"?"Cardiologia":o==="Luxottica"?"Oftalmologia":"Generale",provincia:["Milano","Roma","Torino","Napoli"][Math.floor(Math.random()*4)],gdprConsent:!0,consensoMarketing:!0};if(await new Promise(R=>setTimeout(R,Math.random()*200+100)),a){const R=["NOTIFICA_INFO","DOCUMENTI_INFORMATIVI","RICHIESTA_CONFERMA","INVIO_CONTRATTO"];for(const z of R)await new Promise(D=>setTimeout(D,Math.random()*100+50)),console.log(`  üìß Email inviata: ${z}`)}const m={...g,tipoServizio:"TeleAssistenza Base",dataAttivazione:new Date().toISOString().split("T")[0],status:"ATTIVO"};await new Promise(R=>setTimeout(R,Math.random()*150+75));const b={tipo_contratto:"Base",prezzo_primo_anno:480,prezzo_rinnovo:240,durata_contratto:12,data_firma:new Date().toISOString()};await new Promise(R=>setTimeout(R,Math.random()*300+150)),console.log("  üìÑ Contratto generato e firmato digitalmente");const h={numero_proforma:`PRO-${Date.now()}-${c}`,importo:b.prezzo_primo_anno,metodo_pagamento:"Stripe",status:"PAGATO"};await new Promise(R=>setTimeout(R,Math.random()*200+100)),console.log(`  üí≥ Proforma generata e pagamento processato: ‚Ç¨${h.importo}`);const E={device_id:`SiDLY${String(Math.floor(Math.random()*999)+1).padStart(3,"0")}`,imei:`86012345678${String(Math.floor(Math.random()*99999)).padStart(5,"0")}`,model:"SiDLY Care Pro V12",status:"ASSIGNED"};await new Promise(R=>setTimeout(R,Math.random()*100+50)),console.log(`  üì± Dispositivo assegnato: ${E.device_id}`),a&&(await new Promise(R=>setTimeout(R,Math.random()*100+50)),console.log("  ‚úÖ Email attivazione servizio inviata"));const S=Date.now()-u,C={cycle:c+1,partner:o,batchId:p,success:!0,duration:`${S}ms`,steps:{lead_generation:"SUCCESS",email_sequence:a?"SUCCESS":"SKIPPED",lead_conversion:"SUCCESS",contract_signature:"SUCCESS",proforma_payment:"SUCCESS",device_assignment:"SUCCESS",service_activation:"SUCCESS"},data:{leadData:g,assistitoData:m,contractData:b,proformaData:h,deviceData:E},timestamp:new Date().toISOString()};i.push(C),console.log(`‚úÖ [TEST 360¬∞] Ciclo ${c+1} completato con successo in ${S}ms`)}catch(g){console.error(`‚ùå [TEST 360¬∞] Errore nel ciclo ${c+1}:`,g),i.push({cycle:c+1,partner:o,batchId:p,success:!1,error:g.message,timestamp:new Date().toISOString()})}}const r=i.filter(c=>c.success).length,s=i.filter(c=>!c.success).length,l=i.reduce((c,u)=>c+(parseInt(u.duration)||0),0),d=Math.round(l/e);return console.log(`üéØ [TEST 360¬∞] COMPLETATO - ${r}/${e} successi`),t.json({success:!0,summary:{partner:o,totalCycles:e,successfulCycles:r,failedCycles:s,successRate:`${(r/e*100).toFixed(1)}%`,totalDuration:`${l}ms`,avgDuration:`${d}ms`,emailsEnabled:a},results:i,timestamp:new Date().toISOString()})}catch(o){return console.error("‚ùå [TEST 360¬∞] Errore generale:",o),t.json({success:!1,error:"Test workflow 360¬∞ fallito",details:o.message},500)}});I.post("/api/test/all-partners-workflow",async t=>{try{const{cyclesPerPartner:o=5,enableEmails:e=!1}=await t.req.json(),a=["IRBEMA","Luxottica","Pirelli","FAS"],i=[];console.log(`üöÄ [MULTI-PARTNER TEST] Inizio test con ${a.length} partner, ${o} cicli ciascuno`);for(const c of a){console.log(`üîÑ [MULTI-PARTNER TEST] Testing partner: ${c}`);const p=await(await fetch("http://localhost:3000/api/test/complete-workflow",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({partner:c,cycles:o,enableEmails:e})})).json();i.push({partner:c,...p})}const r=a.length*o,s=i.reduce((c,u)=>{var p;return c+(((p=u.summary)==null?void 0:p.successfulCycles)||0)},0),l=i.reduce((c,u)=>{var p;return c+(((p=u.summary)==null?void 0:p.failedCycles)||0)},0),d=(s/r*100).toFixed(1);return console.log(`üéØ [MULTI-PARTNER TEST] COMPLETATO - ${s}/${r} successi globali (${d}%)`),t.json({success:!0,globalSummary:{partnersGestioned:a.length,cyclesPerPartner:o,totalCycles:r,totalSuccessful:s,totalFailed:l,overallSuccessRate:`${d}%`,emailsEnabled:e},partnerResults:i,timestamp:new Date().toISOString()})}catch(o){return console.error("‚ùå [MULTI-PARTNER TEST] Errore:",o),t.json({success:!1,error:"Test multi-partner fallito",details:o.message},500)}});I.post("/api/test/stress/create-assistito",async t=>{var o;try{const{batchId:e,index:a,total:i}=await t.req.json(),r=`STRESS-${e}-${String(a).padStart(3,"0")}`,s=Math.random()*200+50;if(await new Promise(l=>setTimeout(l,s)),Math.random()<.05)throw new Error("Random failure simulation");return(o=t.env)!=null&&o.DB?t.json({success:!1,error:"Database stress test not implemented yet"}):(console.log(`‚úÖ [STRESS] Assistito creato: ${r} (${a}/${i})`),t.json({success:!0,assistitoCode:r,batchId:e,index:a,total:i,latency:Math.round(s),timestamp:new Date().toISOString()}))}catch(e){return console.error(`‚ùå Errore stress test assistito ${index}:`,e.message),t.json({success:!1,error:"Creazione assistito fallita",details:e.message},500)}});I.get("/api/test/stress/stats",async t=>{try{return t.json({success:!0,stats:{totalRuns:15,averageSuccessRate:94.2,lastRun:{timestamp:new Date(Date.now()-3e5).toISOString(),assistitiCreated:47,assistitiRequested:50,successRate:94,averageLatency:127},performance:{memoryUsage:"45.2MB",cpuUsage:"23%",responseTime:"89ms"}}})}catch(o){return console.error("‚ùå Errore stats stress test:",o),t.json({success:!1,error:"Errore recupero statistiche"},500)}});I.get("/api/warehouse/inventory",async t=>{try{const o=[{id:1,codice:"SiDLY-001",lotto:"LOT-2024-A001",scadenza:"2025-12-31",stock:25,minStock:10,status:"disponibile",location:"A-01-03"},{id:2,codice:"SiDLY-002",lotto:"LOT-2024-A002",scadenza:"2025-11-15",stock:8,minStock:10,status:"stock_basso",location:"A-01-04"},{id:3,codice:"CARD-001",lotto:"LOT-2024-B001",scadenza:"2026-03-20",stock:50,minStock:20,status:"disponibile",location:"B-02-01"}];return t.json({success:!0,inventory:o,totalItems:o.length})}catch{return t.json({success:!1,error:"Errore inventario"},500)}});I.get("/api/warehouse/assets",async t=>{try{const o=[{id:1,assetCode:"AST-2024-001",dispositivo:"SiDLY-001",assignedTo:"Mario Rossi",dataAssegnazione:"2024-10-01",status:"attivo",location:"Domicilio paziente",maintenanceDate:"2024-12-15"}];return t.json({success:!0,assets:o,totalAssets:o.length})}catch{return t.json({success:!1,error:"Errore assets"},500)}});I.post("/api/devices/scan-extended",async t=>{try{const{imageData:o,scanType:e,captureMethod:a}=await t.req.json(),i={success:!0,deviceCode:"SiDLY-"+Math.random().toString().substr(2,6),imei:CT(),serialNumber:"SN"+Math.random().toString().substr(2,10),lotto:"LOT-2024-"+Math.random().toString(36).substr(2,6).toUpperCase(),dataProduction:"2024-08-15",scadenza:"2025-12-31",manufacturer:"TeleMedCare Industries",model:"SiDLY Gen-2",firmwareVersion:"V2.1.3",hardwareRevision:"Rev-C",certifications:["CE","FDA","ISO13485","IEC62304"],classeMedica:"Classe IIa",marcaturaCE:"0297",udiCode:"UDI-"+Math.random().toString().substr(2,12).toUpperCase(),gtin:"8012345"+Math.random().toString().substr(2,6),captureMethod:a||"manual",imageUrl:`/storage/scans/scan-${Date.now()}.jpg`,confidence:.95,timestamp:new Date().toISOString(),scannedBy:"System",location:"Warehouse-A"};return t.json(i)}catch{return t.json({success:!1,error:"Errore scanning esteso"},500)}});I.post("/api/devices/capture-photo",async t=>{try{const{imageBlob:o,deviceInfo:e}=await t.req.json(),a=`photo-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,i=`/storage/device-photos/${a}.jpg`;return t.json({success:!0,photoId:a,photoUrl:i,deviceInfo:e,timestamp:new Date().toISOString(),message:"Foto acquisita con successo"})}catch{return t.json({success:!1,error:"Errore acquisizione foto"},500)}});function CT(){let t="86"+Math.random().toString().substr(2,12),o=0;for(let e=0;e<14;e++){let a=parseInt(t[e]);e%2===1&&(a*=2,a>9&&(a=Math.floor(a/10)+a%10)),o+=a}return t+(10-o%10)%10}I.post("/api/email/preview/:templateId",async t=>{try{const o=t.req.param("templateId"),{variables:e}=await t.req.json(),i={invio_contratto:{subject:"üìã TeleMedCare - Il tuo contratto √® pronto!",html:`
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <div style="background: #3B82F6; color: white; padding: 20px; text-align: center;">
              <h1>TeleMedCare</h1>
              <h2>Il tuo contratto √® pronto!</h2>
            </div>
            <div style="padding: 20px;">
              <p>Gentile <strong>${e.NOME_CLIENTE||"Cliente"}</strong>,</p>
              <p>Il tuo contratto per il piano <strong>${e.PIANO_SERVIZIO||"SiDLY Care Pro"}</strong> √® stato generato e firmato digitalmente.</p>
              <div style="background: #F3F4F6; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <p><strong>Piano:</strong> ${e.PIANO_SERVIZIO||"SiDLY Care Pro"}</p>
                <p><strong>Prezzo:</strong> ${e.PREZZO_PIANO||"‚Ç¨299,00"}</p>
                <p><strong>Codice Cliente:</strong> ${e.CODICE_CLIENTE||"TMC-2024-001"}</p>
              </div>
              <p>Troverai il contratto in allegato. Per qualsiasi domanda, contattaci.</p>
              <p>Cordiali saluti,<br><strong>Team TeleMedCare</strong></p>
            </div>
          </div>
        `},invio_proforma:{subject:`üí∞ TeleMedCare - Fattura Proforma per ${e.PIANO_SERVIZIO||"SiDLY Care Pro"}`,html:`
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <div style="background: #F59E0B; color: white; padding: 20px; text-align: center;">
              <h1>TeleMedCare</h1>
              <h2>Fattura Proforma</h2>
            </div>
            <div style="padding: 20px;">
              <p>Gentile <strong>${e.NOME_CLIENTE||"Cliente"}</strong>,</p>
              <p>Abbiamo preparato la fattura proforma per il tuo piano TeleMedCare.</p>
              <div style="background: #FEF3C7; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <p><strong>Importo:</strong> ${e.IMPORTO_TOTALE||"‚Ç¨299,00"}</p>
                <p><strong>Scadenza Pagamento:</strong> ${e.SCADENZA_PAGAMENTO||"2024-11-15"}</p>
                <p><strong>Codice Cliente:</strong> ${e.CODICE_CLIENTE||"TMC-2024-001"}</p>
              </div>
              <p>Procedi con il pagamento per attivare il servizio.</p>
              <p>Cordiali saluti,<br><strong>Team TeleMedCare</strong></p>
            </div>
          </div>
        `}}[o];return i?t.json({success:!0,preview:{renderedSubject:i.subject,renderedContent:i.html,recipientEmail:e.emailCliente||"test@telemedcare.it",estimatedSize:"~15KB"}}):t.json({success:!1,error:"Template non trovato"},404)}catch{return t.json({success:!1,error:"Errore preview template"},500)}});I.post("/api/contract/preview/:contractType",async t=>{try{const o=t.req.param("contractType"),{clientData:e}=await t.req.json(),a=`
      <div style="font-family: Arial, sans-serif; padding: 40px;">
        <div style="text-align: center; border-bottom: 2px solid #3B82F6; padding-bottom: 20px;">
          <h1>CONTRATTO TELEMEDCARE</h1>
          <h2>${o.toUpperCase()}</h2>
        </div>
        
        <div style="margin: 30px 0;">
          <h3>DATI CLIENTE</h3>
          <p><strong>Nome:</strong> ${e.nome||"Mario Rossi"}</p>
          <p><strong>Email:</strong> ${e.email||"mario.rossi@example.com"}</p>
          <p><strong>Piano:</strong> ${e.piano||"SiDLY Care Pro"}</p>
          <p><strong>Prezzo:</strong> ${e.prezzo||"‚Ç¨299,00"}</p>
        </div>
        
        <div style="margin: 30px 0;">
          <h3>CONDIZIONI DI SERVIZIO</h3>
          <p>Il presente contratto disciplina l'erogazione dei servizi di telemedicina...</p>
        </div>
        
        <div style="margin: 30px 0; text-align: center;">
          <p>Generato il: ${new Date().toLocaleDateString("it-IT")}</p>
          <p><strong>TeleMedCare V12.0 Enterprise</strong></p>
        </div>
      </div>
    `;return t.json({success:!0,preview:a,pdfUrl:`/api/contract/download/${o}/${Date.now()}`,contractType:o})}catch{return t.json({success:!1,error:"Errore preview contratto"},500)}});I.post("/api/email/preview",async t=>{try{const{templateId:o,variables:e}=await t.req.json(),i={INVIO_CONTRATTO:`
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: white;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #2563eb; margin: 0;">TeleMedCare</h1>
            <p style="color: #6b7280; margin: 5px 0;">Sistema di Telemedicina Avanzato</p>
          </div>
          
          <h2 style="color: #1f2937;">üìã Il tuo contratto √® pronto!</h2>
          
          <p>Gentile <strong>${e.NOME_CLIENTE||"{{NOME_CLIENTE}}"}</strong>,</p>
          
          <p>Siamo lieti di informarti che il contratto per il servizio <strong>${e.PIANO_SERVIZIO||"{{PIANO_SERVIZIO}}"}</strong> √® stato preparato e ti √® stato inviato per la firma elettronica.</p>
          
          <div style="background: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h3 style="margin-top: 0; color: #374151;">Dettagli Contratto:</h3>
            <ul style="margin: 0; padding-left: 20px;">
              <li><strong>Piano:</strong> ${e.PIANO_SERVIZIO||"{{PIANO_SERVIZIO}}"}</li>
              <li><strong>Prezzo:</strong> ${e.PREZZO_PIANO||"{{PREZZO_PIANO}}"}</li>
              <li><strong>Codice Cliente:</strong> ${e.CODICE_CLIENTE||"{{CODICE_CLIENTE}}"}</li>
            </ul>
          </div>
          
          <p>Per procedere con l'attivazione del servizio, ti preghiamo di:</p>
          <ol>
            <li>Scaricare il contratto allegato</li>
            <li>Leggere attentamente tutti i termini</li>
            <li>Firmare digitalmente il documento</li>
            <li>Restituirci il contratto firmato</li>
          </ol>
          
          <div style="text-align: center; margin: 30px 0;">
            <a href="#" style="background: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px;">Scarica Contratto</a>
          </div>
          
          <p style="font-size: 14px; color: #6b7280; border-top: 1px solid #e5e7eb; padding-top: 20px; margin-top: 30px;">
            Grazie per aver scelto TeleMedCare.<br>
            Per assistenza: support@telemedcare.it | +39 800 123 456
          </p>
        </div>
      `,INVIO_BROCHURE:`
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: white;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #2563eb; margin: 0;">eCura</h1>
            <p style="color: #6b7280; margin: 5px 0;">La tecnologia che Le salva salute e vita</p>
            <div style="font-size: 14px; color: #64748b;">
              <strong>Medica GB S.r.l.</strong> - Startup Innovativa a Vocazione Sociale
            </div>
          </div>
          
          <h2 style="color: #1f2937;">üìö Ecco la documentazione richiesta</h2>
          
          <p>Gentile <strong>${e.NOME_CLIENTE||"{{NOME_CLIENTE}}"}</strong>,</p>
          
          <p>Grazie per l'interesse mostrato verso i nostri servizi <strong>eCura ${e.SERVIZIO||"PRO"}</strong>. Come richiesto, Le inviamo la documentazione informativa completa.</p>
          
          <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #2563eb;">
            <h3 style="margin-top: 0; color: #1e40af;">üìã Riepilogo della Sua richiesta</h3>
            <ul style="margin: 0; padding-left: 20px;">
              <li><strong>Codice pratica:</strong> ${e.LEAD_ID||"{{LEAD_ID}}"}</li>
              <li><strong>Servizio:</strong> eCura ${e.SERVIZIO||"PRO"}</li>
              <li><strong>Piano:</strong> ${e.PIANO||"BASE"}</li>
              <li><strong>Assistito:</strong> ${e.NOME_ASSISTITO||"{{NOME_ASSISTITO}}"} ${e.COGNOME_ASSISTITO||"{{COGNOME_ASSISTITO}}"}</li>
            </ul>
          </div>
          
          <div style="background: #ecfdf5; padding: 20px; border-radius: 8px; margin: 20px 0; border: 2px solid #10b981;">
            <h3 style="margin-top: 0; color: #047857;">üìÑ Documentazione Allegata</h3>
            <ul style="margin: 10px 0; padding-left: 20px;">
              <li><strong>Brochure eCura ${e.SERVIZIO||"PRO"}</strong> - Panoramica completa del servizio</li>
              <li><strong>Scheda Tecnica Dispositivo</strong> - Caratteristiche e certificazioni</li>
              <li><strong>Listino Prezzi</strong> - Dettaglio costi e piani disponibili</li>
            </ul>
          </div>
          
          <div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h3 style="margin-top: 0; color: #92400e;">üí∞ Vantaggi Economici e Fiscali</h3>
            <ul style="margin: 10px 0; padding-left: 20px;">
              <li><strong>‚úÖ Detrazione Fiscale 19%</strong> - Servizio detraibile come spesa sanitaria</li>
              <li><strong>‚úÖ Possibili Rimborsi INPS</strong> - Per ISEE sotto ‚Ç¨6.000 + Legge 104</li>
            </ul>
          </div>
          
          <p>Il nostro servizio √® pensato per garantire sicurezza, tranquillit√† e assistenza continua. Siamo a disposizione per qualsiasi chiarimento.</p>
          
          <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #e2e8f0;">
            <h3 style="margin-top: 0; color: #475569;">üìû Contatti</h3>
            <p style="margin: 5px 0;"><strong>E-MAIL:</strong> <a href="mailto:info@medicagb.it" style="color: #2563eb;">info@medicagb.it</a></p>
            <p style="margin: 5px 0;"><strong>Telefono commerciale:</strong> 335 7301206</p>
            <p style="margin: 5px 0;"><strong>Telefono tecnico:</strong> 331 64 32 390</p>
          </div>
          
          <p>Siamo lieti di accompagnarLa in questo importante passo verso una maggiore sicurezza e tranquillit√†.</p>
          
          <p><strong>Cordiali saluti,</strong><br>Il Team eCura<br><em>Medica GB S.r.l.</em></p>
          
          <div style="background: #1f2937; color: white; padding: 20px; text-align: center; font-size: 14px; margin-top: 30px; border-radius: 8px;">
            <p style="margin: 5px 0;"><strong>Medica GB S.r.l.</strong> - Startup Innovativa a Vocazione Sociale</p>
            <p style="margin: 5px 0;">Milano: Corso Garibaldi 34, 20121 | Genova: Via delle Eriche 53, 16148</p>
            <p style="margin: 5px 0;">P.IVA: 12435130963 | <a href="mailto:info@medicagb.it" style="color: #60a5fa;">info@medicagb.it</a> | www.medicagb.it</p>
          </div>
        </div>
      `,INVIO_PROFORMA:`
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: white;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #f59e0b; margin: 0;">TeleMedCare</h1>
            <p style="color: #6b7280; margin: 5px 0;">Fatturazione e Pagamenti</p>
          </div>
          
          <h2 style="color: #1f2937;">üí∞ Fattura Proforma</h2>
          
          <p>Gentile <strong>${e.NOME_CLIENTE||"{{NOME_CLIENTE}}"}</strong>,</p>
          
          <p>Ti inviamo la fattura proforma per il servizio <strong>${e.PIANO_SERVIZIO||"{{PIANO_SERVIZIO}}"}</strong>.</p>
          
          <div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #f59e0b;">
            <h3 style="margin-top: 0; color: #92400e;">Dettagli Fatturazione:</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <tr><td style="padding: 5px 0; border-bottom: 1px solid #fbbf24;"><strong>Servizio:</strong></td><td style="text-align: right; padding: 5px 0; border-bottom: 1px solid #fbbf24;">${e.PIANO_SERVIZIO||"{{PIANO_SERVIZIO}}"}</td></tr>
              <tr><td style="padding: 5px 0; border-bottom: 1px solid #fbbf24;"><strong>Importo:</strong></td><td style="text-align: right; padding: 5px 0; border-bottom: 1px solid #fbbf24;">${e.IMPORTO_TOTALE||"{{IMPORTO_TOTALE}}"}</td></tr>
              <tr><td style="padding: 5px 0; border-bottom: 1px solid #fbbf24;"><strong>Scadenza:</strong></td><td style="text-align: right; padding: 5px 0; border-bottom: 1px solid #fbbf24;">${e.SCADENZA_PAGAMENTO||"{{SCADENZA_PAGAMENTO}}"}</td></tr>
              <tr><td style="padding: 5px 0;"><strong>Codice:</strong></td><td style="text-align: right; padding: 5px 0;">${e.CODICE_CLIENTE||"{{CODICE_CLIENTE}}"}</td></tr>
            </table>
          </div>
          
          <div style="text-align: center; margin: 30px 0;">
            <a href="#" style="background: #f59e0b; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px;">Procedi al Pagamento</a>
          </div>
          
          <p style="font-size: 14px; color: #6b7280;">
            <strong>Modalit√† di pagamento disponibili:</strong><br>
            ‚Ä¢ Bonifico bancario<br>
            ‚Ä¢ Carta di credito/debito<br>
            ‚Ä¢ PayPal
          </p>
        </div>
      `,BENVENUTO:`
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: white;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #10b981; margin: 0;">üéâ Benvenuto in TeleMedCare!</h1>
            <p style="color: #6b7280; margin: 5px 0;">Il futuro della telemedicina</p>
          </div>
          
          <p>Caro <strong>${e.NOME_CLIENTE||"{{NOME_CLIENTE}}"}</strong>,</p>
          
          <p>Benvenuto nella famiglia TeleMedCare! Siamo entusiasti di averti come nuovo cliente e di poterti offrire i nostri servizi di telemedicina avanzata.</p>
          
          <div style="background: #ecfdf5; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #10b981;">
            <h3 style="margin-top: 0; color: #047857;">Il tuo piano attivo:</h3>
            <ul style="margin: 0; padding-left: 20px;">
              <li><strong>Piano:</strong> ${e.PIANO_SERVIZIO||"{{PIANO_SERVIZIO}}"}</li>
              <li><strong>Costo:</strong> ${e.COSTO_SERVIZIO||"{{COSTO_SERVIZIO}}"}</li>
              <li><strong>Data Attivazione:</strong> ${e.DATA_ATTIVAZIONE||"{{DATA_ATTIVAZIONE}}"}</li>
              <li><strong>Codice Cliente:</strong> ${e.CODICE_CLIENTE||"{{CODICE_CLIENTE}}"}</li>
            </ul>
          </div>
          
          <h3 style="color: #047857;">üåü Servizi inclusi nel tuo piano:</h3>
          <p>${e.SERVIZI_INCLUSI||"{{SERVIZI_INCLUSI}}"}</p>
          
          <div style="text-align: center; margin: 30px 0;">
            <a href="#" style="background: #10b981; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin-right: 10px;">Scarica App</a>
            <a href="#" style="background: #6b7280; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px;">Guida Utente</a>
          </div>
          
          <p>Il nostro team √® a tua disposizione per qualsiasi domanda o supporto tecnico.</p>
        </div>
      `}[o]||'<div style="text-align: center; padding: 40px; color: #ef4444;">Template non trovato</div>';return t.json({success:!0,preview:i,templateId:o,variables:Object.keys(e||{})})}catch{return t.json({success:!1,error:"Errore generazione preview"},500)}});I.post("/api/email/test-send",async t=>{try{const{templateId:o,variables:e,testEmail:a}=await t.req.json();return await new Promise(i=>setTimeout(i,1e3)),t.json({success:!0,message:`Email test inviata a ${a}`,templateId:o,timestamp:new Date().toISOString()})}catch{return t.json({success:!1,error:"Errore invio email test"},500)}});I.get("/admin/docs",t=>t.html(`
    <!DOCTYPE html>
    <html lang="it">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>TeleMedCare V12.0 - Centro Documentazione</title>
        <script src="https://cdn.tailwindcss.com"><\/script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .doc-card { transition: all 0.3s ease; }
            .doc-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
            .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <div class="min-h-screen">
            <!-- Header -->
            <header class="gradient-bg shadow-lg">
                <div class="container mx-auto px-6 py-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <i class="fas fa-book text-3xl text-white"></i>
                            <div>
                                <h1 class="text-2xl font-bold text-white">Centro Documentazione TeleMedCare</h1>
                                <p class="text-blue-100">Manuali utente, deployment e dispositivi medici</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="px-3 py-1 bg-green-500 text-white rounded-full text-sm cursor-pointer" onclick="showSystemStatus()">
                                <i class="fas fa-server mr-1"></i>Sistema Online
                            </span>
                            <a href="/home" class="px-3 py-2 bg-white text-blue-600 rounded-lg hover:bg-gray-100 transition-colors" title="Home">
                                <i class="fas fa-home text-xl"></i>
                            </a>
                            <a href="/dashboard" class="px-3 py-2 bg-white text-blue-600 rounded-lg hover:bg-gray-100 transition-colors" title="Dashboard Operativa">
                                <i class="fas fa-chart-pie text-xl"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <div class="container mx-auto px-6 py-8">
                <!-- Sezione Manuali TeleMedCare -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">
                        <i class="fas fa-laptop-medical text-blue-600 mr-2"></i>
                        Documentazione TeleMedCare V12.0
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Manuale Utente -->
                        <div class="doc-card bg-white rounded-xl p-6 shadow-lg">
                            <div class="text-center mb-4">
                                <div class="text-4xl text-blue-600 mb-3">
                                    <i class="fas fa-user-guide"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">Manuale Utente</h3>
                                <p class="text-gray-600 text-sm">Guida completa all'uso del sistema TeleMedCare</p>
                            </div>
                            
                            <div class="space-y-2 text-sm text-gray-600 mb-4">
                                <div>üìñ <strong>Versione:</strong> 11.0.3</div>
                                <div>üìÖ <strong>Aggiornato:</strong> 10/10/2024</div>
                                <div>üìÑ <strong>Pagine:</strong> 127</div>
                                <div>üåç <strong>Lingua:</strong> Italiano</div>
                            </div>
                            
                            <div class="space-y-2">
                                <button onclick="viewDocument('user-manual')" class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    <i class="fas fa-eye mr-2"></i>Visualizza Online
                                </button>
                                <button onclick="downloadDocument('user-manual')" class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                    <i class="fas fa-download mr-2"></i>Scarica PDF
                                </button>
                            </div>
                        </div>
                        
                        <!-- Deployment Manual -->
                        <div class="doc-card bg-white rounded-xl p-6 shadow-lg">
                            <div class="text-center mb-4">
                                <div class="text-4xl text-purple-600 mb-3">
                                    <i class="fas fa-server"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">Deployment Manual</h3>
                                <p class="text-gray-600 text-sm">Guida tecnica installazione e configurazione</p>
                            </div>
                            
                            <div class="space-y-2 text-sm text-gray-600 mb-4">
                                <div>üîß <strong>Versione:</strong> 11.0.2</div>
                                <div>üìÖ <strong>Aggiornato:</strong> 08/10/2024</div>
                                <div>üìÑ <strong>Pagine:</strong> 89</div>
                                <div>üõ†Ô∏è <strong>Target:</strong> DevOps/IT</div>
                            </div>
                            
                            <div class="space-y-2">
                                <button onclick="viewDocument('deployment-manual')" class="w-full px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                                    <i class="fas fa-eye mr-2"></i>Visualizza Online
                                </button>
                                <button onclick="downloadDocument('deployment-manual')" class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                    <i class="fas fa-download mr-2"></i>Scarica PDF
                                </button>
                            </div>
                        </div>
                        
                        <!-- System Architecture -->
                        <div class="doc-card bg-white rounded-xl p-6 shadow-lg">
                            <div class="text-center mb-4">
                                <div class="text-4xl text-orange-600 mb-3">
                                    <i class="fas fa-sitemap"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">System Architecture</h3>
                                <p class="text-gray-600 text-sm">Architettura tecnica del sistema</p>
                            </div>
                            
                            <div class="space-y-2 text-sm text-gray-600 mb-4">
                                <div>üèóÔ∏è <strong>Versione:</strong> 11.0.1</div>
                                <div>üìÖ <strong>Aggiornato:</strong> 05/10/2024</div>
                                <div>üìÑ <strong>Pagine:</strong> 156</div>
                                <div>‚öôÔ∏è <strong>Target:</strong> Sviluppatori</div>
                            </div>
                            
                            <div class="space-y-2">
                                <button onclick="viewDocument('system-architecture')" class="w-full px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">
                                    <i class="fas fa-eye mr-2"></i>Visualizza Online
                                </button>
                                <button onclick="downloadDocument('system-architecture')" class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                    <i class="fas fa-download mr-2"></i>Scarica PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sezione Dispositivi Medici -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">
                        <i class="fas fa-stethoscope text-red-600 mr-2"></i>
                        Documentazione Dispositivi Medici
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- SiDLY Care Pro -->
                        <div class="doc-card bg-white rounded-xl p-6 shadow-lg">
                            <div class="text-center mb-4">
                                <div class="text-3xl text-red-600 mb-3">
                                    <i class="fas fa-heartbeat"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">SiDLY Care Pro</h3>
                                <p class="text-gray-600 text-sm">Dispositivo di monitoraggio cardiaco avanzato</p>
                            </div>
                            
                            <div class="space-y-2 text-xs text-gray-600 mb-4">
                                <div>üè∑Ô∏è <strong>Codice:</strong> SCP-2024</div>
                                <div>üîß <strong>Versione FW:</strong> 2.1.3</div>
                                <div>üè• <strong>Classe:</strong> IIa</div>
                            </div>
                            
                            <div class="space-y-1">
                                <button onclick="viewDeviceDoc('sidly-manual')" class="w-full px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">
                                    üìö Manuale d'uso
                                </button>
                                <button onclick="viewDeviceDoc('sidly-technical')" class="w-full px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                                    üîß Scheda tecnica
                                </button>
                                <button onclick="viewDeviceDoc('sidly-maintenance')" class="w-full px-3 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">
                                    üõ†Ô∏è Manutenzione
                                </button>
                            </div>
                        </div>
                        
                        <!-- CardioMed Pro -->
                        <div class="doc-card bg-white rounded-xl p-6 shadow-lg">
                            <div class="text-center mb-4">
                                <div class="text-3xl text-blue-600 mb-3">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">CardioMed Pro</h3>
                                <p class="text-gray-600 text-sm">Monitor pressorio digitale professionale</p>
                            </div>
                            
                            <div class="space-y-2 text-xs text-gray-600 mb-4">
                                <div>üè∑Ô∏è <strong>Codice:</strong> CMP-2024</div>
                                <div>üîß <strong>Versione FW:</strong> 1.8.2</div>
                                <div>üè• <strong>Classe:</strong> IIa</div>
                            </div>
                            
                            <div class="space-y-1">
                                <button onclick="viewDeviceDoc('cardio-manual')" class="w-full px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                                    üìö Manuale d'uso
                                </button>
                                <button onclick="viewDeviceDoc('cardio-technical')" class="w-full px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                                    üîß Scheda tecnica
                                </button>
                                <button onclick="viewDeviceDoc('cardio-calibration')" class="w-full px-3 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">
                                    ‚öñÔ∏è Calibrazione
                                </button>
                            </div>
                        </div>
                        
                        <!-- GlucoseMon -->
                        <div class="doc-card bg-white rounded-xl p-6 shadow-lg">
                            <div class="text-center mb-4">
                                <div class="text-3xl text-green-600 mb-3">
                                    <i class="fas fa-tint"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">GlucoseMon</h3>
                                <p class="text-gray-600 text-sm">Glucometro digitale connesso</p>
                            </div>
                            
                            <div class="space-y-2 text-xs text-gray-600 mb-4">
                                <div>üè∑Ô∏è <strong>Codice:</strong> GLM-2024</div>
                                <div>üîß <strong>Versione FW:</strong> 3.2.1</div>
                                <div>üè• <strong>Classe:</strong> IIb</div>
                            </div>
                            
                            <div class="space-y-1">
                                <button onclick="viewDeviceDoc('glucose-manual')" class="w-full px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">
                                    üìö Manuale d'uso
                                </button>
                                <button onclick="viewDeviceDoc('glucose-strips')" class="w-full px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                                    üß™ Strisce reattive
                                </button>
                                <button onclick="viewDeviceDoc('glucose-safety')" class="w-full px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">
                                    ‚ö†Ô∏è Sicurezza
                                </button>
                            </div>
                        </div>
                        
                        <!-- OxiSat Pro -->
                        <div class="doc-card bg-white rounded-xl p-6 shadow-lg">
                            <div class="text-center mb-4">
                                <div class="text-3xl text-purple-600 mb-3">
                                    <i class="fas fa-lungs"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">OxiSat Pro</h3>
                                <p class="text-gray-600 text-sm">Pulsossimetro professionale wireless</p>
                            </div>
                            
                            <div class="space-y-2 text-xs text-gray-600 mb-4">
                                <div>üè∑Ô∏è <strong>Codice:</strong> OSP-2024</div>
                                <div>üîß <strong>Versione FW:</strong> 1.5.4</div>
                                <div>üè• <strong>Classe:</strong> IIa</div>
                            </div>
                            
                            <div class="space-y-1">
                                <button onclick="viewDeviceDoc('oxi-manual')" class="w-full px-3 py-1 bg-purple-600 text-white rounded text-xs hover:bg-purple-700">
                                    üìö Manuale d'uso
                                </button>
                                <button onclick="viewDeviceDoc('oxi-accuracy')" class="w-full px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                                    üìè Precisione
                                </button>
                                <button onclick="viewDeviceDoc('oxi-wireless')" class="w-full px-3 py-1 bg-indigo-600 text-white rounded text-xs hover:bg-indigo-700">
                                    üì° Wireless Setup
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-tools text-gray-600 mr-2"></i>Azioni Rapide
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button onclick="searchDocuments()" class="flex items-center justify-center px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-search mr-2"></i>Cerca Documentazione
                        </button>
                        <button onclick="requestUpdate()" class="flex items-center justify-center px-4 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                            <i class="fas fa-edit mr-2"></i>Richiedi Aggiornamento
                        </button>
                        <button onclick="downloadAll()" class="flex items-center justify-center px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <i class="fas fa-download mr-2"></i>Scarica Tutto
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // System Status Modal (reused from other pages)
            function showSystemStatus() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                modal.onclick = () => modal.remove();
                
                modal.innerHTML = \`
                    <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-96 overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-800">
                                <i class="fas fa-server text-green-600 mr-2"></i>Centro Documentazione Online
                            </h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span>üìö Manuali TeleMedCare</span><span class="text-green-600">‚úì 3 Disponibili</span></div>
                            <div class="flex justify-between"><span>üè• Doc. Dispositivi</span><span class="text-green-600">‚úì 4 Dispositivi</span></div>
                            <div class="flex justify-between"><span>üîÑ Auto-Update</span><span class="text-green-600">‚úì Attivo</span></div>
                            <div class="flex justify-between"><span>üíæ Storage</span><span class="text-blue-600">2.1GB / 10GB</span></div>
                        </div>
                    </div>
                \`;
                
                document.body.appendChild(modal);
            }
            
            // Document Actions
            function viewDocument(docId) {
                const urls = {
                    'user-manual': '/docs/telemedcare-user-manual-v12.pdf',
                    'deployment-manual': '/docs/telemedcare-deployment-v12.pdf',
                    'system-architecture': '/docs/telemedcare-architecture-v12.pdf'
                };
                
                if (urls[docId]) {
                    window.open(urls[docId], '_blank');
                } else {
                    alert('üìñ Visualizzazione documento: ' + docId);
                }
            }
            
            function downloadDocument(docId) {
                alert('‚¨áÔ∏è Download avviato per: ' + docId);
            }
            
            function viewDeviceDoc(docId) {
                alert('üì± Apertura documentazione dispositivo: ' + docId);
            }
            
            function searchDocuments() {
                const query = prompt('üîç Inserisci termine di ricerca:');
                if (query) {
                    alert('Ricerca in corso per: ' + query);
                }
            }
            
            function requestUpdate() {
                alert('üìù Richiesta di aggiornamento documentazione inviata al team tecnico');
            }
            
            function downloadAll() {
                if (confirm('üì¶ Scaricare tutta la documentazione? (~ 45MB)')) {
                    alert('‚¨áÔ∏è Download pacchetto completo avviato');
                }
            }
        <\/script>
    </body>
    </html>
  `));I.get("/api/status",t=>t.json({system:"TeleMedCare V12.0 Modular Enterprise",status:"active",timestamp:new Date().toISOString(),version:"V12.0-Modular-Enterprise",enterprise:!0,modules:["lead-config","lead-core","lead-channels","lead-conversion","lead-scoring","lead-reports","dispositivi","pdf","utils","logging"],compatibility:"V12.0-Cloudflare"}));I.get("/api/system/status",async t=>{try{const{env:o}=t;let e="OFFLINE",a=null;try{await o.DB.prepare("SELECT 1").first(),e="ONLINE"}catch(r){a=r instanceof Error?r.message:"Database connection failed"}let i=null;try{i=await o.DB.prepare(`
        SELECT 
          (SELECT COUNT(*) FROM leads) as total_leads,
          (SELECT COUNT(*) FROM assistiti) as total_assistiti,
          (SELECT COUNT(*) FROM dispositivi) as total_devices,
          (SELECT COUNT(*) FROM contracts) as total_contracts
      `).first()}catch(r){console.error("Errore stats:",r)}return t.json({system:"TeleMedCare V12.0",status:"ONLINE",timestamp:new Date().toISOString(),health:{database:{status:e,error:a,lastCheck:new Date().toISOString()},api:{status:"ONLINE",endpoints:47},services:{email:"READY",leads:"ACTIVE",devices:"ACTIVE",contracts:"ACTIVE"}},statistics:i||{total_leads:0,total_assistiti:0,total_devices:0,total_contracts:0},performance:{uptime:process.uptime?Math.floor(process.uptime()):"N/A",memory:"N/A",responseTime:"Fast"}})}catch(o){return t.json({system:"TeleMedCare V12.0",status:"ERROR",timestamp:new Date().toISOString(),error:o instanceof Error?o.message:"Sistema non disponibile"},500)}});I.get("/api/analytics/overview",async t=>{try{const o=t.env.DB;let e=0,a=0,i=0,r=0;if(o){const s=await o.prepare("SELECT COUNT(*) as count FROM leads").first();e=(s==null?void 0:s.count)||0,a=Math.floor(e*.7),i=a*299,r=Math.floor(e*.05)}else e=25,a=18,i=5382,r=3;return t.json({success:!0,data:{totalLeads:e,activeContracts:a,monthlyRevenue:`‚Ç¨${i.toLocaleString()}`,emergencies:r,lastUpdated:new Date().toISOString()}})}catch{return t.json({success:!1,error:"Errore recupero analytics"},500)}});I.get("/api/data/proforma",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database D1 non configurato"},500);const e=await t.env.DB.prepare(`
      SELECT 
        p.id,
        p.numero_proforma,
        p.prezzo_totale,
        p.status,
        p.data_emissione,
        p.data_invio,
        p.contract_id,
        l.nomeRichiedente,
        l.cognomeRichiedente,
        l.email,
        c.tipo_contratto
      FROM proforma p
      LEFT JOIN contracts c ON p.contract_id = c.id
      LEFT JOIN leads l ON c.leadId = l.id
      ORDER BY p.created_at DESC
    `).all();return t.json({success:!0,proforma:e.results.map(a=>({...a,cliente_nome:`${a.nomeRichiedente} ${a.cognomeRichiedente}`,status_italiano:a.status==="PAID"?"Pagata":a.status==="SENT"?"Inviata":a.status==="DRAFT"?"Bozza":"In attesa"})),totalCount:e.results.length,totalValue:e.results.reduce((a,i)=>a+Number(i.prezzo_totale||0),0)})}catch(e){return t.json({success:!1,error:"Errore recupero proforma",details:e.message},500)}});I.get("/api/data/pagamenti",async t=>{try{const o=t.env.DB,e=t.req.query("status");if(o){const r=(await o.prepare(`
        SELECT c.id, c.contractType, c.status, c.created_at, c.leadId
        FROM contracts c
        WHERE c.status IN ('PAID', 'SIGNED')
        ORDER BY c.created_at DESC
      `).all()).results.map((s,l)=>({id:`PAY_${s.id}`,transactionId:`TXN_${Date.now()}_${l}`,nome_cliente:`Cliente_${s.leadId}`,importo:s.contractType==="AVANZATO"?890:490,metodo:l%4===0?"Stripe":l%4===1?"PayPal":l%4===2?"Bonifico":"Carta",status:s.status==="PAID"?"completed":"pending",data:s.created_at,contratto_id:s.id})).filter(s=>!e||e==="all"||s.status===e);return t.json({success:!0,pagamenti:r,totalCount:r.length,totalValue:r.reduce((s,l)=>s+l.importo,0)})}else{const a=[{id:"PAY_001",transactionId:"TXN_2024_001",nome_cliente:"Mario Rossi",importo:890,metodo:"Stripe",status:"completed",data:"2024-10-01T10:00:00Z"},{id:"PAY_002",transactionId:"TXN_2024_002",nome_cliente:"Anna Verdi",importo:490,metodo:"PayPal",status:"pending",data:"2024-10-05T14:30:00Z"},{id:"PAY_003",transactionId:"TXN_2024_003",nome_cliente:"Luigi Bianchi",importo:890,metodo:"Bonifico",status:"completed",data:"2024-10-07T09:15:00Z"}].filter(i=>!e||e==="all"||i.status===e);return t.json({success:!0,pagamenti:a,totalCount:a.length,totalValue:a.reduce((i,r)=>i+r.importo,0)})}}catch(o){return t.json({success:!1,error:"Errore recupero pagamenti",details:o.message},500)}});I.get("/api/data/dashboard",async t=>{try{const o=t.env.DB;let e={};if(o){const[a,i,r]=await Promise.all([o.prepare("SELECT COUNT(*) as count FROM leads").first(),o.prepare('SELECT COUNT(*) as count FROM contracts WHERE status = "SIGNED"').first(),o.prepare('SELECT COUNT(*) as count FROM dispositivi WHERE status = "attivo"').first()]),s=(a==null?void 0:a.count)||0,l=(i==null?void 0:i.count)||0,d=(r==null?void 0:r.count)||0;e={leads:{totali:s,nuovi_oggi:Math.floor(s*.1)||1,in_lavorazione:Math.floor(s*.3),convertiti:l},contratti:{attivi:l,in_scadenza:Math.floor(l*.15),fatturato_mensile:l*490,crescita:"+12%"},dispositivi:{totali:d,configurati:d,assegnati:Math.floor(d*.8),disponibili:Math.floor(d*.2)}}}else e={leads:{totali:25,nuovi_oggi:3,in_lavorazione:8,convertiti:12},contratti:{attivi:12,in_scadenza:2,fatturato_mensile:5880,crescita:"+12%"},dispositivi:{totali:15,configurati:15,assegnati:12,disponibili:3}};return t.json({success:!0,data:e,timestamp:new Date().toISOString(),version:"V12.0-Consistent"})}catch(o){return t.json({success:!1,error:"Errore recupero dashboard",details:o.message},500)}});I.get("/api/analytics/charts",async t=>{try{const o=t.env.DB,e=7,a=[];for(let i=e-1;i>=0;i--){const r=new Date;r.setDate(r.getDate()-i);const s=r.toISOString().split("T")[0];let l=r.getDate()*3%8+2;if(o)try{const d=await o.prepare(`
            SELECT COUNT(*) as count 
            FROM leads 
            WHERE DATE(created_at) = ?
          `).bind(s).first();l=(d==null?void 0:d.count)||l}catch{}a.push({date:s,leads:l,contracts:Math.floor(l*.7),revenue:l*299})}return t.json({success:!0,data:{daily:a,period:`${e} giorni`,generated:new Date().toISOString()}})}catch{return t.json({success:!1,error:"Errore recupero dati grafici"},500)}});I.post("/api/devices/read-imei",async t=>{try{const{deviceId:o}=await t.req.json();console.log(`üì± [API] Richiesta lettura IMEI dispositivo: ${o}`);const i=await(await Promise.resolve().then(()=>S0)).default.getInstance().readDeviceIMEI(o);return t.json({success:i.success,imei:i.imei,deviceInfo:i.deviceInfo,error:i.error})}catch(o){return console.error("‚ùå [API] Errore lettura IMEI:",o),t.json({success:!1,error:o instanceof Error?o.message:"Errore lettura IMEI"},500)}});I.post("/api/devices/calculate-expiry",async t=>{try{const{manufacturingDate:o,deviceType:e}=await t.req.json();console.log(`üìÖ [API] Calcolo scadenza dispositivo: ${e}, data: ${o}`);const r=(await Promise.resolve().then(()=>S0)).default.getInstance().calculateDeviceExpiry(o,e);return t.json({success:!0,expiry:r})}catch(o){return console.error("‚ùå [API] Errore calcolo scadenza:",o),t.json({success:!1,error:o instanceof Error?o.message:"Errore calcolo scadenza"},500)}});I.get("/api/devices/registry",async t=>{try{const o=t.env.DB;let e=[];if(o)try{e=(await o.prepare(`
          SELECT * FROM device_registry 
          ORDER BY created_at DESC LIMIT 50
        `).all()).results||[]}catch{console.log("Tabella device_registry non trovata, uso dati mock")}return e.length===0&&(e=[{id:"DEV001",nome:"SiDLY Care Pro V12.0 #001",tipo:"dispositivo_principale",seriale:"SCP110001",stato:"attivo",paziente:"Mario Rossi",ubicazione:"Roma, Via Roma 123",batteria:87,segnale:4,ultimo_aggiornamento:new Date().toISOString(),created_at:new Date().toISOString()},{id:"DEV002",nome:"SiDLY Care Pro V12.0 #002",tipo:"dispositivo_principale",seriale:"SCP110002",stato:"manutenzione",paziente:"Anna Bianchi",ubicazione:"Milano, Via Duomo 45",batteria:23,segnale:3,ultimo_aggiornamento:new Date().toISOString(),created_at:new Date().toISOString()},{id:"DEV003",nome:"SiDLY Care Pro V12.0 #003",tipo:"dispositivo_principale",seriale:"SCP110003",stato:"attivo",paziente:"Giuseppe Verde",ubicazione:"Napoli, Corso Umberto 78",batteria:92,segnale:5,ultimo_aggiornamento:new Date().toISOString(),created_at:new Date().toISOString()}]),t.json({success:!0,data:e,count:e.length,timestamp:new Date().toISOString()})}catch{return t.json({success:!1,error:"Errore recupero dispositivi"},500)}});function RT(){const t=new Date().toISOString().replace(/[:.]/g,""),o=Math.random().toString(36).substring(2,8).toUpperCase();return`LEAD_${t}_${o}`}I.get("/",t=>(t.header("Cache-Control","no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0"),t.header("Pragma","no-cache"),t.header("Expires","0"),t.header("X-Cache-Bypass","true"),t.header("X-TeleMedCare-Version","11.0-"+Date.now()),t.html(c0)));I.get("/landing",t=>t.html(`
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleMedCare V12.0 - Telemedicina Avanzata</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-600">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-600 text-white p-2 rounded-lg">
                        <i class="fas fa-heartbeat text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">TeleMedCare V12.0</h1>
                        <p class="text-sm text-gray-600">Telemedicina Professionale</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-600">Medica GB S.r.l.</p>
                    <p class="text-xs text-blue-600">Certificata ISO 27001</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="py-16 text-center">
        <div class="max-w-4xl mx-auto px-4">
            <h2 class="text-5xl font-bold text-gray-800 mb-6">
                üè• Rivoluziona la Tua <span class="text-blue-600">Salute</span>
            </h2>
            <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">
                Monitoring avanzato H24, dispositivi SiDLY Care Pro, consulenze specialistiche immediate. 
                Il futuro della telemedicina √® qui.
            </p>
            
            <!-- Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <i class="fas fa-users text-3xl text-blue-600 mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-800">15.000+</h3>
                    <p class="text-gray-600">Pazienti Attivi</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <i class="fas fa-stethoscope text-3xl text-green-600 mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-800">250+</h3>
                    <p class="text-gray-600">Medici Specialisti</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <i class="fas fa-chart-line text-3xl text-purple-600 mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-800">99.8%</h3>
                    <p class="text-gray-600">Uptime Garantito</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Form Section -->
    <section class="py-16 bg-white">
        <div class="max-w-6xl mx-auto px-4">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
                
                <!-- Form Column -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-8 rounded-2xl shadow-xl">
                    <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">
                        üöÄ Inizia Subito
                    </h3>
                    
                    <form id="leadForm" class="space-y-6">
                        <!-- Nome -->
                        <div>
                            <label for="nome" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-user mr-2"></i>Nome Completo *
                            </label>
                            <input type="text" id="nome" name="nome" required
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                                placeholder="Mario Rossi">
                        </div>

                        <!-- Email -->
                        <div>
                            <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-envelope mr-2"></i>Email *
                            </label>
                            <input type="email" id="email" name="email" required
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                                placeholder="mario@email.com">
                        </div>

                        <!-- Telefono -->
                        <div>
                            <label for="telefono" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-phone mr-2"></i>Telefono *
                            </label>
                            <input type="tel" id="telefono" name="telefono" required
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                                placeholder="+39 123 456 7890">
                        </div>

                        <!-- Et√† -->
                        <div>
                            <label for="eta" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-calendar mr-2"></i>Et√†
                            </label>
                            <input type="number" id="eta" name="eta" min="18" max="100"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                                placeholder="65">
                        </div>

                        <!-- Tipologia Servizio -->
                        <div>
                            <label for="servizio" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-medical-kit mr-2"></i>Servizio Richiesto *
                            </label>
                            <select id="servizio" name="servizio" required
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors">
                                <option value="">Seleziona servizio...</option>
                                <option value="BASIC">üìä Basic - Monitoring Essenziale (‚Ç¨490/anno)</option>
                                <option value="AVANZATO">üè• Avanzato - Telemedicina Completa (‚Ç¨890/anno)</option>
                            </select>
                        </div>

                        <!-- Azienda (opzionale) -->
                        <div>
                            <label for="azienda" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-building mr-2"></i>Azienda (opzionale)
                            </label>
                            <input type="text" id="azienda" name="azienda"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                                placeholder="Medica GB S.r.l.">
                        </div>

                        <!-- Privacy -->
                        <div class="flex items-start space-x-3">
                            <input type="checkbox" id="privacy" name="privacy" required
                                class="mt-1 h-4 w-4 text-blue-600 border-2 border-gray-300 rounded focus:ring-blue-500">
                            <label for="privacy" class="text-sm text-gray-600 leading-tight">
                                Accetto il trattamento dei dati personali secondo la 
                                <a href="#" class="text-blue-600 underline">Privacy Policy</a> 
                                e autorizzo l'invio di comunicazioni commerciali *
                            </label>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" 
                            class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-4 px-6 rounded-lg hover:from-blue-700 hover:to-indigo-700 transform hover:scale-105 transition-all duration-300 shadow-lg">
                            <i class="fas fa-rocket mr-2"></i>
                            ATTIVA TELEMEDCARE SUBITO
                        </button>
                    </form>

                    <!-- Loading e Success Messages -->
                    <div id="loadingMessage" class="hidden text-center mt-6">
                        <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
                        <p class="text-blue-600 font-semibold mt-2">Elaborazione in corso...</p>
                    </div>

                    <div id="successMessage" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mt-6">
                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                        <span class="text-green-800 font-semibold">Richiesta inviata! Controlla la tua email per il contratto.</span>
                    </div>

                    <div id="errorMessage" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mt-6">
                        <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                        <span class="text-red-800 font-semibold">Errore nell'invio. Riprova o contatta il supporto.</span>
                    </div>
                </div>

                <!-- Benefits Column -->
                <div class="space-y-8">
                    <h3 class="text-3xl font-bold text-gray-800 mb-8">
                        ‚ú® Perch√© Scegliere TeleMedCare?
                    </h3>
                    
                    <div class="space-y-6">
                        <div class="flex items-start space-x-4">
                            <div class="bg-blue-100 text-blue-600 p-3 rounded-lg">
                                <i class="fas fa-shield-alt text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">Sicurezza Garantita</h4>
                                <p class="text-gray-600">Crittografia end-to-end e conformit√† GDPR</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-4">
                            <div class="bg-green-100 text-green-600 p-3 rounded-lg">
                                <i class="fas fa-clock text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">Supporto H24</h4>
                                <p class="text-gray-600">Assistenza medica disponibile 24 ore su 24</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-4">
                            <div class="bg-purple-100 text-purple-600 p-3 rounded-lg">
                                <i class="fas fa-mobile-alt text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">Dispositivi Smart</h4>
                                <p class="text-gray-600">Tecnologia SiDLY Care Pro inclusa</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-4">
                            <div class="bg-orange-100 text-orange-600 p-3 rounded-lg">
                                <i class="fas fa-chart-line text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">Analytics Avanzate</h4>
                                <p class="text-gray-600">Reportistica dettagliata e insights predittivi</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <p>&copy; 2024 TeleMedCare V12.0 - Medica GB S.r.l. - P.IVA 12345678901</p>
            <p class="text-gray-400 mt-2">Certificazioni: ISO 27001 | ISO 13485 | GDPR Compliant</p>
        </div>
    </footer>

    <!-- JavaScript per il form -->
    <script>
        document.getElementById('leadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Nascondi messaggi precedenti
            document.getElementById('successMessage').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('loadingMessage').classList.remove('hidden');
            
            try {
                // Raccogli i dati del form
                const formData = new FormData(this);
                const data = {
                    nome: formData.get('nome'),
                    email: formData.get('email'),
                    telefono: formData.get('telefono'),
                    eta: formData.get('eta') || null,
                    servizio: formData.get('servizio'),
                    azienda: formData.get('azienda') || null,
                    privacy: formData.get('privacy') ? true : false,
                    source: 'LANDING_PAGE'
                };
                
                console.log('üöÄ Invio lead:', data);
                
                // Invia la richiesta all'API
                const response = await fetch('/api/lead', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                console.log('üìß Risposta API:', result);
                
                document.getElementById('loadingMessage').classList.add('hidden');
                
                if (result.success) {
                    document.getElementById('successMessage').classList.remove('hidden');
                    this.reset(); // Reset del form
                    
                    // Scroll al messaggio di successo
                    document.getElementById('successMessage').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                } else {
                    document.getElementById('errorMessage').classList.remove('hidden');
                    console.error('‚ùå Errore API:', result.error);
                }
                
            } catch (error) {
                console.error('‚ùå Errore invio:', error);
                document.getElementById('loadingMessage').classList.add('hidden');
                document.getElementById('errorMessage').classList.remove('hidden');
            }
        });
    <\/script>
</body>
</html>
  `));I.get("/dashboard",t=>(t.header("Cache-Control","no-store, no-cache, must-revalidate, proxy-revalidate"),t.header("Pragma","no-cache"),t.header("Expires","0"),t.header("X-TeleMedCare-Dashboard","operativa"),t.header("X-TeleMedCare-Version","V12.0-Dynamic-Template"),t.html(vT)));I.get("/admin/leads-dashboard",t=>(t.header("Cache-Control","no-store, no-cache, must-revalidate"),t.header("X-TeleMedCare-Dashboard","leads"),t.html(ET)));I.get("/admin/data-dashboard",t=>(t.header("Cache-Control","no-store, no-cache, must-revalidate"),t.header("X-TeleMedCare-Dashboard","data"),t.html(bT)));I.get("/admin/workflow-manager",t=>(t.header("Cache-Control","no-store, no-cache, must-revalidate"),t.header("X-TeleMedCare-Dashboard","workflow"),t.html(yT)));I.get("/admin/test-contratti",t=>(t.header("Cache-Control","no-store, no-cache, must-revalidate"),t.html(`<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Caricamento Contratti - TeleMedCare</title>
  <script src="https://cdn.tailwindcss.com"><\/script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-8">
  
  <div class="max-w-6xl mx-auto">
    
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">
        üß™ Test Caricamento Contratti
      </h1>
      <p class="text-gray-600">
        Verifica e carica i 9 contratti reali nel database
      </p>
    </div>

    <!-- Buttons -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="mb-4">
        <button 
          id="btnDebug" 
          onclick="debugLeads()"
          class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-md hover:shadow-lg">
          üîç DEBUG: Mostra Email Leads nel Database
        </button>
      </div>
      
      <div class="grid grid-cols-1 gap-4">
        <button 
          id="btnAll" 
          onclick="runFullCycle()"
          class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-4 px-8 rounded-lg transition-all shadow-lg hover:shadow-xl text-lg">
          üöÄ CARICA CONTRATTI (DELETE + POST)
        </button>
      </div>
      
      <div class="grid grid-cols-2 gap-4 mt-4">
        <button 
          id="btnDelete" 
          onclick="deleteContracts()"
          class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg transition-all shadow-md hover:shadow-lg">
          üóëÔ∏è DELETE Contratti
        </button>
        
        <button 
          id="btnCreate" 
          onclick="createContracts()"
          class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-all shadow-md hover:shadow-lg">
          ‚úÖ POST Contratti
        </button>
      </div>
    </div>
        
        <button 
          id="btnCreate" 
          onclick="createContracts()"
          class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-all shadow-md hover:shadow-lg">
          ‚úÖ POST Contratti
        </button>
      </div>
    </div>

    <!-- Log Output -->
    <div class="bg-white rounded-lg shadow-lg p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">üìã Log Output</h2>
      <div id="output" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm overflow-auto" style="max-height: 600px;">
        <div class="text-gray-500">In attesa di comandi...</div>
      </div>
    </div>

  </div>

  <script>
    const output = document.getElementById('output');
    
    function log(message, color = 'text-green-400') {
      const div = document.createElement('div');
      div.className = color;
      div.textContent = message;
      output.appendChild(div);
      output.scrollTop = output.scrollHeight;
    }
    
    function clearLog() {
      output.innerHTML = '';
    }
    
    async function deleteContracts() {
      clearLog();
      log('üóëÔ∏è DELETE /api/setup-real-contracts...', 'text-yellow-400');
      
      try {
        const response = await fetch('/api/setup-real-contracts', { 
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });
        
        log(\`üì° Response: \${response.status} \${response.statusText}\`, 'text-blue-400');
        
        if (!response.ok) {
          throw new Error(\`HTTP \${response.status}: \${response.statusText}\`);
        }
        
        const result = await response.json();
        log('‚úÖ DELETE completato!', 'text-green-400');
        log(\`   Contratti rimossi: \${result.removed || 0}\`, 'text-green-400');
        log(JSON.stringify(result, null, 2), 'text-gray-400');
        
      } catch (error) {
        log('‚ùå ERRORE:', 'text-red-400');
        log(error.message, 'text-red-400');
        console.error(error);
      }
    }
    
    async function debugLeads() {
      clearLog();
      log('üîç DEBUG: Caricamento email leads dal database...', 'text-yellow-400');
      log('', '');
      
      try {
        const response = await fetch('/api/debug/leads-emails');
        
        if (!response.ok) {
          throw new Error(\`HTTP \${response.status}: \${response.statusText}\`);
        }
        
        const result = await response.json();
        
        log(\`‚úÖ Trovati \${result.total} leads nel database\`, 'text-green-400');
        log('', '');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
        log('üìß EMAIL LEADS NEL DATABASE:', 'text-cyan-400');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
        
        if (result.leads && result.leads.length > 0) {
          result.leads.forEach((lead, i) => {
            log(\`\${i + 1}. \${lead.email}\`, 'text-white');
            log(\`   Nome: \${lead.nome_completo}\`, 'text-gray-400');
            log(\`   ID: \${lead.id}\`, 'text-gray-400');
            log('', '');
          });
          
          log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
          log('üîç EMAIL RICHIESTE DAI CONTRATTI:', 'text-cyan-400');
          log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
          
          const emailRichieste = [
            'elenasaglia@hotmail.com',
            'paolo@paolomagri.com',
            'simona.pizzutto@coopbarbarab.it',
            'caterinadalterio108@gmail.com',
            'elisabettacattini@gmail.com',
            'gr@ecotorino.it'
          ];
          
          emailRichieste.forEach((email, i) => {
            const found = result.leads.find(l => l.email.toLowerCase() === email.toLowerCase());
            if (found) {
              log(\`\${i + 1}. ‚úÖ \${email} ‚Üí TROVATO (\${found.nome_completo})\`, 'text-green-400');
            } else {
              log(\`\${i + 1}. ‚ùå \${email} ‚Üí NON TROVATO\`, 'text-red-400');
            }
          });
          
        } else {
          log('‚ö†Ô∏è Nessun lead trovato nel database!', 'text-red-400');
        }
        
      } catch (error) {
        log('‚ùå ERRORE:', 'text-red-400');
        log(error.message, 'text-red-400');
        console.error(error);
      }
    }
    
    async function createContracts() {
      clearLog();
      log('‚úÖ POST /api/setup-real-contracts...', 'text-yellow-400');
      
      try {
        const response = await fetch('/api/setup-real-contracts', { 
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        log(\`üì° Response: \${response.status} \${response.statusText}\`, 'text-blue-400');
        
        if (!response.ok) {
          throw new Error(\`HTTP \${response.status}: \${response.statusText}\`);
        }
        
        const result = await response.json();
        log('‚úÖ CREAZIONE COMPLETATA!', 'text-green-400');
        log('', '');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
        log('üìä RIEPILOGO STATISTICHE', 'text-cyan-400');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
        log(\`‚úì Contratti creati:      \${result.creati}\`, 'text-green-400');
        log(\`‚úó Errori:                \${result.errori}\`, 'text-red-400');
        log(\`üìù Contratti FIRMATI:    \${result.firmati}\`, 'text-green-400');
        log(\`üìù Contratti INVIATI:    \${result.creati - result.firmati}\`, 'text-yellow-400');
        log(\`üí∞ REVENUE ANNUALE:      ‚Ç¨\${result.revenue}\`, 'text-green-400');
        log(\`üìà Conversion Rate:      \${result.conversionRate}\`, 'text-blue-400');
        log(\`üíµ AOV (valore medio):   ‚Ç¨\${result.aov}\`, 'text-blue-400');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
        log('', '');
        
        if (result.contratti) {
          log('üìã CONTRATTI CREATI:', 'text-cyan-400');
          log('', '');
          result.contratti.forEach((c, i) => {
            const status = c.status === 'SIGNED' ? '‚úÖ Firmato' : 'üì§ Inviato';
            log(\`\${i + 1}. \${c.codice}\`, 'text-white');
            log(\`   Intestatario: \${c.intestatario}\`, 'text-gray-400');
            log(\`   Piano: \${c.piano} | Prezzo: ‚Ç¨\${c.prezzo}\`, 'text-gray-400');
            log(\`   Status: \${status}\`, c.status === 'SIGNED' ? 'text-green-400' : 'text-yellow-400');
            log(\`   Data firma: \${c.data_firma || '-'}\`, 'text-gray-400');
            log('', '');
          });
        }
        
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
        log('üîç VERIFICHE INTESTATARI:', 'text-cyan-400');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
        
        const verifiche = [
          { codice: 'CTR-KING-2025', intestatario: 'Eileen King', prezzo: 840 },
          { codice: 'CTR-BALZAROTTI-2025', intestatario: 'Giuliana Balzarotti', prezzo: 480 },
          { codice: 'CTR-PIZZUTTO-G-2025', intestatario: 'Gianni Paolo Pizzutto', prezzo: 480 },
          { codice: 'CTR-PENNACCHIO-2025', intestatario: 'Rita Pennacchio', prezzo: 480 },
          { codice: 'CTR-COZZI-2025', intestatario: 'Giuseppina Cozzi', prezzo: 480 },
          { codice: 'CTR-CAPONE-2025', intestatario: 'Maria Capone', prezzo: 480 }
        ];
        
        verifiche.forEach(v => {
          const found = result.contratti.find(c => c.codice === v.codice);
          if (found) {
            const ok = found.intestatario === v.intestatario && found.prezzo === v.prezzo;
            log(\`\${ok ? '‚úÖ' : '‚ùå'} \${v.codice}: \${found.intestatario} (‚Ç¨\${found.prezzo})\`, ok ? 'text-green-400' : 'text-red-400');
          } else {
            log(\`‚ùå \${v.codice}: NON TROVATO\`, 'text-red-400');
          }
        });
        
        log('', '');
        log('‚úÖ COMPLETATO! Controlla la Dashboard per vedere i risultati.', 'text-green-400');
        
      } catch (error) {
        log('‚ùå ERRORE:', 'text-red-400');
        log(error.message, 'text-red-400');
        console.error(error);
      }
    }
    
    async function runFullCycle() {
      clearLog();
      log('üöÄ CICLO COMPLETO: DELETE + POST', 'text-cyan-400');
      log('', '');
      
      // DELETE
      log('1Ô∏è‚É£ DELETE contratti esistenti...', 'text-yellow-400');
      
      try {
        const deleteResponse = await fetch('/api/setup-real-contracts', { 
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!deleteResponse.ok) {
          throw new Error(\`DELETE failed: \${deleteResponse.status} \${deleteResponse.statusText}\`);
        }
        
        const deleteResult = await deleteResponse.json();
        log(\`‚úÖ DELETE completato - Rimossi: \${deleteResult.removed || 0}\`, 'text-green-400');
        log('', '');
        log('‚è≥ Attesa 2 secondi...', 'text-gray-400');
        log('', '');
        
        // POST dopo 2 secondi
        setTimeout(async () => {
          log('2Ô∏è‚É£ POST nuovi contratti...', 'text-yellow-400');
          
          try {
            const createResponse = await fetch('/api/setup-real-contracts', { 
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            
            if (!createResponse.ok) {
              throw new Error(\`POST failed: \${createResponse.status} \${createResponse.statusText}\`);
            }
            
            const result = await createResponse.json();
            log('‚úÖ POST completato!', 'text-green-400');
            log('', '');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
            log('üìä RIEPILOGO FINALE', 'text-cyan-400');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
            log(\`‚úì Contratti creati:      \${result.creati}\`, 'text-green-400');
            log(\`‚úó Errori:                \${result.errori}\`, 'text-red-400');
            log(\`üìù Contratti FIRMATI:    \${result.firmati}\`, 'text-green-400');
            log(\`üí∞ REVENUE ANNUALE:      ‚Ç¨\${result.revenue}\`, 'text-green-400');
            log(\`üìà Conversion Rate:      \${result.conversionRate}\`, 'text-blue-400');
            log(\`üíµ AOV:                  ‚Ç¨\${result.aov}\`, 'text-blue-400');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
            
            if (result.contratti) {
              log('', '');
              log('üìã CONTRATTI:', 'text-cyan-400');
              result.contratti.forEach((c, i) => {
                log(\`\${i + 1}. \${c.codice} - \${c.intestatario} - \${c.status === 'SIGNED' ? '‚úÖ' : 'üì§'} ‚Ç¨\${c.prezzo}\`, 
                    c.status === 'SIGNED' ? 'text-green-400' : 'text-yellow-400');
              });
            }
            
            log('', '');
            log('‚úÖ COMPLETATO! La pagina si ricaricher√† tra 3 secondi...', 'text-green-400');
            
            setTimeout(() => {
              location.reload();
            }, 3000);
            
          } catch (postError) {
            log('‚ùå ERRORE POST:', 'text-red-400');
            log(postError.message, 'text-red-400');
          }
          
        }, 2000);
        
      } catch (deleteError) {
        log('‚ùå ERRORE DELETE:', 'text-red-400');
        log(deleteError.message, 'text-red-400');
      }
    }
    
  <\/script>

</body>
</html>`)));I.get("/api/debug/leads-schema",async t=>{var o,e;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const i=(e=(await t.env.DB.prepare("PRAGMA table_info(leads)").all()).results)==null?void 0:e.map(r=>({name:r.name,type:r.type,required:r.notnull===1}));return t.json({success:!0,table:"leads",columns:i,count:(i==null?void 0:i.length)||0})}catch(a){return console.error("‚ùå Errore schema leads:",a),t.json({success:!1,error:"Errore recupero schema",details:a instanceof Error?a.message:String(a)},500)}});I.get("/api/debug/leads-emails",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const a=(await t.env.DB.prepare(`
      SELECT id, email, nomeRichiedente, cognomeRichiedente, created_at
      FROM leads
      ORDER BY created_at DESC
      LIMIT 200
    `).all()).results||[];return t.json({success:!0,total:a.length,leads:a.map(i=>({id:i.id,email:i.email,nome_completo:`${i.nomeRichiedente} ${i.cognomeRichiedente}`,created_at:i.created_at}))})}catch(e){return console.error("‚ùå Errore debug leads:",e),t.json({success:!1,error:e.message},500)}});I.post("/api/admin/cleanup-test-data",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=t.env.ENVIRONMENT||"production";console.log(`üßπ [CLEANUP] Ambiente: ${e}`);const a=await t.env.DB.prepare("SELECT COUNT(*) as count FROM leads WHERE id LIKE 'LEAD-MANUAL-176%'").first(),i=(a==null?void 0:a.count)||0;if(console.log(`üßπ [CLEANUP] Lead da eliminare: ${i}`),i===0)return t.json({success:!0,message:"Nessun lead da eliminare",deleted:{logs:0,tokens:0,contracts:0,leads:0}});const r={logs:0,tokens:0,contracts:0,leads:0},s=await t.env.DB.prepare("DELETE FROM lead_completion_log WHERE lead_id LIKE 'LEAD-MANUAL-176%'").run();r.logs=s.meta.changes||0,console.log(`üßπ [CLEANUP] Log eliminati: ${r.logs}`);const l=await t.env.DB.prepare("DELETE FROM lead_completion_tokens WHERE lead_id LIKE 'LEAD-MANUAL-176%'").run();r.tokens=l.meta.changes||0,console.log(`üßπ [CLEANUP] Token eliminati: ${r.tokens}`);const d=await t.env.DB.prepare("DELETE FROM contracts WHERE id LIKE 'CONTRACT-176%'").run();r.contracts=d.meta.changes||0,console.log(`üßπ [CLEANUP] Contratti eliminati: ${r.contracts}`);const c=await t.env.DB.prepare("DELETE FROM leads WHERE id LIKE 'LEAD-MANUAL-176%'").run();r.leads=c.meta.changes||0,console.log(`üßπ [CLEANUP] Lead eliminati: ${r.leads}`);const u=await t.env.DB.prepare("SELECT COUNT(*) as count FROM leads WHERE id LIKE 'LEAD-MANUAL-176%'").first(),p=(u==null?void 0:u.count)||0;return console.log(`‚úÖ [CLEANUP] Lead rimanenti: ${p}`),t.json({success:!0,message:"Cleanup completato con successo",environment:e,deleted:r,verification:{remaining_test_leads:p}})}catch(e){return console.error("‚ùå Errore cleanup:",e),t.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.post("/api/import/irbema/force",async t=>{var o,e;try{if(console.log("üîÑ [HUBSPOT FORCE] Inizio import FORZATO da HubSpot..."),!((o=t.env)!=null&&o.DB)||!((e=t.env)!=null&&e.HUBSPOT_ACCESS_TOKEN))return t.json({success:!1,error:"Configurazione mancante"},500);const a=t.env.HUBSPOT_ACCESS_TOKEN,i=["amministrazione@europa92.it","morroni.mariacarla55@gmail.com","lailamoustafa.pia@gmail.com","lucio.cam51@gmail.com"];let r=0;const s=[],l=await t.env.DB.prepare("SELECT id FROM leads WHERE id LIKE 'LEAD-IRBEMA-%' ORDER BY id DESC LIMIT 1").first();let d=128;if(l!=null&&l.id){const c=l.id.match(/LEAD-IRBEMA-(\d+)/);c&&(d=parseInt(c[1])+1)}for(const c of i)try{console.log(`üîç [HUBSPOT FORCE] Ricerca: ${c}`);const u="https://api.hubapi.com/crm/v3/objects/contacts/search",p={filterGroups:[{filters:[{propertyName:"email",operator:"EQ",value:c}]}],properties:["firstname","lastname","email","phone","mobilephone","company","hs_lead_status","createdate"]},g=await fetch(u,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify(p)});if(!g.ok){s.push(`${c}: Errore API ${g.status}`);continue}const m=await g.json();if(!m.results||m.results.length===0){s.push(`${c}: Non trovata su HubSpot`);continue}const b=m.results[0],h=b.properties,E=await t.env.DB.prepare("SELECT id FROM leads WHERE email = ? LIMIT 1").bind(c).first();if(E){console.log(`‚è≠Ô∏è [HUBSPOT FORCE] Gi√† esistente: ${c} ‚Üí ${E.id}`),s.push(`${c}: Gi√† presente come ${E.id}`);continue}const w=`LEAD-IRBEMA-${String(d).padStart(5,"0")}`;d++;const S=new Date().toISOString();await t.env.DB.prepare(`
          INSERT INTO leads (
            id, nomeRichiedente, cognomeRichiedente, email, telefono,
            servizio, piano, tipoServizio, fonte, status, vuoleBrochure, vuoleContratto,
            note, created_at, updated_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(w,h.firstname||"N/A",h.lastname||"N/A",c,h.phone||h.mobilephone||"","eCura PRO","BASE","eCura PRO","Form eCura","NEW","No","No",`HubSpot ID: ${b.id} | FORCED IMPORT`,S,S).run(),console.log(`‚úÖ [HUBSPOT FORCE] Importato: ${w} - ${h.firstname} ${h.lastname}`),r++}catch(u){console.error(`‚ùå [HUBSPOT FORCE] Errore ${c}:`,u),s.push(`${c}: ${u instanceof Error?u.message:String(u)}`)}return t.json({success:!0,message:"Force import completato",imported:r,errors:s.length>0?s:void 0,targetEmails:i})}catch(a){return console.error("‚ùå [HUBSPOT FORCE] Errore generale:",a),t.json({success:!1,error:a instanceof Error?a.message:String(a)},500)}});I.post("/api/setup-contracts-table",async t=>{var o;try{return(o=t.env)!=null&&o.DB?(await t.env.DB.prepare(`
      CREATE TABLE IF NOT EXISTS contracts (
        id TEXT PRIMARY KEY,
        leadId TEXT NOT NULL,
        status TEXT NOT NULL DEFAULT 'DRAFT',
        created_at TEXT NOT NULL DEFAULT (datetime('now')),
        updated_at TEXT NOT NULL DEFAULT (datetime('now')),
        codice_contratto TEXT,
        tipo_contratto TEXT,
        template_utilizzato TEXT,
        contenuto_html TEXT,
        pdf_url TEXT,
        pdf_generated INTEGER DEFAULT 0,
        prezzo_mensile REAL,
        durata_mesi INTEGER DEFAULT 12,
        prezzo_totale REAL,
        data_invio TEXT,
        data_scadenza TEXT,
        data_firma TEXT,
        email_sent INTEGER DEFAULT 0,
        email_template_used TEXT,
        piano TEXT,
        servizio TEXT,
        firma_digitale TEXT,
        ip_address TEXT,
        user_agent TEXT,
        assistito_id INTEGER
      )
    `).run(),await t.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_contracts_leadId ON contracts(leadId)").run(),await t.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_contracts_status ON contracts(status)").run(),await t.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_contracts_codice ON contracts(codice_contratto)").run(),t.json({success:!0,message:"Tabella contracts creata con successo"})):t.json({success:!1,error:"Database non configurato"},500)}catch(e){return console.error("Errore creazione tabella contracts:",e),t.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.post("/api/setup-intestatario-fields",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=["ALTER TABLE leads ADD COLUMN cfIntestatario TEXT","ALTER TABLE leads ADD COLUMN codiceFiscaleIntestatario TEXT","ALTER TABLE leads ADD COLUMN indirizzoIntestatario TEXT","ALTER TABLE leads ADD COLUMN capIntestatario TEXT","ALTER TABLE leads ADD COLUMN cittaIntestatario TEXT","ALTER TABLE leads ADD COLUMN provinciaIntestatario TEXT","ALTER TABLE leads ADD COLUMN luogoNascitaIntestatario TEXT","ALTER TABLE leads ADD COLUMN dataNascitaIntestatario TEXT","ALTER TABLE leads ADD COLUMN etaCalcolata INTEGER","CREATE INDEX IF NOT EXISTS idx_leads_cf_intestatario ON leads(cfIntestatario)","CREATE INDEX IF NOT EXISTS idx_leads_citta_intestatario ON leads(cittaIntestatario)"],a=[];for(const i of e)try{await t.env.DB.prepare(i).run(),a.push({sql:i,success:!0})}catch(r){r.message.includes("duplicate column")?a.push({sql:i,success:!0,note:"already exists"}):a.push({sql:i,success:!1,error:r.message})}return t.json({success:!0,message:"Migration intestatario completata",results:a})}catch(e){return console.error("Errore migration intestatario:",e),t.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.post("/api/admin/update-fonte-batch",async t=>{var o;try{if(!((o=t.env)!=null&&o.DB))return t.json({success:!1,error:"Database non configurato"},500);const e=await t.req.json(),{leadIds:a,fonte:i}=e;if(!Array.isArray(a)||a.length===0)return t.json({success:!1,error:"leadIds array vuoto o non valido"},400);if(!i)return t.json({success:!1,error:"fonte mancante"},400);console.log(`üìù Aggiornamento fonte per ${a.length} lead a: "${i}"`);let r=0,s=0;const l=[];for(const d of a)try{(await t.env.DB.prepare("UPDATE leads SET fonte = ?, updated_at = datetime('now') WHERE id = ?").bind(i,d).run()).success?r++:(s++,l.push({id:d,error:"Update failed"}))}catch(c){s++,l.push({id:d,error:c instanceof Error?c.message:String(c)})}return console.log(`‚úÖ Aggiornamento completato: ${r}/${a.length} successo`),t.json({success:!0,total:a.length,successCount:r,errorCount:s,errors:l.length>0?l:void 0,message:`Aggiornati ${r}/${a.length} lead con fonte: "${i}"`})}catch(e){return console.error("‚ùå Errore batch update fonte:",e),t.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.post("/api/admin/sync-form-ecura",async t=>{var o,e,a;try{console.log("üîÑ SYNC FORM ECURA: Inizio processo");const i=(o=t.env)==null?void 0:o.HUBSPOT_ACCESS_TOKEN,r=(e=t.env)==null?void 0:e.HUBSPOT_PORTAL_ID;if(!i||!r)return t.json({success:!1,error:"Credenziali HubSpot non configurate"},500);if(!((a=t.env)!=null&&a.DB))return t.json({success:!1,error:"Database non configurato"},500);console.log("‚úÖ Credenziali verificate");const{HubSpotClient:s}=await Promise.resolve().then(()=>ka),l=new s(i,r);console.log('üîç Query HubSpot: hs_object_source_detail_1 = "Form eCura"');const d=await l.searchContacts({hs_object_source_detail_1:"Form eCura",createdAfter:"2026-01-01",limit:100});if(console.log(`‚úÖ Trovati ${d.total} lead HubSpot con Form eCura`),d.results.length===0)return t.json({success:!0,message:"Nessun lead Form eCura trovato su HubSpot",hubspotTotal:0,matched:0,updated:0});const c=await t.env.DB.prepare("SELECT id, external_source_id, fonte, email, created_at FROM leads WHERE external_source_id IS NOT NULL").all();console.log(`üìä Lead locali con external_source_id: ${c.results.length}`);const u=[];for(const b of d.results){const h=b.id,E=c.results.find(w=>w.external_source_id===h);E&&u.push({leadId:E.id,hubspotId:h,email:E.email,fonteAttuale:E.fonte||"(vuota)",created_at:E.created_at})}if(console.log(`‚úÖ Matched: ${u.length}/${d.results.length}`),u.length===0)return t.json({success:!0,message:"Nessun lead matchato con il database locale",hubspotTotal:d.total,matched:0,updated:0,details:{hubspotLeads:d.results.map(b=>({id:b.id,email:b.properties.email,name:`${b.properties.firstname} ${b.properties.lastname}`}))}});let p=0,g=0;const m=[];for(const b of u)try{(await t.env.DB.prepare("UPDATE leads SET fonte = ?, updated_at = datetime('now') WHERE id = ?").bind("Form eCura",b.leadId).run()).success?p++:(g++,m.push({id:b.leadId,error:"Update failed"}))}catch(h){g++,m.push({id:b.leadId,error:h instanceof Error?h.message:String(h)})}return console.log(`‚úÖ Sync completato: ${p}/${u.length} aggiornati`),t.json({success:!0,message:`Sync completato: ${p}/${u.length} lead aggiornati`,hubspotTotal:d.total,matched:u.length,updated:p,errors:g,details:{matchedLeads:u.map(b=>({leadId:b.leadId,hubspotId:b.hubspotId,email:b.email,fonteVecchia:b.fonteAttuale,fonteNuova:"Form eCura"})),errorDetails:m.length>0?m:void 0}})}catch(i){return console.error("‚ùå Errore sync Form eCura:",i),t.json({success:!1,error:i instanceof Error?i.message:String(i),stack:i instanceof Error?i.stack:void 0},500)}});I.get("/api/health",async t=>{var i,r,s,l,d;const e="033b5c7",a="2026-02-12T17:03:00Z";try{const c={"firma-contratto.html":!1,"dashboard.html":!1,"index.html":!1};for(const m of Object.keys(c))try{const b=await t.env.ASSETS.fetch(new URL(`/${m}`,t.req.url));c[m]=b.ok}catch{c[m]=!1}let u="disconnected";try{(i=t.env)!=null&&i.DB&&(await t.env.DB.prepare("SELECT 1").first(),u="connected")}catch{u="error"}const p=c["firma-contratto.html"]&&c["dashboard.html"]&&u==="connected",g={status:p?"healthy":"degraded",version:"V12",commit:e,buildDate:a,timestamp:new Date().toISOString(),checks:{files:c,database:u,environment:{hasDB:!!((r=t.env)!=null&&r.DB),hasASSETS:!!((s=t.env)!=null&&s.ASSETS),hasEmailService:!!((l=t.env)!=null&&l.EMAIL_SERVICE),hasTwilioSID:!!((d=t.env)!=null&&d.TWILIO_ACCOUNT_SID)}},uptime:process.uptime?`${Math.floor(process.uptime())}s`:"N/A"};return t.header("X-System-Version","V12"),t.header("X-Git-Commit",e),t.header("X-Build-Date",a),t.header("X-Health-Status",g.status),t.json(g,p?200:503)}catch(c){return console.error("Health check error:",c),t.json({status:"error",version:"V12",commit:e,error:c instanceof Error?c.message:"Unknown error",timestamp:new Date().toISOString()},500)}});I.use("*",async(t,o)=>{const a="033b5c7";t.header("X-System-Version","V12"),t.header("X-Git-Commit",a),t.header("X-Powered-By","TeleMedCare-V12-Protected"),t.req.path.startsWith("/api/")&&console.log(`[V12] ${t.req.method} ${t.req.path}`),await o()});const qm=new Ng,_T=Object.assign({"/src/index.tsx":I});let u0=!1;for(const[,t]of Object.entries(_T))t&&(qm.all("*",o=>{let e;try{e=o.executionCtx}catch{}return t.fetch(o.req.raw,o.env,e)}),qm.notFound(o=>{let e;try{e=o.executionCtx}catch{}return t.fetch(o.req.raw,o.env,e)}),u0=!0);if(!u0)throw new Error("Can't import modules from ['/src/index.ts','/src/index.tsx','/app/server.ts']");function p0(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Yc={exports:{}},Ou,Ym;function OT(){if(Ym)return Ou;Ym=1;var t=1e3,o=t*60,e=o*60,a=e*24,i=a*7,r=a*365.25;Ou=function(u,p){p=p||{};var g=typeof u;if(g==="string"&&u.length>0)return s(u);if(g==="number"&&isFinite(u))return p.long?d(u):l(u);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(u))};function s(u){if(u=String(u),!(u.length>100)){var p=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(u);if(p){var g=parseFloat(p[1]),m=(p[2]||"ms").toLowerCase();switch(m){case"years":case"year":case"yrs":case"yr":case"y":return g*r;case"weeks":case"week":case"w":return g*i;case"days":case"day":case"d":return g*a;case"hours":case"hour":case"hrs":case"hr":case"h":return g*e;case"minutes":case"minute":case"mins":case"min":case"m":return g*o;case"seconds":case"second":case"secs":case"sec":case"s":return g*t;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return g;default:return}}}}function l(u){var p=Math.abs(u);return p>=a?Math.round(u/a)+"d":p>=e?Math.round(u/e)+"h":p>=o?Math.round(u/o)+"m":p>=t?Math.round(u/t)+"s":u+"ms"}function d(u){var p=Math.abs(u);return p>=a?c(u,p,a,"day"):p>=e?c(u,p,e,"hour"):p>=o?c(u,p,o,"minute"):p>=t?c(u,p,t,"second"):u+" ms"}function c(u,p,g,m){var b=p>=g*1.5;return Math.round(u/g)+" "+m+(b?"s":"")}return Ou}var Du,Zm;function DT(){if(Zm)return Du;Zm=1;function t(o){a.debug=a,a.default=a,a.coerce=c,a.disable=l,a.enable=r,a.enabled=d,a.humanize=OT(),a.destroy=u,Object.keys(o).forEach(p=>{a[p]=o[p]}),a.names=[],a.skips=[],a.formatters={};function e(p){let g=0;for(let m=0;m<p.length;m++)g=(g<<5)-g+p.charCodeAt(m),g|=0;return a.colors[Math.abs(g)%a.colors.length]}a.selectColor=e;function a(p){let g,m=null,b,h;function E(...w){if(!E.enabled)return;const S=E,C=Number(new Date),R=C-(g||C);S.diff=R,S.prev=g,S.curr=C,g=C,w[0]=a.coerce(w[0]),typeof w[0]!="string"&&w.unshift("%O");let z=0;w[0]=w[0].replace(/%([a-zA-Z%])/g,(F,L)=>{if(F==="%%")return"%";z++;const M=a.formatters[L];if(typeof M=="function"){const j=w[z];F=M.call(S,j),w.splice(z,1),z--}return F}),a.formatArgs.call(S,w),(S.log||a.log).apply(S,w)}return E.namespace=p,E.useColors=a.useColors(),E.color=a.selectColor(p),E.extend=i,E.destroy=a.destroy,Object.defineProperty(E,"enabled",{enumerable:!0,configurable:!1,get:()=>m!==null?m:(b!==a.namespaces&&(b=a.namespaces,h=a.enabled(p)),h),set:w=>{m=w}}),typeof a.init=="function"&&a.init(E),E}function i(p,g){const m=a(this.namespace+(typeof g>"u"?":":g)+p);return m.log=this.log,m}function r(p){a.save(p),a.namespaces=p,a.names=[],a.skips=[];const g=(typeof p=="string"?p:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const m of g)m[0]==="-"?a.skips.push(m.slice(1)):a.names.push(m)}function s(p,g){let m=0,b=0,h=-1,E=0;for(;m<p.length;)if(b<g.length&&(g[b]===p[m]||g[b]==="*"))g[b]==="*"?(h=b,E=m,b++):(m++,b++);else if(h!==-1)b=h+1,E++,m=E;else return!1;for(;b<g.length&&g[b]==="*";)b++;return b===g.length}function l(){const p=[...a.names,...a.skips.map(g=>"-"+g)].join(",");return a.enable(""),p}function d(p){for(const g of a.skips)if(s(p,g))return!1;for(const g of a.names)if(s(p,g))return!0;return!1}function c(p){return p instanceof Error?p.stack||p.message:p}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return a.enable(a.load()),a}return Du=t,Du}var Xm;function MT(){return Xm||(Xm=1,(function(t,o){var e={};o.formatArgs=i,o.save=r,o.load=s,o.useColors=a,o.storage=l(),o.destroy=(()=>{let c=!1;return()=>{c||(c=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),o.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function a(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let c;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(c=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(c[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function i(c){if(c[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+c[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const u="color: "+this.color;c.splice(1,0,u,"color: inherit");let p=0,g=0;c[0].replace(/%[a-zA-Z%]/g,m=>{m!=="%%"&&(p++,m==="%c"&&(g=p))}),c.splice(g,0,u)}o.log=console.debug||console.log||(()=>{});function r(c){try{c?o.storage.setItem("debug",c):o.storage.removeItem("debug")}catch{}}function s(){let c;try{c=o.storage.getItem("debug")||o.storage.getItem("DEBUG")}catch{}return!c&&typeof process<"u"&&"env"in process&&(c=e.DEBUG),c}function l(){try{return localStorage}catch{}}t.exports=DT()(o);const{formatters:d}=t.exports;d.j=function(c){try{return JSON.stringify(c)}catch(u){return"[UnexpectedJSONParseError]: "+u.message}}})(Yc,Yc.exports)),Yc.exports}var zT=MT();const LT=p0(zT),NT=Object.freeze(Object.defineProperty({__proto__:null,default:LT},Symbol.toStringTag,{value:"Module"}));var Mu,Jm;function PT(){return Jm||(Jm=1,Mu=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")}),Mu}var BT=PT();const kT=p0(BT);/**
 * @license
 * Copyright 2018 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Do;const um=class um{constructor(o){f(this,Do);O(this,"onmessage");O(this,"onclose");v(this,Do,o),n(this,Do).addEventListener("message",e=>{this.onmessage&&this.onmessage.call(null,e.data)}),n(this,Do).addEventListener("close",()=>{this.onclose&&this.onclose.call(null)}),n(this,Do).addEventListener("error",()=>{})}static create(o,e){return new Promise((a,i)=>{const r=new kT(o,[],{followRedirects:!0,perMessageDeflate:!1,allowSynchronousEvents:!1,maxPayload:268435456,headers:{"User-Agent":`Puppeteer ${Zp}`,...e}});r.addEventListener("open",()=>a(new um(r))),r.addEventListener("error",i)})}send(o){n(this,Do).send(o)}close(){n(this,Do).close()}};Do=new WeakMap;let Fp=um;const FT=Object.freeze(Object.defineProperty({__proto__:null,NodeWebSocketTransport:Fp},Symbol.toStringTag,{value:"Module"}));function $T(t){if(!t)return null;try{let o;if(t.match(/^\d{4}-\d{2}-\d{2}$/))o=new Date(t);else if(t.match(/^\d{2}\/\d{2}\/\d{4}$/)){const[r,s,l]=t.split("/");o=new Date(`${l}-${s}-${r}`)}else if(t.match(/^\d{2}-\d{2}-\d{4}$/)){const[r,s,l]=t.split("-");o=new Date(`${l}-${s}-${r}`)}else return null;if(isNaN(o.getTime()))return null;const e=new Date;let a=e.getFullYear()-o.getFullYear();const i=e.getMonth()-o.getMonth();return(i<0||i===0&&e.getDate()<o.getDate())&&a--,a>=0?a:null}catch(o){return console.error("Errore calcolo et√†:",o),null}}const UT=Object.freeze(Object.defineProperty({__proto__:null,calcolaEta:$T},Symbol.toStringTag,{value:"Module"})),m0=129,g0=JSON.parse(`[{"excel_row":6,"data_arrivo":"2025-03-01","nome":"Claudio Macchi","email":"claudio.macchi1@libero.it","telefono":"3398183049","canale":"IRBEMA","location":"","messaggio":"Gradirei conoscere il prezzo del dispositivo.","note":"whatsapp 8/4","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00001"},{"excel_row":7,"data_arrivo":"2025-03-01","nome":"Daniela Bisson","email":"bissondaniela2018@gmail.com","telefono":"3336364976","canale":"IRBEMA","location":"","messaggio":"Richiesta informazioni per pap√† 87 anni vive da solo","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00002"},{"excel_row":8,"data_arrivo":"2025-03-06","nome":"Anna Moro","email":"moro.annamaria@yahoo.it","telefono":"3348389365","canale":"IRBEMA","location":"","messaggio":"Salve per vortesia vorrei sapere il costo dell orologio Cordialmente Moro","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00003"},{"excel_row":9,"data_arrivo":"2025-03-13","nome":"Maria Aldeghi","email":"vittoriaaldeghi@gmail.com","telefono":"3332897971","canale":"IRBEMA","location":"","messaggio":"Volevo avere pi√π informazioni del prodotto a uso privati","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00004"},{"excel_row":10,"data_arrivo":"2025-03-20","nome":"Vivian Pontarini","email":"vivianpontarin@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"Buongiorno, sto cercando un dispositivo di sicurezza per mio padre anziano che vive da solo","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00005"},{"excel_row":11,"data_arrivo":"2025-03-21","nome":"Giuseppe Porretta","email":"","telefono":"3662043768","canale":"IRBEMA","location":"Provincia di Frosinone","messaggio":"Ci ha contatto un potenziale cliente finale interessato ad un braccialetto SiDLY per la madre fragile.","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00006"},{"excel_row":12,"data_arrivo":"2025-03-22","nome":"Manuela Poggi","email":"manuela.poggi1@icloud.com","telefono":"","canale":"IRBEMA","location":"Bologna","messaggio":"Sarei interessato al vostro bracciale salva vita mi potete contattare grazie","note":"08/05/2025 inviato contratto. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00007"},{"excel_row":13,"data_arrivo":"2025-03-22","nome":"Katia Dondero","email":"katiadondero@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"Informazioni bracciale Sidly","note":"Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00008"},{"excel_row":14,"data_arrivo":"2025-03-31","nome":"Anna Maria Avenia","email":"aveniaannamaria@gmail.com","telefono":"3280466133","canale":"IRBEMA","location":"","messaggio":"Vorrei sapere il prezzo","note":"whatsapp 8/4. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00009"},{"excel_row":15,"data_arrivo":"2025-03-31","nome":"Alessandra PAVANELLO","email":"alealzira@gmail.com","telefono":"34676198737","canale":"IRBEMA","location":"","messaggio":"MI INTERESSA SIDLY","note":"Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00010"},{"excel_row":16,"data_arrivo":"2025-03-31","nome":"Marilena Cardoni","email":"marilenacardoni43@gmail.com","telefono":"3382489222","canale":"IRBEMA","location":"","messaggio":"Interessata x mio marito per varie patologie","note":"Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00011"},{"excel_row":17,"data_arrivo":"2025-03-31","nome":"Angela Rotatori","email":"angelarotatori@gmail.com","telefono":"3478477590","canale":"IRBEMA","location":"","messaggio":"Salve vorrei info sui costi grazie","note":"Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00012"},{"excel_row":18,"data_arrivo":"2025-03-31","nome":"Emilio Martire","email":"emiliomartire1@gmail.com","telefono":"3688049329","canale":"IRBEMA","location":"","messaggio":"Salve, Sono interessato a braccialetto per anziani.","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00013"},{"excel_row":19,"data_arrivo":"2025-03-31","nome":"Daniel Sutera","email":"daniel.sutera@virgilio.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"info bracciale","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00014"},{"excel_row":20,"data_arrivo":"2025-03-31","nome":"Sig. Giuseppe Porretta","email":"","telefono":"3662043768","canale":"IRBEMA","location":"","messaggio":"Provincia di Frosinone","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00015"},{"excel_row":21,"data_arrivo":"2025-03-31","nome":"Alina Macii","email":"maciialina@gmail.com","telefono":"3776759169","canale":"IRBEMA","location":"","messaggio":"Buon Pomeriggio.Voglio avere informazioni su questo orologio di telemedicina","note":"Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00016"},{"excel_row":22,"data_arrivo":"2025-03-31","nome":"Antonella Iacovitti","email":"antonellaiacovitti@gmail.com","telefono":"3385643188","canale":"IRBEMA","location":"Roma","messaggio":"Informazioni","note":"Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00017"},{"excel_row":23,"data_arrivo":"2025-04-02","nome":"Francesca Amaddeo","email":"francescaamaddeo@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00018"},{"excel_row":24,"data_arrivo":"2025-04-03","nome":"Elena Saglia","email":"elenasaglia@hotmail.com","telefono":"3493416242","canale":"IRBEMA","location":"Cernusco sul Naviglio (MI)","messaggio":"","note":"5/05 inviato contratto avanzato","status":"CONVERTED","assistito":"","id":"LEAD-IRBEMA-00019"},{"excel_row":25,"data_arrivo":"2025-04-07","nome":"Lead Anonimo - kimiamamisegua@live.it","email":"kimiamamisegua@live.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"Salvavita di cosa si tratta quanto costa","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00020"},{"excel_row":26,"data_arrivo":"2025-04-07","nome":"Pierluigi Etzi","email":"pierluigietzi69@libero.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00021"},{"excel_row":27,"data_arrivo":"2025-04-07","nome":"Tiziana Curto/ frisardi","email":"tiziana.curto64@gmail.com","telefono":"3356253956","canale":"IRBEMA","location":"","messaggio":"Vorrei un preventivo oer un dispositivo facile da utilizzare e sicuro in caso di malore di mia nadre","note":"whatsapp 8/4. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00022"},{"excel_row":28,"data_arrivo":"2025-04-08","nome":"Raffaele Di martino","email":"dimartino.raffaele@virgilio.it","telefono":"3355292860","canale":"IRBEMA","location":"","messaggio":"Presidente AVIS Napoli. Informazioni sul braccialetto anziano","note":"whatsapp 8/4. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00023"},{"excel_row":29,"data_arrivo":"2025-04-10","nome":"Sabina Pascuttini","email":"passabi@gmail.com","telefono":"3318303852","canale":"IRBEMA","location":"","messaggio":"Informazioni su contratto, costi","note":"whatsapp 10/4. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00024"},{"excel_row":30,"data_arrivo":"2025-04-23","nome":"Imma Grimaldi","email":"","telefono":"+393928995340","canale":"IRBEMA","location":"","messaggio":"","note":"whatsapp 23/4. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00025"},{"excel_row":31,"data_arrivo":"2025-04-23","nome":"Tatiana","email":"","telefono":"+39 338 690 1311","canale":"IRBEMA","location":"","messaggio":"","note":"whatsapp 23/4. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00026"},{"excel_row":32,"data_arrivo":"2025-04-23","nome":"Gaetano Santamaria","email":"","telefono":"+39 335 599 6265","canale":"IRBEMA","location":"","messaggio":"","note":"whatsapp 23/4. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00027"},{"excel_row":33,"data_arrivo":"2025-04-23","nome":"Mariaelena Torrisi","email":"","telefono":"393402534586","canale":"IRBEMA","location":"","messaggio":"","note":"whatsapp 23/4. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00028"},{"excel_row":34,"data_arrivo":"2025-04-24","nome":"Simone Corpino","email":"simonecorpino@gmail.com","telefono":"3485650603","canale":"IRBEMA","location":"","messaggio":"","note":"whatsapp 2/5.il 16/10 non √® pi√π su whatsapp","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00029"},{"excel_row":35,"data_arrivo":"2025-04-25","nome":"Caterina D‚ÄôAlterio","email":"caterinadalterio108@gmail.com","telefono":"3898006744","canale":"IRBEMA","location":"Giugliano Napoli","messaggio":"","note":"08/05/2025 inviato contratto base","status":"CONVERTED","assistito":"","id":"LEAD-IRBEMA-00030"},{"excel_row":36,"data_arrivo":"2025-04-26","nome":"Mauro Reggi","email":"","telefono":"3289051937","canale":"IRBEMA","location":"","messaggio":"","note":"whatsapp 1/5. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00031"},{"excel_row":37,"data_arrivo":"2025-04-30","nome":"Nicola","email":"immobiliarenicola@gmail.com","telefono":"3517011414","canale":"IRBEMA","location":"","messaggio":"","note":"whatsapp 30/4. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00032"},{"excel_row":38,"data_arrivo":"2025-05-01","nome":"Simona Pizzutto","email":"","telefono":"3450016665","canale":"IRBEMA","location":"San Mauro Torinese (TO)","messaggio":"","note":"08/05/2025 inviato contratto base","status":"CONVERTED","assistito":"","id":"LEAD-IRBEMA-00033"},{"excel_row":39,"data_arrivo":"2025-05-02","nome":"ANTONIA Bonavita","email":"antobonavita@libero.it","telefono":"3386484910","canale":"IRBEMA","location":"","messaggio":"","note":"7 e 8/05 inviato whatsapp. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00034"},{"excel_row":40,"data_arrivo":"2025-05-03","nome":"Barbara Camorani","email":"barbara.camorani@regione.liguria.it","telefono":"3405635515","canale":"IRBEMA","location":"","messaggio":"richiesta prova gratuita per un mese. Glielo abbiamo concesso ma la madre non vuole provare","note":"prima voleva fare una prova poi ha cambiato idea. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00035"},{"excel_row":41,"data_arrivo":"2025-05-04","nome":"Anna Posa","email":"annablu01@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00036"},{"excel_row":42,"data_arrivo":"2025-05-13","nome":"Isabella Consoloni","email":"isabella.consoloni@libero.it","telefono":"3381714788","canale":"IRBEMA","location":"","messaggio":"Salve volevo sapere quanto costa e dov'√® compralo e dov E comprarlo Gr","note":"la madre √® morta. Non serve pi√π il dispositivo","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00037"},{"excel_row":43,"data_arrivo":"2025-05-13","nome":"Roberta Verazzo","email":"verazzoroberta@yahoo.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00038"},{"excel_row":44,"data_arrivo":"2025-05-14","nome":"Giovanna Salvidio","email":"avv.giovannasalvidio@gmail.com","telefono":"3930620563","canale":"IRBEMA","location":"","messaggio":"","note":"28/07 inviato whatsapp. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00039"},{"excel_row":51,"data_arrivo":"2025-05-14","nome":"CARLA MAGLIOCCHETTI","email":"carla.magliocchetti@libero.it","telefono":"3346452561","canale":"IRBEMA","location":"","messaggio":"","note":"costi troppo elevati","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00040"},{"excel_row":45,"data_arrivo":"2025-05-21","nome":"Maria","email":"altamarea.2018@libero.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00041"},{"excel_row":46,"data_arrivo":"2025-05-22","nome":"EMANUELA BALZAROTTI","email":"emanuelabalzarotti@libero.it","telefono":"3389414462","canale":"IRBEMA","location":"","messaggio":"Desidero un preventivo per mia suocera grazie","note":"25/6 contattata, lei ci crede molto. La suocera non vuole.Da settembre far√† assistenza ad anziani autosufficienti per pratiche burocratiche ad Ogiati Olona (VA)  . Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00042"},{"excel_row":47,"data_arrivo":"2025-05-22","nome":"TONINO FICICCHIA","email":"toninoficicchia4@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"Salve che prezzo fa mia madre a la 104 e invalida","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00043"},{"excel_row":48,"data_arrivo":"2025-05-25","nome":"Luciana garrisi","email":"lucianagarrisi@libero.it","telefono":"3349057602","canale":"IRBEMA","location":"","messaggio":"","note":"26/05 inviato whatsapp. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00044"},{"excel_row":50,"data_arrivo":"2025-05-26","nome":"MONICA MORELLI","email":"avv.morellimonica@gmail.com","telefono":"3387318749","canale":"IRBEMA","location":"","messaggio":"","note":"inivato whatsapp. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00045"},{"excel_row":49,"data_arrivo":"2025-05-27","nome":"Giorgia Origa","email":"giorgiaoriga@gmail.com","telefono":"3288610478","canale":"IRBEMA","location":"","messaggio":"Vorrei informazioni per mia madre","note":"25/6 contattata, la madre non sta bene. Mi richimer√† lei. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00046"},{"excel_row":52,"data_arrivo":"2025-05-28","nome":"Claudio Fontana","email":"fontanaclaudio@hotmail.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00047"},{"excel_row":53,"data_arrivo":"2025-05-28","nome":"Claudia Peron","email":"claudiaperon07@gmail.com","telefono":"3498421721","canale":"IRBEMA","location":"","messaggio":"","note":"richiamare il 10/6 ore 12. Non risponde. Richiamata il 25/6 non risponde inviato whatsapp. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00048"},{"excel_row":55,"data_arrivo":"2025-05-29","nome":"MONICA TERRAGNI","email":"terragni.monica@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00049"},{"excel_row":54,"data_arrivo":"2025-05-30","nome":"FRANCESA CAROFEI","email":"fra.carofei@icloud.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00050"},{"excel_row":56,"data_arrivo":"2025-06-03","nome":"Silvia Grossi","email":"1967silvia@tiscali.it","telefono":"3394296488","canale":"IRBEMA","location":"","messaggio":"Salve, vorrei informazioni sul vostro prodotto. Grazie","note":"Richiamare. Ha mal di testa. Richiamata il 25/6 e le inviato nuovamente tutto perch√© prima non aveva letto. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00051"},{"excel_row":57,"data_arrivo":"2025-06-03","nome":"GIOVANNI LOLLI","email":"giovanni.lollig@gmail.com","telefono":"3247972835","canale":"IRBEMA","location":"","messaggio":"Vorrei saperne di pi√π","note":"NON E' Pi√π INTERESSATO","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00052"},{"excel_row":58,"data_arrivo":"2025-06-03","nome":"Maria Di Nuzzo","email":"amariadinuzzo358@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00053"},{"excel_row":59,"data_arrivo":"2025-06-04","nome":"CONCETTA","email":"concettacinardo@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00054"},{"excel_row":60,"data_arrivo":"2025-06-04","nome":"Antonella Robbiani","email":"arobbiani@hotmail.com","telefono":"335258091","canale":"IRBEMA","location":"","messaggio":"","note":"9/6 ho chiamato non risponde. 25/6 richiamata e il cellulare √® spento.Inviato whatsapp","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00055"},{"excel_row":61,"data_arrivo":"2025-06-05","nome":"Paola Giacobelli","email":"paolagiacobelli@yahoo.it","telefono":"3348810542","canale":"IRBEMA","location":"","messaggio":"","note":"mi ha buttato gi√π il telefono. Mi ha richiamato. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00056"},{"excel_row":62,"data_arrivo":"2025-06-09","nome":"Dorella Soatto","email":"dorellasoatto@libero.it","telefono":"3382896878","canale":"IRBEMA","location":"","messaggio":"Buongiorno, vorrei essere contattato per un preventivo per il braccialetto Sidly. Grazie","note":"mi ha scritto subito un'email. Ho parlato con la figlia. Interessati solo al base no centrale operativa. Chiamata la madre il 25/6 non risponde, inviato whatsapp. Hanno scelto un altro dipositivo","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00057"},{"excel_row":63,"data_arrivo":"2025-06-09","nome":"Elisabetta Ghidella","email":"elisabettaghidella@gmail.com","telefono":"3343442458","canale":"IRBEMA","location":"","messaggio":"Buongiorno vorrei avere maggiori informazioni. Grazie","note":"9/6 ho chiamato non risponde. 25/6 richiamata non risponde. Inviato whatsapp","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00058"},{"excel_row":64,"data_arrivo":"2025-06-09","nome":"Giancarlo Fissone","email":"iguana710@gmail.com","telefono":"3927179250","canale":"IRBEMA","location":"Bussoleno - Susa (TO)","messaggio":"Salve volevo chiederti informazioni riguardo il bracciale per quanto riguarda mia mamma prima di chiamare inviatemi un messaggio o un wathsapp grazie mille","note":"9/06  ha contattato il figlio per la madre. Richiama. E' interessato al base. Richiamato il 25/06 deve ancora parlarne con la sorella. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00059"},{"excel_row":65,"data_arrivo":"2025-06-11","nome":"Sig. Froilan","email":"usa.rossacroce@gmail.com","telefono":"","canale":"IRBEMA","location":"Roma","messaggio":"","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00060"},{"excel_row":66,"data_arrivo":"2025-06-11","nome":"Giorgio Riela","email":"gr@ecotorino.it","telefono":"0117395260","canale":"IRBEMA","location":"","messaggio":"Buongiorno, ho acquistato per mia madre e mia suocera due bracciali seremy, di cui sono profondamente scontento per la pessima assistenza post vendita, per cui sto cercando delle alternative. Voi potreste fare al caso mio? Cordiali saluti Giorgio Riela","note":"la moglie ha avuto un incidente. Richiamer√†. Abbiamo fatto sconto di 40‚Ç¨ e 140‚Ç¨","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00061"},{"excel_row":67,"data_arrivo":"2025-06-11","nome":"Paolo Magri","email":"paolo@paolomagri.com","telefono":"+41793311949","canale":"IRBEMA","location":"Como","messaggio":"","note":"25/6 inviato contratto teleassistenza base","status":"CONVERTED","assistito":"","id":"LEAD-IRBEMA-00062"},{"excel_row":68,"data_arrivo":"2025-06-13","nome":"Sindaco Delvigo","email":"sindacodelvigo@gmail.com","telefono":"3803263069","canale":"IRBEMA","location":"","messaggio":"","note":"ha risposto al telefono il 25 giugno, richiama il 26 per fare delle domande. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00063"},{"excel_row":70,"data_arrivo":"2025-06-16","nome":"Elena Bodini","email":"elenabodini5@gmail.com","telefono":"3392045623","canale":"IRBEMA","location":"Lodi - Lombardia","messaggio":"Vorrei info. Mia made 90enne vive da sola in in'altra citt√†","note":"richiamata il 25 giugno e non aveva ricevuto email e whatsapp. Adesso s√¨. 21/7 richiamata e rinviata email e whatsapp. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00064"},{"excel_row":71,"data_arrivo":"2025-06-16","nome":"Giuseppina","email":"apinucciadaluiso@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"non risponde","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00065"},{"excel_row":69,"data_arrivo":"2025-06-17","nome":"Aurora Teruggi","email":"a.teruggi@virgilio.it","telefono":"3496156239","canale":"IRBEMA","location":"Milano","messaggio":"Il vostro dispositivo pu√≤ essere utilizzato da anziani al proprio domicilio non inseriti in progetti innovativi come quello di Desio?nello specifico sarei interessata a capire se il vostro sistema potrebbe essere utile per mio padre che vive a Milani, al proprio domicilio ed il relativo costo","note":"signora molto interessata e preparato. Padre con defibrillatore. Conosce progetto Desio e CURA. Richiamata il 25 giugno non risponde. Inviato whatsapp con brochure sidly. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00066"},{"excel_row":72,"data_arrivo":"2025-06-25","nome":"Laura Calvi","email":"","telefono":"","canale":"NETWORKING","location":"Genova - Liguria","messaggio":"","note":"MAMMA STEFANIA ROCCA","status":"CONVERTED","assistito":"","id":"LEAD-NETWORKING-00001"},{"excel_row":73,"data_arrivo":"2025-06-27","nome":"Michele Amoruso","email":"ammiche@tiscali.it","telefono":"3472120496","canale":"IRBEMA","location":"Sardegna","messaggio":"Mediobanca/Informazioni sul bracialetto","note":"sentito telefonicamente - richiamato i11/07 la madre si sente troppo autonoma. Ci riprova e mi far√† sapere. TROPPO CARO PER LUI. VORREBBE PAGARE MENSILMENTE","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00067"},{"excel_row":75,"data_arrivo":"2025-07-01","nome":"Giulia Clementi","email":"","telefono":"3494378160","canale":"IRBEMA","location":"Paderno Dugnano","messaggio":"","note":"sentita telefonicamente e inviataproposta via whatsapp - richiamata l'11/7 non hanno ancora deciso, prezzo alto. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00068"},{"excel_row":74,"data_arrivo":"2025-07-02","nome":"Carmen Tierno","email":"cartier.05@libero.it","telefono":"3394745902","canale":"IRBEMA","location":"Avellino - Campania","messaggio":"","note":"sentita telefonicamente - richiamata l'11/7 non risponde. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00069"},{"excel_row":76,"data_arrivo":"2025-07-03","nome":"Raffaella Casubolo","email":"raffaellacasubolo71@gmail.com","telefono":"","canale":"IRBEMA","location":"Roma - Lazio","messaggio":"Vorrei gentilmente un preventivo esclusivamente via email","note":"chiamata 11/7 non risponde - inviato whatsapp - cellulare sbagliato - cancellato cellulare","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00070"},{"excel_row":77,"data_arrivo":"2025-07-04","nome":"Antonella Barbone","email":"","telefono":"3388821280","canale":"IRBEMA","location":"","messaggio":"sorella di sua mamma ha 92 anni. Ricoverata ed esce a fine luglio","note":"inviato whatsapp mail. Ci sta pensando in data 28/07. Il 16/10 Inviato whatsapp con nuova brochure. Non ha le disponibilit√† economiche","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00071"},{"excel_row":78,"data_arrivo":"2025-07-07","nome":"Elisabetta Cattini","email":"elisabettacattini@gmail.com","telefono":"393200811667","canale":"IRBEMA","location":"Olgiate Olona - Lombardia","messaggio":"","note":"inviato whatsapp + call non risponde. Chiamata 11/7 inviato anche whatsapp","status":"CONVERTED","assistito":"","id":"LEAD-IRBEMA-00072"},{"excel_row":79,"data_arrivo":"2025-07-08","nome":"Diego Dainese","email":"studio2dvigonza@gmail.com","telefono":"348999318","canale":"IRBEMA","location":"Padova - Veneto","messaggio":"","note":"inviata email - il cellulare √® sbagliato - 21/07 scritta altra email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00073"},{"excel_row":80,"data_arrivo":"2025-07-12","nome":"Claudio La Viola","email":"clalav74@libero.it","telefono":"3270962223","canale":"IRBEMA","location":"Palermo - Sicilia","messaggio":"Desidero avere altre informazioni. Grazie","note":"inviata email e whatsapp - 21/7 richiamato ma ha riagganciato. Il padre ha 87 anni","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00074"},{"excel_row":81,"data_arrivo":"2025-07-14","nome":"Barbara Campi","email":"campi.barbara@yahoo.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email - 21/7 rinviata email con richiesta conferma ricezione.","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00075"},{"excel_row":82,"data_arrivo":"2025-07-15","nome":"Lombardi Addolorata","email":"presidelombardi@gmail.com","telefono":"3382295587","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email - contattata telefonicamente ci pensa e mi fa sapere. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00076"},{"excel_row":83,"data_arrivo":"2025-07-16","nome":"Leonardo Perini","email":"perini.spoleto@gmail.com","telefono":"3336297471","canale":"IRBEMA","location":"","messaggio":"vorrei conoscere il prezzo le modalit√† acquisto o noleggio, il canone per la teleassistenza","note":"inviata email - whatsapp - 21/7 chiamato ma √® in riunione. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00077"},{"excel_row":84,"data_arrivo":"2025-07-21","nome":"Grazia Fiumana","email":"graziafiumana@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00078"},{"excel_row":85,"data_arrivo":"2025-07-21","nome":"Stefania Albertin","email":"albertinstefania@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00079"},{"excel_row":86,"data_arrivo":"2025-07-21","nome":"Arianna Sichich","email":"ari.sichich@gmail.com","telefono":"3460789840","canale":"IRBEMA","location":"Bergamo - Lombardia","messaggio":"Vorrei avere maggiori imformazioni sulle caratteristiche del prodotto e costo","note":"inviata email con proposta.  Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00080"},{"excel_row":88,"data_arrivo":"2025-07-24","nome":"Andrea Spelta","email":"speltaandrea@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviatata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00081"},{"excel_row":87,"data_arrivo":"2025-07-25","nome":"Simonetta","email":"","telefono":"3201965501","canale":"IRBEMA","location":"Firenze - Toscana","messaggio":"","note":"inviato whatsapp no email e contattata .  Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00082"},{"excel_row":89,"data_arrivo":"2025-07-27","nome":"Giovanni Dandraia","email":"dandraia.g@gmail.com","telefono":"3487282428","canale":"IRBEMA","location":"VIETRI DI POTENZA (PZ) BASILICATA","messaggio":"","note":"inviata email, whatsapp e call. Chiamato il 23/09: Invio contratto base","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00083"},{"excel_row":90,"data_arrivo":"2025-07-28","nome":"Norma Giannetti","email":"","telefono":"3471226301","canale":"IRBEMA","location":"Milano","messaggio":"voleva sapere i prezzi - molto frettolosa","note":"inivato whatsapp, sms e call. Chiamata il 23/09 ma non risponde.  Il 16/10 chiamato e ha riagganciato. Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00084"},{"excel_row":91,"data_arrivo":"2025-07-29","nome":"Elia Citro","email":"eliocitro7@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00085"},{"excel_row":92,"data_arrivo":"2025-07-29","nome":"Serena De Ponto","email":"depontomariaserena@gmail.com","telefono":"3514455108","canale":"IRBEMA","location":"Nettuno - Lazio","messaggio":"","note":"inviato whatsapp e email. Il 4/8 call ma non risponde. 8/9 inviato un whatsapp. 23/09 chiamata ma non risponde.  Il 16/10 chiamato e ha riagganciato. Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00086"},{"excel_row":93,"data_arrivo":"2025-07-31","nome":"Valeria Zafon","email":"valeria.zaf@gmail.com","telefono":"+393483725032","canale":"IRBEMA","location":"Venezia - Veneto","messaggio":"","note":"inviata email e whatsapp. 8/9 inviato un whatsapp. Chiamata il 23/09 ed √® occupata.  Il 16/10 chiamato e ha riagganciato. Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00087"},{"excel_row":94,"data_arrivo":"2025-08-04","nome":"Cristiana Rugggeri","email":"cristianaruggeri2611@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00088"},{"excel_row":95,"data_arrivo":"2025-08-25","nome":"Maria Ricciardelli","email":"ricciardelli.ela@gmail.com","telefono":"3496428227","canale":"IRBEMA","location":"Lecco - Lombardia","messaggio":"","note":"inviata email e whatsapp. 8/9 inviato un whatsapp. Ha bisogno di chiarimenti ma non ha tempo. 23/09 chiamata ma non risponde","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00089"},{"excel_row":96,"data_arrivo":"2025-08-27","nome":"Gabriella Azzaro","email":"annamariagabriellaazzaro757@gmail.com","telefono":"3911858536","canale":"IRBEMA","location":"Torino - Piemonte","messaggio":"VORREI UNA PROTEZIONE DA EVENTUALI MALESSERI","note":"inviata email e whatsapp. 3/9 inviato un whatsapp mi far√† sapere. 23/09 chiamata e lasciato messaggio in segreteria.  Il 16/10 chiamato e ha riagganciato. Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00090"},{"excel_row":97,"data_arrivo":"2025-08-27","nome":"Carla martini","email":"c.martini2009@libero.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00091"},{"excel_row":100,"data_arrivo":"2025-08-28","nome":"Paola Scarpin","email":"","telefono":"3404686122","canale":"IRBEMA","location":"Cervignano del Friuli","messaggio":"","note":"inviato whatsapp. Mi ha chiamato ha madre 85y su sedia a rotelle che non parla e vorrebbe un telemonitoraggio dei parametri vitali che mandino degli allert in caso si soffocasse ecc","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00092"},{"excel_row":98,"data_arrivo":"2025-08-29","nome":"Michele Lorieri","email":"lorierimichele@gmail.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"vorrei sapere il costo del bracciale e del servizio perch√© vorrei regalarlo a mia mamma","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00093"},{"excel_row":99,"data_arrivo":"2025-08-29","nome":"Ds Valerani","email":"dsvalerani@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"il bracciale sidly care pro oltre all'acquisto ha un canone annuo? Come funziona il centro che risponde all'SOS?","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00094"},{"excel_row":101,"data_arrivo":"2025-08-31","nome":"Adriana Mulassano","email":"audrey.mulassano@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00095"},{"excel_row":102,"data_arrivo":"2025-08-31","nome":"Ettore Destro","email":"ettoredestro@gmail.com","telefono":"+393273118009","canale":"IRBEMA","location":"Como - Lombardia","messaggio":"Medico. Sono interessato per monitorare i miei genitori di 90 e 88 anni. Lucidi efficienti autonomi ma che abitano da soli. \\nPer favore inviatemi un sms o un wa dicendo che mi state contattando telefonicamente, Grazie","note":"inviata email e whatsapp. 8/9 inviato un whatsapp. Chiamato il 23/09 vuole che invii un contratto per due dispositivi con centrale operativa sconto 5%","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00096"},{"excel_row":103,"data_arrivo":"2025-09-01","nome":"francesco pepe","email":"cicciopepe@libero.it","telefono":"+393317545440","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email e whatsapp. Mi far√† sapere settimana 8/09. Chiamato il 23/09 non risponde, inviato whtsapp.  Il 16/10 chiamato e ha riagganciato. Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00097"},{"excel_row":104,"data_arrivo":"2025-09-02","nome":"Mauro Giumelli","email":"maurogiumelli1952@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00098"},{"excel_row":105,"data_arrivo":"2025-09-05","nome":"Maria Cristina Sorcini","email":"cristinasorcini@yahoo.it","telefono":"+393470562139","canale":"IRBEMA","location":"Perugia - Umbria","messaggio":"","note":"inviata email e whatsapp. Chiamat il 23/09. Costa troppo. Era per lei e non pu√≤ permetterselo","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00099"},{"excel_row":106,"data_arrivo":"2025-09-07","nome":"Norma Zanetta","email":"zanetta.norma64@gmail.com","telefono":"3409854064","canale":"IRBEMA","location":"Borgomanero - Piemonte","messaggio":"Buongiorno sto cercando un valido servizio di teleassistenza per mio padre 90 enne","note":"inviata email e whatsapp. Chiamata il 23/09 mette il padre in struttura","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00100"},{"excel_row":108,"data_arrivo":"2025-09-08","nome":"Luca Nadali","email":"luca.nadali@gmail.com","telefono":"+39 328 95 12 054","canale":"IRBEMA","location":"","messaggio":"Buongiorno, ho 48 anni ma soffro di una malattia polmonare (bronchiectasie e asma) che mi causa, in momenti non sospetti, carenza di ossigeno con svenimento. Sia per lavoro che in attivit√† sportive spesso sono da solo e in famiglia stavamo valutando un sistema di rilevazione cadute o sistema rapido di richiesta aiuto.\\nIl vostro bracciale pu√≤ soddisfare queste necessit√†.\\nQuanto sarebbe il costo completo?\\nPu√≤ essere sostenuto dal SSN?\\nGrazie per i chiarimenti.\\n\\nCordiali saluti\\n \\nLuca Nadali\\ncell: +39 328 95 12 054","note":"inviata email e whatsapp. Il 16/10 chiamato e ha riagganciato. Inviato whatsapp con nuova brochure. Ha risposto che √® troppo caro","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00101"},{"excel_row":107,"data_arrivo":"2025-09-09","nome":"Andrea Dente","email":"aanderea@me.com","telefono":"3669785184","canale":"IRBEMA","location":"Pesaro - Marche","messaggio":"","note":"inviata email e whatsapp. Ha risposto che ha ricevuto tutto. Chiamato il 23/09 non risponde.  Il 16/10 inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00102"},{"excel_row":109,"data_arrivo":"2025-09-14","nome":"Giuliano Rapelli","email":"rapelligiuliano@gmail.com","telefono":"3518276853","canale":"IRBEMA","location":"Bruzolo - Piemonte","messaggio":"Vorrei per cortesia un preventivo per il bracciale","note":"inviata email e whatsapp. Chiamato il 23/09. Ha problemi economici","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00103"},{"excel_row":110,"data_arrivo":"2025-09-14","nome":"Eros Coghi","email":"eroscoghi@gmail.com","telefono":"+393474124442","canale":"IRBEMA","location":"Cassano Magnago - Lombardia","messaggio":"","note":"inviata email e whatsapp. Chiamato il 23/09 ha gi√† trovato un'altra soluzione","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00104"},{"excel_row":111,"data_arrivo":"2025-09-15","nome":"Giuseppe Zonno","email":"gzonno@mediatipo.it","telefono":"+393333333430","canale":"IRBEMA","location":"Puglia","messaggio":"","note":"inviata email e whatsapp. Chiamato il 23/09 . Richiamare in serata. Richiamato non poteva parlare.IL 16/10 richiamato, mi telefona lui alle 15","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00105"},{"excel_row":112,"data_arrivo":"2025-09-17","nome":"Maria Maglione","email":"mariamaglione4@gmail.com","telefono":"3334464095","canale":"IRBEMA","location":"Aosta - Valle d'Aosta","messaggio":"","note":"inviata email e whatsapp. Chiamata il 23/09 ha riagganciato. Inviato whtsapp. 16/10 non √® pi√π interessata","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00106"},{"excel_row":113,"data_arrivo":"2025-09-18","nome":"Manu Cels - Simone","email":"","telefono":"","canale":"IRBEMA","location":"Valle Susa - Piemonte","messaggio":"","note":"inviato whtsapp. Scritto il 23/09 hanno preso una badante","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00107"},{"excel_row":114,"data_arrivo":"2025-09-24","nome":"Daniele Brunelli","email":"danielebrunelli.db@libero.it","telefono":"3400873094","canale":"IRBEMA","location":"Castel giorgio - Umbria","messaggio":"madre 81 anni. Problemi di vista","note":"inviato whatsapp e call mi richiama. 16/10 chiamato ed inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00108"},{"excel_row":115,"data_arrivo":"2025-09-25","nome":"Angela Ronconi","email":"angelaronconi@libero.it","telefono":"393401191079","canale":"IRBEMA","location":"Avellino - Campania","messaggio":"","note":"inviato whatsapp e call ma non ha risposto. Ci siamo risentite telefonicamente il 26/09. Vuole valutare cosa offre la concorrenza. In data 15/10 ha inviato un'altra richiesta. L'ho contattata e inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00109"},{"excel_row":116,"data_arrivo":"2025-10-06","nome":"Maria Mertel","email":"mertelmaria@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"orologio salvavita per anziani","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00110"},{"excel_row":117,"data_arrivo":"2025-10-09","nome":"Tafaro","email":"t.tafaro@virgilio.it","telefono":"335 8303589","canale":"IRBEMA","location":"Roma Centro","messaggio":"orologio salvavita per anziani. Avete convenzioni con Mutue o Fondi sanitari?","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00111"},{"excel_row":118,"data_arrivo":"2025-10-13","nome":"Deanna Mantovani","email":"deannamant@outlook.it","telefono":"+393454431743","canale":"IRBEMA","location":"","messaggio":"Vorrei informazioni pi√π dettagliate sul dispositivo grazie","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00112"},{"excel_row":119,"data_arrivo":"2025-10-21","nome":"Serena Scilleri","email":"Scilleri.serena@libero.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00113"},{"excel_row":121,"data_arrivo":"2025-10-30","nome":"Silvia Brocadello","email":"silviabrocadello72@yahoo.it","telefono":"3343329422","canale":"IRBEMA","location":"Milano","messaggio":"","note":"inviato whatsapp","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00114"},{"excel_row":120,"data_arrivo":"2025-10-31","nome":"Francesco Prandoni","email":"francescoprandoni@hotmail.it","telefono":"+393394686011","canale":"IRBEMA","location":"Busto Arsizio (VA) - Lombardia","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00115"},{"excel_row":122,"data_arrivo":"2025-11-02","nome":"Andrea Vergani","email":"andrea.s.vergani@gmail.com","telefono":"+393357880251","canale":"IRBEMA","location":"Cernusco Lombardone (MI) - Lombardia","messaggio":"","note":"inviato whatsapp","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00116"},{"excel_row":123,"data_arrivo":"2025-11-06","nome":"Giovanni Creton","email":"giovannicreton@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00117"},{"excel_row":124,"data_arrivo":"2025-11-18","nome":"Valeria Ramus","email":"valeria.ramus@gmail.com","telefono":"3398179615","canale":"IRBEMA","location":"Brescia - Lombardia","messaggio":"Cerco un bracciale che riveli parametri animali o bisogno di assistenza per parente anziano","note":"inviato whtsapp","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00118"},{"excel_row":125,"data_arrivo":"2025-11-18","nome":"Claudia Franceschini","email":"franceschinicla@gmail.com","telefono":"3465024760","canale":"IRBEMA","location":"Roma - Lazio","messaggio":"","note":"inviato whtsapp. Contattata il 27/11 mi richiama il 28/11","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00119"},{"excel_row":126,"data_arrivo":"2025-11-22","nome":"Giorgio Ferranti","email":"giorgio.ferranti@msn.com","telefono":"3396935977","canale":"IRBEMA","location":"Terni (TR) - Umbria","messaggio":"costo?","note":"inviata email. Contattato il 27/11 troppo alto il prezzo","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00120"},{"excel_row":127,"data_arrivo":"2025-11-25","nome":"Emanuela","email":"doc.emi@libero.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00121"},{"excel_row":128,"data_arrivo":"2025-11-26","nome":"Luca Catrini","email":"lucacatrini25@gmail.com","telefono":"3476854422","canale":"IRBEMA","location":"Brugherio - Lombardia","messaggio":"Vorrei pi√π preventivi per pi√π soluzioni. Per il padre 88y vive da solo","note":"inviata email. Contattato il 27/11 stanno valutando anche altri dispositivi","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00122"},{"excel_row":129,"data_arrivo":"2025-11-29","nome":"Enzo Gag","email":"enzogag@tin.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00123"},{"excel_row":130,"data_arrivo":"2025-11-30","nome":"Francesca Grati","email":"fgrati@gmail.com","telefono":"3429714170","canale":"WEB","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-WEB-00001"},{"excel_row":132,"data_arrivo":"2025-12-13","nome":"Giuseppe","email":"pinogaglioti@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00124"},{"excel_row":131,"data_arrivo":"2025-12-14","nome":"Giusy Pizzo","email":"pizzogiusy@libero.it","telefono":"3458414686","canale":"IRBEMA","location":"Roma - Lazio","messaggio":"","note":"call 15/12 + email + whatsapp. Volevano chiamata diretta all'ambulanza","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00125"},{"excel_row":133,"data_arrivo":"2025-12-14","nome":"Giansanto Rizzotti","email":"giansanto@rizzotti.it","telefono":"393276246536","canale":"IRBEMA","location":"Taranto - Puglia","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00126"},{"excel_row":134,"data_arrivo":"2025-12-17","nome":"Roberto Bifulco","email":"roberto.bif@libero.it","telefono":"3360949528","canale":"IRBEMA","location":"Napoli - Campania","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00127"}]`),jT={total:m0,leads:g0},HT=Object.freeze(Object.defineProperty({__proto__:null,default:jT,leads:g0,total:m0},Symbol.toStringTag,{value:"Module"}));class f0{constructor(o){O(this,"db");O(this,"pythonScriptPath");this.db=o,this.pythonScriptPath=_0(process.cwd(),"src","services","document-generator.py")}async generateDocumentsForLead(o){try{console.log(`üìÑ Inizio generazione documenti per lead ${o}`);const e=await this.getLeadFromDatabase(o);if(!e)return{success:!1,errors:[`Lead ${o} non trovato nel database`]};if(!e.vuoleContratto)return{success:!1,errors:["Il lead non ha richiesto il contratto"]};const a=await this.callPythonGenerator(e);if(!a.success)return a;const i=a.contractPdfPath,r=a.proformaPdfPath,s=await this.saveContractToDatabase({id:a.contractId,leadId:e.id,tipo_contratto:a.tipoServizio,pdf_url:i||"",prezzo_mensile:a.prezzoBase||0,prezzo_totale:a.prezzoIvaInclusa||0}),l=await this.saveProformaToDatabase({id:a.proformaId,contract_id:a.contractId,leadId:e.id,tipo_servizio:a.tipoServizio,pdf_url:r||"",prezzo_mensile:a.prezzoBase||0,prezzo_totale:a.prezzoIvaInclusa||0,cliente_nome:e.nomeAssistito,cliente_cognome:e.cognomeAssistito,cliente_email:e.email,cliente_telefono:e.telefono||"",cliente_indirizzo:e.indirizzoAssistito||"",cliente_codice_fiscale:e.cfAssistito||""});return console.log("‚úÖ Documenti generati e salvati nel database"),{...a,contractPdfUrl:i,proformaPdfUrl:r}}catch(e){return console.error("‚ùå Errore generazione documenti:",e),{success:!1,errors:[e instanceof Error?e.message:"Errore sconosciuto"]}}}async callPythonGenerator(o){return new Promise((e,a)=>{const i=JSON.stringify({id:o.id,nomeRichiedente:o.nomeRichiedente,cognomeRichiedente:o.cognomeRichiedente,email:o.email,telefono:o.telefono,nomeAssistito:o.nomeAssistito,cognomeAssistito:o.cognomeAssistito,dataNascitaAssistito:o.dataNascitaAssistito,luogoNascitaAssistito:o.luogoNascita,cfAssistito:o.cfAssistito,indirizzoAssistito:o.indirizzoAssistito,cfIntestatario:o.cfIntestatario,indirizzoIntestatario:o.indirizzoIntestatario,pacchetto:o.pacchetto,vuoleContratto:o.vuoleContratto,intestazioneContratto:o.intestazioneContratto}),r=O0("python3",[this.pythonScriptPath,i]);let s="",l="";r.stdout.on("data",d=>{s+=d.toString()}),r.stderr.on("data",d=>{l+=d.toString()}),r.on("close",d=>{if(d!==0){e({success:!1,errors:[`Processo Python terminato con codice ${d}`,l]});return}try{const c=JSON.parse(s);e(c)}catch{e({success:!1,errors:["Errore parsing output Python",s,l]})}}),r.on("error",d=>{e({success:!1,errors:[`Errore esecuzione Python: ${d.message}`]})})})}async getLeadFromDatabase(o){try{const e=await this.db.prepare(`
        SELECT * FROM leads WHERE id = ?
      `).bind(o).first();return e?{id:e.id,nomeRichiedente:e.nomeRichiedente,cognomeRichiedente:e.cognomeRichiedente,email:e.email,telefono:e.telefono,nomeAssistito:e.nomeAssistito,cognomeAssistito:e.cognomeAssistito,dataNascitaAssistito:e.dataNascitaAssistito,etaAssistito:e.etaAssistito,parentelaAssistito:e.parentelaAssistito,pacchetto:e.pacchetto,condizioniSalute:e.condizioniSalute,priority:e.priority,preferenzaContatto:e.preferitoContatto,vuoleContratto:e.vuoleContratto==="Si",intestazioneContratto:e.intestazioneContratto,cfIntestatario:e.cfIntestatario,indirizzoIntestatario:e.indirizzoIntestatario,cfAssistito:e.cfAssistito,indirizzoAssistito:e.indirizzoAssistito,vuoleBrochure:e.vuoleBrochure==="Si",vuoleManuale:e.vuoleManuale==="Si",dataNascita:e.dataNascita,luogoNascita:e.luogoNascita,sesso:e.sesso,note:e.note,gdprConsent:e.gdprConsent==="on",timestamp:e.created_at,fonte:e.sourceUrl,versione:e.sistemaVersione,status:e.status,partnerId:e.partnerId,createdAt:e.created_at,updatedAt:e.updated_at,fingerprintHash:e.fingerprintHash,duplicatoId:e.duplicatoId}:null}catch(e){return console.error("‚ùå Errore recupero lead:",e),null}}async saveContractToDatabase(o){try{const e=new Date().toISOString(),a=`CTR-${o.id}`,i=o.tipo_contratto==="BASE"?"Template_Contratto_Base_TeleMedCare":"Template_Contratto_Avanzato_TeleMedCare";return await this.db.prepare(`
        INSERT INTO contracts (
          id, leadId, codice_contratto, tipo_contratto, template_utilizzato,
          contenuto_html, pdf_url, pdf_generated, prezzo_mensile, durata_mesi,
          prezzo_totale, status, email_sent, email_template_used,
          created_at, updated_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `).bind(o.id,o.leadId,a,o.tipo_contratto,i,"",o.pdf_url,!0,o.prezzo_mensile,12,o.prezzo_totale,"DRAFT",!1,"email_invio_contratto",e,e).run(),console.log(`‚úÖ Contratto ${o.id} salvato nel database`),!0}catch(e){return console.error("‚ùå Errore salvataggio contratto:",e),!1}}async saveProformaToDatabase(o){try{const e=new Date().toISOString(),a=new Date().toISOString().split("T")[0],i=new Date(Date.now()+720*60*60*1e3).toISOString().split("T")[0],r=`PRF-${o.id}`,s=this.extractCAP(o.cliente_indirizzo),l=this.extractCity(o.cliente_indirizzo),d=this.extractProvince(o.cliente_indirizzo);return await this.db.prepare(`
        INSERT INTO proforma (
          id, contract_id, leadId, numero_proforma, data_emissione, data_scadenza,
          cliente_nome, cliente_cognome, cliente_email, cliente_telefono,
          cliente_indirizzo, cliente_citta, cliente_cap, cliente_provincia,
          cliente_codice_fiscale, tipo_servizio, prezzo_mensile, durata_mesi,
          prezzo_totale, pdf_url, pdf_generated, template_utilizzato,
          status, email_sent, email_template_used, created_at, updated_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `).bind(o.id,o.contract_id,o.leadId,r,a,i,o.cliente_nome,o.cliente_cognome,o.cliente_email,o.cliente_telefono,o.cliente_indirizzo,l,s,d,o.cliente_codice_fiscale,o.tipo_servizio,o.prezzo_mensile,12,o.prezzo_totale,o.pdf_url,!0,"Template_Proforma_Unificato_TeleMedCare","DRAFT",!1,"email_invio_proforma",e,e).run(),console.log(`‚úÖ Proforma ${o.id} salvata nel database`),!0}catch(e){return console.error("‚ùå Errore salvataggio proforma:",e),!1}}extractCAP(o){const e=o.match(/\b(\d{5})\b/);return e?e[1]:""}extractCity(o){const e=o.match(/\d{5}\s+([A-Za-z√†√®√©√¨√≤√π√Ä√à√â√å√í√ô\s]+?)(?:\s+[A-Z]{2})?$/);return e?e[1].trim():""}extractProvince(o){const e=o.match(/\b([A-Z]{2})$/);return e?e[1]:""}async updateContractStatus(o,e){try{return await this.db.prepare(`
        UPDATE contracts 
        SET status = ?, updated_at = ?
        WHERE id = ?
      `).bind(e,new Date().toISOString(),o).run(),!0}catch(a){return console.error("‚ùå Errore aggiornamento status contratto:",a),!1}}async updateProformaStatus(o,e){try{return await this.db.prepare(`
        UPDATE proforma 
        SET status = ?, updated_at = ?
        WHERE id = ?
      `).bind(e,new Date().toISOString(),o).run(),!0}catch(a){return console.error("‚ùå Errore aggiornamento status proforma:",a),!1}}}async function VT(t,o){return new f0(t).generateDocumentsForLead(o)}const WT=Object.freeze(Object.defineProperty({__proto__:null,DocumentManager:f0,generateDocumentsForLead:VT},Symbol.toStringTag,{value:"Module"}));function h0(t){if(!t)return console.error("‚ùå Payload HubSpot vuoto"),!1;if(!t.portalId&&!t.properties)return console.error("‚ùå Payload HubSpot invalido: mancano portalId o properties"),!1;const o=t.properties||{};return o.hs_object_source_detail_1!=="Form eCura"?(console.log(`‚ö†Ô∏è Lead ignorato: fonte "${o.hs_object_source_detail_1}" diversa da "Form eCura"`),!1):o.email?!o.firstname||!o.lastname?(console.error("‚ùå Nome o cognome richiedente mancante"),!1):!o.servizio_ecura&&!o.piano_ecura?(console.error("‚ùå N√© servizio n√© piano eCura specificati"),!1):(console.log("‚úÖ Validazione payload superata"),!0):(console.error("‚ùå Email richiedente mancante"),!1)}function v0(t){const o=t.properties||{},e=o.richiedi_brochure===!0||o.richiedi_brochure==="true",a=o.richiedi_contratto===!0||o.richiedi_contratto==="true",i=Math.random().toString(36).substring(2,8).toUpperCase(),r=`LEAD_${new Date().toISOString().replace(/[:.]/g,"").slice(0,-1)}Z_${i}`,s=(o.piano_ecura||"BASE").toUpperCase();return{id:r,nomeRichiedente:o.firstname||"",cognomeRichiedente:o.lastname||"",email:o.email||"",telefono:o.phone||void 0,cittaIntestatario:o.city||void 0,nomeAssistito:o.nome_assistito||void 0,cognomeAssistito:o.cognome_assistito||void 0,etaAssistito:o.eta_assistito?parseInt(o.eta_assistito):void 0,pacchetto:s,vuoleBrochure:e,vuoleManuale:!1,vuoleContratto:a,fonte:"Form eCura",note:o.note||void 0}}async function E0(t,o){var e,a;try{console.log("üíæ Tentativo salvataggio lead:",{id:t.id,nome:t.nomeRichiedente,cognome:t.cognomeRichiedente,email:t.email,pacchetto:t.pacchetto,fonte:t.fonte});const r=await o.prepare(`
      INSERT INTO leads (
        id, 
        nomeRichiedente, 
        cognomeRichiedente, 
        email, 
        telefono,
        cittaIntestatario,
        nomeAssistito, 
        cognomeAssistito, 
        etaAssistito,
        pacchetto,
        vuoleBrochure,
        vuoleManuale,
        vuoleContratto,
        fonte,
        note,
        status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(t.id,t.nomeRichiedente,t.cognomeRichiedente,t.email,t.telefono||"",t.cittaIntestatario||null,t.nomeAssistito||null,t.cognomeAssistito||null,t.etaAssistito||null,t.pacchetto,t.vuoleBrochure?1:0,t.vuoleManuale?1:0,t.vuoleContratto?1:0,t.fonte||"Form eCura",t.note||null,"NEW").run();return console.log(`‚úÖ Lead ${t.id} salvato nel database. Result:`,{success:r.success,meta:r.meta,changes:((e=r.meta)==null?void 0:e.changes)||0}),!r.success||(((a=r.meta)==null?void 0:a.changes)||0)===0?{success:!1,error:"INSERT non ha modificato righe nel DB"}:{success:!0}}catch(i){const r=i instanceof Error?i.message:String(i),s={error:r,stack:i instanceof Error?i.stack:void 0,cause:i instanceof Error?i.cause:void 0,leadId:t.id,leadData:{nomeRichiedente:t.nomeRichiedente,cognomeRichiedente:t.cognomeRichiedente,email:t.email,pacchetto:t.pacchetto}};return console.error("‚ùå Errore salvataggio lead nel DB:",s),{success:!1,error:r}}}async function GT(t,o){try{const e=await t.json();if(console.log("üì• Webhook HubSpot ricevuto:",{portalId:e.portalId,objectId:e.objectId,subscriptionType:e.subscriptionType}),!h0(e))return new Response(JSON.stringify({success:!1,error:"Payload invalido"}),{status:400,headers:{"Content-Type":"application/json"}});const a=v0(e);console.log("üîÑ Lead mappato:",{id:a.id,email:a.email,servizio:a.pacchetto,vuoleBrochure:a.vuoleBrochure,vuoleContratto:a.vuoleContratto});const i=o.DB||o.telemedcare_v12_db;if(!i)return console.error("‚ùå Database non configurato in env",{envKeys:Object.keys(o)}),new Response(JSON.stringify({success:!1,error:"Database non configurato"}),{status:500,headers:{"Content-Type":"application/json"}});console.log("‚úÖ Database configurato, procedo al salvataggio");const r=await E0(a,i);return r.success?new Response(JSON.stringify({success:!0,leadId:a.id,message:"Lead ricevuto e processato con successo"}),{status:200,headers:{"Content-Type":"application/json"}}):new Response(JSON.stringify({success:!1,error:"Errore salvataggio database",details:r.error||"Errore sconosciuto"}),{status:500,headers:{"Content-Type":"application/json"}})}catch(e){return console.error("‚ùå Errore handler webhook HubSpot:",e),new Response(JSON.stringify({success:!1,error:e instanceof Error?e.message:"Errore sconosciuto"}),{status:500,headers:{"Content-Type":"application/json"}})}}const KT=Object.freeze(Object.defineProperty({__proto__:null,handleHubSpotWebhook:GT,mapHubSpotToLead:v0,saveLeadToDB:E0,validateHubSpotPayload:h0},Symbol.toStringTag,{value:"Module"}));class qT{static async handleWebhook(o,e,a){var r,s;const i={success:!1,message:"",envelopeId:o.data.envelopeId,status:o.data.envelopeSummary.status,actions:[],errors:[]};try{console.log(`üì¨ [DOCUSIGN_WEBHOOK] Evento ricevuto: ${o.event}`),console.log(`üìã [DOCUSIGN_WEBHOOK] Envelope: ${o.data.envelopeId}`),console.log(`üìä [DOCUSIGN_WEBHOOK] Status: ${o.data.envelopeSummary.status}`);const l=o.data.envelopeId,d=o.data.envelopeSummary.status,c=await e.prepare(`
        SELECT * FROM contracts 
        WHERE docusign_envelope_id = ?
      `).bind(l).first();if(!c)return(r=i.errors)==null||r.push(`Contratto non trovato per envelope ${l}`),console.error("‚ùå [DOCUSIGN_WEBHOOK] Contratto non trovato"),i;switch(console.log(`‚úÖ [DOCUSIGN_WEBHOOK] Contratto trovato: ${c.contract_code}`),d.toLowerCase()){case"completed":await this.handleCompleted(c,o,e,a,i);break;case"declined":await this.handleDeclined(c,o,e,a,i);break;case"voided":await this.handleVoided(c,o,e,a,i);break;default:console.log(`‚ÑπÔ∏è [DOCUSIGN_WEBHOOK] Status ignorato: ${d}`),i.message=`Status ${d} ricevuto ma non processato`}return i.success=!0,i}catch(l){return console.error("‚ùå [DOCUSIGN_WEBHOOK] Errore processing webhook:",l),(s=i.errors)==null||s.push(String(l)),i}}static async handleCompleted(o,e,a,i,r){var d,c,u,p,g,m,b,h,E,w,S;console.log(`‚úÖ [DOCUSIGN_WEBHOOK] Firma completata per contratto: ${o.contract_code}`);const s=e.data.envelopeSummary.statusDateTime;(c=(d=e.data.envelopeSummary.recipients)==null?void 0:d.signers)==null||c[0],await a.prepare(`
      UPDATE contracts 
      SET status = 'signed',
          signed_at = ?,
          updated_at = datetime('now')
      WHERE id = ?
    `).bind(s,o.id).run(),(u=r.actions)==null||u.push(`Contratto ${o.contract_code} marcato come SIGNED`),console.log("‚úÖ [DOCUSIGN_WEBHOOK] Status contratto aggiornato: SIGNED");let l=null;o.lead_id&&(await a.prepare(`
        UPDATE leads 
        SET status = 'CONTRACT_SIGNED'
        WHERE id = ?
      `).bind(o.lead_id).run(),l=await a.prepare(`
        SELECT * FROM leads WHERE id = ?
      `).bind(o.lead_id).first(),(p=r.actions)==null||p.push(`Lead ${o.lead_id} aggiornato: CONTRACT_SIGNED`));try{if(l){console.log("üí∞ [DOCUSIGN_WEBHOOK] Generazione proforma automatica...");const{createProformaFromContract:C}=await Promise.resolve().then(()=>tg),R=(await Promise.resolve().then(()=>tg)).default,{createStripeService:z,createProformaPaymentLink:D}=await Promise.resolve().then(()=>dw),F=(await Promise.resolve().then(()=>At)).default,{loadEmailTemplate:L,renderTemplate:M}=await Promise.resolve().then(()=>Pa),j=z(i),N=await C(o.contract_code,l.nome_richiedente||l.nomeRichiedente||"Cliente",l.cognome_richiedente||l.cognomeRichiedente||"",l.email_richiedente||l.email||"",o.servizio||l.servizio||"PRO",o.tipo_servizio||l.pacchetto||"BASE"),A=await D(j,"",o.contract_code,N.servizio,N.piano,N.totale,N.nomeCliente,N.emailCliente);N.linkPagamentoStripe=A.url;const x=await R.generateProforma(N,a);if(x.success&&x.proforma){const P=x.proforma;await a.prepare(`
            UPDATE proformas 
            SET stripe_payment_link = ?
            WHERE id = ?
          `).bind(A.url,P.proformaId).run(),console.log(`‚úÖ [DOCUSIGN_WEBHOOK] Proforma generata: ${P.numeroProforma}`),(g=r.actions)==null||g.push(`Proforma ${P.numeroProforma} generata`);try{console.log("üìß [DOCUSIGN_WEBHOOK] Invio email proforma..."),await L("email_invio_proforma",a)||console.warn("‚ö†Ô∏è [DOCUSIGN_WEBHOOK] Template email_invio_proforma non trovato in DB, uso inline");const{getPricing:J,formatServiceName:ae}=await Promise.resolve().then(()=>Ug),ie=J(N.servizio,N.piano),Z={NUMERO_PROFORMA:P.numeroProforma,NOME_CLIENTE:N.nomeCliente,COGNOME_CLIENTE:N.cognomeCliente,TOTALE:N.totale.toFixed(2),LINK_PAGAMENTO:A.url,SERVIZIO_COMPLETO:ae(N.servizio,N.piano),DISPOSITIVO:N.dispositivo,SCADENZA_PAGAMENTO:N.scadenzaPagamento,DATA_EMISSIONE:N.dataEmissione,CODICE_CONTRATTO:o.contract_code,DETRAZIONE_FISCALE:ie?(ie.detrazioneFiscale19/12).toFixed(2):"0.00"},We=await new F(i).sendEmail({to:N.emailCliente,from:i.EMAIL_FROM||"info@telemedcare.it",subject:`üí∞ Proforma eCura ${P.numeroProforma} - Completa il Pagamento`,templateName:"email_invio_proforma",variables:Z,attachments:P.pdfBase64?[{filename:`Proforma_${P.numeroProforma}.pdf`,content:P.pdfBase64,contentType:"application/pdf"}]:void 0});We.success?(console.log(`‚úÖ [DOCUSIGN_WEBHOOK] Email proforma inviata a ${N.emailCliente}`),(m=r.actions)==null||m.push(`Email proforma inviata a ${N.emailCliente}`)):(console.error("‚ùå [DOCUSIGN_WEBHOOK] Errore invio email proforma:",We.error),(b=r.actions)==null||b.push(`Errore invio email: ${We.error}`))}catch(B){console.error("‚ùå [DOCUSIGN_WEBHOOK] Errore invio email proforma:",B),(h=r.actions)==null||h.push(`Errore invio email proforma: ${B}`)}}else console.error("‚ùå [DOCUSIGN_WEBHOOK] Errore generazione proforma:",x.error),(E=r.actions)==null||E.push(`Errore generazione proforma: ${x.error}`)}else console.warn("‚ö†Ô∏è [DOCUSIGN_WEBHOOK] Lead non trovato, skip proforma"),(w=r.actions)==null||w.push("Lead non trovato, proforma skippata")}catch(C){console.error("‚ùå [DOCUSIGN_WEBHOOK] Errore workflow proforma:",C),(S=r.actions)==null||S.push(`Errore workflow proforma: ${C}`)}r.message=`Firma completata con successo per ${o.contract_code}`}static async handleDeclined(o,e,a,i,r){var s,l,d;console.log(`‚ùå [DOCUSIGN_WEBHOOK] Firma declinata per contratto: ${o.contract_code}`),await a.prepare(`
      UPDATE contracts 
      SET status = 'declined',
          updated_at = datetime('now')
      WHERE id = ?
    `).bind(o.id).run(),(s=r.actions)==null||s.push(`Contratto ${o.contract_code} marcato come DECLINED`),o.lead_id&&(await a.prepare(`
        UPDATE leads 
        SET status = 'CONTRACT_DECLINED'
        WHERE id = ?
      `).bind(o.lead_id).run(),(l=r.actions)==null||l.push(`Lead ${o.lead_id} aggiornato: CONTRACT_DECLINED`)),(d=r.actions)==null||d.push("TODO: Notifica team - firma declinata"),console.log("üìß [DOCUSIGN_WEBHOOK] TODO: Notifica team firma declinata"),r.message=`Firma declinata per ${o.contract_code}`}static async handleVoided(o,e,a,i,r){var s;console.log(`üö´ [DOCUSIGN_WEBHOOK] Envelope annullato per contratto: ${o.contract_code}`),await a.prepare(`
      UPDATE contracts 
      SET status = 'voided',
          updated_at = datetime('now')
      WHERE id = ?
    `).bind(o.id).run(),(s=r.actions)==null||s.push(`Contratto ${o.contract_code} marcato come VOIDED`),o.lead_id&&await a.prepare(`
        UPDATE leads 
        SET status = 'CONTRACT_VOIDED'
        WHERE id = ?
      `).bind(o.lead_id).run(),r.message=`Envelope annullato per ${o.contract_code}`}static validateSignature(o,e,a){return console.log("‚ö†Ô∏è [DOCUSIGN_WEBHOOK] Validazione HMAC signature TODO"),!0}}const YT=Object.freeze(Object.defineProperty({__proto__:null,DocuSignWebhookHandler:qT},Symbol.toStringTag,{value:"Module"}));class ZT{static async processWebhook(o,e){console.log(`üîî [STRIPE-WEBHOOK] Ricevuto evento: ${o.type}`);try{switch(o.type){case"payment_intent.succeeded":return await this.handlePaymentSuccess(o.data.object,e);case"payment_intent.payment_failed":return await this.handlePaymentFailed(o.data.object,e);case"payment_intent.canceled":return await this.handlePaymentCanceled(o.data.object,e);default:return console.log(`‚ö†Ô∏è [STRIPE-WEBHOOK] Evento non gestito: ${o.type}`),{success:!0,message:`Evento ${o.type} ricevuto ma non gestito`}}}catch(a){return console.error("‚ùå [STRIPE-WEBHOOK] Errore processamento:",a),{success:!1,message:"Errore processamento webhook",error:String(a)}}}static async handlePaymentSuccess(o,e){const a=o.id,i=o.amount/100;console.log(`‚úÖ [STRIPE-WEBHOOK] Pagamento completato: ${a} - ‚Ç¨${i}`);try{const r=o.metadata||{},s=r.proforma_number,l=r.contract_code;if(!s)throw new Error("Metadata proforma_number mancante nel payment_intent");console.log(`üìÑ [STRIPE-WEBHOOK] Proforma: ${s} | Contratto: ${l}`),await e.prepare(`
        UPDATE proformas 
        SET status = 'paid', 
            paid_at = datetime('now'),
            payment_intent_id = ?,
            updated_at = datetime('now')
        WHERE numero_proforma = ?
      `).bind(a,s).run(),console.log(`‚úÖ [STRIPE-WEBHOOK] Proforma ${s} aggiornata: paid`);const d=await e.prepare(`
        SELECT l.*, c.codice_contratto
        FROM leads l
        INNER JOIN contracts c ON c.lead_id = l.id
        WHERE c.codice_contratto = ?
      `).bind(l).first();if(!d)throw new Error(`Lead non trovato per contratto ${l}`);await e.prepare(`
        UPDATE leads 
        SET status = 'PAYMENT_COMPLETED',
            updated_at = datetime('now')
        WHERE id = ?
      `).bind(d.id).run(),console.log(`‚úÖ [STRIPE-WEBHOOK] Lead ${d.id} aggiornato: PAYMENT_COMPLETED`);const c=await this.sendConfigurationEmail(d,e);return c.success||console.error("‚ùå [STRIPE-WEBHOOK] Errore invio email configurazione:",c.error),console.log("üöö [TODO] Generare DDT automatico"),console.log("üöÄ [TODO] Avviare processo attivazione servizio"),{success:!0,message:`Pagamento completato per proforma ${s}. Email configurazione inviata.`}}catch(r){return console.error("‚ùå [STRIPE-WEBHOOK] Errore handlePaymentSuccess:",r),{success:!1,message:"Errore gestione pagamento completato",error:String(r)}}}static async sendConfigurationEmail(o,e){try{console.log(`üìß [STRIPE-WEBHOOK] Invio email configurazione a: ${o.email}`);const a=await e.prepare(`
        SELECT html_content 
        FROM document_templates 
        WHERE name = 'email_configurazione' AND active = 1
      `).first();if(!a)throw new Error("Template email_configurazione non trovato nel database");const i=`https://forms.ecura.it/configurazione/${o.id}`,r={NOME_CLIENTE:o.nome||"Cliente",COGNOME_CLIENTE:o.cognome||"",LINK_FORM_CONFIGURAZIONE:i,CODICE_CLIENTE:o.id.substring(0,12),SERVIZIO:o.servizio||"PRO",PIANO:o.pacchetto||"BASE",DATA_PAGAMENTO:new Date().toLocaleDateString("it-IT")},s=Xe.renderTemplate(a.html_content,r),l=await Xe.sendEmail({to:o.email,from:"info@telemedcare.it",fromName:"eCura - Medica GB",subject:"Configura il tuo SiDLY CARE - Benvenuto!",html:s,text:`Benvenuto! Completa la configurazione del tuo servizio eCura: ${i}`});return l.success?console.log(`‚úÖ [STRIPE-WEBHOOK] Email configurazione inviata a ${o.email}`):console.error(`‚ùå [STRIPE-WEBHOOK] Errore invio email: ${l.error}`),l}catch(a){return console.error("‚ùå [STRIPE-WEBHOOK] Errore sendConfigurationEmail:",a),{success:!1,error:String(a)}}}static async handlePaymentFailed(o,e){const a=o.id,r=(o.metadata||{}).proforma_number;return console.log(`‚ùå [STRIPE-WEBHOOK] Pagamento fallito: ${a}`),r?(await e.prepare(`
      UPDATE proformas 
      SET status = 'failed',
          updated_at = datetime('now')
      WHERE numero_proforma = ?
    `).bind(r).run(),console.log(`‚ö†Ô∏è [STRIPE-WEBHOOK] Proforma ${r} marcata come failed`),{success:!0,message:`Pagamento fallito per proforma ${r}`}):{success:!0,message:"Proforma non specificata"}}static async handlePaymentCanceled(o,e){const a=o.id,r=(o.metadata||{}).proforma_number;return console.log(`‚ö†Ô∏è [STRIPE-WEBHOOK] Pagamento cancellato: ${a}`),r?(await e.prepare(`
      UPDATE proformas 
      SET status = 'canceled',
          updated_at = datetime('now')
      WHERE numero_proforma = ?
    `).bind(r).run(),console.log(`‚ö†Ô∏è [STRIPE-WEBHOOK] Proforma ${r} marcata come canceled`),{success:!0,message:`Pagamento cancellato per proforma ${r}`}):{success:!0,message:"Proforma non specificata"}}}const XT=Object.freeze(Object.defineProperty({__proto__:null,StripeWebhookHandler:ZT},Symbol.toStringTag,{value:"Module"})),zu={FAMILY:{BASE:{setup:390,rinnovo:200},AVANZATO:{setup:690,rinnovo:500}},PRO:{BASE:{setup:480,rinnovo:240},AVANZATO:{setup:840,rinnovo:600}},PREMIUM:{BASE:{setup:590,rinnovo:300},AVANZATO:{setup:990,rinnovo:750}}},Qm=.22,JT=.19;function pu(t,o){const e=t.toUpperCase(),a=o.toUpperCase();if(!zu[e])throw new Error(`Servizio non valido: ${t}. Valori ammessi: FAMILY, PRO, PREMIUM`);if(!zu[e][a])throw new Error(`Piano non valido: ${o}. Valori ammessi: BASE, AVANZATO`);const{setup:i,rinnovo:r}=zu[e][a],s=Math.round(i*Qm*100)/100,l=Math.round(r*Qm*100)/100,d=Math.round((i+s)*100)/100,c=Math.round((r+l)*100)/100,u=Math.round(d*JT*100)/100;return{setupBase:i,setupIva:s,setupTotale:d,rinnovoBase:r,rinnovoIva:l,rinnovoTotale:c,servizio:e,piano:a,detrazioneFiscale19:u}}function b0(){const t=[],o=["FAMILY","PRO","PREMIUM"],e=["BASE","AVANZATO"];for(const a of o)for(const i of e)t.push(pu(a,i));return t}function y0(t,o,e){try{return pu(t,o).setupBase===e}catch{return!1}}function co(t){return`‚Ç¨${t.toFixed(2).replace(".",",")}`}function T0(t){return`
üì¶ ${t.servizio} - ${t.piano}

üí∞ Setup (1¬∞ Anno):
   Base (IVA esclusa): ${co(t.setupBase)}
   IVA 22%: ${co(t.setupIva)}
   Totale: ${co(t.setupTotale)}

üîÑ Rinnovo (dal 2¬∞ anno):
   Base (IVA esclusa): ${co(t.rinnovoBase)}
   IVA 22%: ${co(t.rinnovoIva)}
   Totale: ${co(t.rinnovoTotale)}

üíä Detrazione Fiscale 19%: ${co(t.detrazioneFiscale19)}
  `.trim()}const QT={calculatePrice:pu,getAllPrices:b0,isValidPrice:y0,formatPrice:co,formatPriceBreakdown:T0},sr=Object.freeze(Object.defineProperty({__proto__:null,calculatePrice:pu,default:QT,formatPrice:co,formatPriceBreakdown:T0,getAllPrices:b0,isValidPrice:y0},Symbol.toStringTag,{value:"Module"})),ew=`<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Completa i tuoi dati - eCura</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }
        .content {
            padding: 30px;
        }
        .greeting {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .section-header {
            color: #475569;
            font-size: 18px;
            margin: 30px 0 20px 0;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        .form-row {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        .form-row.cols-2 {
            grid-template-columns: 1fr 1fr;
        }
        .form-row.cols-3 {
            grid-template-columns: 2fr 1fr 1fr;
        }
        .form-row.date-location {
            grid-template-columns: 1fr 1fr;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #475569;
            font-weight: 600;
            font-size: 14px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .date-input-group {
            display: flex;
            gap: 8px;
        }
        .date-input-group input {
            text-align: center;
            padding: 12px 8px;
        }
        .date-input-group input.day,
        .date-input-group input.month {
            flex: 1;
        }
        .date-input-group input.year {
            flex: 1.5;
        }
        .required {
            color: #ef4444;
        }
        .submit-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: opacity 0.3s;
        }
        .submit-button:hover:not(:disabled) {
            opacity: 0.9;
        }
        .submit-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .checkbox-wrapper {
            display: flex;
            align-items: flex-start;
            margin: 20px 0;
        }
        .checkbox-wrapper input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            margin-top: 3px;
        }
        .checkbox-wrapper label {
            font-weight: normal;
            font-size: 14px;
        }
        .error {
            background: #fee;
            border: 2px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .success {
            text-align: center;
            padding: 40px;
        }
        .success-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 768px) {
            .form-row.cols-2,
            .form-row.cols-3,
            .form-row.date-location {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìù Completa i tuoi dati</h1>
            <p>Ultimi dettagli per la tua richiesta eCura</p>
        </div>
        
        <div class="content" id="mainContent">
            <div class="loading" id="loadingDiv">
                <div class="spinner"></div>
                <p>Caricamento dati in corso...</p>
            </div>
            
            <div id="formContainer" style="display: none;">
                <p class="greeting" id="greeting">Gentile Cliente,</p>
                
                <form id="completaForm" onsubmit="submitForm(event)">
                    <div id="formFieldsContainer"></div>
                    
                    <div class="form-group">
                        <label for="note">Note aggiuntive (facoltativo)</label>
                        <textarea id="note" name="note" rows="3" placeholder="Eventuali richieste o informazioni aggiuntive..."></textarea>
                    </div>
                    
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="gdprConsent" name="gdprConsent" value="1" required>
                        <label for="gdprConsent">
                            Accetto l'<a href="/privacy" target="_blank" style="color: #667eea;">informativa sulla privacy</a> <span class="required">*</span>
                        </label>
                    </div>
                    
                    <button type="submit" class="submit-button" id="submitBtn">
                        ‚úâÔ∏è Conferma e Invia
                    </button>
                </form>
            </div>
            
            <div id="errorDiv" class="error" style="display: none;"></div>
        </div>
    </div>
    
    <script>
        let leadId = null;
        
        // Estrai leadId dall'URL
        const urlParams = new URLSearchParams(window.location.search);
        leadId = urlParams.get('leadId') || urlParams.get('id');
        
        if (!leadId) {
            showError('Link non valido. Manca l\\'ID del lead.');
        } else {
            loadLeadData();
        }
        
        async function loadLeadData() {
            const loadingDiv = document.getElementById('loadingDiv');
            const formContainer = document.getElementById('formContainer');
            
            loadingDiv.style.display = 'block';
            
            try {
                const response = await fetch(\`/api/leads/\${leadId}\`);
                
                if (!response.ok) {
                    throw new Error('Lead non trovato');
                }
                
                const result = await response.json();
                const lead = result.lead || result;
                
                // Aggiorna greeting
                const greeting = document.getElementById('greeting');
                greeting.textContent = \`Gentile \${lead.nomeRichiedente || ''} \${lead.cognomeRichiedente || ''},\`;
                
                // Genera campi form
                generateFormFields(lead);
                
                loadingDiv.style.display = 'none';
                formContainer.style.display = 'block';
                
            } catch (error) {
                console.error('Errore caricamento lead:', error);
                showError('Impossibile caricare i dati. Verifica il link o contattaci a info@telemedcare.it');
            }
        }
        
        function generateFormFields(lead) {
            const container = document.getElementById('formFieldsContainer');
            let html = '';
            
            // SEZIONE 1: Dati Intestatario (per il contratto)
            const needsIntestatario = !lead.cfIntestatario || !lead.indirizzoIntestatario || 
                                     !lead.capIntestatario || !lead.cittaIntestatario;
            
            if (needsIntestatario) {
                html += '<h3 class="section-header">üìã Dati Intestatario (per la proposta)</h3>';
                
                if (!lead.cfIntestatario) {
                    html += \`
                        <div class="form-group">
                            <label for="cfIntestatario">Codice Fiscale <span class="required">*</span></label>
                            <input type="text" id="cfIntestatario" name="cfIntestatario" 
                                   placeholder="Es. RSSMRA80A01F205K" required 
                                   maxlength="16" style="text-transform: uppercase;">
                        </div>
                    \`;
                }
                
                // Indirizzo, CAP, Citt√† sulla stessa riga
                const hasAddressGaps = !lead.indirizzoIntestatario || !lead.capIntestatario || !lead.cittaIntestatario;
                if (hasAddressGaps) {
                    html += '<div class="form-row cols-3">';
                    
                    if (!lead.indirizzoIntestatario) {
                        html += \`
                            <div class="form-group">
                                <label for="indirizzoIntestatario">Indirizzo <span class="required">*</span></label>
                                <input type="text" id="indirizzoIntestatario" name="indirizzoIntestatario" 
                                       placeholder="Via/Piazza Nome, N." required>
                            </div>
                        \`;
                    }
                    
                    if (!lead.capIntestatario) {
                        html += \`
                            <div class="form-group">
                                <label for="capIntestatario">CAP <span class="required">*</span></label>
                                <input type="text" id="capIntestatario" name="capIntestatario" 
                                       placeholder="00000" required maxlength="5" 
                                       pattern="[0-9]*" inputmode="numeric">
                            </div>
                        \`;
                    }
                    
                    if (!lead.cittaIntestatario) {
                        html += \`
                            <div class="form-group">
                                <label for="cittaIntestatario">Citt√† <span class="required">*</span></label>
                                <input type="text" id="cittaIntestatario" name="cittaIntestatario" 
                                       placeholder="Es. Milano" required>
                            </div>
                        \`;
                    }
                    
                    html += '</div>';
                }
            }
            
            // SEZIONE 2: Dati Assistito
            const needsAssistito = !lead.nomeAssistito || !lead.cognomeAssistito || 
                                  !lead.dataNascitaAssistito || !lead.luogoNascitaAssistito ||
                                  !lead.cfAssistito || !lead.indirizzoAssistito || 
                                  !lead.capAssistito || !lead.cittaAssistito || !lead.condizioniSalute;
            
            if (needsAssistito) {
                html += '<h3 class="section-header">üë§ Dati Assistito</h3>';
                
                // Nome e Cognome sulla stessa riga
                const needsNameSurname = !lead.nomeAssistito || !lead.cognomeAssistito;
                if (needsNameSurname) {
                    html += '<div class="form-row cols-2">';
                    
                    if (!lead.nomeAssistito) {
                        html += \`
                            <div class="form-group">
                                <label for="nomeAssistito">Nome <span class="required">*</span></label>
                                <input type="text" id="nomeAssistito" name="nomeAssistito" 
                                       placeholder="Nome" required>
                            </div>
                        \`;
                    }
                    
                    if (!lead.cognomeAssistito) {
                        html += \`
                            <div class="form-group">
                                <label for="cognomeAssistito">Cognome <span class="required">*</span></label>
                                <input type="text" id="cognomeAssistito" name="cognomeAssistito" 
                                       placeholder="Cognome" required>
                            </div>
                        \`;
                    }
                    
                    html += '</div>';
                }
                
                // Data e Luogo di nascita sulla stessa riga
                const needsBirthInfo = !lead.dataNascitaAssistito || !lead.luogoNascitaAssistito;
                if (needsBirthInfo) {
                    html += '<div class="form-row date-location">';
                    
                    if (!lead.dataNascitaAssistito) {
                        html += \`
                            <div class="form-group">
                                <label for="dataNascitaAssistito">Data di Nascita <span class="required">*</span></label>
                                <div class="date-input-group">
                                    <input type="text" class="day" id="dataNascitaAssistito_giorno" 
                                           maxlength="2" placeholder="GG"
                                           onkeyup="autoFocusDate(event, 'dataNascitaAssistito_mese', 2); updateDateField('dataNascitaAssistito')" 
                                           pattern="[0-9]*" inputmode="numeric" required>
                                    <input type="text" class="month" id="dataNascitaAssistito_mese" 
                                           maxlength="2" placeholder="MM"
                                           onkeyup="autoFocusDate(event, 'dataNascitaAssistito_anno', 2); updateDateField('dataNascitaAssistito')" 
                                           pattern="[0-9]*" inputmode="numeric" required>
                                    <input type="text" class="year" id="dataNascitaAssistito_anno" 
                                           maxlength="4" placeholder="AAAA"
                                           onkeyup="updateDateField('dataNascitaAssistito')" 
                                           pattern="[0-9]*" inputmode="numeric" required>
                                </div>
                                <input type="hidden" id="dataNascitaAssistito" name="dataNascitaAssistito">
                            </div>
                        \`;
                    }
                    
                    if (!lead.luogoNascitaAssistito) {
                        html += \`
                            <div class="form-group">
                                <label for="luogoNascitaAssistito">Luogo di Nascita <span class="required">*</span></label>
                                <input type="text" id="luogoNascitaAssistito" name="luogoNascitaAssistito" 
                                       placeholder="Es. Milano" required>
                            </div>
                        \`;
                    }
                    
                    html += '</div>';
                }
                
                // Codice Fiscale
                if (!lead.cfAssistito) {
                    html += \`
                        <div class="form-group">
                            <label for="cfAssistito">Codice Fiscale <span class="required">*</span></label>
                            <input type="text" id="cfAssistito" name="cfAssistito" 
                                   placeholder="Es. RSSMRA80A01F205K" required 
                                   maxlength="16" style="text-transform: uppercase;">
                        </div>
                    \`;
                }
                
                // Indirizzo, CAP, Citt√† sulla stessa riga
                const hasAssistitoAddressGaps = !lead.indirizzoAssistito || !lead.capAssistito || !lead.cittaAssistito;
                if (hasAssistitoAddressGaps) {
                    html += '<div class="form-row cols-3">';
                    
                    if (!lead.indirizzoAssistito) {
                        html += \`
                            <div class="form-group">
                                <label for="indirizzoAssistito">Indirizzo <span class="required">*</span></label>
                                <input type="text" id="indirizzoAssistito" name="indirizzoAssistito" 
                                       placeholder="Via/Piazza Nome, N." required>
                            </div>
                        \`;
                    }
                    
                    if (!lead.capAssistito) {
                        html += \`
                            <div class="form-group">
                                <label for="capAssistito">CAP <span class="required">*</span></label>
                                <input type="text" id="capAssistito" name="capAssistito" 
                                       placeholder="00000" required maxlength="5" 
                                       pattern="[0-9]*" inputmode="numeric">
                            </div>
                        \`;
                    }
                    
                    if (!lead.cittaAssistito) {
                        html += \`
                            <div class="form-group">
                                <label for="cittaAssistito">Citt√† <span class="required">*</span></label>
                                <input type="text" id="cittaAssistito" name="cittaAssistito" 
                                       placeholder="Es. Roma" required>
                            </div>
                        \`;
                    }
                    
                    html += '</div>';
                }
                
                // Condizioni di Salute
                if (!lead.condizioniSalute) {
                    html += \`
                        <div class="form-group">
                            <label for="condizioniSalute">Condizioni di Salute <span class="required">*</span></label>
                            <textarea id="condizioniSalute" name="condizioniSalute" 
                                      placeholder="Descrivi brevemente le condizioni di salute dell'assistito..." 
                                      rows="4" required></textarea>
                        </div>
                    \`;
                }
            }
            
            if (!needsIntestatario && !needsAssistito) {
                showError('Tutti i dati sono gi√† completi!');
                return;
            }
            
            container.innerHTML = html;
        }
        
        async function submitForm(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            submitBtn.textContent = '‚è≥ Invio in corso...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch(\`/api/leads/\${leadId}/complete\`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showSuccess();
                } else {
                    throw new Error('Errore invio dati');
                }
                
            } catch (error) {
                console.error('Errore submit:', error);
                submitBtn.textContent = '‚úâÔ∏è Conferma e Invia';
                submitBtn.disabled = false;
                showError('Errore invio dati. Riprova o contattaci a info@telemedcare.it');
            }
        }
        
        function showError(message) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('formContainer').style.display = 'none';
            const errorDiv = document.getElementById('errorDiv');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function showSuccess() {
            const content = document.getElementById('mainContent');
            content.innerHTML = \`
                <div class="success">
                    <div class="success-icon">‚úÖ</div>
                    <h2 style="color: #10b981; margin: 0 0 10px 0;">Dati salvati con successo!</h2>
                    <p style="color: #64748b; margin: 10px 0;">Grazie per aver completato i tuoi dati.</p>
                    <p style="color: #64748b;">Il nostro team ti contatter√† presto per finalizzare la tua richiesta.</p>
                    <button onclick="window.close()" class="submit-button" style="margin-top: 20px;">
                        ‚úì Conferma
                    </button>
                </div>
            \`;
        }
        
        // Auto-focus tra campi data (giorno ‚Üí mese ‚Üí anno)
        function autoFocusDate(event, nextFieldId, maxLength) {
            const input = event.target;
            const value = input.value;
            
            // Permetti solo numeri
            input.value = value.replace(/[^0-9]/g, '');
            
            // Se raggiunge la lunghezza massima, passa al campo successivo
            if (input.value.length >= maxLength && nextFieldId) {
                const nextField = document.getElementById(nextFieldId);
                if (nextField) {
                    nextField.focus();
                }
            }
        }
        
        // Aggiorna il campo hidden con formato YYYY-MM-DD
        function updateDateField(fieldName) {
            const giorno = document.getElementById(fieldName + '_giorno')?.value.padStart(2, '0') || '';
            const mese = document.getElementById(fieldName + '_mese')?.value.padStart(2, '0') || '';
            const anno = document.getElementById(fieldName + '_anno')?.value || '';
            
            if (giorno && mese && anno && anno.length === 4) {
                const dataISO = \`\${anno}-\${mese}-\${giorno}\`;
                const hiddenField = document.getElementById(fieldName);
                if (hiddenField) {
                    hiddenField.value = dataISO;
                }
            }
        }
    <\/script>
</body>
</html>
`,tw=Object.freeze(Object.defineProperty({__proto__:null,FORM_HTML:ew},Symbol.toStringTag,{value:"Module"}));class ow{constructor(o,e){O(this,"accessToken");O(this,"portalId");O(this,"baseUrl","https://api.hubapi.com");this.accessToken=o,this.portalId=e}async request(o,e={}){const a=`${this.baseUrl}${o}`,i=await fetch(a,{...e,headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json",...e.headers}});if(!i.ok){const r=await i.json();throw new Error(`HubSpot API Error: ${r.message} (${r.status})`)}return i.json()}async getContacts(o){const e=new URLSearchParams;return o!=null&&o.limit&&e.append("limit",o.limit.toString()),o!=null&&o.after&&e.append("after",o.after),(o==null?void 0:o.archived)!==void 0&&e.append("archived",o.archived.toString()),o!=null&&o.properties?o.properties.forEach(a=>e.append("properties",a)):["firstname","lastname","email","phone","mobilephone","company","address","city","state","zip","country","hs_lead_status","lifecyclestage","createdate","lastmodifieddate","servizio_ecura","piano_ecura","hs_object_source_detail_1","servizio_di_interesse","piano_desiderato"].forEach(i=>e.append("properties",i)),this.request(`/crm/v3/objects/contacts?${e.toString()}`)}async searchContacts(o){const e=[],a=[];o.createdAfter&&a.push({propertyName:"createdate",operator:"GTE",value:new Date(o.createdAfter).getTime().toString()}),o.createdBefore&&a.push({propertyName:"createdate",operator:"LTE",value:new Date(o.createdBefore).getTime().toString()}),o.email&&a.push({propertyName:"email",operator:"EQ",value:o.email}),o.hs_lead_status&&a.push({propertyName:"hs_lead_status",operator:"EQ",value:o.hs_lead_status}),o.hs_object_source_detail_1&&a.push({propertyName:"hs_object_source_detail_1",operator:"EQ",value:o.hs_object_source_detail_1}),a.length>0&&e.push({filters:a});const i=o.properties||["firstname","lastname","email","phone","mobilephone","hs_lead_status","lifecyclestage","createdate","lastmodifieddate","hs_object_source_detail_1","servizio_ecura","piano_ecura","servizio_di_interesse","piano_desiderato"],r={filterGroups:e,properties:i,limit:o.limit||100,sorts:[{propertyName:"createdate",direction:"DESCENDING"}]};return this.request("/crm/v3/objects/contacts/search",{method:"POST",body:JSON.stringify(r)})}async getContact(o,e){const a=new URLSearchParams;return(e||["firstname","lastname","email","phone","mobilephone","hs_lead_status","lifecyclestage","createdate"]).forEach(r=>a.append("properties",r)),this.request(`/crm/v3/objects/contacts/${o}?${a.toString()}`)}async createContact(o){return this.request("/crm/v3/objects/contacts",{method:"POST",body:JSON.stringify({properties:o})})}async updateContact(o,e){return this.request(`/crm/v3/objects/contacts/${o}`,{method:"PATCH",body:JSON.stringify({properties:e})})}async testConnection(){try{const o=await this.getContacts({limit:1});return{success:!0,portalId:this.portalId,message:`‚úÖ Connessione HubSpot riuscita! Trovati ${o.total} contatti totali.`}}catch(o){return{success:!1,portalId:this.portalId,message:`‚ùå Errore connessione HubSpot: ${o.message}`}}}}async function aw(t){const o=t.properties,e=o.firstname||"",a=o.lastname||"",i=o.email||"",r=o.phone||o.mobilephone||"",s=[o.address,o.city,o.state,o.zip,o.country].filter(Boolean).join(", ");console.log(`üîç [HUBSPOT MAPPING] Contact ${o.firstname} ${o.lastname}:`),console.log(`üîç [HUBSPOT MAPPING] - servizio_ecura (raw): ${o.servizio_ecura||"NULL/EMPTY"}`),console.log(`üîç [HUBSPOT MAPPING] - piano_ecura (raw): ${o.piano_ecura||"NULL/EMPTY"}`),console.log(`üîç [HUBSPOT MAPPING] - servizio_di_interesse (raw): ${o.servizio_di_interesse||"NULL/EMPTY"}`),console.log(`üîç [HUBSPOT MAPPING] - piano_desiderato (raw): ${o.piano_desiderato||"NULL/EMPTY"}`);let l="PRO";if(o.servizio_ecura)l=o.servizio_ecura.toUpperCase(),console.log(`üîç [HUBSPOT MAPPING] - Servizio da servizio_ecura: ${l}`);else if(o.servizio_di_interesse){const h=o.servizio_di_interesse.toLowerCase();h.includes("family")?l="FAMILY":h.includes("premium")||h.includes("vital")?l="PREMIUM":h.includes("pro")&&(l="PRO"),console.log(`üîç [HUBSPOT MAPPING] - Servizio da servizio_di_interesse: ${l}`)}else console.log(`üîç [HUBSPOT MAPPING] - Servizio default: ${l}`);let d="BASE";if(o.piano_ecura)d=o.piano_ecura.toUpperCase(),console.log(`üîç [HUBSPOT MAPPING] - Piano da piano_ecura: ${d}`);else if(o.piano_desiderato){const h=o.piano_desiderato.toLowerCase();(h.includes("avanzato")||h.includes("advanced"))&&(d="AVANZATO"),console.log(`üîç [HUBSPOT MAPPING] - Piano da piano_desiderato: ${d}`)}else console.log(`üîç [HUBSPOT MAPPING] - Piano default: ${d}`);console.log(`‚úÖ [HUBSPOT MAPPING] - Servizio finale: ${l}, Piano finale: ${d}`);const c=`eCura ${l}`,u=d;let p={setupBase:null,setupIva:null,setupTotale:null,rinnovoBase:null,rinnovoIva:null,rinnovoTotale:null};try{console.log(`üí∞ [HUBSPOT MAPPING] Calcolo prezzi per: servizio=${l}, piano=${d}`);const E=(await Promise.resolve().then(()=>sr)).calculatePrice(l,d);console.log("üí∞ [HUBSPOT MAPPING] Prezzi calcolati:",JSON.stringify(E,null,2)),p={setupBase:E.setupBase,setupIva:E.setupIva,setupTotale:E.setupTotale,rinnovoBase:E.rinnovoBase,rinnovoIva:E.rinnovoIva,rinnovoTotale:E.rinnovoTotale},console.log(`‚úÖ [HUBSPOT MAPPING] Prezzi assegnati: setupBase=${p.setupBase}, rinnovoBase=${p.rinnovoBase}`)}catch(h){console.error("‚ùå [HUBSPOT MAPPING] ERRORE calcolo prezzi:",h),console.error(`‚ùå [HUBSPOT MAPPING] Servizio: ${l}, Piano: ${d}`)}const m={new:"NEW",open:"CONTACTED",in_progress:"QUALIFIED",qualified:"QUALIFIED",unqualified:"LOST",contacted:"CONTACTED"}[o.hs_lead_status||"new"]||"NEW",b={nomeRichiedente:e,cognomeRichiedente:a,email:i,telefono:r,indirizzoIntestatario:s,nomeAssistito:o.nome_assistito||null,cognomeAssistito:o.cognome_assistito||null,servizio:c,piano:u,pacchetto:u,tipoServizio:"eCura",servizio_ecura:l,piano_ecura:d,prezzo_anno:p.setupBase,prezzo_rinnovo:p.rinnovoBase,status:m,fonte:"Form eCura",external_source_id:t.id,note:o.note_assistito||`Importato da HubSpot - ID: ${t.id}`,vuoleContratto:1,vuoleBrochure:1,vuoleManuale:0,gdprConsent:!0,consensoMarketing:!1,consensoTerze:!1,created_at:o.createdate||new Date().toISOString(),updated_at:o.lastmodifieddate||new Date().toISOString()};return console.log("üìã [HUBSPOT MAPPING] Lead finale da ritornare:"),console.log(`   - Nome: ${b.nomeRichiedente} ${b.cognomeRichiedente}`),console.log(`   - Servizio: ${b.servizio} (${b.servizio_ecura})`),console.log(`   - Piano: ${b.piano} (${b.piano_ecura})`),console.log(`   - Prezzo anno: ${b.prezzo_anno}`),console.log(`   - Prezzo rinnovo: ${b.prezzo_rinnovo}`),b}const ka=Object.freeze(Object.defineProperty({__proto__:null,HubSpotClient:ow,mapHubSpotContactToLead:aw},Symbol.toStringTag,{value:"Module"}));function w0(t){const o=new Date,e=t.days||1;return new Date(o.getTime()-e*24*60*60*1e3)}async function iw(t,o,e,a={enabled:!0,startHour:9,days:1,onlyEcura:!0,dryRun:!1}){var s;const i=Date.now(),r={success:!1,message:"",imported:0,skipped:0,errors:0,errorDetails:[],timeRange:{from:"",to:new Date().toISOString()},performance:{hubspotContacts:0,processingTimeMs:0}};try{if(!a.enabled)return r.message="Auto-import disabilitato",r;const l=o==null?void 0:o.HUBSPOT_ACCESS_TOKEN,d=o==null?void 0:o.HUBSPOT_PORTAL_ID;if(!l||!d)return r.message="Credenziali HubSpot non configurate",r.errorDetails.push("Mancano HUBSPOT_ACCESS_TOKEN o HUBSPOT_PORTAL_ID"),r;const{HubSpotClient:c,mapHubSpotContactToLead:u}=await Promise.resolve().then(()=>ka),p=w0(a);r.timeRange.from=p.toISOString();const g=a.days||1;console.log(`üîÑ [AUTO-IMPORT] Inizio import incrementale ultimi ${g} ${g===1?"giorno":"giorni"} (da ${p.toLocaleString("it-IT")})`),console.log(`üìä [AUTO-IMPORT] Config: onlyEcura=${a.onlyEcura}, dryRun=${a.dryRun}`);const m=new c(l,d),b={createdAfter:p.toISOString(),limit:100};a.onlyEcura&&(b.hs_object_source_detail_1="Form eCura",console.log("üîç [AUTO-IMPORT] Filtro attivo: solo lead da Form eCura"));const h=await m.searchContacts(b);if(r.performance.hubspotContacts=h.results.length,console.log(`üìä [AUTO-IMPORT] Trovati ${h.results.length} contatti HubSpot da processare`),h.results.length===0)return r.success=!0,r.message=`Nessun nuovo lead da importare (periodo: ${p.toLocaleTimeString("it-IT")} - ${new Date().toLocaleTimeString("it-IT")})`,r.performance.processingTimeMs=Date.now()-i,r;for(const E of h.results)try{if(await t.prepare(`
          SELECT id FROM leads 
          WHERE email = ? OR external_source_id = ?
          LIMIT 1
        `).bind(E.properties.email,E.id).first()){console.log(`‚è≠Ô∏è  [AUTO-IMPORT] Contact ${E.id} (${E.properties.email}) gi√† esistente, skip`),r.skipped++;continue}if(a.dryRun){console.log(`üîç [AUTO-IMPORT DRY-RUN] Contatto ${E.id} sarebbe stato importato`),r.imported++;continue}const S=await u(E);console.log("üîç [AUTO-IMPORT] Lead data mapped:",{nomeRichiedente:S.nomeRichiedente,email:S.email,hasEmail:!!S.email,emailLength:((s=S.email)==null?void 0:s.length)||0});const C=await t.prepare(`
          SELECT id FROM leads 
          WHERE id LIKE 'LEAD-IRBEMA-%' 
          ORDER BY id DESC 
          LIMIT 1
        `).first();let R=146;if(C!=null&&C.id){const L=C.id.match(/LEAD-IRBEMA-(\d+)/);L&&(R=parseInt(L[1])+1)}const z=`LEAD-IRBEMA-${R.toString().padStart(5,"0")}`;console.log(`üÜî [AUTO-IMPORT] Generato ID: ${z} per ${E.properties.email}`);const D=S.email||`noemail-${E.id}@placeholder.local`,F=S.telefono||"";console.log(`üìß [AUTO-IMPORT] Email: ${D}, Telefono: ${F}`),await t.prepare(`
          INSERT INTO leads (
            id, nomeRichiedente, cognomeRichiedente, email, telefono,
            nomeAssistito, cognomeAssistito,
            servizio, piano, tipoServizio,
            prezzo_anno, prezzo_rinnovo,
            fonte, external_source_id, status, note,
            vuoleContratto, vuoleBrochure, vuoleManuale,
            gdprConsent, consensoMarketing, consensoTerze,
            created_at, updated_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(z,S.nomeRichiedente,S.cognomeRichiedente,D,F,S.nomeAssistito,S.cognomeAssistito,S.servizio,S.piano,S.tipoServizio,S.prezzo_anno||null,S.prezzo_rinnovo||null,S.fonte,S.external_source_id,S.status,S.note,S.vuoleContratto,S.vuoleBrochure,S.vuoleManuale,S.gdprConsent?1:0,S.consensoMarketing?1:0,S.consensoTerze?1:0,new Date().toISOString(),new Date().toISOString()).run(),console.log(`‚úÖ [AUTO-IMPORT] Lead creato: ${z} from HubSpot ${E.id}`),console.log("üîî [AUTO-IMPORT] >>> INIZIO BLOCCO EMAIL <<<"),r.imported++;try{console.log(`üìß [AUTO-IMPORT] Invio email notifica tramite sendNewLeadNotification per ${z}...`);const{sendNewLeadNotification:L}=await Promise.resolve().then(()=>jp);await L(z,{nomeRichiedente:S.nomeRichiedente||"N/A",cognomeRichiedente:S.cognomeRichiedente||"",email:S.email||void 0,telefono:S.telefono||void 0,citta:void 0,servizio:S.servizio,piano:S.piano,fonte:"Form eCura",note:S.note||"",created_at:new Date().toISOString()},o),console.log(`‚úÖ [AUTO-IMPORT] Email notifica admin inviata con successo per ${z}`)}catch(L){console.error("‚ö†Ô∏è [AUTO-IMPORT] Errore invio email notifica admin:",L),console.error("‚ö†Ô∏è [AUTO-IMPORT] Error details:",{message:L.message,stack:L.stack,leadId:z})}try{const L=await t.prepare("SELECT value FROM settings WHERE key = 'lead_email_notifications_enabled' LIMIT 1").first(),M=(L==null?void 0:L.value)==="true";if(console.log("üîç [AUTO-IMPORT] Check email conditions:",{leadEmailEnabled:M,hasEmail:!!S.email,email:S.email,leadId:z}),M&&S.email){console.log("üö®üö®üö® [AUTO-IMPORT] INIZIO INVIO EMAIL AL LEAD üö®üö®üö®"),console.log(`üìß [AUTO-IMPORT] Email destinatario: ${S.email}`),console.log(`üìß Switch abilitato: ${M}`);try{const{createCompletionToken:j,getMissingFields:N,getSystemConfig:A}=await Promise.resolve().then(()=>at),x=(await Promise.resolve().then(()=>At)).default,{loadEmailTemplate:P,renderTemplate:B}=await Promise.resolve().then(()=>Pa),J=await t.prepare("SELECT * FROM leads WHERE id = ?").bind(z).first();if(!J)throw console.error(`‚ùå [AUTO-IMPORT] Lead ${z} non trovato in DB dopo inserimento`),new Error("Lead not found after insert");const ae=await A(t),ie=await j(t,z,ae.auto_completion_token_days);console.log(`‚úÖ [AUTO-IMPORT] Token creato: ${ie.token}`);const Z=(o==null?void 0:o.PUBLIC_URL)||(o==null?void 0:o.PAGES_URL)||"https://telemedcare-v12.pages.dev",H=`${Z}/api/form/${z}?leadId=${z}`,{missing:We,available:Se}=N(J),ut=await P("email_richiesta_completamento_form",t,o),Je=Object.entries(Se).map(([Ge,Q])=>({FIELD_LABEL:Ge,FIELD_VALUE:Q})),Ft={telefono:{label:"Telefono",type:"tel",placeholder:"+39 3XX XXX XXXX",required:!0},telefono:{label:"Telefono",type:"tel",placeholder:"+39 3XX XXX XXXX",required:!0},cittaIntestatario:{label:"Citt√†",type:"text",placeholder:"Es. Milano",required:!0},citta:{label:"Citt√†",type:"text",placeholder:"Es. Milano",required:!0},nomeAssistito:{label:"Nome Assistito",type:"text",placeholder:"Nome",required:!0},cognomeAssistito:{label:"Cognome Assistito",type:"text",placeholder:"Cognome",required:!0},dataNascitaAssistito:{label:"Data Nascita Assistito",type:"date",placeholder:"",required:!0},cittaAssistito:{label:"Citt√† Assistito",type:"text",placeholder:"Es. Roma",required:!0},cfAssistito:{label:"Codice Fiscale Assistito",type:"text",placeholder:"Es. RSSMRA85M01H501X",required:!1},indirizzoAssistito:{label:"Indirizzo Assistito",type:"text",placeholder:"Via, numero civico",required:!1},servizio:{label:"Servizio",type:"select",required:!0,options:[{value:"eCura FAMILY",label:"eCura FAMILY - Monitoraggio base"},{value:"eCura PRO",label:"eCura PRO - Assistenza completa"},{value:"eCura PREMIUM",label:"eCura PREMIUM - Assistenza avanzata"}]},piano:{label:"Piano",type:"select",required:!0,options:[{value:"BASE",label:"BASE - Mensile"},{value:"AVANZATO",label:"AVANZATO - Trimestrale (sconto 5%)"}]}},pt=We.map(Ge=>{const Q=Ft[Ge]||{label:Ge.charAt(0).toUpperCase()+Ge.slice(1),type:"text",placeholder:"",required:!1};return{FIELD_ID:Ge,FIELD_NAME:Ge,FIELD_LABEL:Q.label,INPUT_TYPE:Q.type,PLACEHOLDER:Q.placeholder||"",IS_REQUIRED:Q.required,IS_INPUT:Q.type!=="select"&&Q.type!=="textarea",IS_SELECT:Q.type==="select",IS_TEXTAREA:Q.type==="textarea",OPTIONS:Q.options||[]}}),$o={NOME_CLIENTE:J.nomeRichiedente,COGNOME_CLIENTE:J.cognomeRichiedente,SERVIZIO:J.servizio||J.tipoServizio||"eCura PRO",PIANO:J.piano||J.pacchetto||"BASE",LEAD_ID:z,API_ENDPOINT:Z,COMPLETION_URL:H,BROCHURE_URL:`${Z}/assets/brochures/brochure-ecura.pdf`,EXPIRES_IN_DAYS:ae.auto_completion_token_days.toString(),AVAILABLE_FIELDS:Je,MISSING_FIELDS:pt},fe=B(ut,$o);await new x(o).sendEmail({to:J.email||J.email,from:(o==null?void 0:o.EMAIL_FROM)||"info@telemedcare.it",subject:"üìù Completa la tua richiesta eCura - Ultimi dettagli necessari",html:fe,text:`Gentile ${J.nomeRichiedente}, per completare la tua richiesta eCura abbiamo bisogno di alcuni dati aggiuntivi. Rispondi a questa email o contattaci a info@telemedcare.it`}),console.log(`‚úÖ‚úÖ‚úÖ [AUTO-IMPORT] Email completamento inviata a ${S.email} ‚úÖ‚úÖ‚úÖ`)}catch(j){console.error("‚ö†Ô∏è [AUTO-IMPORT] Errore email completamento:",j),console.error("‚ö†Ô∏è [AUTO-IMPORT] Error details:",{message:j.message,stack:j.stack,leadId:z})}}else console.log("‚è≠Ô∏è‚è≠Ô∏è‚è≠Ô∏è [AUTO-IMPORT] Email completamento dati NON inviata ‚è≠Ô∏è‚è≠Ô∏è‚è≠Ô∏è"),console.log(`   leadEmailEnabled: ${M}`),console.log(`   leadData.email: ${S.email||"MISSING"}`),console.log(`   Motivo: ${M?"Email mancante":"Switch OFF"}`)}catch(L){console.error("‚ö†Ô∏è [AUTO-IMPORT] Errore workflow completamento dati:",L),console.error("‚ö†Ô∏è [AUTO-IMPORT] Error details:",{message:L.message,stack:L.stack,leadId:z})}console.log("üîî [AUTO-IMPORT] >>> FINE BLOCCO EMAIL <<<")}catch(w){console.error(`‚ùå [AUTO-IMPORT] Errore import contact ${E.id}:`,w),r.errors++,r.errorDetails.push({contactId:E.id,email:E.properties.email,error:w.message})}return r.success=!0,r.message=a.dryRun?`Dry run: ${r.imported} lead sarebbero stati importati`:`Import completato: ${r.imported} nuovi lead importati, ${r.skipped} gi√† esistenti`,r.performance.processingTimeMs=Date.now()-i,console.log(`‚úÖ [AUTO-IMPORT] Completato in ${r.performance.processingTimeMs}ms`),console.log(`üìä [AUTO-IMPORT] Risultati: ${r.imported} importati, ${r.skipped} skipped, ${r.errors} errori`),r}catch(l){return console.error("‚ùå [AUTO-IMPORT] Errore generale:",l),r.success=!1,r.message=`Errore import: ${l.message}`,r.errorDetails.push(l.message),r.performance.processingTimeMs=Date.now()-i,r}}async function rw(t,o){console.log("üìù [AUTO-IMPORT LOG]",JSON.stringify({imported:o.imported,skipped:o.skipped,errors:o.errors,timeRange:o.timeRange}))}const sw=Object.freeze(Object.defineProperty({__proto__:null,executeAutoImport:iw,getIncrementalStartTime:w0,logAutoImport:rw},Symbol.toStringTag,{value:"Module"})),I0={GLUCOSE_METER:{id:"glucose_meter",name:"Glucometro",category:"diabetes",icon:"ü©∏",description:"Misurazione glicemia",normalRanges:{fasting:{min:70,max:110},postMeal:{min:70,max:140},bedtime:{min:100,max:140}},supportedBrands:["OneTouch","Accu-Chek","FreeStyle","Contour"]},BLOOD_PRESSURE:{id:"blood_pressure",name:"Sfigmomanometro",category:"cardiovascular",icon:"ü©∫",description:"Misurazione pressione arteriosa",normalRanges:{systolic:{min:90,max:139},diastolic:{min:60,max:89},pulse:{min:60,max:100}},supportedBrands:["Omron","Microlife","Braun","Beurer"]},OXIMETER:{id:"oximeter",name:"Pulsossimetro",category:"respiratory",icon:"ü´Å",description:"Misurazione saturazione ossigeno",normalRanges:{spo2:{min:95,max:100},heartRate:{min:60,max:100}},supportedBrands:["Nonin","Masimo","Contec","Zacurate"]},WEIGHT_SCALE:{id:"weight_scale",name:"Bilancia",category:"metabolic",icon:"‚öñÔ∏è",description:"Misurazione peso corporeo",normalRanges:{bmi:{min:18.5,max:24.9}},supportedBrands:["Withings","Fitbit","Garmin","Tanita"]},ECG_MONITOR:{id:"ecg_monitor",name:"Monitor ECG",category:"cardiovascular",icon:"üìà",description:"Elettrocardiogramma portatile",normalRanges:{heartRate:{min:60,max:100},qtInterval:{min:350,max:440}},supportedBrands:["KardiaMobile","Apple Watch","Withings","Healforce"]}},Ga=class Ga{static getInstance(){return Ga.instance||(Ga.instance=new Ga),Ga.instance}async associateDevice(o,e){try{const a=`DEV_${Date.now()}_${Math.random().toString(36).substring(2)}`;console.log("üì± Associazione nuovo dispositivo:",{customer:o,type:e.deviceType,model:`${e.brand} ${e.model}`});const i=await this.findDeviceBySerial(e.serialNumber);if(i&&i.customerId&&i.customerId!==o)return{success:!1,error:"Dispositivo gi√† associato ad altro cliente"};const r=await this.getCustomerInfo(o),l={...this.createDefaultSettings(e.deviceType),...e.settings},d={id:a,deviceType:e.deviceType,brand:e.brand,model:e.model,serialNumber:e.serialNumber,macAddress:e.macAddress,bluetoothId:e.bluetoothId,customerId:o,customerName:r.name,customerEmail:r.email,status:"ACTIVE",connectionType:"BLUETOOTH",settings:l,alerts:[],installDate:new Date().toISOString(),syncEnabled:!0,googleSheetId:e.googleSheetId,syncFrequency:15,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),tags:["new-device"]};return await this.saveDevice(d),e.googleSheetId&&await this.setupGoogleSheetsIntegration(d),await this.setupDefaultAlerts(d),console.log(`‚úÖ Dispositivo associato: ${a}`),{success:!0,device:d}}catch(a){return console.error("‚ùå Errore associazione dispositivo:",a),{success:!1,error:a instanceof Error?a.message:"Errore associazione dispositivo"}}}async recordReading(o,e){var a;try{const i=`READ_${Date.now()}_${Math.random().toString(36).substring(2)}`;console.log(`üìä Registrazione lettura dispositivo ${o}:`,e);const r=await this.getDeviceById(o);if(!r)return{success:!1,error:"Dispositivo non trovato"};const s={id:i,deviceId:o,customerId:r.customerId,readingTime:e.readingTime||new Date().toISOString(),recordedAt:new Date().toISOString(),glucoseLevel:e.glucoseLevel,bloodPressure:e.bloodPressure,oxygenSaturation:e.oxygenSaturation,heartRate:e.heartRate,bodyTemperature:e.bodyTemperature,weight:e.weight,mealContext:e.mealContext,activityContext:e.activityContext,medicationContext:e.medicationContext,quality:this.assessReadingQuality(r,e),confidence:this.calculateConfidence(r,e),isManual:e.isManual||!1,isNormal:!1,requiresAttention:!1,trend:await this.calculateTrend(o,e),sentToDoctor:!1,notes:e.notes,tags:[],createdAt:new Date().toISOString()};s.weight&&((a=r.settings.weightScale)!=null&&a.targetWeight)&&(s.bmi=s.weight/Math.pow(170/100,2));const l=this.evaluateReading(r,s);s.isNormal=l.isNormal,s.requiresAttention=l.requiresAttention,await this.saveReading(s),r.lastReading=s,r.lastConnection=new Date().toISOString(),r.updatedAt=new Date().toISOString(),await this.saveDevice(r);const d=await this.checkAndCreateAlerts(r,s,l);return r.syncEnabled&&r.googleSheetId&&await this.syncToGoogleSheets(r,s),s.requiresAttention&&await this.notifyStakeholders(r,s,d),console.log(`‚úÖ Lettura registrata: ${i} (Normale: ${s.isNormal})`),{success:!0,reading:s,alerts:d}}catch(i){return console.error("‚ùå Errore registrazione lettura:",i),{success:!1,error:i instanceof Error?i.message:"Errore registrazione lettura"}}}async getCustomerDevices(o){try{return console.log(`üîç Ricerca dispositivi cliente: ${o}`),{success:!0,devices:[{id:"DEV_001",deviceType:"GLUCOSE_METER",brand:"OneTouch",model:"Verio Reflect",serialNumber:"OT123456789",customerId:o,customerName:"Mario Rossi",customerEmail:"mario.rossi@example.com",status:"ACTIVE",connectionType:"BLUETOOTH",lastConnection:new Date(Date.now()-7200*1e3).toISOString(),batteryLevel:85,settings:this.createDefaultSettings("GLUCOSE_METER"),alerts:[],installDate:new Date(Date.now()-720*60*60*1e3).toISOString(),syncEnabled:!0,syncFrequency:15,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:"DEV_002",deviceType:"BLOOD_PRESSURE",brand:"Omron",model:"M6 Comfort",serialNumber:"OM987654321",customerId:o,customerName:"Mario Rossi",customerEmail:"mario.rossi@example.com",status:"ACTIVE",connectionType:"BLUETOOTH",lastConnection:new Date(Date.now()-3600*1e3).toISOString(),batteryLevel:92,settings:this.createDefaultSettings("BLOOD_PRESSURE"),alerts:[],installDate:new Date(Date.now()-360*60*60*1e3).toISOString(),syncEnabled:!0,syncFrequency:30,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}]}}catch(e){return console.error("‚ùå Errore ricerca dispositivi cliente:",e),{success:!1,error:e instanceof Error?e.message:"Errore ricerca dispositivi"}}}async getDeviceReadings(o,e){try{console.log(`üìä Ricerca letture dispositivo ${o}:`,e);const a=[{id:"READ_001",deviceId:o,customerId:"CUST_001",readingTime:new Date(Date.now()-7200*1e3).toISOString(),recordedAt:new Date(Date.now()-7200*1e3).toISOString(),glucoseLevel:110,mealContext:"FASTING",quality:"EXCELLENT",confidence:95,isManual:!1,isNormal:!0,requiresAttention:!1,trend:"STABLE",sentToDoctor:!1,createdAt:new Date().toISOString()},{id:"READ_002",deviceId:o,customerId:"CUST_001",readingTime:new Date(Date.now()-360*60*1e3).toISOString(),recordedAt:new Date(Date.now()-360*60*1e3).toISOString(),bloodPressure:{systolic:125,diastolic:80,pulse:72},quality:"GOOD",confidence:88,isManual:!1,isNormal:!0,requiresAttention:!1,trend:"IMPROVING",sentToDoctor:!1,createdAt:new Date().toISOString()}],i={totalReadings:a.length,normalReadings:a.filter(r=>r.isNormal).length,anomalousReadings:a.filter(r=>!r.isNormal).length,averageValue:a.reduce((r,s)=>{var l;return r+(s.glucoseLevel||((l=s.bloodPressure)==null?void 0:l.systolic)||0)},0)/a.length,trend:"STABLE"};return{success:!0,readings:a,stats:i}}catch(a){return console.error("‚ùå Errore ricerca letture:",a),{success:!1,error:a instanceof Error?a.message:"Errore ricerca letture"}}}async getDeviceStatistics(o){try{return console.log("üìä Calcolo statistiche dispositivi"),{totalDevices:347,activeDevices:289,offlineDevices:12,totalReadings:15642,recentReadings:127,criticalAlerts:3,devicesByType:{GLUCOSE_METER:89,BLOOD_PRESSURE:134,OXIMETER:67,WEIGHT_SCALE:45,ECG_MONITOR:12},batteryStatus:{low:23,medium:87,high:237},syncStatus:{synced:267,pending:18,failed:4}}}catch(e){throw console.error("‚ùå Errore calcolo statistiche dispositivi:",e),e}}async getCustomerInfo(o){return{name:"Mario Rossi",email:"mario.rossi@example.com"}}async findDeviceBySerial(o){return console.log(`üîç Ricerca dispositivo per serial: ${o}`),null}async getDeviceById(o){return console.log(`üîç Ricerca dispositivo per ID: ${o}`),{id:o,deviceType:"GLUCOSE_METER",brand:"OneTouch",model:"Verio Reflect",serialNumber:"OT123456789",customerId:"CUST_001",customerName:"Mario Rossi",customerEmail:"mario.rossi@example.com",status:"ACTIVE",connectionType:"BLUETOOTH",settings:this.createDefaultSettings("GLUCOSE_METER"),alerts:[],installDate:new Date().toISOString(),syncEnabled:!0,syncFrequency:15,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}}createDefaultSettings(o){const e={measurementUnit:"METRIC",timezone:"Europe/Rome",language:"IT",notifications:{enabled:!0,email:!0,sms:!1,push:!0,emergencyContacts:[]},automations:{autoSync:!0,smartReminders:!0,doctorAlerts:!0,familySharing:!1}};switch(o){case"GLUCOSE_METER":e.glucoseMeter={targetMin:70,targetMax:140,mealOffset:120,insulinType:"rapid"};break;case"BLOOD_PRESSURE":e.bloodPressure={systolicMin:90,systolicMax:139,diastolicMin:60,diastolicMax:89,measurementPosition:"ARM"};break;case"OXIMETER":e.oximeter={spo2Min:95,heartRateMin:60,heartRateMax:100,alarmEnabled:!0};break;case"WEIGHT_SCALE":e.weightScale={targetWeight:70,weightGoal:"MAINTAIN",weeklyTarget:.5};break}return e}assessReadingQuality(o,e){return e.isManual||o.batteryLevel&&o.batteryLevel<20?"FAIR":!o.lastConnection||new Date(o.lastConnection)<new Date(Date.now()-1440*60*1e3)?"GOOD":"EXCELLENT"}calculateConfidence(o,e){let a=100;return e.isManual&&(a-=20),o.batteryLevel&&o.batteryLevel<20&&(a-=10),(!o.calibrationData||new Date(o.calibrationData.nextCalibrationDue)<new Date)&&(a-=15),Math.max(0,a)}async calculateTrend(o,e){return console.log(`üìà Calcolo trend per dispositivo: ${o}`),"STABLE"}evaluateReading(o,e){const a=I0[o.deviceType];let i=!0,r=!1,s=0;if(e.glucoseLevel&&a.normalRanges){const l=a.normalRanges,d=e.mealContext==="FASTING"?l.fasting:l.postMeal;d&&(i=e.glucoseLevel>=d.min&&e.glucoseLevel<=d.max,e.glucoseLevel<70?(r=!0,s=e.glucoseLevel<54?9:6):e.glucoseLevel>250&&(r=!0,s=8))}if(e.bloodPressure&&a.normalRanges){const l=a.normalRanges,{systolic:d,diastolic:c}=e.bloodPressure;i=d>=l.systolic.min&&d<=l.systolic.max&&c>=l.diastolic.min&&c<=l.diastolic.max,d>180||c>110?(r=!0,s=9):(d<90||c<60)&&(r=!0,s=6)}return{isNormal:i,requiresAttention:r,severity:s}}async checkAndCreateAlerts(o,e,a){const i=[];if(a.requiresAttention){const s={id:`ALERT_${Date.now()}_${Math.random().toString(36).substring(2)}`,deviceId:o.id,customerId:o.customerId,type:a.severity>=8?"CRITICAL":"WARNING",category:"READING_ANOMALY",title:this.getAlertTitle(o.deviceType,e,a.severity),message:this.getAlertMessage(o.deviceType,e,a.severity),severity:a.severity,triggeredBy:"READING",triggerValue:this.getReadingValue(e),status:"ACTIVE",actionsTaken:[],escalationLevel:0,notificationsSent:{patient:!1,doctor:!1,family:!1,emergency:!1},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};i.push(s),o.alerts.push(s),console.log(`üö® Alert creato: ${s.type} - ${s.title}`)}return i}getAlertTitle(o,e,a){if(o==="GLUCOSE_METER"&&e.glucoseLevel){if(e.glucoseLevel<70)return a>=9?"IPOGLICEMIA SEVERA":"Ipoglicemia";if(e.glucoseLevel>250)return"IPERGLICEMIA SEVERA"}if(o==="BLOOD_PRESSURE"&&e.bloodPressure){if(e.bloodPressure.systolic>180)return"CRISI IPERTENSIVA";if(e.bloodPressure.systolic<90)return"Ipotensione"}return"Valore Anomalo"}getAlertMessage(o,e,a){return o==="GLUCOSE_METER"&&e.glucoseLevel&&e.glucoseLevel<70?`Glicemia molto bassa: ${e.glucoseLevel} mg/dL. ${a>=9?"CONTATTARE IMMEDIATAMENTE IL MEDICO!":"Assumere zuccheri rapidamente."}`:"Rilevato valore fuori range normale. Consultare il medico."}getReadingValue(o){return o.glucoseLevel||o.bloodPressure||o.oxygenSaturation||o.weight}async saveDevice(o){console.log(`üíæ Salvataggio dispositivo: ${o.id}`)}async saveReading(o){console.log(`üíæ Salvataggio lettura: ${o.id}`)}async setupGoogleSheetsIntegration(o){console.log(`üìä Setup Google Sheets per dispositivo: ${o.id}`)}async setupDefaultAlerts(o){console.log(`üîî Setup alert default per dispositivo: ${o.id}`)}async syncToGoogleSheets(o,e){o.googleSheetId&&console.log(`üìä Sync a Google Sheets: ${o.googleSheetId}`)}async notifyStakeholders(o,e,a){console.log(`üìß Notifica stakeholder per alert critici: ${o.id}`)}async readCompleteCELabel(o){try{console.log(`üè∑Ô∏è [CE LABEL] Lettura completa etichetta CE dispositivo: ${o}`);const e={imei:"868298061208378",udiCode:"SIDLY868298061208378240531",udiDI:"(01)05060301000017",udiPI:"(11)240531(21)868298061208378",manufacturingDate:"05/2023",manufacturingDateISO:"2023-05-01T00:00:00.000Z",expiryDate:this.calculateDeviceExpiry("2023-05-01","SIDLY_CARE_PRO").expiryDate,warrantyExpiry:this.calculateWarrantyExpiry("2023-05-01",24),modelCode:"SIDLY-CP-2023-V1",batchLot:"LOT240531A",softwareVersion:"v2.4.1",hardwareVersion:"HW-1.2",ceMarkCode:"CE0123",notifiedBodyNumber:"0123",medicalDeviceClass:"IIa",riskClass:"MEDIUM_RISK",complianceStandards:["ISO 13485:2016","ISO 14971:2019","IEC 62304:2006","ISO 62366-1:2015","EN 60601-1:2006"],regulatoryStatus:"CE_MARKED",manufacturerName:"SiDLY Medical Technologies S.r.l.",manufacturerCode:"SIDLY-IT-001",manufacturerAddress:"Via delle Tecnologie, 15 - 20900 Milano, Italy",authorizedRep:"SiDLY EU Representative B.V.",qcPassedDate:"2023-05-30T14:30:00.000Z",calibrationDate:"2023-05-29T10:15:00.000Z",nextCalibrationDue:"2024-05-29T10:15:00.000Z",deviceLifespan:24,remainingLifespan:this.calculateRemainingDays("2023-05-01",24),lifecycleStatus:this.determineLifecycleStatus("2023-05-01",24),storageConditions:{temperatureMin:-10,temperatureMax:60,humidityMax:85,pressureRange:"500-1060 hPa"},sterilizationMethod:"GAMMA",sterileUntil:"2025-05-01T23:59:59.000Z",ifu:"IFU-SIDLY-CP-IT-v2.4",technicalDocumentation:"TD-SIDLY-CP-2023-001",riskAnalysisRef:"RA-SIDLY-CP-v1.2"},a=this.validateCELabel(e),i=this.generateCERecommendations(e);a.length>0&&console.warn("‚ö†Ô∏è [CE LABEL] Errori validazione:",a);const r=await this.getDeviceById(o);return r&&(r.ceLabel=e,r.imei=e.imei,r.deviceType="SIDLY_CARE_PRO",r.updatedAt=new Date().toISOString(),await this.saveDevice(r)),{success:!0,ceLabel:e,validationErrors:a.length>0?a:void 0,recommendations:i}}catch(e){return console.error("‚ùå [CE LABEL] Errore lettura etichetta CE:",e),{success:!1,error:e instanceof Error?e.message:"Errore lettura etichetta CE completa"}}}validateCELabel(o){const e=[];this.validateIMEI(o.imei)||e.push(`IMEI non valido: ${o.imei}`),(!o.udiCode||o.udiCode.length<10)&&e.push("UDI Code mancante o troppo corto");const a=new Date(o.manufacturingDateISO),i=new Date(o.expiryDate);return isNaN(a.getTime())&&e.push("Data fabbricazione non valida"),isNaN(i.getTime())&&e.push("Data scadenza non valida"),a>i&&e.push("Data fabbricazione posteriore alla scadenza"),["I","IIa","IIb","III"].includes(o.medicalDeviceClass)||e.push(`Classe dispositivo medico non valida: ${o.medicalDeviceClass}`),(!o.notifiedBodyNumber||!/^\d{4}$/.test(o.notifiedBodyNumber))&&e.push("Numero ente notificato deve essere 4 cifre"),o.storageConditions.temperatureMin>=o.storageConditions.temperatureMax&&e.push("Range temperatura stoccaggio non valido"),e}generateCERecommendations(o){const e=[],a=Math.ceil((new Date(o.expiryDate).getTime()-Date.now())/864e5);a<0?e.push("üö® URGENTE: Dispositivo scaduto - Sostituire immediatamente"):a<=30?e.push("‚ö†Ô∏è ATTENZIONE: Dispositivo in scadenza entro 30 giorni - Pianificare sostituzione"):a<=90&&e.push("üìÖ INFO: Dispositivo in scadenza entro 90 giorni - Monitorare");const i=Math.ceil((new Date(o.nextCalibrationDue).getTime()-Date.now())/(1e3*60*60*24));if(i<0?e.push("üîß MANUTENZIONE: Calibrazione scaduta - Programmare immediatamente"):i<=7&&e.push("üîß MANUTENZIONE: Calibrazione dovuta entro 7 giorni"),o.sterilizationMethod!=="NONE"){const r=new Date(o.sterileUntil),s=Math.ceil((r.getTime()-Date.now())/(1e3*60*60*24));s<0?e.push("ü¶† IGIENE: Sterilizzazione scaduta - Ri-sterilizzare prima dell'uso"):s<=30&&e.push("ü¶† IGIENE: Sterilizzazione in scadenza entro 30 giorni")}return o.remainingLifespan<=30&&e.push("üìä LIFECYCLE: Dispositivo vicino al fine vita - Valutare sostituzione"),e}calculateRemainingDays(o,e){const a=new Date(o),i=new Date(a);i.setMonth(i.getMonth()+e);const r=new Date,s=i.getTime()-r.getTime();return Math.ceil(s/(1e3*60*60*24))}determineLifecycleStatus(o,e){const a=this.calculateRemainingDays(o,e);if(a<0)return"END_OF_LIFE";if(a<=30)return"MAINTENANCE";const i=e*30;return(i-a)/i*100<10?"NEW":"ACTIVE"}calculateWarrantyExpiry(o,e){const a=new Date(o),i=new Date(a);return i.setMonth(i.getMonth()+e),i.toISOString().split("T")[0]}async readDeviceIMEI(o){try{console.log(`üì± [IMEI] Lettura IMEI dispositivo: ${o}`);const e=this.generateValidIMEI();if(!this.validateIMEI(e))return{success:!1,error:"IMEI non valido - fallito controllo Luhn"};const a=this.parseIMEIInfo(e),i=await this.getDeviceById(o);return i&&(i.imei=e,i.updatedAt=new Date().toISOString()),{success:!0,imei:e,deviceInfo:{...a,readTime:new Date().toISOString(),deviceType:(i==null?void 0:i.deviceType)||"SiDLY_CARE_PRO"}}}catch(e){return console.error("‚ùå [IMEI] Errore lettura IMEI:",e),{success:!1,error:e instanceof Error?e.message:"Errore lettura IMEI"}}}calculateDeviceExpiry(o,e="SiDLY_CARE_PRO"){try{const a=new Date(o),i={SiDLY_CARE_PRO:24,GLUCOSE_METER:36,BLOOD_PRESSURE:24,OXIMETER:18,ECG_MONITOR:60,DEFAULT:24},r=i[e]||i.DEFAULT,s=new Date(a);s.setMonth(s.getMonth()+r);const l=new Date,d=s.getTime()-l.getTime(),c=Math.ceil(d/(1e3*60*60*24));let u,p;return c<0?(u="EXPIRED",p="üö® URGENTE: Sostituire dispositivo immediatamente"):c<=30?(u="EXPIRING",p="‚ö†Ô∏è ATTENZIONE: Pianificare sostituzione entro 30 giorni"):(u="VALID",p="‚úÖ Dispositivo in garanzia - Nessuna azione richiesta"),{expiryDate:s.toISOString().split("T")[0],daysRemaining:c,warrantyStatus:u,recommendedAction:p}}catch(a){return console.error("‚ùå Errore calcolo scadenza:",a),{expiryDate:"N/A",daysRemaining:0,warrantyStatus:"EXPIRED",recommendedAction:"‚ùå Errore calcolo - Verificare data fabbricazione"}}}generateValidIMEI(){const o="35742108",e=Math.floor(1e5+Math.random()*9e5).toString(),a=o+e,i=this.calculateLuhnDigit(a);return a+i}validateIMEI(o){if(o.length!==15||!/^\d+$/.test(o))return!1;const e=o.split("").map(Number);let a=0;for(let r=0;r<14;r++){let s=e[r];r%2===1&&(s*=2,s>9&&(s-=9)),a+=s}return(10-a%10)%10===e[14]}calculateLuhnDigit(o){const e=o.split("").map(Number);let a=0;for(let i=0;i<e.length;i++){let r=e[i];i%2===1&&(r*=2,r>9&&(r-=9)),a+=r}return((10-a%10)%10).toString()}parseIMEIInfo(o){const e=o.substring(0,8),a=o.substring(8,14),r={35742108:{manufacturer:"SiDLY Medical",model:"Care Pro"},35742109:{manufacturer:"SiDLY Medical",model:"Care Advanced"},35742110:{manufacturer:"SiDLY Medical",model:"Care Basic"}}[e]||{manufacturer:"Unknown",model:"Unknown Device"};return{tac:e,snr:a,manufacturer:r.manufacturer,deviceModel:r.model,isValid:this.validateIMEI(o)}}async registerDeviceLevel1(o){var e,a;try{console.log("üì± [LIVELLO 1] Registrazione base dispositivo:",o.serialNumber);const i=`DEV_L1_${Date.now()}_${Math.random().toString(36).substring(2)}`,r=await this.readCompleteCELabel(i);if(!r.success)return{success:!1,error:"Impossibile leggere etichetta CE"};const s={id:i,deviceType:o.deviceType,serialNumber:o.serialNumber,brand:((e=r.ceLabel)==null?void 0:e.manufacturerName)||"SiDLY Medical",model:((a=r.ceLabel)==null?void 0:a.modelCode)||"Care Pro",ceLabel:r.ceLabel,status:"ACTIVE",connectionType:"MANUAL",installDate:new Date().toISOString(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return await this.saveDevice(s),{success:!0,deviceId:i}}catch(i){return console.error("‚ùå [LIVELLO 1] Errore registrazione:",i),{success:!1,error:i instanceof Error?i.message:"Errore registrazione livello 1"}}}async configureDeviceLevel2(o,e){try{console.log("‚öôÔ∏è [LIVELLO 2] Configurazione avanzata dispositivo:",o);const a=await this.getDeviceById(o);return a?(a.customerId=e.customerId,a.connectionType=e.connectionType,a.location=e.location,a.updatedAt=new Date().toISOString(),e.settings&&(a.settings={...a.settings,...e.settings}),e.connectionType!=="MANUAL"&&(a.syncEnabled=!0,a.syncFrequency=15,await this.setupDeviceAutomation(a)),await this.saveDevice(a),{success:!0}):{success:!1,error:"Dispositivo non trovato"}}catch(a){return console.error("‚ùå [LIVELLO 2] Errore configurazione:",a),{success:!1,error:a instanceof Error?a.message:"Errore configurazione livello 2"}}}async enableDeviceLevel3(o,e){try{console.log("üîÑ [LIVELLO 3] Integrazione completa dispositivo:",o);const a=await this.getDeviceById(o);return a?(e.enableRealTimeMonitoring&&await this.enableRealTimeMonitoring(a),e.enableAlerting&&await this.setupAdvancedAlerting(a,e.emergencyContacts),e.enableGoogleSheets&&e.googleSheetId&&(a.googleSheetId=e.googleSheetId,await this.setupGoogleSheetsIntegration(a)),e.enableDoctorIntegration&&e.doctorEmail&&await this.setupDoctorIntegration(a,e.doctorEmail),a.updatedAt=new Date().toISOString(),await this.saveDevice(a),{success:!0}):{success:!1,error:"Dispositivo non trovato"}}catch(a){return console.error("‚ùå [LIVELLO 3] Errore integrazione:",a),{success:!1,error:a instanceof Error?a.message:"Errore integrazione livello 3"}}}async enableDeviceLevel4(o,e){try{console.log("üß† [LIVELLO 4] Analytics e AI dispositivo:",o);const a=await this.getDeviceById(o);if(!a)return{success:!1,error:"Dispositivo non trovato"};const i={deviceId:o,predictiveAnalytics:e.enablePredictiveAnalytics,trendAnalysis:e.enableTrendAnalysis,anomalyDetection:e.enableAnomalyDetection,personalizedRecommendations:e.enablePersonalizedRecommendations,aiModel:e.aiModelType||"BASIC",enabledAt:new Date().toISOString()};return await this.setupMLPipeline(a,i),await this.initializeAIBaseline(a),a.updatedAt=new Date().toISOString(),await this.saveDevice(a),{success:!0}}catch(a){return console.error("‚ùå [LIVELLO 4] Errore setup AI:",a),{success:!1,error:a instanceof Error?a.message:"Errore setup AI livello 4"}}}async enableDeviceLevel5(o,e){try{console.log("üè¢ [LIVELLO 5] Integrazione Enterprise:",o);const a=await this.getDeviceById(o);return a?(e.enableHISIntegration&&await this.setupHISIntegration(a,e.organizationId),e.enableHL7Integration&&await this.setupHL7Integration(a),e.enableGDPRCompliance&&await this.setupGDPRCompliance(a),e.enableAuditTrail&&await this.setupAuditTrail(a),e.enableRegulatoryReporting&&await this.setupRegulatoryReporting(a,e.complianceLevel),a.updatedAt=new Date().toISOString(),await this.saveDevice(a),{success:!0}):{success:!1,error:"Dispositivo non trovato"}}catch(a){return console.error("‚ùå [LIVELLO 5] Errore setup Enterprise:",a),{success:!1,error:a instanceof Error?a.message:"Errore setup Enterprise livello 5"}}}async setupDeviceAutomation(o){console.log(`ü§ñ Setup automazione dispositivo: ${o.id}`)}async enableRealTimeMonitoring(o){console.log(`üì° Attivazione monitoraggio real-time: ${o.id}`)}async setupAdvancedAlerting(o,e){console.log(`üö® Setup alerting avanzato: ${o.id}`)}async setupDoctorIntegration(o,e){console.log(`üë®‚Äç‚öïÔ∏è Setup integrazione medico: ${o.id} -> ${e}`)}async setupMLPipeline(o,e){console.log(`üß† Setup pipeline ML: ${o.id}`)}async initializeAIBaseline(o){console.log(`üìä Inizializzazione baseline AI: ${o.id}`)}async setupHISIntegration(o,e){console.log(`üè• Setup integrazione HIS: ${o.id} -> ${e}`)}async setupHL7Integration(o){console.log(`üìã Setup HL7 FHIR: ${o.id}`)}async setupGDPRCompliance(o){console.log(`üîí Setup GDPR compliance: ${o.id}`)}async setupAuditTrail(o){console.log(`üìù Setup audit trail: ${o.id}`)}async setupRegulatoryReporting(o,e){console.log(`üìä Setup regulatory reporting: ${o.id} -> ${e}`)}};O(Ga,"instance",null);let zd=Ga;const S0=Object.freeze(Object.defineProperty({__proto__:null,DEVICE_TYPES:I0,DeviceManager:zd,default:zd},Symbol.toStringTag,{value:"Module"}));class eg{static async generateProforma(o,e){try{console.log("üìÑ [PROFORMA] Generazione proforma per contratto:",o.codiceContratto),console.log("üìÑ [PROFORMA] Piano:",o.piano,"| Servizio:",o.servizio);const a=this.generateProformaNumber(),i=`PROF_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,r={...o,numeroProforma:a,dataEmissione:o.dataEmissione||new Date().toLocaleDateString("it-IT"),dataScadenza:o.dataScadenza||this.calculateScadenza(7)},s=await this.generateProformaHTML(r),l=Buffer.from(s).toString("base64");return await e.prepare(`
        INSERT INTO proformas (
          id, numero_proforma, contract_code, servizio, piano,
          importo_base, iva, totale, status,
          pdf_url, stripe_payment_link, created_at, updated_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'), datetime('now'))
      `).bind(i,a,o.codiceContratto,o.servizio,o.piano,o.importoBase,o.iva,o.totale,"pending",`/proformas/${a}.pdf`,o.linkPagamentoStripe||null).run(),console.log(`‚úÖ [PROFORMA] Proforma generata: ${a} (${o.piano})`),{success:!0,proforma:{proformaId:i,numeroProforma:a,pdfBase64:l,pdfUrl:`/proformas/${a}.pdf`,createdAt:new Date().toISOString()}}}catch(a){return console.error("‚ùå [PROFORMA] Errore generazione:",a),{success:!1,error:String(a)}}}static generateProformaNumber(){const o=new Date,e=o.getFullYear(),a=String(o.getMonth()+1).padStart(2,"0"),i=Math.random().toString(36).substring(2,8).toUpperCase();return`PF-${e}${a}-${i}`}static calculateScadenza(o){const e=new Date;return e.setDate(e.getDate()+o),e.toLocaleDateString("it-IT")}static async generateProformaHTML(o){o.piano;const e=this.getProformaTemplate(o.piano),a={NUMERO_PROFORMA:o.numeroProforma,DATA_PROFORMA:o.dataEmissione,DATA_GENERAZIONE:new Date().toLocaleDateString("it-IT"),DATA_SCADENZA:o.dataScadenza,NOME_COGNOME_CLIENTE:`${o.nomeCliente} ${o.cognomeCliente}`,CODICE_CLIENTE:o.codiceContratto.substring(0,12),INDIRIZZO_CLIENTE:o.indirizzoCliente||"DA COMPLETARE",CITTA_CAP_CLIENTE:"",CODICE_FISCALE_CLIENTE:o.codiceFiscaleCliente||"DA COMPLETARE",EMAIL_CLIENTE:o.emailCliente,TELEFONO_CLIENTE:o.telefonoCliente||"Non specificato",DESCRIZIONE_SERVIZIO:o.descrizioneServizio,DISPOSITIVO:o.dispositivo,SERVIZIO_COMPLETO:io(o.servizio,o.piano),IMPORTO_BASE:o.importoBase.toFixed(2).replace(".",","),IVA:o.iva.toFixed(2).replace(".",","),TOTALE:o.totale.toFixed(2).replace(".",","),LINK_PAGAMENTO:o.linkPagamentoStripe||"mailto:info@medicagb.it",IBAN_AZIENDALE:"IT00 X000 0000 0000 0000 0000 000",CODICE_CONTRATTO:o.codiceContratto,ANNO:new Date().getFullYear().toString()};return wr.render(e,a)}static getProformaTemplate(o){return`<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proforma {{NUMERO_PROFORMA}} - eCura</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      text-align: center;
      border-bottom: 3px solid #3b82f6;
      padding-bottom: 20px;
      margin-bottom: 30px;
    }
    .logo {
      color: #3b82f6;
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .proforma-title {
      font-size: 24px;
      color: #3b82f6;
      margin: 20px 0;
      text-align: center;
    }
    .info-box {
      background: #f9fafb;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    .table th,
    .table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    .table th {
      background: #f3f4f6;
      font-weight: bold;
    }
    .total-box {
      background: linear-gradient(135deg, #f8faff 0%, #e8f2ff 100%);
      border: 2px solid #3b82f6;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      text-align: right;
    }
    .total-box .amount {
      font-size: 32px;
      font-weight: bold;
      color: #3b82f6;
    }
    .payment-button {
      display: inline-block;
      background: #22c55e;
      color: white;
      padding: 15px 40px;
      text-decoration: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      margin: 20px 0;
      text-align: center;
    }
    .payment-button:hover {
      background: #16a34a;
    }
    .footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 2px solid #e5e7eb;
      font-size: 12px;
      color: #666;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">üè• eCura - Medica GB S.r.l.</div>
    <div style="font-size: 14px; color: #666;">
      Startup Innovativa a Vocazione Sociale<br>
      P.IVA: 12435130963 | Reg. Imprese Milano<br>
      Corso Garibaldi 34, 20121 Milano
    </div>
  </div>

  <h1 class="proforma-title">üìÑ PROFORMA / FATTURA PROFORMA</h1>
  
  <div class="info-box">
    <table style="width: 100%;">
      <tr>
        <td><strong>Numero Proforma:</strong></td>
        <td>{{NUMERO_PROFORMA}}</td>
      </tr>
      <tr>
        <td><strong>Data Emissione:</strong></td>
        <td>{{DATA_EMISSIONE}}</td>
      </tr>
      <tr>
        <td><strong>Scadenza Pagamento:</strong></td>
        <td>{{DATA_SCADENZA}}</td>
      </tr>
      <tr>
        <td><strong>Contratto Collegato:</strong></td>
        <td>{{CODICE_CONTRATTO}}</td>
      </tr>
    </table>
  </div>

  <div class="info-box">
    <h3 style="margin-top: 0; color: #3b82f6;">üë§ CLIENTE</h3>
    <p>
      <strong>Nome e Cognome:</strong> {{NOME_CLIENTE}} {{COGNOME_CLIENTE}}<br>
      <strong>Email:</strong> {{EMAIL_CLIENTE}}<br>
      <strong>Telefono:</strong> {{TELEFONO_CLIENTE}}<br>
      <strong>Indirizzo:</strong> {{INDIRIZZO_CLIENTE}}<br>
      <strong>Codice Fiscale:</strong> {{CODICE_FISCALE}}
    </p>
  </div>

  <h3 style="color: #3b82f6;">üì¶ SERVIZI</h3>
  <table class="table">
    <thead>
      <tr>
        <th>Descrizione</th>
        <th>Quantit√†</th>
        <th style="text-align: right;">Importo</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>
          <strong>{{SERVIZIO_COMPLETO}}</strong><br>
          <small>{{DESCRIZIONE_SERVIZIO}}</small><br>
          <small>Dispositivo: {{DISPOSITIVO}}</small><br>
          <small>Durata: 12 mesi (primo anno)</small>
        </td>
        <td>1</td>
        <td style="text-align: right;">{{IMPORTO_BASE}}</td>
      </tr>
    </tbody>
  </table>

  <div class="total-box">
    <table style="width: 100%;">
      <tr>
        <td><strong>Imponibile:</strong></td>
        <td style="text-align: right;">{{IMPORTO_BASE}}</td>
      </tr>
      <tr>
        <td><strong>IVA 22%:</strong></td>
        <td style="text-align: right;">{{IVA}}</td>
      </tr>
      <tr style="border-top: 2px solid #3b82f6;">
        <td><strong style="font-size: 18px;">TOTALE DA PAGARE:</strong></td>
        <td style="text-align: right;">
          <div class="amount">{{TOTALE}}</div>
        </td>
      </tr>
    </table>
  </div>

  <div style="text-align: center; margin: 40px 0;">
    <h3 style="color: #3b82f6;">üí≥ PROCEDI AL PAGAMENTO</h3>
    <p>Paga in modo sicuro con carta di credito/debito o bonifico bancario</p>
    <a href="{{LINK_PAGAMENTO}}" class="payment-button">
      üí≥ PAGA ORA ‚Ç¨{{TOTALE}}
    </a>
    <p style="font-size: 14px; color: #666;">
      üîí Pagamento sicuro tramite Stripe<br>
      ‚è∞ Scadenza: {{SCADENZA_PAGAMENTO}}
    </p>
  </div>

  <div class="info-box">
    <h4 style="margin-top: 0; color: #3b82f6;">üìã MODALIT√Ä DI PAGAMENTO</h4>
    <p><strong>1. Pagamento Online (Consigliato):</strong><br>
    Clicca sul pulsante "PAGA ORA" e completa il pagamento con carta di credito/debito in modo sicuro tramite Stripe.</p>
    
    <p><strong>2. Bonifico Bancario:</strong><br>
    IBAN: <strong>IT00 X000 0000 0000 0000 0000 000</strong><br>
    Intestato a: <strong>Medica GB S.r.l.</strong><br>
    Causale: <strong>Proforma {{NUMERO_PROFORMA}}</strong></p>
    
    <p style="font-size: 12px; color: #666;">
    ‚ö†Ô∏è In caso di bonifico, inviare ricevuta a info@telemedcare.it per conferma pagamento
    </p>
  </div>

  <div class="info-box" style="background: #fef3c7; border-left: 4px solid #f59e0b;">
    <h4 style="margin-top: 0; color: #92400e;">üí∞ DETRAZIONE FISCALE 19%</h4>
    <p>Il servizio eCura √® detraibile come spesa sanitaria nella dichiarazione dei redditi (730/Unico).</p>
    <p><strong>Risparmio fiscale stimato:</strong> Fino a {{IVA}} di detrazione annuale</p>
    <p style="font-size: 12px;">Riceverai tutta la documentazione necessaria per il 730</p>
  </div>

  <div class="footer">
    <p><strong style="color: #3b82f6; font-size: 14px;">Contatti Medica GB S.r.l. - eCura</strong></p>
    <p>
      üìß Email: <a href="mailto:info@telemedcare.it">info@telemedcare.it</a> | 
      üìû Telefono: 02 8715 6826 | 
      üì± Assistenza: 335 730 1206
    </p>
    <p>
      üè¢ Milano: Corso Garibaldi 34, 20121 | 
      üè¢ Genova: Via delle Eriche 53, 16148
    </p>
    <p>
      üåê Web: <a href="https://www.ecura.it">www.ecura.it</a>
    </p>
    <p style="margin-top: 15px; font-size: 11px; font-style: italic;">
      Medica GB S.r.l. - P.IVA 12435130963 | Reg. Imprese Milano | Cap. Soc. ‚Ç¨10.000 i.v.<br>
      Questa √® una proforma. Dopo il pagamento riceverai la fattura definitiva.
    </p>
  </div>
</body>
</html>`}}async function nw(t,o,e,a,i,r,s){const l=Nc(i,r);if(!l)throw new Error(`Pricing non trovato per ${i} ${r}`);return{numeroProforma:"",dataEmissione:new Date().toLocaleDateString("it-IT"),dataScadenza:new Date(Date.now()+10080*60*1e3).toLocaleDateString("it-IT"),nomeCliente:o,cognomeCliente:e,emailCliente:a,servizio:i,piano:r,descrizioneServizio:`Servizio eCura ${io(i,r)} - Primo Anno`,dispositivo:l.dispositivo,importoBase:l.setupBase,iva:l.setupIva,totale:l.setupTotale,codiceContratto:t,linkPagamentoStripe:s,scadenzaPagamento:new Date(Date.now()+10080*60*1e3).toLocaleDateString("it-IT")}}const tg=Object.freeze(Object.defineProperty({__proto__:null,ProformaGenerator:eg,createProformaFromContract:nw,default:eg},Symbol.toStringTag,{value:"Module"}));class A0{constructor(o){O(this,"config");O(this,"baseUrl","https://api.stripe.com/v1");this.config=o}async createPaymentLink(o){try{console.log(`üí≥ [STRIPE] Creazione Payment Link per ‚Ç¨${(o.amount/100).toFixed(2)}`);const e=`plink_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,a=`https://buy.stripe.com/test_${e}`,i={id:e,url:a,active:!0};return console.log(`‚úÖ [STRIPE] Payment Link creato: ${i.url}`),i}catch(e){throw console.error("‚ùå [STRIPE] Errore creazione Payment Link:",e),new Error(`Stripe Payment Link creation failed: ${e}`)}}async createPaymentIntent(o,e="eur",a){try{console.log(`üí≥ [STRIPE] Creazione Payment Intent per ‚Ç¨${(o/100).toFixed(2)}`);const i=`pi_${Date.now()}_${Math.random().toString(36).substring(2,9)}`;return{id:i,amount:o,currency:e,status:"requires_payment_method",clientSecret:`${i}_secret_${Math.random().toString(36).substring(2,9)}`}}catch(i){throw console.error("‚ùå [STRIPE] Errore creazione Payment Intent:",i),i}}async retrievePaymentIntent(o){try{return console.log(`üîç [STRIPE] Recupero Payment Intent: ${o}`),{id:o,amount:102480,currency:"eur",status:"succeeded"}}catch(e){throw console.error("‚ùå [STRIPE] Errore recupero Payment Intent:",e),e}}static validateWebhookSignature(o,e,a){return console.log("‚ö†Ô∏è [STRIPE] Validazione webhook signature TODO"),!0}}function lw(t){const o={secretKey:t.STRIPE_SECRET_KEY||"sk_test_DEMO",publicKey:t.STRIPE_PUBLIC_KEY||"pk_test_DEMO",webhookSecret:t.STRIPE_WEBHOOK_SECRET||"whsec_DEMO",apiVersion:"2023-10-16"};return new A0(o)}function x0(t){return Math.round(t*100)}async function cw(t,o,e,a,i,r,s,l){const d=`Proforma ${o} - eCura ${a} ${i}`;return await t.createPaymentLink({amount:x0(r),currency:"eur",description:d,metadata:{proforma_number:o,contract_code:e,servizio:a,piano:i,cliente_nome:s,cliente_email:l},successUrl:`https://www.ecura.it/pagamento-confermato?proforma=${o}`,cancelUrl:`https://www.ecura.it/pagamento-annullato?proforma=${o}`})}const dw=Object.freeze(Object.defineProperty({__proto__:null,StripeService:A0,createProformaPaymentLink:cw,createStripeService:lw,euroToCents:x0},Symbol.toStringTag,{value:"Module"}));export{qm as default};
