var E0=Object.defineProperty;var Yd=o=>{throw TypeError(o)};var b0=(o,t,e)=>t in o?E0(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var _=(o,t,e)=>b0(o,typeof t!="symbol"?t+"":t,e),Xd=(o,t,e)=>t.has(o)||Yd("Cannot "+e),mt=(o,t)=>Object(t)!==t?Yd('Cannot use the "in" operator on this value'):o.has(t),n=(o,t,e)=>(Xd(o,t,"read from private field"),e?e.call(o):t.get(o)),h=(o,t,e)=>t.has(o)?Yd("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(o):t.set(o,e),f=(o,t,e,a)=>(Xd(o,t,"write to private field"),a?a.call(o,e):t.set(o,e),e),w=(o,t,e)=>(Xd(o,t,"access private method"),e);var qi=(o,t,e,a)=>({set _(i){f(o,t,i,e)},get _(){return n(o,t,a)}});import"crypto";import*as Ac from"fs";import*as lm from"path";import{join as y0}from"path";import{Buffer as pg}from"node:buffer";import{spawn as w0}from"child_process";var cm=(o,t,e)=>(a,i)=>{let s=-1;return r(0);async function r(l){if(l<=s)throw new Error("next() called multiple times");s=l;let c,d=!1,u;if(o[l]?(u=o[l][0][0],a.req.routeIndex=l):u=l===o.length&&i||void 0,u)try{c=await u(a,()=>r(l+1))}catch(p){if(p instanceof Error&&t)a.error=p,c=await t(p,a),d=!0;else throw p}else a.finalized===!1&&e&&(c=await e(a));return c&&(a.finalized===!1||d)&&(a.res=c),a}},T0=Symbol(),x0=async(o,t=Object.create(null))=>{const{all:e=!1,dot:a=!1}=t,s=(o instanceof Eg?o.raw.headers:o.headers).get("Content-Type");return s!=null&&s.startsWith("multipart/form-data")||s!=null&&s.startsWith("application/x-www-form-urlencoded")?I0(o,{all:e,dot:a}):{}};async function I0(o,t){const e=await o.formData();return e?S0(e,t):{}}function S0(o,t){const e=Object.create(null);return o.forEach((a,i)=>{t.all||i.endsWith("[]")?A0(e,i,a):e[i]=a}),t.dot&&Object.entries(e).forEach(([a,i])=>{a.includes(".")&&(C0(e,a,i),delete e[a])}),e}var A0=(o,t,e)=>{o[t]!==void 0?Array.isArray(o[t])?o[t].push(e):o[t]=[o[t],e]:t.endsWith("[]")?o[t]=[e]:o[t]=e},C0=(o,t,e)=>{let a=o;const i=t.split(".");i.forEach((s,r)=>{r===i.length-1?a[s]=e:((!a[s]||typeof a[s]!="object"||Array.isArray(a[s])||a[s]instanceof File)&&(a[s]=Object.create(null)),a=a[s])})},mg=o=>{const t=o.split("/");return t[0]===""&&t.shift(),t},R0=o=>{const{groups:t,path:e}=_0(o),a=mg(e);return O0(a,t)},_0=o=>{const t=[];return o=o.replace(/\{[^}]+\}/g,(e,a)=>{const i=`@${a}`;return t.push([i,e]),i}),{groups:t,path:o}},O0=(o,t)=>{for(let e=t.length-1;e>=0;e--){const[a]=t[e];for(let i=o.length-1;i>=0;i--)if(o[i].includes(a)){o[i]=o[i].replace(a,t[e][1]);break}}return o},Cc={},D0=(o,t)=>{if(o==="*")return"*";const e=o.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(e){const a=`${o}#${t}`;return Cc[a]||(e[2]?Cc[a]=t&&t[0]!==":"&&t[0]!=="*"?[a,e[1],new RegExp(`^${e[2]}(?=/${t})`)]:[o,e[1],new RegExp(`^${e[2]}$`)]:Cc[a]=[o,e[1],!0]),Cc[a]}return null},Tp=(o,t)=>{try{return t(o)}catch{return o.replace(/(?:%[0-9A-Fa-f]{2})+/g,e=>{try{return t(e)}catch{return e}})}},M0=o=>Tp(o,decodeURI),gg=o=>{const t=o.url,e=t.indexOf("/",t.indexOf(":")+4);let a=e;for(;a<t.length;a++){const i=t.charCodeAt(a);if(i===37){const s=t.indexOf("?",a),r=t.slice(e,s===-1?void 0:s);return M0(r.includes("%25")?r.replace(/%25/g,"%2525"):r)}else if(i===63)break}return t.slice(e,a)},z0=o=>{const t=gg(o);return t.length>1&&t.at(-1)==="/"?t.slice(0,-1):t},Xi=(o,t,...e)=>(e.length&&(t=Xi(t,...e)),`${(o==null?void 0:o[0])==="/"?"":"/"}${o}${t==="/"?"":`${(o==null?void 0:o.at(-1))==="/"?"":"/"}${(t==null?void 0:t[0])==="/"?t.slice(1):t}`}`),hg=o=>{if(o.charCodeAt(o.length-1)!==63||!o.includes(":"))return null;const t=o.split("/"),e=[];let a="";return t.forEach(i=>{if(i!==""&&!/\:/.test(i))a+="/"+i;else if(/\:/.test(i))if(/\?/.test(i)){e.length===0&&a===""?e.push("/"):e.push(a);const s=i.replace("?","");a+="/"+s,e.push(a)}else a+="/"+i}),e.filter((i,s,r)=>r.indexOf(i)===s)},Jd=o=>/[%+]/.test(o)?(o.indexOf("+")!==-1&&(o=o.replace(/\+/g," ")),o.indexOf("%")!==-1?Tp(o,vg):o):o,fg=(o,t,e)=>{let a;if(!e&&t&&!/[%+]/.test(t)){let r=o.indexOf(`?${t}`,8);for(r===-1&&(r=o.indexOf(`&${t}`,8));r!==-1;){const l=o.charCodeAt(r+t.length+1);if(l===61){const c=r+t.length+2,d=o.indexOf("&",c);return Jd(o.slice(c,d===-1?void 0:d))}else if(l==38||isNaN(l))return"";r=o.indexOf(`&${t}`,r+1)}if(a=/[%+]/.test(o),!a)return}const i={};a??(a=/[%+]/.test(o));let s=o.indexOf("?",8);for(;s!==-1;){const r=o.indexOf("&",s+1);let l=o.indexOf("=",s);l>r&&r!==-1&&(l=-1);let c=o.slice(s+1,l===-1?r===-1?void 0:r:l);if(a&&(c=Jd(c)),s=r,c==="")continue;let d;l===-1?d="":(d=o.slice(l+1,r===-1?void 0:r),a&&(d=Jd(d))),e?(i[c]&&Array.isArray(i[c])||(i[c]=[]),i[c].push(d)):i[c]??(i[c]=d)}return t?i[t]:i},L0=fg,N0=(o,t)=>fg(o,t,!0),vg=decodeURIComponent,dm=o=>Tp(o,vg),cs,gt,Io,bg,yg,fu,No,Jm,Eg=(Jm=class{constructor(o,t="/",e=[[]]){h(this,Io);_(this,"raw");h(this,cs);h(this,gt);_(this,"routeIndex",0);_(this,"path");_(this,"bodyCache",{});h(this,No,o=>{const{bodyCache:t,raw:e}=this,a=t[o];if(a)return a;const i=Object.keys(t)[0];return i?t[i].then(s=>(i==="json"&&(s=JSON.stringify(s)),new Response(s)[o]())):t[o]=e[o]()});this.raw=o,this.path=t,f(this,gt,e),f(this,cs,{})}param(o){return o?w(this,Io,bg).call(this,o):w(this,Io,yg).call(this)}query(o){return L0(this.url,o)}queries(o){return N0(this.url,o)}header(o){if(o)return this.raw.headers.get(o)??void 0;const t={};return this.raw.headers.forEach((e,a)=>{t[a]=e}),t}async parseBody(o){var t;return(t=this.bodyCache).parsedBody??(t.parsedBody=await x0(this,o))}json(){return n(this,No).call(this,"text").then(o=>JSON.parse(o))}text(){return n(this,No).call(this,"text")}arrayBuffer(){return n(this,No).call(this,"arrayBuffer")}blob(){return n(this,No).call(this,"blob")}formData(){return n(this,No).call(this,"formData")}addValidatedData(o,t){n(this,cs)[o]=t}valid(o){return n(this,cs)[o]}get url(){return this.raw.url}get method(){return this.raw.method}get[T0](){return n(this,gt)}get matchedRoutes(){return n(this,gt)[0].map(([[,o]])=>o)}get routePath(){return n(this,gt)[0].map(([[,o]])=>o)[this.routeIndex].path}},cs=new WeakMap,gt=new WeakMap,Io=new WeakSet,bg=function(o){const t=n(this,gt)[0][this.routeIndex][1][o],e=w(this,Io,fu).call(this,t);return e&&/\%/.test(e)?dm(e):e},yg=function(){const o={},t=Object.keys(n(this,gt)[0][this.routeIndex][1]);for(const e of t){const a=w(this,Io,fu).call(this,n(this,gt)[0][this.routeIndex][1][e]);a!==void 0&&(o[e]=/\%/.test(a)?dm(a):a)}return o},fu=function(o){return n(this,gt)[1]?n(this,gt)[1][o]:o},No=new WeakMap,Jm),P0={Stringify:1},wg=async(o,t,e,a,i)=>{typeof o=="object"&&!(o instanceof String)&&(o instanceof Promise||(o=o.toString()),o instanceof Promise&&(o=await o));const s=o.callbacks;return s!=null&&s.length?(i?i[0]+=o:i=[o],Promise.all(s.map(l=>l({phase:t,buffer:i,context:a}))).then(l=>Promise.all(l.filter(Boolean).map(c=>wg(c,t,!1,a,i))).then(()=>i[0]))):Promise.resolve(o)},k0="text/plain; charset=UTF-8",Qd=(o,t)=>({"Content-Type":o,...t}),un,pn,Qt,ds,eo,qe,mn,us,ps,za,gn,hn,Po,Ji,Qm,B0=(Qm=class{constructor(o,t){h(this,Po);h(this,un);h(this,pn);_(this,"env",{});h(this,Qt);_(this,"finalized",!1);_(this,"error");h(this,ds);h(this,eo);h(this,qe);h(this,mn);h(this,us);h(this,ps);h(this,za);h(this,gn);h(this,hn);_(this,"render",(...o)=>(n(this,us)??f(this,us,t=>this.html(t)),n(this,us).call(this,...o)));_(this,"setLayout",o=>f(this,mn,o));_(this,"getLayout",()=>n(this,mn));_(this,"setRenderer",o=>{f(this,us,o)});_(this,"header",(o,t,e)=>{this.finalized&&f(this,qe,new Response(n(this,qe).body,n(this,qe)));const a=n(this,qe)?n(this,qe).headers:n(this,za)??f(this,za,new Headers);t===void 0?a.delete(o):e!=null&&e.append?a.append(o,t):a.set(o,t)});_(this,"status",o=>{f(this,ds,o)});_(this,"set",(o,t)=>{n(this,Qt)??f(this,Qt,new Map),n(this,Qt).set(o,t)});_(this,"get",o=>n(this,Qt)?n(this,Qt).get(o):void 0);_(this,"newResponse",(...o)=>w(this,Po,Ji).call(this,...o));_(this,"body",(o,t,e)=>w(this,Po,Ji).call(this,o,t,e));_(this,"text",(o,t,e)=>!n(this,za)&&!n(this,ds)&&!t&&!e&&!this.finalized?new Response(o):w(this,Po,Ji).call(this,o,t,Qd(k0,e)));_(this,"json",(o,t,e)=>w(this,Po,Ji).call(this,JSON.stringify(o),t,Qd("application/json",e)));_(this,"html",(o,t,e)=>{const a=i=>w(this,Po,Ji).call(this,i,t,Qd("text/html; charset=UTF-8",e));return typeof o=="object"?wg(o,P0.Stringify,!1,{}).then(a):a(o)});_(this,"redirect",(o,t)=>{const e=String(o);return this.header("Location",/[^\x00-\xFF]/.test(e)?encodeURI(e):e),this.newResponse(null,t??302)});_(this,"notFound",()=>(n(this,ps)??f(this,ps,()=>new Response),n(this,ps).call(this,this)));f(this,un,o),t&&(f(this,eo,t.executionCtx),this.env=t.env,f(this,ps,t.notFoundHandler),f(this,hn,t.path),f(this,gn,t.matchResult))}get req(){return n(this,pn)??f(this,pn,new Eg(n(this,un),n(this,hn),n(this,gn))),n(this,pn)}get event(){if(n(this,eo)&&"respondWith"in n(this,eo))return n(this,eo);throw Error("This context has no FetchEvent")}get executionCtx(){if(n(this,eo))return n(this,eo);throw Error("This context has no ExecutionContext")}get res(){return n(this,qe)||f(this,qe,new Response(null,{headers:n(this,za)??f(this,za,new Headers)}))}set res(o){if(n(this,qe)&&o){o=new Response(o.body,o);for(const[t,e]of n(this,qe).headers.entries())if(t!=="content-type")if(t==="set-cookie"){const a=n(this,qe).headers.getSetCookie();o.headers.delete("set-cookie");for(const i of a)o.headers.append("set-cookie",i)}else o.headers.set(t,e)}f(this,qe,o),this.finalized=!0}get var(){return n(this,Qt)?Object.fromEntries(n(this,Qt)):{}}},un=new WeakMap,pn=new WeakMap,Qt=new WeakMap,ds=new WeakMap,eo=new WeakMap,qe=new WeakMap,mn=new WeakMap,us=new WeakMap,ps=new WeakMap,za=new WeakMap,gn=new WeakMap,hn=new WeakMap,Po=new WeakSet,Ji=function(o,t,e){const a=n(this,qe)?new Headers(n(this,qe).headers):n(this,za)??new Headers;if(typeof t=="object"&&"headers"in t){const s=t.headers instanceof Headers?t.headers:new Headers(t.headers);for(const[r,l]of s)r.toLowerCase()==="set-cookie"?a.append(r,l):a.set(r,l)}if(e)for(const[s,r]of Object.entries(e))if(typeof r=="string")a.set(s,r);else{a.delete(s);for(const l of r)a.append(s,l)}const i=typeof t=="number"?t:(t==null?void 0:t.status)??n(this,ds);return new Response(o,{status:i,headers:a})},Qm),Se="ALL",F0="all",$0=["get","post","put","delete","options","patch"],Tg="Can not add a route since the matcher is already built.",xg=class extends Error{},U0="__COMPOSED_HANDLER",j0=o=>o.text("404 Not Found",404),um=(o,t)=>{if("getResponse"in o){const e=o.getResponse();return t.newResponse(e.body,e)}return console.error(o),t.text("Internal Server Error",500)},Et,Ce,Sg,bt,Ca,Nc,Pc,eg,Ig=(eg=class{constructor(t={}){h(this,Ce);_(this,"get");_(this,"post");_(this,"put");_(this,"delete");_(this,"options");_(this,"patch");_(this,"all");_(this,"on");_(this,"use");_(this,"router");_(this,"getPath");_(this,"_basePath","/");h(this,Et,"/");_(this,"routes",[]);h(this,bt,j0);_(this,"errorHandler",um);_(this,"onError",t=>(this.errorHandler=t,this));_(this,"notFound",t=>(f(this,bt,t),this));_(this,"fetch",(t,...e)=>w(this,Ce,Pc).call(this,t,e[1],e[0],t.method));_(this,"request",(t,e,a,i)=>t instanceof Request?this.fetch(e?new Request(t,e):t,a,i):(t=t.toString(),this.fetch(new Request(/^https?:\/\//.test(t)?t:`http://localhost${Xi("/",t)}`,e),a,i)));_(this,"fire",()=>{addEventListener("fetch",t=>{t.respondWith(w(this,Ce,Pc).call(this,t.request,t,void 0,t.request.method))})});[...$0,F0].forEach(s=>{this[s]=(r,...l)=>(typeof r=="string"?f(this,Et,r):w(this,Ce,Ca).call(this,s,n(this,Et),r),l.forEach(c=>{w(this,Ce,Ca).call(this,s,n(this,Et),c)}),this)}),this.on=(s,r,...l)=>{for(const c of[r].flat()){f(this,Et,c);for(const d of[s].flat())l.map(u=>{w(this,Ce,Ca).call(this,d.toUpperCase(),n(this,Et),u)})}return this},this.use=(s,...r)=>(typeof s=="string"?f(this,Et,s):(f(this,Et,"*"),r.unshift(s)),r.forEach(l=>{w(this,Ce,Ca).call(this,Se,n(this,Et),l)}),this);const{strict:a,...i}=t;Object.assign(this,i),this.getPath=a??!0?t.getPath??gg:z0}route(t,e){const a=this.basePath(t);return e.routes.map(i=>{var r;let s;e.errorHandler===um?s=i.handler:(s=async(l,c)=>(await cm([],e.errorHandler)(l,()=>i.handler(l,c))).res,s[U0]=i.handler),w(r=a,Ce,Ca).call(r,i.method,i.path,s)}),this}basePath(t){const e=w(this,Ce,Sg).call(this);return e._basePath=Xi(this._basePath,t),e}mount(t,e,a){let i,s;a&&(typeof a=="function"?s=a:(s=a.optionHandler,a.replaceRequest===!1?i=c=>c:i=a.replaceRequest));const r=s?c=>{const d=s(c);return Array.isArray(d)?d:[d]}:c=>{let d;try{d=c.executionCtx}catch{}return[c.env,d]};i||(i=(()=>{const c=Xi(this._basePath,t),d=c==="/"?0:c.length;return u=>{const p=new URL(u.url);return p.pathname=p.pathname.slice(d)||"/",new Request(p,u)}})());const l=async(c,d)=>{const u=await e(i(c.req.raw),...r(c));if(u)return u;await d()};return w(this,Ce,Ca).call(this,Se,Xi(t,"*"),l),this}},Et=new WeakMap,Ce=new WeakSet,Sg=function(){const t=new Ig({router:this.router,getPath:this.getPath});return t.errorHandler=this.errorHandler,f(t,bt,n(this,bt)),t.routes=this.routes,t},bt=new WeakMap,Ca=function(t,e,a){t=t.toUpperCase(),e=Xi(this._basePath,e);const i={basePath:this._basePath,path:e,method:t,handler:a};this.router.add(t,e,[a,i]),this.routes.push(i)},Nc=function(t,e){if(t instanceof Error)return this.errorHandler(t,e);throw t},Pc=function(t,e,a,i){if(i==="HEAD")return(async()=>new Response(null,await w(this,Ce,Pc).call(this,t,e,a,"GET")))();const s=this.getPath(t,{env:a}),r=this.router.match(i,s),l=new B0(t,{path:s,matchResult:r,env:a,executionCtx:e,notFoundHandler:n(this,bt)});if(r[0].length===1){let d;try{d=r[0][0][0][0](l,async()=>{l.res=await n(this,bt).call(this,l)})}catch(u){return w(this,Ce,Nc).call(this,u,l)}return d instanceof Promise?d.then(u=>u||(l.finalized?l.res:n(this,bt).call(this,l))).catch(u=>w(this,Ce,Nc).call(this,u,l)):d??n(this,bt).call(this,l)}const c=cm(r[0],this.errorHandler,n(this,bt));return(async()=>{try{const d=await c(l);if(!d.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return d.res}catch(d){return w(this,Ce,Nc).call(this,d,l)}})()},eg),id="[^/]+",Xr=".*",Jr="(?:|/.*)",Qi=Symbol(),H0=new Set(".\\+*[^]$()");function V0(o,t){return o.length===1?t.length===1?o<t?-1:1:-1:t.length===1||o===Xr||o===Jr?1:t===Xr||t===Jr?-1:o===id?1:t===id?-1:o.length===t.length?o<t?-1:1:t.length-o.length}var La,Na,yt,tg,vu=(tg=class{constructor(){h(this,La);h(this,Na);h(this,yt,Object.create(null))}insert(t,e,a,i,s){if(t.length===0){if(n(this,La)!==void 0)throw Qi;if(s)return;f(this,La,e);return}const[r,...l]=t,c=r==="*"?l.length===0?["","",Xr]:["","",id]:r==="/*"?["","",Jr]:r.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);let d;if(c){const u=c[1];let p=c[2]||id;if(u&&c[2]&&(p===".*"||(p=p.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(p))))throw Qi;if(d=n(this,yt)[p],!d){if(Object.keys(n(this,yt)).some(g=>g!==Xr&&g!==Jr))throw Qi;if(s)return;d=n(this,yt)[p]=new vu,u!==""&&f(d,Na,i.varIndex++)}!s&&u!==""&&a.push([u,n(d,Na)])}else if(d=n(this,yt)[r],!d){if(Object.keys(n(this,yt)).some(u=>u.length>1&&u!==Xr&&u!==Jr))throw Qi;if(s)return;d=n(this,yt)[r]=new vu}d.insert(l,e,a,i,s)}buildRegExpStr(){const e=Object.keys(n(this,yt)).sort(V0).map(a=>{const i=n(this,yt)[a];return(typeof n(i,Na)=="number"?`(${a})@${n(i,Na)}`:H0.has(a)?`\\${a}`:a)+i.buildRegExpStr()});return typeof n(this,La)=="number"&&e.unshift(`#${n(this,La)}`),e.length===0?"":e.length===1?e[0]:"(?:"+e.join("|")+")"}},La=new WeakMap,Na=new WeakMap,yt=new WeakMap,tg),bd,fn,og,W0=(og=class{constructor(){h(this,bd,{varIndex:0});h(this,fn,new vu)}insert(o,t,e){const a=[],i=[];for(let r=0;;){let l=!1;if(o=o.replace(/\{[^}]+\}/g,c=>{const d=`@\\${r}`;return i[r]=[d,c],r++,l=!0,d}),!l)break}const s=o.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let r=i.length-1;r>=0;r--){const[l]=i[r];for(let c=s.length-1;c>=0;c--)if(s[c].indexOf(l)!==-1){s[c]=s[c].replace(l,i[r][1]);break}}return n(this,fn).insert(s,t,a,n(this,bd),e),a}buildRegExp(){let o=n(this,fn).buildRegExpStr();if(o==="")return[/^$/,[],[]];let t=0;const e=[],a=[];return o=o.replace(/#(\d+)|@(\d+)|\.\*\$/g,(i,s,r)=>s!==void 0?(e[++t]=Number(s),"$()"):(r!==void 0&&(a[Number(r)]=++t),"")),[new RegExp(`^${o}`),e,a]}},bd=new WeakMap,fn=new WeakMap,og),Ag=[],G0=[/^$/,[],Object.create(null)],kc=Object.create(null);function Cg(o){return kc[o]??(kc[o]=new RegExp(o==="*"?"":`^${o.replace(/\/\*$|([.\\+*[^\]$()])/g,(t,e)=>e?`\\${e}`:"(?:|/.*)")}$`))}function K0(){kc=Object.create(null)}function q0(o){var d;const t=new W0,e=[];if(o.length===0)return G0;const a=o.map(u=>[!/\*|\/:/.test(u[0]),...u]).sort(([u,p],[g,m])=>u?1:g?-1:p.length-m.length),i=Object.create(null);for(let u=0,p=-1,g=a.length;u<g;u++){const[m,v,b]=a[u];m?i[v]=[b.map(([T])=>[T,Object.create(null)]),Ag]:p++;let E;try{E=t.insert(v,p,m)}catch(T){throw T===Qi?new xg(v):T}m||(e[p]=b.map(([T,R])=>{const S=Object.create(null);for(R-=1;R>=0;R--){const[C,M]=E[R];S[C]=M}return[T,S]}))}const[s,r,l]=t.buildRegExp();for(let u=0,p=e.length;u<p;u++)for(let g=0,m=e[u].length;g<m;g++){const v=(d=e[u][g])==null?void 0:d[1];if(!v)continue;const b=Object.keys(v);for(let E=0,T=b.length;E<T;E++)v[b[E]]=l[v[b[E]]]}const c=[];for(const u in r)c[u]=e[r[u]];return[s,c,i]}function Zi(o,t){if(o){for(const e of Object.keys(o).sort((a,i)=>i.length-a.length))if(Cg(e).test(t))return[...o[e]]}}var ko,Bo,Lr,Rg,_g,ag,Z0=(ag=class{constructor(){h(this,Lr);_(this,"name","RegExpRouter");h(this,ko);h(this,Bo);f(this,ko,{[Se]:Object.create(null)}),f(this,Bo,{[Se]:Object.create(null)})}add(o,t,e){var l;const a=n(this,ko),i=n(this,Bo);if(!a||!i)throw new Error(Tg);a[o]||[a,i].forEach(c=>{c[o]=Object.create(null),Object.keys(c[Se]).forEach(d=>{c[o][d]=[...c[Se][d]]})}),t==="/*"&&(t="*");const s=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){const c=Cg(t);o===Se?Object.keys(a).forEach(d=>{var u;(u=a[d])[t]||(u[t]=Zi(a[d],t)||Zi(a[Se],t)||[])}):(l=a[o])[t]||(l[t]=Zi(a[o],t)||Zi(a[Se],t)||[]),Object.keys(a).forEach(d=>{(o===Se||o===d)&&Object.keys(a[d]).forEach(u=>{c.test(u)&&a[d][u].push([e,s])})}),Object.keys(i).forEach(d=>{(o===Se||o===d)&&Object.keys(i[d]).forEach(u=>c.test(u)&&i[d][u].push([e,s]))});return}const r=hg(t)||[t];for(let c=0,d=r.length;c<d;c++){const u=r[c];Object.keys(i).forEach(p=>{var g;(o===Se||o===p)&&((g=i[p])[u]||(g[u]=[...Zi(a[p],u)||Zi(a[Se],u)||[]]),i[p][u].push([e,s-d+c+1]))})}}match(o,t){K0();const e=w(this,Lr,Rg).call(this);return this.match=(a,i)=>{const s=e[a]||e[Se],r=s[2][i];if(r)return r;const l=i.match(s[0]);if(!l)return[[],Ag];const c=l.indexOf("",1);return[s[1][c],l]},this.match(o,t)}},ko=new WeakMap,Bo=new WeakMap,Lr=new WeakSet,Rg=function(){const o=Object.create(null);return Object.keys(n(this,Bo)).concat(Object.keys(n(this,ko))).forEach(t=>{o[t]||(o[t]=w(this,Lr,_g).call(this,t))}),f(this,ko,f(this,Bo,void 0)),o},_g=function(o){const t=[];let e=o===Se;return[n(this,ko),n(this,Bo)].forEach(a=>{const i=a[o]?Object.keys(a[o]).map(s=>[s,a[o][s]]):[];i.length!==0?(e||(e=!0),t.push(...i)):o!==Se&&t.push(...Object.keys(a[Se]).map(s=>[s,a[Se][s]]))}),e?q0(t):null},ag),Fo,to,ig,Y0=(ig=class{constructor(o){_(this,"name","SmartRouter");h(this,Fo,[]);h(this,to,[]);f(this,Fo,o.routers)}add(o,t,e){if(!n(this,to))throw new Error(Tg);n(this,to).push([o,t,e])}match(o,t){if(!n(this,to))throw new Error("Fatal error");const e=n(this,Fo),a=n(this,to),i=e.length;let s=0,r;for(;s<i;s++){const l=e[s];try{for(let c=0,d=a.length;c<d;c++)l.add(...a[c]);r=l.match(o,t)}catch(c){if(c instanceof xg)continue;throw c}this.match=l.match.bind(l),f(this,Fo,[l]),f(this,to,void 0);break}if(s===i)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,r}get activeRouter(){if(n(this,to)||n(this,Fo).length!==1)throw new Error("No active router has been determined yet.");return n(this,Fo)[0]}},Fo=new WeakMap,to=new WeakMap,ig),$r=Object.create(null),$o,He,Pa,ms,ke,oo,Ra,sg,Og=(sg=class{constructor(t,e,a){h(this,oo);h(this,$o);h(this,He);h(this,Pa);h(this,ms,0);h(this,ke,$r);if(f(this,He,a||Object.create(null)),f(this,$o,[]),t&&e){const i=Object.create(null);i[t]={handler:e,possibleKeys:[],score:0},f(this,$o,[i])}f(this,Pa,[])}insert(t,e,a){f(this,ms,++qi(this,ms)._);let i=this;const s=R0(e),r=[];for(let l=0,c=s.length;l<c;l++){const d=s[l],u=s[l+1],p=D0(d,u),g=Array.isArray(p)?p[0]:d;if(g in n(i,He)){i=n(i,He)[g],p&&r.push(p[1]);continue}n(i,He)[g]=new Og,p&&(n(i,Pa).push(p),r.push(p[1])),i=n(i,He)[g]}return n(i,$o).push({[t]:{handler:a,possibleKeys:r.filter((l,c,d)=>d.indexOf(l)===c),score:n(this,ms)}}),i}search(t,e){var c;const a=[];f(this,ke,$r);let s=[this];const r=mg(e),l=[];for(let d=0,u=r.length;d<u;d++){const p=r[d],g=d===u-1,m=[];for(let v=0,b=s.length;v<b;v++){const E=s[v],T=n(E,He)[p];T&&(f(T,ke,n(E,ke)),g?(n(T,He)["*"]&&a.push(...w(this,oo,Ra).call(this,n(T,He)["*"],t,n(E,ke))),a.push(...w(this,oo,Ra).call(this,T,t,n(E,ke)))):m.push(T));for(let R=0,S=n(E,Pa).length;R<S;R++){const C=n(E,Pa)[R],M=n(E,ke)===$r?{}:{...n(E,ke)};if(C==="*"){const $=n(E,He)["*"];$&&(a.push(...w(this,oo,Ra).call(this,$,t,n(E,ke))),f($,ke,M),m.push($));continue}const[B,j,N]=C;if(!p&&!(N instanceof RegExp))continue;const D=n(E,He)[B],Y=r.slice(d).join("/");if(N instanceof RegExp){const $=N.exec(Y);if($){if(M[j]=$[0],a.push(...w(this,oo,Ra).call(this,D,t,n(E,ke),M)),Object.keys(n(D,He)).length){f(D,ke,M);const O=((c=$[0].match(/\//))==null?void 0:c.length)??0;(l[O]||(l[O]=[])).push(D)}continue}}(N===!0||N.test(p))&&(M[j]=p,g?(a.push(...w(this,oo,Ra).call(this,D,t,M,n(E,ke))),n(D,He)["*"]&&a.push(...w(this,oo,Ra).call(this,n(D,He)["*"],t,M,n(E,ke)))):(f(D,ke,M),m.push(D)))}}s=m.concat(l.shift()??[])}return a.length>1&&a.sort((d,u)=>d.score-u.score),[a.map(({handler:d,params:u})=>[d,u])]}},$o=new WeakMap,He=new WeakMap,Pa=new WeakMap,ms=new WeakMap,ke=new WeakMap,oo=new WeakSet,Ra=function(t,e,a,i){const s=[];for(let r=0,l=n(t,$o).length;r<l;r++){const c=n(t,$o)[r],d=c[e]||c[Se],u={};if(d!==void 0&&(d.params=Object.create(null),s.push(d),a!==$r||i&&i!==$r))for(let p=0,g=d.possibleKeys.length;p<g;p++){const m=d.possibleKeys[p],v=u[d.score];d.params[m]=i!=null&&i[m]&&!v?i[m]:a[m]??(i==null?void 0:i[m]),u[d.score]=!0}}return s},sg),ka,rg,X0=(rg=class{constructor(){_(this,"name","TrieRouter");h(this,ka);f(this,ka,new Og)}add(o,t,e){const a=hg(t);if(a){for(let i=0,s=a.length;i<s;i++)n(this,ka).insert(o,a[i],e);return}n(this,ka).insert(o,t,e)}match(o,t){return n(this,ka).search(o,t)}},ka=new WeakMap,rg),Dg=class extends Ig{constructor(o={}){super(o),this.router=o.router??new Y0({routers:[new Z0,new X0]})}},J0=o=>{const e={...{origin:"*",allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],allowHeaders:[],exposeHeaders:[]},...o},a=(s=>typeof s=="string"?s==="*"?()=>s:r=>s===r?r:null:typeof s=="function"?s:r=>s.includes(r)?r:null)(e.origin),i=(s=>typeof s=="function"?s:Array.isArray(s)?()=>s:()=>[])(e.allowMethods);return async function(r,l){var u;function c(p,g){r.res.headers.set(p,g)}const d=await a(r.req.header("origin")||"",r);if(d&&c("Access-Control-Allow-Origin",d),e.origin!=="*"){const p=r.req.header("Vary");p?c("Vary",p):c("Vary","Origin")}if(e.credentials&&c("Access-Control-Allow-Credentials","true"),(u=e.exposeHeaders)!=null&&u.length&&c("Access-Control-Expose-Headers",e.exposeHeaders.join(",")),r.req.method==="OPTIONS"){e.maxAge!=null&&c("Access-Control-Max-Age",e.maxAge.toString());const p=await i(r.req.header("origin")||"",r);p.length&&c("Access-Control-Allow-Methods",p.join(","));let g=e.allowHeaders;if(!(g!=null&&g.length)){const m=r.req.header("Access-Control-Request-Headers");m&&(g=m.split(/\s*,\s*/))}return g!=null&&g.length&&(c("Access-Control-Allow-Headers",g.join(",")),r.res.headers.append("Vary","Access-Control-Request-Headers")),r.res.headers.delete("Content-Length"),r.res.headers.delete("Content-Type"),new Response(null,{headers:r.res.headers,status:204,statusText:"No Content"})}await l()}},Q0=/^\s*(?:text\/(?!event-stream(?:[;\s]|$))[^;\s]+|application\/(?:javascript|json|xml|xml-dtd|ecmascript|dart|postscript|rtf|tar|toml|vnd\.dart|vnd\.ms-fontobject|vnd\.ms-opentype|wasm|x-httpd-php|x-javascript|x-ns-proxy-autoconfig|x-sh|x-tar|x-virtualbox-hdd|x-virtualbox-ova|x-virtualbox-ovf|x-virtualbox-vbox|x-virtualbox-vdi|x-virtualbox-vhd|x-virtualbox-vmdk|x-www-form-urlencoded)|font\/(?:otf|ttf)|image\/(?:bmp|vnd\.adobe\.photoshop|vnd\.microsoft\.icon|vnd\.ms-dds|x-icon|x-ms-bmp)|message\/rfc822|model\/gltf-binary|x-shader\/x-fragment|x-shader\/x-vertex|[^;\s]+?\+(?:json|text|xml|yaml))(?:[;\s]|$)/i,pm=(o,t=tv)=>{const e=/\.([a-zA-Z0-9]+?)$/,a=o.match(e);if(!a)return;let i=t[a[1]];return i&&i.startsWith("text")&&(i+="; charset=utf-8"),i},ev={aac:"audio/aac",avi:"video/x-msvideo",avif:"image/avif",av1:"video/av1",bin:"application/octet-stream",bmp:"image/bmp",css:"text/css",csv:"text/csv",eot:"application/vnd.ms-fontobject",epub:"application/epub+zip",gif:"image/gif",gz:"application/gzip",htm:"text/html",html:"text/html",ico:"image/x-icon",ics:"text/calendar",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json",jsonld:"application/ld+json",map:"application/json",mid:"audio/x-midi",midi:"audio/x-midi",mjs:"text/javascript",mp3:"audio/mpeg",mp4:"video/mp4",mpeg:"video/mpeg",oga:"audio/ogg",ogv:"video/ogg",ogx:"application/ogg",opus:"audio/opus",otf:"font/otf",pdf:"application/pdf",png:"image/png",rtf:"application/rtf",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",ts:"video/mp2t",ttf:"font/ttf",txt:"text/plain",wasm:"application/wasm",webm:"video/webm",weba:"audio/webm",webmanifest:"application/manifest+json",webp:"image/webp",woff:"font/woff",woff2:"font/woff2",xhtml:"application/xhtml+xml",xml:"application/xml",zip:"application/zip","3gp":"video/3gpp","3g2":"video/3gpp2",gltf:"model/gltf+json",glb:"model/gltf-binary"},tv=ev,ov=(...o)=>{let t=o.filter(i=>i!=="").join("/");t=t.replace(new RegExp("(?<=\\/)\\/+","g"),"");const e=t.split("/"),a=[];for(const i of e)i===".."&&a.length>0&&a.at(-1)!==".."?a.pop():i!=="."&&a.push(i);return a.join("/")||"."},Mg={br:".br",zstd:".zst",gzip:".gz"},av=Object.keys(Mg),iv="index.html",sv=o=>{const t=o.root??"./",e=o.path,a=o.join??ov;return async(i,s)=>{var u,p,g,m;if(i.finalized)return s();let r;if(o.path)r=o.path;else try{if(r=decodeURIComponent(i.req.path),/(?:^|[\/\\])\.\.(?:$|[\/\\])/.test(r))throw new Error}catch{return await((u=o.onNotFound)==null?void 0:u.call(o,i.req.path,i)),s()}let l=a(t,!e&&o.rewriteRequestPath?o.rewriteRequestPath(r):r);o.isDir&&await o.isDir(l)&&(l=a(l,iv));const c=o.getContent;let d=await c(l,i);if(d instanceof Response)return i.newResponse(d.body,d);if(d){const v=o.mimes&&pm(l,o.mimes)||pm(l);if(i.header("Content-Type",v||"application/octet-stream"),o.precompressed&&(!v||Q0.test(v))){const b=new Set((p=i.req.header("Accept-Encoding"))==null?void 0:p.split(",").map(E=>E.trim()));for(const E of av){if(!b.has(E))continue;const T=await c(l+Mg[E],i);if(T){d=T,i.header("Content-Encoding",E),i.header("Vary","Accept-Encoding",{append:!0});break}}}return await((g=o.onFound)==null?void 0:g.call(o,l,i)),i.body(d)}await((m=o.onNotFound)==null?void 0:m.call(o,l,i)),await s()}},rv=async(o,t)=>{let e;t&&t.manifest?typeof t.manifest=="string"?e=JSON.parse(t.manifest):e=t.manifest:typeof __STATIC_CONTENT_MANIFEST=="string"?e=JSON.parse(__STATIC_CONTENT_MANIFEST):e=__STATIC_CONTENT_MANIFEST;let a;t&&t.namespace?a=t.namespace:a=__STATIC_CONTENT;const i=e[o]||o;if(!i)return null;const s=await a.get(i,{type:"stream"});return s||null},nv=o=>async function(e,a){return sv({...o,getContent:async s=>rv(s,{manifest:o.manifest,namespace:o.namespace?o.namespace:e.env?e.env.__STATIC_CONTENT:void 0})})(e,a)},xp=o=>nv(o);const Bc={INVIO_CONTRATTO:{id:"invio_contratto",name:"Invio Contratto",subject:"üìã TeleMedCare - Il tuo contratto √® pronto!",htmlPath:"/templates/email/email_invio_contratto.html",variables:["NOME_CLIENTE","PIANO_SERVIZIO","PREZZO_PIANO","CODICE_CLIENTE"],category:"workflow"},INVIO_PROFORMA:{id:"invio_proforma",name:"Invio Proforma",subject:"üí∞ TeleMedCare - Fattura Proforma per {{PIANO_SERVIZIO}}",htmlPath:"/templates/email/email_invio_proforma.html",variables:["NOME_CLIENTE","PIANO_SERVIZIO","IMPORTO_TOTALE","SCADENZA_PAGAMENTO","CODICE_CLIENTE"],category:"workflow"},BENVENUTO:{id:"benvenuto",name:"Benvenuto Cliente",subject:"üéâ Benvenuto/a in TeleMedCare, {{NOME_CLIENTE}}!",htmlPath:"/templates/email/email_benvenuto.html",variables:["NOME_CLIENTE","PIANO_SERVIZIO","COSTO_SERVIZIO","DATA_ATTIVAZIONE","CODICE_CLIENTE","SERVIZI_INCLUSI"],category:"workflow"},CONFIGURAZIONE:{id:"configurazione",name:"Configurazione Dispositivo",subject:"‚öôÔ∏è TeleMedCare - Configurazione del tuo dispositivo",htmlPath:"/templates/email/email_conferma_attivazione.html",variables:["NOME_CLIENTE","DISPOSITIVO","SERIAL_NUMBER","ISTRUZIONI_CONFIG"],category:"workflow"},CONFERMA:{id:"conferma",name:"Conferma Attivazione",subject:"‚úÖ TeleMedCare - Servizio attivato con successo!",htmlPath:"/templates/email/email_conferma_attivazione.html",variables:["NOME_CLIENTE","PIANO_SERVIZIO","DATA_ATTIVAZIONE","CODICE_CLIENTE"],category:"workflow"},FOLLOWUP_CALL:{id:"followup_call",name:"Follow-up Call",subject:"üìû TeleMedCare - Chiamata di follow-up programmata",htmlPath:"/templates/email/email_followup_call.html",variables:["NOME_CLIENTE","DATA_CHIAMATA","ORA_CHIAMATA","MOTIVO_CHIAMATA"],category:"workflow"},NOTIFICA_INFO:{id:"notifica_info",name:"Notifica Nuovo Lead",subject:"üö® TeleMedCare - Nuovo Lead ricevuto: {{NOME_CLIENTE}}",htmlPath:"/templates/email/email_notifica_info.html",variables:["NOME_CLIENTE","EMAIL_CLIENTE","TELEFONO_CLIENTE","SERVIZIO_RICHIESTO","TIMESTAMP_LEAD","LEAD_ID"],category:"notification"},DOCUMENTI_INFORMATIVI:{id:"documenti_informativi",name:"Invio Documenti Informativi",subject:"üìã TeleMedCare - Documentazione richiesta per {{NOME_CLIENTE}}",htmlPath:"/templates/email/email_documenti_informativi.html",variables:["NOME_CLIENTE","EMAIL_CLIENTE","DOCUMENTI_RICHIESTI","SERVIZIO_INTERESSE","TIMESTAMP_RICHIESTA"],category:"workflow"}};class is{static render(t,e){let a=t;for(const[i,s]of Object.entries(e)){const r=new RegExp(`{{${i}}}`,"g");a=a.replace(r,String(s))}return a=a.replace(/{{[^}]+}}/g,""),a}static renderSubject(t,e){return this.render(t,e)}static htmlToText(t){return t.replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/\s+/g," ").trim()}}const Oa=class Oa{constructor(t){_(this,"env");this.env=t}static getInstance(){return Oa.instance||(Oa.instance=new Oa),Oa.instance}async sendEmail(t){var a;const e={to:t.to,from:t.from,subject:t.subject,html:t.html,text:t.text,attachments:(a=t.attachments)==null?void 0:a.map(i=>({filename:i.filename,content:i.content||"",contentType:i.contentType||"application/octet-stream"}))};return this.sendEmailInternal(e,this.env)}async sendTemplateEmail(t,e,a,i,s){try{const r=Bc[t.toUpperCase()];if(!r)throw new Error(`Template ${t} non trovato`);const l=await this.loadTemplate(r.htmlPath),c=is.render(l,a),d=is.renderSubject(r.subject,a),u=is.htmlToText(c),p={to:e,subject:d,html:c,text:u,attachments:i};return await this.sendEmailInternal(p,s)}catch(r){return console.error("‚ùå Errore invio email template:",r),{success:!1,error:r instanceof Error?r.message:"Errore sconosciuto",timestamp:new Date().toISOString()}}}async loadTemplate(t){try{return console.log(`üìß Uso template embedded per: ${t}`),this.getEmbeddedTemplate(t)}catch(e){throw console.error(`‚ùå Errore caricamento template ${t}:`,e),e}}getEmbeddedTemplate(t){var a;switch((a=t.split("/").pop())==null?void 0:a.replace(".html","")){case"email_invio_contratto":return`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>TeleMedCare - Contratto</title></head>
<body style="font-family:Arial,sans-serif;margin:0;padding:20px;background:#f4f6f8;">
<div style="max-width:600px;margin:0 auto;background:white;border-radius:6px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
<div style="background:#0b63a5;color:white;padding:20px;"><h1 style="margin:0;font-size:20px;">üìã TeleMedCare</h1></div>
<div style="padding:24px;">
<p>Gentile <strong>{{NOME_CLIENTE}}</strong>,</p>
<p>Siamo lieti di accompagnarLa in questo importante passo! In allegato trova il <strong>contratto per il servizio {{PIANO_SERVIZIO}}</strong>.</p>
<div style="background:#f8fbff;border:1px solid #e6f0fa;padding:16px;border-radius:6px;margin:16px 0;">
<h3 style="margin:0 0 8px;color:#0b63a5;">üìã Riepilogo Servizio</h3>
<strong>Piano:</strong> {{PIANO_SERVIZIO}}<br>
<strong>Investimento:</strong> {{PREZZO_PIANO}}<br>
<strong>Codice Cliente:</strong> {{CODICE_CLIENTE}}
</div>
<h3 style="color:#0b63a5;">üöÄ Prossimi Passi:</h3>
<ol style="margin-left:18px;">
<li>Legga attentamente il contratto allegato</li>
<li>Firmi in ogni pagina richiesta</li>
<li>Ci invii il contratto firmato via email</li>
<li>Ricever√† il dispositivo entro 10 giorni</li>
</ol>
<p style="margin-top:20px;"><strong>Grazie per la fiducia!</strong><br>Il Team TeleMedCare</p>
</div></div></body></html>`;case"email_invio_proforma":return`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>TeleMedCare - Proforma</title></head>
<body style="font-family:Arial,sans-serif;margin:0;padding:20px;background:#f4f6f8;">
<div style="max-width:600px;margin:0 auto;background:white;border-radius:6px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
<div style="background:#10b981;color:white;padding:20px;"><h1 style="margin:0;font-size:20px;">üí∞ TeleMedCare</h1></div>
<div style="padding:24px;">
<p>Gentile <strong>{{NOME_CLIENTE}}</strong>,</p>
<p>In allegato trova la <strong>fattura proforma</strong> per il servizio {{PIANO_SERVIZIO}}.</p>
<div style="background:#f0fdf4;border:1px solid #dcfce7;padding:16px;border-radius:6px;margin:16px 0;">
<h3 style="margin:0 0 8px;color:#10b981;">üí≥ Dettagli Pagamento</h3>
<strong>Piano:</strong> {{PIANO_SERVIZIO}}<br>
<strong>Importo Totale:</strong> {{IMPORTO_TOTALE}}<br>
<strong>Scadenza Pagamento:</strong> {{SCADENZA_PAGAMENTO}}<br>
<strong>Codice Cliente:</strong> {{CODICE_CLIENTE}}
</div>
<p>Pu√≤ procedere con il pagamento tramite bonifico bancario utilizzando i dati allegati.</p>
<p style="margin-top:20px;"><strong>Grazie!</strong><br>Il Team TeleMedCare</p>
</div></div></body></html>`;case"email_benvenuto":return`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Benvenuto in TeleMedCare</title></head>
<body style="font-family:Arial,sans-serif;margin:0;padding:20px;background:#f4f6f8;">
<div style="max-width:600px;margin:0 auto;background:white;border-radius:6px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
<div style="background:#0b6cf6;color:white;padding:20px;"><h1 style="margin:0;font-size:20px;">üéâ TeleMedCare</h1></div>
<div style="padding:24px;">
<h1>Benvenuto/a {{NOME_CLIENTE}}!</h1>
<p style="font-size:18px;">üéâ Congratulazioni per la Sua scelta!</p>
<p>Ha scelto il nostro servizio <strong>{{PIANO_SERVIZIO}}</strong> e ora fa parte della famiglia TeleMedCare.</p>
<div style="background:#f7f9fc;border:1px solid #eef2f7;padding:16px;border-radius:6px;margin:16px 0;">
<h3 style="margin:0 0 8px;color:#0b6cf6;">üìã Il Suo Servizio</h3>
<strong>Piano:</strong> {{PIANO_SERVIZIO}}<br>
<strong>Costo:</strong> {{COSTO_SERVIZIO}}<br>
<strong>Data Attivazione:</strong> {{DATA_ATTIVAZIONE}}<br>
<strong>Codice Cliente:</strong> {{CODICE_CLIENTE}}
</div>
<h3 style="color:#0b6cf6;">üöÄ Prossimi Passi:</h3>
<ol style="margin-left:18px;">
<li><strong>Consegna:</strong> Dispositivo entro 10 giorni</li>
<li><strong>Configurazione:</strong> Email per setup personalizzato</li>
<li><strong>Training:</strong> Tutorial gratuito</li>
<li><strong>Attivazione:</strong> Test completo con la Centrale</li>
</ol>
<p style="margin-top:20px;"><strong>Benvenuto/a nella famiglia TeleMedCare!</strong><br>Il Team TeleMedCare</p>
</div></div></body></html>`;case"email_conferma_attivazione":return`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Servizio Attivato</title></head>
<body style="font-family:Arial,sans-serif;margin:0;padding:20px;background:#f4f6f8;">
<div style="max-width:600px;margin:0 auto;background:white;border-radius:6px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
<div style="background:#10b981;color:white;padding:20px;"><h1 style="margin:0;font-size:20px;">‚úÖ TeleMedCare</h1></div>
<div style="padding:24px;">
<h1>Servizio Attivato!</h1>
<p>Gentile <strong>{{NOME_CLIENTE}}</strong>,</p>
<p>Il Suo servizio <strong>{{PIANO_SERVIZIO}}</strong> √® stato attivato con successo!</p>
<div style="background:#f0fdf4;border:1px solid #dcfce7;padding:16px;border-radius:6px;margin:16px 0;">
<h3 style="margin:0 0 8px;color:#10b981;">‚úÖ Configurazione Completata</h3>
<strong>Dispositivo:</strong> {{DISPOSITIVO}}<br>
<strong>Serial Number:</strong> {{SERIAL_NUMBER}}<br>
<strong>Data Attivazione:</strong> {{DATA_ATTIVAZIONE}}<br>
<strong>Codice Cliente:</strong> {{CODICE_CLIENTE}}
</div>
<p>Il Suo dispositivo √® ora operativo e monitorato H24.</p>
<p style="margin-top:20px;"><strong>La Sua sicurezza √® la nostra priorit√†!</strong><br>Il Team TeleMedCare</p>
</div></div></body></html>`;case"email_followup_call":return`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Follow-up Call</title></head>
<body style="font-family:Arial,sans-serif;margin:0;padding:20px;background:#f4f6f8;">
<div style="max-width:600px;margin:0 auto;background:white;border-radius:6px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
<div style="background:#f59e0b;color:white;padding:20px;"><h1 style="margin:0;font-size:20px;">üìû TeleMedCare</h1></div>
<div style="padding:24px;">
<h1>Chiamata di Follow-up</h1>
<p>Gentile <strong>{{NOME_CLIENTE}}</strong>,</p>
<p>Abbiamo programmato una chiamata di follow-up per verificare il corretto funzionamento del servizio.</p>
<div style="background:#fffbeb;border:1px solid #fef3c7;padding:16px;border-radius:6px;margin:16px 0;">
<h3 style="margin:0 0 8px;color:#f59e0b;">üìÖ Dettagli Chiamata</h3>
<strong>Data:</strong> {{DATA_CHIAMATA}}<br>
<strong>Orario:</strong> {{ORA_CHIAMATA}}<br>
<strong>Motivo:</strong> {{MOTIVO_CHIAMATA}}
</div>
<p>Se non dovesse essere disponibile, La ricontatteremo.</p>
<p style="margin-top:20px;"><strong>Grazie!</strong><br>Il Team TeleMedCare</p>
</div></div></body></html>`;case"email_notifica_info":return`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Nuovo Lead TeleMedCare</title></head>
<body style="font-family:Arial,sans-serif;margin:0;padding:20px;background:#f4f6f8;">
<div style="max-width:600px;margin:0 auto;background:white;border-radius:6px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
<div style="background:#dc2626;color:white;padding:20px;"><h1 style="margin:0;font-size:20px;">üö® TeleMedCare - NUOVO LEAD</h1></div>
<div style="padding:24px;">
<h1 style="color:#dc2626;">Nuovo Lead Ricevuto!</h1>
<p><strong>Un nuovo potenziale cliente ha manifestato interesse per i nostri servizi.</strong></p>
<div style="background:#fef2f2;border:1px solid #fecaca;padding:16px;border-radius:6px;margin:16px 0;">
<h3 style="margin:0 0 8px;color:#dc2626;">üë§ Dati Cliente</h3>
<strong>Nome:</strong> {{NOME_CLIENTE}}<br>
<strong>Email:</strong> {{EMAIL_CLIENTE}}<br>
<strong>Telefono:</strong> {{TELEFONO_CLIENTE}}<br>
<strong>Servizio richiesto:</strong> {{SERVIZIO_RICHIESTO}}<br>
<strong>Data/Ora:</strong> {{TIMESTAMP_LEAD}}<br>
<strong>Lead ID:</strong> {{LEAD_ID}}
</div>
<h3 style="color:#dc2626;">‚ö° Azioni Immediate Richieste:</h3>
<ol style="margin-left:18px;color:#374151;">
<li><strong>Contattare entro 30 minuti</strong> per massimizzare conversione</li>
<li><strong>Verificare interesse</strong> e necessit√† specifiche</li>
<li><strong>Inviare documentazione</strong> personalizzata</li>
<li><strong>Programmare demo</strong> se richiesta</li>
</ol>
<p style="margin-top:20px;"><strong>Priorit√† ALTA - Gestire immediatamente!</strong><br>Sistema TeleMedCare V11.0</p>
</div></div></body></html>`;case"email_documenti_informativi":return`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Documenti Informativi TeleMedCare</title></head>
<body style="font-family:Arial,sans-serif;margin:0;padding:20px;background:#f4f6f8;">
<div style="max-width:600px;margin:0 auto;background:white;border-radius:6px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
<div style="background:#0ea5e9;color:white;padding:20px;"><h1 style="margin:0;font-size:20px;">üìã TeleMedCare</h1></div>
<div style="padding:24px;">
<h1>Invio Documenti Informativi</h1>
<p>Team TeleMedCare,</p>
<p><strong>{{NOME_CLIENTE}}</strong> ha richiesto documentazione informativa sui nostri servizi.</p>
<div style="background:#f0f9ff;border:1px solid #bae6fd;padding:16px;border-radius:6px;margin:16px 0;">
<h3 style="margin:0 0 8px;color:#0ea5e9;">üìã Dettagli Richiesta</h3>
<strong>Cliente:</strong> {{NOME_CLIENTE}}<br>
<strong>Email:</strong> {{EMAIL_CLIENTE}}<br>
<strong>Documenti richiesti:</strong> {{DOCUMENTI_RICHIESTI}}<br>
<strong>Servizio di interesse:</strong> {{SERVIZIO_INTERESSE}}<br>
<strong>Data richiesta:</strong> {{TIMESTAMP_RICHIESTA}}
</div>
<h3 style="color:#0ea5e9;">üìã Azioni da Completare:</h3>
<ol style="margin-left:18px;color:#374151;">
<li><strong>Inviare brochure</strong> del servizio richiesto</li>
<li><strong>Allegare listino prezzi</strong> aggiornato</li>
<li><strong>Includere case studies</strong> pertinenti</li>
<li><strong>Programmare follow-up</strong> a 3-5 giorni</li>
</ol>
<p style="margin-top:20px;"><strong>Da gestire entro 4 ore lavorative</strong><br>Sistema TeleMedCare V11.0</p>
</div></div></body></html>`;default:return`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>TeleMedCare</title></head>
<body style="font-family:Arial,sans-serif;padding:20px;text-align:center;">
<h1 style="color:#0b63a5;">üìß TeleMedCare</h1>
<p>Template email non disponibile.</p>
<p>Contatti il supporto per assistenza.</p>
</body></html>`}}async sendEmailInternal(t,e){var a;try{console.log("üìß Invio email reale:",{to:t.to,subject:t.subject,attachments:((a=t.attachments)==null?void 0:a.length)||0,hasEnv:!!e,hasSendgrid:!!(e!=null&&e.SENDGRID_API_KEY),hasResend:!!(e!=null&&e.RESEND_API_KEY)});let i=null,s=null;try{console.log("üìß [1/2] Tentativo SendGrid...");const r=await this.sendWithSendGrid(t,e);if(r.success)return console.log("‚úÖ Email inviata con successo via SendGrid:",r.messageId),r;console.warn("‚ö†Ô∏è SendGrid non ha avuto successo:",r),i=r.error||"Unknown error"}catch(r){i=r,console.error("‚ùå SendGrid exception:",r)}try{console.log("üìß [2/2] Tentativo Resend (fallback)...");const r=await this.sendWithResend(t,e);if(r.success)return console.log("‚úÖ Email inviata con successo via Resend:",r.messageId),r;console.warn("‚ö†Ô∏è Resend non ha avuto successo:",r),s=r.error||"Unknown error"}catch(r){s=r,console.error("‚ùå Resend exception:",r)}return console.error("‚ùå TUTTI I PROVIDER FALLITI - MODALIT√Ä DEMO ATTIVA"),console.error("SendGrid error:",i),console.error("Resend error:",s),{success:!0,messageId:`DEMO_${Date.now()}_${Math.random().toString(36).substring(2)}`,timestamp:new Date().toISOString(),warning:"DEMO MODE: Email non inviata realmente",errors:{sendgrid:(i==null?void 0:i.message)||String(i),resend:(s==null?void 0:s.message)||String(s)}}}catch(i){return{success:!1,error:i instanceof Error?i.message:"Errore invio email",timestamp:new Date().toISOString()}}}async sendWithSendGrid(t,e){var l;const a=(e==null?void 0:e.SENDGRID_API_KEY)||"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";console.log("üìß SendGrid: Using API key:",`${a.substring(0,10)}...`),console.log("üìß SendGrid: From:",t.from||"info@telemedcare.it"),console.log("üìß SendGrid: To:",t.to);const i={personalizations:[{to:[{email:t.to}],subject:t.subject}],from:{name:"TeleMedCare",email:t.from||"info@telemedcare.it"},content:[{type:"text/html",value:t.html}],attachments:(l=t.attachments)==null?void 0:l.map(c=>({filename:c.filename,content:typeof c.content=="string"?c.content:Buffer.from(c.content).toString("base64"),type:c.contentType,disposition:"attachment"}))};console.log("üìß SendGrid: Sending request...");const s=await fetch("https://api.sendgrid.com/v3/mail/send",{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify(i)});if(console.log("üìß SendGrid: Response status:",s.status),!s.ok){const c=await s.text();throw console.error("‚ùå SendGrid error response:",c),new Error(`SendGrid API error: ${s.status} ${c}`)}return{success:!0,messageId:s.headers.get("X-Message-Id")||"sendgrid-"+Date.now(),timestamp:new Date().toISOString()}}async sendWithResend(t,e){var c;const a=(e==null?void 0:e.RESEND_API_KEY)||"re_QeeK2km4_94B4bM3sGq2KhDBf2gi624d2";console.log("üìß Resend: Using API key:",`${a.substring(0,10)}...`);const s={from:`TeleMedCare <${t.from||"info@telemedcare.it"}>`,to:[t.to],subject:t.subject,html:t.html,text:t.text,attachments:(c=t.attachments)==null?void 0:c.map(d=>({filename:d.filename,content:d.content,content_type:d.contentType}))},r=await fetch("https://api.resend.com/emails",{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify(s)});if(!r.ok){const d=await r.text();throw new Error(`Resend API error: ${r.status} ${d}`)}return{success:!0,messageId:(await r.json()).id,timestamp:new Date().toISOString()}}async sendWorkflowEmails(t){const e=[];for(const a of t){const i=await this.sendTemplateEmail(a.templateId,a.to,a.variables,a.attachments);e.push(i),await new Promise(s=>setTimeout(s,100))}return e}getAllTemplates(){return Bc}getTemplate(t){return Bc[t.toUpperCase()]||null}};_(Oa,"instance",null);let Ke=Oa;const Dt=Object.freeze(Object.defineProperty({__proto__:null,EMAIL_TEMPLATES:Bc,EmailService:Ke,TemplateEngine:is,default:Ke},Symbol.toStringTag,{value:"Module"}));async function Ip(o,t,e){try{if(e!=null&&e.DB){const v=await e.DB.prepare("SELECT value FROM settings WHERE key = ?").bind("admin_email_notifications_enabled").first();if((v==null?void 0:v.value)!=="true"){console.log(`‚è≠Ô∏è [NOTIFICATION] Notifiche admin disabilitate, skip email per lead ${o}`);return}}const a=new Ke(e),i=t.nomeRichiedente||"N/A",s=t.cognomeRichiedente||"",r=t.email||"N/A",l=t.telefono||"Non fornito",c=t.citta||"Non fornita",d=t.servizio||"eCura PRO",u=t.piano||"BASE",p=t.fonte||"N/A",g=t.note||"",m=t.created_at?new Date(t.created_at).toLocaleString("it-IT"):new Date().toLocaleString("it-IT");await a.sendEmail({to:(e==null?void 0:e.EMAIL_TO_INFO)||"info@telemedcare.it",from:(e==null?void 0:e.EMAIL_FROM)||"info@telemedcare.it",subject:`üÜï Nuovo Lead: ${i} ${s} - ${u}`,html:`
        <!DOCTYPE html>
        <html lang="it">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Nuovo Lead TeleMedCare</title>
        </head>
        <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
            <h1 style="color: white; margin: 0; font-size: 28px;">üÜï Nuovo Lead TeleMedCare</h1>
          </div>
          
          <div style="background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px;">
            <p style="font-size: 16px; margin-bottom: 20px;"><strong>Richiesta ricevuta:</strong> ${m}</p>
            
            <h2 style="color: #667eea; margin-top: 30px;">üë§ Dati Richiedente</h2>
            <table style="width: 100%; border-collapse: collapse;">
              <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px; font-weight: bold;">Nome:</td>
                <td style="padding: 10px;">${i} ${s}</td>
              </tr>
              <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px; font-weight: bold;">Email:</td>
                <td style="padding: 10px;"><a href="mailto:${r}">${r}</a></td>
              </tr>
              <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px; font-weight: bold;">Telefono:</td>
                <td style="padding: 10px;">${l}</td>
              </tr>
              <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px; font-weight: bold;">Citt√†:</td>
                <td style="padding: 10px;">${c}</td>
              </tr>
            </table>
            
            <h2 style="color: #667eea; margin-top: 30px;">üìã Dettagli Servizio</h2>
            <table style="width: 100%; border-collapse: collapse;">
              <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px; font-weight: bold;">Servizio:</td>
                <td style="padding: 10px;">${d}</td>
              </tr>
              <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px; font-weight: bold;">Piano:</td>
                <td style="padding: 10px;">${u}</td>
              </tr>
              <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px; font-weight: bold;">Fonte:</td>
                <td style="padding: 10px;">${p}</td>
              </tr>
              <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px; font-weight: bold;">Lead ID:</td>
                <td style="padding: 10px;"><code>${o}</code></td>
              </tr>
            </table>
            
            ${g?`
            <h2 style="color: #667eea; margin-top: 30px;">üìù Note</h2>
            <div style="background: white; border-left: 4px solid #667eea; padding: 15px; margin: 20px 0;">
              <p style="margin: 0; font-size: 14px; color: #666;">${g}</p>
            </div>
            `:""}
            
            <div style="margin-top: 30px; text-align: center;">
              <a href="https://telemedcare-v12.pages.dev/dashboard" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold;">Visualizza nella Dashboard</a>
            </div>
          </div>
          
          <div style="text-align: center; padding: 20px; font-size: 12px; color: #666;">
            <p style="margin: 5px 0;">TeleMedCare - Sistema di Gestione Lead</p>
            <p style="margin: 5px 0;">info@telemedcare.it</p>
          </div>
        </body>
        </html>
      `,text:`Nuovo Lead: ${i} ${s}

Email: ${r}
Telefono: ${l}
Citt√†: ${c}
Servizio: ${d} - ${u}
Fonte: ${p}
Lead ID: ${o}`}),console.log(`üìß [NOTIFICATION] Email inviata per nuovo lead ${o} (fonte: ${p})`)}catch(a){console.error(`‚ö†Ô∏è [NOTIFICATION] Errore invio email per lead ${o}:`,a)}}async function zg(o){var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const e=[{key:"hubspot_auto_import_enabled",value:"false",description:"Abilita import automatico da HubSpot"},{key:"lead_email_notifications_enabled",value:"false",description:"Abilita invio email automatiche ai lead"},{key:"admin_email_notifications_enabled",value:"true",description:"Abilita notifiche email a info@telemedcare.it"},{key:"reminder_completion_enabled",value:"false",description:"Abilita reminder automatici completamento dati lead"},{key:"auto_completion_enabled",value:"false",description:"Abilita invio automatico email completamento dati"},{key:"auto_payment_workflow_enabled",value:"false",description:"Abilita workflow automatico pagamenti"},{key:"auto_contract_workflow_enabled",value:"false",description:"Abilita workflow automatico contratti"}];for(const r of e)try{await o.env.DB.prepare(`
          INSERT OR IGNORE INTO settings (key, value, description, updated_at) 
          VALUES (?, ?, ?, datetime('now'))
        `).bind(r.key,r.value,r.description).run()}catch(l){console.warn(`‚ö†Ô∏è Skip init setting ${r.key}:`,l)}const a=await o.env.DB.prepare("SELECT key, value, description FROM settings").all(),i={},s={};return a.results.forEach(r=>{const l=r.value==="true";i[r.key]={value:r.value,description:r.description},s[r.key]=l}),o.json({success:!0,settings:i,...s})}catch(e){return console.error("‚ùå Errore get settings:",e),o.json({success:!1,error:"Errore recupero configurazioni"},500)}}async function Lg(o){var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const e=o.req.param("key"),{value:a}=await o.req.json();if(!await o.env.DB.prepare("SELECT key FROM settings WHERE key = ?").bind(e).first())return o.json({success:!1,error:`Setting '${e}' non trovato`},404);let s="false";return(a===!0||a==="true"||a==="1"||a===1)&&(s="true"),await o.env.DB.prepare("UPDATE settings SET value = ?, updated_at = ? WHERE key = ?").bind(s,new Date().toISOString(),e).run(),console.log(`‚öôÔ∏è Setting aggiornato: ${e} = ${s}`),o.json({success:!0,message:"Setting aggiornato",key:e,value:s==="true"})}catch(e){return console.error("‚ùå Errore update setting:",e),o.json({success:!1,error:"Errore aggiornamento setting"},500)}}async function Ud(o,t){try{const e=await o.prepare("SELECT value FROM settings WHERE key = ?").bind(t).first();return(e==null?void 0:e.value)==="true"}catch(e){return console.error(`‚ùå Errore lettura setting ${t}:`,e),!1}}const Ng=Object.freeze(Object.defineProperty({__proto__:null,getSetting:Ud,getSettings:zg,updateSetting:Lg},Symbol.toStringTag,{value:"Module"})),Pg={FAMILY:{BASE:{servizio:"FAMILY",piano:"BASE",dispositivo:"Senium",descrizioneDispositivo:"Dispositivo base per monitoraggio familiare",setupBase:390,setupIva:85.8,setupTotale:475.8,rinnovoBase:200,rinnovoIva:44,rinnovoTotale:244,detrazioneFiscale19:90.4,serviziInclusi:["Dispositivo medicale Senium","Monitoraggio parametri vitali base","Supporto tecnico (orario lavorativo)","Report mensili","Aggiornamenti software"]},AVANZATO:{servizio:"FAMILY",piano:"AVANZATO",dispositivo:"Senium",descrizioneDispositivo:"Dispositivo base con centrale operativa H24",setupBase:690,setupIva:151.8,setupTotale:841.8,rinnovoBase:500,rinnovoIva:110,rinnovoTotale:610,detrazioneFiscale19:159.94,serviziInclusi:["Dispositivo medicale Senium","Centrale Operativa H24/7","Monitoraggio parametri vitali avanzato","Supporto professionale continuo","Assistenza medica specializzata","Report sanitari periodici","Coordinamento emergenze"]}},PRO:{BASE:{servizio:"PRO",piano:"BASE",dispositivo:"SiDLY Care PRO",descrizioneDispositivo:"Dispositivo professionale per assistenza avanzata",setupBase:480,setupIva:105.6,setupTotale:585.6,rinnovoBase:240,rinnovoIva:52.8,rinnovoTotale:292.8,detrazioneFiscale19:111.26,serviziInclusi:["Dispositivo medicale SiDLY Care PRO (Classe IIa)","Rilevamento automatico cadute","GPS e geolocalizzazione","Monitoraggio parametri vitali","Comunicazione bidirezionale","Pulsante SOS","Supporto tecnico standard"]},AVANZATO:{servizio:"PRO",piano:"AVANZATO",dispositivo:"SiDLY Care PRO",descrizioneDispositivo:"Dispositivo professionale con centrale operativa H24",setupBase:840,setupIva:184.8,setupTotale:1024.8,rinnovoBase:600,rinnovoIva:132,rinnovoTotale:732,detrazioneFiscale19:194.71,serviziInclusi:["Dispositivo medicale SiDLY Care PRO (Classe IIa)","Centrale Operativa H24/7","Rilevamento cadute con algoritmi avanzati","GPS e geolocalizzazione precisa","Monitoraggio parametri vitali avanzato","Comunicazione bidirezionale vocale","Pulsante SOS geolocalizzato","Promemoria farmaci","Supporto familiare con notifiche","Assistenza professionale continua","Intervento immediato emergenze","Consulenze mediche specializzate"]}},PREMIUM:{BASE:{servizio:"PREMIUM",piano:"BASE",dispositivo:"SiDLY Vital Care",descrizioneDispositivo:"Dispositivo premium per monitoraggio completo",setupBase:590,setupIva:129.8,setupTotale:719.8,rinnovoBase:300,rinnovoIva:66,rinnovoTotale:366,detrazioneFiscale19:136.76,serviziInclusi:["Dispositivo medicale SiDLY Vital Care (Classe IIa)","Monitoraggio completo parametri vitali","Rilevamento cadute avanzato","GPS e tracking","Comunicazione vocale HD","Dashboard famiglia avanzata","Supporto tecnico standard"]},AVANZATO:{servizio:"PREMIUM",piano:"AVANZATO",dispositivo:"SiDLY Vital Care",descrizioneDispositivo:"Dispositivo premium con centrale operativa H24",setupBase:990,setupIva:217.8,setupTotale:1207.8,rinnovoBase:750,rinnovoIva:165,rinnovoTotale:915,detrazioneFiscale19:229.48,serviziInclusi:["Dispositivo medicale SiDLY Vital Care (Classe IIa)","Centrale Operativa H24/7","Monitoraggio completo parametri vitali","Rilevamento cadute intelligente","GPS e geolocalizzazione avanzata","Comunicazione vocale HD bidirezionale","Pulsante SOS prioritario","Dashboard famiglia premium","Promemoria farmaci intelligenti","Assistenza medica specializzata H24","Intervento emergenze immediato","Report sanitari dettagliati","Consulenze mediche illimitate","Supporto psicologico famiglia"]}}};function vc(o,t){const e=Pg[o];return e&&e[t]||null}function Yt(o,t){return`eCura ${o} ${t==="BASE"?"Base":"Avanzato"}`}const lv=Object.freeze(Object.defineProperty({__proto__:null,ECURA_PRICING:Pg,formatServiceName:Yt,getPricing:vc},Symbol.toStringTag,{value:"Module"}));async function Ao(o,t,e){const a=(e==null?void 0:e.PUBLIC_URL)||(e==null?void 0:e.PAGES_URL)||"https://telemedcare-v12.pages.dev",i=`/templates/email/${o}.html`,s=`${a}${i}`;console.log(`üìÇ [TEMPLATE] Loading "${o}" from: ${s}`);try{const r=await fetch(s);if(!r.ok)throw new Error(`Template not found: HTTP ${r.status}`);const l=await r.text();return console.log(`‚úÖ [TEMPLATE] Loaded "${o}" (${l.length} chars)`),l}catch(r){throw console.error(`‚ùå [TEMPLATE] Error loading "${o}":`,r),new Error(`Template "${o}" not found at ${s}`)}}function Co(o,t){let e=o;for(const[a,i]of Object.entries(t))if(Array.isArray(i)){const s=`{{#${a}}}`,r=`{{/${a}}}`,l=new RegExp(`${s}([\\s\\S]*?)${r}`,"g");e=e.replace(l,(c,d)=>i.length===0?"":i.map(u=>{let p=d;for(const[g,m]of Object.entries(u)){const v=new RegExp(`{{#${g}}}([\\s\\S]*?){{/${g}}}`,"g");p=p.replace(v,(b,E)=>m?E:"")}for(const[g,m]of Object.entries(u)){const v=`{{${g}}}`,b=new RegExp(v.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),E=m!=null?String(m):"";p=p.replace(b,E)}return p}).join(""))}for(const[a,i]of Object.entries(t))if(!Array.isArray(i)){const s=`{{${a}}}`,r=new RegExp(s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),l=i!=null?String(i):"";e=e.replace(r,l)}return e}const Ec=Object.freeze(Object.defineProperty({__proto__:null,loadEmailTemplate:Ao,renderTemplate:Co},Symbol.toStringTag,{value:"Module"})),cv={FAMILY:{servizio:"FAMILY",nomeDispositivo:"Senium",filename:"Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf",descrizione:"Dispositivo per monitoraggio familiare"},PRO:{servizio:"PRO",nomeDispositivo:"SiDLY Care PRO",filename:"Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf",descrizione:"Dispositivo professionale per assistenza avanzata (SiDLY Care PRO)"},PREMIUM:{servizio:"PREMIUM",nomeDispositivo:"SiDLY Vital Care",filename:"Medica-GB-SiDLY_Vital_Care_ITA-compresso.pdf",descrizione:"Dispositivo premium per monitoraggio completo (SiDLY Vital Care)"}};function dv(o){const t=o.toUpperCase();return cv[t]||null}async function kg(o,t){try{const e=dv(o);if(!e)return console.error(`‚ùå Servizio "${o}" non trovato nella mappa brochure`),null;const a=`${t}/brochures/${e.filename}`;console.log(`üì• [BROCHURE] Servizio: ${o} ‚Üí Dispositivo: ${e.nomeDispositivo}`),console.log(`üì• [BROCHURE] Caricamento da: ${a}`);const i=await fetch(a);if(!i.ok)return console.error(`‚ùå Errore HTTP ${i.status} per ${a}`),null;const s=await i.arrayBuffer(),r=(s.byteLength/1024).toFixed(2);console.log(`‚úÖ [BROCHURE] ${e.nomeDispositivo}: ${e.filename} (${r} KB)`);const l=new Uint8Array(s),c=32768;let d="";for(let p=0;p<l.length;p+=c){const g=l.slice(p,p+c);d+=String.fromCharCode.apply(null,Array.from(g))}const u=btoa(d);return{filename:e.filename,content:u,size:s.byteLength}}catch(e){return console.error(`‚ùå Errore caricamento brochure per servizio "${o}":`,e),null}}function Bg(){const o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t="";for(let e=0;e<64;e++)t+=o.charAt(Math.floor(Math.random()*o.length));return t}function Fg(o){const t=new Date;return t.setDate(t.getDate()+o),t.toISOString()}function jd(o){const t={telefono:"Telefono",nomeAssistito:"Nome Assistito",cognomeAssistito:"Cognome Assistito",dataNascitaAssistito:"Data di Nascita Assistito",luogoNascitaAssistito:"Luogo di Nascita Assistito",cfAssistito:"Codice Fiscale Assistito",indirizzoAssistito:"Indirizzo Assistito",condizioniSalute:"Condizioni di Salute"},e=[],a={};return Object.entries(t).forEach(([i,s])=>{const r=o[i];!r||r===""||r===null||r===void 0?e.push(s):a[s]=r}),o.nomeRichiedente&&(a["Nome Richiedente"]=o.nomeRichiedente),o.cognomeRichiedente&&(a["Cognome Richiedente"]=o.cognomeRichiedente),o.email&&(a.Email=o.email),o.servizio&&(a["Servizio Richiesto"]=o.servizio),o.piano&&(a["Piano Selezionato"]=o.piano),{missing:e,available:a}}function uv(o){const{missing:t}=jd(o);return t.length===0}async function $g(o){const t=await o.prepare("SELECT key, value FROM system_config").all(),e={};return t.results.forEach(a=>{const i=a.key,s=a.value;i==="auto_completion_enabled"||i==="cron_enabled"||i==="hubspot_sync_enabled"?e[i]=s==="true":e[i]=parseInt(s,10)}),{auto_completion_enabled:e.auto_completion_enabled||!1,auto_completion_token_days:e.auto_completion_token_days||30,auto_completion_reminder_days:e.auto_completion_reminder_days||3,auto_completion_max_reminders:e.auto_completion_max_reminders||2,cron_enabled:e.cron_enabled!==void 0?e.cron_enabled:!0,hubspot_sync_enabled:e.hubspot_sync_enabled!==void 0?e.hubspot_sync_enabled:!1}}async function pv(o,t,e){const a=typeof e=="boolean"?e?"true":"false":String(e);await o.prepare(`
    INSERT INTO system_config (key, value, updated_at)
    VALUES (?, ?, datetime('now'))
    ON CONFLICT(key) DO UPDATE SET
      value = excluded.value,
      updated_at = excluded.updated_at
  `).bind(t,a).run()}async function mv(o,t,e=30){const a=Bg(),i=`TOKEN-${Date.now()}-${Math.random().toString(36).substring(2,9).toUpperCase()}`,s=Fg(e),r=new Date().toISOString();return await o.prepare(`
    INSERT INTO lead_completion_tokens (
      id, lead_id, token, expires_at, completed, created_at
    ) VALUES (?, ?, ?, ?, 0, ?)
  `).bind(i,t,a,s,r).run(),await Hd(o,t,i,"token_created",`Token creato, scadenza: ${s}`),{id:i,lead_id:t,token:a,expires_at:s,completed:0,created_at:r,completed_at:null,reminder_sent_at:null,reminder_count:0}}async function gv(o,t){const e=await o.prepare("SELECT * FROM lead_completion_tokens WHERE token = ? LIMIT 1").bind(t).first();if(!e)return{valid:!1,error:"Token non trovato"};if(e.completed)return{valid:!1,error:"Token gi√† utilizzato"};const a=new Date,i=new Date(e.expires_at);return a>i?{valid:!1,error:"Token scaduto"}:{valid:!0,tokenData:e}}async function hv(o,t){const e=new Date().toISOString();await o.prepare(`
    UPDATE lead_completion_tokens
    SET completed = 1, completed_at = ?
    WHERE id = ?
  `).bind(e,t).run();const a=await o.prepare("SELECT lead_id FROM lead_completion_tokens WHERE id = ?").bind(t).first();a&&await Hd(o,a.lead_id,t,"completed","Lead completato con successo")}async function Ug(o,t){const e=new Date().toISOString();await o.prepare(`
    UPDATE lead_completion_tokens
    SET reminder_sent_at = ?, reminder_count = reminder_count + 1
    WHERE id = ?
  `).bind(e,t).run();const a=await o.prepare("SELECT lead_id, reminder_count FROM lead_completion_tokens WHERE id = ?").bind(t).first();a&&await Hd(o,a.lead_id,t,"reminder_sent",`Reminder ${a.reminder_count} inviato`)}async function jg(o,t,e){const a=new Date;return a.setDate(a.getDate()-t),(await o.prepare(`
    SELECT * FROM lead_completion_tokens
    WHERE completed = 0
      AND expires_at > datetime('now')
      AND reminder_count < ?
      AND (
        reminder_sent_at IS NULL
        OR reminder_sent_at < ?
      )
  `).bind(e,a.toISOString()).all()).results}async function Hd(o,t,e,a,i){const s=`LOG-${Date.now()}-${Math.random().toString(36).substring(2,9).toUpperCase()}`,r=new Date().toISOString();await o.prepare(`
    INSERT INTO lead_completion_log (id, lead_id, token_id, action, details, created_at)
    VALUES (?, ?, ?, ?, ?, ?)
  `).bind(s,t,e,a,i,r).run()}async function Hg(o,t,e,a){try{const i=(await Promise.resolve().then(()=>Dt)).default,{loadEmailTemplate:s,renderTemplate:r}=await Promise.resolve().then(()=>Ec),l=new i(t),c=await s("email_reminder_completamento",o,t),u=`${t.PUBLIC_URL||t.PAGES_URL||"https://telemedcare-v12.pages.dev"}/completa-dati?token=${e.token}`,{missing:p}=jd(a),g=p.map(R=>`<li style="color: #856404; font-weight: 500;">${R}</li>`).join(`
        `),m=new Date(e.expires_at),v=Math.ceil((m.getTime()-Date.now())/(1e3*60*60*24)),b={NOME_CLIENTE:a.nomeRichiedente||"Cliente",COGNOME_CLIENTE:a.cognomeRichiedente||"",LEAD_ID:a.id,SERVIZIO:a.servizio||"eCura",PIANO:a.piano||"BASE",MISSING_FIELDS_HTML:g,MISSING_FIELDS_COUNT:p.length,COMPLETION_LINK:u,DAYS_REMAINING:v,TOKEN_EXPIRY:m.toLocaleDateString("it-IT"),REMINDER_COUNT:e.reminder_count+1},E=r(c,b),T=await l.sendEmail({to:a.email,subject:`‚è∞ Promemoria: Completa i tuoi dati TeleMedCare (${v} giorni rimasti)`,html:E,tags:[{name:"tipo",value:"reminder_completamento"},{name:"lead_id",value:a.id},{name:"reminder_count",value:String(e.reminder_count+1)}]});return T.success?(await Ug(o,e.id),console.log(`‚úÖ [REMINDER] Email inviata a ${a.email} (reminder #${e.reminder_count+1})`),!0):(console.error("‚ùå [REMINDER] Errore invio email:",T.error),!1)}catch(i){return console.error("‚ùå [REMINDER] Errore sendReminderEmail:",i),!1}}async function fv(o,t){const e=await $g(o);if(!e.cron_enabled)return console.log("‚ö†Ô∏è [REMINDER] Cron disabilitato dalla dashboard - nessuna azione eseguita"),{success:0,failed:0,total:0,disabled:!0};console.log("‚úÖ [REMINDER] Cron abilitato - avvio processo reminder");const a=await jg(o,e.auto_completion_reminder_days,e.auto_completion_max_reminders);console.log(`üìß [REMINDER] Trovati ${a.length} token che necessitano reminder`);let i=0,s=0;for(const r of a)try{const l=await o.prepare("SELECT * FROM leads WHERE id = ?").bind(r.lead_id).first();if(!l){console.warn(`‚ö†Ô∏è [REMINDER] Lead ${r.lead_id} non trovato`),s++;continue}await Hg(o,t,r,l)?i++:s++,await new Promise(d=>setTimeout(d,1e3))}catch(l){console.error(`‚ùå [REMINDER] Errore processando token ${r.id}:`,l),s++}return{success:i,failed:s,total:a.length}}const Mt=Object.freeze(Object.defineProperty({__proto__:null,calculateExpiryDate:Fg,createCompletionToken:mv,generateSecureToken:Bg,getMissingFields:jd,getSystemConfig:$g,getTokensNeedingReminder:jg,isLeadComplete:uv,logCompletionAction:Hd,markTokenAsCompleted:hv,processReminders:fv,recordReminderSent:Ug,sendReminderEmail:Hg,updateSystemConfig:pv,validateCompletionToken:gv},Symbol.toStringTag,{value:"Module"}));async function vv(o,t){const e=t.servizio||"eCura PRO",a=t.tipoServizio||"BASE",i=e.includes("PREMIUM")?"SiDLY Vital Care":"SiDLY Care PRO",s=t.prezzoBase,r=a==="AVANZATO"?600:200,l=new Date().toLocaleDateString("it-IT",{day:"2-digit",month:"long",year:"numeric"}),c=new Date().toLocaleDateString("it-IT"),d=new Date(Date.now()+365*24*60*60*1e3).toLocaleDateString("it-IT"),u=!o.intestatarioContratto||o.intestatarioContratto==="richiedente",p=u?o.nomeRichiedente:o.nomeAssistito||o.nomeRichiedente,g=u?o.cognomeRichiedente:o.cognomeAssistito||o.cognomeRichiedente,m=o.luogoNascitaAssistito||"N/A",v=o.dataNascitaAssistito||"N/A",b=o.indirizzoAssistito||"N/A",E=o.capAssistito||"N/A",T=o.cittaAssistito||"N/A",R=o.provinciaAssistito||"N/A",S=o.cfAssistito||"N/A";return`
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contratto eCura - ${t.contractCode}</title>
    <style>
        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            color: #333;
            background-color: #fff;
        }
        
        h1 {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
            text-transform: uppercase;
        }
        
        h2 {
            font-size: 16px;
            font-weight: bold;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        
        p {
            margin-bottom: 12px;
            text-align: justify;
        }
        
        .party {
            margin: 20px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-left: 4px solid #0066cc;
        }
        
        .breviter {
            font-style: italic;
            margin-top: 10px;
        }
        
        .premises {
            margin: 20px 0;
        }
        
        .premises ul {
            list-style-type: none;
            padding-left: 0;
        }
        
        .premises li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }
        
        .premises li:before {
            content: "-";
            position: absolute;
            left: 0;
        }
        
        .feature-list {
            margin: 15px 0;
            padding-left: 20px;
        }
        
        .highlight {
            background-color: transparent;
            padding: 0;
            font-weight: bold;
        }
        
        .payment-details {
            background-color: #f5f5f5;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #ddd;
        }
        
        .signature-section {
            margin-top: 40px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        
        .signature-block {
            width: 45%;
            border-top: 1px solid #333;
            padding-top: 10px;
            text-align: center;
        }
        
        .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid #0066cc;
            text-align: center;
            font-size: 12px;
            color: #666;
        }
        
        .footer p {
            margin: 5px 0;
        }
        
        @media print {
            body {
                padding: 20px;
            }
            .signature-section {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <h1>SCRITTURA PRIVATA</h1>
    
    <p>Con la presente scrittura privata da valere a tutti gli effetti e conseguenze di legge tra:</p>
    
    <div class="party">
        <p><strong>Medica GB S.r.l.</strong>, con sede in Corso Giuseppe Garibaldi, 34 ‚Äì 20121 Milano e con Partita IVA e registro imprese 12435130963, in persona dell'Amministratore Stefania Rocca</p>
        <p class="breviter">(breviter Medica GB)</p>
    </div>
    
    <p style="text-align: center; font-weight: bold;">e</p>
    
    <div class="party">
        <p>Sig./Sig.ra <span class="highlight">${p}</span> <span class="highlight">${g}</span> nato/a a <span class="highlight">${m}</span> il <span class="highlight">${v}</span>, residente e domiciliato/a in <span class="highlight">${b}</span> - <span class="highlight">${E}</span> <span class="highlight">${T}</span> (<span class="highlight">${R}</span>) e con codice fiscale <span class="highlight">${S}</span>.</p>
        
        <p><strong>Riferimenti:</strong><br>
        telefono <span class="highlight">${o.telefonoRichiedente||"N/A"}</span> ‚Äì e-mail <span class="highlight">${o.emailRichiedente}</span></p>
        
        <p class="breviter">(breviter Il Cliente)</p>
    </div>
    
    <div class="premises">
        <p><strong>premesso che</strong></p>
        <ul>
            <li>Medica GB eroga servizi di assistenza domiciliare con tecnologie innovative, servizi di diagnostica a domicilio, esami strumentali, telemedicina, teleassistenza, telemonitoraggio e riabilitazione a domicilio.</li>
            <li>Medica GB si avvale della consulenza di Medici, Terapisti, Infermieri e Operatori Socio Sanitari per erogare i servizi sopra descritti;</li>
        </ul>
        <p><strong>Tanto premesso,</strong></p>
        <p style="text-align: center; font-weight: bold;">si conviene e stabilisce quanto segue</p>
    </div>
    
    <h2>Premessa</h2>
    <p>La premessa che precede costituisce parte integrante del presente Contratto.</p>
    
    <h2>Oggetto del Contratto</h2>
    <p>L'oggetto del presente Contratto √® l'erogazione del Servizio <span class="highlight">${e}</span> mediante l'utilizzo del Dispositivo <span class="highlight">${i}</span> e con il supporto del Piano <span class="highlight">${a}</span>.</p>
    
    <p>Le funzioni del dispositivo <span class="highlight">${i}</span> sono le seguenti:</p>
    
    <div class="feature-list">
        <p><strong>Comunicazione vocale bidirezionale:</strong> √® possibile configurare sulla Piattaforma i contatti dei familiari oltre a quelli della Centrale Operativa ove prevista; dopo l'invio dell'allarme i familiari e/o la Centrale Operativa (piano avanzato) ricevono una chiamata dal dispositivo e possono parlare con l'assistito; in qualsiasi momento i familiari e/o la Centrale Operativa (piano avanzato) possono contattare l'assistito tramite il dispositivo.</p>
        
        <p><strong>Rilevatore automatico di caduta:</strong> effettua una chiamata vocale di allarme, in caso di caduta, ai Care Givers e Famigliari (Piano Base) e alla Centrale Operativa (Piano Avanzato) e invia una notifica tramite sms ai familiari e, nel piano avanzato anche alla Centrale Operativa. Nell'sms arriver√† sia il link da cliccare per individuare la posizione dell'assistito (geolocalizzazione) che i valori dei parametri fisiologici che √® stato possibile rilevare.</p>
        
        <p><strong>Posizione GPS e GPS-assistito:</strong> consente di localizzare l'assistito quando viene inviato l'allarme. √à inoltre possibile impostare una cosiddetta area sicura per l'assistito (geo-fencing).</p>
        
        <p><strong>Misurazioni della frequenza cardiaca e della saturazione di ossigeno:</strong> √® possibile impostare una notifica che arrivi ai familiari e/o Centrale Operativa (ove prevista) tramite APP quando i valori rilevati vanno oltre le soglie programmate (comunicate dal proprio Medico di Base).</p>
        
        <p><strong>Pulsante SOS:</strong> premendo il pulsante SOS per circa 3 secondi √® possibile effettuare una chiamata vocale ai care giver / famigliari (piano base) o alla Centrale Operativa (piano avanzato) e inviare una notifica di emergenza (geolocalizzata) ai familiari o alla Centrale Operativa stessa.</p>
        
        <p><strong>Assistenza vocale:</strong> informa l'assistito in relazione ai seguenti eventi: pressione pulsante SOS, attivazione dispositivo, messa in carica del dispositivo, segnalazione di batteria scarica, ecc.</p>
        
        <p><strong>Promemoria per l'assunzione dei farmaci:</strong> un messaggio ricorda l'orario in cui assumere i farmaci (aderenza terapeutica).</p>
    </div>
    
    <h2>Durata del Servizio</h2>
    <p>Il Servizio di TeleAssistenza <span class="highlight">${e}</span> ha una durata di 12 mesi a partire da <span class="highlight">${c}</span> fino al <span class="highlight">${d}</span>.</p>
    <p>Il Contratto sar√† prorogabile su richiesta scritta del Cliente e su accettazione di Medica GB.</p>
    
    <h2>Tariffa del Servizio</h2>
    <p>La tariffa annuale per il primo anno di attivazione del Servizio <span class="highlight">${e}</span> √® pari a Euro <span class="highlight">${s},00</span> + IVA 22% e include:</p>
    
    <ul>
        <li>Dispositivo <span class="highlight">${i}</span></li>
        <li>Configurazione del Dispositivo e del Processo di Comunicazione con la Centrale Operativa (ove previsto) e/o uno o pi√π familiari e Piattaforma Web e APP di TeleAssistenza per la durata di 12 mesi</li>
        <li>SIM per trasmissione dati e comunicazione vocale per la durata di 12 mesi</li>
        <li>Piano <span class="highlight">${a}</span></li>
    </ul>
    
    <p>Per i successivi anni (rinnovabili di anno in anno) la tariffa annuale per il Servizio <span class="highlight">${e}</span> sar√† pari a Euro <span class="highlight">${r},00</span> + IVA 22% con inclusi:</p>
    
    <ul>
        <li>Piattaforma Web e APP di TeleAssistenza per la durata di 12 mesi</li>
        <li>SIM per trasmissione dati e comunicazione vocale per la durata di 12 mesi</li>
        <li>Piano <span class="highlight">${a}</span></li>
    </ul>
    
    <h2>Metodo di pagamento</h2>
    <p>Medica GB emetter√† fattura anticipata di 12 mesi all'attivazione del Servizio e il Cliente proceder√† al pagamento a ricevimento della fattura stessa tramite bonifico bancario</p>
    
    <div class="payment-details">
        <p><strong>Intestato a:</strong> Medica GB S.r.l.</p>
        <p><strong>Causale:</strong> Servizio ${e} ${a} con Dispositivo ${i}</p>
        <p><strong>Banca Popolare di Milano - Iban:</strong> IT97L0503401727000000003519</p>
    </div>
    
    <h2>Riservatezza ed esclusiva</h2>
    <p>Il Cliente e Medica GB si impegnano reciprocamente a non divulgare o, comunque, non utilizzare, se non per motivi attinenti all'esercizio del presente contratto, tutte le informazioni di cui venissero a conoscenza nello svolgimento del Servizio.</p>
    <p>Il Cliente si impegna a contattare Medica GB per tutte le modifiche e proroghe del presente contratto.</p>
    
    <h2>Foro competente</h2>
    <p>Ogni eventuale contestazione o controversia che dovesse insorgere tra le parti in relazione all'interpretazione, alla validit√† ed esecuzione del presente contratto, sar√† definita alla cognizione esclusiva del Foro di Milano.</p>
    
    <div class="signature-section">
        <div>
            <p>Milano, l√¨ <span class="highlight">${l}</span></p>
        </div>
    </div>
    
    <div class="signature-section">
        <div class="signature-block">
            <p><strong>Medica GB S.r.l.</strong></p>
        </div>
        <div class="signature-block">
            <p><strong>Il Cliente</strong></p>
        </div>
    </div>
    
    <div class="footer">
        <p><strong>Medica GB S.r.l.</strong></p>
        <p>Corso Giuseppe Garibaldi, 34 ‚Äì 20121 Milano</p>
        <p>PEC: [email protected]</p>
        <p>E-mail: [email protected]</p>
        <p>Codice Fiscale e P.IVA: 12435130963 - REA: MI-2661409</p>
        <p>www.medicagb.it www.ecura.it</p>
    </div>
</body>
</html>
  `.trim()}async function Vg(o,t,e){var i;const a={success:!1,step:"notifica_info",emailsSent:[],errors:[]};try{console.log("üìß [WORKFLOW] STEP 1: Invio notifica nuovo lead a info@telemedcare.it"),console.log(`Lead: ${o.nomeRichiedente} ${o.cognomeRichiedente} - ${o.emailRichiedente}`);const s=new Ke(t),r=await Ao("email_notifica_info",e,t),l=new Date,c=o.vuoleContratto||!1,d=o.vuoleBrochure||!1,u=o.vuoleManuale||!1;let p="";c?p="Il cliente ha richiesto il CONTRATTO. Procedere con la preparazione e invio del contratto pre-compilato.":d||u?p="Il cliente ha richiesto solo DOCUMENTAZIONE INFORMATIVA. √à stata inviata automaticamente email con documenti.":p="Contattare il cliente entro 24 ore per verificare le sue esigenze e procedere con l'attivazione del servizio TeleMedCare.";const g={NOME_RICHIEDENTE:o.nomeRichiedente,COGNOME_RICHIEDENTE:o.cognomeRichiedente,EMAIL_RICHIEDENTE:o.emailRichiedente,TELEFONO_RICHIEDENTE:o.telefonoRichiedente||"Non fornito",CF_RICHIEDENTE:o.cfRichiedente||"Non fornito",INDIRIZZO_RICHIEDENTE:o.indirizzoRichiedente||"Non fornito",NOME_ASSISTITO:o.nomeAssistito||o.nomeRichiedente,COGNOME_ASSISTITO:o.cognomeAssistito||o.cognomeRichiedente,ETA_ASSISTITO:((i=o.etaAssistito)==null?void 0:i.toString())||"Non fornita",DATA_NASCITA_ASSISTITO:o.dataNascitaAssistito||"Non fornita",LUOGO_NASCITA_ASSISTITO:o.luogoNascitaAssistito||"Non fornito",CF_ASSISTITO:o.cfAssistito||"Non fornito",INDIRIZZO_ASSISTITO:o.indirizzoAssistito||"Non fornito",CONDIZIONI_SALUTE:o.condizioniSalute||o.note||"Non specificate",NOTE_AGGIUNTIVE:o.note||"Nessuna",PIANO_SERVIZIO:Yt(o.servizio||"PRO",o.pacchetto),SERVIZIO:o.servizio||"eCura PRO",PIANO:o.pacchetto||"BASE",PREZZO_PIANO:o.pacchetto==="BASE"?"‚Ç¨585,60":"‚Ç¨1.024,80",DATA_RICHIESTA:l.toLocaleDateString("it-IT",{timeZone:"Europe/Rome"}),ORA_RICHIESTA:l.toLocaleTimeString("it-IT",{timeZone:"Europe/Rome"}),TIMESTAMP_COMPLETO:l.toLocaleString("it-IT",{timeZone:"Europe/Rome"}),VERSIONE_SISTEMA:"TeleMedCare V12.0",VUOLE_CONTRATTO:c?"S√å":"NO",VUOLE_BROCHURE:d?"S√å":"NO",VUOLE_MANUALE:u?"S√å":"NO",VUOLE_CONTRATTO_TEXT:c?"‚úÖ SI":"‚ùå NO",VUOLE_CONTRATTO_COLOR:c?"#198754":"#dc3545",VUOLE_BROCHURE_TEXT:d?"‚úÖ SI":"‚ùå NO",VUOLE_BROCHURE_COLOR:d?"#198754":"#dc3545",VUOLE_MANUALE_TEXT:u?"‚úÖ SI":"‚ùå NO",VUOLE_MANUALE_COLOR:u?"#198754":"#dc3545",URGENZA:o.urgenzaRisposta||"NORMALE",AZIONE_SUGGERITA:p},m=Co(r,g),v=await s.sendEmail({to:t.EMAIL_TO_INFO||"info@telemedcare.it",from:"info@telemedcare.it",subject:`üÜï Nuovo Lead: ${o.nomeRichiedente} ${o.cognomeRichiedente} - ${o.pacchetto}`,html:m,text:`Nuovo lead ricevuto: ${o.nomeRichiedente} ${o.cognomeRichiedente}
Servizio: ${o.pacchetto}
Email: ${o.emailRichiedente}`});v.success?(a.success=!0,a.emailsSent.push("email_notifica_info -> info@telemedcare.it"),a.messageIds=[v.messageId],console.log(`‚úÖ [WORKFLOW] Email notifica inviata con successo: ${v.messageId}`)):(a.errors.push(`Errore invio email notifica: ${v.error}`),console.error("‚ùå [WORKFLOW] Errore invio email notifica:",v.error))}catch(s){a.errors.push(`Eccezione invio email notifica: ${s.message}`),console.error("‚ùå [WORKFLOW] Eccezione STEP 1:",s)}return a}async function Wg(o,t,e,a){const i={success:!1,step:"documenti_informativi",emailsSent:[],errors:[]};try{if(!await Ud(a,"lead_email_notifications_enabled"))return console.log("‚è≠Ô∏è [WORKFLOW] Email automatiche ai lead disabilitate - skip invio documenti informativi"),i.errors.push("Email automatiche ai lead disabilitate nelle impostazioni sistema"),i;console.log(`üìß [WORKFLOW] STEP 2A: Invio documenti informativi a ${o.emailRichiedente}`),console.log(`Richiesti: Brochure=${o.vuoleBrochure}, Manuale=${o.vuoleManuale}`);const r=new Ke(t),l=await Ao("email_documenti_informativi",a,t),c=o.servizio||"eCura",d=o.pacchetto==="BASE"||o.pacchetto==="base"?"BASE":"AVANZATO",u=c==="PREMIUM"||c==="premium"?"SiDLY Vital Care":"SiDLY Care PRO",p=t.PUBLIC_URL||t.PAGES_URL||"https://telemedcare-v12.pages.dev";console.log(`üåê [WORKFLOW] Using baseUrl: ${p}`);const m=`${p}/brochures/${c==="PREMIUM"||c==="premium"?"Medica-GB-SiDLY_Vital_Care_ITA-compresso.pdf":"Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf"}`,{missing:v,available:b}=jd(o),E=v.length>0;let T="";if(E){const B=`${p}/completa-dati?leadId=${o.id}`,j=30,N=new Date;N.setDate(N.getDate()+j);const D=N.toLocaleDateString("it-IT");T=`
<!-- SEZIONE COMPLETAMENTO DATI (lead incompleto) -->
<div class="warning-box">
    <h4>‚ö†Ô∏è Ultimi Dettagli Necessari</h4>
    <p>Per procedere con l'attivazione del servizio, abbiamo bisogno di alcuni dati aggiuntivi:</p>
    <ul style="margin: 15px 0; padding-left: 25px; line-height: 2;">
        ${v.map($=>`<li style="color: #856404; font-weight: 500;">${$}</li>`).join(`
        `)}
    </ul>
    <p style="margin: 20px 0 10px 0; font-weight: 500;">Clicchi sul pulsante qui sotto per completare i dati in soli 2 minuti:</p>
    <div style="text-align: center; margin: 25px 0;">
        <a href="${B}" 
           style="display: inline-block; 
                  background: linear-gradient(135deg, #0066CC 0%, #0099CC 100%); 
                  color: white; 
                  padding: 15px 40px; 
                  text-decoration: none; 
                  border-radius: 8px; 
                  font-size: 18px; 
                  font-weight: 600;
                  box-shadow: 0 4px 8px rgba(0,102,204,0.3);">
            üìù Completa i Dati Ora
        </a>
    </div>
    <p style="font-size: 13px; color: #856404; margin: 15px 0;">
        ‚è∞ Il link √® valido per ${j} giorni (scadenza: ${D})
    </p>
</div>
`}const R={NOME_CLIENTE:o.nomeRichiedente,COGNOME_CLIENTE:o.cognomeRichiedente,NOME_ASSISTITO:o.nomeAssistito||o.nomeRichiedente,COGNOME_ASSISTITO:o.cognomeAssistito||o.cognomeRichiedente,LEAD_ID:o.id,TIPO_SERVIZIO:o.pacchetto==="BASE"?"Base":"Avanzato",SERVIZIO:c,SERVIZI:c,PIANO:d,DISPOSITIVO:u,BROCHURE_URL:m,DATA_RICHIESTA:new Date().toLocaleDateString("it-IT"),PACCHETTO:o.pacchetto||"BASE",PREZZO_PIANO:o.pacchetto==="BASE"?"‚Ç¨480/anno":"‚Ç¨840/anno",PREZZO_SERVIZIO_PIANO:o.pacchetto==="BASE"?"‚Ç¨480/anno":"‚Ç¨840/anno",COMPLETION_SECTION:T},S=Co(l,R),C=[];try{const B=t.PUBLIC_URL||t.PAGES_URL||"https://telemedcare-v12.pages.dev";if(console.log(`üåê [WORKFLOW] Using baseUrl: ${B}`),o.vuoleBrochure){console.log(`üìÑ [WORKFLOW] Caricamento brochure per servizio: ${o.servizio||"DEFAULT"}`);const j=o.servizio||"DEFAULT",N=j.replace(/^eCura\s+/i,"").trim();console.log(`üìÑ [WORKFLOW] Servizio normalizzato: "${j}" ‚Üí "${N}"`);try{let D=null;if(N!=="DEFAULT"&&(N==="FAMILY"||N==="PRO"||N==="PREMIUM")&&(console.log(`üì• [WORKFLOW] Caricamento brochure specifica per ${N}`),D=await kg(N,B),D?console.log(`‚úÖ [WORKFLOW] Brochure ${N} caricata: ${(D.size/1024).toFixed(2)} KB`):console.warn(`‚ö†Ô∏è [WORKFLOW] Brochure ${N} non trovata, fallback su brochure generica`)),!D){console.log("üìÑ [WORKFLOW] Caricamento brochure generica eCura");const Y=`${B}/brochures/Brochure_eCura.pdf`,$=await fetch(Y);if($.ok){const O=await $.arrayBuffer(),x=new Uint8Array(O);let k="";const z=8192;for(let ae=0;ae<x.length;ae+=z){const te=x.subarray(ae,Math.min(ae+z,x.length));k+=String.fromCharCode.apply(null,Array.from(te))}D={filename:"Brochure_eCura.pdf",content:btoa(k),size:O.byteLength},console.log(`‚úÖ [WORKFLOW] Brochure generica caricata: ${(D.size/1024).toFixed(2)} KB`)}}D&&(C.push({filename:D.filename,content:D.content,contentType:"application/pdf"}),console.log("‚úÖ [WORKFLOW] Brochure aggiunta agli allegati"))}catch(D){console.error("‚ùå [WORKFLOW] Errore caricamento brochure:",D),console.error("‚ùå [WORKFLOW] Stack trace:",D.stack)}}if(o.vuoleManuale){console.log("üìÑ [WORKFLOW] Caricamento manuale da public/documents/");try{const j=`${B}/documents/Manuale_SiDLY.pdf`,N=await fetch(j);if(N.ok){const D=await N.arrayBuffer();console.log(`üì• [WORKFLOW] Manuale ArrayBuffer ricevuto: ${D.byteLength} bytes`);const Y=new Uint8Array(D);let $="";const O=8192;for(let k=0;k<Y.length;k+=O){const z=Y.subarray(k,Math.min(k+O,Y.length));$+=String.fromCharCode.apply(null,Array.from(z))}const x=btoa($);C.push({filename:"Manuale_SiDLY.pdf",content:x,contentType:"application/pdf"}),console.log(`‚úÖ [WORKFLOW] Manuale caricato: ${(D.byteLength/1024).toFixed(2)} KB`)}else console.warn(`‚ö†Ô∏è [WORKFLOW] Manuale non trovato: ${N.status}`)}catch(j){console.error("‚ùå [WORKFLOW] Errore caricamento manuale:",j)}}}catch(B){console.warn("‚ö†Ô∏è [WORKFLOW] Errore preparazione allegati:",B)}console.log(`üìÑ [WORKFLOW] Documenti richiesti: Brochure=${o.vuoleBrochure}, Manuale=${o.vuoleManuale}`),console.log(`üìÑ [WORKFLOW] Brochure URL: ${m}`),console.log("üìÑ [WORKFLOW] Link download inclusi nel template email");const M=await r.sendEmail({to:o.emailRichiedente,from:"info@telemedcare.it",subject:"üìö TeleMedCare - Documenti Informativi Richiesti",html:S});M.success?(i.success=!0,i.emailsSent.push(`email_documenti_informativi -> ${o.emailRichiedente}`),i.messageIds=[M.messageId],console.log(`‚úÖ [WORKFLOW] Email documenti inviata con successo: ${M.messageId}`)):(i.errors.push(`Errore invio email documenti: ${M.error}`),console.error("‚ùå [WORKFLOW] Errore invio email documenti:",M.error))}catch(s){i.errors.push(`Eccezione invio email documenti: ${s.message}`),console.error("‚ùå [WORKFLOW] Eccezione STEP 2A:",s)}return i}async function Gg(o,t,e,a,i){const s={success:!1,step:"invio_contratto",emailsSent:[],errors:[]};try{if(!await Ud(i,"lead_email_notifications_enabled"))return console.log("‚è≠Ô∏è [WORKFLOW] Email automatiche ai lead disabilitate - skip invio contratto"),s.errors.push("Email automatiche ai lead disabilitate nelle impostazioni sistema"),s;if(console.log(`üìß [WORKFLOW] STEP 2B: Invio contratto ${t.tipoServizio} a ${o.emailRichiedente}`),console.log(`üìä [CONTRATTO] DB disponibile: ${!!i}`),console.log(`üìä [CONTRATTO] Contract ID: ${t.contractId}`),console.log(`üìä [CONTRATTO] Lead ID: ${o.id}`),i)try{console.log("üìã [CONTRATTO] Generazione HTML contratto...");const C=await vv(o,t);console.log(`üìã [CONTRATTO] HTML generato (${C.length} chars)`),console.log("üíæ [CONTRATTO] Salvataggio nel DB..."),console.log("üíæ [CONTRATTO] DB type:",typeof i,i?"Available":"NULL");const M=t.tipoServizio==="AVANZATO"?70:40,B=12;console.log("üíæ [CONTRATTO] Dati da salvare:",{id:t.contractId,leadId:o.id,codice_contratto:t.contractCode,tipo_contratto:t.tipoServizio,servizio:t.servizio,piano:t.tipoServizio,prezzo_totale:t.prezzoBase});const j=await i.prepare(`
          INSERT INTO contracts (
            id, leadId, codice_contratto, tipo_contratto, 
            template_utilizzato, contenuto_html, 
            pdf_generated, pdf_url, email_sent, email_template_used,
            status, servizio, piano, 
            prezzo_mensile, durata_mesi, prezzo_totale, 
            data_invio, data_scadenza,
            created_at, updated_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(t.contractId,o.id,t.contractCode,t.tipoServizio,"template_contratto_firma_digitale",C,0,"",1,"email_invio_contratto","PENDING",t.servizio,t.tipoServizio,M,B,t.prezzoBase,new Date().toISOString(),new Date(Date.now()+720*60*60*1e3).toISOString(),new Date().toISOString(),new Date().toISOString()).run();console.log("‚úÖ [CONTRATTO] Insert result:",j),console.log(`‚úÖ [CONTRATTO] Salvato nel DB: ${t.contractId}`)}catch(C){console.error("‚ùå [CONTRATTO] Errore salvataggio DB:",C),console.error("‚ùå [CONTRATTO] Stack:",C==null?void 0:C.stack)}else console.warn("‚ö†Ô∏è  [CONTRATTO] DB non disponibile - contratto NON salvato!");const l=new Ke(e),c=await Ao("email_invio_contratto",i,e),d=t.servizio||o.servizio||"eCura PRO",u=t.tipoServizio||"BASE",p=d.includes("PREMIUM")||d.includes("premium")?"SiDLY Vital Care":"SiDLY Care PRO",g=(e==null?void 0:e.PUBLIC_URL)||"https://telemedcare-v12.pages.dev",m=d.replace(/^eCura\s+/i,"").trim().toUpperCase();let v="Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf";m==="PREMIUM"&&(v="Medica-GB-SiDLY_Vital_Care_ITA-compresso.pdf");const b=`${g}/brochures/${v}`,E={NOME_CLIENTE:o.nomeRichiedente,COGNOME_CLIENTE:o.cognomeRichiedente,PIANO_SERVIZIO:Yt(d.replace("eCura ",""),u),SERVIZIO:d,PIANO:u,DISPOSITIVO:p,PREZZO_PIANO:`‚Ç¨${t.prezzoBase.toFixed(2)}`,PREZZO_SERVIZIO_PIANO:`‚Ç¨${t.prezzoBase.toFixed(2)}/anno`,CODICE_CLIENTE:o.id,CODICE_CONTRATTO:t.contractCode,LINK_FIRMA:`${g}/contract-signature.html?contractId=${t.contractId}`,LINK_BROCHURE:b,DATA_INVIO:new Date().toLocaleDateString("it-IT")},T=Co(c,E),R=[];if(o.vuoleBrochure&&(e!=null&&e.ASSETS))try{console.log(`üìé [CONTRATTO] Caricamento brochure via ASSETS: ${b}`);const C=new URL(b),M=await e.ASSETS.fetch(C);if(M.ok){const B=await M.arrayBuffer(),j=(B.byteLength/1024).toFixed(2);console.log(`üì• [CONTRATTO] PDF caricato: ${j} KB`);const N=new Uint8Array(B),D=32768;let Y="";for(let x=0;x<N.length;x+=D){const k=N.slice(x,x+D);Y+=String.fromCharCode.apply(null,Array.from(k))}const $=btoa(Y),O=b.split("/").pop()||"Brochure_eCura.pdf";R.push({filename:O,content:$,contentType:"application/pdf"}),console.log(`‚úÖ [CONTRATTO] Brochure allegata: ${O} (${j} KB, ${$.length} chars base64)`)}else console.warn(`‚ö†Ô∏è [CONTRATTO] ASSETS non trova brochure: ${b} (status: ${M.status})`)}catch(C){console.error("‚ùå [CONTRATTO] Errore caricamento brochure:",C)}else o.vuoleBrochure&&!(e!=null&&e.ASSETS)&&console.warn("‚ö†Ô∏è [CONTRATTO] ASSETS binding non disponibile, brochure disponibile solo via link");console.log(`üìé [CONTRATTO] Link brochure nel template: ${b}`),o.vuoleManuale&&a.manuale&&console.log(`üìé [CONTRATTO] Link manuale disponibile: ${a.manuale}`);const S=await l.sendEmail({to:o.emailRichiedente,from:"info@telemedcare.it",subject:`üìÑ TeleMedCare - Il Tuo Contratto ${t.tipoServizio}`,html:T,attachments:R});S.success?(s.success=!0,s.emailsSent.push(`email_invio_contratto -> ${o.emailRichiedente}`),s.messageIds=[S.messageId],console.log(`‚úÖ [WORKFLOW] Email contratto inviata con successo: ${S.messageId}`)):(s.errors.push(`Errore invio email contratto: ${S.error}`),console.error("‚ùå [WORKFLOW] Errore invio email contratto:",S.error))}catch(r){s.errors.push(`Eccezione invio email contratto: ${r.message}`),console.error("‚ùå [WORKFLOW] Eccezione STEP 2B:",r)}return s}async function Kg(o,t,e,a){const i={success:!1,step:"invio_proforma",emailsSent:[],errors:[]};try{console.log(`üìß [WORKFLOW] STEP 3: Invio proforma ${t.numeroProforma} a ${o.emailRichiedente}`);const s=new Ke(e),r=await Ao("email_invio_proforma",a,e),l={NOME_CLIENTE:o.nomeRichiedente,COGNOME_CLIENTE:o.cognomeRichiedente,PIANO_SERVIZIO:Yt(t.servizio||"PRO",t.tipoServizio),NUMERO_PROFORMA:t.numeroProforma,IMPORTO_TOTALE:`‚Ç¨${t.prezzoIvaInclusa.toFixed(2)}`,SCADENZA_PAGAMENTO:new Date(t.dataScadenza).toLocaleDateString("it-IT"),IBAN:"IT02X0306909606100000061231",CAUSALE:`Proforma ${t.numeroProforma} - TeleMedCare`,LINK_PAGAMENTO:`${e.PUBLIC_URL||"https://telemedcare.it"}/pagamento?proformaId=${t.proformaId}`,DATA_INVIO:new Date().toLocaleDateString("it-IT")},c=Co(r,l),d=[{filename:`Proforma_${t.numeroProforma}.pdf`,path:t.proformaPdfUrl}],u=await s.sendEmail({to:o.emailRichiedente,from:"info@telemedcare.it",subject:`üí∞ TeleMedCare - Fattura Proforma ${t.numeroProforma}`,html:c,attachments:d});u.success?(i.success=!0,i.emailsSent.push(`email_invio_proforma -> ${o.emailRichiedente}`),i.messageIds=[u.messageId],console.log(`‚úÖ [WORKFLOW] Email proforma inviata con successo: ${u.messageId}`)):(i.errors.push(`Errore invio email proforma: ${u.error}`),console.error("‚ùå [WORKFLOW] Errore invio email proforma:",u.error))}catch(s){i.errors.push(`Eccezione invio email proforma: ${s.message}`),console.error("‚ùå [WORKFLOW] Eccezione STEP 3:",s)}return i}async function qg(o,t,e){const a={success:!1,step:"email_benvenuto",emailsSent:[],errors:[]};try{console.log(`üìß [WORKFLOW] STEP 4: Invio email benvenuto a ${o.emailRichiedente}`);const i=new Ke(t),s=await Ao("email_benvenuto",e,t),r={NOME_CLIENTE:o.nomeRichiedente,COGNOME_CLIENTE:o.cognomeRichiedente,PIANO_SERVIZIO:Yt(o.servizio||"PRO",o.pacchetto),CODICE_CLIENTE:o.codiceCliente,DATA_ATTIVAZIONE:new Date().toLocaleDateString("it-IT"),LINK_CONFIGURAZIONE:`${t.PUBLIC_URL||"https://telemedcare.it"}/configurazione?clientId=${o.codiceCliente}`,PREZZO_PIANO:o.pacchetto==="BASE"?"‚Ç¨490/anno":"‚Ç¨840/anno"},l=Co(s,r),c=await i.sendEmail({to:o.emailRichiedente,from:"info@telemedcare.it",subject:`üéâ Benvenuto/a in TeleMedCare, ${o.nomeRichiedente}!`,html:l});c.success?(a.success=!0,a.emailsSent.push(`email_benvenuto -> ${o.emailRichiedente}`),a.messageIds=[c.messageId],console.log(`‚úÖ [WORKFLOW] Email benvenuto inviata con successo: ${c.messageId}`)):(a.errors.push(`Errore invio email benvenuto: ${c.error}`),console.error("‚ùå [WORKFLOW] Errore invio email benvenuto:",c.error))}catch(i){a.errors.push(`Eccezione invio email benvenuto: ${i.message}`),console.error("‚ùå [WORKFLOW] Eccezione STEP 4:",i)}return a}async function Zg(o,t,e,a){const i={success:!1,step:"email_configurazione_info",emailsSent:[],errors:[]};try{console.log("üìß [WORKFLOW] STEP 5: Invio configurazione cliente a info@telemedcare.it");const s=new Ke(e),r=await Ao("email_configurazione",a,e),l={NOME_CLIENTE:o.nomeRichiedente,COGNOME_CLIENTE:o.cognomeRichiedente,CODICE_CLIENTE:o.codiceCliente,EMAIL_CLIENTE:o.emailRichiedente,TELEFONO_CLIENTE:o.telefonoRichiedente||"Non fornito",PIANO_SERVIZIO:o.pacchetto,DATA_COMPILAZIONE:new Date().toLocaleDateString("it-IT"),DATI_CONFIGURAZIONE:JSON.stringify(t,null,2)},c=Co(r,l),d=await s.sendEmail({to:e.EMAIL_TO_INFO||"info@telemedcare.it",from:"info@telemedcare.it",subject:`üìã Nuova Configurazione Cliente: ${o.nomeRichiedente} ${o.cognomeRichiedente}`,html:c});d.success?(i.success=!0,i.emailsSent.push("email_configurazione -> info@telemedcare.it"),i.messageIds=[d.messageId],console.log(`‚úÖ [WORKFLOW] Email configurazione inviata con successo: ${d.messageId}`)):(i.errors.push(`Errore invio email configurazione: ${d.error}`),console.error("‚ùå [WORKFLOW] Errore invio email configurazione:",d.error))}catch(s){i.errors.push(`Eccezione invio email configurazione: ${s.message}`),console.error("‚ùå [WORKFLOW] Eccezione STEP 5:",s)}return i}async function Yg(o,t,e,a){const i={success:!1,step:"email_conferma_attivazione",emailsSent:[],errors:[]};try{console.log(`üìß [WORKFLOW] STEP 6: Invio email conferma attivazione a ${o.emailRichiedente}`);const s=new Ke(e),r=await Ao("email_conferma_attivazione",a,e),l={NOME_CLIENTE:o.nomeRichiedente,COGNOME_CLIENTE:o.cognomeRichiedente,CODICE_CLIENTE:o.codiceCliente,PIANO_SERVIZIO:Yt(o.servizio||"PRO",o.pacchetto),MODELLO_DISPOSITIVO:t.modello||"SiDLY Care Pro V11.0",IMEI_DISPOSITIVO:t.imei,NUMERO_SIM:t.numeroSim||"Da configurare",DATA_ATTIVAZIONE:new Date(t.dataAssociazione).toLocaleDateString("it-IT"),TELEFONO_ASSISTENZA:"+39 02 1234567"},c=Co(r,l),d=await s.sendEmail({to:o.emailRichiedente,from:"info@telemedcare.it",subject:"‚úÖ TeleMedCare - Servizio Attivato!",html:c});d.success?(i.success=!0,i.emailsSent.push(`email_conferma -> ${o.emailRichiedente}`),i.messageIds=[d.messageId],console.log(`‚úÖ [WORKFLOW] Email conferma attivazione inviata con successo: ${d.messageId}`)):(i.errors.push(`Errore invio email conferma: ${d.error}`),console.error("‚ùå [WORKFLOW] Errore invio email conferma:",d.error))}catch(s){i.errors.push(`Eccezione invio email conferma: ${s.message}`),console.error("‚ùå [WORKFLOW] Eccezione STEP 6:",s)}return i}const _r={inviaEmailNotificaInfo:Vg,inviaEmailDocumentiInformativi:Wg,inviaEmailContratto:Gg,inviaEmailProforma:Kg,inviaEmailBenvenuto:qg,inviaEmailConfigurazione:Zg,inviaEmailConfermaAttivazione:Yg},Sp=Object.freeze(Object.defineProperty({__proto__:null,default:_r,inviaEmailBenvenuto:qg,inviaEmailConfermaAttivazione:Yg,inviaEmailConfigurazione:Zg,inviaEmailContratto:Gg,inviaEmailDocumentiInformativi:Wg,inviaEmailNotificaInfo:Vg,inviaEmailProforma:Kg},Symbol.toStringTag,{value:"Module"}));function mm(){const o=Date.now(),t=Math.floor(Math.random()*1e4).toString().padStart(4,"0");return`PAY${o}${t}`}async function Ev(o,t){try{const e=mm();console.log(`üí≥ [PAYMENT] Registrazione pagamento ${e} per proforma ${t.proformaId}`),console.log("üí≥ [PAYMENT DEBUG] Full paymentData:",JSON.stringify(t));const a=e,i=t.proformaId,s=t.contractId,r=t.leadId,l=t.importo,c="EUR",d=t.metodoPagamento,u=t.transactionId||null,p="PENDING",g={field1_id:{value:a,type:typeof a,isUndefined:a===void 0},field2_proforma_id:{value:i,type:typeof i,isUndefined:i===void 0},field3_contract_id:{value:s,type:typeof s,isUndefined:s===void 0},field4_leadId:{value:r,type:typeof r,isUndefined:r===void 0},field5_importo:{value:l,type:typeof l,isUndefined:l===void 0},field6_valuta:{value:c,type:typeof c,isUndefined:c===void 0},field7_metodo:{value:d,type:typeof d,isUndefined:d===void 0},field8_transaction_id:{value:u,type:typeof u,isUndefined:u===void 0},field9_status:{value:p,type:typeof p,isUndefined:p===void 0}};if(console.log("üí≥ [PAYMENT DEBUG] All fields:",JSON.stringify(g,null,2)),a===void 0)return{success:!1,error:"Field 1 (id) is undefined",debug:g};if(i===void 0)return{success:!1,error:"Field 2 (proforma_id) is undefined",debug:g};if(s===void 0)return{success:!1,error:"Field 3 (contract_id) is undefined",debug:g};if(r===void 0)return{success:!1,error:"Field 4 (leadId) is undefined",debug:g};if(l===void 0)return{success:!1,error:"Field 5 (importo) is undefined",debug:g};if(d===void 0)return{success:!1,error:"Field 7 (metodo) is undefined",debug:g};const m=await o.prepare(`
      INSERT INTO payments (
        id,
        proforma_id,
        contract_id,
        leadId,
        importo,
        valuta,
        metodo_pagamento,
        transaction_id,
        status,
        data_pagamento
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
    `).bind(a,i,s,r,l,c,d,u,p).run();return console.log("‚úÖ [PAYMENT] INSERT successful:",m),console.log(`‚úÖ [PAYMENT] Pagamento ${e} registrato con successo`),{success:!0,paymentId:e}}catch(e){console.error("‚ùå [PAYMENT] Errore registrazione pagamento:",e);const a=mm(),i=t.proformaId,s=t.contractId,r=t.leadId,l=t.importo,c="EUR",d=t.metodoPagamento,u=t.transactionId||null,p="PENDING",g={field1_id:{value:a,type:typeof a,isUndefined:a===void 0},field2_proforma_id:{value:i,type:typeof i,isUndefined:i===void 0},field3_contract_id:{value:s,type:typeof s,isUndefined:s===void 0},field4_leadId:{value:r,type:typeof r,isUndefined:r===void 0},field5_importo:{value:l,type:typeof l,isUndefined:l===void 0},field6_valuta:{value:c,type:typeof c,isUndefined:c===void 0},field7_metodo:{value:d,type:typeof d,isUndefined:d===void 0},field8_transaction_id:{value:u,type:typeof u,isUndefined:u===void 0},field9_status:{value:p,type:typeof p,isUndefined:p===void 0},originalError:e.message};return{success:!1,error:e.message,debug:g}}}async function Xg(o,t){try{console.log(`‚úÖ [PAYMENT] Conferma pagamento ${t}`),await o.prepare(`
      UPDATE payments 
      SET status = 'COMPLETED', 
          data_conferma = datetime('now')
      WHERE id = ?
    `).bind(t).run();const e=await o.prepare(`
      SELECT * FROM payments WHERE id = ?
    `).bind(t).first();return e&&(await o.prepare(`
        UPDATE proforma 
        SET status = 'PAID', updated_at = datetime('now')
        WHERE id = ?
      `).bind(e.proforma_id).run(),await o.prepare(`
        UPDATE leads 
        SET status = 'CONVERTED', updated_at = datetime('now')
        WHERE id = ?
      `).bind(e.leadId).run(),console.log("‚úÖ [PAYMENT] Pagamento confermato e status aggiornati")),{success:!0,paymentId:t}}catch(e){return console.error("‚ùå [PAYMENT] Errore conferma pagamento:",e),{success:!1,error:e.message}}}async function bv(o,t,e,a){try{console.log(`üí≥ [STRIPE] Creazione Payment Intent per ‚Ç¨${(t/100).toFixed(2)}`);const i=o.STRIPE_SECRET_KEY;if(!i)return console.warn("‚ö†Ô∏è [STRIPE] API Key non configurata, modalit√† test"),{success:!0,stripeClientSecret:`test_client_secret_${Date.now()}`,paymentId:`test_pi_${Date.now()}`};const s=await fetch("https://api.stripe.com/v1/payment_intents",{method:"POST",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({amount:t.toString(),currency:"eur",description:e,"metadata[proforma_id]":a.proformaId||"","metadata[contract_id]":a.contractId||"","metadata[lead_id]":a.leadId||""})});if(!s.ok){const l=await s.text();throw new Error(`Stripe API error: ${l}`)}const r=await s.json();return console.log(`‚úÖ [STRIPE] Payment Intent creato: ${r.id}`),{success:!0,stripeClientSecret:r.client_secret,paymentId:r.id}}catch(i){return console.error("‚ùå [STRIPE] Errore creazione Payment Intent:",i),{success:!1,error:i.message}}}async function yv(o,t){try{if(console.log(`üîî [STRIPE WEBHOOK] Evento ricevuto: ${t.type}`),t.type==="payment_intent.succeeded"){const e=t.data.object,a=await o.prepare(`
        SELECT * FROM payments 
        WHERE stripe_payment_intent_id = ?
      `).bind(e.id).first();if(a)return await Xg(o,a.id),console.log(`‚úÖ [STRIPE WEBHOOK] Pagamento ${a.id} confermato automaticamente`),{success:!0,paymentId:a.id};console.warn(`‚ö†Ô∏è [STRIPE WEBHOOK] Pagamento non trovato per PaymentIntent ${e.id}`)}return{success:!0}}catch(e){return console.error("‚ùå [STRIPE WEBHOOK] Errore gestione webhook:",e),{success:!1,error:e.message}}}async function wv(o,t){try{const e=await o.prepare(`
      SELECT COUNT(*) as count 
      FROM payments 
      WHERE proforma_id = ? AND status = 'COMPLETED'
    `).bind(t).first();return(e==null?void 0:e.count)>0}catch(e){return console.error("‚ùå [PAYMENT] Errore verifica pagamento:",e),!1}}async function Tv(o,t){try{return await o.prepare(`
      SELECT * FROM payments WHERE id = ?
    `).bind(t).first()}catch(e){return console.error("‚ùå [PAYMENT] Errore recupero dettagli pagamento:",e),null}}const gm={registerPayment:Ev,confirmPayment:Xg,createStripePaymentIntent:bv,handleStripeWebhook:yv,isProformaPaid:wv,getPaymentDetails:Tv};async function xv(o,t){try{console.log(`üìã [CONFIG] Salvataggio configurazione per cliente ${t.codiceCliente}`);const e=JSON.stringify(t),a=t.leadId,i=e,s="SUBMITTED";if(console.log("üìã [CONFIG DEBUG] Field 1 (leadId):",a,typeof a),console.log("üìã [CONFIG DEBUG] Field 2 (config_data):",i==null?void 0:i.substring(0,50),typeof i),console.log("üìã [CONFIG DEBUG] Field 3 (status):",s,typeof s),a===void 0)throw new Error("Field 1 (leadId) is undefined");if(i===void 0)throw new Error("Field 2 (configuration_data) is undefined");const r=await o.prepare(`
      INSERT INTO configurations (
        leadId,
        configuration_data,
        status,
        created_at
      ) VALUES (?, ?, ?, datetime('now'))
    `).bind(a,i,s).run(),l=String(r.meta.last_row_id);return await o.prepare(`
      UPDATE leads 
      SET status = 'CONFIGURED', updated_at = datetime('now')
      WHERE id = ?
    `).bind(t.leadId).run(),console.log("‚úÖ [CONFIG] Configurazione salvata con successo"),{success:!0,configurationId:l}}catch(e){console.error("‚ùå [CONFIG] Errore salvataggio configurazione:",e);const a=t.leadId,i=JSON.stringify(t),s="SUBMITTED",r={field1_leadId:{value:a,type:typeof a,isUndefined:a===void 0},field2_config_data:{value:i==null?void 0:i.substring(0,50),type:typeof i,isUndefined:i===void 0},field3_status:{value:s,type:typeof s,isUndefined:s===void 0},originalError:e.message};return{success:!1,error:e.message,debug:r}}}async function Iv(o,t){try{const e=await o.prepare(`
      SELECT configuration_data 
      FROM configurations 
      WHERE leadId = ?
      ORDER BY created_at DESC
      LIMIT 1
    `).bind(t).first();return e&&e.configuration_data?JSON.parse(e.configuration_data):null}catch(e){return console.error("‚ùå [CONFIG] Errore recupero configurazione:",e),null}}async function Sv(o,t){try{const e=await o.prepare(`
      SELECT COUNT(*) as count 
      FROM configurations 
      WHERE leadId = ? AND status = 'SUBMITTED'
    `).bind(t).first();return(e==null?void 0:e.count)>0}catch(e){return console.error("‚ùå [CONFIG] Errore verifica configurazione:",e),!1}}async function Av(o,t,e){try{return await o.prepare(`
      UPDATE configurations 
      SET status = ?, updated_at = datetime('now')
      WHERE id = ?
    `).bind(e,t).run(),console.log(`‚úÖ [CONFIG] Status configurazione ${t} aggiornato a ${e}`),{success:!0}}catch(a){return console.error("‚ùå [CONFIG] Errore aggiornamento status:",a),{success:!1,error:a.message}}}const Cv={saveConfiguration:xv,getConfiguration:Iv,hasCompletedConfiguration:Sv,updateConfigurationStatus:Av};/**
 * @license
 * Copyright 2025 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */globalThis.Buffer=pg;var Eu=function(o,t){return Eu=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,a){e.__proto__=a}||function(e,a){for(var i in a)Object.prototype.hasOwnProperty.call(a,i)&&(e[i]=a[i])},Eu(o,t)};function Ro(o,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");Eu(o,t);function e(){this.constructor=o}o.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}function Rv(o,t,e,a){function i(s){return s instanceof e?s:new e(function(r){r(s)})}return new(e||(e=Promise))(function(s,r){function l(u){try{d(a.next(u))}catch(p){r(p)}}function c(u){try{d(a.throw(u))}catch(p){r(p)}}function d(u){u.done?s(u.value):i(u.value).then(l,c)}d((a=a.apply(o,[])).next())})}function Jg(o,t){var e={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},a,i,s,r;return r={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(r[Symbol.iterator]=function(){return this}),r;function l(d){return function(u){return c([d,u])}}function c(d){if(a)throw new TypeError("Generator is already executing.");for(;r&&(r=0,d[0]&&(e=0)),e;)try{if(a=1,i&&(s=d[0]&2?i.return:d[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,d[1])).done)return s;switch(i=0,s&&(d=[d[0]&2,s.value]),d[0]){case 0:case 1:s=d;break;case 4:return e.label++,{value:d[1],done:!1};case 5:e.label++,i=d[1],d=[0];continue;case 7:d=e.ops.pop(),e.trys.pop();continue;default:if(s=e.trys,!(s=s.length>0&&s[s.length-1])&&(d[0]===6||d[0]===2)){e=0;continue}if(d[0]===3&&(!s||d[1]>s[0]&&d[1]<s[3])){e.label=d[1];break}if(d[0]===6&&e.label<s[1]){e.label=s[1],s=d;break}if(s&&e.label<s[2]){e.label=s[2],e.ops.push(d);break}s[2]&&e.ops.pop(),e.trys.pop();continue}d=t.call(o,e)}catch(u){d=[6,u],i=0}finally{a=s=0}if(d[0]&5)throw d[1];return{value:d[0]?d[1]:void 0,done:!0}}}function Or(o){var t=typeof Symbol=="function"&&Symbol.iterator,e=t&&o[t],a=0;if(e)return e.call(o);if(o&&typeof o.length=="number")return{next:function(){return o&&a>=o.length&&(o=void 0),{value:o&&o[a++],done:!o}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function Ui(o,t){var e=typeof Symbol=="function"&&o[Symbol.iterator];if(!e)return o;var a=e.call(o),i,s=[],r;try{for(;(t===void 0||t-- >0)&&!(i=a.next()).done;)s.push(i.value)}catch(l){r={error:l}}finally{try{i&&!i.done&&(e=a.return)&&e.call(a)}finally{if(r)throw r.error}}return s}function Dr(o,t,e){if(arguments.length===2)for(var a=0,i=t.length,s;a<i;a++)(s||!(a in t))&&(s||(s=Array.prototype.slice.call(t,0,a)),s[a]=t[a]);return o.concat(s||Array.prototype.slice.call(t))}function ss(o){return this instanceof ss?(this.v=o,this):new ss(o)}function _v(o,t,e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var a=e.apply(o,t||[]),i,s=[];return i={},r("next"),r("throw"),r("return"),i[Symbol.asyncIterator]=function(){return this},i;function r(g){a[g]&&(i[g]=function(m){return new Promise(function(v,b){s.push([g,m,v,b])>1||l(g,m)})})}function l(g,m){try{c(a[g](m))}catch(v){p(s[0][3],v)}}function c(g){g.value instanceof ss?Promise.resolve(g.value.v).then(d,u):p(s[0][2],g)}function d(g){l("next",g)}function u(g){l("throw",g)}function p(g,m){g(m),s.shift(),s.length&&l(s[0][0],s[0][1])}}function Ov(o){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=o[Symbol.asyncIterator],e;return t?t.call(o):(o=typeof Or=="function"?Or(o):o[Symbol.iterator](),e={},a("next"),a("throw"),a("return"),e[Symbol.asyncIterator]=function(){return this},e);function a(s){e[s]=o[s]&&function(r){return new Promise(function(l,c){r=o[s](r),i(l,c,r.done,r.value)})}}function i(s,r,l,c){Promise.resolve(c).then(function(d){s({value:d,done:l})},r)}}function he(o){return typeof o=="function"}function Ap(o){var t=function(a){Error.call(a),a.stack=new Error().stack},e=o(t);return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,e}var eu=Ap(function(o){return function(e){o(this),this.message=e?e.length+` errors occurred during unsubscription:
`+e.map(function(a,i){return i+1+") "+a.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=e}});function sd(o,t){if(o){var e=o.indexOf(t);0<=e&&o.splice(e,1)}}var bc=(function(){function o(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}return o.prototype.unsubscribe=function(){var t,e,a,i,s;if(!this.closed){this.closed=!0;var r=this._parentage;if(r)if(this._parentage=null,Array.isArray(r))try{for(var l=Or(r),c=l.next();!c.done;c=l.next()){var d=c.value;d.remove(this)}}catch(b){t={error:b}}finally{try{c&&!c.done&&(e=l.return)&&e.call(l)}finally{if(t)throw t.error}}else r.remove(this);var u=this.initialTeardown;if(he(u))try{u()}catch(b){s=b instanceof eu?b.errors:[b]}var p=this._finalizers;if(p){this._finalizers=null;try{for(var g=Or(p),m=g.next();!m.done;m=g.next()){var v=m.value;try{hm(v)}catch(b){s=s??[],b instanceof eu?s=Dr(Dr([],Ui(s)),Ui(b.errors)):s.push(b)}}}catch(b){a={error:b}}finally{try{m&&!m.done&&(i=g.return)&&i.call(g)}finally{if(a)throw a.error}}}if(s)throw new eu(s)}},o.prototype.add=function(t){var e;if(t&&t!==this)if(this.closed)hm(t);else{if(t instanceof o){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=(e=this._finalizers)!==null&&e!==void 0?e:[]).push(t)}},o.prototype._hasParent=function(t){var e=this._parentage;return e===t||Array.isArray(e)&&e.includes(t)},o.prototype._addParent=function(t){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(t),e):e?[e,t]:t},o.prototype._removeParent=function(t){var e=this._parentage;e===t?this._parentage=null:Array.isArray(e)&&sd(e,t)},o.prototype.remove=function(t){var e=this._finalizers;e&&sd(e,t),t instanceof o&&t._removeParent(this)},o.EMPTY=(function(){var t=new o;return t.closed=!0,t})(),o})(),Qg=bc.EMPTY;function eh(o){return o instanceof bc||o&&"closed"in o&&he(o.remove)&&he(o.add)&&he(o.unsubscribe)}function hm(o){he(o)?o():o.unsubscribe()}var Dv={Promise:void 0},Mv={setTimeout:function(o,t){for(var e=[],a=2;a<arguments.length;a++)e[a-2]=arguments[a];return setTimeout.apply(void 0,Dr([o,t],Ui(e)))},clearTimeout:function(o){return clearTimeout(o)},delegate:void 0};function th(o){Mv.setTimeout(function(){throw o})}function Mr(){}function Fc(o){o()}var Cp=(function(o){Ro(t,o);function t(e){var a=o.call(this)||this;return a.isStopped=!1,e?(a.destination=e,eh(e)&&e.add(a)):a.destination=Nv,a}return t.create=function(e,a,i){return new rd(e,a,i)},t.prototype.next=function(e){this.isStopped||this._next(e)},t.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,o.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t})(bc),zv=(function(){function o(t){this.partialObserver=t}return o.prototype.next=function(t){var e=this.partialObserver;if(e.next)try{e.next(t)}catch(a){Rc(a)}},o.prototype.error=function(t){var e=this.partialObserver;if(e.error)try{e.error(t)}catch(a){Rc(a)}else Rc(t)},o.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(e){Rc(e)}},o})(),rd=(function(o){Ro(t,o);function t(e,a,i){var s=o.call(this)||this,r;return he(e)||!e?r={next:e??void 0,error:a??void 0,complete:i??void 0}:r=e,s.destination=new zv(r),s}return t})(Cp);function Rc(o){th(o)}function Lv(o){throw o}var Nv={closed:!0,next:Mr,error:Lv,complete:Mr},Rp=(function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"})();function Ia(o){return o}function Pv(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];return oh(o)}function oh(o){return o.length===0?Ia:o.length===1?o[0]:function(e){return o.reduce(function(a,i){return i(a)},e)}}var Le=(function(){function o(t){t&&(this._subscribe=t)}return o.prototype.lift=function(t){var e=new o;return e.source=this,e.operator=t,e},o.prototype.subscribe=function(t,e,a){var i=this,s=Bv(t)?t:new rd(t,e,a);return Fc(function(){var r=i,l=r.operator,c=r.source;s.add(l?l.call(s,c):c?i._subscribe(s):i._trySubscribe(s))}),s},o.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){t.error(e)}},o.prototype.forEach=function(t,e){var a=this;return e=fm(e),new e(function(i,s){var r=new rd({next:function(l){try{t(l)}catch(c){s(c),r.unsubscribe()}},error:s,complete:i});a.subscribe(r)})},o.prototype._subscribe=function(t){var e;return(e=this.source)===null||e===void 0?void 0:e.subscribe(t)},o.prototype[Rp]=function(){return this},o.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return oh(t)(this)},o.prototype.toPromise=function(t){var e=this;return t=fm(t),new t(function(a,i){var s;e.subscribe(function(r){return s=r},function(r){return i(r)},function(){return a(s)})})},o.create=function(t){return new o(t)},o})();function fm(o){var t;return(t=o??Dv.Promise)!==null&&t!==void 0?t:Promise}function kv(o){return o&&he(o.next)&&he(o.error)&&he(o.complete)}function Bv(o){return o&&o instanceof Cp||kv(o)&&eh(o)}function Fv(o){return he(o==null?void 0:o.lift)}function je(o){return function(t){if(Fv(t))return t.lift(function(e){try{return o(e,this)}catch(a){this.error(a)}});throw new TypeError("Unable to lift unknown Observable type")}}function Ue(o,t,e,a,i){return new $v(o,t,e,a,i)}var $v=(function(o){Ro(t,o);function t(e,a,i,s,r,l){var c=o.call(this,e)||this;return c.onFinalize=r,c.shouldUnsubscribe=l,c._next=a?function(d){try{a(d)}catch(u){e.error(u)}}:o.prototype._next,c._error=s?function(d){try{s(d)}catch(u){e.error(u)}finally{this.unsubscribe()}}:o.prototype._error,c._complete=i?function(){try{i()}catch(d){e.error(d)}finally{this.unsubscribe()}}:o.prototype._complete,c}return t.prototype.unsubscribe=function(){var e;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var a=this.closed;o.prototype.unsubscribe.call(this),!a&&((e=this.onFinalize)===null||e===void 0||e.call(this))}},t})(Cp),Uv=Ap(function(o){return function(){o(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),ah=(function(o){Ro(t,o);function t(){var e=o.call(this)||this;return e.closed=!1,e.currentObservers=null,e.observers=[],e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return t.prototype.lift=function(e){var a=new vm(this,this);return a.operator=e,a},t.prototype._throwIfClosed=function(){if(this.closed)throw new Uv},t.prototype.next=function(e){var a=this;Fc(function(){var i,s;if(a._throwIfClosed(),!a.isStopped){a.currentObservers||(a.currentObservers=Array.from(a.observers));try{for(var r=Or(a.currentObservers),l=r.next();!l.done;l=r.next()){var c=l.value;c.next(e)}}catch(d){i={error:d}}finally{try{l&&!l.done&&(s=r.return)&&s.call(r)}finally{if(i)throw i.error}}}})},t.prototype.error=function(e){var a=this;Fc(function(){if(a._throwIfClosed(),!a.isStopped){a.hasError=a.isStopped=!0,a.thrownError=e;for(var i=a.observers;i.length;)i.shift().error(e)}})},t.prototype.complete=function(){var e=this;Fc(function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var a=e.observers;a.length;)a.shift().complete()}})},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var e;return((e=this.observers)===null||e===void 0?void 0:e.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(e){return this._throwIfClosed(),o.prototype._trySubscribe.call(this,e)},t.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},t.prototype._innerSubscribe=function(e){var a=this,i=this,s=i.hasError,r=i.isStopped,l=i.observers;return s||r?Qg:(this.currentObservers=null,l.push(e),new bc(function(){a.currentObservers=null,sd(l,e)}))},t.prototype._checkFinalizedStatuses=function(e){var a=this,i=a.hasError,s=a.thrownError,r=a.isStopped;i?e.error(s):r&&e.complete()},t.prototype.asObservable=function(){var e=new Le;return e.source=this,e},t.create=function(e,a){return new vm(e,a)},t})(Le),vm=(function(o){Ro(t,o);function t(e,a){var i=o.call(this)||this;return i.destination=e,i.source=a,i}return t.prototype.next=function(e){var a,i;(i=(a=this.destination)===null||a===void 0?void 0:a.next)===null||i===void 0||i.call(a,e)},t.prototype.error=function(e){var a,i;(i=(a=this.destination)===null||a===void 0?void 0:a.error)===null||i===void 0||i.call(a,e)},t.prototype.complete=function(){var e,a;(a=(e=this.destination)===null||e===void 0?void 0:e.complete)===null||a===void 0||a.call(e)},t.prototype._subscribe=function(e){var a,i;return(i=(a=this.source)===null||a===void 0?void 0:a.subscribe(e))!==null&&i!==void 0?i:Qg},t})(ah),_p={now:function(){return(_p.delegate||Date).now()},delegate:void 0},jv=(function(o){Ro(t,o);function t(e,a,i){e===void 0&&(e=1/0),a===void 0&&(a=1/0),i===void 0&&(i=_p);var s=o.call(this)||this;return s._bufferSize=e,s._windowTime=a,s._timestampProvider=i,s._buffer=[],s._infiniteTimeWindow=!0,s._infiniteTimeWindow=a===1/0,s._bufferSize=Math.max(1,e),s._windowTime=Math.max(1,a),s}return t.prototype.next=function(e){var a=this,i=a.isStopped,s=a._buffer,r=a._infiniteTimeWindow,l=a._timestampProvider,c=a._windowTime;i||(s.push(e),!r&&s.push(l.now()+c)),this._trimBuffer(),o.prototype.next.call(this,e)},t.prototype._subscribe=function(e){this._throwIfClosed(),this._trimBuffer();for(var a=this._innerSubscribe(e),i=this,s=i._infiniteTimeWindow,r=i._buffer,l=r.slice(),c=0;c<l.length&&!e.closed;c+=s?1:2)e.next(l[c]);return this._checkFinalizedStatuses(e),a},t.prototype._trimBuffer=function(){var e=this,a=e._bufferSize,i=e._timestampProvider,s=e._buffer,r=e._infiniteTimeWindow,l=(r?1:2)*a;if(a<1/0&&l<s.length&&s.splice(0,s.length-l),!r){for(var c=i.now(),d=0,u=1;u<s.length&&s[u]<=c;u+=2)d=u;d&&s.splice(0,d+1)}},t})(ah),Hv=(function(o){Ro(t,o);function t(e,a){return o.call(this)||this}return t.prototype.schedule=function(e,a){return this},t})(bc),Em={setInterval:function(o,t){for(var e=[],a=2;a<arguments.length;a++)e[a-2]=arguments[a];return setInterval.apply(void 0,Dr([o,t],Ui(e)))},clearInterval:function(o){return clearInterval(o)},delegate:void 0},Vv=(function(o){Ro(t,o);function t(e,a){var i=o.call(this,e,a)||this;return i.scheduler=e,i.work=a,i.pending=!1,i}return t.prototype.schedule=function(e,a){var i;if(a===void 0&&(a=0),this.closed)return this;this.state=e;var s=this.id,r=this.scheduler;return s!=null&&(this.id=this.recycleAsyncId(r,s,a)),this.pending=!0,this.delay=a,this.id=(i=this.id)!==null&&i!==void 0?i:this.requestAsyncId(r,this.id,a),this},t.prototype.requestAsyncId=function(e,a,i){return i===void 0&&(i=0),Em.setInterval(e.flush.bind(e,this),i)},t.prototype.recycleAsyncId=function(e,a,i){if(i===void 0&&(i=0),i!=null&&this.delay===i&&this.pending===!1)return a;a!=null&&Em.clearInterval(a)},t.prototype.execute=function(e,a){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var i=this._execute(e,a);if(i)return i;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},t.prototype._execute=function(e,a){var i=!1,s;try{this.work(e)}catch(r){i=!0,s=r||new Error("Scheduled action threw falsy error")}if(i)return this.unsubscribe(),s},t.prototype.unsubscribe=function(){if(!this.closed){var e=this,a=e.id,i=e.scheduler,s=i.actions;this.work=this.state=this.scheduler=null,this.pending=!1,sd(s,this),a!=null&&(this.id=this.recycleAsyncId(i,a,null)),this.delay=null,o.prototype.unsubscribe.call(this)}},t})(Hv),bm=(function(){function o(t,e){e===void 0&&(e=o.now),this.schedulerActionCtor=t,this.now=e}return o.prototype.schedule=function(t,e,a){return e===void 0&&(e=0),new this.schedulerActionCtor(this,t).schedule(a,e)},o.now=_p.now,o})(),Wv=(function(o){Ro(t,o);function t(e,a){a===void 0&&(a=bm.now);var i=o.call(this,e,a)||this;return i.actions=[],i._active=!1,i}return t.prototype.flush=function(e){var a=this.actions;if(this._active){a.push(e);return}var i;this._active=!0;do if(i=e.execute(e.state,e.delay))break;while(e=a.shift());if(this._active=!1,i){for(;e=a.shift();)e.unsubscribe();throw i}},t})(bm),Gv=new Wv(Vv),Kv=Gv,Fi=new Le(function(o){return o.complete()});function qv(o){return o&&he(o.schedule)}function ih(o){return o[o.length-1]}function Vd(o){return qv(ih(o))?o.pop():void 0}function Zv(o,t){return typeof ih(o)=="number"?o.pop():t}var Op=function(o){return o&&typeof o.length=="number"&&typeof o!="function"};function sh(o){return he(o==null?void 0:o.then)}function rh(o){return he(o[Rp])}function nh(o){return Symbol.asyncIterator&&he(o==null?void 0:o[Symbol.asyncIterator])}function lh(o){return new TypeError("You provided "+(o!==null&&typeof o=="object"?"an invalid object":"'"+o+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function Yv(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var ch=Yv();function dh(o){return he(o==null?void 0:o[ch])}function uh(o){return _v(this,arguments,function(){var e,a,i,s;return Jg(this,function(r){switch(r.label){case 0:e=o.getReader(),r.label=1;case 1:r.trys.push([1,,9,10]),r.label=2;case 2:return[4,ss(e.read())];case 3:return a=r.sent(),i=a.value,s=a.done,s?[4,ss(void 0)]:[3,5];case 4:return[2,r.sent()];case 5:return[4,ss(i)];case 6:return[4,r.sent()];case 7:return r.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}})})}function ph(o){return he(o==null?void 0:o.getReader)}function it(o){if(o instanceof Le)return o;if(o!=null){if(rh(o))return Xv(o);if(Op(o))return Jv(o);if(sh(o))return Qv(o);if(nh(o))return mh(o);if(dh(o))return eE(o);if(ph(o))return tE(o)}throw lh(o)}function Xv(o){return new Le(function(t){var e=o[Rp]();if(he(e.subscribe))return e.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Jv(o){return new Le(function(t){for(var e=0;e<o.length&&!t.closed;e++)t.next(o[e]);t.complete()})}function Qv(o){return new Le(function(t){o.then(function(e){t.closed||(t.next(e),t.complete())},function(e){return t.error(e)}).then(null,th)})}function eE(o){return new Le(function(t){var e,a;try{for(var i=Or(o),s=i.next();!s.done;s=i.next()){var r=s.value;if(t.next(r),t.closed)return}}catch(l){e={error:l}}finally{try{s&&!s.done&&(a=i.return)&&a.call(i)}finally{if(e)throw e.error}}t.complete()})}function mh(o){return new Le(function(t){oE(o,t).catch(function(e){return t.error(e)})})}function tE(o){return mh(uh(o))}function oE(o,t){var e,a,i,s;return Rv(this,void 0,void 0,function(){var r,l;return Jg(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,11]),e=Ov(o),c.label=1;case 1:return[4,e.next()];case 2:if(a=c.sent(),!!a.done)return[3,4];if(r=a.value,t.next(r),t.closed)return[2];c.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return l=c.sent(),i={error:l},[3,11];case 6:return c.trys.push([6,,9,10]),a&&!a.done&&(s=e.return)?[4,s.call(e)]:[3,8];case 7:c.sent(),c.label=8;case 8:return[3,10];case 9:if(i)throw i.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})}function $i(o,t,e,a,i){a===void 0&&(a=0),i===void 0&&(i=!1);var s=t.schedule(function(){e(),i?o.add(this.schedule(null,a)):this.unsubscribe()},a);if(o.add(s),!i)return s}function gh(o,t){return t===void 0&&(t=0),je(function(e,a){e.subscribe(Ue(a,function(i){return $i(a,o,function(){return a.next(i)},t)},function(){return $i(a,o,function(){return a.complete()},t)},function(i){return $i(a,o,function(){return a.error(i)},t)}))})}function hh(o,t){return t===void 0&&(t=0),je(function(e,a){a.add(o.schedule(function(){return e.subscribe(a)},t))})}function aE(o,t){return it(o).pipe(hh(t),gh(t))}function iE(o,t){return it(o).pipe(hh(t),gh(t))}function sE(o,t){return new Le(function(e){var a=0;return t.schedule(function(){a===o.length?e.complete():(e.next(o[a++]),e.closed||this.schedule())})})}function rE(o,t){return new Le(function(e){var a;return $i(e,t,function(){a=o[ch](),$i(e,t,function(){var i,s,r;try{i=a.next(),s=i.value,r=i.done}catch(l){e.error(l);return}r?e.complete():e.next(s)},0,!0)}),function(){return he(a==null?void 0:a.return)&&a.return()}})}function fh(o,t){if(!o)throw new Error("Iterable cannot be null");return new Le(function(e){$i(e,t,function(){var a=o[Symbol.asyncIterator]();$i(e,t,function(){a.next().then(function(i){i.done?e.complete():e.next(i.value)})},0,!0)})})}function nE(o,t){return fh(uh(o),t)}function lE(o,t){if(o!=null){if(rh(o))return aE(o,t);if(Op(o))return sE(o,t);if(sh(o))return iE(o,t);if(nh(o))return fh(o,t);if(dh(o))return rE(o,t);if(ph(o))return nE(o,t)}throw lh(o)}function le(o,t){return t?lE(o,t):it(o)}function ym(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];var e=Vd(o);return le(o,e)}var Dp=Ap(function(o){return function(){o(this),this.name="EmptyError",this.message="no elements in sequence"}});function tt(o,t){return new Promise(function(e,a){var i=new rd({next:function(s){e(s),i.unsubscribe()},error:a,complete:function(){a(new Dp)}});o.subscribe(i)})}function cE(o){return o instanceof Date&&!isNaN(o)}function et(o,t){return je(function(e,a){var i=0;e.subscribe(Ue(a,function(s){a.next(o.call(t,s,i++))}))})}var dE=Array.isArray;function uE(o,t){return dE(t)?o.apply(void 0,Dr([],Ui(t))):o(t)}function pE(o){return et(function(t){return uE(o,t)})}function vh(o,t,e,a,i,s,r,l){var c=[],d=0,u=0,p=!1,g=function(){p&&!c.length&&!d&&t.complete()},m=function(b){return d<a?v(b):c.push(b)},v=function(b){s&&t.next(b),d++;var E=!1;it(e(b,u++)).subscribe(Ue(t,function(T){i==null||i(T),s?m(T):t.next(T)},function(){E=!0},void 0,function(){if(E)try{d--;for(var T=function(){var R=c.shift();r||v(R)};c.length&&d<a;)T();g()}catch(R){t.error(R)}}))};return o.subscribe(Ue(t,m,function(){p=!0,g()})),function(){l==null||l()}}function Be(o,t,e){return e===void 0&&(e=1/0),he(t)?Be(function(a,i){return et(function(s,r){return t(a,s,i,r)})(it(o(a,i)))},e):(typeof t=="number"&&(e=t),je(function(a,i){return vh(a,i,o,e)}))}function Eh(o){return o===void 0&&(o=1/0),Be(Ia,o)}function mE(){return Eh(1)}function bu(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];return mE()(le(o,Vd(o)))}function rs(o){return new Le(function(t){it(o()).subscribe(t)})}var gE=["addListener","removeListener"],hE=["addEventListener","removeEventListener"],fE=["on","off"];function yu(o,t,e,a){if(he(e)&&(a=e,e=void 0),a)return yu(o,t,e).pipe(pE(a));var i=Ui(bE(o)?hE.map(function(l){return function(c){return o[l](t,c,e)}}):vE(o)?gE.map(wm(o,t)):EE(o)?fE.map(wm(o,t)):[],2),s=i[0],r=i[1];if(!s&&Op(o))return Be(function(l){return yu(l,t,e)})(it(o));if(!s)throw new TypeError("Invalid event target");return new Le(function(l){var c=function(){for(var d=[],u=0;u<arguments.length;u++)d[u]=arguments[u];return l.next(1<d.length?d:d[0])};return s(c),function(){return r(c)}})}function wm(o,t){return function(e){return function(a){return o[e](t,a)}}}function vE(o){return he(o.addListener)&&he(o.removeListener)}function EE(o){return he(o.on)&&he(o.off)}function bE(o){return he(o.addEventListener)&&he(o.removeEventListener)}function Mp(o,t,e){return o===void 0&&(o=0),e===void 0&&(e=Kv),new Le(function(a){var i=cE(o)?+o-e.now():o;i<0&&(i=0);var s=0;return e.schedule(function(){a.closed||(a.next(s++),a.complete())},i)})}function sn(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];var e=Vd(o),a=Zv(o,1/0),i=o;return i.length?i.length===1?it(i[0]):Eh(a)(le(i,e)):Fi}var bh=new Le(Mr),yE=Array.isArray;function wE(o){return o.length===1&&yE(o[0])?o[0]:o}function kr(o,t){return je(function(e,a){var i=0;e.subscribe(Ue(a,function(s){return o.call(t,s,i++)&&a.next(s)}))})}function TE(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];return o=wE(o),o.length===1?it(o[0]):new Le(yh(o))}function yh(o){return function(t){for(var e=[],a=function(s){e.push(it(o[s]).subscribe(Ue(t,function(r){if(e){for(var l=0;l<e.length;l++)l!==s&&e[l].unsubscribe();e=null}t.next(r)})))},i=0;e&&!t.closed&&i<o.length;i++)a(i)}}function Wr(o){return je(function(t,e){var a=null,i=!1,s;a=t.subscribe(Ue(e,void 0,void 0,function(r){s=it(o(r,Wr(o)(t))),a?(a.unsubscribe(),a=null,s.subscribe(e)):i=!0})),i&&(a.unsubscribe(),a=null,s.subscribe(e))})}function wh(o){return je(function(t,e){var a=!1;t.subscribe(Ue(e,function(i){a=!0,e.next(i)},function(){a||e.next(o),e.complete()}))})}function Th(o){return o<=0?function(){return Fi}:je(function(t,e){var a=0;t.subscribe(Ue(e,function(i){++a<=o&&(e.next(i),o<=a&&e.complete())}))})}function $c(){return je(function(o,t){o.subscribe(Ue(t,Mr))})}function Wd(o){return o===void 0&&(o=xE),je(function(t,e){var a=!1;t.subscribe(Ue(e,function(i){a=!0,e.next(i)},function(){return a?e.complete():e.error(o())}))})}function xE(){return new Dp}function nd(o,t){var e=arguments.length>=2;return function(a){return a.pipe(o?kr(function(i,s){return o(i,s,a)}):Ia,Th(1),e?wh(t):Wd(function(){return new Dp}))}}function IE(o,t,e){return e===void 0&&(e=1/0),je(function(a,i){var s=t;return vh(a,i,function(r,l){return o(s,r,l)},e,function(r){s=r},!1,void 0,function(){return s=null})})}function Kt(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];return o.length?je(function(e,a){yh(Dr([e],Ui(o)))(a)}):Ia}function Uc(o){o===void 0&&(o=1/0);var t;o&&typeof o=="object"?t=o:t={count:o};var e=t.count,a=e===void 0?1/0:e,i=t.delay,s=t.resetOnSuccess,r=s===void 0?!1:s;return a<=0?Ia:je(function(l,c){var d=0,u,p=function(){var g=!1;u=l.subscribe(Ue(c,function(m){r&&(d=0),c.next(m)},void 0,function(m){if(d++<a){var v=function(){u?(u.unsubscribe(),u=null,p()):g=!0};if(i!=null){var b=typeof i=="number"?Mp(i):it(i(m,d)),E=Ue(c,function(){E.unsubscribe(),v()},function(){c.complete()});b.subscribe(E)}else v()}else c.error(m)})),g&&(u.unsubscribe(),u=null,p())};p()})}function SE(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];var e=Vd(o);return je(function(a,i){(e?bu(o,a,e):bu(o,a)).subscribe(i)})}function AE(o,t){return je(function(e,a){var i=null,s=0,r=!1,l=function(){return r&&!i&&a.complete()};e.subscribe(Ue(a,function(c){i==null||i.unsubscribe();var d=0,u=s++;it(o(c,u)).subscribe(i=Ue(a,function(p){return a.next(t?t(c,p,u,d++):p)},function(){i=null,l()}))},function(){r=!0,l()}))})}function CE(o){return je(function(t,e){it(o).subscribe(Ue(e,function(){return e.complete()},Mr)),!e.closed&&t.subscribe(e)})}function _c(o,t,e){var a=he(o)||t||e?{next:o,error:t,complete:e}:o;return a?je(function(i,s){var r;(r=a.subscribe)===null||r===void 0||r.call(a);var l=!0;i.subscribe(Ue(s,function(c){var d;(d=a.next)===null||d===void 0||d.call(a,c),s.next(c)},function(){var c;l=!1,(c=a.complete)===null||c===void 0||c.call(a),s.complete()},function(c){var d;l=!1,(d=a.error)===null||d===void 0||d.call(a,c),s.error(c)},function(){var c,d;l&&((c=a.unsubscribe)===null||c===void 0||c.call(a)),(d=a.finalize)===null||d===void 0||d.call(a)}))}):Ia}const zp="1.0.4";/**
 * @license
 * Copyright 2020 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const L=(o,t)=>{if(!o)throw new Error(t)};/**
 * @license
 * Copyright 2020 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const xh=!!(typeof process<"u"&&process.version);var RE={};let tu=null;async function _E(){return tu||(tu=(await Promise.resolve().then(()=>Rw)).default),tu}const Lp=o=>xh?async(...t)=>{const e=RE.DEBUG||"";(e==="*"||(e.endsWith("*")?o.startsWith(e):o===e))&&(await _E())(o)(t)}:(...t)=>{const e=globalThis.__PUPPETEER_DEBUG;!e||!(e==="*"||(e.endsWith("*")?o.startsWith(e):o===e))||console.log(`${o}:`,...t)};/**
 * @license
 * Copyright 2018 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class Np extends Error{constructor(t,e){super(t,e),this.name=this.constructor.name}get[Symbol.toStringTag](){return this.constructor.name}}class Pp extends Np{}var vn,En;class rn extends Np{constructor(){super(...arguments);h(this,vn);h(this,En,"")}set code(e){f(this,vn,e)}get code(){return n(this,vn)}set originalMessage(e){f(this,En,e)}get originalMessage(){return n(this,En)}}vn=new WeakMap,En=new WeakMap;class Ih extends Np{}class wa extends rn{}/**
 * @license
 * Copyright 2020 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const OE={letter:{width:8.5,height:11},legal:{width:8.5,height:14},tabloid:{width:11,height:17},ledger:{width:17,height:11},a0:{width:33.1,height:46.8},a1:{width:23.4,height:33.1},a2:{width:16.54,height:23.4},a3:{width:11.7,height:16.54},a4:{width:8.27,height:11.7},a5:{width:5.83,height:8.27},a6:{width:4.13,height:5.83}};/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const Z=Lp("puppeteer:error"),DE=Object.freeze({width:800,height:600}),ld=Symbol("Source URL for Puppeteer evaluation scripts");var Ba,Fa;const Da=class Da{constructor(){h(this,Ba);h(this,Fa)}static fromCallSite(t,e){const a=new Da;return f(a,Ba,t),f(a,Fa,e.toString()),a}get functionName(){return n(this,Ba)}get siteString(){return n(this,Fa)}toString(){return`pptr:${[n(this,Ba),encodeURIComponent(n(this,Fa))].join(";")}`}};Ba=new WeakMap,Fa=new WeakMap,_(Da,"INTERNAL_URL","pptr:internal"),_(Da,"parse",t=>{t=t.slice(5);const[e="",a=""]=t.split(";"),i=new Da;return f(i,Ba,e),f(i,Fa,decodeURIComponent(a)),i}),_(Da,"isPuppeteerURL",t=>t.startsWith("pptr:"));let wo=Da;const ze=(o,t)=>{if(Object.prototype.hasOwnProperty.call(t,ld))return t;const e=Error.prepareStackTrace;Error.prepareStackTrace=(i,s)=>s[2];const a=new Error().stack;return Error.prepareStackTrace=e,Object.assign(t,{[ld]:wo.fromCallSite(o,a)})},ME=o=>{if(Object.prototype.hasOwnProperty.call(o,ld))return o[ld]},Wi=o=>typeof o=="string"||o instanceof String,zE=o=>typeof o=="number"||o instanceof Number;function Sh(o,...t){var i;if(Wi(o))return L(t.length===0,"Cannot evaluate a string with arguments"),o;function e(s){return Object.is(s,void 0)?"undefined":JSON.stringify(s)}const a=`(${o})(${t.map(e).join(",")})`;return((i=globalThis.navigator)==null?void 0:i.userAgent)==="Cloudflare-Workers"?`((__name => (${a}))(t => t))`:a}let ou=null;async function Tm(){if(!ou)try{ou=await import("fs/promises")}catch(o){throw o instanceof TypeError?new Error("Cannot write to a path outside of a Node-like environment. fs"):o}return ou}async function Ah(o,t){const e=[],a=o.getReader();if(t)throw new Error("Cannot write to a path outside of a Node-like environment.");for(;;){const{done:i,value:s}=await a.read();if(i)break;e.push(s)}try{return pg.concat(e)}catch(i){return Z(i),null}}async function Ch(o,t){return new ReadableStream({async pull(e){function a(l,c){return c?Uint8Array.from(atob(l),u=>u.codePointAt(0)):new TextEncoder().encode(l)}const{data:i,base64Encoded:s,eof:r}=await o.send("IO.read",{handle:t});e.enqueue(a(i,s??!1)),r&&(await o.send("IO.close",{handle:t}),e.close())}})}function LE(o){let t=null;return new Set(["alert","confirm","prompt","beforeunload"]).has(o)&&(t=o),L(t,`Unknown javascript dialog type: ${o}`),t}function qt(o,t){return o===0?bh:Mp(o).pipe(et(()=>{throw new Pp(`Timed out after waiting ${o}ms`,{cause:t})}))}const xm="__puppeteer_utility_world__"+zp,Im=/^[\040\t]*\/\/[@#] sourceURL=\s*(\S*?)\s*$/m;function NE(o){return`//# sourceURL=${o}`}const PE=500;function kE(o={},t="in"){var r,l,c,d;const e={scale:1,displayHeaderFooter:!1,headerTemplate:"",footerTemplate:"",printBackground:!1,landscape:!1,pageRanges:"",preferCSSPageSize:!1,omitBackground:!1,outline:!1,tagged:!0,waitForFonts:!0};let a=8.5,i=11;if(o.format){const u=OE[o.format.toLowerCase()];L(u,"Unknown paper format: "+o.format),a=u.width,i=u.height}else a=Yi(o.width,t)??a,i=Yi(o.height,t)??i;const s={top:Yi((r=o.margin)==null?void 0:r.top,t)||0,left:Yi((l=o.margin)==null?void 0:l.left,t)||0,bottom:Yi((c=o.margin)==null?void 0:c.bottom,t)||0,right:Yi((d=o.margin)==null?void 0:d.right,t)||0};return o.outline&&(o.tagged=!0),{...e,...o,width:a,height:i,margin:s}}const au={px:1,in:96,cm:37.8,mm:3.78};function Yi(o,t="in"){if(typeof o>"u")return;let e;if(zE(o))e=o;else if(Wi(o)){const a=o;let i=a.substring(a.length-2).toLowerCase(),s="";i in au?s=a.substring(0,a.length-2):(i="px",s=a);const r=Number(s);L(!isNaN(r),"Failed to parse parameter value: "+a),e=r*au[i]}else throw new Error("page.pdf() Cannot handle parameter type: "+typeof o);return e/au[t]}function Ae(o,t){return new Le(e=>{const a=i=>{e.next(i)};return o.on(t,a),()=>{o.off(t,a)}})}function Gr(o,t){return o?yu(o,"abort").pipe(et(()=>{throw o.reason instanceof Error?(o.reason.cause=t,o.reason):new Error(o.reason,{cause:t})})):bh}function Qr(o){return Be(t=>le(Promise.resolve(o(t))).pipe(kr(e=>e),et(()=>t)))}function BE(o){return{all:o=o||new Map,on:function(t,e){var a=o.get(t);a?a.push(e):o.set(t,[e])},off:function(t,e){var a=o.get(t);a&&(e?a.splice(a.indexOf(e)>>>0,1):o.set(t,[]))},emit:function(t,e){var a=o.get(t);a&&a.slice().map(function(i){i(e)}),(a=o.get("*"))&&a.slice().map(function(i){i(t,e)})}}}/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */Symbol.dispose??(Symbol.dispose=Symbol("dispose"));Symbol.asyncDispose??(Symbol.asyncDispose=Symbol("asyncDispose"));const ue=Symbol.dispose,Ot=Symbol.asyncDispose;var ng,lg,Uo,ao;lg=ue,ng=Symbol.toStringTag;const $p=class $p{constructor(){h(this,Uo,!1);h(this,ao,[]);_(this,lg,this.dispose);_(this,ng,"DisposableStack")}get disposed(){return n(this,Uo)}dispose(){if(!n(this,Uo)){f(this,Uo,!0);for(const t of n(this,ao).reverse())t[ue]()}}use(t){return t&&n(this,ao).push(t),t}adopt(t,e){return n(this,ao).push({[ue](){e(t)}}),t}defer(t){n(this,ao).push({[ue](){t()}})}move(){if(n(this,Uo))throw new ReferenceError("a disposed stack can not use anything new");const t=new $p;return f(t,ao,n(this,ao)),f(this,Uo,!0),t}};Uo=new WeakMap,ao=new WeakMap;let To=$p;var cg,dg,jo,io;dg=Ot,cg=Symbol.toStringTag;const Up=class Up{constructor(){h(this,jo,!1);h(this,io,[]);_(this,dg,this.dispose);_(this,cg,"AsyncDisposableStack")}get disposed(){return n(this,jo)}async dispose(){if(!n(this,jo)){f(this,jo,!0);for(const t of n(this,io).reverse())await t[Ot]()}}use(t){return t&&n(this,io).push(t),t}adopt(t,e){return n(this,io).push({[Ot](){return e(t)}}),t}defer(t){n(this,io).push({[Ot](){return t()}})}move(){if(n(this,jo))throw new ReferenceError("a disposed stack can not use anything new");const t=new Up;return f(t,io,n(this,io)),f(this,jo,!0),t}};jo=new WeakMap,io=new WeakMap;let cd=Up;/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var so,$t;class ye{constructor(t=BE(new Map)){h(this,so);h(this,$t,new Map);f(this,so,t)}on(t,e){const a=n(this,$t).get(t);return a===void 0?n(this,$t).set(t,[e]):a.push(e),n(this,so).on(t,e),this}off(t,e){const a=n(this,$t).get(t)??[];if(e===void 0){for(const s of a)n(this,so).off(t,s);return n(this,$t).delete(t),this}const i=a.lastIndexOf(e);return i>-1&&n(this,so).off(t,...a.splice(i,1)),this}emit(t,e){return n(this,so).emit(t,e),this.listenerCount(t)>0}once(t,e){const a=i=>{e(i),this.off(t,a)};return this.on(t,a)}listenerCount(t){var e;return((e=n(this,$t).get(t))==null?void 0:e.length)||0}removeAllListeners(t){return t!==void 0?this.off(t):(this[ue](),this)}[ue](){for(const[t,e]of n(this,$t))for(const a of e)n(this,so).off(t,a);n(this,$t).clear()}}so=new WeakMap,$t=new WeakMap;/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const FE=new Map([["geolocation","geolocation"],["midi","midi"],["notifications","notifications"],["camera","videoCapture"],["microphone","audioCapture"],["background-sync","backgroundSync"],["ambient-light-sensor","sensors"],["accelerometer","sensors"],["gyroscope","sensors"],["magnetometer","sensors"],["accessibility-events","accessibilityEvents"],["clipboard-read","clipboardReadWrite"],["clipboard-write","clipboardReadWrite"],["clipboard-sanitized-write","clipboardSanitizedWrite"],["payment-handler","paymentHandler"],["persistent-storage","durableStorage"],["idle-detection","idleDetection"],["midi-sysex","midiSysex"]]);class $E extends ye{constructor(){super()}async waitForTarget(t,e={}){const{timeout:a=3e4}=e;return await tt(sn(Ae(this,"targetcreated"),Ae(this,"targetchanged"),le(this.targets())).pipe(Qr(t),Kt(qt(a))))}async pages(){return(await Promise.all(this.browserContexts().map(e=>e.pages()))).reduce((e,a)=>e.concat(a),[])}isConnected(){return this.connected}[ue](){return this.process()?void this.close().catch(Z):void this.disconnect().catch(Z)}[Ot](){return this.process()?this.close():this.disconnect()}sessionId(){throw new Error("Not implemented")}}var ge;(function(o){o.Disconnected=Symbol("CDPSession.Disconnected"),o.Swapped=Symbol("CDPSession.Swapped"),o.Ready=Symbol("CDPSession.Ready"),o.SessionAttached="sessionattached",o.SessionDetached="sessiondetached"})(ge||(ge={}));class jc extends ye{constructor(){super()}parentSession(){}}/**
 * @license
 * Copyright 2024 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Ho,Vo,$a,bn,yd,gs,yn,wn,wu,hs;const wd=class wd{constructor(t){h(this,wn);h(this,Ho,!1);h(this,Vo,!1);h(this,$a);h(this,bn);h(this,yd,new Promise(t=>{f(this,bn,t)}));h(this,gs);h(this,yn);h(this,hs);t&&t.timeout>0&&(f(this,yn,new Pp(t.message)),f(this,gs,setTimeout(()=>{this.reject(n(this,yn))},t.timeout)))}static create(t){return new wd(t)}static async race(t){const e=new Set;try{const a=t.map(i=>i instanceof wd?(n(i,gs)&&e.add(i),i.valueOrThrow()):i);return await Promise.race(a)}finally{for(const a of e)a.reject(new Error("Timeout cleared"))}}resolve(t){n(this,Vo)||n(this,Ho)||(f(this,Ho,!0),w(this,wn,wu).call(this,t))}reject(t){n(this,Vo)||n(this,Ho)||(f(this,Vo,!0),w(this,wn,wu).call(this,t))}resolved(){return n(this,Ho)}finished(){return n(this,Ho)||n(this,Vo)}value(){return n(this,$a)}valueOrThrow(){return n(this,hs)||f(this,hs,(async()=>{if(await n(this,yd),n(this,Vo))throw n(this,$a);return n(this,$a)})()),n(this,hs)}};Ho=new WeakMap,Vo=new WeakMap,$a=new WeakMap,bn=new WeakMap,yd=new WeakMap,gs=new WeakMap,yn=new WeakMap,wn=new WeakSet,wu=function(t){clearTimeout(n(this,gs)),f(this,$a,t),n(this,bn).call(this)},hs=new WeakMap;let de=wd;/**
 * @license
 * Copyright 2024 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Tn,xn,ug,fs,In;const on=class on{constructor(){h(this,fs,!1);h(this,In,[])}async acquire(t){if(!n(this,fs))return f(this,fs,!0),new on.Guard(this);const e=de.create();return n(this,In).push(e.resolve.bind(e)),await e.valueOrThrow(),new on.Guard(this,t)}release(){const t=n(this,In).shift();if(!t){f(this,fs,!1);return}t()}};fs=new WeakMap,In=new WeakMap,_(on,"Guard",(ug=class{constructor(e,a){h(this,Tn);h(this,xn);f(this,Tn,e),f(this,xn,a)}[ue](){var e;return(e=n(this,xn))==null||e.call(this),n(this,Tn).release()}},Tn=new WeakMap,xn=new WeakMap,ug));let nn=on;/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Ua,vs;class UE extends ye{constructor(){super();h(this,Ua);h(this,vs,0)}startScreenshot(){const e=n(this,Ua)||new nn;return f(this,Ua,e),qi(this,vs)._++,e.acquire(()=>{qi(this,vs)._--,n(this,vs)===0&&f(this,Ua,void 0)})}waitForScreenshotOperations(){var e;return(e=n(this,Ua))==null?void 0:e.acquire()}async waitForTarget(e,a={}){const{timeout:i=3e4}=a;return await tt(sn(Ae(this,"targetcreated"),Ae(this,"targetchanged"),le(this.targets())).pipe(Qr(e),Kt(qt(i))))}get closed(){return!this.browser().browserContexts().includes(this)}get id(){}[ue](){return void this.close().catch(Z)}[Ot](){return this.close()}}Ua=new WeakMap,vs=new WeakMap;/**
 * @license
 * Copyright 2024 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var jE=function(o,t,e){if(t!=null){if(typeof t!="object"&&typeof t!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=t[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=t[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");o.stack.push({value:t,dispose:a,async:e})}else e&&o.stack.push({async:!0});return t},HE=(function(o){return function(t){function e(i){t.error=t.hasError?new o(i,t.error,"An error was suppressed during disposal."):i,t.hasError=!0}function a(){for(;t.stack.length;){var i=t.stack.pop();try{var s=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(s).then(a,function(r){return e(r),a()})}catch(r){e(r)}}if(t.hasError)throw t.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(o,t,e){var a=new Error(e);return a.name="SuppressedError",a.error=o,a.suppressed=t,a}),Es,ro,wt;class iu extends UE{constructor(e,a,i){super();h(this,Es);h(this,ro);h(this,wt);f(this,Es,e),f(this,ro,a),f(this,wt,i)}get id(){return n(this,wt)}targets(){return n(this,ro).targets().filter(e=>e.browserContext()===this)}async pages(){return(await Promise.all(this.targets().filter(a=>{var i;return a.type()==="page"||a.type()==="other"&&((i=n(this,ro)._getIsPageTargetCallback())==null?void 0:i(a))}).map(a=>a.page()))).filter(a=>!!a)}isIncognito(){return!!n(this,wt)}async overridePermissions(e,a){const i=a.map(s=>{const r=FE.get(s);if(!r)throw new Error("Unknown permission: "+s);return r});await n(this,Es).send("Browser.grantPermissions",{origin:e,browserContextId:n(this,wt)||void 0,permissions:i})}async clearPermissionOverrides(){await n(this,Es).send("Browser.resetPermissions",{browserContextId:n(this,wt)||void 0})}async newPage(){const e={stack:[],error:void 0,hasError:!1};try{const a=jE(e,await this.waitForScreenshotOperations(),!1);return await n(this,ro)._createPageInContext(n(this,wt))}catch(a){e.error=a,e.hasError=!0}finally{HE(e)}}browser(){return n(this,ro)}async close(){L(n(this,wt),"Non-incognito profiles cannot be closed!"),await n(this,ro)._disposeContext(n(this,wt))}}Es=new WeakMap,ro=new WeakMap,wt=new WeakMap;/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var pt;(function(o){o.PAGE="page",o.BACKGROUND_PAGE="background_page",o.SERVICE_WORKER="service_worker",o.SHARED_WORKER="shared_worker",o.BROWSER="browser",o.WEBVIEW="webview",o.OTHER="other",o.TAB="tab"})(pt||(pt={}));class VE{constructor(){}async worker(){return null}async page(){return null}}/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */function Xt(o){return typeof o=="object"&&o!==null&&"name"in o&&"message"in o}function Rh(o,t,e){return o.message=t,o.originalMessage=e??o.originalMessage,o}function _h(o){let t=o.error.message;return o.error&&typeof o.error=="object"&&"data"in o.error&&(t+=` ${o.error.data}`),t}/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Tt,Td;class Oh{constructor(){h(this,Tt,new Map);h(this,Td,GE())}create(t,e,a){const i=new WE(n(this,Td).call(this),t,e);n(this,Tt).set(i.id,i);try{a(i.id)}catch(s){throw i.promise.catch(Z).finally(()=>{n(this,Tt).delete(i.id)}),i.reject(s),s}return i.promise.finally(()=>{n(this,Tt).delete(i.id)})}reject(t,e,a){const i=n(this,Tt).get(t);i&&this._reject(i,e,a)}_reject(t,e,a){let i,s;e instanceof rn?(i=e,i.cause=t.error,s=e.message):(i=t.error,s=e),t.reject(Rh(i,`Protocol error (${t.label}): ${s}`,a))}resolve(t,e){const a=n(this,Tt).get(t);a&&a.resolve(e)}clear(){for(const t of n(this,Tt).values())this._reject(t,new wa("Target closed"));n(this,Tt).clear()}getPendingProtocolErrors(){const t=[];for(const e of n(this,Tt).values())t.push(new Error(`${e.label} timed out. Trace: ${e.error.stack}`));return t}}Tt=new WeakMap,Td=new WeakMap;var Sn,An,ja,bs,Cn;class WE{constructor(t,e,a){h(this,Sn);h(this,An,new rn);h(this,ja,de.create());h(this,bs);h(this,Cn);f(this,Sn,t),f(this,Cn,e),a&&f(this,bs,setTimeout(()=>{n(this,ja).reject(Rh(n(this,An),`${e} timed out. Increase the 'protocolTimeout' setting in launch/connect calls for a higher timeout if needed.`))},a))}resolve(t){clearTimeout(n(this,bs)),n(this,ja).resolve(t)}reject(t){clearTimeout(n(this,bs)),n(this,ja).reject(t)}get id(){return n(this,Sn)}get promise(){return n(this,ja).valueOrThrow()}get error(){return n(this,An)}get label(){return n(this,Cn)}}Sn=new WeakMap,An=new WeakMap,ja=new WeakMap,bs=new WeakMap,Cn=new WeakMap;function GE(){let o=0;return()=>++o}/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Ha,ys,Wo,xt,ws,Ts;class ns extends jc{constructor(e,a,i,s){super();h(this,Ha);h(this,ys);h(this,Wo,new Oh);h(this,xt);h(this,ws);h(this,Ts);f(this,xt,e),f(this,ys,a),f(this,Ha,i),f(this,ws,s)}_setTarget(e){f(this,Ts,e)}_target(){return L(n(this,Ts),"Target must exist"),n(this,Ts)}connection(){return n(this,xt)}parentSession(){var a;return n(this,ws)?((a=n(this,xt))==null?void 0:a.session(n(this,ws)))??void 0:this}send(e,a,i){return n(this,xt)?n(this,xt)._rawSend(n(this,Wo),e,a,n(this,Ha),i):Promise.reject(new wa(`Protocol error (${e}): Session closed. Most likely the ${n(this,ys)} has been closed.`))}_onMessage(e){e.id?e.error?n(this,Wo).reject(e.id,_h(e),e.error.message):n(this,Wo).resolve(e.id,e.result):(L(!e.id),this.emit(e.method,e.params))}async detach(){if(!n(this,xt))throw new Error(`Session already detached. Most likely the ${n(this,ys)} has been closed.`);await n(this,xt).send("Target.detachFromTarget",{sessionId:n(this,Ha)})}_onClosed(){n(this,Wo).clear(),f(this,xt,void 0),this.emit(ge.Disconnected,void 0)}id(){return n(this,Ha)}getPendingProtocolErrors(){return n(this,Wo).getPendingProtocolErrors()}}Ha=new WeakMap,ys=new WeakMap,Wo=new WeakMap,xt=new WeakMap,ws=new WeakMap,Ts=new WeakMap;/**
 * @license
 * Copyright 2019 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const Sm=3e4;var no,Va;class kp{constructor(){h(this,no);h(this,Va);f(this,no,null),f(this,Va,null)}setDefaultTimeout(t){f(this,no,t)}setDefaultNavigationTimeout(t){f(this,Va,t)}navigationTimeout(){return n(this,Va)!==null?n(this,Va):n(this,no)!==null?n(this,no):Sm}timeout(){return n(this,no)!==null?n(this,no):Sm}}no=new WeakMap,Va=new WeakMap;/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var KE=function(o,t,e){if(t!=null){if(typeof t!="object"&&typeof t!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=t[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=t[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");o.stack.push({value:t,dispose:a,async:e})}else e&&o.stack.push({async:!0});return t},qE=(function(o){return function(t){function e(i){t.error=t.hasError?new o(i,t.error,"An error was suppressed during disposal."):i,t.hasError=!0}function a(){for(;t.stack.length;){var i=t.stack.pop();try{var s=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(s).then(a,function(r){return e(r),a()})}catch(r){e(r)}}if(t.hasError)throw t.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(o,t,e){var a=new Error(e);return a.name="SuppressedError",a.error=o,a.suppressed=t,a});const Ur=new WeakSet;function ZE(o,t){let e=!1;if(o.prototype[ue]){const a=o.prototype[ue];o.prototype[ue]=function(){if(Ur.has(this)){Ur.delete(this);return}return a.call(this)},e=!0}if(o.prototype[Ot]){const a=o.prototype[Ot];o.prototype[Ot]=function(){if(Ur.has(this)){Ur.delete(this);return}return a.call(this)},e=!0}return e&&(o.prototype.move=function(){return Ur.add(this),this}),o}function Q(o=t=>`Attempted to use disposed ${t.constructor.name}.`){return(t,e)=>function(...a){if(this.disposed)throw new Error(o(this));return t.call(this,...a)}}function Lt(o,t){const e=new WeakMap;let a=-1;return function(...i){if(a===-1&&(a=i.length),a!==i.length)throw new Error("Memoized method was called with the wrong number of arguments");let s=!1,r=e;for(const l of i)r.has(l)||(s=!0,r.set(l,new WeakMap)),r=r.get(l);if(s)return o.call(this,...i)}}function YE(o=function(){return this}){return(t,e)=>{const a=new WeakMap;return async function(...i){const s={stack:[],error:void 0,hasError:!1};try{const r=o.call(this);let l=a.get(r);l||(l=new nn,a.set(r,l));const c=KE(s,await l.acquire(),!0);return await t.call(this,...i)}catch(r){s.error=r,s.hasError=!0}finally{const r=qE(s);r&&await r}}}}var XE=function(o,t,e){if(t!=null){if(typeof t!="object"&&typeof t!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=t[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=t[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");o.stack.push({value:t,dispose:a,async:e})}else e&&o.stack.push({async:!0});return t},JE=(function(o){return function(t){function e(i){t.error=t.hasError?new o(i,t.error,"An error was suppressed during disposal."):i,t.hasError=!0}function a(){for(;t.stack.length;){var i=t.stack.pop();try{var s=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(s).then(a,function(r){return e(r),a()})}catch(r){e(r)}}if(t.hasError)throw t.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(o,t,e){var a=new Error(e);return a.name="SuppressedError",a.error=o,a.suppressed=t,a}),os;(function(o){o.Action="action"})(os||(os={}));var Wa,Ga,Ka,Rn,qa,Za,Jt,Dh,Mh,zh,Lh;class Br extends ye{constructor(){super(...arguments);h(this,Jt);_(this,"visibility",null);_(this,"_timeout",3e4);h(this,Wa,!0);h(this,Ga,!0);h(this,Ka,!0);_(this,"operators",{conditions:(e,a)=>Be(i=>sn(...e.map(s=>s(i,a))).pipe(wh(i))),retryAndRaceWithSignalAndTimer:(e,a)=>{const i=[];return e&&i.push(Gr(e,a)),i.push(qt(this._timeout,a)),Pv(Uc({delay:Hc}),Kt(...i))}});h(this,Rn,(e,a)=>n(this,Ga)?le(e.frame.waitForFunction(i=>i instanceof HTMLElement?!["BUTTON","INPUT","SELECT","TEXTAREA","OPTION","OPTGROUP"].includes(i.nodeName)||!i.hasAttribute("disabled"):!0,{timeout:this._timeout,signal:a},e)).pipe($c()):Fi);h(this,qa,e=>n(this,Ka)?rs(()=>le(e.evaluate(a=>new Promise(i=>{window.requestAnimationFrame(()=>{const s=a.getBoundingClientRect();window.requestAnimationFrame(()=>{const r=a.getBoundingClientRect();i([{x:s.x,y:s.y,width:s.width,height:s.height},{x:r.x,y:r.y,width:r.width,height:r.height}])})})})))).pipe(nd(([a,i])=>a.x===i.x&&a.y===i.y&&a.width===i.width&&a.height===i.height),Uc({delay:Hc}),$c()):Fi);h(this,Za,e=>n(this,Wa)?le(e.isIntersectingViewport({threshold:0})).pipe(kr(a=>!a),Be(()=>le(e.scrollIntoView())),Be(()=>rs(()=>le(e.isIntersectingViewport({threshold:0}))).pipe(nd(Ia),Uc({delay:Hc}),$c()))):Fi)}static race(e){return Tu.create(e)}get timeout(){return this._timeout}setTimeout(e){const a=this._clone();return a._timeout=e,a}setVisibility(e){const a=this._clone();return a.visibility=e,a}setWaitForEnabled(e){const a=this._clone();return f(a,Ga,e),a}setEnsureElementIsInTheViewport(e){const a=this._clone();return f(a,Wa,e),a}setWaitForStableBoundingBox(e){const a=this._clone();return f(a,Ka,e),a}copyOptions(e){return this._timeout=e._timeout,this.visibility=e.visibility,f(this,Ga,n(e,Ga)),f(this,Wa,n(e,Wa)),f(this,Ka,n(e,Ka)),this}clone(){return this._clone()}async waitHandle(e){const a=new Error("Locator.waitHandle");return await tt(this._wait(e).pipe(this.operators.retryAndRaceWithSignalAndTimer(e==null?void 0:e.signal,a)))}async wait(e){const a={stack:[],error:void 0,hasError:!1};try{return await XE(a,await this.waitHandle(e),!1).jsonValue()}catch(i){a.error=i,a.hasError=!0}finally{JE(a)}}map(e){return new pd(this._clone(),a=>a.evaluateHandle(e))}filter(e){return new ud(this._clone(),async(a,i)=>(await a.frame.waitForFunction(e,{signal:i,timeout:this._timeout},a),!0))}filterHandle(e){return new ud(this._clone(),e)}mapHandle(e){return new pd(this._clone(),e)}click(e){return tt(w(this,Jt,Dh).call(this,e))}fill(e,a){return tt(w(this,Jt,Mh).call(this,e,a))}hover(e){return tt(w(this,Jt,zh).call(this,e))}scroll(e){return tt(w(this,Jt,Lh).call(this,e))}}Wa=new WeakMap,Ga=new WeakMap,Ka=new WeakMap,Rn=new WeakMap,qa=new WeakMap,Za=new WeakMap,Jt=new WeakSet,Dh=function(e){const a=e==null?void 0:e.signal,i=new Error("Locator.click");return this._wait(e).pipe(this.operators.conditions([n(this,Za),n(this,qa),n(this,Rn)],a),_c(()=>this.emit(os.Action,void 0)),Be(s=>le(s.click(e)).pipe(Wr(r=>{throw s.dispose().catch(Z),r}))),this.operators.retryAndRaceWithSignalAndTimer(a,i))},Mh=function(e,a){const i=a==null?void 0:a.signal,s=new Error("Locator.fill");return this._wait(a).pipe(this.operators.conditions([n(this,Za),n(this,qa),n(this,Rn)],i),_c(()=>this.emit(os.Action,void 0)),Be(r=>le(r.evaluate(l=>l instanceof HTMLSelectElement?"select":l instanceof HTMLTextAreaElement?"typeable-input":l instanceof HTMLInputElement?new Set(["textarea","text","url","tel","search","password","number","email"]).has(l.type)?"typeable-input":"other-input":l.isContentEditable?"contenteditable":"unknown")).pipe(Be(l=>{switch(l){case"select":return le(r.select(e).then(Mr));case"contenteditable":case"typeable-input":return le(r.evaluate((c,d)=>{const u=c.isContentEditable?c.innerText:c.value;if(d.length<=u.length||!d.startsWith(c.value))return c.isContentEditable?c.innerText="":c.value="",d;const p=c.isContentEditable?c.innerText:c.value;return c.isContentEditable?(c.innerText="",c.innerText=p):(c.value="",c.value=p),d.substring(p.length)},e)).pipe(Be(c=>le(r.type(c))));case"other-input":return le(r.focus()).pipe(Be(()=>le(r.evaluate((c,d)=>{c.value=d,c.dispatchEvent(new Event("input",{bubbles:!0})),c.dispatchEvent(new Event("change",{bubbles:!0}))},e))));case"unknown":throw new Error("Element cannot be filled out.")}})).pipe(Wr(l=>{throw r.dispose().catch(Z),l}))),this.operators.retryAndRaceWithSignalAndTimer(i,s))},zh=function(e){const a=e==null?void 0:e.signal,i=new Error("Locator.hover");return this._wait(e).pipe(this.operators.conditions([n(this,Za),n(this,qa)],a),_c(()=>this.emit(os.Action,void 0)),Be(s=>le(s.hover()).pipe(Wr(r=>{throw s.dispose().catch(Z),r}))),this.operators.retryAndRaceWithSignalAndTimer(a,i))},Lh=function(e){const a=e==null?void 0:e.signal,i=new Error("Locator.scroll");return this._wait(e).pipe(this.operators.conditions([n(this,Za),n(this,qa)],a),_c(()=>this.emit(os.Action,void 0)),Be(s=>le(s.evaluate((r,l,c)=>{l!==void 0&&(r.scrollTop=l),c!==void 0&&(r.scrollLeft=c)},e==null?void 0:e.scrollTop,e==null?void 0:e.scrollLeft)).pipe(Wr(r=>{throw s.dispose().catch(Z),r}))),this.operators.retryAndRaceWithSignalAndTimer(a,i))};var xs,Is;const xd=class xd extends Br{constructor(e,a){super();h(this,xs);h(this,Is);f(this,xs,e),f(this,Is,a)}static create(e,a){return new xd(e,a).setTimeout("getDefaultTimeout"in e?e.getDefaultTimeout():e.page().getDefaultTimeout())}_clone(){return new xd(n(this,xs),n(this,Is))}_wait(e){const a=e==null?void 0:e.signal;return rs(()=>le(n(this,xs).waitForFunction(n(this,Is),{timeout:this.timeout,signal:a}))).pipe(Wd())}};xs=new WeakMap,Is=new WeakMap;let dd=xd;var Ve;class Nh extends Br{constructor(e){super();h(this,Ve);f(this,Ve,e),this.copyOptions(n(this,Ve))}get delegate(){return n(this,Ve)}setTimeout(e){const a=super.setTimeout(e);return f(a,Ve,n(this,Ve).setTimeout(e)),a}setVisibility(e){const a=super.setVisibility(e);return f(a,Ve,n(a,Ve).setVisibility(e)),a}setWaitForEnabled(e){const a=super.setWaitForEnabled(e);return f(a,Ve,n(this,Ve).setWaitForEnabled(e)),a}setEnsureElementIsInTheViewport(e){const a=super.setEnsureElementIsInTheViewport(e);return f(a,Ve,n(this,Ve).setEnsureElementIsInTheViewport(e)),a}setWaitForStableBoundingBox(e){const a=super.setWaitForStableBoundingBox(e);return f(a,Ve,n(this,Ve).setWaitForStableBoundingBox(e)),a}}Ve=new WeakMap;var Ss;const jp=class jp extends Nh{constructor(e,a){super(e);h(this,Ss);f(this,Ss,a)}_clone(){return new jp(this.delegate.clone(),n(this,Ss)).copyOptions(this)}_wait(e){return this.delegate._wait(e).pipe(Be(a=>le(Promise.resolve(n(this,Ss).call(this,a,e==null?void 0:e.signal))).pipe(kr(i=>i),et(()=>a))),Wd())}};Ss=new WeakMap;let ud=jp;var As;const Hp=class Hp extends Nh{constructor(e,a){super(e);h(this,As);f(this,As,a)}_clone(){return new Hp(this.delegate.clone(),n(this,As)).copyOptions(this)}_wait(e){return this.delegate._wait(e).pipe(Be(a=>le(Promise.resolve(n(this,As).call(this,a,e==null?void 0:e.signal)))))}};As=new WeakMap;let pd=Hp;var Cs,Rs,Id;const Sd=class Sd extends Br{constructor(e,a){super();h(this,Cs);h(this,Rs);h(this,Id,e=>this.visibility?(()=>{switch(this.visibility){case"hidden":return rs(()=>le(e.isHidden()));case"visible":return rs(()=>le(e.isVisible()))}})().pipe(nd(Ia),Uc({delay:Hc}),$c()):Fi);f(this,Cs,e),f(this,Rs,a)}static create(e,a){return new Sd(e,a).setTimeout("getDefaultTimeout"in e?e.getDefaultTimeout():e.page().getDefaultTimeout())}_clone(){return new Sd(n(this,Cs),n(this,Rs)).copyOptions(this)}_wait(e){const a=e==null?void 0:e.signal;return rs(()=>le(n(this,Cs).waitForSelector(n(this,Rs),{visible:!1,timeout:this._timeout,signal:a}))).pipe(kr(i=>i!==null),Wd(),this.operators.conditions([n(this,Id)],a))}};Cs=new WeakMap,Rs=new WeakMap,Id=new WeakMap;let md=Sd;function QE(o){for(const t of o)if(!(t instanceof Br))throw new Error("Unknown locator for race candidate");return o}var _s;const Ad=class Ad extends Br{constructor(e){super();h(this,_s);f(this,_s,e)}static create(e){const a=QE(e);return new Ad(a)}_clone(){return new Ad(n(this,_s).map(e=>e.clone())).copyOptions(this)}_wait(e){return TE(...n(this,_s).map(a=>a._wait(e)))}};_s=new WeakMap;let Tu=Ad;const Hc=100;var eb=function(o,t,e){for(var a=arguments.length>2,i=0;i<t.length;i++)e=a?t[i].call(o,e):t[i].call(o);return a?e:void 0},tb=function(o,t,e,a,i,s){function r(T){if(T!==void 0&&typeof T!="function")throw new TypeError("Function expected");return T}for(var l=a.kind,c=l==="getter"?"get":l==="setter"?"set":"value",d=!t&&o?a.static?o:o.prototype:null,u=t||(d?Object.getOwnPropertyDescriptor(d,a.name):{}),p,g=!1,m=e.length-1;m>=0;m--){var v={};for(var b in a)v[b]=b==="access"?{}:a[b];for(var b in a.access)v.access[b]=a.access[b];v.addInitializer=function(T){if(g)throw new TypeError("Cannot add initializers after decoration has completed");s.push(r(T||null))};var E=(0,e[m])(l==="accessor"?{get:u.get,set:u.set}:u[c],v);if(l==="accessor"){if(E===void 0)continue;if(E===null||typeof E!="object")throw new TypeError("Object expected");(p=r(E.get))&&(u.get=p),(p=r(E.set))&&(u.set=p),(p=r(E.init))&&i.unshift(p)}else(p=r(E))&&(l==="field"?i.unshift(p):u[c]=p)}d&&Object.defineProperty(d,a.name,u),g=!0},Am=function(o,t,e){if(t!=null){if(typeof t!="object"&&typeof t!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=t[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=t[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");o.stack.push({value:t,dispose:a,async:e})}else e&&o.stack.push({async:!0});return t},ob=(function(o){return function(t){function e(i){t.error=t.hasError?new o(i,t.error,"An error was suppressed during disposal."):i,t.hasError=!0}function a(){for(;t.stack.length;){var i=t.stack.pop();try{var s=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(s).then(a,function(r){return e(r),a()})}catch(r){e(r)}}if(t.hasError)throw t.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(o,t,e){var a=new Error(e);return a.name="SuppressedError",a.error=o,a.suppressed=t,a});function ab(o){o.optimizeForSpeed??(o.optimizeForSpeed=!1),o.type??(o.type="png"),o.fromSurface??(o.fromSurface=!0),o.fullPage??(o.fullPage=!1),o.omitBackground??(o.omitBackground=!1),o.encoding??(o.encoding="binary"),o.captureBeyondViewport??(o.captureBeyondViewport=!0)}let ib=(()=>{var a,i,s,r,l;let o=ye,t=[],e;return l=class extends o{constructor(){super();_(this,"_isDragging",(eb(this,t),!1));_(this,"_timeoutSettings",new kp);h(this,a,new WeakMap);h(this,i,new jv(1));h(this,s,0);h(this,r);Ae(this,"request").pipe(Be(u=>bu(ym(1),sn(Ae(this,"requestfailed"),Ae(this,"requestfinished"),Ae(this,"response").pipe(et(p=>p.request()))).pipe(kr(p=>p.id===u.id),Th(1),et(()=>-1)))),IE((u,p)=>ym(u+p),0),CE(Ae(this,"close")),SE(0)).subscribe(n(this,i))}on(u,p){if(u!=="request")return super.on(u,p);let g=n(this,a).get(p);return g===void 0&&(g=m=>{m.enqueueInterceptAction(()=>p(m))},n(this,a).set(p,g)),super.on(u,g)}off(u,p){return u==="request"&&(p=n(this,a).get(p)||p),super.off(u,p)}get accessibility(){return this.mainFrame().accessibility}locator(u){return typeof u=="string"?md.create(this,u):dd.create(this,u)}locatorRace(u){return Br.race(u)}async $(u){return await this.mainFrame().$(u)}async $$(u,p){return await this.mainFrame().$$(u,p)}async evaluateHandle(u,...p){return u=ze(this.evaluateHandle.name,u),await this.mainFrame().evaluateHandle(u,...p)}async $eval(u,p,...g){return p=ze(this.$eval.name,p),await this.mainFrame().$eval(u,p,...g)}async $$eval(u,p,...g){return p=ze(this.$$eval.name,p),await this.mainFrame().$$eval(u,p,...g)}async addScriptTag(u){return await this.mainFrame().addScriptTag(u)}async addStyleTag(u){return await this.mainFrame().addStyleTag(u)}url(){return this.mainFrame().url()}async content(){return await this.mainFrame().content()}async setContent(u,p){await this.mainFrame().setContent(u,p)}async goto(u,p){return await this.mainFrame().goto(u,p)}async waitForNavigation(u={}){return await this.mainFrame().waitForNavigation(u)}waitForRequest(u,p={}){const{timeout:g=this._timeoutSettings.timeout(),signal:m}=p;if(typeof u=="string"){const b=u;u=E=>E.url()===b}const v=Ae(this,"request").pipe(Qr(u),Kt(qt(g),Gr(m),Ae(this,"close").pipe(et(()=>{throw new wa("Page closed!")}))));return tt(v)}waitForResponse(u,p={}){const{timeout:g=this._timeoutSettings.timeout(),signal:m}=p;if(typeof u=="string"){const b=u;u=E=>E.url()===b}const v=Ae(this,"response").pipe(Qr(u),Kt(qt(g),Gr(m),Ae(this,"close").pipe(et(()=>{throw new wa("Page closed!")}))));return tt(v)}waitForNetworkIdle(u={}){return tt(this.waitForNetworkIdle$(u))}waitForNetworkIdle$(u={}){const{timeout:p=this._timeoutSettings.timeout(),idleTime:g=PE,concurrency:m=0,signal:v}=u;return n(this,i).pipe(AE(b=>b>m?Fi:Mp(g)),et(()=>{}),Kt(qt(p),Gr(v),Ae(this,"close").pipe(et(()=>{throw new wa("Page closed!")}))))}async waitForFrame(u,p={}){const{timeout:g=this.getDefaultTimeout(),signal:m}=p;return Wi(u)&&(u=v=>u===v.url()),await tt(sn(Ae(this,"frameattached"),Ae(this,"framenavigated"),le(this.frames())).pipe(Qr(u),nd(),Kt(qt(g),Gr(m),Ae(this,"close").pipe(et(()=>{throw new wa("Page closed.")})))))}async emulate(u){await Promise.all([this.setUserAgent(u.userAgent),this.setViewport(u.viewport)])}async evaluate(u,...p){return u=ze(this.evaluate.name,u),await this.mainFrame().evaluate(u,...p)}async _maybeWriteBufferToFile(u,p){if(u)throw new Error("Cannot write to a path outside of a Node-like environment.")}async _startScreencast(){++qi(this,s)._,n(this,r)||f(this,r,this.mainFrame().client.send("Page.startScreencast",{format:"png"}).then(()=>new Promise(u=>this.mainFrame().client.once("Page.screencastFrame",()=>u())))),await n(this,r)}async _stopScreencast(){--qi(this,s)._,n(this,r)&&(f(this,r,void 0),n(this,s)===0&&await this.mainFrame().client.send("Page.stopScreencast"))}async screenshot(u={}){const p={stack:[],error:void 0,hasError:!1};try{const g=Am(p,await this.browserContext().startScreenshot(),!1);await this.bringToFront();const m={...u,clip:u.clip?{...u.clip}:void 0};if(m.type===void 0&&m.path!==void 0){const T=m.path;switch(T.slice(T.lastIndexOf(".")+1).toLowerCase()){case"png":m.type="png";break;case"jpeg":case"jpg":m.type="jpeg";break;case"webp":m.type="webp";break}}if(m.quality!==void 0){if(m.quality<0||m.quality>100)throw new Error(`Expected 'quality' (${m.quality}) to be between 0 and 100, inclusive.`);if(m.type===void 0||!["jpeg","webp"].includes(m.type))throw new Error(`${m.type??"png"} screenshots do not support 'quality'.`)}if(m.clip){if(m.clip.width<=0)throw new Error("'width' in 'clip' must be positive.");if(m.clip.height<=0)throw new Error("'height' in 'clip' must be positive.")}ab(m);const v=Am(p,new cd,!0);if(m.clip){if(m.fullPage)throw new Error("'clip' and 'fullPage' are mutually exclusive");m.clip=rb(sb(m.clip))}else if(m.fullPage){if(!m.captureBeyondViewport){const T=await this.mainFrame().isolatedRealm().evaluate(()=>{const S=document.documentElement;return{width:S.scrollWidth,height:S.scrollHeight}}),R=this.viewport();await this.setViewport({...R,...T}),v.defer(async()=>{await this.setViewport(R).catch(Z)})}}else m.captureBeyondViewport=!1;const b=await this._screenshot(m);if(m.encoding==="base64")return b;const E=Buffer.from(b,"base64");return await this._maybeWriteBufferToFile(m.path,E),E}catch(g){p.error=g,p.hasError=!0}finally{const g=ob(p);g&&await g}}async title(){return await this.mainFrame().title()}click(u,p){return this.mainFrame().click(u,p)}focus(u){return this.mainFrame().focus(u)}hover(u){return this.mainFrame().hover(u)}select(u,...p){return this.mainFrame().select(u,...p)}tap(u){return this.mainFrame().tap(u)}type(u,p,g){return this.mainFrame().type(u,p,g)}async waitForSelector(u,p={}){return await this.mainFrame().waitForSelector(u,p)}waitForFunction(u,p,...g){return this.mainFrame().waitForFunction(u,p,...g)}[(e=[YE(function(){return this.browser()})],ue)](){return void this.close().catch(Z)}[Ot](){return this.close()}},a=new WeakMap,i=new WeakMap,s=new WeakMap,r=new WeakMap,(()=>{const u=typeof Symbol=="function"&&Symbol.metadata?Object.create(o[Symbol.metadata]??null):void 0;tb(l,null,e,{kind:"method",name:"screenshot",static:!1,private:!1,access:{has:p=>"screenshot"in p,get:p=>p.screenshot},metadata:u},null,t),u&&Object.defineProperty(l,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:u})})(),l})();function sb(o){return{...o,...o.width<0?{x:o.x+o.width,width:-o.width}:{x:o.x,width:o.width},...o.height<0?{y:o.y+o.height,height:-o.height}:{y:o.y,height:o.height}}}function rb(o){const t=Math.round(o.x),e=Math.round(o.y),a=Math.round(o.width+o.x-t),i=Math.round(o.height+o.y-e);return{...o,x:t,y:e,width:a,height:i}}/**
 * @license
 * Copyright 2020 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var _n,On,Dn,Os;class Cm{constructor(t,e,a,i){h(this,_n);h(this,On);h(this,Dn);h(this,Os);f(this,_n,t),f(this,On,e),f(this,Dn,a),f(this,Os,i)}type(){return n(this,_n)}text(){return n(this,On)}args(){return n(this,Dn)}location(){return n(this,Os)[0]??{}}stackTrace(){return n(this,Os)}}_n=new WeakMap,On=new WeakMap,Dn=new WeakMap,Os=new WeakMap;/**
 * @license
 * Copyright 2020 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Ds,Mn,Ya;class nb{constructor(t,e){h(this,Ds);h(this,Mn);h(this,Ya,!1);f(this,Ds,t),f(this,Mn,e.mode!=="selectSingle")}isMultiple(){return n(this,Mn)}async accept(t){L(!n(this,Ya),"Cannot accept FileChooser which is already handled!"),f(this,Ya,!0),await n(this,Ds).uploadFile(...t)}async cancel(){L(!n(this,Ya),"Cannot cancel FileChooser which is already handled!"),f(this,Ya,!0),await n(this,Ds).evaluate(t=>{t.dispatchEvent(new Event("cancel",{bubbles:!0}))})}}Ds=new WeakMap,Mn=new WeakMap,Ya=new WeakMap;/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var De;(function(o){o.Request=Symbol("NetworkManager.Request"),o.RequestServedFromCache=Symbol("NetworkManager.RequestServedFromCache"),o.Response=Symbol("NetworkManager.Response"),o.RequestFailed=Symbol("NetworkManager.RequestFailed"),o.RequestFinished=Symbol("NetworkManager.RequestFinished")})(De||(De={}));/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Rm=function(o,t,e){for(var a=arguments.length>2,i=0;i<t.length;i++)e=a?t[i].call(o,e):t[i].call(o);return a?e:void 0},su=function(o,t,e,a,i,s){function r(T){if(T!==void 0&&typeof T!="function")throw new TypeError("Function expected");return T}for(var l=a.kind,c=l==="getter"?"get":l==="setter"?"set":"value",d=!t&&o?a.static?o:o.prototype:null,u=t||(d?Object.getOwnPropertyDescriptor(d,a.name):{}),p,g=!1,m=e.length-1;m>=0;m--){var v={};for(var b in a)v[b]=b==="access"?{}:a[b];for(var b in a.access)v.access[b]=a.access[b];v.addInitializer=function(T){if(g)throw new TypeError("Cannot add initializers after decoration has completed");s.push(r(T||null))};var E=(0,e[m])(l==="accessor"?{get:u.get,set:u.set}:u[c],v);if(l==="accessor"){if(E===void 0)continue;if(E===null||typeof E!="object")throw new TypeError("Object expected");(p=r(E.get))&&(u.get=p),(p=r(E.set))&&(u.set=p),(p=r(E.init))&&i.unshift(p)}else(p=r(E))&&(l==="field"?i.unshift(p):u[c]=p)}d&&Object.defineProperty(d,a.name,u),g=!0},lb=function(o,t,e){if(t!=null){if(typeof t!="object"&&typeof t!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=t[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=t[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");o.stack.push({value:t,dispose:a,async:e})}else e&&o.stack.push({async:!0});return t},cb=(function(o){return function(t){function e(i){t.error=t.hasError?new o(i,t.error,"An error was suppressed during disposal."):i,t.hasError=!0}function a(){for(;t.stack.length;){var i=t.stack.pop();try{var s=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(s).then(a,function(r){return e(r),a()})}catch(r){e(r)}}if(t.hasError)throw t.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(o,t,e){var a=new Error(e);return a.name="SuppressedError",a.error=o,a.suppressed=t,a});let as=(()=>{var l;let o=[ZE],t,e=[],a,i=[],s,r;return l=class{constructor(){Rm(this,i)}async evaluate(d,...u){return d=ze(this.evaluate.name,d),await this.realm.evaluate(d,this,...u)}async evaluateHandle(d,...u){return d=ze(this.evaluateHandle.name,d),await this.realm.evaluateHandle(d,this,...u)}async getProperty(d){return await this.evaluateHandle((u,p)=>u[p],d)}async getProperties(){const d=await this.evaluate(g=>{var b;const m=[],v=Object.getOwnPropertyDescriptors(g);for(const E in v)(b=v[E])!=null&&b.enumerable&&m.push(E);return m}),u=new Map,p=await Promise.all(d.map(g=>this.getProperty(g)));for(const[g,m]of Object.entries(d)){const v={stack:[],error:void 0,hasError:!1};try{const b=lb(v,p[g],!1);b&&u.set(m,b.move())}catch(b){v.error=b,v.hasError=!0}finally{cb(v)}}return u}[(s=[Q()],r=[Q()],ue)](){return void this.dispose().catch(Z)}[Ot](){return this.dispose()}},a=l,(()=>{const d=typeof Symbol=="function"&&Symbol.metadata?Object.create(null):void 0;su(l,null,s,{kind:"method",name:"getProperty",static:!1,private:!1,access:{has:u=>"getProperty"in u,get:u=>u.getProperty},metadata:d},null,i),su(l,null,r,{kind:"method",name:"getProperties",static:!1,private:!1,access:{has:u=>"getProperties"in u,get:u=>u.getProperties},metadata:d},null,i),su(null,t={value:a},o,{kind:"class",name:a.name,metadata:d},null,e),a=t.value,d&&Object.defineProperty(a,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:d}),Rm(a,e)})(),a})();var db=function(o,t,e){if(t!=null){if(typeof t!="object"&&typeof t!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=t[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=t[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");o.stack.push({value:t,dispose:a,async:e})}else e&&o.stack.push({async:!0});return t},ub=(function(o){return function(t){function e(i){t.error=t.hasError?new o(i,t.error,"An error was suppressed during disposal."):i,t.hasError=!0}function a(){for(;t.stack.length;){var i=t.stack.pop();try{var s=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(s).then(a,function(r){return e(r),a()})}catch(r){e(r)}}if(t.hasError)throw t.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(o,t,e){var a=new Error(e);return a.name="SuppressedError",a.error=o,a.suppressed=t,a}),lo,zn,Ln;class gd{constructor(t,e,a){h(this,lo);h(this,zn);h(this,Ln);f(this,lo,t),f(this,zn,e),f(this,Ln,a)}get name(){return n(this,lo)}get initSource(){return n(this,Ln)}async run(t,e,a,i){const s=new To;try{if(!i){const r={stack:[],error:void 0,hasError:!1};try{const c=await db(r,await t.evaluateHandle((d,u)=>globalThis[d].args.get(u),n(this,lo),e),!1).getProperties();for(const[d,u]of c)if(d in a)switch(u.remoteObject().subtype){case"node":a[+d]=u;break;default:s.use(u)}else s.use(u)}catch(l){r.error=l,r.hasError=!0}finally{ub(r)}}await t.evaluate((r,l,c)=>{const d=globalThis[r].callbacks;d.get(l).resolve(c),d.delete(l)},n(this,lo),e,await n(this,zn).call(this,...a));for(const r of a)r instanceof as&&s.use(r)}catch(r){Xt(r)?await t.evaluate((l,c,d,u)=>{const p=new Error(d);p.stack=u;const g=globalThis[l].callbacks;g.get(c).reject(p),g.delete(c)},n(this,lo),e,r.message,r.stack).catch(Z):await t.evaluate((l,c,d)=>{const u=globalThis[l].callbacks;u.get(c).reject(d),u.delete(c)},n(this,lo),e,r).catch(Z)}}}lo=new WeakMap,zn=new WeakMap,Ln=new WeakMap;/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const pb=Lp("puppeteer:protocol:SEND ‚ñ∫"),mb=Lp("puppeteer:protocol:RECV ‚óÄ");var Nn,Ut,Xa,Ms,Ze,Ja,zs,Go,Pn,xu;class Ph extends ye{constructor(e,a,i=0,s){super();h(this,Pn);h(this,Nn);h(this,Ut);h(this,Xa);h(this,Ms);h(this,Ze,new Map);h(this,Ja,!1);h(this,zs,new Set);h(this,Go,new Oh);f(this,Nn,e),f(this,Xa,i),f(this,Ms,s??18e4),f(this,Ut,a),n(this,Ut).onmessage=this.onMessage.bind(this),n(this,Ut).onclose=w(this,Pn,xu).bind(this)}static fromSession(e){return e.connection()}get delay(){return n(this,Xa)}get timeout(){return n(this,Ms)}get _closed(){return n(this,Ja)}get _sessions(){return n(this,Ze)}session(e){return n(this,Ze).get(e)||null}url(){return n(this,Nn)}send(e,a,i){return this._rawSend(n(this,Go),e,a,void 0,i)}_rawSend(e,a,i,s,r){return n(this,Ja)?Promise.reject(new Error("Protocol error: Connection closed.")):e.create(a,(r==null?void 0:r.timeout)??n(this,Ms),l=>{const c=JSON.stringify({method:a,params:i,id:l,sessionId:s});pb(c),n(this,Ut).send(c)})}async closeBrowser(){await this.send("Browser.close")}async onMessage(e){n(this,Xa)&&await new Promise(i=>setTimeout(i,n(this,Xa))),mb(e);const a=JSON.parse(e);if(a.method==="Target.attachedToTarget"){const i=a.params.sessionId,s=new ns(this,a.params.targetInfo.type,i,a.sessionId);n(this,Ze).set(i,s),this.emit(ge.SessionAttached,s);const r=n(this,Ze).get(a.sessionId);r&&r.emit(ge.SessionAttached,s)}else if(a.method==="Target.detachedFromTarget"){const i=n(this,Ze).get(a.params.sessionId);if(i){i._onClosed(),n(this,Ze).delete(a.params.sessionId),this.emit(ge.SessionDetached,i);const s=n(this,Ze).get(a.sessionId);s&&s.emit(ge.SessionDetached,i)}}if(a.sessionId){const i=n(this,Ze).get(a.sessionId);i&&i._onMessage(a)}else a.id?a.error?n(this,Go).reject(a.id,_h(a),a.error.message):n(this,Go).resolve(a.id,a.result):this.emit(a.method,a.params)}dispose(){w(this,Pn,xu).call(this),n(this,Ut).close()}isAutoAttached(e){return!n(this,zs).has(e)}async _createSession(e,a=!0){a||n(this,zs).add(e.targetId);const{sessionId:i}=await this.send("Target.attachToTarget",{targetId:e.targetId,flatten:!0});n(this,zs).delete(e.targetId);const s=n(this,Ze).get(i);if(!s)throw new Error("CDPSession creation failed.");return s}async createSession(e){return await this._createSession(e,!1)}getPendingProtocolErrors(){const e=[];e.push(...n(this,Go).getPendingProtocolErrors());for(const a of n(this,Ze).values())e.push(...a.getPendingProtocolErrors());return e}}Nn=new WeakMap,Ut=new WeakMap,Xa=new WeakMap,Ms=new WeakMap,Ze=new WeakMap,Ja=new WeakMap,zs=new WeakMap,Go=new WeakMap,Pn=new WeakSet,xu=function(){if(!n(this,Ja)){f(this,Ja,!0),n(this,Ut).onmessage=void 0,n(this,Ut).onclose=void 0,n(this,Go).clear();for(const e of n(this,Ze).values())e._onClosed();n(this,Ze).clear(),this.emit(ge.Disconnected,void 0)}};function Iu(o){return o instanceof wa}/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Qa,ei;class gb{constructor(t){h(this,Qa);h(this,ei);f(this,Qa,new hb(t)),f(this,ei,new fb(t))}updateClient(t){n(this,Qa).updateClient(t),n(this,ei).updateClient(t)}async startJSCoverage(t={}){return await n(this,Qa).start(t)}async stopJSCoverage(){return await n(this,Qa).stop()}async startCSSCoverage(t={}){return await n(this,ei).start(t)}async stopCSSCoverage(){return await n(this,ei).stop()}}Qa=new WeakMap,ei=new WeakMap;var Ye,ti,oi,ai,Ls,kn,Ns,Ps,Nr,kh,Bh;class hb{constructor(t){h(this,Nr);h(this,Ye);h(this,ti,!1);h(this,oi,new Map);h(this,ai,new Map);h(this,Ls);h(this,kn,!1);h(this,Ns,!1);h(this,Ps,!1);f(this,Ye,t)}updateClient(t){f(this,Ye,t)}async start(t={}){L(!n(this,ti),"JSCoverage is already enabled");const{resetOnNavigation:e=!0,reportAnonymousScripts:a=!1,includeRawScriptCoverage:i=!1,useBlockCoverage:s=!0}=t;f(this,kn,e),f(this,Ns,a),f(this,Ps,i),f(this,ti,!0),n(this,oi).clear(),n(this,ai).clear(),f(this,Ls,new To);const r=n(this,Ls).use(new ye(n(this,Ye)));r.on("Debugger.scriptParsed",w(this,Nr,Bh).bind(this)),r.on("Runtime.executionContextsCleared",w(this,Nr,kh).bind(this)),await Promise.all([n(this,Ye).send("Profiler.enable"),n(this,Ye).send("Profiler.startPreciseCoverage",{callCount:n(this,Ps),detailed:s}),n(this,Ye).send("Debugger.enable"),n(this,Ye).send("Debugger.setSkipAllPauses",{skip:!0})])}async stop(){var i;L(n(this,ti),"JSCoverage is not enabled"),f(this,ti,!1);const t=await Promise.all([n(this,Ye).send("Profiler.takePreciseCoverage"),n(this,Ye).send("Profiler.stopPreciseCoverage"),n(this,Ye).send("Profiler.disable"),n(this,Ye).send("Debugger.disable")]);(i=n(this,Ls))==null||i.dispose();const e=[],a=t[0];for(const s of a.result){let r=n(this,oi).get(s.scriptId);!r&&n(this,Ns)&&(r="debugger://VM"+s.scriptId);const l=n(this,ai).get(s.scriptId);if(l===void 0||r===void 0)continue;const c=[];for(const u of s.functions)c.push(...u.ranges);const d=Uh(c);n(this,Ps)?e.push({url:r,ranges:d,text:l,rawScriptCoverage:s}):e.push({url:r,ranges:d,text:l})}return e}}Ye=new WeakMap,ti=new WeakMap,oi=new WeakMap,ai=new WeakMap,Ls=new WeakMap,kn=new WeakMap,Ns=new WeakMap,Ps=new WeakMap,Nr=new WeakSet,kh=function(){n(this,kn)&&(n(this,oi).clear(),n(this,ai).clear())},Bh=async function(t){if(!wo.isPuppeteerURL(t.url)&&!(!t.url&&!n(this,Ns)))try{const e=await n(this,Ye).send("Debugger.getScriptSource",{scriptId:t.scriptId});n(this,oi).set(t.scriptId,t.url),n(this,ai).set(t.scriptId,e.scriptSource)}catch(e){Z(e)}};var nt,ii,Ko,si,ks,Bn,Pr,Fh,$h;class fb{constructor(t){h(this,Pr);h(this,nt);h(this,ii,!1);h(this,Ko,new Map);h(this,si,new Map);h(this,ks);h(this,Bn,!1);f(this,nt,t)}updateClient(t){f(this,nt,t)}async start(t={}){L(!n(this,ii),"CSSCoverage is already enabled");const{resetOnNavigation:e=!0}=t;f(this,Bn,e),f(this,ii,!0),n(this,Ko).clear(),n(this,si).clear(),f(this,ks,new To);const a=n(this,ks).use(new ye(n(this,nt)));a.on("CSS.styleSheetAdded",w(this,Pr,$h).bind(this)),a.on("Runtime.executionContextsCleared",w(this,Pr,Fh).bind(this)),await Promise.all([n(this,nt).send("DOM.enable"),n(this,nt).send("CSS.enable"),n(this,nt).send("CSS.startRuleUsageTracking")])}async stop(){var i;L(n(this,ii),"CSSCoverage is not enabled"),f(this,ii,!1);const t=await n(this,nt).send("CSS.stopRuleUsageTracking");await Promise.all([n(this,nt).send("CSS.disable"),n(this,nt).send("DOM.disable")]),(i=n(this,ks))==null||i.dispose();const e=new Map;for(const s of t.ruleUsage){let r=e.get(s.styleSheetId);r||(r=[],e.set(s.styleSheetId,r)),r.push({startOffset:s.startOffset,endOffset:s.endOffset,count:s.used?1:0})}const a=[];for(const s of n(this,Ko).keys()){const r=n(this,Ko).get(s);L(typeof r<"u",`Stylesheet URL is undefined (styleSheetId=${s})`);const l=n(this,si).get(s);L(typeof l<"u",`Stylesheet text is undefined (styleSheetId=${s})`);const c=Uh(e.get(s)||[]);a.push({url:r,ranges:c,text:l})}return a}}nt=new WeakMap,ii=new WeakMap,Ko=new WeakMap,si=new WeakMap,ks=new WeakMap,Bn=new WeakMap,Pr=new WeakSet,Fh=function(){n(this,Bn)&&(n(this,Ko).clear(),n(this,si).clear())},$h=async function(t){const e=t.header;if(e.sourceURL)try{const a=await n(this,nt).send("CSS.getStyleSheetText",{styleSheetId:e.styleSheetId});n(this,Ko).set(e.styleSheetId,e.sourceURL),n(this,si).set(e.styleSheetId,a.text)}catch(a){Z(a)}};function Uh(o){const t=[];for(const s of o)t.push({offset:s.startOffset,type:0,range:s}),t.push({offset:s.endOffset,type:1,range:s});t.sort((s,r)=>{if(s.offset!==r.offset)return s.offset-r.offset;if(s.type!==r.type)return r.type-s.type;const l=s.range.endOffset-s.range.startOffset,c=r.range.endOffset-r.range.startOffset;return s.type===0?c-l:l-c});const e=[],a=[];let i=0;for(const s of t){if(e.length&&i<s.offset&&e[e.length-1]>0){const r=a[a.length-1];r&&r.end===i?r.end=s.offset:a.push({start:i,end:s.offset})}i=s.offset,s.type===0?e.push(s.range.count):e.pop()}return a.filter(s=>s.end-s.start>0)}/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Fn,$n,Un;class vb{constructor(t,e,a=""){h(this,Fn);h(this,$n);h(this,Un);_(this,"handled",!1);f(this,Fn,t),f(this,$n,e),f(this,Un,a)}type(){return n(this,Fn)}message(){return n(this,$n)}defaultValue(){return n(this,Un)}async accept(t){L(!this.handled,"Cannot accept dialog which is already handled!"),this.handled=!0,await this.handle({accept:!0,text:t})}async dismiss(){L(!this.handled,"Cannot dismiss dialog which is already handled!"),this.handled=!0,await this.handle({accept:!1})}}Fn=new WeakMap,$n=new WeakMap,Un=new WeakMap;/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var jn;class Eb extends vb{constructor(e,a,i,s=""){super(a,i,s);h(this,jn);f(this,jn,e)}async handle(e){await n(this,jn).send("Page.handleJavaScriptDialog",{accept:e.accept,promptText:e.text})}}jn=new WeakMap;var bb=function(o,t,e){for(var a=arguments.length>2,i=0;i<t.length;i++)e=a?t[i].call(o,e):t[i].call(o);return a?e:void 0},Nt=function(o,t,e,a,i,s){function r(T){if(T!==void 0&&typeof T!="function")throw new TypeError("Function expected");return T}for(var l=a.kind,c=l==="getter"?"get":l==="setter"?"set":"value",d=!t&&o?a.static?o:o.prototype:null,u=t||(d?Object.getOwnPropertyDescriptor(d,a.name):{}),p,g=!1,m=e.length-1;m>=0;m--){var v={};for(var b in a)v[b]=b==="access"?{}:a[b];for(var b in a.access)v.access[b]=a.access[b];v.addInitializer=function(T){if(g)throw new TypeError("Cannot add initializers after decoration has completed");s.push(r(T||null))};var E=(0,e[m])(l==="accessor"?{get:u.get,set:u.set}:u[c],v);if(l==="accessor"){if(E===void 0)continue;if(E===null||typeof E!="object")throw new TypeError("Object expected");(p=r(E.get))&&(u.get=p),(p=r(E.set))&&(u.set=p),(p=r(E.init))&&i.unshift(p)}else(p=r(E))&&(l==="field"?i.unshift(p):u[c]=p)}d&&Object.defineProperty(d,a.name,u),g=!0},Pt=function(o,t,e){return typeof t=="symbol"&&(t=t.description?"[".concat(t.description,"]"):""),Object.defineProperty(o,"name",{configurable:!0,value:e?"".concat(e," ",t):t})},ri,Bs,Hn;class kt{constructor(t,e,a){h(this,ri);h(this,Bs);h(this,Hn);f(this,ri,t),f(this,Bs,e),f(this,Hn,a),n(this,Bs).registerState(this)}async setState(t){f(this,ri,t),await this.sync()}get state(){return n(this,ri)}async sync(){await Promise.all(n(this,Bs).clients().map(t=>n(this,Hn).call(this,t,n(this,ri))))}}ri=new WeakMap,Bs=new WeakMap,Hn=new WeakMap;let yb=(()=>{var M,B,j,N,D,Y,$,O,x,k,z,ee,ae,te,pe,V,Su,Au,Cu,Ru,_u,Ou,Du,Mu,zu,Lu,Ie;let o=[],t,e,a,i,s,r,l,c,d,u,p,g,m,v,b,E,T,R,S,C;return Ie=class{constructor(W){h(this,V);h(this,M,bb(this,o));h(this,B,!1);h(this,j,!1);h(this,N,[]);h(this,D,new kt({active:!1},this,n(this,V,Su)));h(this,Y,new kt({active:!1},this,n(this,V,Au)));h(this,$,new kt({active:!1},this,n(this,V,Cu)));h(this,O,new kt({active:!1},this,n(this,V,Ru)));h(this,x,new kt({active:!1},this,n(this,V,_u)));h(this,k,new kt({active:!1},this,n(this,V,Ou)));h(this,z,new kt({active:!1},this,n(this,V,Du)));h(this,ee,new kt({active:!1},this,n(this,V,Mu)));h(this,ae,new kt({active:!1},this,n(this,V,zu)));h(this,te,new kt({javaScriptEnabled:!0,active:!1},this,n(this,V,Lu)));h(this,pe,new Set);f(this,M,W)}updateClient(W){f(this,M,W),n(this,pe).delete(W)}registerState(W){n(this,N).push(W)}clients(){return[n(this,M),...Array.from(n(this,pe))]}async registerSpeculativeSession(W){n(this,pe).add(W),W.once(ge.Disconnected,()=>{n(this,pe).delete(W)}),Promise.all(n(this,N).map(P=>P.sync().catch(Z)))}get javascriptEnabled(){return n(this,te).state.javaScriptEnabled}async emulateViewport(W){const P=n(this,D).state;if(!W&&!P.active)return!1;await n(this,D).setState(W?{viewport:W,active:!0}:{active:!1});const q=(W==null?void 0:W.isMobile)||!1,we=(W==null?void 0:W.hasTouch)||!1,Gi=n(this,B)!==q||n(this,j)!==we;return f(this,B,q),f(this,j,we),Gi}async emulateIdleState(W){await n(this,Y).setState({active:!0,overrides:W})}async emulateTimezone(W){await n(this,$).setState({timezoneId:W,active:!0})}async emulateVisionDeficiency(W){L(!W||new Set(["none","achromatopsia","blurredVision","deuteranopia","protanopia","tritanopia"]).has(W),`Unsupported vision deficiency: ${W}`),await n(this,O).setState({active:!0,visionDeficiency:W})}async emulateCPUThrottling(W){L(W===null||W>=1,"Throttling rate should be greater or equal to 1"),await n(this,x).setState({active:!0,factor:W??void 0})}async emulateMediaFeatures(W){if(Array.isArray(W))for(const P of W){const q=P.name;L(/^(?:prefers-(?:color-scheme|reduced-motion)|color-gamut)$/.test(q),"Unsupported media feature: "+q)}await n(this,k).setState({active:!0,mediaFeatures:W})}async emulateMediaType(W){L(W==="screen"||W==="print"||(W??void 0)===void 0,"Unsupported media type: "+W),await n(this,z).setState({type:W,active:!0})}async setGeolocation(W){const{longitude:P,latitude:q,accuracy:we=0}=W;if(P<-180||P>180)throw new Error(`Invalid longitude "${P}": precondition -180 <= LONGITUDE <= 180 failed.`);if(q<-90||q>90)throw new Error(`Invalid latitude "${q}": precondition -90 <= LATITUDE <= 90 failed.`);if(we<0)throw new Error(`Invalid accuracy "${we}": precondition 0 <= ACCURACY failed.`);await n(this,ee).setState({active:!0,geoLocation:{longitude:P,latitude:q,accuracy:we}})}async resetDefaultBackgroundColor(){await n(this,ae).setState({active:!0,color:void 0})}async setTransparentBackgroundColor(){await n(this,ae).setState({active:!0,color:{r:0,g:0,b:0,a:0}})}async setJavaScriptEnabled(W){await n(this,te).setState({active:!0,javaScriptEnabled:W})}},M=new WeakMap,B=new WeakMap,j=new WeakMap,N=new WeakMap,D=new WeakMap,Y=new WeakMap,$=new WeakMap,O=new WeakMap,x=new WeakMap,k=new WeakMap,z=new WeakMap,ee=new WeakMap,ae=new WeakMap,te=new WeakMap,pe=new WeakMap,V=new WeakSet,Su=function(){return e.value},Au=function(){return i.value},Cu=function(){return r.value},Ru=function(){return c.value},_u=function(){return u.value},Ou=function(){return g.value},Du=function(){return v.value},Mu=function(){return E.value},zu=function(){return R.value},Lu=function(){return C.value},(()=>{const W=typeof Symbol=="function"&&Symbol.metadata?Object.create(null):void 0;t=[Lt],a=[Lt],s=[Lt],l=[Lt],d=[Lt],p=[Lt],m=[Lt],b=[Lt],T=[Lt],S=[Lt],Nt(Ie,e={value:Pt(async function(P,q){if(!q.viewport){await Promise.all([P.send("Emulation.clearDeviceMetricsOverride"),P.send("Emulation.setTouchEmulationEnabled",{enabled:!1})]).catch(Z);return}const{viewport:we}=q,Gi=we.isMobile||!1,wc=we.width,Tc=we.height,xc=we.deviceScaleFactor??1,Ic=we.isLandscape?{angle:90,type:"landscapePrimary"}:{angle:0,type:"portraitPrimary"},Sc=we.hasTouch||!1;await Promise.all([P.send("Emulation.setDeviceMetricsOverride",{mobile:Gi,width:wc,height:Tc,deviceScaleFactor:xc,screenOrientation:Ic}).catch(Ki=>{if(Ki.message.includes("Target does not support metrics override")){Z(Ki);return}throw Ki}),P.send("Emulation.setTouchEmulationEnabled",{enabled:Sc})])},"#applyViewport")},t,{kind:"method",name:"#applyViewport",static:!1,private:!0,access:{has:P=>mt(V,P),get:P=>n(P,V,Su)},metadata:W},null,o),Nt(Ie,i={value:Pt(async function(P,q){q.active&&(q.overrides?await P.send("Emulation.setIdleOverride",{isUserActive:q.overrides.isUserActive,isScreenUnlocked:q.overrides.isScreenUnlocked}):await P.send("Emulation.clearIdleOverride"))},"#emulateIdleState")},a,{kind:"method",name:"#emulateIdleState",static:!1,private:!0,access:{has:P=>mt(V,P),get:P=>n(P,V,Au)},metadata:W},null,o),Nt(Ie,r={value:Pt(async function(P,q){if(q.active)try{await P.send("Emulation.setTimezoneOverride",{timezoneId:q.timezoneId||""})}catch(we){throw Xt(we)&&we.message.includes("Invalid timezone")?new Error(`Invalid timezone ID: ${q.timezoneId}`):we}},"#emulateTimezone")},s,{kind:"method",name:"#emulateTimezone",static:!1,private:!0,access:{has:P=>mt(V,P),get:P=>n(P,V,Cu)},metadata:W},null,o),Nt(Ie,c={value:Pt(async function(P,q){q.active&&await P.send("Emulation.setEmulatedVisionDeficiency",{type:q.visionDeficiency||"none"})},"#emulateVisionDeficiency")},l,{kind:"method",name:"#emulateVisionDeficiency",static:!1,private:!0,access:{has:P=>mt(V,P),get:P=>n(P,V,Ru)},metadata:W},null,o),Nt(Ie,u={value:Pt(async function(P,q){q.active&&await P.send("Emulation.setCPUThrottlingRate",{rate:q.factor??1})},"#emulateCpuThrottling")},d,{kind:"method",name:"#emulateCpuThrottling",static:!1,private:!0,access:{has:P=>mt(V,P),get:P=>n(P,V,_u)},metadata:W},null,o),Nt(Ie,g={value:Pt(async function(P,q){q.active&&await P.send("Emulation.setEmulatedMedia",{features:q.mediaFeatures})},"#emulateMediaFeatures")},p,{kind:"method",name:"#emulateMediaFeatures",static:!1,private:!0,access:{has:P=>mt(V,P),get:P=>n(P,V,Ou)},metadata:W},null,o),Nt(Ie,v={value:Pt(async function(P,q){q.active&&await P.send("Emulation.setEmulatedMedia",{media:q.type||""})},"#emulateMediaType")},m,{kind:"method",name:"#emulateMediaType",static:!1,private:!0,access:{has:P=>mt(V,P),get:P=>n(P,V,Du)},metadata:W},null,o),Nt(Ie,E={value:Pt(async function(P,q){q.active&&await P.send("Emulation.setGeolocationOverride",q.geoLocation?{longitude:q.geoLocation.longitude,latitude:q.geoLocation.latitude,accuracy:q.geoLocation.accuracy}:void 0)},"#setGeolocation")},b,{kind:"method",name:"#setGeolocation",static:!1,private:!0,access:{has:P=>mt(V,P),get:P=>n(P,V,Mu)},metadata:W},null,o),Nt(Ie,R={value:Pt(async function(P,q){q.active&&await P.send("Emulation.setDefaultBackgroundColorOverride",{color:q.color})},"#setDefaultBackgroundColor")},T,{kind:"method",name:"#setDefaultBackgroundColor",static:!1,private:!0,access:{has:P=>mt(V,P),get:P=>n(P,V,zu)},metadata:W},null,o),Nt(Ie,C={value:Pt(async function(P,q){q.active&&await P.send("Emulation.setScriptExecutionDisabled",{value:!q.javaScriptEnabled})},"#setJavaScriptEnabled")},S,{kind:"method",name:"#setJavaScriptEnabled",static:!1,private:!0,access:{has:P=>mt(V,P),get:P=>n(P,V,Lu)},metadata:W},null,o),W&&Object.defineProperty(Ie,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:W})})(),Ie})();/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var ht,ni,jt,Vn,Fs,$s,qo,Wn,Us,Cd,Gn,Kn,Rd,li,Kr;class jh extends ye{constructor(e,a,i){super();h(this,li);h(this,ht);h(this,ni,new Map);h(this,jt,new Map);h(this,Vn,new Map);h(this,Fs);h(this,$s);h(this,qo,new WeakMap);h(this,Wn,de.create());h(this,Us,new Set);h(this,Cd,e=>{this.removeSessionListeners(e),n(this,Vn).delete(e.id())});h(this,Gn,async e=>{if(n(this,ni).has(e.targetInfo.targetId))return;if(n(this,ni).set(e.targetInfo.targetId,e.targetInfo),e.targetInfo.type==="browser"&&e.targetInfo.attached){const i=n(this,$s).call(this,e.targetInfo,void 0);i._initialize(),n(this,jt).set(e.targetInfo.targetId,i),w(this,li,Kr).call(this,i._targetId);return}const a=n(this,$s).call(this,e.targetInfo,void 0);if(n(this,Fs)&&!n(this,Fs).call(this,a)){w(this,li,Kr).call(this,e.targetInfo.targetId);return}a._initialize(),n(this,jt).set(e.targetInfo.targetId,a),this.emit("targetAvailable",a),w(this,li,Kr).call(this,a._targetId)});h(this,Kn,e=>{n(this,ni).delete(e.targetId),w(this,li,Kr).call(this,e.targetId);const a=n(this,jt).get(e.targetId);a&&(this.emit("targetGone",a),n(this,jt).delete(e.targetId))});h(this,Rd,async(e,a)=>{const i=a.targetInfo,s=n(this,ht).session(a.sessionId);if(!s)throw new Error(`Session ${a.sessionId} was not created.`);const r=n(this,jt).get(i.targetId);L(r,`Target ${i.targetId} is missing`),s._setTarget(r),this.setupAttachmentListeners(s),n(this,Vn).set(s.id(),n(this,jt).get(i.targetId)),e.emit(ge.Ready,s)});f(this,ht,e),f(this,Fs,i),f(this,$s,a),n(this,ht).on("Target.targetCreated",n(this,Gn)),n(this,ht).on("Target.targetDestroyed",n(this,Kn)),n(this,ht).on(ge.SessionDetached,n(this,Cd)),this.setupAttachmentListeners(n(this,ht))}setupAttachmentListeners(e){const a=i=>n(this,Rd).call(this,e,i);L(!n(this,qo).has(e)),n(this,qo).set(e,a),e.on("Target.attachedToTarget",a)}removeSessionListeners(e){n(this,qo).has(e)&&(e.off("Target.attachedToTarget",n(this,qo).get(e)),n(this,qo).delete(e))}getAvailableTargets(){return n(this,jt)}getChildTargets(e){return new Set}dispose(){n(this,ht).off("Target.targetCreated",n(this,Gn)),n(this,ht).off("Target.targetDestroyed",n(this,Kn))}async initialize(){await n(this,ht).send("Target.setDiscoverTargets",{discover:!0,filter:[{}]}),f(this,Us,new Set(n(this,ni).keys())),await n(this,Wn).valueOrThrow()}}ht=new WeakMap,ni=new WeakMap,jt=new WeakMap,Vn=new WeakMap,Fs=new WeakMap,$s=new WeakMap,qo=new WeakMap,Wn=new WeakMap,Us=new WeakMap,Cd=new WeakMap,Gn=new WeakMap,Kn=new WeakMap,Rd=new WeakMap,li=new WeakSet,Kr=function(e){n(this,Us).delete(e),n(this,Us).size===0&&n(this,Wn).resolve()};/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const Vc=Symbol("_isElementHandle");/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const _m=new Map,wb=o=>{let t=_m.get(o);return t||(t=new Function(`return ${o}`)(),_m.set(o,t),t)};function Ta(o){var e;let t;return typeof o=="function"&&((e=globalThis.navigator)==null?void 0:e.userAgent)==="Cloudflare-Workers"?t=`((__name => (${o}))(t => t))`:t=o.toString(),t}const en=(o,t)=>{let e=Ta(o);for(const[a,i]of Object.entries(t))e=e.replace(new RegExp(`PLACEHOLDER\\(\\s*(?:'${a}'|"${a}")\\s*\\)`,"g"),`(${i})`);return wb(e)};/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Wc=function(o,t,e){if(t!=null){if(typeof t!="object"&&typeof t!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=t[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=t[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");o.stack.push({value:t,dispose:a,async:e})}else e&&o.stack.push({async:!0});return t},Nu=(function(o){return function(t){function e(i){t.error=t.hasError?new o(i,t.error,"An error was suppressed during disposal."):i,t.hasError=!0}function a(){for(;t.stack.length;){var i=t.stack.pop();try{var s=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(s).then(a,function(r){return e(r),a()})}catch(r){e(r)}}if(t.hasError)throw t.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(o,t,e){var a=new Error(e);return a.name="SuppressedError",a.error=o,a.suppressed=t,a});const Tb=20;async function*xb(o,t){const e={stack:[],error:void 0,hasError:!1};try{const i=await Wc(e,await o.evaluateHandle(async(l,c)=>{const d=[];for(;d.length<c;){const u=await l.next();if(u.done)break;d.push(u.value)}return d},t),!1).getProperties(),s=i.values();return Wc(e,new To,!1).defer(()=>{for(const l of s){const c={stack:[],error:void 0,hasError:!1};try{Wc(c,l,!1)[ue]()}catch(d){c.error=d,c.hasError=!0}finally{Nu(c)}}}),yield*s,i.size===0}catch(a){e.error=a,e.hasError=!0}finally{Nu(e)}}async function*Ib(o){let t=Tb;for(;!(yield*xb(o,t));)t<<=1}async function*Hh(o){const t={stack:[],error:void 0,hasError:!1};try{const e=Wc(t,await o.evaluateHandle(a=>(async function*(){yield*a})()),!1);yield*Ib(e)}catch(e){t.error=e,t.hasError=!0}finally{Nu(t)}}/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var qn;const _d=class _d{constructor(t){h(this,qn);f(this,qn,t)}async get(t){return await n(this,qn).call(this,t)}};qn=new WeakMap,_(_d,"create",t=>new _d(t));let Zt=_d;/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Oc=function(o,t,e){if(t!=null){if(typeof t!="object"&&typeof t!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=t[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=t[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");o.stack.push({value:t,dispose:a,async:e})}else e&&o.stack.push({async:!0});return t},Dc=(function(o){return function(t){function e(i){t.error=t.hasError?new o(i,t.error,"An error was suppressed during disposal."):i,t.hasError=!0}function a(){for(;t.stack.length;){var i=t.stack.pop();try{var s=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(s).then(a,function(r){return e(r),a()})}catch(r){e(r)}}if(t.hasError)throw t.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(o,t,e){var a=new Error(e);return a.name="SuppressedError",a.error=o,a.suppressed=t,a});class xo{static get _querySelector(){if(this.querySelector)return this.querySelector;if(!this.querySelectorAll)throw new Error("Cannot create default `querySelector`.");return this.querySelector=en(async(t,e,a)=>{const s=PLACEHOLDER("querySelectorAll")(t,e,a);for await(const r of s)return r;return null},{querySelectorAll:Ta(this.querySelectorAll)})}static get _querySelectorAll(){if(this.querySelectorAll)return this.querySelectorAll;if(!this.querySelector)throw new Error("Cannot create default `querySelectorAll`.");return this.querySelectorAll=en(async function*(t,e,a){const s=await PLACEHOLDER("querySelector")(t,e,a);s&&(yield s)},{querySelector:Ta(this.querySelector)})}static async*queryAll(t,e){const a={stack:[],error:void 0,hasError:!1};try{const i=Oc(a,await t.evaluateHandle(this._querySelectorAll,e,Zt.create(s=>s.puppeteerUtil)),!1);yield*Hh(i)}catch(i){a.error=i,a.hasError=!0}finally{Dc(a)}}static async queryOne(t,e){const a={stack:[],error:void 0,hasError:!1};try{const i=Oc(a,await t.evaluateHandle(this._querySelector,e,Zt.create(s=>s.puppeteerUtil)),!1);return Vc in i?i.move():null}catch(i){a.error=i,a.hasError=!0}finally{Dc(a)}}static async waitFor(t,e,a){const i={stack:[],error:void 0,hasError:!1};try{let s;const r=Oc(i,await(async()=>{if(!(Vc in t)){s=t;return}return s=t.frame,await s.isolatedRealm().adoptHandle(t)})(),!1),{visible:l=!1,hidden:c=!1,timeout:d,signal:u}=a,p=a.polling??(l||c?"raf":"mutation");try{const g={stack:[],error:void 0,hasError:!1};try{u==null||u.throwIfAborted();const m=Oc(g,await s.isolatedRealm().waitForFunction(async(v,b,E,T,R)=>{const C=await v.createFunction(b)(T??document,E,v);return v.checkVisibility(C,R)},{polling:p,root:r,timeout:d,signal:u},Zt.create(v=>v.puppeteerUtil),Ta(this._querySelector),e,r,l?!0:c?!1:void 0),!1);if(u!=null&&u.aborted)throw u.reason;return Vc in m?await s.mainRealm().transferHandle(m):null}catch(m){g.error=m,g.hasError=!0}finally{Dc(g)}}catch(g){throw!Xt(g)||g.name==="AbortError"||(g.message=`Waiting for selector \`${e}\` failed: ${g.message}`),g}}catch(s){i.error=s,i.hasError=!0}finally{Dc(i)}}}_(xo,"querySelectorAll"),_(xo,"querySelector");class Gd{static async*map(t,e){for await(const a of t)yield await e(a)}static async*flatMap(t,e){for await(const a of t)yield*e(a)}static async collect(t){const e=[];for await(const a of t)e.push(a);return e}static async first(t){for await(const e of t)return e}}/**
 * @license
 * Copyright 2020 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const Sb=o=>["name","role"].includes(o),Om=o=>o.replace(/ +/g," ").trim(),Ab=/\[\s*(?<attribute>\w+)\s*=\s*(?<quote>"|')(?<value>\\.|.*?(?=\k<quote>))\k<quote>\s*\]/g,Cb=o=>{const t={},e=o.replace(Ab,(a,i,s,r)=>(i=i.trim(),L(Sb(i),`Unknown aria attribute "${i}" in selector`),t[i]=Om(r),""));return e&&!t.name&&(t.name=Om(e)),t},an=class an extends xo{static async*queryAll(t,e){const{name:a,role:i}=Cb(e);yield*t.queryAXTree(a,i)}};_(an,"querySelector",async(t,e,{ariaQuerySelector:a})=>await a(t,e)),_(an,"queryOne",async(t,e)=>await Gd.first(an.queryAll(t,e))??null);let ln=an;/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class hd extends xo{}_(hd,"querySelector",(t,e,{cssQuerySelector:a})=>a(t,e)),_(hd,"querySelectorAll",(t,e,{cssQuerySelectorAll:a})=>a(t,e));const Rb='"use strict";var g=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var Y=Object.prototype.hasOwnProperty;var l=(t,e)=>{for(var r in e)g(t,r,{get:e[r],enumerable:!0})},G=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of B(e))!Y.call(t,n)&&n!==r&&g(t,n,{get:()=>e[n],enumerable:!(o=X(e,n))||o.enumerable});return t};var J=t=>G(g({},"__esModule",{value:!0}),t);var pe={};l(pe,{default:()=>he});module.exports=J(pe);var N=class extends Error{constructor(e,r){super(e,r),this.name=this.constructor.name}get[Symbol.toStringTag](){return this.constructor.name}},p=class extends N{};var c=class t{static create(e){return new t(e)}static async race(e){let r=new Set;try{let o=e.map(n=>n instanceof t?(n.#n&&r.add(n),n.valueOrThrow()):n);return await Promise.race(o)}finally{for(let o of r)o.reject(new Error("Timeout cleared"))}}#e=!1;#r=!1;#o;#t;#a=new Promise(e=>{this.#t=e});#n;#i;constructor(e){e&&e.timeout>0&&(this.#i=new p(e.message),this.#n=setTimeout(()=>{this.reject(this.#i)},e.timeout))}#l(e){clearTimeout(this.#n),this.#o=e,this.#t()}resolve(e){this.#r||this.#e||(this.#e=!0,this.#l(e))}reject(e){this.#r||this.#e||(this.#r=!0,this.#l(e))}resolved(){return this.#e}finished(){return this.#e||this.#r}value(){return this.#o}#s;valueOrThrow(){return this.#s||(this.#s=(async()=>{if(await this.#a,this.#r)throw this.#o;return this.#o})()),this.#s}};var L=new Map,F=t=>{let e=L.get(t);return e||(e=new Function(`return ${t}`)(),L.set(t,e),e)};var x={};l(x,{ariaQuerySelector:()=>z,ariaQuerySelectorAll:()=>b});var z=(t,e)=>globalThis.__ariaQuerySelector(t,e),b=async function*(t,e){yield*await globalThis.__ariaQuerySelectorAll(t,e)};var E={};l(E,{cssQuerySelector:()=>K,cssQuerySelectorAll:()=>Z});var K=(t,e)=>t.querySelector(e),Z=function(t,e){return t.querySelectorAll(e)};var A={};l(A,{customQuerySelectors:()=>P});var v=class{#e=new Map;register(e,r){if(!r.queryOne&&r.queryAll){let o=r.queryAll;r.queryOne=(n,i)=>{for(let s of o(n,i))return s;return null}}else if(r.queryOne&&!r.queryAll){let o=r.queryOne;r.queryAll=(n,i)=>{let s=o(n,i);return s?[s]:[]}}else if(!r.queryOne||!r.queryAll)throw new Error("At least one query method must be defined.");this.#e.set(e,{querySelector:r.queryOne,querySelectorAll:r.queryAll})}unregister(e){this.#e.delete(e)}get(e){return this.#e.get(e)}clear(){this.#e.clear()}},P=new v;var R={};l(R,{pierceQuerySelector:()=>ee,pierceQuerySelectorAll:()=>te});var ee=(t,e)=>{let r=null,o=n=>{let i=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT);do{let s=i.currentNode;s.shadowRoot&&o(s.shadowRoot),!(s instanceof ShadowRoot)&&s!==n&&!r&&s.matches(e)&&(r=s)}while(!r&&i.nextNode())};return t instanceof Document&&(t=t.documentElement),o(t),r},te=(t,e)=>{let r=[],o=n=>{let i=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT);do{let s=i.currentNode;s.shadowRoot&&o(s.shadowRoot),!(s instanceof ShadowRoot)&&s!==n&&s.matches(e)&&r.push(s)}while(i.nextNode())};return t instanceof Document&&(t=t.documentElement),o(t),r};var u=(t,e)=>{if(!t)throw new Error(e)};var y=class{#e;#r;#o;#t;constructor(e,r){this.#e=e,this.#r=r}async start(){let e=this.#t=c.create(),r=await this.#e();if(r){e.resolve(r);return}this.#o=new MutationObserver(async()=>{let o=await this.#e();o&&(e.resolve(o),await this.stop())}),this.#o.observe(this.#r,{childList:!0,subtree:!0,attributes:!0})}async stop(){u(this.#t,"Polling never started."),this.#t.finished()||this.#t.reject(new Error("Polling stopped")),this.#o&&(this.#o.disconnect(),this.#o=void 0)}result(){return u(this.#t,"Polling never started."),this.#t.valueOrThrow()}},w=class{#e;#r;constructor(e){this.#e=e}async start(){let e=this.#r=c.create(),r=await this.#e();if(r){e.resolve(r);return}let o=async()=>{if(e.finished())return;let n=await this.#e();if(!n){window.requestAnimationFrame(o);return}e.resolve(n),await this.stop()};window.requestAnimationFrame(o)}async stop(){u(this.#r,"Polling never started."),this.#r.finished()||this.#r.reject(new Error("Polling stopped"))}result(){return u(this.#r,"Polling never started."),this.#r.valueOrThrow()}},T=class{#e;#r;#o;#t;constructor(e,r){this.#e=e,this.#r=r}async start(){let e=this.#t=c.create(),r=await this.#e();if(r){e.resolve(r);return}this.#o=setInterval(async()=>{let o=await this.#e();o&&(e.resolve(o),await this.stop())},this.#r)}async stop(){u(this.#t,"Polling never started."),this.#t.finished()||this.#t.reject(new Error("Polling stopped")),this.#o&&(clearInterval(this.#o),this.#o=void 0)}result(){return u(this.#t,"Polling never started."),this.#t.valueOrThrow()}};var _={};l(_,{PCombinator:()=>H,pQuerySelector:()=>fe,pQuerySelectorAll:()=>$});var a=class{static async*map(e,r){for await(let o of e)yield await r(o)}static async*flatMap(e,r){for await(let o of e)yield*r(o)}static async collect(e){let r=[];for await(let o of e)r.push(o);return r}static async first(e){for await(let r of e)return r}};var C={};l(C,{textQuerySelectorAll:()=>m});var re=new Set(["checkbox","image","radio"]),oe=t=>t instanceof HTMLSelectElement||t instanceof HTMLTextAreaElement||t instanceof HTMLInputElement&&!re.has(t.type),ne=new Set(["SCRIPT","STYLE"]),f=t=>!ne.has(t.nodeName)&&!document.head?.contains(t),I=new WeakMap,j=t=>{for(;t;)I.delete(t),t instanceof ShadowRoot?t=t.host:t=t.parentNode},W=new WeakSet,se=new MutationObserver(t=>{for(let e of t)j(e.target)}),d=t=>{let e=I.get(t);if(e||(e={full:"",immediate:[]},!f(t)))return e;let r="";if(oe(t))e.full=t.value,e.immediate.push(t.value),t.addEventListener("input",o=>{j(o.target)},{once:!0,capture:!0});else{for(let o=t.firstChild;o;o=o.nextSibling){if(o.nodeType===Node.TEXT_NODE){e.full+=o.nodeValue??"",r+=o.nodeValue??"";continue}r&&e.immediate.push(r),r="",o.nodeType===Node.ELEMENT_NODE&&(e.full+=d(o).full)}r&&e.immediate.push(r),t instanceof Element&&t.shadowRoot&&(e.full+=d(t.shadowRoot).full),W.has(t)||(se.observe(t,{childList:!0,characterData:!0,subtree:!0}),W.add(t))}return I.set(t,e),e};var m=function*(t,e){let r=!1;for(let o of t.childNodes)if(o instanceof Element&&f(o)){let n;o.shadowRoot?n=m(o.shadowRoot,e):n=m(o,e);for(let i of n)yield i,r=!0}r||t instanceof Element&&f(t)&&d(t).full.includes(e)&&(yield t)};var O={};l(O,{checkVisibility:()=>le,pierce:()=>S,pierceAll:()=>k});var ie=["hidden","collapse"],le=(t,e)=>{if(!t)return e===!1;if(e===void 0)return t;let r=t.nodeType===Node.TEXT_NODE?t.parentElement:t,o=window.getComputedStyle(r),n=o&&!ie.includes(o.visibility)&&!ae(r);return e===n?t:!1};function ae(t){let e=t.getBoundingClientRect();return e.width===0||e.height===0}var ce=t=>"shadowRoot"in t&&t.shadowRoot instanceof ShadowRoot;function*S(t){ce(t)?yield t.shadowRoot:yield t}function*k(t){t=S(t).next().value,yield t;let e=[document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT)];for(let r of e){let o;for(;o=r.nextNode();)o.shadowRoot&&(yield o.shadowRoot,e.push(document.createTreeWalker(o.shadowRoot,NodeFilter.SHOW_ELEMENT)))}}var Q={};l(Q,{xpathQuerySelectorAll:()=>q});var q=function*(t,e,r=-1){let n=(t.ownerDocument||document).evaluate(e,t,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE),i=[],s;for(;(s=n.iterateNext())&&(i.push(s),!(r&&i.length===r)););for(let h=0;h<i.length;h++)s=i[h],yield s,delete i[h]};var ue=/[-\\w\\P{ASCII}*]/,H=(r=>(r.Descendent=">>>",r.Child=">>>>",r))(H||{}),V=t=>"querySelectorAll"in t,M=class{#e;#r=[];#o=void 0;elements;constructor(e,r){this.elements=[e],this.#e=r,this.#t()}async run(){if(typeof this.#o=="string")switch(this.#o.trimStart()){case":scope":this.#t();break}for(;this.#o!==void 0;this.#t()){let e=this.#o;typeof e=="string"?e[0]&&ue.test(e[0])?this.elements=a.flatMap(this.elements,async function*(r){V(r)&&(yield*r.querySelectorAll(e))}):this.elements=a.flatMap(this.elements,async function*(r){if(!r.parentElement){if(!V(r))return;yield*r.querySelectorAll(e);return}let o=0;for(let n of r.parentElement.children)if(++o,n===r)break;yield*r.parentElement.querySelectorAll(`:scope>:nth-child(${o})${e}`)}):this.elements=a.flatMap(this.elements,async function*(r){switch(e.name){case"text":yield*m(r,e.value);break;case"xpath":yield*q(r,e.value);break;case"aria":yield*b(r,e.value);break;default:let o=P.get(e.name);if(!o)throw new Error(`Unknown selector type: ${e.name}`);yield*o.querySelectorAll(r,e.value)}})}}#t(){if(this.#r.length!==0){this.#o=this.#r.shift();return}if(this.#e.length===0){this.#o=void 0;return}let e=this.#e.shift();switch(e){case">>>>":{this.elements=a.flatMap(this.elements,S),this.#t();break}case">>>":{this.elements=a.flatMap(this.elements,k),this.#t();break}default:this.#r=e,this.#t();break}}},D=class{#e=new WeakMap;calculate(e,r=[]){if(e===null)return r;e instanceof ShadowRoot&&(e=e.host);let o=this.#e.get(e);if(o)return[...o,...r];let n=0;for(let s=e.previousSibling;s;s=s.previousSibling)++n;let i=this.calculate(e.parentNode,[n]);return this.#e.set(e,i),[...i,...r]}},U=(t,e)=>{if(t.length+e.length===0)return 0;let[r=-1,...o]=t,[n=-1,...i]=e;return r===n?U(o,i):r<n?-1:1},de=async function*(t){let e=new Set;for await(let o of t)e.add(o);let r=new D;yield*[...e.values()].map(o=>[o,r.calculate(o)]).sort(([,o],[,n])=>U(o,n)).map(([o])=>o)},$=function(t,e){let r=JSON.parse(e);if(r.some(o=>{let n=0;return o.some(i=>(typeof i=="string"?++n:n=0,n>1))}))throw new Error("Multiple deep combinators found in sequence.");return de(a.flatMap(r,o=>{let n=new M(t,o);return n.run(),n.elements}))},fe=async function(t,e){for await(let r of $(t,e))return r;return null};var me=Object.freeze({...x,...A,...R,..._,...C,...O,...Q,...E,Deferred:c,createFunction:F,createTextContent:d,IntervalPoller:T,isSuitableNodeForTextMatching:f,MutationPoller:y,RAFPoller:w}),he=me;\n';/**
 * @license
 * Copyright 2024 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var js,Hs,Hi,Pu,Vh;class _b{constructor(){h(this,Hi);h(this,js,!1);h(this,Hs,new Set)}append(t){w(this,Hi,Pu).call(this,()=>{n(this,Hs).add(t)})}pop(t){w(this,Hi,Pu).call(this,()=>{n(this,Hs).delete(t)})}inject(t,e=!1){(n(this,js)||e)&&t(w(this,Hi,Vh).call(this)),f(this,js,!1)}}js=new WeakMap,Hs=new WeakMap,Hi=new WeakSet,Pu=function(t){t(),f(this,js,!0)},Vh=function(){return`(() => {
      const module = {};
      ${Rb}
      ${[...n(this,Hs)].map(t=>`(${t})(module.exports.default);`).join("")}
      return module.exports.default;
    })()`};const Gc=new _b;/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var It;class Ob{constructor(){h(this,It,new Map)}get(t){const e=n(this,It).get(t);return e?e[1]:void 0}register(t,e){var s;L(!n(this,It).has(t),`Cannot register over existing handler: ${t}`),L(/^[a-zA-Z]+$/.test(t),"Custom query handler names may only contain [a-zA-Z]"),L(e.queryAll||e.queryOne,"At least one query method must be implemented.");const a=(s=class extends xo{},_(s,"querySelectorAll",en((r,l,c)=>c.customQuerySelectors.get(PLACEHOLDER("name")).querySelectorAll(r,l),{name:JSON.stringify(t)})),_(s,"querySelector",en((r,l,c)=>c.customQuerySelectors.get(PLACEHOLDER("name")).querySelector(r,l),{name:JSON.stringify(t)})),s),i=en(r=>{r.customQuerySelectors.register(PLACEHOLDER("name"),{queryAll:PLACEHOLDER("queryAll"),queryOne:PLACEHOLDER("queryOne")})},{name:JSON.stringify(t),queryAll:e.queryAll?Ta(e.queryAll):String(void 0),queryOne:e.queryOne?Ta(e.queryOne):String(void 0)}).toString();n(this,It).set(t,[i,a]),Gc.append(i)}unregister(t){const e=n(this,It).get(t);if(!e)throw new Error(`Cannot unregister unknown handler: ${t}`);Gc.pop(e[0]),n(this,It).delete(t)}names(){return[...n(this,It).keys()]}clear(){for(const[t]of n(this,It))Gc.pop(t);n(this,It).clear()}}It=new WeakMap;const ku=new Ob;/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class Bu extends xo{}_(Bu,"querySelector",(t,e,{pierceQuerySelector:a})=>a(t,e)),_(Bu,"querySelectorAll",(t,e,{pierceQuerySelectorAll:a})=>a(t,e));/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class Fu extends xo{}_(Fu,"querySelectorAll",(t,e,{pQuerySelectorAll:a})=>a(t,e)),_(Fu,"querySelector",(t,e,{pQuerySelector:a})=>a(t,e));var zr={attribute:/\[\s*(?:(?<namespace>\*|[-\w\P{ASCII}]*)\|)?(?<name>[-\w\P{ASCII}]+)\s*(?:(?<operator>\W?=)\s*(?<value>.+?)\s*(\s(?<caseSensitive>[iIsS]))?\s*)?\]/gu,id:/#(?<name>[-\w\P{ASCII}]+)/gu,class:/\.(?<name>[-\w\P{ASCII}]+)/gu,comma:/\s*,\s*/g,combinator:/\s*[\s>+~]\s*/g,"pseudo-element":/::(?<name>[-\w\P{ASCII}]+)(?:\((?<argument>¬∂*)\))?/gu,"pseudo-class":/:(?<name>[-\w\P{ASCII}]+)(?:\((?<argument>¬∂*)\))?/gu,universal:/(?:(?<namespace>\*|[-\w\P{ASCII}]*)\|)?\*/gu,type:/(?:(?<namespace>\*|[-\w\P{ASCII}]*)\|)?(?<name>[-\w\P{ASCII}]+)/gu},Db=new Set(["combinator","comma"]),Mb=o=>{switch(o){case"pseudo-element":case"pseudo-class":return new RegExp(zr[o].source.replace("(?<argument>¬∂*)","(?<argument>.*)"),"gu");default:return zr[o]}};function zb(o,t){let e=0,a="";for(;t<o.length;t++){const i=o[t];switch(i){case"(":++e;break;case")":--e;break}if(a+=i,e===0)return a}return a}function Lb(o,t=zr){if(!o)return[];const e=[o];for(const[i,s]of Object.entries(t))for(let r=0;r<e.length;r++){const l=e[r];if(typeof l!="string")continue;s.lastIndex=0;const c=s.exec(l);if(!c)continue;const d=c.index-1,u=[],p=c[0],g=l.slice(0,d+1);g&&u.push(g),u.push({...c.groups,type:i,content:p});const m=l.slice(d+p.length+1);m&&u.push(m),e.splice(r,1,...u)}let a=0;for(const i of e)switch(typeof i){case"string":throw new Error(`Unexpected sequence ${i} found at index ${a}`);case"object":a+=i.content.length,i.pos=[a-i.content.length,a],Db.has(i.type)&&(i.content=i.content.trim()||" ");break}return e}var Nb=/(['"])([^\\\n]+?)\1/g,Pb=/\\./g;function kb(o,t=zr){if(o=o.trim(),o==="")return[];const e=[];o=o.replace(Pb,(s,r)=>(e.push({value:s,offset:r}),"ÓÄÄ".repeat(s.length))),o=o.replace(Nb,(s,r,l,c)=>(e.push({value:s,offset:c}),`${r}${"ÓÄÅ".repeat(l.length)}${r}`));{let s=0,r;for(;(r=o.indexOf("(",s))>-1;){const l=zb(o,r);e.push({value:l,offset:r}),o=`${o.substring(0,r)}(${"¬∂".repeat(l.length-2)})${o.substring(r+l.length)}`,s=r+l.length}}const a=Lb(o,t),i=new Set;for(const s of e.reverse())for(const r of a){const{offset:l,value:c}=s;if(!(r.pos[0]<=l&&l+c.length<=r.pos[1]))continue;const{content:d}=r,u=l-r.pos[0];r.content=d.slice(0,u)+c+d.slice(u+c.length),r.content!==d&&i.add(r)}for(const s of i){const r=Mb(s.type);if(!r)throw new Error(`Unknown token type: ${s.type}`);r.lastIndex=0;const l=r.exec(s.content);if(!l)throw new Error(`Unable to parse content for ${s.type}: ${s.content}`);Object.assign(s,l.groups)}return a}function*Kc(o,t){switch(o.type){case"list":for(let e of o.list)yield*Kc(e,o);break;case"complex":yield*Kc(o.left,o),yield*Kc(o.right,o);break;case"compound":yield*o.list.map(e=>[e,o]);break;default:yield[o,t]}}function jr(o){let t;return Array.isArray(o)?t=o:t=[...Kc(o)].map(([e])=>e),t.map(e=>e.content).join("")}/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */zr.nesting=/&/g;zr.combinator=/\s*(>>>>?|[\s>+~])\s*/g;const Bb=/\\[\s\S]/g,Fb=o=>o.length<=1?o:((o[0]==='"'||o[0]==="'")&&o.endsWith(o[0])&&(o=o.slice(1,-1)),o.replace(Bb,t=>t[1]));function $b(o){let t=!0,e=!1,a=!1;const i=kb(o);if(i.length===0)return[[],t,a,!1];let s=[],r=[s];const l=[r],c=[];for(const d of i){switch(d.type){case"combinator":switch(d.content){case">>>":t=!1,c.length&&(s.push(jr(c)),c.splice(0)),s=[],r.push(">>>"),r.push(s);continue;case">>>>":t=!1,c.length&&(s.push(jr(c)),c.splice(0)),s=[],r.push(">>>>"),r.push(s);continue}break;case"pseudo-element":if(!d.name.startsWith("-p-"))break;t=!1,c.length&&(s.push(jr(c)),c.splice(0));const u=d.name.slice(3);u==="aria"&&(e=!0),s.push({name:u,value:Fb(d.argument??"")});continue;case"pseudo-class":a=!0;break;case"comma":c.length&&(s.push(jr(c)),c.splice(0)),s=[],r=[s],l.push(r);continue}c.push(d)}return c.length&&s.push(jr(c)),[l,t,a,e]}/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class Wh extends xo{}_(Wh,"querySelectorAll",(t,e,{textQuerySelectorAll:a})=>a(t,e));/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class $u extends xo{}_($u,"querySelectorAll",(t,e,{xpathQuerySelectorAll:a})=>a(t,e)),_($u,"querySelector",(t,e,{xpathQuerySelectorAll:a})=>{for(const i of a(t,e,1))return i;return null});/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const Ub={aria:ln,pierce:Bu,xpath:$u,text:Wh},jb=["=","/"];function qc(o){for(const t of[ku.names().map(e=>[e,ku.get(e)]),Object.entries(Ub)])for(const[e,a]of t)for(const i of jb){const s=`${e}${i}`;if(o.startsWith(s))return o=o.slice(s.length),{updatedSelector:o,polling:e==="aria"?"raf":"mutation",QueryHandler:a}}try{const[t,e,a,i]=$b(o);return e?{updatedSelector:o,polling:a?"raf":"mutation",QueryHandler:hd}:{updatedSelector:JSON.stringify(t),polling:i?"raf":"mutation",QueryHandler:Fu}}catch{return{updatedSelector:o,polling:"mutation",QueryHandler:hd}}}/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Hb=function(o,t,e){for(var a=arguments.length>2,i=0;i<t.length;i++)e=a?t[i].call(o,e):t[i].call(o);return a?e:void 0},Te=function(o,t,e,a,i,s){function r(T){if(T!==void 0&&typeof T!="function")throw new TypeError("Function expected");return T}for(var l=a.kind,c=l==="getter"?"get":l==="setter"?"set":"value",d=!t&&o?a.static?o:o.prototype:null,u=t||(d?Object.getOwnPropertyDescriptor(d,a.name):{}),p,g=!1,m=e.length-1;m>=0;m--){var v={};for(var b in a)v[b]=b==="access"?{}:a[b];for(var b in a.access)v.access[b]=a.access[b];v.addInitializer=function(T){if(g)throw new TypeError("Cannot add initializers after decoration has completed");s.push(r(T||null))};var E=(0,e[m])(l==="accessor"?{get:u.get,set:u.set}:u[c],v);if(l==="accessor"){if(E===void 0)continue;if(E===null||typeof E!="object")throw new TypeError("Object expected");(p=r(E.get))&&(u.get=p),(p=r(E.set))&&(u.set=p),(p=r(E.init))&&i.unshift(p)}else(p=r(E))&&(l==="field"?i.unshift(p):u[c]=p)}d&&Object.defineProperty(d,a.name,u),g=!0},Mo=function(o,t,e){if(t!=null){if(typeof t!="object"&&typeof t!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=t[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=t[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");o.stack.push({value:t,dispose:a,async:e})}else e&&o.stack.push({async:!0});return t},zo=(function(o){return function(t){function e(i){t.error=t.hasError?new o(i,t.error,"An error was suppressed during disposal."):i,t.hasError=!0}function a(){for(;t.stack.length;){var i=t.stack.pop();try{var s=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(s).then(a,function(r){return e(r),a()})}catch(r){e(r)}}if(t.hasError)throw t.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(o,t,e){var a=new Error(e);return a.name="SuppressedError",a.error=o,a.suppressed=t,a}),Fe;(function(o){o.FrameNavigated=Symbol("Frame.FrameNavigated"),o.FrameSwapped=Symbol("Frame.FrameSwapped"),o.LifecycleEvent=Symbol("Frame.LifecycleEvent"),o.FrameNavigatedWithinDocument=Symbol("Frame.FrameNavigatedWithinDocument"),o.FrameDetached=Symbol("Frame.FrameDetached"),o.FrameSwappedByActivation=Symbol("Frame.FrameSwappedByActivation")})(Fe||(Fe={}));const me=Q(o=>`Attempted to use detached Frame '${o._id}'.`);let Vb=(()=>{var B,j,qr,D;let o=ye,t=[],e,a,i,s,r,l,c,d,u,p,g,m,v,b,E,T,R,S,C,M;return D=class extends o{constructor(){super();h(this,j);_(this,"_id",Hb(this,t));_(this,"_parentId");_(this,"_name");_(this,"_hasStartedLoading",!1);h(this,B)}clearDocumentHandle(){f(this,B,void 0)}async frameElement(){const O={stack:[],error:void 0,hasError:!1};try{const x=this.parentFrame();if(!x)return null;const k=Mo(O,await x.isolatedRealm().evaluateHandle(()=>document.querySelectorAll("iframe,frame")),!1);for await(const z of Hh(k)){const ee={stack:[],error:void 0,hasError:!1};try{const ae=Mo(ee,z,!1),te=await ae.contentFrame();if((te==null?void 0:te._id)===this._id)return ae.move()}catch(ae){ee.error=ae,ee.hasError=!0}finally{zo(ee)}}return null}catch(x){O.error=x,O.hasError=!0}finally{zo(O)}}async evaluateHandle(O,...x){return O=ze(this.evaluateHandle.name,O),await this.mainRealm().evaluateHandle(O,...x)}async evaluate(O,...x){return O=ze(this.evaluate.name,O),await this.mainRealm().evaluate(O,...x)}locator(O){return typeof O=="string"?md.create(this,O):dd.create(this,O)}async $(O){return await(await w(this,j,qr).call(this)).$(O)}async $$(O,x){return await(await w(this,j,qr).call(this)).$$(O,x)}async $eval(O,x,...k){return x=ze(this.$eval.name,x),await(await w(this,j,qr).call(this)).$eval(O,x,...k)}async $$eval(O,x,...k){return x=ze(this.$$eval.name,x),await(await w(this,j,qr).call(this)).$$eval(O,x,...k)}async waitForSelector(O,x={}){const{updatedSelector:k,QueryHandler:z,polling:ee}=qc(O);return await z.waitFor(this,k,{polling:ee,...x})}async waitForFunction(O,x={},...k){return await this.mainRealm().waitForFunction(O,x,...k)}async content(){return await this.evaluate(()=>{let O="";for(const x of document.childNodes)switch(x){case document.documentElement:O+=document.documentElement.outerHTML;break;default:O+=new XMLSerializer().serializeToString(x);break}return O})}async setFrameContent(O){return await this.evaluate(x=>{document.open(),document.write(x),document.close()},O)}name(){return this._name||""}isDetached(){return this.detached}get disposed(){return this.detached}async addScriptTag(O){let{content:x="",type:k}=O;const{path:z}=O;if(+!!O.url+ +!!z+ +!!x!=1)throw new Error("Exactly one of `url`, `path`, or `content` must be specified.");return z&&(x=await(await Tm()).readFile(z,"utf8"),x+=`//# sourceURL=${z.replace(/\n/g,"")}`),k=k??"text/javascript",await this.mainRealm().transferHandle(await this.isolatedRealm().evaluateHandle(async({url:ee,id:ae,type:te,content:pe})=>await new Promise((V,_o)=>{const st=document.createElement("script");st.type=te,st.text=pe,st.addEventListener("error",yc=>{_o(new Error(yc.message??"Could not load script"))},{once:!0}),ae&&(st.id=ae),ee?(st.src=ee,st.addEventListener("load",()=>{V(st)},{once:!0}),document.head.appendChild(st)):(document.head.appendChild(st),V(st))}),{...O,type:k,content:x}))}async addStyleTag(O){let{content:x=""}=O;const{path:k}=O;if(+!!O.url+ +!!k+ +!!x!=1)throw new Error("Exactly one of `url`, `path`, or `content` must be specified.");return k&&(x=await(await Tm()).readFile(k,"utf8"),x+="/*# sourceURL="+k.replace(/\n/g,"")+"*/",O.content=x),await this.mainRealm().transferHandle(await this.isolatedRealm().evaluateHandle(async({url:z,content:ee})=>await new Promise((ae,te)=>{let pe;if(!z)pe=document.createElement("style"),pe.appendChild(document.createTextNode(ee));else{const V=document.createElement("link");V.rel="stylesheet",V.href=z,pe=V}return pe.addEventListener("load",()=>{ae(pe)},{once:!0}),pe.addEventListener("error",V=>{te(new Error(V.message??"Could not load style"))},{once:!0}),document.head.appendChild(pe),pe}),O))}async click(O,x={}){const k={stack:[],error:void 0,hasError:!1};try{const z=Mo(k,await this.$(O),!1);L(z,`No element found for selector: ${O}`),await z.click(x),await z.dispose()}catch(z){k.error=z,k.hasError=!0}finally{zo(k)}}async focus(O){const x={stack:[],error:void 0,hasError:!1};try{const k=Mo(x,await this.$(O),!1);L(k,`No element found for selector: ${O}`),await k.focus()}catch(k){x.error=k,x.hasError=!0}finally{zo(x)}}async hover(O){const x={stack:[],error:void 0,hasError:!1};try{const k=Mo(x,await this.$(O),!1);L(k,`No element found for selector: ${O}`),await k.hover()}catch(k){x.error=k,x.hasError=!0}finally{zo(x)}}async select(O,...x){const k={stack:[],error:void 0,hasError:!1};try{const z=Mo(k,await this.$(O),!1);return L(z,`No element found for selector: ${O}`),await z.select(...x)}catch(z){k.error=z,k.hasError=!0}finally{zo(k)}}async tap(O){const x={stack:[],error:void 0,hasError:!1};try{const k=Mo(x,await this.$(O),!1);L(k,`No element found for selector: ${O}`),await k.tap()}catch(k){x.error=k,x.hasError=!0}finally{zo(x)}}async type(O,x,k){const z={stack:[],error:void 0,hasError:!1};try{const ee=Mo(z,await this.$(O),!1);L(ee,`No element found for selector: ${O}`),await ee.type(x,k)}catch(ee){z.error=ee,z.hasError=!0}finally{zo(z)}}async title(){return await this.isolatedRealm().evaluate(()=>document.title)}},B=new WeakMap,j=new WeakSet,qr=function(){return n(this,B)||f(this,B,this.mainRealm().evaluateHandle(()=>document)),n(this,B)},(()=>{const O=typeof Symbol=="function"&&Symbol.metadata?Object.create(o[Symbol.metadata]??null):void 0;e=[me],a=[me],i=[me],s=[me],r=[me],l=[me],c=[me],d=[me],u=[me],p=[me],g=[me],m=[me],v=[me],b=[me],E=[me],T=[me],R=[me],S=[me],C=[me],M=[me],Te(D,null,e,{kind:"method",name:"frameElement",static:!1,private:!1,access:{has:x=>"frameElement"in x,get:x=>x.frameElement},metadata:O},null,t),Te(D,null,a,{kind:"method",name:"evaluateHandle",static:!1,private:!1,access:{has:x=>"evaluateHandle"in x,get:x=>x.evaluateHandle},metadata:O},null,t),Te(D,null,i,{kind:"method",name:"evaluate",static:!1,private:!1,access:{has:x=>"evaluate"in x,get:x=>x.evaluate},metadata:O},null,t),Te(D,null,s,{kind:"method",name:"locator",static:!1,private:!1,access:{has:x=>"locator"in x,get:x=>x.locator},metadata:O},null,t),Te(D,null,r,{kind:"method",name:"$",static:!1,private:!1,access:{has:x=>"$"in x,get:x=>x.$},metadata:O},null,t),Te(D,null,l,{kind:"method",name:"$$",static:!1,private:!1,access:{has:x=>"$$"in x,get:x=>x.$$},metadata:O},null,t),Te(D,null,c,{kind:"method",name:"$eval",static:!1,private:!1,access:{has:x=>"$eval"in x,get:x=>x.$eval},metadata:O},null,t),Te(D,null,d,{kind:"method",name:"$$eval",static:!1,private:!1,access:{has:x=>"$$eval"in x,get:x=>x.$$eval},metadata:O},null,t),Te(D,null,u,{kind:"method",name:"waitForSelector",static:!1,private:!1,access:{has:x=>"waitForSelector"in x,get:x=>x.waitForSelector},metadata:O},null,t),Te(D,null,p,{kind:"method",name:"waitForFunction",static:!1,private:!1,access:{has:x=>"waitForFunction"in x,get:x=>x.waitForFunction},metadata:O},null,t),Te(D,null,g,{kind:"method",name:"content",static:!1,private:!1,access:{has:x=>"content"in x,get:x=>x.content},metadata:O},null,t),Te(D,null,m,{kind:"method",name:"addScriptTag",static:!1,private:!1,access:{has:x=>"addScriptTag"in x,get:x=>x.addScriptTag},metadata:O},null,t),Te(D,null,v,{kind:"method",name:"addStyleTag",static:!1,private:!1,access:{has:x=>"addStyleTag"in x,get:x=>x.addStyleTag},metadata:O},null,t),Te(D,null,b,{kind:"method",name:"click",static:!1,private:!1,access:{has:x=>"click"in x,get:x=>x.click},metadata:O},null,t),Te(D,null,E,{kind:"method",name:"focus",static:!1,private:!1,access:{has:x=>"focus"in x,get:x=>x.focus},metadata:O},null,t),Te(D,null,T,{kind:"method",name:"hover",static:!1,private:!1,access:{has:x=>"hover"in x,get:x=>x.hover},metadata:O},null,t),Te(D,null,R,{kind:"method",name:"select",static:!1,private:!1,access:{has:x=>"select"in x,get:x=>x.select},metadata:O},null,t),Te(D,null,S,{kind:"method",name:"tap",static:!1,private:!1,access:{has:x=>"tap"in x,get:x=>x.tap},metadata:O},null,t),Te(D,null,C,{kind:"method",name:"type",static:!1,private:!1,access:{has:x=>"type"in x,get:x=>x.type},metadata:O},null,t),Te(D,null,M,{kind:"method",name:"title",static:!1,private:!1,access:{has:x=>"title"in x,get:x=>x.title},metadata:O},null,t),O&&Object.defineProperty(D,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:O})})(),D})();/**
 * @license
 * Copyright 2024 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Zn,Yn,Vs;class Wb{constructor(t,e,a){h(this,Zn);h(this,Yn);h(this,Vs,new WeakMap);f(this,Zn,e),f(this,Yn,a),n(this,Vs).set(t,e)}get id(){return n(this,Zn)}get source(){return n(this,Yn)}getIdForFrame(t){return n(this,Vs).get(t)}setIdForFrame(t,e){n(this,Vs).set(t,e)}}Zn=new WeakMap,Yn=new WeakMap,Vs=new WeakMap;/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class Gb{constructor(t,e){_(this,"id");_(this,"name");this.id=t,this.name=e}}var lt,Xn,ci,di,Ws,Gs,Jn,Uu;class Kb{constructor(t,e,a){h(this,Jn);h(this,lt);h(this,Xn);h(this,ci);h(this,di,!1);h(this,Ws,w(this,Jn,Uu).bind(this));h(this,Gs,new Set);_(this,"devices",[]);f(this,lt,t),f(this,Xn,e),f(this,ci,a.id),n(this,lt).on("DeviceAccess.deviceRequestPrompted",n(this,Ws)),n(this,lt).on("Target.detachedFromTarget",()=>{f(this,lt,null)}),w(this,Jn,Uu).call(this,a)}async waitForDevice(t,e={}){for(const r of this.devices)if(t(r))return r;const{timeout:a=n(this,Xn).timeout()}=e,i=de.create({message:`Waiting for \`DeviceRequestPromptDevice\` failed: ${a}ms exceeded`,timeout:a}),s={filter:t,promise:i};n(this,Gs).add(s);try{return await i.valueOrThrow()}finally{n(this,Gs).delete(s)}}async select(t){return L(n(this,lt)!==null,"Cannot select device through detached session!"),L(this.devices.includes(t),"Cannot select unknown device!"),L(!n(this,di),"Cannot select DeviceRequestPrompt which is already handled!"),n(this,lt).off("DeviceAccess.deviceRequestPrompted",n(this,Ws)),f(this,di,!0),await n(this,lt).send("DeviceAccess.selectPrompt",{id:n(this,ci),deviceId:t.id})}async cancel(){return L(n(this,lt)!==null,"Cannot cancel prompt through detached session!"),L(!n(this,di),"Cannot cancel DeviceRequestPrompt which is already handled!"),n(this,lt).off("DeviceAccess.deviceRequestPrompted",n(this,Ws)),f(this,di,!0),await n(this,lt).send("DeviceAccess.cancelPrompt",{id:n(this,ci)})}}lt=new WeakMap,Xn=new WeakMap,ci=new WeakMap,di=new WeakMap,Ws=new WeakMap,Gs=new WeakMap,Jn=new WeakSet,Uu=function(t){if(t.id===n(this,ci))for(const e of t.devices){if(this.devices.some(i=>i.id===e.id))continue;const a=new Gb(e.id,e.name);this.devices.push(a);for(const i of n(this,Gs))i.filter(a)&&i.promise.resolve(a)}};var St,Ks,co,Od,Gh;class qb{constructor(t,e){h(this,Od);h(this,St);h(this,Ks);h(this,co,new Set);f(this,St,t),f(this,Ks,e),n(this,St).on("DeviceAccess.deviceRequestPrompted",a=>{w(this,Od,Gh).call(this,a)}),n(this,St).on("Target.detachedFromTarget",()=>{f(this,St,null)})}async waitForDevicePrompt(t={}){L(n(this,St)!==null,"Cannot wait for device prompt through detached session!");const e=n(this,co).size===0;let a;e&&(a=n(this,St).send("DeviceAccess.enable"));const{timeout:i=n(this,Ks).timeout()}=t,s=de.create({message:`Waiting for \`DeviceRequestPrompt\` failed: ${i}ms exceeded`,timeout:i});n(this,co).add(s);try{const[r]=await Promise.all([s.valueOrThrow(),a]);return r}finally{n(this,co).delete(s)}}}St=new WeakMap,Ks=new WeakMap,co=new WeakMap,Od=new WeakSet,Gh=function(t){if(!n(this,co).size)return;L(n(this,St)!==null);const e=new Kb(n(this,St),n(this,Ks),t);for(const a of n(this,co))a.resolve(e);n(this,co).clear()};/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Zb=function(o,t,e){for(var a=arguments.length>2,i=0;i<t.length;i++)e=a?t[i].call(o,e):t[i].call(o);return a?e:void 0},se=function(o,t,e,a,i,s){function r(T){if(T!==void 0&&typeof T!="function")throw new TypeError("Function expected");return T}for(var l=a.kind,c=l==="getter"?"get":l==="setter"?"set":"value",d=!t&&o?a.static?o:o.prototype:null,u=t||(d?Object.getOwnPropertyDescriptor(d,a.name):{}),p,g=!1,m=e.length-1;m>=0;m--){var v={};for(var b in a)v[b]=b==="access"?{}:a[b];for(var b in a.access)v.access[b]=a.access[b];v.addInitializer=function(T){if(g)throw new TypeError("Cannot add initializers after decoration has completed");s.push(r(T||null))};var E=(0,e[m])(l==="accessor"?{get:u.get,set:u.set}:u[c],v);if(l==="accessor"){if(E===void 0)continue;if(E===null||typeof E!="object")throw new TypeError("Object expected");(p=r(E.get))&&(u.get=p),(p=r(E.set))&&(u.set=p),(p=r(E.init))&&i.unshift(p)}else(p=r(E))&&(l==="field"?i.unshift(p):u[c]=p)}d&&Object.defineProperty(d,a.name,u),g=!0},Hr=function(o,t,e){if(t!=null){if(typeof t!="object"&&typeof t!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=t[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=t[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");o.stack.push({value:t,dispose:a,async:e})}else e&&o.stack.push({async:!0});return t},Vr=(function(o){return function(t){function e(i){t.error=t.hasError?new o(i,t.error,"An error was suppressed during disposal."):i,t.hasError=!0}function a(){for(;t.stack.length;){var i=t.stack.pop();try{var s=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(s).then(a,function(r){return e(r),a()})}catch(r){e(r)}}if(t.hasError)throw t.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(o,t,e){var a=new Error(e);return a.name="SuppressedError",a.error=o,a.suppressed=t,a}),Yb=function(o,t,e){return typeof t=="symbol"&&(t=t.description?"[".concat(t.description,"]"):""),Object.defineProperty(o,"name",{configurable:!0,value:e?"".concat(e," ",t):t})};let ru=(()=>{var fe,ju,Hu,Vu,Kh,Wu,Gu,qh,Zh,Yh,U;var o,t,e,a,i,s,r,l,c,d,u,p,g,m,v,b,E,T,R,S,C,M,B,j,N,D,Y,$,O,x;let k=as,z=[],ee,ae,te,pe,V,_o,st,yc,Yp,Xp,Jp,Qp,em,tm,om,Ie,am,W,P,q,we,Gi,wc,Tc,xc,Ic,Sc,Ki,im,sm,rm,nm;return U=class extends k{constructor(A){super();h(this,fe);_(this,"isolatedHandle",Zb(this,z));_(this,"handle");this.handle=A,this[Vc]=!0}static bindIsolatedHandle(A,y){return async function(...G){if(this.realm===this.frame.isolatedRealm())return await A.call(this,...G);let H;this.isolatedHandle?H=this.isolatedHandle:this.isolatedHandle=H=await this.frame.isolatedRealm().adoptHandle(this);const K=await A.call(H,...G);return K===H?this:K instanceof as?await this.realm.transferHandle(K):(Array.isArray(K)&&await Promise.all(K.map(async(X,ne,Ne)=>{X instanceof as&&(Ne[ne]=await this.realm.transferHandle(X))})),K instanceof Map&&await Promise.all([...K.entries()].map(async([X,ne])=>{ne instanceof as&&K.set(X,await this.realm.transferHandle(ne))})),K)}}get id(){return this.handle.id}get disposed(){return this.handle.disposed}async getProperty(A){return await this.handle.getProperty(A)}async getProperties(){return await this.handle.getProperties()}async evaluate(A,...y){return A=ze(this.evaluate.name,A),await this.handle.evaluate(A,...y)}async evaluateHandle(A,...y){return A=ze(this.evaluateHandle.name,A),await this.handle.evaluateHandle(A,...y)}async jsonValue(){return await this.handle.jsonValue()}toString(){return this.handle.toString()}remoteObject(){return this.handle.remoteObject()}dispose(){return this.handle.dispose()}asElement(){return this}async $(A){const{updatedSelector:y,QueryHandler:G}=qc(A);return await G.queryOne(this,y)}async $$(A,y){return(y==null?void 0:y.isolate)===!1?await w(this,fe,Hu).call(this,A):await n(this,fe,ju).call(this,A)}async $eval(A,y,...G){const H={stack:[],error:void 0,hasError:!1};try{y=ze(this.$eval.name,y);const K=Hr(H,await this.$(A),!1);if(!K)throw new Error(`Error: failed to find element matching selector "${A}"`);return await K.evaluate(y,...G)}catch(K){H.error=K,H.hasError=!0}finally{Vr(H)}}async $$eval(A,y,...G){const H={stack:[],error:void 0,hasError:!1};try{y=ze(this.$$eval.name,y);const K=await this.$$(A),X=Hr(H,await this.evaluateHandle((Ne,...Pe)=>Pe,...K),!1),[ne]=await Promise.all([X.evaluate(y,...G),...K.map(Ne=>Ne.dispose())]);return ne}catch(K){H.error=K,H.hasError=!0}finally{Vr(H)}}async waitForSelector(A,y={}){const{updatedSelector:G,QueryHandler:H,polling:K}=qc(A);return await H.waitFor(this,G,{polling:K,...y})}async isVisible(){return await w(this,fe,Vu).call(this,!0)}async isHidden(){return await w(this,fe,Vu).call(this,!1)}async toElement(A){if(!await this.evaluate((G,H)=>G.nodeName===H.toUpperCase(),A))throw new Error(`Element is not a(n) \`${A}\` element`);return this}async clickablePoint(A){const y=await w(this,fe,Kh).call(this);if(!y)throw new Error("Node is either not clickable or not an Element");return A!==void 0?{x:y.x+A.x,y:y.y+A.y}:{x:y.x+y.width/2,y:y.y+y.height/2}}async hover(){await this.scrollIntoViewIfNeeded();const{x:A,y}=await this.clickablePoint();await this.frame.page().mouse.move(A,y)}async click(A={}){await this.scrollIntoViewIfNeeded();const{x:y,y:G}=await this.clickablePoint(A.offset);await this.frame.page().mouse.click(y,G,A)}async drag(A){await this.scrollIntoViewIfNeeded();const y=this.frame.page();if(y.isDragInterceptionEnabled()){const G=await this.clickablePoint();return A instanceof U&&(A=await A.clickablePoint()),await y.mouse.drag(G,A)}try{y._isDragging||(y._isDragging=!0,await this.hover(),await y.mouse.down()),A instanceof U?await A.hover():await y.mouse.move(A.x,A.y)}catch(G){throw y._isDragging=!1,G}}async dragEnter(A={items:[],dragOperationsMask:1}){const y=this.frame.page();await this.scrollIntoViewIfNeeded();const G=await this.clickablePoint();await y.mouse.dragEnter(G,A)}async dragOver(A={items:[],dragOperationsMask:1}){const y=this.frame.page();await this.scrollIntoViewIfNeeded();const G=await this.clickablePoint();await y.mouse.dragOver(G,A)}async drop(A={items:[],dragOperationsMask:1}){const y=this.frame.page();if("items"in A){await this.scrollIntoViewIfNeeded();const G=await this.clickablePoint();await y.mouse.drop(G,A)}else await A.drag(this),y._isDragging=!1,await y.mouse.up()}async dragAndDrop(A,y){const G=this.frame.page();L(G.isDragInterceptionEnabled(),"Drag Interception is not enabled!"),await this.scrollIntoViewIfNeeded();const H=await this.clickablePoint(),K=await A.clickablePoint();await G.mouse.dragAndDrop(H,K,y)}async select(...A){for(const y of A)L(Wi(y),'Values must be strings. Found value "'+y+'" of type "'+typeof y+'"');return await this.evaluate((y,G)=>{const H=new Set(G);if(!(y instanceof HTMLSelectElement))throw new Error("Element is not a <select> element.");const K=new Set;if(y.multiple)for(const X of y.options)X.selected=H.has(X.value),X.selected&&K.add(X.value);else{for(const X of y.options)X.selected=!1;for(const X of y.options)if(H.has(X.value)){X.selected=!0,K.add(X.value);break}}return y.dispatchEvent(new Event("input",{bubbles:!0})),y.dispatchEvent(new Event("change",{bubbles:!0})),[...K.values()]},A)}async tap(){await this.scrollIntoViewIfNeeded();const{x:A,y}=await this.clickablePoint();await this.frame.page().touchscreen.tap(A,y)}async touchStart(){await this.scrollIntoViewIfNeeded();const{x:A,y}=await this.clickablePoint();await this.frame.page().touchscreen.touchStart(A,y)}async touchMove(){await this.scrollIntoViewIfNeeded();const{x:A,y}=await this.clickablePoint();await this.frame.page().touchscreen.touchMove(A,y)}async touchEnd(){await this.scrollIntoViewIfNeeded(),await this.frame.page().touchscreen.touchEnd()}async focus(){await this.evaluate(A=>{if(!(A instanceof HTMLElement))throw new Error("Cannot focus non-HTMLElement");return A.focus()})}async type(A,y){await this.focus(),await this.frame.page().keyboard.type(A,y)}async press(A,y){await this.focus(),await this.frame.page().keyboard.press(A,y)}async boundingBox(){const A=await this.evaluate(G=>{if(!(G instanceof Element)||G.getClientRects().length===0)return null;const H=G.getBoundingClientRect();return{x:H.x,y:H.y,width:H.width,height:H.height}});if(!A)return null;const y=await w(this,fe,Gu).call(this);return y?{x:A.x+y.x,y:A.y+y.y,height:A.height,width:A.width}:null}async boxModel(){const A=await this.evaluate(G=>{if(!(G instanceof Element)||G.getClientRects().length===0)return null;const H=G.getBoundingClientRect(),K=window.getComputedStyle(G),X={padding:{left:parseInt(K.paddingLeft,10),top:parseInt(K.paddingTop,10),right:parseInt(K.paddingRight,10),bottom:parseInt(K.paddingBottom,10)},margin:{left:-parseInt(K.marginLeft,10),top:-parseInt(K.marginTop,10),right:-parseInt(K.marginRight,10),bottom:-parseInt(K.marginBottom,10)},border:{left:parseInt(K.borderLeft,10),top:parseInt(K.borderTop,10),right:parseInt(K.borderRight,10),bottom:parseInt(K.borderBottom,10)}},ne=[{x:H.left,y:H.top},{x:H.left+H.width,y:H.top},{x:H.left+H.width,y:H.top+H.bottom},{x:H.left,y:H.top+H.bottom}],Ne=zt(ne,X.border),Pe=zt(Ne,X.padding),Sa=zt(ne,X.margin);return{content:Pe,padding:Ne,border:ne,margin:Sa,width:H.width,height:H.height};function zt(Oo,Do){return[{x:Oo[0].x+Do.left,y:Oo[0].y+Do.top},{x:Oo[1].x-Do.right,y:Oo[1].y+Do.top},{x:Oo[2].x-Do.right,y:Oo[2].y-Do.bottom},{x:Oo[3].x+Do.left,y:Oo[3].y-Do.bottom}]}});if(!A)return null;const y=await w(this,fe,Gu).call(this);if(!y)return null;for(const G of["content","padding","border","margin"])for(const H of A[G])H.x+=y.x,H.y+=y.y;return A}async screenshot(A={}){const{scrollIntoView:y=!0,clip:G}=A,H=this.frame.page();y&&await this.scrollIntoViewIfNeeded();const K=await w(this,fe,qh).call(this),[X,ne]=await this.evaluate(()=>{if(!window.visualViewport)throw new Error("window.visualViewport is not supported.");return[window.visualViewport.pageLeft,window.visualViewport.pageTop]});return K.x+=X,K.y+=ne,G&&(K.x+=G.x,K.y+=G.y,K.height=G.height,K.width=G.width),await H.screenshot({...A,clip:K})}async assertConnectedElement(){const A=await this.evaluate(async y=>{if(!y.isConnected)return"Node is detached from document";if(y.nodeType!==Node.ELEMENT_NODE)return"Node is not of type HTMLElement"});if(A)throw new Error(A)}async scrollIntoViewIfNeeded(){await this.isIntersectingViewport({threshold:1})||await this.scrollIntoView()}async isIntersectingViewport(A={}){var G;const y={stack:[],error:void 0,hasError:!1};try{await this.assertConnectedElement();const H=await w(this,fe,Zh).call(this);return await(Hr(y,H&&await w(G=H,fe,Yh).call(G),!1)??this).evaluate(async(X,ne)=>{const Ne=await new Promise(Pe=>{const Sa=new IntersectionObserver(zt=>{Pe(zt[0].intersectionRatio),Sa.disconnect()});Sa.observe(X)});return ne===1?Ne===1:Ne>ne},A.threshold??0)}catch(H){y.error=H,y.hasError=!0}finally{Vr(y)}}async scrollIntoView(){await this.assertConnectedElement(),await this.evaluate(async A=>{A.scrollIntoView({block:"center",inline:"center",behavior:"instant"})})}},fe=new WeakSet,ju=function(){return st.value},Hu=async function(A){const{updatedSelector:y,QueryHandler:G}=qc(A);return await Gd.collect(G.queryAll(this,y))},Vu=async function(A){return await this.evaluate(async(y,G,H)=>!!G.checkVisibility(y,H),Zt.create(y=>y.puppeteerUtil),A)},Kh=async function(){var K;const A=await this.evaluate(X=>X instanceof Element?[...X.getClientRects()].map(ne=>({x:ne.x,y:ne.y,width:ne.width,height:ne.height})):null);if(!(A!=null&&A.length))return null;await w(this,fe,Wu).call(this,A);let y=this.frame,G;for(;G=y==null?void 0:y.parentFrame();){const X={stack:[],error:void 0,hasError:!1};try{const ne=Hr(X,await y.frameElement(),!1);if(!ne)throw new Error("Unsupported frame type");const Ne=await ne.evaluate(Pe=>{if(Pe.getClientRects().length===0)return null;const Sa=Pe.getBoundingClientRect(),zt=window.getComputedStyle(Pe);return{left:Sa.left+parseInt(zt.paddingLeft,10)+parseInt(zt.borderLeftWidth,10),top:Sa.top+parseInt(zt.paddingTop,10)+parseInt(zt.borderTopWidth,10)}});if(!Ne)return null;for(const Pe of A)Pe.x+=Ne.left,Pe.y+=Ne.top;await w(K=ne,fe,Wu).call(K,A),y=G}catch(ne){X.error=ne,X.hasError=!0}finally{Vr(X)}}const H=A.find(X=>X.width>=1&&X.height>=1);return H?{x:H.x,y:H.y,height:H.height,width:H.width}:null},Wu=async function(A){const{documentWidth:y,documentHeight:G}=await this.frame.isolatedRealm().evaluate(()=>({documentWidth:document.documentElement.clientWidth,documentHeight:document.documentElement.clientHeight}));for(const H of A)Xb(H,y,G)},Gu=async function(){const A={x:0,y:0};let y=this.frame,G;for(;G=y==null?void 0:y.parentFrame();){const H={stack:[],error:void 0,hasError:!1};try{const K=Hr(H,await y.frameElement(),!1);if(!K)throw new Error("Unsupported frame type");const X=await K.evaluate(ne=>{if(ne.getClientRects().length===0)return null;const Ne=ne.getBoundingClientRect(),Pe=window.getComputedStyle(ne);return{left:Ne.left+parseInt(Pe.paddingLeft,10)+parseInt(Pe.borderLeftWidth,10),top:Ne.top+parseInt(Pe.paddingTop,10)+parseInt(Pe.borderTopWidth,10)}});if(!X)return null;A.x+=X.left,A.y+=X.top,y=G}catch(K){H.error=K,H.hasError=!0}finally{Vr(H)}}return A},qh=async function(){const A=await this.boundingBox();return L(A,"Node is either not visible or not an HTMLElement"),L(A.width!==0,"Node has 0 width."),L(A.height!==0,"Node has 0 height."),A},Zh=async function(){return await this.evaluate(A=>A instanceof SVGElement)?this:null},Yh=async function(){return await this.evaluateHandle(A=>A instanceof SVGSVGElement?A:A.ownerSVGElement)},(()=>{const A=typeof Symbol=="function"&&Symbol.metadata?Object.create(k[Symbol.metadata]??null):void 0;ee=[Q(),(o=U).bindIsolatedHandle.bind(o)],ae=[Q(),(t=U).bindIsolatedHandle.bind(t)],te=[Q(),(e=U).bindIsolatedHandle.bind(e)],pe=[Q(),(a=U).bindIsolatedHandle.bind(a)],V=[Q()],_o=[(i=U).bindIsolatedHandle.bind(i)],yc=[Q(),(s=U).bindIsolatedHandle.bind(s)],Yp=[Q(),(r=U).bindIsolatedHandle.bind(r)],Xp=[Q(),(l=U).bindIsolatedHandle.bind(l)],Jp=[Q(),(c=U).bindIsolatedHandle.bind(c)],Qp=[Q(),(d=U).bindIsolatedHandle.bind(d)],em=[Q(),(u=U).bindIsolatedHandle.bind(u)],tm=[Q(),(p=U).bindIsolatedHandle.bind(p)],om=[Q(),(g=U).bindIsolatedHandle.bind(g)],Ie=[Q(),(m=U).bindIsolatedHandle.bind(m)],am=[Q(),(v=U).bindIsolatedHandle.bind(v)],W=[Q(),(b=U).bindIsolatedHandle.bind(b)],P=[Q(),(E=U).bindIsolatedHandle.bind(E)],q=[Q(),(T=U).bindIsolatedHandle.bind(T)],we=[Q(),(R=U).bindIsolatedHandle.bind(R)],Gi=[Q(),(S=U).bindIsolatedHandle.bind(S)],wc=[Q(),(C=U).bindIsolatedHandle.bind(C)],Tc=[Q(),(M=U).bindIsolatedHandle.bind(M)],xc=[Q(),(B=U).bindIsolatedHandle.bind(B)],Ic=[Q(),(j=U).bindIsolatedHandle.bind(j)],Sc=[Q(),(N=U).bindIsolatedHandle.bind(N)],Ki=[Q(),(D=U).bindIsolatedHandle.bind(D)],im=[Q(),(Y=U).bindIsolatedHandle.bind(Y)],sm=[Q(),($=U).bindIsolatedHandle.bind($)],rm=[Q(),(O=U).bindIsolatedHandle.bind(O)],nm=[Q(),(x=U).bindIsolatedHandle.bind(x)],se(U,null,ee,{kind:"method",name:"getProperty",static:!1,private:!1,access:{has:y=>"getProperty"in y,get:y=>y.getProperty},metadata:A},null,z),se(U,null,ae,{kind:"method",name:"getProperties",static:!1,private:!1,access:{has:y=>"getProperties"in y,get:y=>y.getProperties},metadata:A},null,z),se(U,null,te,{kind:"method",name:"jsonValue",static:!1,private:!1,access:{has:y=>"jsonValue"in y,get:y=>y.jsonValue},metadata:A},null,z),se(U,null,pe,{kind:"method",name:"$",static:!1,private:!1,access:{has:y=>"$"in y,get:y=>y.$},metadata:A},null,z),se(U,null,V,{kind:"method",name:"$$",static:!1,private:!1,access:{has:y=>"$$"in y,get:y=>y.$$},metadata:A},null,z),se(U,st={value:Yb(async function(y){return await w(this,fe,Hu).call(this,y)},"#$$")},_o,{kind:"method",name:"#$$",static:!1,private:!0,access:{has:y=>mt(fe,y),get:y=>n(y,fe,ju)},metadata:A},null,z),se(U,null,yc,{kind:"method",name:"waitForSelector",static:!1,private:!1,access:{has:y=>"waitForSelector"in y,get:y=>y.waitForSelector},metadata:A},null,z),se(U,null,Yp,{kind:"method",name:"isVisible",static:!1,private:!1,access:{has:y=>"isVisible"in y,get:y=>y.isVisible},metadata:A},null,z),se(U,null,Xp,{kind:"method",name:"isHidden",static:!1,private:!1,access:{has:y=>"isHidden"in y,get:y=>y.isHidden},metadata:A},null,z),se(U,null,Jp,{kind:"method",name:"toElement",static:!1,private:!1,access:{has:y=>"toElement"in y,get:y=>y.toElement},metadata:A},null,z),se(U,null,Qp,{kind:"method",name:"clickablePoint",static:!1,private:!1,access:{has:y=>"clickablePoint"in y,get:y=>y.clickablePoint},metadata:A},null,z),se(U,null,em,{kind:"method",name:"hover",static:!1,private:!1,access:{has:y=>"hover"in y,get:y=>y.hover},metadata:A},null,z),se(U,null,tm,{kind:"method",name:"click",static:!1,private:!1,access:{has:y=>"click"in y,get:y=>y.click},metadata:A},null,z),se(U,null,om,{kind:"method",name:"drag",static:!1,private:!1,access:{has:y=>"drag"in y,get:y=>y.drag},metadata:A},null,z),se(U,null,Ie,{kind:"method",name:"dragEnter",static:!1,private:!1,access:{has:y=>"dragEnter"in y,get:y=>y.dragEnter},metadata:A},null,z),se(U,null,am,{kind:"method",name:"dragOver",static:!1,private:!1,access:{has:y=>"dragOver"in y,get:y=>y.dragOver},metadata:A},null,z),se(U,null,W,{kind:"method",name:"drop",static:!1,private:!1,access:{has:y=>"drop"in y,get:y=>y.drop},metadata:A},null,z),se(U,null,P,{kind:"method",name:"dragAndDrop",static:!1,private:!1,access:{has:y=>"dragAndDrop"in y,get:y=>y.dragAndDrop},metadata:A},null,z),se(U,null,q,{kind:"method",name:"select",static:!1,private:!1,access:{has:y=>"select"in y,get:y=>y.select},metadata:A},null,z),se(U,null,we,{kind:"method",name:"tap",static:!1,private:!1,access:{has:y=>"tap"in y,get:y=>y.tap},metadata:A},null,z),se(U,null,Gi,{kind:"method",name:"touchStart",static:!1,private:!1,access:{has:y=>"touchStart"in y,get:y=>y.touchStart},metadata:A},null,z),se(U,null,wc,{kind:"method",name:"touchMove",static:!1,private:!1,access:{has:y=>"touchMove"in y,get:y=>y.touchMove},metadata:A},null,z),se(U,null,Tc,{kind:"method",name:"touchEnd",static:!1,private:!1,access:{has:y=>"touchEnd"in y,get:y=>y.touchEnd},metadata:A},null,z),se(U,null,xc,{kind:"method",name:"focus",static:!1,private:!1,access:{has:y=>"focus"in y,get:y=>y.focus},metadata:A},null,z),se(U,null,Ic,{kind:"method",name:"type",static:!1,private:!1,access:{has:y=>"type"in y,get:y=>y.type},metadata:A},null,z),se(U,null,Sc,{kind:"method",name:"press",static:!1,private:!1,access:{has:y=>"press"in y,get:y=>y.press},metadata:A},null,z),se(U,null,Ki,{kind:"method",name:"boundingBox",static:!1,private:!1,access:{has:y=>"boundingBox"in y,get:y=>y.boundingBox},metadata:A},null,z),se(U,null,im,{kind:"method",name:"boxModel",static:!1,private:!1,access:{has:y=>"boxModel"in y,get:y=>y.boxModel},metadata:A},null,z),se(U,null,sm,{kind:"method",name:"screenshot",static:!1,private:!1,access:{has:y=>"screenshot"in y,get:y=>y.screenshot},metadata:A},null,z),se(U,null,rm,{kind:"method",name:"isIntersectingViewport",static:!1,private:!1,access:{has:y=>"isIntersectingViewport"in y,get:y=>y.isIntersectingViewport},metadata:A},null,z),se(U,null,nm,{kind:"method",name:"scrollIntoView",static:!1,private:!1,access:{has:y=>"scrollIntoView"in y,get:y=>y.scrollIntoView},metadata:A},null,z),A&&Object.defineProperty(U,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:A})})(),U})();function Xb(o,t,e){o.width=Math.max(o.x>=0?Math.min(t-o.x,o.width):Math.min(t,o.width+o.x),0),o.height=Math.max(o.y>=0?Math.min(e-o.y,o.height):Math.min(e,o.height+o.y),0)}/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */function Dm(o){let t,e;if(!o.exception)t="Error",e=o.text;else{if((o.exception.type!=="object"||o.exception.subtype!=="error")&&!o.exception.objectId)return ji(o.exception);{const l=Xh(o);t=l.name,e=l.message}}const a=e.split(`
`).length,i=new Error(e);i.name=t;const s=i.stack.split(`
`),r=s.splice(0,a);if(s.shift(),o.stackTrace&&s.length<Error.stackTraceLimit)for(const l of o.stackTrace.callFrames.reverse()){if(wo.isPuppeteerURL(l.url)&&l.url!==wo.INTERNAL_URL){const c=wo.parse(l.url);s.unshift(`    at ${l.functionName||c.functionName} (${c.functionName} at ${c.siteString}, <anonymous>:${l.lineNumber}:${l.columnNumber})`)}else s.push(`    at ${l.functionName||"<anonymous>"} (${l.url}:${l.lineNumber}:${l.columnNumber})`);if(s.length>=Error.stackTraceLimit)break}return i.stack=[...r,...s].join(`
`),i}const Xh=o=>{var s,r,l,c;let t="",e;const a=((r=(s=o.exception)==null?void 0:s.description)==null?void 0:r.split(`
    at `))??[],i=Math.min(((l=o.stackTrace)==null?void 0:l.callFrames.length)??0,a.length-1);return a.splice(-i,i),(c=o.exception)!=null&&c.className&&(t=o.exception.className),e=a.join(`
`),t&&e.startsWith(`${t}: `)&&(e=e.slice(t.length+2)),{message:e,name:t}};function Jb(o){let t,e;if(!o.exception)t="Error",e=o.text;else{if((o.exception.type!=="object"||o.exception.subtype!=="error")&&!o.exception.objectId)return ji(o.exception);{const l=Xh(o);t=l.name,e=l.message}}const a=new Error(e);a.name=t;const i=a.message.split(`
`).length,s=a.stack.split(`
`).splice(0,i),r=[];if(o.stackTrace){for(const l of o.stackTrace.callFrames)if(r.push(`    at ${l.functionName||"<anonymous>"} (${l.url}:${l.lineNumber+1}:${l.columnNumber+1})`),r.length>=Error.stackTraceLimit)break}return a.stack=[...s,...r].join(`
`),a}function ji(o){if(L(!o.objectId,"Cannot extract value when objectId is given"),o.unserializableValue){if(o.type==="bigint")return BigInt(o.unserializableValue.replace("n",""));switch(o.unserializableValue){case"-0":return-0;case"NaN":return NaN;case"Infinity":return 1/0;case"-Infinity":return-1/0;default:throw new Error("Unsupported unserializable value: "+o.unserializableValue)}}return o.value}function Jh(o,t,e){globalThis[t]||Object.assign(globalThis,{[t](...a){const i=globalThis[t];i.args??(i.args=new Map),i.callbacks??(i.callbacks=new Map);const s=(i.lastSeq??0)+1;return i.lastSeq=s,i.args.set(s,a),globalThis[e+t](JSON.stringify({type:o,name:t,seq:s,args:a,isTrivial:!a.some(r=>r instanceof Node)})),new Promise((r,l)=>{i.callbacks.set(s,{resolve(c){i.args.delete(s),r(c)},reject(c){i.args.delete(s),l(c)}})})}})}const ls="puppeteer_";function Qb(o,t){return Sh(Jh,o,t,ls)}/**
 * @license
 * Copyright 2019 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var qs,Qe,Zs;class Kd extends as{constructor(e,a){super();h(this,qs,!1);h(this,Qe);h(this,Zs);f(this,Zs,e),f(this,Qe,a)}get disposed(){return n(this,qs)}get realm(){return n(this,Zs)}get client(){return this.realm.environment.client}async jsonValue(){if(!n(this,Qe).objectId)return ji(n(this,Qe));const e=await this.evaluate(a=>a);if(e===void 0)throw new Error("Could not serialize referenced object");return e}asElement(){return null}async dispose(){n(this,qs)||(f(this,qs,!0),await Qh(this.client,n(this,Qe)))}toString(){return n(this,Qe).objectId?"JSHandle@"+(n(this,Qe).subtype||n(this,Qe).type):"JSHandle:"+ji(n(this,Qe))}get id(){return n(this,Qe).objectId}remoteObject(){return n(this,Qe)}async getProperties(){const e=await this.client.send("Runtime.getProperties",{objectId:n(this,Qe).objectId,ownProperties:!0}),a=new Map;for(const i of e.result)!i.enumerable||!i.value||a.set(i.name,n(this,Zs).createCdpHandle(i.value));return a}}qs=new WeakMap,Qe=new WeakMap,Zs=new WeakMap;async function Qh(o,t){t.objectId&&await o.send("Runtime.releaseObject",{objectId:t.objectId}).catch(e=>{Z(e)})}/**
 * @license
 * Copyright 2019 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var ey=function(o,t,e){for(var a=arguments.length>2,i=0;i<t.length;i++)e=a?t[i].call(o,e):t[i].call(o);return a?e:void 0},Mc=function(o,t,e,a,i,s){function r(T){if(T!==void 0&&typeof T!="function")throw new TypeError("Function expected");return T}for(var l=a.kind,c=l==="getter"?"get":l==="setter"?"set":"value",d=!t&&o?a.static?o:o.prototype:null,u=t||(d?Object.getOwnPropertyDescriptor(d,a.name):{}),p,g=!1,m=e.length-1;m>=0;m--){var v={};for(var b in a)v[b]=b==="access"?{}:a[b];for(var b in a.access)v.access[b]=a.access[b];v.addInitializer=function(T){if(g)throw new TypeError("Cannot add initializers after decoration has completed");s.push(r(T||null))};var E=(0,e[m])(l==="accessor"?{get:u.get,set:u.set}:u[c],v);if(l==="accessor"){if(E===void 0)continue;if(E===null||typeof E!="object")throw new TypeError("Object expected");(p=r(E.get))&&(u.get=p),(p=r(E.set))&&(u.set=p),(p=r(E.init))&&i.unshift(p)}else(p=r(E))&&(l==="field"?i.unshift(p):u[c]=p)}d&&Object.defineProperty(d,a.name,u),g=!0};const ty=new Set(["StaticText","InlineTextBox"]);let ef=(()=>{var c,tf,u;var o,t;let e=ru,a=[],i,s,r,l;return u=class extends e{constructor(m,v){super(new Kd(m,v));h(this,c);ey(this,a)}get realm(){return this.handle.realm}get client(){return this.handle.client}remoteObject(){return this.handle.remoteObject()}get frame(){return this.realm.environment}async contentFrame(){const m=await this.client.send("DOM.describeNode",{objectId:this.id});return typeof m.node.frameId!="string"?null:n(this,c,tf).frame(m.node.frameId)}async scrollIntoView(){await this.assertConnectedElement();try{await this.client.send("DOM.scrollIntoViewIfNeeded",{objectId:this.id})}catch(m){Z(m),await super.scrollIntoView()}}async uploadFile(...m){const v=await this.evaluate(R=>R.multiple);L(m.length<=1||v,"Multiple file uploads only work with <input type=file multiple>");let b;try{b=await import("path")}catch(R){throw R instanceof TypeError?new Error("JSHandle#uploadFile can only be used in Node-like environments."):R}const E=m.map(R=>b.win32.isAbsolute(R)||b.posix.isAbsolute(R)?R:b.resolve(R));if(E.length===0){await this.evaluate(R=>{R.files=new DataTransfer().files,R.dispatchEvent(new Event("input",{bubbles:!0,composed:!0})),R.dispatchEvent(new Event("change",{bubbles:!0}))});return}const{node:{backendNodeId:T}}=await this.client.send("DOM.describeNode",{objectId:this.id});await this.client.send("DOM.setFileInputFiles",{objectId:this.id,files:E,backendNodeId:T})}async autofill(m){const b=(await this.client.send("DOM.describeNode",{objectId:this.handle.id})).node.backendNodeId,E=this.frame._id;await this.client.send("Autofill.trigger",{fieldId:b,frameId:E,card:m.creditCard})}async*queryAXTree(m,v){const{nodes:b}=await this.client.send("Accessibility.queryAXTree",{objectId:this.id,accessibleName:m,role:v}),E=b.filter(T=>!(T.ignored||!T.role||ty.has(T.role.value)));return yield*Gd.map(E,T=>this.realm.adoptBackendNode(T.backendDOMNodeId))}},c=new WeakSet,tf=function(){return this.frame._frameManager},(()=>{const m=typeof Symbol=="function"&&Symbol.metadata?Object.create(e[Symbol.metadata]??null):void 0;i=[Q()],s=[Q(),(o=ru).bindIsolatedHandle.bind(o)],r=[Q(),(t=ru).bindIsolatedHandle.bind(t)],l=[Q()],Mc(u,null,i,{kind:"method",name:"contentFrame",static:!1,private:!1,access:{has:v=>"contentFrame"in v,get:v=>v.contentFrame},metadata:m},null,a),Mc(u,null,s,{kind:"method",name:"scrollIntoView",static:!1,private:!1,access:{has:v=>"scrollIntoView"in v,get:v=>v.scrollIntoView},metadata:m},null,a),Mc(u,null,r,{kind:"method",name:"uploadFile",static:!1,private:!1,access:{has:v=>"uploadFile"in v,get:v=>v.uploadFile},metadata:m},null,a),Mc(u,null,l,{kind:"method",name:"autofill",static:!1,private:!1,access:{has:v=>"autofill"in v,get:v=>v.autofill},metadata:m},null,a),m&&Object.defineProperty(u,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:m})})(),u})();/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var oy=function(o,t,e){if(t!=null){if(typeof t!="object"&&typeof t!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=t[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=t[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");o.stack.push({value:t,dispose:a,async:e})}else e&&o.stack.push({async:!0});return t},ay=(function(o){return function(t){function e(i){t.error=t.hasError?new o(i,t.error,"An error was suppressed during disposal."):i,t.hasError=!0}function a(){for(;t.stack.length;){var i=t.stack.pop();try{var s=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(s).then(a,function(r){return e(r),a()})}catch(r){e(r)}}if(t.hasError)throw t.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(o,t,e){var a=new Error(e);return a.name="SuppressedError",a.error=o,a.suppressed=t,a});const iy=new gd("__ariaQuerySelector",ln.queryOne,""),sy=new gd("__ariaQuerySelectorAll",(async(o,t)=>{const e=ln.queryAll(o,t);return await o.realm.evaluateHandle((...a)=>a,...await Gd.collect(e))}),"");var Zo,ui,At,Ys,Qn,pi,Dd,at,af,sf,rf,el,Yo,Ku,qu;class of extends ye{constructor(e,a,i){super();h(this,at);h(this,Zo);h(this,ui);h(this,At);h(this,Ys);h(this,Qn,new To);h(this,pi,new Map);h(this,Dd,new nn);h(this,el,!1);h(this,Yo);f(this,Zo,e),f(this,ui,i),f(this,At,a.id),a.name&&f(this,Ys,a.name);const s=n(this,Qn).use(new ye(n(this,Zo)));s.on("Runtime.bindingCalled",w(this,at,sf).bind(this)),s.on("Runtime.executionContextDestroyed",async r=>{r.executionContextId===n(this,At)&&this[ue]()}),s.on("Runtime.executionContextsCleared",async()=>{this[ue]()}),s.on("Runtime.consoleAPICalled",w(this,at,rf).bind(this)),s.on(ge.Disconnected,()=>{this[ue]()})}get id(){return n(this,At)}get puppeteerUtil(){let e=Promise.resolve();return n(this,el)||(e=Promise.all([w(this,at,Ku).call(this,iy),w(this,at,Ku).call(this,sy)]),f(this,el,!0)),Gc.inject(a=>{n(this,Yo)&&n(this,Yo).then(i=>{i.dispose()}),f(this,Yo,e.then(()=>this.evaluateHandle(a)))},!n(this,Yo)),n(this,Yo)}async evaluate(e,...a){return await w(this,at,qu).call(this,!0,e,...a)}async evaluateHandle(e,...a){return await w(this,at,qu).call(this,!1,e,...a)}[ue](){n(this,Qn).dispose(),this.emit("disposed",void 0)}}Zo=new WeakMap,ui=new WeakMap,At=new WeakMap,Ys=new WeakMap,Qn=new WeakMap,pi=new WeakMap,Dd=new WeakMap,at=new WeakSet,af=async function(e){const a={stack:[],error:void 0,hasError:!1};try{if(n(this,pi).has(e.name))return;const i=oy(a,await n(this,Dd).acquire(),!1);try{await n(this,Zo).send("Runtime.addBinding",n(this,Ys)?{name:ls+e.name,executionContextName:n(this,Ys)}:{name:ls+e.name,executionContextId:n(this,At)}),await this.evaluate(Jh,"internal",e.name,ls),n(this,pi).set(e.name,e)}catch(s){if(s instanceof Error&&(s.message.includes("Execution context was destroyed")||s.message.includes("Cannot find context with specified id")))return;Z(s)}}catch(i){a.error=i,a.hasError=!0}finally{ay(a)}},sf=async function(e){if(e.executionContextId!==n(this,At))return;let a;try{a=JSON.parse(e.payload)}catch{return}const{type:i,name:s,seq:r,args:l,isTrivial:c}=a;if(i!=="internal"){this.emit("bindingcalled",e);return}if(!n(this,pi).has(s)){this.emit("bindingcalled",e);return}try{const d=n(this,pi).get(s);await(d==null?void 0:d.run(this,r,l,c))}catch(d){Z(d)}},rf=function(e){e.executionContextId===n(this,At)&&this.emit("consoleapicalled",e)},el=new WeakMap,Yo=new WeakMap,Ku=async function(e){try{await w(this,at,af).call(this,e)}catch(a){Z(a)}},qu=async function(e,a,...i){var g;const s=NE(((g=ME(a))==null?void 0:g.toString())??wo.INTERNAL_URL);if(Wi(a)){const m=n(this,At),v=a,b=Im.test(v)?v:`${v}
${s}
`,{exceptionDetails:E,result:T}=await n(this,Zo).send("Runtime.evaluate",{expression:b,contextId:m,returnByValue:e,awaitPromise:!0,userGesture:!0}).catch(Mm);if(E)throw Dm(E);return e?ji(T):n(this,ui).createCdpHandle(T)}const r=Ta(a),l=Im.test(r)?r:`${r}
${s}
`;let c;try{c=n(this,Zo).send("Runtime.callFunctionOn",{functionDeclaration:l,executionContextId:n(this,At),arguments:i.length?await Promise.all(i.map(p.bind(this))):[],returnByValue:e,awaitPromise:!0,userGesture:!0})}catch(m){throw m instanceof TypeError&&m.message.startsWith("Converting circular structure to JSON")&&(m.message+=" Recursive objects are not allowed."),m}const{exceptionDetails:d,result:u}=await c.catch(Mm);if(d)throw Dm(d);return e?ji(u):n(this,ui).createCdpHandle(u);async function p(m){if(m instanceof Zt&&(m=await m.get(this)),typeof m=="bigint")return{unserializableValue:`${m.toString()}n`};if(Object.is(m,-0))return{unserializableValue:"-0"};if(Object.is(m,1/0))return{unserializableValue:"Infinity"};if(Object.is(m,-1/0))return{unserializableValue:"-Infinity"};if(Object.is(m,NaN))return{unserializableValue:"NaN"};const v=m&&(m instanceof Kd||m instanceof ef)?m:null;if(v){if(v.realm!==n(this,ui))throw new Error("JSHandles can be evaluated only in the context they were created!");if(v.disposed)throw new Error("JSHandle is disposed!");return v.remoteObject().unserializableValue?{unserializableValue:v.remoteObject().unserializableValue}:v.remoteObject().objectId?{objectId:v.remoteObject().objectId}:{value:v.remoteObject().value}}return{value:m}}};const Mm=o=>{if(o.message.includes("Object reference chain is too long"))return{result:{type:"undefined"}};if(o.message.includes("Object couldn't be returned by value"))return{result:{type:"undefined"}};throw o.message.endsWith("Cannot find context with specified id")||o.message.endsWith("Inspected target navigated or closed")?new Error("Execution context was destroyed, most likely because of a navigation."):o};/**
 * @license
 * Copyright 2018 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var mi;class ry{constructor(t){h(this,mi);f(this,mi,t)}async snapshot(t={}){const{interestingOnly:e=!0,root:a=null}=t,{nodes:i}=await n(this,mi).environment.client.send("Accessibility.getFullAXTree");let s;if(a){const{node:d}=await n(this,mi).environment.client.send("DOM.describeNode",{objectId:a.id});s=d.backendNodeId}const r=Zu.createTree(n(this,mi),i);let l=r;if(s&&(l=r.find(d=>d.payload.backendDOMNodeId===s),!l))return null;if(!e)return this.serializeTree(l)[0]??null;const c=new Set;return this.collectInterestingNodes(c,r,!1),c.has(l)?this.serializeTree(l,c)[0]??null:null}serializeTree(t,e){const a=[];for(const s of t.children)a.push(...this.serializeTree(s,e));if(e&&!e.has(t))return a;const i=t.serialize();return a.length&&(i.children=a),[i]}collectInterestingNodes(t,e,a){if(e.isInteresting(a)&&t.add(e),!e.isLeafNode()){a=a||e.isControl();for(const i of e.children)this.collectInterestingNodes(t,i,a)}}}mi=new WeakMap;var Xs,tl,gi,ol,hi,ct,al,fi,il,So,nf,lf,Yu;const Vp=class Vp{constructor(t,e){h(this,So);_(this,"payload");_(this,"children",[]);h(this,Xs,!1);h(this,tl,!1);h(this,gi,!1);h(this,ol,!1);h(this,hi);h(this,ct);h(this,al);h(this,fi);h(this,il);this.payload=e,f(this,hi,this.payload.name?this.payload.name.value:""),f(this,ct,this.payload.role?this.payload.role.value:"Unknown"),f(this,al,this.payload.ignored),f(this,il,t);for(const a of this.payload.properties||[])a.name==="editable"&&(f(this,Xs,a.value.value==="richtext"),f(this,tl,!0)),a.name==="focusable"&&f(this,gi,a.value.value),a.name==="hidden"&&f(this,ol,a.value.value)}find(t){if(t(this))return this;for(const e of this.children){const a=e.find(t);if(a)return a}return null}isLeafNode(){if(!this.children.length||w(this,So,nf).call(this)||w(this,So,lf).call(this))return!0;switch(n(this,ct)){case"doc-cover":case"graphics-symbol":case"img":case"image":case"Meter":case"scrollbar":case"slider":case"separator":case"progressbar":return!0}return w(this,So,Yu).call(this)?!1:!!(n(this,gi)&&n(this,hi)||n(this,ct)==="heading"&&n(this,hi))}isControl(){switch(n(this,ct)){case"button":case"checkbox":case"ColorWell":case"combobox":case"DisclosureTriangle":case"listbox":case"menu":case"menubar":case"menuitem":case"menuitemcheckbox":case"menuitemradio":case"radio":case"scrollbar":case"searchbox":case"slider":case"spinbutton":case"switch":case"tab":case"textbox":case"tree":case"treeitem":return!0;default:return!1}}isInteresting(t){return n(this,ct)==="Ignored"||n(this,ol)||n(this,al)?!1:n(this,gi)||n(this,Xs)||this.isControl()?!0:t?!1:this.isLeafNode()&&!!n(this,hi)}serialize(){const t=new Map;for(const g of this.payload.properties||[])t.set(g.name.toLowerCase(),g.value.value);this.payload.name&&t.set("name",this.payload.name.value),this.payload.value&&t.set("value",this.payload.value.value),this.payload.description&&t.set("description",this.payload.description.value);const e={role:n(this,ct),elementHandle:async()=>this.payload.backendDOMNodeId?await n(this,il).adoptBackendNode(this.payload.backendDOMNodeId):null},a=["name","value","description","keyshortcuts","roledescription","valuetext"],i=g=>t.get(g);for(const g of a)t.has(g)&&(e[g]=i(g));const s=["disabled","expanded","focused","modal","multiline","multiselectable","readonly","required","selected"],r=g=>t.get(g);for(const g of s)g==="focused"&&n(this,ct)==="RootWebArea"||!r(g)||(e[g]=r(g));const l=["checked","pressed"];for(const g of l){if(!t.has(g))continue;const m=t.get(g);e[g]=m==="mixed"?"mixed":m==="true"}const c=["level","valuemax","valuemin"],d=g=>t.get(g);for(const g of c)t.has(g)&&(e[g]=d(g));const u=["autocomplete","haspopup","invalid","orientation"],p=g=>t.get(g);for(const g of u){const m=p(g);!m||m==="false"||(e[g]=p(g))}return e}static createTree(t,e){const a=new Map;for(const i of e)a.set(i.nodeId,new Vp(t,i));for(const i of a.values())for(const s of i.payload.childIds||[]){const r=a.get(s);r&&i.children.push(r)}return a.values().next().value}};Xs=new WeakMap,tl=new WeakMap,gi=new WeakMap,ol=new WeakMap,hi=new WeakMap,ct=new WeakMap,al=new WeakMap,fi=new WeakMap,il=new WeakMap,So=new WeakSet,nf=function(){return n(this,Xs)?!1:n(this,tl)?!0:n(this,ct)==="textbox"||n(this,ct)==="searchbox"},lf=function(){const t=n(this,ct);return t==="LineBreak"||t==="text"||t==="InlineTextBox"||t==="StaticText"},Yu=function(){var t;if(n(this,fi)===void 0){f(this,fi,!1);for(const e of this.children)if(n(e,gi)||w(t=e,So,Yu).call(t)){f(this,fi,!0);break}}return n(this,fi)};let Zu=Vp;/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Me;(function(o){o.FrameAttached=Symbol("FrameManager.FrameAttached"),o.FrameNavigated=Symbol("FrameManager.FrameNavigated"),o.FrameDetached=Symbol("FrameManager.FrameDetached"),o.FrameSwapped=Symbol("FrameManager.FrameSwapped"),o.LifecycleEvent=Symbol("FrameManager.LifecycleEvent"),o.FrameNavigatedWithinDocument=Symbol("FrameManager.FrameNavigatedWithinDocument"),o.ConsoleApiCalled=Symbol("FrameManager.ConsoleApiCalled"),o.BindingCalled=Symbol("FrameManager.BindingCalled")})(Me||(Me={}));/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var uo,Js,sl,Xo,vi,rl,nl,Ei,dt,Qs,er;class ny{constructor(t,e,a,...i){h(this,uo);h(this,Js);h(this,sl);h(this,Xo);h(this,vi);h(this,rl);h(this,nl);h(this,Ei,de.create());h(this,dt);h(this,Qs);h(this,er,[]);var s;switch(f(this,uo,t),f(this,Js,e.polling),f(this,sl,e.root),f(this,Qs,e.signal),(s=n(this,Qs))==null||s.addEventListener("abort",()=>{var r;this.terminate((r=n(this,Qs))==null?void 0:r.reason)},{once:!0}),typeof a){case"string":f(this,Xo,`() => {return (${a});}`);break;default:f(this,Xo,Ta(a));break}f(this,vi,i),n(this,uo).taskManager.add(this),e.timeout&&(f(this,nl,new Pp(`Waiting failed: ${e.timeout}ms exceeded`)),f(this,rl,setTimeout(()=>{this.terminate(n(this,nl))},e.timeout))),this.rerun()}get result(){return n(this,Ei).valueOrThrow()}async rerun(){for(const e of n(this,er))e.abort();n(this,er).length=0;const t=new AbortController;n(this,er).push(t);try{switch(n(this,Js)){case"raf":f(this,dt,await n(this,uo).evaluateHandle(({RAFPoller:a,createFunction:i},s,...r)=>{const l=i(s);return new a(()=>l(...r))},Zt.create(a=>a.puppeteerUtil),n(this,Xo),...n(this,vi)));break;case"mutation":f(this,dt,await n(this,uo).evaluateHandle(({MutationPoller:a,createFunction:i},s,r,...l)=>{const c=i(r);return new a(()=>c(...l),s||document)},Zt.create(a=>a.puppeteerUtil),n(this,sl),n(this,Xo),...n(this,vi)));break;default:f(this,dt,await n(this,uo).evaluateHandle(({IntervalPoller:a,createFunction:i},s,r,...l)=>{const c=i(r);return new a(()=>c(...l),s)},Zt.create(a=>a.puppeteerUtil),n(this,Js),n(this,Xo),...n(this,vi)));break}await n(this,dt).evaluate(a=>{a.start()});const e=await n(this,dt).evaluateHandle(a=>a.result());n(this,Ei).resolve(e),await this.terminate()}catch(e){if(t.signal.aborted)return;const a=this.getBadError(e);a&&await this.terminate(a)}}async terminate(t){if(n(this,uo).taskManager.delete(this),clearTimeout(n(this,rl)),t&&!n(this,Ei).finished()&&n(this,Ei).reject(t),n(this,dt))try{await n(this,dt).evaluateHandle(async e=>{await e.stop()}),n(this,dt)&&(await n(this,dt).dispose(),f(this,dt,void 0))}catch{}}getBadError(t){return Xt(t)?t.message.includes("Execution context is not available in detached frame")?new Error("Waiting failed: Frame detached"):t.message.includes("Execution context was destroyed")||t.message.includes("Cannot find context with specified id")||t.message.includes("AbortError: Actor 'MessageHandlerFrame' destroyed")?void 0:t:new Error("WaitTask failed with an error",{cause:t})}}uo=new WeakMap,Js=new WeakMap,sl=new WeakMap,Xo=new WeakMap,vi=new WeakMap,rl=new WeakMap,nl=new WeakMap,Ei=new WeakMap,dt=new WeakMap,Qs=new WeakMap,er=new WeakMap;var Jo;class ly{constructor(){h(this,Jo,new Set)}add(t){n(this,Jo).add(t)}delete(t){n(this,Jo).delete(t)}terminateAll(t){for(const e of n(this,Jo))e.terminate(t);n(this,Jo).clear()}async rerunAll(){await Promise.all([...n(this,Jo)].map(t=>t.rerun()))}}Jo=new WeakMap;/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var ll;class cy{constructor(t){_(this,"timeoutSettings");_(this,"taskManager",new ly);h(this,ll,!1);this.timeoutSettings=t}async waitForFunction(t,e={},...a){const{polling:i="raf",timeout:s=this.timeoutSettings.timeout(),root:r,signal:l}=e;if(typeof i=="number"&&i<0)throw new Error("Cannot poll with non-positive interval");return await new ny(this,{polling:i,root:r,timeout:s,signal:l},t,...a).result}get disposed(){return n(this,ll)}dispose(){f(this,ll,!0),this.taskManager.terminateAll(new Error("waitForFunction failed: frame got detached."))}[ue](){this.dispose()}}ll=new WeakMap;/**
 * @license
 * Copyright 2019 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Ht,Ct,Qo,Ge,cf,df,uf,Zc,Yc;class Xu extends cy{constructor(e,a){super(a);h(this,Ge);h(this,Ht);h(this,Ct,new ye);h(this,Qo);f(this,Qo,e)}get environment(){return n(this,Qo)}get client(){return n(this,Qo).client}get emitter(){return n(this,Ct)}setContext(e){var a;(a=n(this,Ht))==null||a[ue](),e.once("disposed",w(this,Ge,cf).bind(this)),e.on("consoleapicalled",w(this,Ge,df).bind(this)),e.on("bindingcalled",w(this,Ge,uf).bind(this)),f(this,Ht,e),n(this,Ct).emit("context",e),this.taskManager.rerunAll()}hasContext(){return!!n(this,Ht)}get context(){return n(this,Ht)}async evaluateHandle(e,...a){e=ze(this.evaluateHandle.name,e);let i=w(this,Ge,Zc).call(this);return i||(i=await w(this,Ge,Yc).call(this)),await i.evaluateHandle(e,...a)}async evaluate(e,...a){e=ze(this.evaluate.name,e);let i=w(this,Ge,Zc).call(this);return i||(i=await w(this,Ge,Yc).call(this)),await i.evaluate(e,...a)}async adoptBackendNode(e){let a=w(this,Ge,Zc).call(this);a||(a=await w(this,Ge,Yc).call(this));const{object:i}=await this.client.send("DOM.resolveNode",{backendNodeId:e,executionContextId:a.id});return this.createCdpHandle(i)}async adoptHandle(e){if(e.realm===this)return await e.evaluateHandle(i=>i);const a=await this.client.send("DOM.describeNode",{objectId:e.id});return await this.adoptBackendNode(a.node.backendNodeId)}async transferHandle(e){if(e.realm===this||e.remoteObject().objectId===void 0)return e;const a=await this.client.send("DOM.describeNode",{objectId:e.remoteObject().objectId}),i=await this.adoptBackendNode(a.node.backendNodeId);return await e.dispose(),i}createCdpHandle(e){return e.subtype==="node"?new ef(this,e):new Kd(this,e)}[ue](){var e;(e=n(this,Ht))==null||e[ue](),n(this,Ct).emit("disposed",void 0),super[ue](),n(this,Ct).removeAllListeners()}}Ht=new WeakMap,Ct=new WeakMap,Qo=new WeakMap,Ge=new WeakSet,cf=function(){f(this,Ht,void 0),"clearDocumentHandle"in n(this,Qo)&&n(this,Qo).clearDocumentHandle()},df=function(e){n(this,Ct).emit("consoleapicalled",e)},uf=function(e){n(this,Ct).emit("bindingcalled",e)},Zc=function(){if(this.disposed)throw new Error(`Execution context is not available in detached frame or worker "${this.environment.url()}" (are you trying to evaluate?)`);return n(this,Ht)},Yc=async function(){return await tt(Ae(n(this,Ct),"context").pipe(Kt(Ae(n(this,Ct),"disposed").pipe(et(()=>{throw new Error("Execution context was destroyed")})),qt(this.timeoutSettings.timeout()))))};/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const Bt=Symbol("mainWorld"),Xc=Symbol("puppeteerWorld");/**
 * @license
 * Copyright 2019 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const dy=new Map([["load","load"],["domcontentloaded","DOMContentLoaded"],["networkidle0","networkIdle"],["networkidle2","networkAlmostIdle"]]);var cl,ea,tr,ta,bi,dl,yi,ul,pl,ml,gl,hl,po,ve,pf,mf,gf,hf,ff,vf,Jc,_a;class nu{constructor(t,e,a,i){h(this,ve);h(this,cl);h(this,ea);h(this,tr);h(this,ta,null);h(this,bi,new To);h(this,dl);h(this,yi);h(this,ul,de.create());h(this,pl,de.create());h(this,ml,de.create());h(this,gl);h(this,hl);h(this,po);Array.isArray(a)?a=a.slice():typeof a=="string"&&(a=[a]),f(this,dl,e._loaderId),f(this,cl,a.map(c=>{const d=dy.get(c);return L(d,"Unknown value for options.waitUntil: "+c),d})),f(this,ea,e),f(this,tr,i),n(this,bi).use(new ye(e._frameManager)).on(Me.LifecycleEvent,w(this,ve,_a).bind(this));const r=n(this,bi).use(new ye(e));r.on(Fe.FrameNavigatedWithinDocument,w(this,ve,ff).bind(this)),r.on(Fe.FrameNavigated,w(this,ve,vf).bind(this)),r.on(Fe.FrameSwapped,w(this,ve,Jc).bind(this)),r.on(Fe.FrameSwappedByActivation,w(this,ve,Jc).bind(this)),r.on(Fe.FrameDetached,w(this,ve,hf).bind(this));const l=n(this,bi).use(new ye(t));l.on(De.Request,w(this,ve,pf).bind(this)),l.on(De.Response,w(this,ve,gf).bind(this)),l.on(De.RequestFailed,w(this,ve,mf).bind(this)),f(this,yi,de.create({timeout:n(this,tr),message:`Navigation timeout of ${n(this,tr)} ms exceeded`})),w(this,ve,_a).call(this)}async navigationResponse(){var t;return await((t=n(this,po))==null?void 0:t.valueOrThrow()),n(this,ta)?n(this,ta).response():null}sameDocumentNavigationPromise(){return n(this,ul).valueOrThrow()}newDocumentNavigationPromise(){return n(this,ml).valueOrThrow()}lifecyclePromise(){return n(this,pl).valueOrThrow()}terminationPromise(){return n(this,yi).valueOrThrow()}dispose(){n(this,bi).dispose(),n(this,yi).resolve(new Error("LifecycleWatcher disposed"))}}cl=new WeakMap,ea=new WeakMap,tr=new WeakMap,ta=new WeakMap,bi=new WeakMap,dl=new WeakMap,yi=new WeakMap,ul=new WeakMap,pl=new WeakMap,ml=new WeakMap,gl=new WeakMap,hl=new WeakMap,po=new WeakMap,ve=new WeakSet,pf=function(t){var e,a;t.frame()!==n(this,ea)||!t.isNavigationRequest()||(f(this,ta,t),(e=n(this,po))==null||e.resolve(),f(this,po,de.create()),t.response()!==null&&((a=n(this,po))==null||a.resolve()))},mf=function(t){var e,a;((e=n(this,ta))==null?void 0:e.id)===t.id&&((a=n(this,po))==null||a.resolve())},gf=function(t){var e,a;((e=n(this,ta))==null?void 0:e.id)===t.request().id&&((a=n(this,po))==null||a.resolve())},hf=function(t){if(n(this,ea)===t){n(this,yi).resolve(new Error("Navigating frame was detached"));return}w(this,ve,_a).call(this)},ff=function(){f(this,gl,!0),w(this,ve,_a).call(this)},vf=function(t){if(t==="BackForwardCacheRestore")return w(this,ve,Jc).call(this);w(this,ve,_a).call(this)},Jc=function(){f(this,hl,!0),w(this,ve,_a).call(this)},_a=function(){if(!t(n(this,ea),n(this,cl)))return;n(this,pl).resolve(),n(this,gl)&&n(this,ul).resolve(void 0),(n(this,hl)||n(this,ea)._loaderId!==n(this,dl))&&n(this,ml).resolve(void 0);function t(e,a){for(const i of a)if(!e._lifecycleEvents.has(i))return!1;for(const i of e.childFrames())if(i._hasStartedLoading&&!t(i,a))return!1;return!0}};/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var uy=function(o,t,e){for(var a=arguments.length>2,i=0;i<t.length;i++)e=a?t[i].call(o,e):t[i].call(o);return a?e:void 0},Aa=function(o,t,e,a,i,s){function r(T){if(T!==void 0&&typeof T!="function")throw new TypeError("Function expected");return T}for(var l=a.kind,c=l==="getter"?"get":l==="setter"?"set":"value",d=!t&&o?a.static?o:o.prototype:null,u=t||(d?Object.getOwnPropertyDescriptor(d,a.name):{}),p,g=!1,m=e.length-1;m>=0;m--){var v={};for(var b in a)v[b]=b==="access"?{}:a[b];for(var b in a.access)v.access[b]=a.access[b];v.addInitializer=function(T){if(g)throw new TypeError("Cannot add initializers after decoration has completed");s.push(r(T||null))};var E=(0,e[m])(l==="accessor"?{get:u.get,set:u.set}:u[c],v);if(l==="accessor"){if(E===void 0)continue;if(E===null||typeof E!="object")throw new TypeError("Object expected");(p=r(E.get))&&(u.get=p),(p=r(E.set))&&(u.set=p),(p=r(E.init))&&i.unshift(p)}else(p=r(E))&&(l==="field"?i.unshift(p):u[c]=p)}d&&Object.defineProperty(d,a.name,u),g=!0};let zm=(()=>{var d,u,p,g,Ef,bf,yf,E;let o=Vb,t=[],e,a,i,s,r,l,c;return E=class extends o{constructor(S,C,M,B){super();h(this,g);h(this,d,(uy(this,t),""));h(this,u,!1);h(this,p);_(this,"_frameManager");_(this,"_loaderId","");_(this,"_lifecycleEvents",new Set);_(this,"_id");_(this,"_parentId");_(this,"accessibility");_(this,"worlds");this._frameManager=S,f(this,d,""),this._id=C,this._parentId=M,f(this,u,!1),f(this,p,B),this._loaderId="",this.worlds={[Bt]:new Xu(this,this._frameManager.timeoutSettings),[Xc]:new Xu(this,this._frameManager.timeoutSettings)},this.accessibility=new ry(this.worlds[Bt]),this.on(Fe.FrameSwappedByActivation,()=>{this._onLoadingStarted(),this._onLoadingStopped()}),this.worlds[Bt].emitter.on("consoleapicalled",w(this,g,Ef).bind(this)),this.worlds[Bt].emitter.on("bindingcalled",w(this,g,bf).bind(this))}_client(){return n(this,p)}updateId(S){this._id=S}updateClient(S){f(this,p,S)}page(){return this._frameManager.page()}isOOPFrame(){return n(this,p)!==this._frameManager.client}async goto(S,C={}){const{referer:M=this._frameManager.networkManager.extraHTTPHeaders().referer,referrerPolicy:B=this._frameManager.networkManager.extraHTTPHeaders()["referer-policy"],waitUntil:j=["load"],timeout:N=this._frameManager.timeoutSettings.navigationTimeout()}=C;let D=!1;const Y=new nu(this._frameManager.networkManager,this,j,N);let $=await de.race([O(n(this,p),S,M,B,this._id),Y.terminationPromise()]);$||($=await de.race([Y.terminationPromise(),D?Y.newDocumentNavigationPromise():Y.sameDocumentNavigationPromise()]));try{if($)throw $;return await Y.navigationResponse()}finally{Y.dispose()}async function O(x,k,z,ee,ae){try{const te=await x.send("Page.navigate",{url:k,referrer:z,frameId:ae,referrerPolicy:ee});return D=!!te.loaderId,te.errorText==="net::ERR_HTTP_RESPONSE_CODE_FAILURE"?null:te.errorText?new Error(`${te.errorText} at ${k}`):null}catch(te){if(Xt(te))return te;throw te}}}async waitForNavigation(S={}){const{waitUntil:C=["load"],timeout:M=this._frameManager.timeoutSettings.navigationTimeout()}=S,B=new nu(this._frameManager.networkManager,this,C,M),j=await de.race([B.terminationPromise(),...S.ignoreSameDocumentNavigation?[]:[B.sameDocumentNavigationPromise()],B.newDocumentNavigationPromise()]);try{if(j)throw j;const N=await de.race([B.terminationPromise(),B.navigationResponse()]);if(N instanceof Error)throw j;return N||null}finally{B.dispose()}}get client(){return n(this,p)}mainRealm(){return this.worlds[Bt]}isolatedRealm(){return this.worlds[Xc]}async setContent(S,C={}){const{waitUntil:M=["load"],timeout:B=this._frameManager.timeoutSettings.navigationTimeout()}=C;await this.setFrameContent(S);const j=new nu(this._frameManager.networkManager,this,M,B),N=await de.race([j.terminationPromise(),j.lifecyclePromise()]);if(j.dispose(),N)throw N}url(){return n(this,d)}parentFrame(){return this._frameManager._frameTree.parentFrame(this._id)||null}childFrames(){return this._frameManager._frameTree.childFrames(this._id)}async addPreloadScript(S){if(!this.isOOPFrame()&&this!==this._frameManager.mainFrame()||S.getIdForFrame(this))return;const{identifier:C}=await n(this,p).send("Page.addScriptToEvaluateOnNewDocument",{source:S.source});S.setIdForFrame(this,C)}async addExposedFunctionBinding(S){this!==this._frameManager.mainFrame()&&!this._hasStartedLoading||await Promise.all([n(this,p).send("Runtime.addBinding",{name:ls+S.name}),this.evaluate(S.initSource).catch(Z)])}async removeExposedFunctionBinding(S){this!==this._frameManager.mainFrame()&&!this._hasStartedLoading||await Promise.all([n(this,p).send("Runtime.removeBinding",{name:ls+S.name}),this.evaluate(C=>{globalThis[C]=void 0},S.name).catch(Z)])}async waitForDevicePrompt(S={}){return await w(this,g,yf).call(this).waitForDevicePrompt(S)}_navigated(S){this._name=S.name,f(this,d,`${S.url}${S.urlFragment||""}`)}_navigatedWithinDocument(S){f(this,d,S)}_onLifecycleEvent(S,C){C==="init"&&(this._loaderId=S,this._lifecycleEvents.clear()),this._lifecycleEvents.add(C)}_onLoadingStopped(){this._lifecycleEvents.add("DOMContentLoaded"),this._lifecycleEvents.add("load")}_onLoadingStarted(){this._hasStartedLoading=!0}get detached(){return n(this,u)}[(e=[me],a=[me],i=[me],s=[me],r=[me],l=[me],c=[me],ue)](){n(this,u)||(f(this,u,!0),this.worlds[Bt][ue](),this.worlds[Xc][ue]())}exposeFunction(){throw new Ih}},d=new WeakMap,u=new WeakMap,p=new WeakMap,g=new WeakSet,Ef=function(S){this._frameManager.emit(Me.ConsoleApiCalled,[this.worlds[Bt],S])},bf=function(S){this._frameManager.emit(Me.BindingCalled,[this.worlds[Bt],S])},yf=function(){const S=this.page().mainFrame();return this.isOOPFrame()||S===null?this._frameManager._deviceRequestPromptManager(n(this,p)):S._frameManager._deviceRequestPromptManager(n(this,p))},(()=>{const S=typeof Symbol=="function"&&Symbol.metadata?Object.create(o[Symbol.metadata]??null):void 0;Aa(E,null,e,{kind:"method",name:"goto",static:!1,private:!1,access:{has:C=>"goto"in C,get:C=>C.goto},metadata:S},null,t),Aa(E,null,a,{kind:"method",name:"waitForNavigation",static:!1,private:!1,access:{has:C=>"waitForNavigation"in C,get:C=>C.waitForNavigation},metadata:S},null,t),Aa(E,null,i,{kind:"method",name:"setContent",static:!1,private:!1,access:{has:C=>"setContent"in C,get:C=>C.setContent},metadata:S},null,t),Aa(E,null,s,{kind:"method",name:"addPreloadScript",static:!1,private:!1,access:{has:C=>"addPreloadScript"in C,get:C=>C.addPreloadScript},metadata:S},null,t),Aa(E,null,r,{kind:"method",name:"addExposedFunctionBinding",static:!1,private:!1,access:{has:C=>"addExposedFunctionBinding"in C,get:C=>C.addExposedFunctionBinding},metadata:S},null,t),Aa(E,null,l,{kind:"method",name:"removeExposedFunctionBinding",static:!1,private:!1,access:{has:C=>"removeExposedFunctionBinding"in C,get:C=>C.removeExposedFunctionBinding},metadata:S},null,t),Aa(E,null,c,{kind:"method",name:"waitForDevicePrompt",static:!1,private:!1,access:{has:C=>"waitForDevicePrompt"in C,get:C=>C.waitForDevicePrompt},metadata:S},null,t),S&&Object.defineProperty(E,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:S})})(),E})();/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var wi,or,oa,ar,ir,fl;class py{constructor(){h(this,wi,new Map);h(this,or,new Map);h(this,oa,new Map);h(this,ar);h(this,ir,!1);h(this,fl,new Map)}getMainFrame(){return n(this,ar)}getById(t){return n(this,wi).get(t)}waitForFrame(t){const e=this.getById(t);if(e)return Promise.resolve(e);const a=de.create();return(n(this,fl).get(t)||new Set).add(a),a.valueOrThrow()}frames(){return Array.from(n(this,wi).values())}addFrame(t){var e;n(this,wi).set(t._id,t),t._parentId?(n(this,or).set(t._id,t._parentId),n(this,oa).has(t._parentId)||n(this,oa).set(t._parentId,new Set),n(this,oa).get(t._parentId).add(t._id)):(!n(this,ar)||n(this,ir))&&(f(this,ar,t),f(this,ir,!1)),(e=n(this,fl).get(t._id))==null||e.forEach(a=>a.resolve(t))}removeFrame(t){var e;n(this,wi).delete(t._id),n(this,or).delete(t._id),t._parentId?(e=n(this,oa).get(t._parentId))==null||e.delete(t._id):f(this,ir,!0)}childFrames(t){const e=n(this,oa).get(t);return e?Array.from(e).map(a=>this.getById(a)).filter(a=>a!==void 0):[]}parentFrame(t){const e=n(this,or).get(t);return e?this.getById(e):void 0}}wi=new WeakMap,or=new WeakMap,oa=new WeakMap,ar=new WeakMap,ir=new WeakMap,fl=new WeakMap;class Lm{constructor(){_(this,"_interceptionId");_(this,"_failureText",null);_(this,"_response",null);_(this,"_fromMemoryCache",!1);_(this,"_redirectChain",[]);_(this,"interception",{enabled:!1,handled:!1,handlers:[],resolutionState:{action:Ft.None},requestOverrides:{},response:null,abortReason:null})}continueRequestOverrides(){return L(this.interception.enabled,"Request Interception is not enabled!"),this.interception.requestOverrides}responseForRequest(){return L(this.interception.enabled,"Request Interception is not enabled!"),this.interception.response}abortErrorReason(){return L(this.interception.enabled,"Request Interception is not enabled!"),this.interception.abortReason}interceptResolutionState(){return this.interception.enabled?this.interception.handled?{action:Ft.AlreadyHandled}:{...this.interception.resolutionState}:{action:Ft.Disabled}}isInterceptResolutionHandled(){return this.interception.handled}enqueueInterceptAction(t){this.interception.handlers.push(t)}async finalizeInterceptions(){await this.interception.handlers.reduce((e,a)=>e.then(a),Promise.resolve()),this.interception.handlers=[];const{action:t}=this.interceptResolutionState();switch(t){case"abort":return await this._abort(this.interception.abortReason);case"respond":if(this.interception.response===null)throw new Error("Response is missing for the interception");return await this._respond(this.interception.response);case"continue":return await this._continue(this.interception.requestOverrides)}}async continue(t={},e){if(!this.url().startsWith("data:")){if(L(this.interception.enabled,"Request Interception is not enabled!"),L(!this.interception.handled,"Request is already handled!"),e===void 0)return await this._continue(t);if(this.interception.requestOverrides=t,this.interception.resolutionState.priority===void 0||e>this.interception.resolutionState.priority){this.interception.resolutionState={action:Ft.Continue,priority:e};return}if(e===this.interception.resolutionState.priority){if(this.interception.resolutionState.action==="abort"||this.interception.resolutionState.action==="respond")return;this.interception.resolutionState.action=Ft.Continue}}}async respond(t,e){if(!this.url().startsWith("data:")){if(L(this.interception.enabled,"Request Interception is not enabled!"),L(!this.interception.handled,"Request is already handled!"),e===void 0)return await this._respond(t);if(this.interception.response=t,this.interception.resolutionState.priority===void 0||e>this.interception.resolutionState.priority){this.interception.resolutionState={action:Ft.Respond,priority:e};return}if(e===this.interception.resolutionState.priority){if(this.interception.resolutionState.action==="abort")return;this.interception.resolutionState.action=Ft.Respond}}}async abort(t="failed",e){if(this.url().startsWith("data:"))return;const a=gy[t];if(L(a,"Unknown error code: "+t),L(this.interception.enabled,"Request Interception is not enabled!"),L(!this.interception.handled,"Request is already handled!"),e===void 0)return await this._abort(a);if(this.interception.abortReason=a,this.interception.resolutionState.priority===void 0||e>=this.interception.resolutionState.priority){this.interception.resolutionState={action:Ft.Abort,priority:e};return}}static getResponse(t){const e=Wi(t)?new TextEncoder().encode(t):t,a=[];for(const i of e)a.push(String.fromCharCode(i));return{contentLength:e.byteLength,base64:btoa(a.join(""))}}}var Ft;(function(o){o.Abort="abort",o.Respond="respond",o.Continue="continue",o.Disabled="disabled",o.None="none",o.AlreadyHandled="already-handled"})(Ft||(Ft={}));function Nm(o){const t=[];for(const e in o){const a=o[e];if(!Object.is(a,void 0)){const i=Array.isArray(a)?a:[a];t.push(...i.map(s=>({name:e,value:s+""})))}}return t}const my={100:"Continue",101:"Switching Protocols",102:"Processing",103:"Early Hints",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",208:"Already Reported",226:"IM Used",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",306:"Switch Proxy",307:"Temporary Redirect",308:"Permanent Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Payload Too Large",414:"URI Too Long",415:"Unsupported Media Type",416:"Range Not Satisfiable",417:"Expectation Failed",418:"I'm a teapot",421:"Misdirected Request",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",425:"Too Early",426:"Upgrade Required",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",451:"Unavailable For Legal Reasons",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",508:"Loop Detected",510:"Not Extended",511:"Network Authentication Required"},gy={aborted:"Aborted",accessdenied:"AccessDenied",addressunreachable:"AddressUnreachable",blockedbyclient:"BlockedByClient",blockedbyresponse:"BlockedByResponse",connectionaborted:"ConnectionAborted",connectionclosed:"ConnectionClosed",connectionfailed:"ConnectionFailed",connectionrefused:"ConnectionRefused",connectionreset:"ConnectionReset",internetdisconnected:"InternetDisconnected",namenotresolved:"NameNotResolved",timedout:"TimedOut",failed:"Failed"};function lu(o){if(o.originalMessage.includes("Invalid header")||o.originalMessage.includes('Expected "header"')||o.originalMessage.includes("invalid argument"))throw o;Z(o)}var mo,vl,El,bl,yl,wl,Tl,xl,Il,Sl;class Pm extends Lm{constructor(e,a,i,s,r,l){super();_(this,"id");h(this,mo);h(this,vl);h(this,El);h(this,bl);h(this,yl);h(this,wl,!1);h(this,Tl);h(this,xl,{});h(this,Il);h(this,Sl);f(this,mo,e),this.id=r.requestId,f(this,vl,r.requestId===r.loaderId&&r.type==="Document"),this._interceptionId=i,f(this,El,r.request.url),f(this,bl,(r.type||"other").toLowerCase()),f(this,yl,r.request.method),f(this,Tl,r.request.postData),f(this,wl,r.request.hasPostData??!1),f(this,Il,a),this._redirectChain=l,f(this,Sl,r.initiator),this.interception.enabled=s;for(const[c,d]of Object.entries(r.request.headers))n(this,xl)[c.toLowerCase()]=d}get client(){return n(this,mo)}url(){return n(this,El)}resourceType(){return n(this,bl)}method(){return n(this,yl)}postData(){return n(this,Tl)}hasPostData(){return n(this,wl)}async fetchPostData(){try{return(await n(this,mo).send("Network.getRequestPostData",{requestId:this.id})).postData}catch(e){Z(e);return}}headers(){return n(this,xl)}response(){return this._response}frame(){return n(this,Il)}isNavigationRequest(){return n(this,vl)}initiator(){return n(this,Sl)}redirectChain(){return this._redirectChain.slice()}failure(){return this._failureText?{errorText:this._failureText}:null}async _continue(e={}){const{url:a,method:i,postData:s,headers:r}=e;this.interception.handled=!0;const l=s?btoa(s):void 0;if(this._interceptionId===void 0)throw new Error("HTTPRequest is missing _interceptionId needed for Fetch.continueRequest");await n(this,mo).send("Fetch.continueRequest",{requestId:this._interceptionId,url:a,method:i,postData:l,headers:r?Nm(r):void 0}).catch(c=>(this.interception.handled=!1,lu(c)))}async _respond(e){this.interception.handled=!0;let a;e.body&&(a=Lm.getResponse(e.body));const i={};if(e.headers)for(const r of Object.keys(e.headers)){const l=e.headers[r];i[r.toLowerCase()]=Array.isArray(l)?l.map(c=>String(c)):String(l)}e.contentType&&(i["content-type"]=e.contentType),a!=null&&a.contentLength&&!("content-length"in i)&&(i["content-length"]=String(a.contentLength));const s=e.status||200;if(this._interceptionId===void 0)throw new Error("HTTPRequest is missing _interceptionId needed for Fetch.fulfillRequest");await n(this,mo).send("Fetch.fulfillRequest",{requestId:this._interceptionId,responseCode:s,responsePhrase:my[s],responseHeaders:Nm(i),body:a==null?void 0:a.base64}).catch(r=>(this.interception.handled=!1,lu(r)))}async _abort(e){if(this.interception.handled=!0,this._interceptionId===void 0)throw new Error("HTTPRequest is missing _interceptionId needed for Fetch.failRequest");await n(this,mo).send("Fetch.failRequest",{requestId:this._interceptionId,errorReason:e||"Failed"}).catch(lu)}}mo=new WeakMap,vl=new WeakMap,El=new WeakMap,bl=new WeakMap,yl=new WeakMap,wl=new WeakMap,Tl=new WeakMap,xl=new WeakMap,Il=new WeakMap,Sl=new WeakMap;/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class hy{constructor(){}ok(){const t=this.status();return t===0||t>=200&&t<=299}async text(){return(await this.buffer()).toString("utf8")}async json(){const t=await this.text();return JSON.parse(t)}}/**
 * @license
 * Copyright 2020 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Al,Cl,Rl,_l,Ol,Dl;class fy{constructor(t){h(this,Al);h(this,Cl);h(this,Rl);h(this,_l);h(this,Ol);h(this,Dl);f(this,Al,t.subjectName),f(this,Cl,t.issuer),f(this,Rl,t.validFrom),f(this,_l,t.validTo),f(this,Ol,t.protocol),f(this,Dl,t.sanList)}issuer(){return n(this,Cl)}validFrom(){return n(this,Rl)}validTo(){return n(this,_l)}protocol(){return n(this,Ol)}subjectName(){return n(this,Al)}subjectAlternativeNames(){return n(this,Dl)}}Al=new WeakMap,Cl=new WeakMap,Rl=new WeakMap,_l=new WeakMap,Ol=new WeakMap,Dl=new WeakMap;/**
 * @license
 * Copyright 2020 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Ml,aa,sr,rr,zl,Ll,Nl,Pl,kl,Bl,Fl,$l,Ul,Md,wf;class km extends hy{constructor(e,a,i,s){super();h(this,Md);h(this,Ml);h(this,aa);h(this,sr,null);h(this,rr,de.create());h(this,zl);h(this,Ll);h(this,Nl);h(this,Pl);h(this,kl);h(this,Bl);h(this,Fl,{});h(this,$l);h(this,Ul);f(this,Ml,e),f(this,aa,a),f(this,zl,{ip:i.remoteIPAddress,port:i.remotePort}),f(this,Nl,w(this,Md,wf).call(this,s)||i.statusText),f(this,Pl,a.url()),f(this,kl,!!i.fromDiskCache),f(this,Bl,!!i.fromServiceWorker),f(this,Ll,s?s.statusCode:i.status);const r=s?s.headers:i.headers;for(const[l,c]of Object.entries(r))n(this,Fl)[l.toLowerCase()]=c;f(this,$l,i.securityDetails?new fy(i.securityDetails):null),f(this,Ul,i.timing||null)}_resolveBody(e){return e?n(this,rr).reject(e):n(this,rr).resolve()}remoteAddress(){return n(this,zl)}url(){return n(this,Pl)}status(){return n(this,Ll)}statusText(){return n(this,Nl)}headers(){return n(this,Fl)}securityDetails(){return n(this,$l)}timing(){return n(this,Ul)}buffer(){return n(this,sr)||f(this,sr,n(this,rr).valueOrThrow().then(async()=>{try{const e=await n(this,Ml).send("Network.getResponseBody",{requestId:n(this,aa).id});return Buffer.from(e.body,e.base64Encoded?"base64":"utf8")}catch(e){throw e instanceof rn&&e.originalMessage==="No resource with given identifier found"?new rn("Could not load body for this request. This might happen if the request is a preflight request."):e}})),n(this,sr)}request(){return n(this,aa)}fromCache(){return n(this,kl)||n(this,aa)._fromMemoryCache}fromServiceWorker(){return n(this,Bl)}frame(){return n(this,aa).frame()}}Ml=new WeakMap,aa=new WeakMap,sr=new WeakMap,rr=new WeakMap,zl=new WeakMap,Ll=new WeakMap,Nl=new WeakMap,Pl=new WeakMap,kl=new WeakMap,Bl=new WeakMap,Fl=new WeakMap,$l=new WeakMap,Ul=new WeakMap,Md=new WeakSet,wf=function(e){if(!e||!e.headersText)return;const a=e.headersText.split("\r",1)[0];if(!a)return;const i=a.match(/[^ ]* [^ ]* (.*)/);if(!i)return;const s=i[1];if(s)return s};/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Ti,xi,Ii,Si,Ai,Ci;class vy{constructor(){h(this,Ti,new Map);h(this,xi,new Map);h(this,Ii,new Map);h(this,Si,new Map);h(this,Ai,new Map);h(this,Ci,new Map)}forget(t){n(this,Ti).delete(t),n(this,xi).delete(t),n(this,Ci).delete(t),n(this,Ai).delete(t),n(this,Si).delete(t)}responseExtraInfo(t){return n(this,Si).has(t)||n(this,Si).set(t,[]),n(this,Si).get(t)}queuedRedirectInfo(t){return n(this,Ai).has(t)||n(this,Ai).set(t,[]),n(this,Ai).get(t)}queueRedirectInfo(t,e){this.queuedRedirectInfo(t).push(e)}takeQueuedRedirectInfo(t){return this.queuedRedirectInfo(t).shift()}inFlightRequestsCount(){let t=0;for(const e of n(this,Ii).values())e.response()||t++;return t}storeRequestWillBeSent(t,e){n(this,Ti).set(t,e)}getRequestWillBeSent(t){return n(this,Ti).get(t)}forgetRequestWillBeSent(t){n(this,Ti).delete(t)}getRequestPaused(t){return n(this,xi).get(t)}forgetRequestPaused(t){n(this,xi).delete(t)}storeRequestPaused(t,e){n(this,xi).set(t,e)}getRequest(t){return n(this,Ii).get(t)}storeRequest(t,e){n(this,Ii).set(t,e)}forgetRequest(t){n(this,Ii).delete(t)}getQueuedEventGroup(t){return n(this,Ci).get(t)}queueEventGroup(t,e){n(this,Ci).set(t,e)}forgetQueuedEventGroup(t){n(this,Ci).delete(t)}}Ti=new WeakMap,xi=new WeakMap,Ii=new WeakMap,Si=new WeakMap,Ai=new WeakMap,Ci=new WeakMap;/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var nr,re,Ri,ia,lr,Vt,go,sa,We,cr,jl,zd,ra,F,Tf,Ju,Lo,Qc,Qu,ed,Zr,xf,If,Sf,ep,Af,Yr,Cf,Rf,tp,_f,Of,td,Df,op,Mf,ap;class Ey extends ye{constructor(e){super();h(this,F);h(this,nr);h(this,re,new vy);h(this,Ri);h(this,ia,null);h(this,lr,new Set);h(this,Vt,!1);h(this,go,!1);h(this,sa);h(this,We);h(this,cr);h(this,jl);h(this,zd,[["Fetch.requestPaused",w(this,F,Sf)],["Fetch.authRequired",w(this,F,If)],["Network.requestWillBeSent",w(this,F,xf)],["Network.requestServedFromCache",w(this,F,Cf)],["Network.responseReceived",w(this,F,_f)],["Network.loadingFinished",w(this,F,Df)],["Network.loadingFailed",w(this,F,Mf)],["Network.responseReceivedExtraInfo",w(this,F,Of)],[ge.Disconnected,w(this,F,Tf)]]);h(this,ra,new Map);f(this,nr,e)}async addClient(e){if(n(this,ra).has(e))return;const a=new To;n(this,ra).set(e,a);const i=a.use(new ye(e));for(const[s,r]of n(this,zd))i.on(s,l=>r.bind(this)(e,l));await Promise.all([e.send("Network.enable"),w(this,F,Ju).call(this,e),w(this,F,Qc).call(this,e),w(this,F,Zr).call(this,e),w(this,F,ed).call(this,e),w(this,F,Qu).call(this,e)])}async authenticate(e){f(this,ia,e);const a=n(this,Vt)||!!n(this,ia);a!==n(this,go)&&(f(this,go,a),await w(this,F,Lo).call(this,w(this,F,ed).bind(this)))}async setExtraHTTPHeaders(e){const a={};for(const[i,s]of Object.entries(e))L(Wi(s),`Expected value of header "${i}" to be String, but "${typeof s}" is found.`),a[i.toLowerCase()]=s;f(this,Ri,a),await w(this,F,Lo).call(this,w(this,F,Ju).bind(this))}extraHTTPHeaders(){return Object.assign({},n(this,Ri))}inFlightRequestsCount(){return n(this,re).inFlightRequestsCount()}async setOfflineMode(e){n(this,We)||f(this,We,{offline:!1,upload:-1,download:-1,latency:0}),n(this,We).offline=e,await w(this,F,Lo).call(this,w(this,F,Qc).bind(this))}async emulateNetworkConditions(e){n(this,We)||f(this,We,{offline:!1,upload:-1,download:-1,latency:0}),n(this,We).upload=e?e.upload:-1,n(this,We).download=e?e.download:-1,n(this,We).latency=e?e.latency:0,await w(this,F,Lo).call(this,w(this,F,Qc).bind(this))}async setUserAgent(e,a){f(this,cr,e),f(this,jl,a),await w(this,F,Lo).call(this,w(this,F,Qu).bind(this))}async setCacheEnabled(e){f(this,sa,!e),await w(this,F,Lo).call(this,w(this,F,Zr).bind(this))}async setRequestInterception(e){f(this,Vt,e);const a=n(this,Vt)||!!n(this,ia);a!==n(this,go)&&(f(this,go,a),await w(this,F,Lo).call(this,w(this,F,ed).bind(this)))}}nr=new WeakMap,re=new WeakMap,Ri=new WeakMap,ia=new WeakMap,lr=new WeakMap,Vt=new WeakMap,go=new WeakMap,sa=new WeakMap,We=new WeakMap,cr=new WeakMap,jl=new WeakMap,zd=new WeakMap,ra=new WeakMap,F=new WeakSet,Tf=async function(e){var a;(a=n(this,ra).get(e))==null||a.dispose(),n(this,ra).delete(e)},Ju=async function(e){n(this,Ri)!==void 0&&await e.send("Network.setExtraHTTPHeaders",{headers:n(this,Ri)})},Lo=async function(e){await Promise.all(Array.from(n(this,ra).keys()).map(a=>e(a)))},Qc=async function(e){n(this,We)!==void 0&&await e.send("Network.emulateNetworkConditions",{offline:n(this,We).offline,latency:n(this,We).latency,uploadThroughput:n(this,We).upload,downloadThroughput:n(this,We).download})},Qu=async function(e){n(this,cr)!==void 0&&await e.send("Network.setUserAgentOverride",{userAgent:n(this,cr),userAgentMetadata:n(this,jl)})},ed=async function(e){n(this,sa)===void 0&&f(this,sa,!1),n(this,go)?await Promise.all([w(this,F,Zr).call(this,e),e.send("Fetch.enable",{handleAuthRequests:!0,patterns:[{urlPattern:"*"}]})]):await Promise.all([w(this,F,Zr).call(this,e),e.send("Fetch.disable")])},Zr=async function(e){n(this,sa)!==void 0&&await e.send("Network.setCacheDisabled",{cacheDisabled:n(this,sa)})},xf=function(e,a){if(n(this,Vt)&&!a.request.url.startsWith("data:")){const{requestId:i}=a;n(this,re).storeRequestWillBeSent(i,a);const s=n(this,re).getRequestPaused(i);if(s){const{requestId:r}=s;w(this,F,ep).call(this,a,s),w(this,F,Yr).call(this,e,a,r),n(this,re).forgetRequestPaused(i)}return}w(this,F,Yr).call(this,e,a,void 0)},If=function(e,a){let i="Default";n(this,lr).has(a.requestId)?i="CancelAuth":n(this,ia)&&(i="ProvideCredentials",n(this,lr).add(a.requestId));const{username:s,password:r}=n(this,ia)||{username:void 0,password:void 0};e.send("Fetch.continueWithAuth",{requestId:a.requestId,authChallengeResponse:{response:i,username:s,password:r}}).catch(Z)},Sf=function(e,a){!n(this,Vt)&&n(this,go)&&e.send("Fetch.continueRequest",{requestId:a.requestId}).catch(Z);const{networkId:i,requestId:s}=a;if(!i){w(this,F,Af).call(this,e,a);return}const r=(()=>{const l=n(this,re).getRequestWillBeSent(i);if(l&&(l.request.url!==a.request.url||l.request.method!==a.request.method)){n(this,re).forgetRequestWillBeSent(i);return}return l})();r?(w(this,F,ep).call(this,r,a),w(this,F,Yr).call(this,e,r,s)):n(this,re).storeRequestPaused(i,a)},ep=function(e,a){e.request.headers={...e.request.headers,...a.request.headers}},Af=function(e,a){const i=a.frameId?n(this,nr).frame(a.frameId):null,s=new Pm(e,i,a.requestId,n(this,Vt),a,[]);this.emit(De.Request,s),s.finalizeInterceptions()},Yr=function(e,a,i){let s=[];if(a.redirectResponse){let c=null;if(a.redirectHasExtraInfo&&(c=n(this,re).responseExtraInfo(a.requestId).shift(),!c)){n(this,re).queueRedirectInfo(a.requestId,{event:a,fetchRequestId:i});return}const d=n(this,re).getRequest(a.requestId);d&&(w(this,F,Rf).call(this,e,d,a.redirectResponse,c),s=d._redirectChain)}const r=a.frameId?n(this,nr).frame(a.frameId):null,l=new Pm(e,r,i,n(this,Vt),a,s);n(this,re).storeRequest(a.requestId,l),this.emit(De.Request,l),l.finalizeInterceptions()},Cf=function(e,a){const i=n(this,re).getRequest(a.requestId);i&&(i._fromMemoryCache=!0),this.emit(De.RequestServedFromCache,i)},Rf=function(e,a,i,s){const r=new km(e,a,i,s);a._response=r,a._redirectChain.push(a),r._resolveBody(new Error("Response body is unavailable for redirect responses")),w(this,F,td).call(this,a,!1),this.emit(De.Response,r),this.emit(De.RequestFinished,a)},tp=function(e,a,i){const s=n(this,re).getRequest(a.requestId);if(!s)return;n(this,re).responseExtraInfo(a.requestId).length&&Z(new Error("Unexpected extraInfo events for request "+a.requestId)),a.response.fromDiskCache&&(i=null);const l=new km(e,s,a.response,i);s._response=l,this.emit(De.Response,l)},_f=function(e,a){const i=n(this,re).getRequest(a.requestId);let s=null;if(i&&!i._fromMemoryCache&&a.hasExtraInfo&&(s=n(this,re).responseExtraInfo(a.requestId).shift(),!s)){n(this,re).queueEventGroup(a.requestId,{responseReceivedEvent:a});return}w(this,F,tp).call(this,e,a,s)},Of=function(e,a){const i=n(this,re).takeQueuedRedirectInfo(a.requestId);if(i){n(this,re).responseExtraInfo(a.requestId).push(a),w(this,F,Yr).call(this,e,i.event,i.fetchRequestId);return}const s=n(this,re).getQueuedEventGroup(a.requestId);if(s){n(this,re).forgetQueuedEventGroup(a.requestId),w(this,F,tp).call(this,e,s.responseReceivedEvent,a),s.loadingFinishedEvent&&w(this,F,op).call(this,s.loadingFinishedEvent),s.loadingFailedEvent&&w(this,F,ap).call(this,s.loadingFailedEvent);return}n(this,re).responseExtraInfo(a.requestId).push(a)},td=function(e,a){const i=e.id,s=e._interceptionId;n(this,re).forgetRequest(i),s!==void 0&&n(this,lr).delete(s),a&&n(this,re).forget(i)},Df=function(e,a){const i=n(this,re).getQueuedEventGroup(a.requestId);i?i.loadingFinishedEvent=a:w(this,F,op).call(this,a)},op=function(e){var i;const a=n(this,re).getRequest(e.requestId);a&&(a.response()&&((i=a.response())==null||i._resolveBody()),w(this,F,td).call(this,a,!0),this.emit(De.RequestFinished,a))},Mf=function(e,a){const i=n(this,re).getQueuedEventGroup(a.requestId);i?i.loadingFailedEvent=a:w(this,F,ap).call(this,a)},ap=function(e){const a=n(this,re).getRequest(e.requestId);if(!a)return;a._failureText=e.errorText;const i=a.response();i&&i._resolveBody(),w(this,F,td).call(this,a,!0),this.emit(De.RequestFailed,a)};/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const by=100;var Hl,na,dr,Vl,ft,_i,ur,Oi,Wl,Xe,oe,ip,zf,Lf,Nf,sp,rp,np,Pf,kf,Bf,Ff,es;class yy extends ye{constructor(e,a,i){super();h(this,oe);h(this,Hl);h(this,na);h(this,dr);h(this,Vl,new Set);h(this,ft);h(this,_i,new Map);h(this,ur,new Set);_(this,"_frameTree",new py);h(this,Oi,new Set);h(this,Wl,new WeakMap);h(this,Xe);f(this,ft,e),f(this,Hl,a),f(this,na,new Ey(this)),f(this,dr,i),this.setupEventListeners(n(this,ft)),e.once(ge.Disconnected,()=>{w(this,oe,ip).call(this).catch(Z)})}get timeoutSettings(){return n(this,dr)}get networkManager(){return n(this,na)}get client(){return n(this,ft)}async swapFrameTree(e){f(this,ft,e),L(n(this,ft)instanceof ns,"CDPSession is not an instance of CDPSessionImpl.");const a=this._frameTree.getMainFrame();a&&(n(this,Oi).add(n(this,ft)._target()._targetId),this._frameTree.removeFrame(a),a.updateId(n(this,ft)._target()._targetId),this._frameTree.addFrame(a),a.updateClient(e)),this.setupEventListeners(e),e.once(ge.Disconnected,()=>{w(this,oe,ip).call(this).catch(Z)}),await this.initialize(e,a),await n(this,na).addClient(e),a&&a.emit(Fe.FrameSwappedByActivation,void 0)}async registerSpeculativeSession(e){await n(this,na).addClient(e)}setupEventListeners(e){e.on("Page.frameAttached",async a=>{var i;await((i=n(this,Xe))==null?void 0:i.valueOrThrow()),w(this,oe,rp).call(this,e,a.frameId,a.parentFrameId)}),e.on("Page.frameNavigated",async a=>{var i;n(this,Oi).add(a.frame.id),await((i=n(this,Xe))==null?void 0:i.valueOrThrow()),w(this,oe,np).call(this,a.frame,a.type)}),e.on("Page.navigatedWithinDocument",async a=>{var i;await((i=n(this,Xe))==null?void 0:i.valueOrThrow()),w(this,oe,kf).call(this,a.frameId,a.url)}),e.on("Page.frameDetached",async a=>{var i;await((i=n(this,Xe))==null?void 0:i.valueOrThrow()),w(this,oe,Bf).call(this,a.frameId,a.reason)}),e.on("Page.frameStartedLoading",async a=>{var i;await((i=n(this,Xe))==null?void 0:i.valueOrThrow()),w(this,oe,Lf).call(this,a.frameId)}),e.on("Page.frameStoppedLoading",async a=>{var i;await((i=n(this,Xe))==null?void 0:i.valueOrThrow()),w(this,oe,Nf).call(this,a.frameId)}),e.on("Runtime.executionContextCreated",async a=>{var i;await((i=n(this,Xe))==null?void 0:i.valueOrThrow()),w(this,oe,Ff).call(this,a.context,e)}),e.on("Page.lifecycleEvent",async a=>{var i;await((i=n(this,Xe))==null?void 0:i.valueOrThrow()),w(this,oe,zf).call(this,a)})}async initialize(e,a){var i,s;try{(i=n(this,Xe))==null||i.resolve(),f(this,Xe,de.create()),await Promise.all([n(this,na).addClient(e),e.send("Page.enable"),e.send("Page.getFrameTree").then(({frameTree:r})=>{var l;w(this,oe,sp).call(this,e,r),(l=n(this,Xe))==null||l.resolve()}),e.send("Page.setLifecycleEventsEnabled",{enabled:!0}),e.send("Runtime.enable").then(()=>w(this,oe,Pf).call(this,e,xm)),...(a?Array.from(n(this,_i).values()):[]).map(r=>a==null?void 0:a.addPreloadScript(r)),...(a?Array.from(n(this,ur).values()):[]).map(r=>a==null?void 0:a.addExposedFunctionBinding(r))])}catch(r){if((s=n(this,Xe))==null||s.resolve(),Xt(r)&&Iu(r))return;throw r}}page(){return n(this,Hl)}mainFrame(){const e=this._frameTree.getMainFrame();return L(e,"Requesting main frame too early!"),e}frames(){return Array.from(this._frameTree.frames())}frame(e){return this._frameTree.getById(e)||null}async addExposedFunctionBinding(e){n(this,ur).add(e),await Promise.all(this.frames().map(async a=>await a.addExposedFunctionBinding(e)))}async removeExposedFunctionBinding(e){n(this,ur).delete(e),await Promise.all(this.frames().map(async a=>await a.removeExposedFunctionBinding(e)))}async evaluateOnNewDocument(e){const{identifier:a}=await this.mainFrame()._client().send("Page.addScriptToEvaluateOnNewDocument",{source:e}),i=new Wb(this.mainFrame(),a,e);return n(this,_i).set(a,i),await Promise.all(this.frames().map(async s=>await s.addPreloadScript(i))),{identifier:a}}async removeScriptToEvaluateOnNewDocument(e){const a=n(this,_i).get(e);if(!a)throw new Error(`Script to evaluate on new document with id ${e} not found`);n(this,_i).delete(e),await Promise.all(this.frames().map(i=>{const s=a.getIdForFrame(i);if(s)return i._client().send("Page.removeScriptToEvaluateOnNewDocument",{identifier:s}).catch(Z)}))}onAttachedToTarget(e){if(e._getTargetInfo().type!=="iframe")return;const a=this.frame(e._getTargetInfo().targetId);a&&a.updateClient(e._session()),this.setupEventListeners(e._session()),this.initialize(e._session(),a)}_deviceRequestPromptManager(e){let a=n(this,Wl).get(e);return a===void 0&&(a=new qb(e,n(this,dr)),n(this,Wl).set(e,a)),a}}Hl=new WeakMap,na=new WeakMap,dr=new WeakMap,Vl=new WeakMap,ft=new WeakMap,_i=new WeakMap,ur=new WeakMap,Oi=new WeakMap,Wl=new WeakMap,Xe=new WeakMap,oe=new WeakSet,ip=async function(){const e=this._frameTree.getMainFrame();if(!e)return;for(const i of e.childFrames())w(this,oe,es).call(this,i);const a=de.create({timeout:by,message:"Frame was not swapped"});e.once(Fe.FrameSwappedByActivation,()=>{a.resolve()});try{await a.valueOrThrow()}catch{w(this,oe,es).call(this,e)}},zf=function(e){const a=this.frame(e.frameId);a&&(a._onLifecycleEvent(e.loaderId,e.name),this.emit(Me.LifecycleEvent,a),a.emit(Fe.LifecycleEvent,void 0))},Lf=function(e){const a=this.frame(e);a&&a._onLoadingStarted()},Nf=function(e){const a=this.frame(e);a&&(a._onLoadingStopped(),this.emit(Me.LifecycleEvent,a),a.emit(Fe.LifecycleEvent,void 0))},sp=function(e,a){if(a.frame.parentId&&w(this,oe,rp).call(this,e,a.frame.id,a.frame.parentId),n(this,Oi).has(a.frame.id)?n(this,Oi).delete(a.frame.id):w(this,oe,np).call(this,a.frame,"Navigation"),!!a.childFrames)for(const i of a.childFrames)w(this,oe,sp).call(this,e,i)},rp=function(e,a,i){let s=this.frame(a);if(s){e&&s.isOOPFrame()&&s.updateClient(e);return}s=new zm(this,a,i,e),this._frameTree.addFrame(s),this.emit(Me.FrameAttached,s)},np=async function(e,a){const i=e.id,s=!e.parentId;let r=this._frameTree.getById(i);if(r)for(const l of r.childFrames())w(this,oe,es).call(this,l);s&&(r?(this._frameTree.removeFrame(r),r._id=i):r=new zm(this,i,void 0,n(this,ft)),this._frameTree.addFrame(r)),r=await this._frameTree.waitForFrame(i),r._navigated(e),this.emit(Me.FrameNavigated,r),r.emit(Fe.FrameNavigated,a)},Pf=async function(e,a){const i=`${e.id()}:${a}`;n(this,Vl).has(i)||(await e.send("Page.addScriptToEvaluateOnNewDocument",{source:`//# sourceURL=${wo.INTERNAL_URL}`,worldName:a}),await Promise.all(this.frames().filter(s=>s.client===e).map(s=>e.send("Page.createIsolatedWorld",{frameId:s._id,worldName:a,grantUniveralAccess:!0}).catch(Z))),n(this,Vl).add(i))},kf=function(e,a){const i=this.frame(e);i&&(i._navigatedWithinDocument(a),this.emit(Me.FrameNavigatedWithinDocument,i),i.emit(Fe.FrameNavigatedWithinDocument,void 0),this.emit(Me.FrameNavigated,i),i.emit(Fe.FrameNavigated,"Navigation"))},Bf=function(e,a){const i=this.frame(e);if(i)switch(a){case"remove":w(this,oe,es).call(this,i);break;case"swap":this.emit(Me.FrameSwapped,i),i.emit(Fe.FrameSwapped,void 0);break}},Ff=function(e,a){const i=e.auxData,s=i&&i.frameId,r=typeof s=="string"?this.frame(s):void 0;let l;if(r){if(r.client!==a)return;e.auxData&&e.auxData.isDefault?l=r.worlds[Bt]:e.name===xm&&(l=r.worlds[Xc])}if(!l)return;const c=new of((r==null?void 0:r.client)||n(this,ft),e,l);l.setContext(c)},es=function(e){for(const a of e.childFrames())w(this,oe,es).call(this,a);e[ue](),this._frameTree.removeFrame(e),this.emit(Me.FrameDetached,e),e.emit(Fe.FrameDetached,e)};/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class wy{constructor(){}}const $e=Object.freeze({Left:"left",Right:"right",Middle:"middle",Back:"back",Forward:"forward"});class Ty{constructor(){}}class xy{constructor(){}async tap(t,e){await this.touchStart(t,e),await this.touchEnd()}}/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const Bm={0:{keyCode:48,key:"0",code:"Digit0"},1:{keyCode:49,key:"1",code:"Digit1"},2:{keyCode:50,key:"2",code:"Digit2"},3:{keyCode:51,key:"3",code:"Digit3"},4:{keyCode:52,key:"4",code:"Digit4"},5:{keyCode:53,key:"5",code:"Digit5"},6:{keyCode:54,key:"6",code:"Digit6"},7:{keyCode:55,key:"7",code:"Digit7"},8:{keyCode:56,key:"8",code:"Digit8"},9:{keyCode:57,key:"9",code:"Digit9"},Power:{key:"Power",code:"Power"},Eject:{key:"Eject",code:"Eject"},Abort:{keyCode:3,code:"Abort",key:"Cancel"},Help:{keyCode:6,code:"Help",key:"Help"},Backspace:{keyCode:8,code:"Backspace",key:"Backspace"},Tab:{keyCode:9,code:"Tab",key:"Tab"},Numpad5:{keyCode:12,shiftKeyCode:101,key:"Clear",code:"Numpad5",shiftKey:"5",location:3},NumpadEnter:{keyCode:13,code:"NumpadEnter",key:"Enter",text:"\r",location:3},Enter:{keyCode:13,code:"Enter",key:"Enter",text:"\r"},"\r":{keyCode:13,code:"Enter",key:"Enter",text:"\r"},"\n":{keyCode:13,code:"Enter",key:"Enter",text:"\r"},ShiftLeft:{keyCode:16,code:"ShiftLeft",key:"Shift",location:1},ShiftRight:{keyCode:16,code:"ShiftRight",key:"Shift",location:2},ControlLeft:{keyCode:17,code:"ControlLeft",key:"Control",location:1},ControlRight:{keyCode:17,code:"ControlRight",key:"Control",location:2},AltLeft:{keyCode:18,code:"AltLeft",key:"Alt",location:1},AltRight:{keyCode:18,code:"AltRight",key:"Alt",location:2},Pause:{keyCode:19,code:"Pause",key:"Pause"},CapsLock:{keyCode:20,code:"CapsLock",key:"CapsLock"},Escape:{keyCode:27,code:"Escape",key:"Escape"},Convert:{keyCode:28,code:"Convert",key:"Convert"},NonConvert:{keyCode:29,code:"NonConvert",key:"NonConvert"},Space:{keyCode:32,code:"Space",key:" "},Numpad9:{keyCode:33,shiftKeyCode:105,key:"PageUp",code:"Numpad9",shiftKey:"9",location:3},PageUp:{keyCode:33,code:"PageUp",key:"PageUp"},Numpad3:{keyCode:34,shiftKeyCode:99,key:"PageDown",code:"Numpad3",shiftKey:"3",location:3},PageDown:{keyCode:34,code:"PageDown",key:"PageDown"},End:{keyCode:35,code:"End",key:"End"},Numpad1:{keyCode:35,shiftKeyCode:97,key:"End",code:"Numpad1",shiftKey:"1",location:3},Home:{keyCode:36,code:"Home",key:"Home"},Numpad7:{keyCode:36,shiftKeyCode:103,key:"Home",code:"Numpad7",shiftKey:"7",location:3},ArrowLeft:{keyCode:37,code:"ArrowLeft",key:"ArrowLeft"},Numpad4:{keyCode:37,shiftKeyCode:100,key:"ArrowLeft",code:"Numpad4",shiftKey:"4",location:3},Numpad8:{keyCode:38,shiftKeyCode:104,key:"ArrowUp",code:"Numpad8",shiftKey:"8",location:3},ArrowUp:{keyCode:38,code:"ArrowUp",key:"ArrowUp"},ArrowRight:{keyCode:39,code:"ArrowRight",key:"ArrowRight"},Numpad6:{keyCode:39,shiftKeyCode:102,key:"ArrowRight",code:"Numpad6",shiftKey:"6",location:3},Numpad2:{keyCode:40,shiftKeyCode:98,key:"ArrowDown",code:"Numpad2",shiftKey:"2",location:3},ArrowDown:{keyCode:40,code:"ArrowDown",key:"ArrowDown"},Select:{keyCode:41,code:"Select",key:"Select"},Open:{keyCode:43,code:"Open",key:"Execute"},PrintScreen:{keyCode:44,code:"PrintScreen",key:"PrintScreen"},Insert:{keyCode:45,code:"Insert",key:"Insert"},Numpad0:{keyCode:45,shiftKeyCode:96,key:"Insert",code:"Numpad0",shiftKey:"0",location:3},Delete:{keyCode:46,code:"Delete",key:"Delete"},NumpadDecimal:{keyCode:46,shiftKeyCode:110,code:"NumpadDecimal",key:"\0",shiftKey:".",location:3},Digit0:{keyCode:48,code:"Digit0",shiftKey:")",key:"0"},Digit1:{keyCode:49,code:"Digit1",shiftKey:"!",key:"1"},Digit2:{keyCode:50,code:"Digit2",shiftKey:"@",key:"2"},Digit3:{keyCode:51,code:"Digit3",shiftKey:"#",key:"3"},Digit4:{keyCode:52,code:"Digit4",shiftKey:"$",key:"4"},Digit5:{keyCode:53,code:"Digit5",shiftKey:"%",key:"5"},Digit6:{keyCode:54,code:"Digit6",shiftKey:"^",key:"6"},Digit7:{keyCode:55,code:"Digit7",shiftKey:"&",key:"7"},Digit8:{keyCode:56,code:"Digit8",shiftKey:"*",key:"8"},Digit9:{keyCode:57,code:"Digit9",shiftKey:"(",key:"9"},KeyA:{keyCode:65,code:"KeyA",shiftKey:"A",key:"a"},KeyB:{keyCode:66,code:"KeyB",shiftKey:"B",key:"b"},KeyC:{keyCode:67,code:"KeyC",shiftKey:"C",key:"c"},KeyD:{keyCode:68,code:"KeyD",shiftKey:"D",key:"d"},KeyE:{keyCode:69,code:"KeyE",shiftKey:"E",key:"e"},KeyF:{keyCode:70,code:"KeyF",shiftKey:"F",key:"f"},KeyG:{keyCode:71,code:"KeyG",shiftKey:"G",key:"g"},KeyH:{keyCode:72,code:"KeyH",shiftKey:"H",key:"h"},KeyI:{keyCode:73,code:"KeyI",shiftKey:"I",key:"i"},KeyJ:{keyCode:74,code:"KeyJ",shiftKey:"J",key:"j"},KeyK:{keyCode:75,code:"KeyK",shiftKey:"K",key:"k"},KeyL:{keyCode:76,code:"KeyL",shiftKey:"L",key:"l"},KeyM:{keyCode:77,code:"KeyM",shiftKey:"M",key:"m"},KeyN:{keyCode:78,code:"KeyN",shiftKey:"N",key:"n"},KeyO:{keyCode:79,code:"KeyO",shiftKey:"O",key:"o"},KeyP:{keyCode:80,code:"KeyP",shiftKey:"P",key:"p"},KeyQ:{keyCode:81,code:"KeyQ",shiftKey:"Q",key:"q"},KeyR:{keyCode:82,code:"KeyR",shiftKey:"R",key:"r"},KeyS:{keyCode:83,code:"KeyS",shiftKey:"S",key:"s"},KeyT:{keyCode:84,code:"KeyT",shiftKey:"T",key:"t"},KeyU:{keyCode:85,code:"KeyU",shiftKey:"U",key:"u"},KeyV:{keyCode:86,code:"KeyV",shiftKey:"V",key:"v"},KeyW:{keyCode:87,code:"KeyW",shiftKey:"W",key:"w"},KeyX:{keyCode:88,code:"KeyX",shiftKey:"X",key:"x"},KeyY:{keyCode:89,code:"KeyY",shiftKey:"Y",key:"y"},KeyZ:{keyCode:90,code:"KeyZ",shiftKey:"Z",key:"z"},MetaLeft:{keyCode:91,code:"MetaLeft",key:"Meta",location:1},MetaRight:{keyCode:92,code:"MetaRight",key:"Meta",location:2},ContextMenu:{keyCode:93,code:"ContextMenu",key:"ContextMenu"},NumpadMultiply:{keyCode:106,code:"NumpadMultiply",key:"*",location:3},NumpadAdd:{keyCode:107,code:"NumpadAdd",key:"+",location:3},NumpadSubtract:{keyCode:109,code:"NumpadSubtract",key:"-",location:3},NumpadDivide:{keyCode:111,code:"NumpadDivide",key:"/",location:3},F1:{keyCode:112,code:"F1",key:"F1"},F2:{keyCode:113,code:"F2",key:"F2"},F3:{keyCode:114,code:"F3",key:"F3"},F4:{keyCode:115,code:"F4",key:"F4"},F5:{keyCode:116,code:"F5",key:"F5"},F6:{keyCode:117,code:"F6",key:"F6"},F7:{keyCode:118,code:"F7",key:"F7"},F8:{keyCode:119,code:"F8",key:"F8"},F9:{keyCode:120,code:"F9",key:"F9"},F10:{keyCode:121,code:"F10",key:"F10"},F11:{keyCode:122,code:"F11",key:"F11"},F12:{keyCode:123,code:"F12",key:"F12"},F13:{keyCode:124,code:"F13",key:"F13"},F14:{keyCode:125,code:"F14",key:"F14"},F15:{keyCode:126,code:"F15",key:"F15"},F16:{keyCode:127,code:"F16",key:"F16"},F17:{keyCode:128,code:"F17",key:"F17"},F18:{keyCode:129,code:"F18",key:"F18"},F19:{keyCode:130,code:"F19",key:"F19"},F20:{keyCode:131,code:"F20",key:"F20"},F21:{keyCode:132,code:"F21",key:"F21"},F22:{keyCode:133,code:"F22",key:"F22"},F23:{keyCode:134,code:"F23",key:"F23"},F24:{keyCode:135,code:"F24",key:"F24"},NumLock:{keyCode:144,code:"NumLock",key:"NumLock"},ScrollLock:{keyCode:145,code:"ScrollLock",key:"ScrollLock"},AudioVolumeMute:{keyCode:173,code:"AudioVolumeMute",key:"AudioVolumeMute"},AudioVolumeDown:{keyCode:174,code:"AudioVolumeDown",key:"AudioVolumeDown"},AudioVolumeUp:{keyCode:175,code:"AudioVolumeUp",key:"AudioVolumeUp"},MediaTrackNext:{keyCode:176,code:"MediaTrackNext",key:"MediaTrackNext"},MediaTrackPrevious:{keyCode:177,code:"MediaTrackPrevious",key:"MediaTrackPrevious"},MediaStop:{keyCode:178,code:"MediaStop",key:"MediaStop"},MediaPlayPause:{keyCode:179,code:"MediaPlayPause",key:"MediaPlayPause"},Semicolon:{keyCode:186,code:"Semicolon",shiftKey:":",key:";"},Equal:{keyCode:187,code:"Equal",shiftKey:"+",key:"="},NumpadEqual:{keyCode:187,code:"NumpadEqual",key:"=",location:3},Comma:{keyCode:188,code:"Comma",shiftKey:"<",key:","},Minus:{keyCode:189,code:"Minus",shiftKey:"_",key:"-"},Period:{keyCode:190,code:"Period",shiftKey:">",key:"."},Slash:{keyCode:191,code:"Slash",shiftKey:"?",key:"/"},Backquote:{keyCode:192,code:"Backquote",shiftKey:"~",key:"`"},BracketLeft:{keyCode:219,code:"BracketLeft",shiftKey:"{",key:"["},Backslash:{keyCode:220,code:"Backslash",shiftKey:"|",key:"\\"},BracketRight:{keyCode:221,code:"BracketRight",shiftKey:"}",key:"]"},Quote:{keyCode:222,code:"Quote",shiftKey:'"',key:"'"},AltGraph:{keyCode:225,code:"AltGraph",key:"AltGraph"},Props:{keyCode:247,code:"Props",key:"CrSel"},Cancel:{keyCode:3,key:"Cancel",code:"Abort"},Clear:{keyCode:12,key:"Clear",code:"Numpad5",location:3},Shift:{keyCode:16,key:"Shift",code:"ShiftLeft",location:1},Control:{keyCode:17,key:"Control",code:"ControlLeft",location:1},Alt:{keyCode:18,key:"Alt",code:"AltLeft",location:1},Accept:{keyCode:30,key:"Accept"},ModeChange:{keyCode:31,key:"ModeChange"}," ":{keyCode:32,key:" ",code:"Space"},Print:{keyCode:42,key:"Print"},Execute:{keyCode:43,key:"Execute",code:"Open"},"\0":{keyCode:46,key:"\0",code:"NumpadDecimal",location:3},a:{keyCode:65,key:"a",code:"KeyA"},b:{keyCode:66,key:"b",code:"KeyB"},c:{keyCode:67,key:"c",code:"KeyC"},d:{keyCode:68,key:"d",code:"KeyD"},e:{keyCode:69,key:"e",code:"KeyE"},f:{keyCode:70,key:"f",code:"KeyF"},g:{keyCode:71,key:"g",code:"KeyG"},h:{keyCode:72,key:"h",code:"KeyH"},i:{keyCode:73,key:"i",code:"KeyI"},j:{keyCode:74,key:"j",code:"KeyJ"},k:{keyCode:75,key:"k",code:"KeyK"},l:{keyCode:76,key:"l",code:"KeyL"},m:{keyCode:77,key:"m",code:"KeyM"},n:{keyCode:78,key:"n",code:"KeyN"},o:{keyCode:79,key:"o",code:"KeyO"},p:{keyCode:80,key:"p",code:"KeyP"},q:{keyCode:81,key:"q",code:"KeyQ"},r:{keyCode:82,key:"r",code:"KeyR"},s:{keyCode:83,key:"s",code:"KeyS"},t:{keyCode:84,key:"t",code:"KeyT"},u:{keyCode:85,key:"u",code:"KeyU"},v:{keyCode:86,key:"v",code:"KeyV"},w:{keyCode:87,key:"w",code:"KeyW"},x:{keyCode:88,key:"x",code:"KeyX"},y:{keyCode:89,key:"y",code:"KeyY"},z:{keyCode:90,key:"z",code:"KeyZ"},Meta:{keyCode:91,key:"Meta",code:"MetaLeft",location:1},"*":{keyCode:106,key:"*",code:"NumpadMultiply",location:3},"+":{keyCode:107,key:"+",code:"NumpadAdd",location:3},"-":{keyCode:109,key:"-",code:"NumpadSubtract",location:3},"/":{keyCode:111,key:"/",code:"NumpadDivide",location:3},";":{keyCode:186,key:";",code:"Semicolon"},"=":{keyCode:187,key:"=",code:"Equal"},",":{keyCode:188,key:",",code:"Comma"},".":{keyCode:190,key:".",code:"Period"},"`":{keyCode:192,key:"`",code:"Backquote"},"[":{keyCode:219,key:"[",code:"BracketLeft"},"\\":{keyCode:220,key:"\\",code:"Backslash"},"]":{keyCode:221,key:"]",code:"BracketRight"},"'":{keyCode:222,key:"'",code:"Quote"},Attn:{keyCode:246,key:"Attn"},CrSel:{keyCode:247,key:"CrSel",code:"Props"},ExSel:{keyCode:248,key:"ExSel"},EraseEof:{keyCode:249,key:"EraseEof"},Play:{keyCode:250,key:"Play"},ZoomOut:{keyCode:251,key:"ZoomOut"},")":{keyCode:48,key:")",code:"Digit0"},"!":{keyCode:49,key:"!",code:"Digit1"},"@":{keyCode:50,key:"@",code:"Digit2"},"#":{keyCode:51,key:"#",code:"Digit3"},$:{keyCode:52,key:"$",code:"Digit4"},"%":{keyCode:53,key:"%",code:"Digit5"},"^":{keyCode:54,key:"^",code:"Digit6"},"&":{keyCode:55,key:"&",code:"Digit7"},"(":{keyCode:57,key:"(",code:"Digit9"},A:{keyCode:65,key:"A",code:"KeyA"},B:{keyCode:66,key:"B",code:"KeyB"},C:{keyCode:67,key:"C",code:"KeyC"},D:{keyCode:68,key:"D",code:"KeyD"},E:{keyCode:69,key:"E",code:"KeyE"},F:{keyCode:70,key:"F",code:"KeyF"},G:{keyCode:71,key:"G",code:"KeyG"},H:{keyCode:72,key:"H",code:"KeyH"},I:{keyCode:73,key:"I",code:"KeyI"},J:{keyCode:74,key:"J",code:"KeyJ"},K:{keyCode:75,key:"K",code:"KeyK"},L:{keyCode:76,key:"L",code:"KeyL"},M:{keyCode:77,key:"M",code:"KeyM"},N:{keyCode:78,key:"N",code:"KeyN"},O:{keyCode:79,key:"O",code:"KeyO"},P:{keyCode:80,key:"P",code:"KeyP"},Q:{keyCode:81,key:"Q",code:"KeyQ"},R:{keyCode:82,key:"R",code:"KeyR"},S:{keyCode:83,key:"S",code:"KeyS"},T:{keyCode:84,key:"T",code:"KeyT"},U:{keyCode:85,key:"U",code:"KeyU"},V:{keyCode:86,key:"V",code:"KeyV"},W:{keyCode:87,key:"W",code:"KeyW"},X:{keyCode:88,key:"X",code:"KeyX"},Y:{keyCode:89,key:"Y",code:"KeyY"},Z:{keyCode:90,key:"Z",code:"KeyZ"},":":{keyCode:186,key:":",code:"Semicolon"},"<":{keyCode:188,key:"<",code:"Comma"},_:{keyCode:189,key:"_",code:"Minus"},">":{keyCode:190,key:">",code:"Period"},"?":{keyCode:191,key:"?",code:"Slash"},"~":{keyCode:192,key:"~",code:"Backquote"},"{":{keyCode:219,key:"{",code:"BracketLeft"},"|":{keyCode:220,key:"|",code:"Backslash"},"}":{keyCode:221,key:"}",code:"BracketRight"},'"':{keyCode:222,key:'"',code:"Quote"},SoftLeft:{key:"SoftLeft",code:"SoftLeft",location:4},SoftRight:{key:"SoftRight",code:"SoftRight",location:4},Camera:{keyCode:44,key:"Camera",code:"Camera",location:4},Call:{key:"Call",code:"Call",location:4},EndCall:{keyCode:95,key:"EndCall",code:"EndCall",location:4},VolumeDown:{keyCode:182,key:"VolumeDown",code:"VolumeDown",location:4},VolumeUp:{keyCode:183,key:"VolumeUp",code:"VolumeUp",location:4}};/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var la,pr,xa,lp,cp;class Iy extends wy{constructor(e){super();h(this,xa);h(this,la);h(this,pr,new Set);_(this,"_modifiers",0);f(this,la,e)}updateClient(e){f(this,la,e)}async down(e,a={text:void 0,commands:[]}){const i=w(this,xa,cp).call(this,e),s=n(this,pr).has(i.code);n(this,pr).add(i.code),this._modifiers|=w(this,xa,lp).call(this,i.key);const r=a.text===void 0?i.text:a.text;await n(this,la).send("Input.dispatchKeyEvent",{type:r?"keyDown":"rawKeyDown",modifiers:this._modifiers,windowsVirtualKeyCode:i.keyCode,code:i.code,key:i.key,text:r,unmodifiedText:r,autoRepeat:s,location:i.location,isKeypad:i.location===3,commands:a.commands})}async up(e){const a=w(this,xa,cp).call(this,e);this._modifiers&=~w(this,xa,lp).call(this,a.key),n(this,pr).delete(a.code),await n(this,la).send("Input.dispatchKeyEvent",{type:"keyUp",modifiers:this._modifiers,key:a.key,windowsVirtualKeyCode:a.keyCode,code:a.code,location:a.location})}async sendCharacter(e){await n(this,la).send("Input.insertText",{text:e})}charIsKey(e){return!!Bm[e]}async type(e,a={}){const i=a.delay||void 0;for(const s of e)this.charIsKey(s)?await this.press(s,{delay:i}):(i&&await new Promise(r=>setTimeout(r,i)),await this.sendCharacter(s))}async press(e,a={}){const{delay:i=null}=a;await this.down(e,a),i&&await new Promise(s=>setTimeout(s,a.delay)),await this.up(e)}}la=new WeakMap,pr=new WeakMap,xa=new WeakSet,lp=function(e){return e==="Alt"?1:e==="Control"?2:e==="Meta"?4:e==="Shift"?8:0},cp=function(e){const a=this._modifiers&8,i={key:"",keyCode:0,code:"",text:"",location:0},s=Bm[e];return L(s,`Unknown key: "${e}"`),s.key&&(i.key=s.key),a&&s.shiftKey&&(i.key=s.shiftKey),s.keyCode&&(i.keyCode=s.keyCode),a&&s.shiftKeyCode&&(i.keyCode=s.shiftKeyCode),s.code&&(i.code=s.code),s.location&&(i.location=s.location),i.key.length===1&&(i.text=i.key),s.text&&(i.text=s.text),a&&s.shiftText&&(i.text=s.shiftText),this._modifiers&-9&&(i.text=""),i};const Fm=o=>{switch(o){case $e.Left:return 1;case $e.Right:return 2;case $e.Middle:return 4;case $e.Back:return 8;case $e.Forward:return 16}},Sy=o=>o&1?$e.Left:o&2?$e.Right:o&4?$e.Middle:o&8?$e.Back:o&16?$e.Forward:"none";var ut,Rt,mr,be,rt,Di,$f,od;class Ay extends Ty{constructor(e,a){super();h(this,be);h(this,ut);h(this,Rt);h(this,mr,{position:{x:0,y:0},buttons:0});h(this,Di,[]);f(this,ut,e),f(this,Rt,a)}updateClient(e){f(this,ut,e)}async reset(){const e=[];for(const[a,i]of[[1,$e.Left],[4,$e.Middle],[2,$e.Right],[16,$e.Forward],[8,$e.Back]])n(this,be,rt).buttons&a&&e.push(this.up({button:i}));(n(this,be,rt).position.x!==0||n(this,be,rt).position.y!==0)&&e.push(this.move(0,0)),await Promise.all(e)}async move(e,a,i={}){const{steps:s=1}=i,r=n(this,be,rt).position,l={x:e,y:a};for(let c=1;c<=s;c++)await w(this,be,od).call(this,d=>{d({position:{x:r.x+(l.x-r.x)*(c/s),y:r.y+(l.y-r.y)*(c/s)}});const{buttons:u,position:p}=n(this,be,rt);return n(this,ut).send("Input.dispatchMouseEvent",{type:"mouseMoved",modifiers:n(this,Rt)._modifiers,buttons:u,button:Sy(u),...p})})}async down(e={}){const{button:a=$e.Left,clickCount:i=1}=e,s=Fm(a);if(!s)throw new Error(`Unsupported mouse button: ${a}`);if(n(this,be,rt).buttons&s)throw new Error(`'${a}' is already pressed.`);await w(this,be,od).call(this,r=>{r({buttons:n(this,be,rt).buttons|s});const{buttons:l,position:c}=n(this,be,rt);return n(this,ut).send("Input.dispatchMouseEvent",{type:"mousePressed",modifiers:n(this,Rt)._modifiers,clickCount:i,buttons:l,button:a,...c})})}async up(e={}){const{button:a=$e.Left,clickCount:i=1}=e,s=Fm(a);if(!s)throw new Error(`Unsupported mouse button: ${a}`);if(!(n(this,be,rt).buttons&s))throw new Error(`'${a}' is not pressed.`);await w(this,be,od).call(this,r=>{r({buttons:n(this,be,rt).buttons&~s});const{buttons:l,position:c}=n(this,be,rt);return n(this,ut).send("Input.dispatchMouseEvent",{type:"mouseReleased",modifiers:n(this,Rt)._modifiers,clickCount:i,buttons:l,button:a,...c})})}async click(e,a,i={}){const{delay:s,count:r=1,clickCount:l=r}=i;if(r<1)throw new Error("Click must occur a positive number of times.");const c=[this.move(e,a)];if(l===r)for(let d=1;d<r;++d)c.push(this.down({...i,clickCount:d}),this.up({...i,clickCount:d}));c.push(this.down({...i,clickCount:l})),typeof s=="number"&&(await Promise.all(c),c.length=0,await new Promise(d=>{setTimeout(d,s)})),c.push(this.up({...i,clickCount:l})),await Promise.all(c)}async wheel(e={}){const{deltaX:a=0,deltaY:i=0}=e,{position:s,buttons:r}=n(this,be,rt);await n(this,ut).send("Input.dispatchMouseEvent",{type:"mouseWheel",pointerType:"mouse",modifiers:n(this,Rt)._modifiers,deltaY:i,deltaX:a,buttons:r,...s})}async drag(e,a){const i=new Promise(s=>{n(this,ut).once("Input.dragIntercepted",r=>s(r.data))});return await this.move(e.x,e.y),await this.down(),await this.move(a.x,a.y),await i}async dragEnter(e,a){await n(this,ut).send("Input.dispatchDragEvent",{type:"dragEnter",x:e.x,y:e.y,modifiers:n(this,Rt)._modifiers,data:a})}async dragOver(e,a){await n(this,ut).send("Input.dispatchDragEvent",{type:"dragOver",x:e.x,y:e.y,modifiers:n(this,Rt)._modifiers,data:a})}async drop(e,a){await n(this,ut).send("Input.dispatchDragEvent",{type:"drop",x:e.x,y:e.y,modifiers:n(this,Rt)._modifiers,data:a})}async dragAndDrop(e,a,i={}){const{delay:s=null}=i,r=await this.drag(e,a);await this.dragEnter(a,r),await this.dragOver(a,r),s&&await new Promise(l=>setTimeout(l,s)),await this.drop(a,r),await this.up()}}ut=new WeakMap,Rt=new WeakMap,mr=new WeakMap,be=new WeakSet,rt=function(){return Object.assign({...n(this,mr)},...n(this,Di))},Di=new WeakMap,$f=function(){const e={};n(this,Di).push(e);const a=()=>{n(this,Di).splice(n(this,Di).indexOf(e),1)};return{update:i=>{Object.assign(e,i)},commit:()=>{f(this,mr,{...n(this,mr),...e}),a()},rollback:a}},od=async function(e){const{update:a,commit:i,rollback:s}=w(this,be,$f).call(this);try{await e(a),i()}catch(r){throw s(),r}};var ca,Mi;class Cy extends xy{constructor(e,a){super();h(this,ca);h(this,Mi);f(this,ca,e),f(this,Mi,a)}updateClient(e){f(this,ca,e)}async touchStart(e,a){await n(this,ca).send("Input.dispatchTouchEvent",{type:"touchStart",touchPoints:[{x:Math.round(e),y:Math.round(a),radiusX:.5,radiusY:.5,force:.5}],modifiers:n(this,Mi)._modifiers})}async touchMove(e,a){await n(this,ca).send("Input.dispatchTouchEvent",{type:"touchMove",touchPoints:[{x:Math.round(e),y:Math.round(a),radiusX:.5,radiusY:.5,force:.5}],modifiers:n(this,Mi)._modifiers})}async touchEnd(){await n(this,ca).send("Input.dispatchTouchEvent",{type:"touchEnd",touchPoints:[],modifiers:n(this,Mi)._modifiers})}}ca=new WeakMap,Mi=new WeakMap;var ho,gr,Gl;class Ry{constructor(t){h(this,ho);h(this,gr,!1);h(this,Gl);f(this,ho,t)}updateClient(t){f(this,ho,t)}async start(t={}){L(!n(this,gr),"Cannot start recording trace while already recording trace.");const e=["-*","devtools.timeline","v8.execute","disabled-by-default-devtools.timeline","disabled-by-default-devtools.timeline.frame","toplevel","blink.console","blink.user_timing","latencyInfo","disabled-by-default-devtools.timeline.stack","disabled-by-default-v8.cpu_profiler"],{path:a,screenshots:i=!1,categories:s=e}=t;i&&s.push("disabled-by-default-devtools.screenshot");const r=s.filter(c=>c.startsWith("-")).map(c=>c.slice(1)),l=s.filter(c=>!c.startsWith("-"));f(this,Gl,a),f(this,gr,!0),await n(this,ho).send("Tracing.start",{transferMode:"ReturnAsStream",traceConfig:{excludedCategories:r,includedCategories:l}})}async stop(){const t=de.create();return n(this,ho).once("Tracing.tracingComplete",async e=>{try{L(e.stream,'Missing "stream"');const a=await Ch(n(this,ho),e.stream),i=await Ah(a,n(this,Gl));t.resolve(i??void 0)}catch(a){Xt(a)?t.reject(a):t.reject(new Error(`Unknown error: ${a}`))}}),await n(this,ho).send("Tracing.end"),f(this,gr,!1),await t.valueOrThrow()}}ho=new WeakMap,gr=new WeakMap,Gl=new WeakMap;/**
 * @license
 * Copyright 2018 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Kl;class _y extends ye{constructor(e){super();_(this,"timeoutSettings",new kp);h(this,Kl);f(this,Kl,e)}url(){return n(this,Kl)}async evaluate(e,...a){return e=ze(this.evaluate.name,e),await this.mainRealm().evaluate(e,...a)}async evaluateHandle(e,...a){return e=ze(this.evaluateHandle.name,e),await this.mainRealm().evaluateHandle(e,...a)}async close(){throw new Ih("WebWorker.close() is not supported")}}Kl=new WeakMap;var Wt,fo,ql,Zl;class Uf extends _y{constructor(e,a,i,s,r,l){super(a);h(this,Wt);h(this,fo);h(this,ql);h(this,Zl);f(this,ql,i),f(this,fo,e),f(this,Zl,s),f(this,Wt,new Xu(this,new kp)),n(this,fo).once("Runtime.executionContextCreated",async c=>{n(this,Wt).setContext(new of(e,c.context,n(this,Wt)))}),n(this,Wt).emitter.on("consoleapicalled",async c=>{try{return r(c.type,c.args.map(d=>new Kd(n(this,Wt),d)),c.stackTrace)}catch(d){Z(d)}}),n(this,fo).on("Runtime.exceptionThrown",l),n(this,fo).once(ge.Disconnected,()=>{n(this,Wt).dispose()}),n(this,fo).send("Runtime.enable").catch(Z)}mainRealm(){return n(this,Wt)}get client(){return n(this,fo)}async close(){var e,a;switch(n(this,Zl)){case pt.SERVICE_WORKER:case pt.SHARED_WORKER:{await((e=this.client.connection())==null?void 0:e.send("Target.closeTarget",{targetId:n(this,ql)})),await((a=this.client.connection())==null?void 0:a.send("Target.detachFromTarget",{sessionId:this.client.id()}));break}default:await this.evaluate(()=>{self.close()})}}}Wt=new WeakMap,fo=new WeakMap,ql=new WeakMap,Zl=new WeakMap;/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var cu=function(o,t,e){if(t!=null){if(typeof t!="object"&&typeof t!="function")throw new TypeError("Object expected.");var a;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");a=t[Symbol.asyncDispose]}if(a===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");a=t[Symbol.dispose]}if(typeof a!="function")throw new TypeError("Object not disposable.");o.stack.push({value:t,dispose:a,async:e})}else e&&o.stack.push({async:!0});return t},du=(function(o){return function(t){function e(i){t.error=t.hasError?new o(i,t.error,"An error was suppressed during disposal."):i,t.hasError=!0}function a(){for(;t.stack.length;){var i=t.stack.pop();try{var s=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(s).then(a,function(r){return e(r),a()})}catch(r){e(r)}}if(t.hasError)throw t.error}return a()}})(typeof SuppressedError=="function"?SuppressedError:function(o,t,e){var a=new Error(e);return a.name="SuppressedError",a.error=o,a.suppressed=t,a});function uu(o){switch(o){case"warning":return"warn";default:return o}}var Yl,da,ie,_t,ua,zi,pa,hr,fr,ce,xe,vr,ma,Er,br,yr,Li,vo,Ld,Xl,Jl,Nd,Pd,kd,J,jf,Hf,Vf,dp,Ql,wr,Wf,Gf,Kf,qf,Zf,up,pp,Yf,Xf,mp,Jf,gp;const Wp=class Wp extends ib{constructor(e,a){super();h(this,J);h(this,Yl,!1);h(this,da);h(this,ie);h(this,_t);h(this,ua);h(this,zi);h(this,pa);h(this,hr);h(this,fr);h(this,ce);h(this,xe);h(this,vr);h(this,ma,new Map);h(this,Er,new Map);h(this,br);h(this,yr);h(this,Li,new Map);h(this,vo,new Set);h(this,Ld,de.create());h(this,Xl,!1);h(this,Jl,!1);h(this,Nd,[[Me.FrameAttached,e=>{this.emit("frameattached",e)}],[Me.FrameDetached,e=>{this.emit("framedetached",e)}],[Me.FrameNavigated,e=>{this.emit("framenavigated",e)}]]);h(this,Pd,[[De.Request,e=>{this.emit("request",e)}],[De.RequestServedFromCache,e=>{this.emit("requestservedfromcache",e)}],[De.Response,e=>{this.emit("response",e)}],[De.RequestFailed,e=>{this.emit("requestfailed",e)}],[De.RequestFinished,e=>{this.emit("requestfinished",e)}]]);h(this,kd,[[ge.Disconnected,()=>{n(this,Ld).reject(new wa("Target closed"))}],["Page.domContentEventFired",()=>this.emit("domcontentloaded",void 0)],["Page.loadEventFired",()=>this.emit("load",void 0)],["Page.javascriptDialogOpening",w(this,J,Jf).bind(this)],["Runtime.exceptionThrown",w(this,J,pp).bind(this)],["Inspector.targetCrashed",w(this,J,Kf).bind(this)],["Performance.metrics",w(this,J,Zf).bind(this)],["Log.entryAdded",w(this,J,qf).bind(this)],["Page.fileChooserOpened",w(this,J,Gf).bind(this)]]);h(this,Ql,e=>{var s;const a=(s=e._session())==null?void 0:s.id(),i=n(this,Li).get(a);i&&(n(this,Li).delete(a),this.emit("workerdestroyed",i))});h(this,wr,e=>{if(L(e instanceof ns),n(this,ce).onAttachedToTarget(e._target()),e._target()._getTargetInfo().type==="worker"){const a=new Uf(e,e._target().url(),e._target()._targetId,e._target().type(),w(this,J,mp).bind(this),w(this,J,pp).bind(this));n(this,Li).set(e.id(),a),this.emit("workercreated",a)}e.on(ge.Ready,n(this,wr))});f(this,ie,e),f(this,ua,e.parentSession()),L(n(this,ua),"Tab target session is not defined."),f(this,zi,n(this,ua)._target()),L(n(this,zi),"Tab target is not defined."),f(this,_t,a),f(this,da,a._targetManager()),f(this,pa,new Iy(e)),f(this,hr,new Ay(e,n(this,pa))),f(this,fr,new Cy(e,n(this,pa))),f(this,ce,new yy(e,this,this._timeoutSettings)),f(this,xe,new yb(e)),f(this,vr,new Ry(e)),f(this,br,new gb(e)),f(this,yr,null);for(const[i,s]of n(this,Nd))n(this,ce).on(i,s);n(this,ce).on(Me.ConsoleApiCalled,([i,s])=>{w(this,J,Yf).call(this,i,s)}),n(this,ce).on(Me.BindingCalled,([i,s])=>{w(this,J,Xf).call(this,i,s)});for(const[i,s]of n(this,Pd))n(this,ce).networkManager.on(i,s);n(this,ua).on(ge.Swapped,w(this,J,Hf).bind(this)),n(this,ua).on(ge.Ready,w(this,J,Vf).bind(this)),n(this,da).on("targetGone",n(this,Ql)),n(this,zi)._isClosedDeferred.valueOrThrow().then(()=>{n(this,da).off("targetGone",n(this,Ql)),this.emit("close",void 0),f(this,Yl,!0)}).catch(Z),w(this,J,dp).call(this),w(this,J,jf).call(this)}static async _create(e,a,i){var r;const s=new Wp(e,a);if(await w(r=s,J,Wf).call(r),i)try{await s.setViewport(i)}catch(l){if(Xt(l)&&Iu(l))Z(l);else throw l}return s}_client(){return n(this,ie)}isServiceWorkerBypassed(){return n(this,Xl)}isDragInterceptionEnabled(){return n(this,Jl)}isJavaScriptEnabled(){return n(this,xe).javascriptEnabled}async waitForFileChooser(e={}){const a=n(this,vo).size===0,{timeout:i=this._timeoutSettings.timeout()}=e,s=de.create({message:`Waiting for \`FileChooser\` failed: ${i}ms exceeded`,timeout:i});n(this,vo).add(s);let r;a&&(r=n(this,ie).send("Page.setInterceptFileChooserDialog",{enabled:!0}));try{const[l]=await Promise.all([s.valueOrThrow(),r]);return l}catch(l){throw n(this,vo).delete(s),l}}async setGeolocation(e){return await n(this,xe).setGeolocation(e)}target(){return n(this,_t)}browser(){return n(this,_t).browser()}browserContext(){return n(this,_t).browserContext()}mainFrame(){return n(this,ce).mainFrame()}get keyboard(){return n(this,pa)}get touchscreen(){return n(this,fr)}get coverage(){return n(this,br)}get tracing(){return n(this,vr)}frames(){return n(this,ce).frames()}workers(){return Array.from(n(this,Li).values())}async setRequestInterception(e){return await n(this,ce).networkManager.setRequestInterception(e)}async setBypassServiceWorker(e){return f(this,Xl,e),await n(this,ie).send("Network.setBypassServiceWorker",{bypass:e})}async setDragInterception(e){return f(this,Jl,e),await n(this,ie).send("Input.setInterceptDrags",{enabled:e})}async setOfflineMode(e){return await n(this,ce).networkManager.setOfflineMode(e)}async emulateNetworkConditions(e){return await n(this,ce).networkManager.emulateNetworkConditions(e)}setDefaultNavigationTimeout(e){this._timeoutSettings.setDefaultNavigationTimeout(e)}setDefaultTimeout(e){this._timeoutSettings.setDefaultTimeout(e)}getDefaultTimeout(){return this._timeoutSettings.timeout()}async queryObjects(e){L(!e.disposed,"Prototype JSHandle is disposed!"),L(e.id,"Prototype JSHandle must not be referencing primitive value");const a=await this.mainFrame().client.send("Runtime.queryObjects",{prototypeObjectId:e.id});return this.mainFrame().mainRealm().createCdpHandle(a.objects)}async cookies(...e){const a=(await n(this,ie).send("Network.getCookies",{urls:e.length?e:[this.url()]})).cookies,i=["sourcePort"],s=r=>{for(const l of i)delete r[l];return r};return a.map(s)}async deleteCookie(...e){const a=this.url();for(const i of e){const s=Object.assign({},i);!i.url&&a.startsWith("http")&&(s.url=a),await n(this,ie).send("Network.deleteCookies",s)}}async setCookie(...e){const a=this.url(),i=a.startsWith("http"),s=e.map(r=>{const l=Object.assign({},r);return!l.url&&i&&(l.url=a),L(l.url!=="about:blank",`Blank page can not have cookie "${l.name}"`),L(!String.prototype.startsWith.call(l.url||"","data:"),`Data URL page can not have cookie "${l.name}"`),l});await this.deleteCookie(...s),s.length&&await n(this,ie).send("Network.setCookies",{cookies:s})}async exposeFunction(e,a){if(n(this,ma).has(e))throw new Error(`Failed to add page binding with name ${e}: window['${e}'] already exists!`);const i=Qb("exposedFun",e);let s;switch(typeof a){case"function":s=new gd(e,a,i);break;default:s=new gd(e,a.default,i);break}n(this,ma).set(e,s);const[{identifier:r}]=await Promise.all([n(this,ce).evaluateOnNewDocument(i),n(this,ce).addExposedFunctionBinding(s)]);n(this,Er).set(e,r)}async removeExposedFunction(e){const a=n(this,Er).get(e);if(!a)throw new Error(`Function with name "${e}" does not exist`);const i=n(this,ma).get(e);n(this,Er).delete(e),n(this,ma).delete(e),await Promise.all([n(this,ce).removeScriptToEvaluateOnNewDocument(a),n(this,ce).removeExposedFunctionBinding(i)])}async authenticate(e){return await n(this,ce).networkManager.authenticate(e)}async setExtraHTTPHeaders(e){return await n(this,ce).networkManager.setExtraHTTPHeaders(e)}async setUserAgent(e,a){return await n(this,ce).networkManager.setUserAgent(e,a)}async metrics(){const e=await n(this,ie).send("Performance.getMetrics");return w(this,J,up).call(this,e.metrics)}async reload(e){const[a]=await Promise.all([this.waitForNavigation({...e,ignoreSameDocumentNavigation:!0}),n(this,ie).send("Page.reload")]);return a}async createCDPSession(){return await this.target().createCDPSession()}async goBack(e={}){return await w(this,J,gp).call(this,-1,e)}async goForward(e={}){return await w(this,J,gp).call(this,1,e)}async bringToFront(){await n(this,ie).send("Page.bringToFront")}async setJavaScriptEnabled(e){return await n(this,xe).setJavaScriptEnabled(e)}async setBypassCSP(e){await n(this,ie).send("Page.setBypassCSP",{enabled:e})}async emulateMediaType(e){return await n(this,xe).emulateMediaType(e)}async emulateCPUThrottling(e){return await n(this,xe).emulateCPUThrottling(e)}async emulateMediaFeatures(e){return await n(this,xe).emulateMediaFeatures(e)}async emulateTimezone(e){return await n(this,xe).emulateTimezone(e)}async emulateIdleState(e){return await n(this,xe).emulateIdleState(e)}async emulateVisionDeficiency(e){return await n(this,xe).emulateVisionDeficiency(e)}async setViewport(e){const a=await n(this,xe).emulateViewport(e);f(this,yr,e),a&&await this.reload()}viewport(){return n(this,yr)}async evaluateOnNewDocument(e,...a){const i=Sh(e,...a);return await n(this,ce).evaluateOnNewDocument(i)}async removeScriptToEvaluateOnNewDocument(e){return await n(this,ce).removeScriptToEvaluateOnNewDocument(e)}async setCacheEnabled(e=!0){await n(this,ce).networkManager.setCacheEnabled(e)}async _screenshot(e){const a={stack:[],error:void 0,hasError:!1};try{const{fromSurface:i,omitBackground:s,optimizeForSpeed:r,quality:l,clip:c,type:d,captureBeyondViewport:u}=e,p=this.target()._targetManager()instanceof jh,g=cu(a,new cd,!0);!p&&s&&(d==="png"||d==="webp")&&(await n(this,xe).setTransparentBackgroundColor(),g.defer(async()=>{await n(this,xe).resetDefaultBackgroundColor().catch(Z)}));let m=c;if(m&&!u){const b=await this.mainFrame().isolatedRealm().evaluate(()=>{const{height:E,pageLeft:T,pageTop:R,width:S}=window.visualViewport;return{x:T,y:R,height:E,width:S}});m=Dy(m,b)}const{data:v}=await n(this,ie).send("Page.captureScreenshot",{format:d,...r?{optimizeForSpeed:r}:{},...l!==void 0?{quality:Math.round(l)}:{},...m?{clip:{...m,scale:m.scale??1}}:{},...i?{}:{fromSurface:i},captureBeyondViewport:u});return v}catch(i){a.error=i,a.hasError=!0}finally{const i=du(a);i&&await i}}async createPDFStream(e={}){const{timeout:a=this._timeoutSettings.timeout()}=e,{landscape:i,displayHeaderFooter:s,headerTemplate:r,footerTemplate:l,printBackground:c,scale:d,width:u,height:p,margin:g,pageRanges:m,preferCSSPageSize:v,omitBackground:b,tagged:E,outline:T,waitForFonts:R}=kE(e);b&&await n(this,xe).setTransparentBackgroundColor(),R&&await tt(le(this.mainFrame().isolatedRealm().evaluate(()=>document.fonts.ready)).pipe(Kt(qt(a))));const S=n(this,ie).send("Page.printToPDF",{transferMode:"ReturnAsStream",landscape:i,displayHeaderFooter:s,headerTemplate:r,footerTemplate:l,printBackground:c,scale:d,paperWidth:u,paperHeight:p,marginTop:g.top,marginBottom:g.bottom,marginLeft:g.left,marginRight:g.right,pageRanges:m,preferCSSPageSize:v,generateTaggedPDF:E,generateDocumentOutline:T}),C=await tt(le(S).pipe(Kt(qt(a))));return b&&await n(this,xe).resetDefaultBackgroundColor(),L(C.stream,"`stream` is missing from `Page.printToPDF"),await Ch(n(this,ie),C.stream)}async pdf(e={}){const{path:a=void 0}=e,i=await this.createPDFStream(e),s=await Ah(i,a);return L(s,"Could not create buffer"),s}async close(e={runBeforeUnload:void 0}){const a={stack:[],error:void 0,hasError:!1};try{const i=cu(a,await this.browserContext().waitForScreenshotOperations(),!1),s=n(this,ie).connection();L(s,"Protocol error: Connection closed. Most likely the page has been closed."),!!e.runBeforeUnload?await n(this,ie).send("Page.close"):(await s.send("Target.closeTarget",{targetId:n(this,_t)._targetId}),await n(this,zi)._isClosedDeferred.valueOrThrow())}catch(i){a.error=i,a.hasError=!0}finally{du(a)}}isClosed(){return n(this,Yl)}get mouse(){return n(this,hr)}async waitForDevicePrompt(e={}){return await this.mainFrame().waitForDevicePrompt(e)}};Yl=new WeakMap,da=new WeakMap,ie=new WeakMap,_t=new WeakMap,ua=new WeakMap,zi=new WeakMap,pa=new WeakMap,hr=new WeakMap,fr=new WeakMap,ce=new WeakMap,xe=new WeakMap,vr=new WeakMap,ma=new WeakMap,Er=new WeakMap,br=new WeakMap,yr=new WeakMap,Li=new WeakMap,vo=new WeakMap,Ld=new WeakMap,Xl=new WeakMap,Jl=new WeakMap,Nd=new WeakMap,Pd=new WeakMap,kd=new WeakMap,J=new WeakSet,jf=function(){const e=[];for(const i of n(this,da).getChildTargets(n(this,_t)))e.push(i);let a=0;for(;a<e.length;){const i=e[a];a++;const s=i._session();s&&n(this,wr).call(this,s);for(const r of n(this,da).getChildTargets(i))e.push(r)}},Hf=async function(e){f(this,ie,e),L(n(this,ie)instanceof ns,"CDPSession is not instance of CDPSessionImpl"),f(this,_t,n(this,ie)._target()),L(n(this,_t),"Missing target on swap"),n(this,pa).updateClient(e),n(this,hr).updateClient(e),n(this,fr).updateClient(e),n(this,xe).updateClient(e),n(this,vr).updateClient(e),n(this,br).updateClient(e),await n(this,ce).swapFrameTree(e),w(this,J,dp).call(this)},Vf=async function(e){L(e instanceof ns),e._target()._subtype()==="prerender"&&(n(this,ce).registerSpeculativeSession(e).catch(Z),n(this,xe).registerSpeculativeSession(e).catch(Z))},dp=function(){n(this,ie).on(ge.Ready,n(this,wr));for(const[e,a]of n(this,kd))n(this,ie).on(e,a)},Ql=new WeakMap,wr=new WeakMap,Wf=async function(){try{await Promise.all([n(this,ce).initialize(n(this,ie)),n(this,ie).send("Performance.enable"),n(this,ie).send("Log.enable")])}catch(e){if(Xt(e)&&Iu(e))Z(e);else throw e}},Gf=async function(e){const a={stack:[],error:void 0,hasError:!1};try{if(!n(this,vo).size)return;const i=n(this,ce).frame(e.frameId);L(i,"This should never happen.");const s=cu(a,await i.worlds[Bt].adoptBackendNode(e.backendNodeId),!1),r=new nb(s.move(),e);for(const l of n(this,vo))l.resolve(r);n(this,vo).clear()}catch(i){a.error=i,a.hasError=!0}finally{du(a)}},Kf=function(){this.emit("error",new Error("Page crashed!"))},qf=function(e){const{level:a,text:i,args:s,source:r,url:l,lineNumber:c}=e.entry;s&&s.map(d=>{Qh(n(this,ie),d)}),r!=="worker"&&this.emit("console",new Cm(uu(a),i,[],[{url:l,lineNumber:c}]))},Zf=function(e){this.emit("metrics",{title:e.title,metrics:w(this,J,up).call(this,e.metrics)})},up=function(e){const a={};for(const i of e||[])Oy.has(i.name)&&(a[i.name]=i.value);return a},pp=function(e){this.emit("pageerror",Jb(e.exceptionDetails))},Yf=function(e,a){const i=a.args.map(s=>e.createCdpHandle(s));w(this,J,mp).call(this,uu(a.type),i,a.stackTrace)},Xf=async function(e,a){let i;try{i=JSON.parse(a.payload)}catch{return}const{type:s,name:r,seq:l,args:c,isTrivial:d}=i;if(s!=="exposedFun")return;const u=e.context;if(!u)return;const p=n(this,ma).get(r);await(p==null?void 0:p.run(u,l,c,d))},mp=function(e,a,i){if(!this.listenerCount("console")){a.forEach(c=>c.dispose());return}const s=[];for(const c of a){const d=c.remoteObject();d.objectId?s.push(c.toString()):s.push(ji(d))}const r=[];if(i)for(const c of i.callFrames)r.push({url:c.url,lineNumber:c.lineNumber,columnNumber:c.columnNumber});const l=new Cm(uu(e),s.join(" "),a,r);this.emit("console",l)},Jf=function(e){const a=LE(e.type),i=new Eb(n(this,ie),a,e.message,e.defaultPrompt);this.emit("dialog",i)},gp=async function(e,a){const i=await n(this,ie).send("Page.getNavigationHistory"),s=i.entries[i.currentIndex+e];return s?(await Promise.all([this.waitForNavigation(a),n(this,ie).send("Page.navigateToHistoryEntry",{entryId:s.id})]))[0]:null};let cn=Wp;const Oy=new Set(["Timestamp","Documents","Frames","JSEventListeners","Nodes","LayoutCount","RecalcStyleCount","LayoutDuration","RecalcStyleDuration","ScriptDuration","TaskDuration","JSHeapUsedSize","JSHeapTotalSize"]);function Dy(o,t){const e=Math.max(o.x,t.x),a=Math.max(o.y,t.y);return{x:e,y:a,width:Math.max(Math.min(o.x+o.width,t.x+t.width)-e,0),height:Math.max(Math.min(o.y+o.height,t.y+t.height)-a,0)}}/**
 * @license
 * Copyright 2019 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var vt;(function(o){o.SUCCESS="success",o.ABORTED="aborted"})(vt||(vt={}));var ga,ha,Gt,Tr,fa,xr;class qd extends VE{constructor(e,a,i,s,r){super();h(this,ga);h(this,ha);h(this,Gt);h(this,Tr);h(this,fa);h(this,xr,new Set);_(this,"_initializedDeferred",de.create());_(this,"_isClosedDeferred",de.create());_(this,"_targetId");f(this,ha,a),f(this,Tr,s),f(this,Gt,e),f(this,ga,i),this._targetId=e.targetId,f(this,fa,r),n(this,ha)&&n(this,ha)instanceof ns&&n(this,ha)._setTarget(this)}async asPage(){const e=this._session();return e?await cn._create(e,this,null):await this.createCDPSession().then(a=>cn._create(a,this,null))}_subtype(){return n(this,Gt).subtype}_session(){return n(this,ha)}_addChildTarget(e){n(this,xr).add(e)}_removeChildTarget(e){n(this,xr).delete(e)}_childTargets(){return n(this,xr)}_sessionFactory(){if(!n(this,fa))throw new Error("sessionFactory is not initialized");return n(this,fa)}createCDPSession(){if(!n(this,fa))throw new Error("sessionFactory is not initialized");return n(this,fa).call(this,!1).then(e=>(e._setTarget(this),e))}url(){return n(this,Gt).url}type(){switch(n(this,Gt).type){case"page":return pt.PAGE;case"background_page":return pt.BACKGROUND_PAGE;case"service_worker":return pt.SERVICE_WORKER;case"shared_worker":return pt.SHARED_WORKER;case"browser":return pt.BROWSER;case"webview":return pt.WEBVIEW;case"tab":return pt.TAB;default:return pt.OTHER}}_targetManager(){if(!n(this,Tr))throw new Error("targetManager is not initialized");return n(this,Tr)}_getTargetInfo(){return n(this,Gt)}browser(){if(!n(this,ga))throw new Error("browserContext is not initialized");return n(this,ga).browser()}browserContext(){if(!n(this,ga))throw new Error("browserContext is not initialized");return n(this,ga)}opener(){const{openerId:e}=n(this,Gt);if(e)return this.browser().targets().find(a=>a._targetId===e)}_targetInfoChanged(e){f(this,Gt,e),this._checkIfInitialized()}_initialize(){this._initializedDeferred.resolve(vt.SUCCESS)}_isTargetExposed(){return this.type()!==pt.TAB&&!this._subtype()}_checkIfInitialized(){this._initializedDeferred.resolved()||this._initializedDeferred.resolve(vt.SUCCESS)}}ga=new WeakMap,ha=new WeakMap,Gt=new WeakMap,Tr=new WeakMap,fa=new WeakMap,xr=new WeakMap;var ec;const Gp=class Gp extends qd{constructor(e,a,i,s,r,l){super(e,a,i,s,r);h(this,ec);_(this,"pagePromise");f(this,ec,l??void 0)}_initialize(){this._initializedDeferred.valueOrThrow().then(async e=>{if(e===vt.ABORTED)return;const a=this.opener();if(!(a instanceof Gp))return;if(!a||!a.pagePromise||this.type()!=="page")return!0;const i=await a.pagePromise;if(!i.listenerCount("popup"))return!0;const s=await this.page();return i.emit("popup",s),!0}).catch(Z),this._checkIfInitialized()}async page(){if(!this.pagePromise){const e=this._session();this.pagePromise=(e?Promise.resolve(e):this._sessionFactory()(!1)).then(a=>cn._create(a,this,n(this,ec)??null))}return await this.pagePromise??null}_checkIfInitialized(){this._initializedDeferred.resolved()||this._getTargetInfo().url!==""&&this._initializedDeferred.resolve(vt.SUCCESS)}};ec=new WeakMap;let fd=Gp;class My extends fd{}var Ir;class zy extends qd{constructor(){super(...arguments);h(this,Ir)}async worker(){if(!n(this,Ir)){const e=this._session();f(this,Ir,(e?Promise.resolve(e):this._sessionFactory()(!1)).then(a=>new Uf(a,this._getTargetInfo().url,this._targetId,this.type(),()=>{},()=>{})))}return await n(this,Ir)}}Ir=new WeakMap;class Ly extends qd{}/**
 * @license
 * Copyright 2022 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */function Ny(o,t){return!!o._subtype()&&!t.subtype}var Re,va,_e,Ni,tc,Ea,Pi,ki,ba,oc,Bi,ac,Sr,Bd,ot,hp,fp,ic,sc,rc,nc,Fd,ts,$d;class Py extends ye{constructor(e,a,i,s=!0){super();h(this,ot);h(this,Re);h(this,va,new Map);h(this,_e,new Map);h(this,Ni,new Map);h(this,tc,new Set);h(this,Ea);h(this,Pi);h(this,ki,new WeakMap);h(this,ba,new WeakMap);h(this,oc,de.create());h(this,Bi,new Set);h(this,ac,!0);h(this,Sr,[{}]);h(this,Bd,()=>{if(n(this,ac))for(const[e,a]of n(this,va).entries()){const i=new qd(a,void 0,void 0,this,void 0),s=a.type==="browser"||a.url.startsWith("chrome-extension://");(!n(this,Ea)||n(this,Ea).call(this,i))&&!s&&n(this,Bi).add(e)}});h(this,ic,e=>{w(this,ot,fp).call(this,e)});h(this,sc,async e=>{if(n(this,va).set(e.targetInfo.targetId,e.targetInfo),this.emit("targetDiscovered",e.targetInfo),e.targetInfo.type==="browser"&&e.targetInfo.attached){if(n(this,_e).has(e.targetInfo.targetId))return;const a=n(this,Pi).call(this,e.targetInfo,void 0);a._initialize(),n(this,_e).set(e.targetInfo.targetId,a)}});h(this,rc,e=>{const a=n(this,va).get(e.targetId);if(n(this,va).delete(e.targetId),w(this,ot,ts).call(this,e.targetId),(a==null?void 0:a.type)==="service_worker"&&n(this,_e).has(e.targetId)){const i=n(this,_e).get(e.targetId);i&&(this.emit("targetGone",i),n(this,_e).delete(e.targetId))}});h(this,nc,e=>{var r;if(n(this,va).set(e.targetInfo.targetId,e.targetInfo),n(this,tc).has(e.targetInfo.targetId)||!n(this,_e).has(e.targetInfo.targetId)||!e.targetInfo.attached)return;const a=n(this,_e).get(e.targetInfo.targetId);if(!a)return;const i=a.url(),s=a._initializedDeferred.value()===vt.SUCCESS;if(Ny(a,e.targetInfo)){const l=a==null?void 0:a._session();L(l,"Target that is being activated is missing a CDPSession."),(r=l.parentSession())==null||r.emit(ge.Swapped,l)}a._targetInfoChanged(e.targetInfo),s&&i!==a.url()&&this.emit("targetChanged",{target:a,wasInitialized:s,previousURL:i})});h(this,Fd,async(e,a)=>{const i=a.targetInfo,s=n(this,Re).session(a.sessionId);if(!s)throw new Error(`Session ${a.sessionId} was not created.`);const r=async()=>{await s.send("Runtime.runIfWaitingForDebugger").catch(Z),await e.send("Target.detachFromTarget",{sessionId:s.id()}).catch(Z)};if(!n(this,Re).isAutoAttached(i.targetId))return;if(i.type==="service_worker"){if(w(this,ot,ts).call(this,i.targetId),await r(),n(this,_e).has(i.targetId))return;const u=n(this,Pi).call(this,i);u._initialize(),n(this,_e).set(i.targetId,u),this.emit("targetAvailable",u);return}const l=n(this,_e).has(i.targetId),c=l?n(this,_e).get(i.targetId):n(this,Pi).call(this,i,s,e instanceof jc?e:void 0);if(n(this,Ea)&&!n(this,Ea).call(this,c)){n(this,tc).add(i.targetId),w(this,ot,ts).call(this,i.targetId),await r();return}w(this,ot,hp).call(this,s),l?(s._setTarget(c),n(this,Ni).set(s.id(),n(this,_e).get(i.targetId))):(c._initialize(),n(this,_e).set(i.targetId,c),n(this,Ni).set(s.id(),c));const d=e instanceof jc?e._target():null;d==null||d._addChildTarget(c),e.emit(ge.Ready,s),n(this,Bi).delete(c._targetId),l||this.emit("targetAvailable",c),w(this,ot,ts).call(this),await Promise.all([s.send("Target.setAutoAttach",{waitForDebuggerOnStart:!0,flatten:!0,autoAttach:!0,filter:n(this,Sr)}),s.send("Runtime.runIfWaitingForDebugger")]).catch(Z)});h(this,$d,(e,a)=>{const i=n(this,Ni).get(a.sessionId);n(this,Ni).delete(a.sessionId),i&&(e instanceof jc&&e._target()._removeChildTarget(i),n(this,_e).delete(i._targetId),this.emit("targetGone",i))});f(this,Re,e),f(this,Ea,i),f(this,Pi,a),f(this,ac,s),n(this,Re).on("Target.targetCreated",n(this,sc)),n(this,Re).on("Target.targetDestroyed",n(this,rc)),n(this,Re).on("Target.targetInfoChanged",n(this,nc)),n(this,Re).on(ge.SessionDetached,n(this,ic)),w(this,ot,hp).call(this,n(this,Re))}async initialize(){await n(this,Re).send("Target.setDiscoverTargets",{discover:!0,filter:n(this,Sr)}),n(this,Bd).call(this),await n(this,Re).send("Target.setAutoAttach",{waitForDebuggerOnStart:!0,flatten:!0,autoAttach:!0,filter:[{type:"page",exclude:!0},...n(this,Sr)]}),w(this,ot,ts).call(this),await n(this,oc).valueOrThrow()}getChildTargets(e){return e._childTargets()}dispose(){n(this,Re).off("Target.targetCreated",n(this,sc)),n(this,Re).off("Target.targetDestroyed",n(this,rc)),n(this,Re).off("Target.targetInfoChanged",n(this,nc)),n(this,Re).off(ge.SessionDetached,n(this,ic)),w(this,ot,fp).call(this,n(this,Re))}getAvailableTargets(){return n(this,_e)}}Re=new WeakMap,va=new WeakMap,_e=new WeakMap,Ni=new WeakMap,tc=new WeakMap,Ea=new WeakMap,Pi=new WeakMap,ki=new WeakMap,ba=new WeakMap,oc=new WeakMap,Bi=new WeakMap,ac=new WeakMap,Sr=new WeakMap,Bd=new WeakMap,ot=new WeakSet,hp=function(e){const a=s=>{n(this,Fd).call(this,e,s)};L(!n(this,ki).has(e)),n(this,ki).set(e,a),e.on("Target.attachedToTarget",a);const i=s=>n(this,$d).call(this,e,s);L(!n(this,ba).has(e)),n(this,ba).set(e,i),e.on("Target.detachedFromTarget",i)},fp=function(e){const a=n(this,ki).get(e);a&&(e.off("Target.attachedToTarget",a),n(this,ki).delete(e)),n(this,ba).has(e)&&(e.off("Target.detachedFromTarget",n(this,ba).get(e)),n(this,ba).delete(e))},ic=new WeakMap,sc=new WeakMap,rc=new WeakMap,nc=new WeakMap,Fd=new WeakMap,ts=function(e){e!==void 0&&n(this,Bi).delete(e),n(this,Bi).size===0&&n(this,oc).resolve()},$d=new WeakMap;/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var Ar,lc,Oe,cc,Cr,Rr,ya,Eo,Ee,dc,uc,Vi,Qf,pc,mc,gc,hc,fc,vp;const Kp=class Kp extends $E{constructor(e,a,i,s,r,l,c,d,u=!0,p){super();h(this,Vi);_(this,"protocol","cdp");h(this,Ar);h(this,lc);h(this,Oe);h(this,cc);h(this,Cr);h(this,Rr);h(this,ya);h(this,Eo,new Map);h(this,Ee);h(this,dc);h(this,uc,()=>{this.emit("disconnected",void 0)});h(this,pc,(e,a)=>{var c;const{browserContextId:i}=e,s=i&&n(this,Eo).has(i)?n(this,Eo).get(i):n(this,ya);if(!s)throw new Error("Missing browser context");const r=d=>n(this,Oe)._createSession(e,d),l=new Ly(e,a,s,n(this,Ee),r);return(c=e.url)!=null&&c.startsWith("devtools://")?new My(e,a,s,n(this,Ee),r,n(this,Ar)??null):n(this,Rr).call(this,l)?new fd(e,a,s,n(this,Ee),r,n(this,Ar)??null):e.type==="service_worker"||e.type==="shared_worker"?new zy(e,a,s,n(this,Ee),r):l});h(this,mc,async e=>{e._isTargetExposed()&&await e._initializedDeferred.valueOrThrow()===vt.SUCCESS&&(this.emit("targetcreated",e),e.browserContext().emit("targetcreated",e))});h(this,gc,async e=>{e._initializedDeferred.resolve(vt.ABORTED),e._isClosedDeferred.resolve(),e._isTargetExposed()&&await e._initializedDeferred.valueOrThrow()===vt.SUCCESS&&(this.emit("targetdestroyed",e),e.browserContext().emit("targetdestroyed",e))});h(this,hc,({target:e})=>{this.emit("targetchanged",e),e.browserContext().emit("targetchanged",e)});h(this,fc,e=>{this.emit("targetdiscovered",e)});e=e||"chrome",f(this,Ar,s),f(this,lc,r),f(this,Oe,a),f(this,cc,l||(()=>{})),f(this,Cr,c||(()=>!0)),w(this,Vi,Qf).call(this,d),e==="firefox"?f(this,Ee,new jh(a,n(this,pc),n(this,Cr))):f(this,Ee,new Py(a,n(this,pc),n(this,Cr),u)),f(this,ya,new iu(n(this,Oe),this));for(const g of i)n(this,Eo).set(g,new iu(n(this,Oe),this,g));f(this,dc,p||"unknown")}static async _create(e,a,i,s,r,l,c,d,u,p=!0,g){const m=new Kp(e,a,i,r,l,c,d,u,p,g);return s&&await a.send("Security.setIgnoreCertificateErrors",{ignore:!0}),await m._attach(),m}async _attach(){n(this,Oe).on(ge.Disconnected,n(this,uc)),n(this,Ee).on("targetAvailable",n(this,mc)),n(this,Ee).on("targetGone",n(this,gc)),n(this,Ee).on("targetChanged",n(this,hc)),n(this,Ee).on("targetDiscovered",n(this,fc)),await n(this,Ee).initialize()}_detach(){n(this,Oe).off(ge.Disconnected,n(this,uc)),n(this,Ee).off("targetAvailable",n(this,mc)),n(this,Ee).off("targetGone",n(this,gc)),n(this,Ee).off("targetChanged",n(this,hc)),n(this,Ee).off("targetDiscovered",n(this,fc))}process(){return n(this,lc)??null}_targetManager(){return n(this,Ee)}_getIsPageTargetCallback(){return n(this,Rr)}async createBrowserContext(e={}){const{proxyServer:a,proxyBypassList:i}=e,{browserContextId:s}=await n(this,Oe).send("Target.createBrowserContext",{proxyServer:a,proxyBypassList:i&&i.join(",")}),r=new iu(n(this,Oe),this,s);return n(this,Eo).set(s,r),r}browserContexts(){return[n(this,ya),...Array.from(n(this,Eo).values())]}defaultBrowserContext(){return n(this,ya)}async _disposeContext(e){e&&(await n(this,Oe).send("Target.disposeBrowserContext",{browserContextId:e}),n(this,Eo).delete(e))}wsEndpoint(){return n(this,Oe).url()}async newPage(){return await n(this,ya).newPage()}async _createPageInContext(e){const{targetId:a}=await n(this,Oe).send("Target.createTarget",{url:"about:blank",browserContextId:e||void 0}),i=await this.waitForTarget(l=>l._targetId===a);if(!i)throw new Error(`Missing target for page (id = ${a})`);if(!(await i._initializedDeferred.valueOrThrow()===vt.SUCCESS))throw new Error(`Failed to create target for page (id = ${a})`);const r=await i.page();if(!r)throw new Error(`Failed to create a page for context (id = ${e})`);return r}targets(){return Array.from(n(this,Ee).getAvailableTargets().values()).filter(e=>e._isTargetExposed()&&e._initializedDeferred.value()===vt.SUCCESS)}target(){const e=this.targets().find(a=>a.type()==="browser");if(!e)throw new Error("Browser target is not found");return e}async version(){return(await w(this,Vi,vp).call(this)).product}async userAgent(){return(await w(this,Vi,vp).call(this)).userAgent}async close(){await n(this,cc).call(null),await this.disconnect()}disconnect(){return n(this,Ee).dispose(),n(this,Oe).dispose(),this._detach(),Promise.resolve()}get connected(){return!n(this,Oe)._closed}get debugInfo(){return{pendingProtocolErrors:n(this,Oe).getPendingProtocolErrors()}}sessionId(){return n(this,dc)}};Ar=new WeakMap,lc=new WeakMap,Oe=new WeakMap,cc=new WeakMap,Cr=new WeakMap,Rr=new WeakMap,ya=new WeakMap,Eo=new WeakMap,Ee=new WeakMap,dc=new WeakMap,uc=new WeakMap,Vi=new WeakSet,Qf=function(e){f(this,Rr,e||(a=>a.type()==="page"||a.type()==="background_page"||a.type()==="webview"))},pc=new WeakMap,mc=new WeakMap,gc=new WeakMap,hc=new WeakMap,fc=new WeakMap,vp=function(){return n(this,Oe).send("Browser.getVersion")};let vd=Kp;/**
 * @license
 * Copyright 2020 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */async function ky(o,t,e){const{ignoreHTTPSErrors:a=!1,defaultViewport:i=DE,targetFilter:s,_isPageTarget:r,slowMo:l=0,protocolTimeout:c}=e,d=new Ph(t,o,l,c),p=(await d.send("Browser.getVersion")).product.toLowerCase().includes("firefox")?"firefox":"chrome",{browserContextIds:g}=await d.send("Target.getBrowserContexts");return await vd._create(p,d,g,a,i,void 0,()=>d.send("Browser.close").catch(Z),s,r)}/**
 * @license
 * Copyright 2023 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const $m=async()=>xh?(await Promise.resolve().then(()=>Mw)).NodeWebSocketTransport:(await Promise.resolve().then(()=>Ky)).BrowserWebSocketTransport;async function By(o){const{connectionTransport:t,endpointUrl:e}=await Fy(o);return await ky(t,e,o)}async function Fy(o){const{browserWSEndpoint:t,browserURL:e,transport:a,headers:i={}}=o;if(L(+!!t+ +!!e+ +!!a==1,"Exactly one of browserWSEndpoint, browserURL or transport must be passed to puppeteer.connect"),a)return{connectionTransport:a,endpointUrl:""};if(t)return{connectionTransport:await(await $m()).create(t,i),endpointUrl:t};if(e){const s=await $y(e);return{connectionTransport:await(await $m()).create(s),endpointUrl:s}}throw new Error("Invalid connection options")}async function $y(o){const t=new URL("/json/version",o);try{const e=await globalThis.fetch(t.toString(),{method:"GET"});if(!e.ok)throw new Error(`HTTP ${e.statusText}`);return(await e.json()).webSocketDebuggerUrl}catch(e){throw Xt(e)&&(e.message=`Failed to fetch browser webSocket URL from ${t}: `+e.message),e}}/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */class e0{constructor(t){_(this,"_isPuppeteerCore");_(this,"_changedProduct",!1);this._isPuppeteerCore=t.isPuppeteerCore,this.connect=this.connect.bind(this)}static registerCustomQueryHandler(t,e){return this.customQueryHandlers.register(t,e)}static unregisterCustomQueryHandler(t){return this.customQueryHandlers.unregister(t)}static customQueryHandlerNames(){return this.customQueryHandlers.names()}static clearCustomQueryHandlers(){return this.customQueryHandlers.clear()}connect(t){return By(t)}}_(e0,"customQueryHandlers",ku);/**
 * @license
 * Copyright 2025 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const Uy=Object.freeze({width:800,height:600});async function jy(o,t){const{ignoreHTTPSErrors:e=!1,defaultViewport:a=Uy,targetFilter:i,_isPageTarget:s,slowMo:r=0,protocolTimeout:l,sessionId:c="unknown"}=t,d=new Ph("",o,r,l),p=(await d.send("Browser.getVersion")).product.toLowerCase().includes("firefox")?"firefox":"chrome",{browserContextIds:g}=await d.send("Target.getBrowserContexts");return await vd._create(p,d,g,e,a,void 0,()=>d.send("Browser.close").catch(console.log),i,s,!0,c)}/**
 * @license
 * Copyright 2025 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const dn=4,ad=1048575,Um=ad-dn,Hy=o=>{const e=new TextEncoder().encode(o),a=new Uint8Array(Math.min(ad,dn+e.length));new DataView(a.buffer).setUint32(0,e.length,!0),a.set(e.slice(0,Um),dn);const s=[a];for(let r=Um;r<o.length;r+=ad)s.push(e.slice(r,r+ad));return s},Vy=(o,t)=>{if(o.length===0)return null;const e=new Uint8Array(0),a=o[0]||e,s=new DataView(a.buffer).getUint32(0,!0);let r=-dn;for(let l=0;l<o.length;++l){const c=o[l]||e;if(r+=c.length,r>s)throw new Error(`Should have gotten the exact number of bytes but we got more.  SessionID: ${t}`);if(r===s){const d=o.splice(0,l+1);d[0]=a.subarray(dn);const u=new Uint8Array(s);let p=0;for(let v=0;v<=l;++v){const b=d[v]||e;u.set(b,p),p+=b.length}return new TextDecoder().decode(u)}}return null},Wy="https://fake.host";class Bp{constructor(t,e){_(this,"ws");_(this,"pingInterval");_(this,"chunks",[]);_(this,"onmessage");_(this,"onclose");_(this,"sessionId");this.pingInterval=setInterval(()=>this.ws.send("ping"),1e3),this.ws=t,this.sessionId=e,this.ws.addEventListener("message",a=>{this.chunks.push(new Uint8Array(a.data));const i=Vy(this.chunks,e);i&&this.onmessage&&this.onmessage(i)}),this.ws.addEventListener("close",()=>{clearInterval(this.pingInterval),this.onclose&&this.onclose()}),this.ws.addEventListener("error",a=>{console.error(`Websocket error: SessionID: ${e}`,a),clearInterval(this.pingInterval)})}static async create(t,e){const a=`${Wy}/v1/connectDevtools?browser_session=${e}`,i=await t.fetch(a,{headers:{Upgrade:"websocket","cf-brapi-client":`@cloudflare/puppeteer@${zp}`}});return i.webSocket.accept(),new Bp(i.webSocket,e)}send(t){for(const e of Hy(t))this.ws.send(e)}close(){clearInterval(this.pingInterval),this.ws.close()}toString(){return this.sessionId}}/**
 * @license
 * Copyright 2025 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const zc="https://fake.host";class Gy extends e0{constructor(){super({isPuppeteerCore:!1}),this.acquire=this.acquire.bind(this),this.connect=this.connect.bind(this),this.launch=this.launch.bind(this),this.sessions=this.sessions.bind(this),this.history=this.history.bind(this),this.limits=this.limits.bind(this)}async launch(t,e){const a=await this.acquire(t,e);return await this.connect(t,a.sessionId)}async sessions(t){const e=await t.fetch(`${zc}/v1/sessions`),a=e.status,i=await e.text();if(a!==200)throw new Error(`Unable to fetch new sessions: code: ${a}: message: ${i}`);return JSON.parse(i).sessions}async history(t){const e=await t.fetch(`${zc}/v1/history`),a=e.status,i=await e.text();if(a!==200)throw new Error(`Unable to fetch account history: code: ${a}: message: ${i}`);return JSON.parse(i).history}async limits(t){const e=await t.fetch(`${zc}/v1/limits`),a=e.status,i=await e.text();if(a!==200)throw new Error(`Unable to fetch account limits: code: ${a}: message: ${i}`);return JSON.parse(i)}async connect(t,e){try{if(!e)return await super.connect(t);const a=await Bp.create(t,e);return await jy(a,{sessionId:e})}catch(a){throw new Error(`Unable to connect to existing session ${e} (it may still be in use or not ready yet) - retry or launch a new browser: ${a}`)}}async acquire(t,e){const a=new URLSearchParams;e!=null&&e.keep_alive&&a.set("keep_alive",`${e.keep_alive}`),e!=null&&e.location&&a.set("location",e.location);const i=`${zc}/v1/acquire?${a.toString()}`,s=await t.fetch(i),r=s.status,l=await s.text();if(r!==200)throw new Error(`Unable to create new browser: code: ${r}: message: ${l}`);return JSON.parse(l)}}var bo;const qp=class qp{constructor(t){h(this,bo);_(this,"onmessage");_(this,"onclose");f(this,bo,t),n(this,bo).addEventListener("message",e=>{this.onmessage&&this.onmessage.call(null,e.data)}),n(this,bo).addEventListener("close",()=>{this.onclose&&this.onclose.call(null)}),n(this,bo).addEventListener("error",()=>{})}static create(t){return new Promise((e,a)=>{const i=new WebSocket(t);i.addEventListener("open",()=>e(new qp(i))),i.addEventListener("error",a)})}send(t){n(this,bo).send(t)}close(){n(this,bo).close()}};bo=new WeakMap;let Ep=qp;const Ky=Object.freeze(Object.defineProperty({__proto__:null,BrowserWebSocketTransport:Ep},Symbol.toStringTag,{value:"Module"}));/**
 * @license
 * Copyright 2017 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const qy=[{name:"Blackberry PlayBook",userAgent:"Mozilla/5.0 (PlayBook; U; RIM Tablet OS 2.1.0; en-US) AppleWebKit/536.2+ (KHTML like Gecko) Version/7.2.1.0 Safari/536.2+",viewport:{width:600,height:1024,deviceScaleFactor:1,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Blackberry PlayBook landscape",userAgent:"Mozilla/5.0 (PlayBook; U; RIM Tablet OS 2.1.0; en-US) AppleWebKit/536.2+ (KHTML like Gecko) Version/7.2.1.0 Safari/536.2+",viewport:{width:1024,height:600,deviceScaleFactor:1,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"BlackBerry Z30",userAgent:"Mozilla/5.0 (BB10; Touch) AppleWebKit/537.10+ (KHTML, like Gecko) Version/10.0.9.2372 Mobile Safari/537.10+",viewport:{width:360,height:640,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"BlackBerry Z30 landscape",userAgent:"Mozilla/5.0 (BB10; Touch) AppleWebKit/537.10+ (KHTML, like Gecko) Version/10.0.9.2372 Mobile Safari/537.10+",viewport:{width:640,height:360,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Galaxy Note 3",userAgent:"Mozilla/5.0 (Linux; U; Android 4.3; en-us; SM-N900T Build/JSS15J) AppleWebKit/534.30 (KHTML, like Gecko) Version/4.0 Mobile Safari/534.30",viewport:{width:360,height:640,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Galaxy Note 3 landscape",userAgent:"Mozilla/5.0 (Linux; U; Android 4.3; en-us; SM-N900T Build/JSS15J) AppleWebKit/534.30 (KHTML, like Gecko) Version/4.0 Mobile Safari/534.30",viewport:{width:640,height:360,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Galaxy Note II",userAgent:"Mozilla/5.0 (Linux; U; Android 4.1; en-us; GT-N7100 Build/JRO03C) AppleWebKit/534.30 (KHTML, like Gecko) Version/4.0 Mobile Safari/534.30",viewport:{width:360,height:640,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Galaxy Note II landscape",userAgent:"Mozilla/5.0 (Linux; U; Android 4.1; en-us; GT-N7100 Build/JRO03C) AppleWebKit/534.30 (KHTML, like Gecko) Version/4.0 Mobile Safari/534.30",viewport:{width:640,height:360,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Galaxy S III",userAgent:"Mozilla/5.0 (Linux; U; Android 4.0; en-us; GT-I9300 Build/IMM76D) AppleWebKit/534.30 (KHTML, like Gecko) Version/4.0 Mobile Safari/534.30",viewport:{width:360,height:640,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Galaxy S III landscape",userAgent:"Mozilla/5.0 (Linux; U; Android 4.0; en-us; GT-I9300 Build/IMM76D) AppleWebKit/534.30 (KHTML, like Gecko) Version/4.0 Mobile Safari/534.30",viewport:{width:640,height:360,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Galaxy S5",userAgent:"Mozilla/5.0 (Linux; Android 5.0; SM-G900P Build/LRX21T) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:360,height:640,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Galaxy S5 landscape",userAgent:"Mozilla/5.0 (Linux; Android 5.0; SM-G900P Build/LRX21T) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:640,height:360,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Galaxy S8",userAgent:"Mozilla/5.0 (Linux; Android 7.0; SM-G950U Build/NRD90M) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.84 Mobile Safari/537.36",viewport:{width:360,height:740,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Galaxy S8 landscape",userAgent:"Mozilla/5.0 (Linux; Android 7.0; SM-G950U Build/NRD90M) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.84 Mobile Safari/537.36",viewport:{width:740,height:360,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Galaxy S9+",userAgent:"Mozilla/5.0 (Linux; Android 8.0.0; SM-G965U Build/R16NW) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.111 Mobile Safari/537.36",viewport:{width:320,height:658,deviceScaleFactor:4.5,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Galaxy S9+ landscape",userAgent:"Mozilla/5.0 (Linux; Android 8.0.0; SM-G965U Build/R16NW) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.111 Mobile Safari/537.36",viewport:{width:658,height:320,deviceScaleFactor:4.5,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Galaxy Tab S4",userAgent:"Mozilla/5.0 (Linux; Android 8.1.0; SM-T837A) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.80 Safari/537.36",viewport:{width:712,height:1138,deviceScaleFactor:2.25,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Galaxy Tab S4 landscape",userAgent:"Mozilla/5.0 (Linux; Android 8.1.0; SM-T837A) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.80 Safari/537.36",viewport:{width:1138,height:712,deviceScaleFactor:2.25,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPad",userAgent:"Mozilla/5.0 (iPad; CPU OS 11_0 like Mac OS X) AppleWebKit/604.1.34 (KHTML, like Gecko) Version/11.0 Mobile/15A5341f Safari/604.1",viewport:{width:768,height:1024,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPad landscape",userAgent:"Mozilla/5.0 (iPad; CPU OS 11_0 like Mac OS X) AppleWebKit/604.1.34 (KHTML, like Gecko) Version/11.0 Mobile/15A5341f Safari/604.1",viewport:{width:1024,height:768,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPad (gen 6)",userAgent:"Mozilla/5.0 (iPad; CPU OS 12_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:768,height:1024,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPad (gen 6) landscape",userAgent:"Mozilla/5.0 (iPad; CPU OS 12_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:1024,height:768,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPad (gen 7)",userAgent:"Mozilla/5.0 (iPad; CPU OS 12_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:810,height:1080,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPad (gen 7) landscape",userAgent:"Mozilla/5.0 (iPad; CPU OS 12_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:1080,height:810,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPad Mini",userAgent:"Mozilla/5.0 (iPad; CPU OS 11_0 like Mac OS X) AppleWebKit/604.1.34 (KHTML, like Gecko) Version/11.0 Mobile/15A5341f Safari/604.1",viewport:{width:768,height:1024,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPad Mini landscape",userAgent:"Mozilla/5.0 (iPad; CPU OS 11_0 like Mac OS X) AppleWebKit/604.1.34 (KHTML, like Gecko) Version/11.0 Mobile/15A5341f Safari/604.1",viewport:{width:1024,height:768,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPad Pro",userAgent:"Mozilla/5.0 (iPad; CPU OS 11_0 like Mac OS X) AppleWebKit/604.1.34 (KHTML, like Gecko) Version/11.0 Mobile/15A5341f Safari/604.1",viewport:{width:1024,height:1366,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPad Pro landscape",userAgent:"Mozilla/5.0 (iPad; CPU OS 11_0 like Mac OS X) AppleWebKit/604.1.34 (KHTML, like Gecko) Version/11.0 Mobile/15A5341f Safari/604.1",viewport:{width:1366,height:1024,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPad Pro 11",userAgent:"Mozilla/5.0 (iPad; CPU OS 12_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:834,height:1194,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPad Pro 11 landscape",userAgent:"Mozilla/5.0 (iPad; CPU OS 12_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:1194,height:834,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 4",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 7_1_2 like Mac OS X) AppleWebKit/537.51.2 (KHTML, like Gecko) Version/7.0 Mobile/11D257 Safari/9537.53",viewport:{width:320,height:480,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 4 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 7_1_2 like Mac OS X) AppleWebKit/537.51.2 (KHTML, like Gecko) Version/7.0 Mobile/11D257 Safari/9537.53",viewport:{width:480,height:320,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 5",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_1 like Mac OS X) AppleWebKit/603.1.30 (KHTML, like Gecko) Version/10.0 Mobile/14E304 Safari/602.1",viewport:{width:320,height:568,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 5 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_1 like Mac OS X) AppleWebKit/603.1.30 (KHTML, like Gecko) Version/10.0 Mobile/14E304 Safari/602.1",viewport:{width:568,height:320,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 6",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:375,height:667,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 6 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:667,height:375,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 6 Plus",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:414,height:736,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 6 Plus landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:736,height:414,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 7",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:375,height:667,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 7 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:667,height:375,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 7 Plus",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:414,height:736,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 7 Plus landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:736,height:414,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 8",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:375,height:667,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 8 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:667,height:375,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 8 Plus",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:414,height:736,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 8 Plus landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:736,height:414,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone SE",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_1 like Mac OS X) AppleWebKit/603.1.30 (KHTML, like Gecko) Version/10.0 Mobile/14E304 Safari/602.1",viewport:{width:320,height:568,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone SE landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_1 like Mac OS X) AppleWebKit/603.1.30 (KHTML, like Gecko) Version/10.0 Mobile/14E304 Safari/602.1",viewport:{width:568,height:320,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone X",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:375,height:812,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone X landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",viewport:{width:812,height:375,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone XR",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 12_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0 Mobile/15E148 Safari/604.1",viewport:{width:414,height:896,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone XR landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 12_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0 Mobile/15E148 Safari/604.1",viewport:{width:896,height:414,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 11",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 13_7 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1 Mobile/15E148 Safari/604.1",viewport:{width:414,height:828,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 11 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 13_7 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1 Mobile/15E148 Safari/604.1",viewport:{width:828,height:414,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 11 Pro",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 13_7 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1 Mobile/15E148 Safari/604.1",viewport:{width:375,height:812,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 11 Pro landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 13_7 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1 Mobile/15E148 Safari/604.1",viewport:{width:812,height:375,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 11 Pro Max",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 13_7 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1 Mobile/15E148 Safari/604.1",viewport:{width:414,height:896,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 11 Pro Max landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 13_7 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1 Mobile/15E148 Safari/604.1",viewport:{width:896,height:414,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 12",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 14_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:390,height:844,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 12 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 14_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:844,height:390,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 12 Pro",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 14_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:390,height:844,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 12 Pro landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 14_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:844,height:390,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 12 Pro Max",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 14_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:428,height:926,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 12 Pro Max landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 14_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:926,height:428,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 12 Mini",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 14_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:375,height:812,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 12 Mini landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 14_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:812,height:375,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 13",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:390,height:844,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 13 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:844,height:390,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 13 Pro",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:390,height:844,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 13 Pro landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:844,height:390,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 13 Pro Max",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:428,height:926,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 13 Pro Max landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:926,height:428,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 13 Mini",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:375,height:812,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 13 Mini landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.4 Mobile/15E148 Safari/604.1",viewport:{width:812,height:375,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 14",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1",viewport:{width:390,height:663,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 14 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1",viewport:{width:750,height:340,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 14 Plus",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1",viewport:{width:428,height:745,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 14 Plus landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1",viewport:{width:832,height:378,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 14 Pro",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1",viewport:{width:393,height:659,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 14 Pro landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1",viewport:{width:734,height:343,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 14 Pro Max",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1",viewport:{width:430,height:739,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 14 Pro Max landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1",viewport:{width:814,height:380,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 15",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 17_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E148 Safari/604.1",viewport:{width:393,height:659,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 15 landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 17_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E148 Safari/604.1",viewport:{width:734,height:343,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 15 Plus",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 17_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E148 Safari/604.1",viewport:{width:430,height:739,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 15 Plus landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 17_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E148 Safari/604.1",viewport:{width:814,height:380,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 15 Pro",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 17_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E148 Safari/604.1",viewport:{width:393,height:659,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 15 Pro landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 17_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E148 Safari/604.1",viewport:{width:734,height:343,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"iPhone 15 Pro Max",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 17_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E148 Safari/604.1",viewport:{width:430,height:739,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"iPhone 15 Pro Max landscape",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 17_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Mobile/15E148 Safari/604.1",viewport:{width:814,height:380,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"JioPhone 2",userAgent:"Mozilla/5.0 (Mobile; LYF/F300B/LYF-F300B-001-01-15-130718-i;Android; rv:48.0) Gecko/48.0 Firefox/48.0 KAIOS/2.5",viewport:{width:240,height:320,deviceScaleFactor:1,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"JioPhone 2 landscape",userAgent:"Mozilla/5.0 (Mobile; LYF/F300B/LYF-F300B-001-01-15-130718-i;Android; rv:48.0) Gecko/48.0 Firefox/48.0 KAIOS/2.5",viewport:{width:320,height:240,deviceScaleFactor:1,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Kindle Fire HDX",userAgent:"Mozilla/5.0 (Linux; U; en-us; KFAPWI Build/JDQ39) AppleWebKit/535.19 (KHTML, like Gecko) Silk/3.13 Safari/535.19 Silk-Accelerated=true",viewport:{width:800,height:1280,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Kindle Fire HDX landscape",userAgent:"Mozilla/5.0 (Linux; U; en-us; KFAPWI Build/JDQ39) AppleWebKit/535.19 (KHTML, like Gecko) Silk/3.13 Safari/535.19 Silk-Accelerated=true",viewport:{width:1280,height:800,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"LG Optimus L70",userAgent:"Mozilla/5.0 (Linux; U; Android 4.4.2; en-us; LGMS323 Build/KOT49I.MS32310c) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:384,height:640,deviceScaleFactor:1.25,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"LG Optimus L70 landscape",userAgent:"Mozilla/5.0 (Linux; U; Android 4.4.2; en-us; LGMS323 Build/KOT49I.MS32310c) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:640,height:384,deviceScaleFactor:1.25,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Microsoft Lumia 550",userAgent:"Mozilla/5.0 (Windows Phone 10.0; Android 4.2.1; Microsoft; Lumia 550) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2486.0 Mobile Safari/537.36 Edge/14.14263",viewport:{width:640,height:360,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Microsoft Lumia 950",userAgent:"Mozilla/5.0 (Windows Phone 10.0; Android 4.2.1; Microsoft; Lumia 950) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2486.0 Mobile Safari/537.36 Edge/14.14263",viewport:{width:360,height:640,deviceScaleFactor:4,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Microsoft Lumia 950 landscape",userAgent:"Mozilla/5.0 (Windows Phone 10.0; Android 4.2.1; Microsoft; Lumia 950) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2486.0 Mobile Safari/537.36 Edge/14.14263",viewport:{width:640,height:360,deviceScaleFactor:4,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Nexus 10",userAgent:"Mozilla/5.0 (Linux; Android 6.0.1; Nexus 10 Build/MOB31T) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Safari/537.36",viewport:{width:800,height:1280,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Nexus 10 landscape",userAgent:"Mozilla/5.0 (Linux; Android 6.0.1; Nexus 10 Build/MOB31T) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Safari/537.36",viewport:{width:1280,height:800,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Nexus 4",userAgent:"Mozilla/5.0 (Linux; Android 4.4.2; Nexus 4 Build/KOT49H) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:384,height:640,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Nexus 4 landscape",userAgent:"Mozilla/5.0 (Linux; Android 4.4.2; Nexus 4 Build/KOT49H) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:640,height:384,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Nexus 5",userAgent:"Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:360,height:640,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Nexus 5 landscape",userAgent:"Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:640,height:360,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Nexus 5X",userAgent:"Mozilla/5.0 (Linux; Android 8.0.0; Nexus 5X Build/OPR4.170623.006) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:412,height:732,deviceScaleFactor:2.625,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Nexus 5X landscape",userAgent:"Mozilla/5.0 (Linux; Android 8.0.0; Nexus 5X Build/OPR4.170623.006) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:732,height:412,deviceScaleFactor:2.625,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Nexus 6",userAgent:"Mozilla/5.0 (Linux; Android 7.1.1; Nexus 6 Build/N6F26U) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:412,height:732,deviceScaleFactor:3.5,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Nexus 6 landscape",userAgent:"Mozilla/5.0 (Linux; Android 7.1.1; Nexus 6 Build/N6F26U) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:732,height:412,deviceScaleFactor:3.5,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Nexus 6P",userAgent:"Mozilla/5.0 (Linux; Android 8.0.0; Nexus 6P Build/OPP3.170518.006) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:412,height:732,deviceScaleFactor:3.5,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Nexus 6P landscape",userAgent:"Mozilla/5.0 (Linux; Android 8.0.0; Nexus 6P Build/OPP3.170518.006) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:732,height:412,deviceScaleFactor:3.5,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Nexus 7",userAgent:"Mozilla/5.0 (Linux; Android 6.0.1; Nexus 7 Build/MOB30X) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Safari/537.36",viewport:{width:600,height:960,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Nexus 7 landscape",userAgent:"Mozilla/5.0 (Linux; Android 6.0.1; Nexus 7 Build/MOB30X) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Safari/537.36",viewport:{width:960,height:600,deviceScaleFactor:2,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Nokia Lumia 520",userAgent:"Mozilla/5.0 (compatible; MSIE 10.0; Windows Phone 8.0; Trident/6.0; IEMobile/10.0; ARM; Touch; NOKIA; Lumia 520)",viewport:{width:320,height:533,deviceScaleFactor:1.5,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Nokia Lumia 520 landscape",userAgent:"Mozilla/5.0 (compatible; MSIE 10.0; Windows Phone 8.0; Trident/6.0; IEMobile/10.0; ARM; Touch; NOKIA; Lumia 520)",viewport:{width:533,height:320,deviceScaleFactor:1.5,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Nokia N9",userAgent:"Mozilla/5.0 (MeeGo; NokiaN9) AppleWebKit/534.13 (KHTML, like Gecko) NokiaBrowser/8.5.0 Mobile Safari/534.13",viewport:{width:480,height:854,deviceScaleFactor:1,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Nokia N9 landscape",userAgent:"Mozilla/5.0 (MeeGo; NokiaN9) AppleWebKit/534.13 (KHTML, like Gecko) NokiaBrowser/8.5.0 Mobile Safari/534.13",viewport:{width:854,height:480,deviceScaleFactor:1,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Pixel 2",userAgent:"Mozilla/5.0 (Linux; Android 8.0; Pixel 2 Build/OPD3.170816.012) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:411,height:731,deviceScaleFactor:2.625,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Pixel 2 landscape",userAgent:"Mozilla/5.0 (Linux; Android 8.0; Pixel 2 Build/OPD3.170816.012) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:731,height:411,deviceScaleFactor:2.625,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Pixel 2 XL",userAgent:"Mozilla/5.0 (Linux; Android 8.0.0; Pixel 2 XL Build/OPD1.170816.004) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:411,height:823,deviceScaleFactor:3.5,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Pixel 2 XL landscape",userAgent:"Mozilla/5.0 (Linux; Android 8.0.0; Pixel 2 XL Build/OPD1.170816.004) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3765.0 Mobile Safari/537.36",viewport:{width:823,height:411,deviceScaleFactor:3.5,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Pixel 3",userAgent:"Mozilla/5.0 (Linux; Android 9; Pixel 3 Build/PQ1A.181105.017.A1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.158 Mobile Safari/537.36",viewport:{width:393,height:786,deviceScaleFactor:2.75,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Pixel 3 landscape",userAgent:"Mozilla/5.0 (Linux; Android 9; Pixel 3 Build/PQ1A.181105.017.A1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.158 Mobile Safari/537.36",viewport:{width:786,height:393,deviceScaleFactor:2.75,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Pixel 4",userAgent:"Mozilla/5.0 (Linux; Android 10; Pixel 4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Mobile Safari/537.36",viewport:{width:353,height:745,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Pixel 4 landscape",userAgent:"Mozilla/5.0 (Linux; Android 10; Pixel 4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Mobile Safari/537.36",viewport:{width:745,height:353,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Pixel 4a (5G)",userAgent:"Mozilla/5.0 (Linux; Android 11; Pixel 4a (5G)) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4812.0 Mobile Safari/537.36",viewport:{width:353,height:745,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Pixel 4a (5G) landscape",userAgent:"Mozilla/5.0 (Linux; Android 11; Pixel 4a (5G)) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4812.0 Mobile Safari/537.36",viewport:{width:745,height:353,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Pixel 5",userAgent:"Mozilla/5.0 (Linux; Android 11; Pixel 5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4812.0 Mobile Safari/537.36",viewport:{width:393,height:851,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Pixel 5 landscape",userAgent:"Mozilla/5.0 (Linux; Android 11; Pixel 5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4812.0 Mobile Safari/537.36",viewport:{width:851,height:393,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}},{name:"Moto G4",userAgent:"Mozilla/5.0 (Linux; Android 7.0; Moto G (4)) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4812.0 Mobile Safari/537.36",viewport:{width:360,height:640,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!1}},{name:"Moto G4 landscape",userAgent:"Mozilla/5.0 (Linux; Android 7.0; Moto G (4)) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4812.0 Mobile Safari/537.36",viewport:{width:640,height:360,deviceScaleFactor:3,isMobile:!0,hasTouch:!0,isLandscape:!0}}],t0={};for(const o of qy)t0[o.name]=o;Object.freeze(t0);/**
 * @license
 * Copyright 2025 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */const o0=new Gy,{connect:gT,history:hT,launch:fT,limits:vT,sessions:ET,acquire:bT}=o0;async function Zy(o,t,e={}){console.log("üé® [PDF_GENERATOR] Inizio generazione PDF da HTML...");try{const a=await o0.launch(t),i=await a.newPage();console.log("üìÑ [PDF_GENERATOR] Caricamento HTML nel browser..."),await i.setContent(o,{waitUntil:"networkidle0"}),console.log("üñ®Ô∏è [PDF_GENERATOR] Generazione PDF...");const s=await i.pdf({format:e.format||"A4",printBackground:e.printBackground!==!1,margin:e.margin||{top:"20mm",right:"15mm",bottom:"20mm",left:"15mm"}});return await a.close(),console.log("‚úÖ [PDF_GENERATOR] PDF generato con successo!"),s}catch(a){throw console.error("‚ùå [PDF_GENERATOR] Errore generazione PDF:",a),new Error(`Errore generazione PDF: ${a.message}`)}}const Yy={FAMILY:{nome:"eCura FAMILY",nomeCompleto:"eCura Family",dispositivo:"SiDLY CARE PRO",dispositivoDescrizione:"Dispositivo indossabile con sensori avanzati per il monitoraggio continuo della salute e localizzazione GPS",servizioDescrizione:"Servizio di teleassistenza dedicato alla famiglia, con monitoraggio dei parametri vitali e supporto per anziani",caratteristiche:["Dispositivo SiDLY CARE PRO in comodato d'uso","Monitoraggio parametri vitali (frequenza cardiaca, pressione, temperatura)","Localizzazione GPS per sicurezza e tranquillit√†","App dedicata per familiari","Supporto tecnico e assistenza"]},PRO:{nome:"eCura PRO",nomeCompleto:"eCura PRO",dispositivo:"SiDLY CARE PRO",dispositivoDescrizione:"Sistema di telemonitoraggio professionale con centrale operativa avanzata e sensori medicali certificati",servizioDescrizione:"Soluzione professionale per il monitoraggio remoto della salute con dispositivo medicale certificato e servizi avanzati",caratteristiche:["Dispositivo SiDLY CARE PRO certificato medicale","Monitoraggio continuo parametri vitali avanzati","Sistema di allarme automatico","Storico completo dei dati sanitari","Integrazione con sistemi sanitari","Supporto tecnico dedicato"]},PREMIUM:{nome:"eCura PREMIUM",nomeCompleto:"eCura Premium",dispositivo:"SiDLY VITAL CARE",dispositivoDescrizione:"Dispositivo medicale premium con sensori di ultima generazione per monitoraggio completo e telediagnosi",servizioDescrizione:"Servizio premium completo con dispositivo SiDLY VITAL CARE e supporto sanitario h24",caratteristiche:["Dispositivo SiDLY VITAL CARE top di gamma","Monitoraggio completo parametri vitali","Telediagnosi con medici specialisti","Analisi predittiva con AI","Report sanitari periodici","Consulenza medica prioritaria","Assistenza premium dedicata"]}},Xy={BASE:{nome:"Base",nomeCompleto:"Base con Connessione diretta h24 con i Care Giver e famigliari per 7 giorni per la durata di 12 mesi",descrizione:"Piano base con notifiche e allarmi indirizzati direttamente ai care givers e familiari",caratteristiche:["Connessione diretta h24 con Care Giver e familiari","Notifiche e allarmi 7 giorni su 7","Monitoraggio parametri vitali","App dedicata per familiari","Storico dati disponibile","Supporto tecnico per il dispositivo","Manutenzione ordinaria inclusa"],centraleOperativa:!1},AVANZATO:{nome:"Avanzato",nomeCompleto:"Avanzato con Servizi di Centrale Operativa h24 per 7 giorni per la durata di 12 mesi",descrizione:"Piano avanzato con centrale operativa attiva 24 ore su 24, 7 giorni su 7",caratteristiche:["Centrale operativa h24 365 giorni/anno","Servizi di Centrale Operativa per 7 giorni","Intervento immediato in caso di emergenza","Monitoraggio continuo parametri vitali","Allarmi automatici alla centrale","Coordinamento con servizi sanitari di emergenza","Report medici periodici","Manutenzione prioritaria"],centraleOperativa:!0}};function bp(o){return Yy[o]}function yp(o){return Xy[o]}function Jy(o,t){const e=bp(o),a=yp(t);return[...e.caratteristiche,...a.caratteristiche]}class Qy{static async generateContract(t,e,a){try{console.log("üìÑ [CONTRACT] Generazione contratto DOCX/PDF per:",t.leadId);const i=this.generateContractCode(),s=`CONTR_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,r={...t,codiceContratto:i,dataContratto:new Date().toLocaleDateString("it-IT")};console.log("üìÑ [CONTRACT] Generazione HTML da template professionale...");const l=this.generateContractHTMLFromTemplate(r);let c;a?(console.log("üé® [CONTRACT] Generazione PDF con Browser Rendering..."),c=await Zy(l,a,{format:"A4",printBackground:!0})):(console.log("üìÑ [CONTRACT] Generazione PDF da HTML (fallback)..."),c=this.generatePDFFromHTMLFallback(l,r));const d=Buffer.from(c).toString("base64");return await e.prepare(`
        INSERT INTO contracts (
          id, lead_id, contract_code, tipo_servizio,
          prezzo_base, prezzo_iva_inclusa, status,
          pdf_url, created_at, updated_at
        ) VALUES (?, ?, ?, ?, ?, ?, 'DRAFT', ?, datetime('now'), datetime('now'))
      `).bind(s,t.leadId,i,t.tipoServizio,t.prezzoMensile*t.durataContratto,t.prezzoTotale,null).run(),console.log("‚úÖ [CONTRACT] Contratto generato:",s),{success:!0,contract:{contractId:s,codiceContratto:i,pdfBase64:d,createdAt:new Date().toISOString()}}}catch(i){return console.error("‚ùå [CONTRACT] Errore generazione contratto:",i),{success:!1,error:i instanceof Error?i.message:"Errore sconosciuto"}}}static generateContractHTMLFromTemplate(t){const e=this.getContractTemplateUnificato(),a=t.servizio||"PRO",i=t.tipoServizio,s=bp(a),r=yp(i);Jy(a,i);const l=t.prezzoTotale,c=t.prezzoMensile*12,d=new Date,u=new Date(d),p=new Date(d);p.setMonth(p.getMonth()+(t.durataContratto||12));const g=v=>{const b=String(v.getDate()).padStart(2,"0"),E=String(v.getMonth()+1).padStart(2,"0"),T=v.getFullYear();return`${b}/${E}/${T}`},m={NOME_ASSISTITO:t.nomeAssistito||t.nomeRichiedente,COGNOME_ASSISTITO:t.cognomeAssistito||t.cognomeRichiedente,LUOGO_NASCITA:t.luogoNascita||"DA COMPLETARE",DATA_NASCITA:t.dataNascita||"DA COMPLETARE",INDIRIZZO_ASSISTITO:t.indirizzoAssistito||"DA COMPLETARE",CAP_ASSISTITO:t.capAssistito||"DA COMPLETARE",CITTA_ASSISTITO:t.cittaAssistito||"DA COMPLETARE",PROVINCIA_ASSISTITO:t.provinciaAssistito||"DA COMPLETARE",CODICE_FISCALE_ASSISTITO:t.codiceFiscaleAssistito||"DA COMPLETARE",TELEFONO_ASSISTITO:t.telefono||"DA COMPLETARE",EMAIL_ASSISTITO:t.email,Servizio:s.nomeCompleto,Dispositivo:s.dispositivo,Piano:r.nomeCompleto,TipoPiano:t.tipoServizio,DATA_INIZIO_SERVIZIO:g(u),DATA_SCADENZA:g(p),DATA_CONTRATTO:g(d),IMPORTO_PRIMO_ANNO:l.toFixed(2),IMPORTO_ANNI_SUCCESSIVI:c.toFixed(2)};return is.render(e,m)}static getContractTemplateUnificato(){return`<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contratto TeleMedCare</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
        }
        body {
            font-family: 'Calibri', 'Arial', sans-serif;
            font-size: 11pt;
            line-height: 1.4;
            color: #000;
            max-width: 21cm;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            font-size: 16pt;
            font-weight: bold;
            margin: 20px 0;
            text-transform: uppercase;
        }
        h2 {
            font-size: 12pt;
            font-weight: bold;
            margin: 15px 0 10px 0;
            text-decoration: underline;
        }
        p {
            margin: 8px 0;
            text-align: justify;
        }
        .bold {
            font-weight: bold;
        }
        .italic {
            font-style: italic;
        }
        .center {
            text-align: center;
        }
        .indent {
            margin-left: 30px;
        }
        .company-header {
            margin: 20px 0;
            line-height: 1.6;
        }
        .signature-section {
            margin-top: 40px;
            display: flex;
            justify-content: space-between;
        }
        .signature-box {
            width: 45%;
        }
        .footer {
            margin-top: 30px;
            font-size: 9pt;
            text-align: center;
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }
        ul {
            margin: 10px 0;
            padding-left: 30px;
        }
        li {
            margin: 5px 0;
        }
    </style>
</head>
<body>

<h1>SCRITTURA PRIVATA</h1>
<p>&nbsp;</p>
<p>Con la presente scrittura privata da valere a tutti gli effetti e conseguenze di legge tra:</p>
<p>&nbsp;</p>
<p>Medica GB S.r.l., con sede in Corso Giuseppe Garibaldi, 34 ‚Äì 20121 Milano e con Partita IVA e registro imprese 12435130963, in persona dell'Amministratore Stefania Rocca</p>
<p>&nbsp;</p>
<p class="italic center">(breviter Medica GB)</p>
<p>&nbsp;</p>
<p class="center">e</p>
<p>&nbsp;</p>
<p>Sig./Sig.ra {{NOME_ASSISTITO}} {{COGNOME_ASSISTITO}} nato/a a {{LUOGO_NASCITA}} il {{DATA_NASCITA}}, residente e domiciliato/a in {{INDIRIZZO_ASSISTITO}} - {{CAP_ASSISTITO}} {{CITTA_ASSISTITO}} ({{PROVINCIA_ASSISTITO}}) e con codice fiscale {{CODICE_FISCALE_ASSISTITO}}.</p>
<p>&nbsp;</p>
<p>Riferimenti:</p>
<p>telefono {{TELEFONO_ASSISTITO}} ‚Äì e-mail {{EMAIL_ASSISTITO}}</p>
<p>&nbsp;</p>
<p class="italic center">(breviter Il Cliente)</p>
<p>&nbsp;</p>
<p class="center">premesso che</p>
<p>&nbsp;</p>
<ul>
<li>Medica GB eroga servizi di assistenza domiciliare con tecnologie innovative, servizi di diagnostica a domicilio, esami strumentali, telemedicina, teleassistenza, telemonitoraggio e riabilitazione a domicilio.</li>
<li>Medica GB si avvale della consulenza di Medici, Terapisti, Infermieri e Operatori Socio Sanitari per erogare i servizi sopra descritti;</li>
<li>Tanto premesso,</li>
</ul>
<p>&nbsp;</p>
<p class="center">si conviene e stabilisce quanto segue</p>
<p>&nbsp;</p>
<h2>Premessa</h2>
<p>&nbsp;</p>
<p>La premessa che precede costituisce parte integrante del presente Contratto.</p>
<p>&nbsp;</p>
<h2>Oggetto del Contratto</h2>
<p>L'oggetto del presente Contratto √® l'erogazione del Servizio {{Servizio}} mediante l'utilizzo del Dispositivo {{Dispositivo}} e con il supporto del Piano {{Piano}}.</p>
<p>&nbsp;</p>
<p>Le funzioni del dispositivo {{Dispositivo}} sono le seguenti:</p>
<p>&nbsp;</p>
<p>Comunicazione vocale bidirezionale: √® possibile configurare sulla Piattaforma i contatti dei familiari oltre a quelli della Centrale Operativa ove prevista; dopo l'invio dell'allarme i familiari e/o la Centrale Operativa (piano avanzato) ricevono una chiamata dal dispositivo e possono parlare con l'assistito; in qualsiasi momento i familiari e/o la Centrale Operativa (piano avanzato) possono contattare l'assistito tramite il dispositivo.</p>
<p>&nbsp;</p>
<p>Rilevatore automatico di caduta: effettua una chiamata vocale di allarme, in caso di caduta, ai Care Givers e Famigliari (Piano Base) e alla Centrale Operativa (Piano Avanzato) e invia una notifica tramite sms ai familiari e, nel piano avanzato anche alla Centrale Operativa. Nell'sms arriver√† sia il link da cliccare per individuare la posizione dell'assistito (geolocalizzazione) che i valori dei parametri fisiologici che √® stato possibile rilevare.</p>
<p>&nbsp;</p>
<p>Posizione GPS e GPS-assistito: consente di localizzare l'assistito quando viene inviato l'allarme. √à inoltre possibile impostare una cosiddetta area sicura per l'assistito (geo-fencing).</p>
<p>&nbsp;</p>
<p>Misurazioni della frequenza cardiaca e della saturazione di ossigeno: √® possibile impostare una notifica che arrivi ai familiari e/o Centrale Operativa (ove prevista) tramite APP quando i valori rilevati vanno oltre le soglie programmate (comunicate dal proprio Medico di Base).</p>
<p>&nbsp;</p>
<p>Pulsante SOS: premendo il pulsante SOS per circa 3 secondi √® possibile effettuare una chiamata vocale ai care giver / famigliari (piano base) o alla Centrale Operativa (piano avanzato) e inviare una notifica di emergenza (geolocalizzata) ai familiari o alla Centrale Operativa stessa.</p>
<p>&nbsp;</p>
<p>Assistenza vocale: informa l'assistito in relazione ai seguenti eventi: pressione pulsante SOS, attivazione dispositivo, messa in carica del dispositivo, segnalazione di batteria scarica, ecc.</p>
<p>&nbsp;</p>
<p>Promemoria per l'assunzione dei farmaci: un messaggio ricorda l'orario in cui assumere i farmaci (aderenza terapeutica).</p>
<p>&nbsp;</p>
<h2>Durata del Servizio</h2>
<p>Il Servizio di TeleAssistenza {{Servizio}} ha una durata di 12 mesi a partire da {{DATA_INIZIO_SERVIZIO}} fino al {{DATA_SCADENZA}}.</p>
<p>&nbsp;</p>
<p>Il Contratto sar√† prorogabile su richiesta scritta del Cliente e su accettazione di Medica GB.</p>
<p>&nbsp;</p>
<h2>Tariffa del Servizio</h2>
<p>La tariffa annuale per il primo anno di attivazione del Servizio {{Servizio}} √® pari a Euro {{IMPORTO_PRIMO_ANNO}} + IVA 22% e include:</p>
<p>&nbsp;</p>
<ul>
<li>Dispositivo {{Dispositivo}}</li>
<li>Configurazione del Dispositivo e del Processo di Comunicazione con la Centrale Operativa (ove previsto) e/o uno o pi√π familiari e Piattaforma Web e APP di TeleAssistenza per la durata di 12 mesi</li>
<li>SIM per trasmissione dati e comunicazione vocale per la durata di 12 mesi</li>
<li>Piano {{Piano}}</li>
</ul>
<p>&nbsp;</p>
<p>Per i successivi anni (rinnovabili di anno in anno) la tariffa annuale per il Servizio {{Servizio}} sar√† pari a Euro {{IMPORTO_ANNI_SUCCESSIVI}} + IVA 22% con inclusi:</p>
<p>&nbsp;</p>
<ul>
<li>Piattaforma Web e APP di TeleAssistenza per la durata di 12 mesi</li>
<li>SIM per trasmissione dati e comunicazione vocale per la durata di 12 mesi</li>
<li>Piano {{Piano}}</li>
</ul>
<p>&nbsp;</p>
<h2>Metodo di pagamento</h2>
<p>Medica GB emetter√† fattura anticipata di 12 mesi all'attivazione del Servizio e il Cliente proceder√† al pagamento a ricevimento della fattura stessa tramite bonifico bancario</p>
<p>&nbsp;</p>
<p>Intestato a: Medica GB S.r.l.</p>
<p>&nbsp;</p>
<p>Causale: Servizio {{Servizio}} {{TipoPiano}} con Dispositivo {{Dispositivo}}</p>
<p>&nbsp;</p>
<p>Banca Popolare di Milano - Iban: IT97L0503401727000000003519</p>
<p>&nbsp;</p>
<h2>Riservatezza ed esclusiva</h2>
<p>Il Cliente e Medica GB si impegnano reciprocamente a non divulgare o, comunque, non utilizzare, se non per motivi attinenti all'esercizio del presente contratto, tutte le informazioni di cui venissero a conoscenza nello svolgimento del Servizio.</p>
<p>Il Cliente si impegna a contattare Medica GB per tutte le modifiche e proroghe del presente contratto.</p>
<p>&nbsp;</p>
<h2>Foro competente</h2>
<p>Ogni eventuale contestazione o controversia che dovesse insorgere tra le parti in relazione all'interpretazione, alla validit√† ed esecuzione del presente contratto, sar√† definita alla cognizione esclusiva del Foro di Milano.</p>
<p>&nbsp;</p>
<p>Milano, l√¨ {{DATA_CONTRATTO}}</p>
<p>&nbsp;</p>
<p>Medica GB S.r.l.                                             Il Cliente</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>Medica GB S.r.l.</p>
<p>Corso Giuseppe Garibaldi, 34 ‚Äì 20121 Milano</p>
<p>PEC: medicagbsrl@pecimprese.it</p>
<p>E.mail: info@medicagb.it</p>
<p>Codice Fiscale e P.IVA: 12435130963 - REA: MI-2661409</p>
<p>www.medicagb.it www.ecura.it</p>

</body>
</html>`}static getContractTemplateBase(){try{const t=lm.join(process.cwd(),"templates","contracts","contratto_ecura_base_b2c.html");if(Ac.existsSync(t))return Ac.readFileSync(t,"utf-8");console.warn("‚ö†Ô∏è Template BASE B2C non trovato, uso fallback inline")}catch(t){console.error("‚ùå Errore caricamento template BASE:",t)}return`<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Contratto TeleMedCare Base - {{CODICE_CONTRATTO}}</title>
  <style>
    @page { size: A4; margin: 2cm; }
    body {
      font-family: 'Arial', sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      text-align: center;
      border-bottom: 3px solid #0b63a5;
      padding-bottom: 20px;
      margin-bottom: 30px;
    }
    .header h1 {
      color: #0b63a5;
      margin: 0;
      font-size: 24px;
    }
    .contract-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    }
    .section {
      margin: 25px 0;
    }
    .section h2 {
      color: #0b63a5;
      font-size: 18px;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 10px;
    }
    .price-box {
      background: #e7f3ff;
      border: 2px solid #0b63a5;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
    }
    .price-box h3 {
      margin: 0 0 10px 0;
      color: #0b63a5;
    }
    .price-box .amount {
      font-size: 32px;
      font-weight: bold;
      color: #0b63a5;
    }
    .signature-section {
      margin-top: 50px;
      padding-top: 30px;
      border-top: 2px solid #dee2e6;
    }
    .signature-box {
      display: inline-block;
      width: 45%;
      text-align: center;
      padding: 20px;
      margin: 10px 2%;
    }
    .signature-line {
      border-top: 2px solid #000;
      margin-top: 60px;
      padding-top: 10px;
    }
    .footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #dee2e6;
      font-size: 12px;
      color: #6c757d;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìã CONTRATTO DI SERVIZIO TELEMEDCARE BASE</h1>
    <p><strong>Codice Contratto:</strong> {{CODICE_CONTRATTO}}</p>
    <p><strong>Data:</strong> {{DATA_CONTRATTO}}</p>
  </div>

  <div class="contract-info">
    <h3>PARTI CONTRAENTI</h3>
    <p><strong>IL FORNITORE:</strong> {{AZIENDA_RAGIONE_SOCIALE}} - {{AZIENDA_INDIRIZZO}} - P.IVA {{AZIENDA_PARTITA_IVA}}</p>
    <p><strong>IL CLIENTE:</strong> {{NOME_RICHIEDENTE}} {{COGNOME_RICHIEDENTE}}</p>
    <p><strong>Email:</strong> {{EMAIL}} | <strong>Telefono:</strong> {{TELEFONO}}</p>
    <p><strong>Assistito:</strong> {{NOME_ASSISTITO}} {{COGNOME_ASSISTITO}} ({{ETA_ASSISTITO}} anni)</p>
  </div>

  <div class="section">
    <h2>ART. 1 - OGGETTO DEL CONTRATTO</h2>
    <p>Il presente contratto ha per oggetto la fornitura del servizio <strong>{{TIPO_SERVIZIO}}</strong>, 
    che include:</p>
    <ul>
      <li>Dispositivo medico SiDLY Care Pro V12.0 in comodato d'uso</li>
      <li>Servizio di telemonitoraggio parametri vitali</li>
      <li>Supporto tecnico telefonico (ore ufficio)</li>
      <li>Manutenzione ordinaria e straordinaria del dispositivo</li>
      <li>Aggiornamenti software inclusi</li>
    </ul>
  </div>

  <div class="section">
    <h2>ART. 2 - DURATA E CORRISPETTIVO</h2>
    <div class="price-box">
      <h3>Piano Tariffario</h3>
      <p>Canone Mensile: <span style="font-size: 20px; font-weight: bold;">{{PREZZO_MENSILE}}</span></p>
      <p>Durata Contratto: <strong>{{DURATA_MESI}} mesi</strong></p>
      <hr style="margin: 15px 0; border: 1px solid #0b63a5;">
      <p>Importo Totale:</p>
      <div class="amount">{{PREZZO_TOTALE}}</div>
      <p style="font-size: 12px; margin-top: 10px;">IVA inclusa se dovuta</p>
    </div>
    <p>Il pagamento dovr√† essere effettuato anticipatamente tramite bonifico bancario o carta di credito.</p>
  </div>

  <div class="section">
    <h2>ART. 3 - OBBLIGHI DEL FORNITORE</h2>
    <p>{{AZIENDA_RAGIONE_SOCIALE}} si impegna a:</p>
    <ul>
      <li>Fornire il dispositivo medico entro 10 giorni lavorativi dalla conferma del pagamento</li>
      <li>Garantire il corretto funzionamento del servizio di telemonitoraggio</li>
      <li>Fornire supporto tecnico durante l'orario lavorativo (9:00-18:00, Lun-Ven)</li>
      <li>Sostituire il dispositivo in caso di malfunzionamento senza costi aggiuntivi</li>
    </ul>
  </div>

  <div class="section">
    <h2>ART. 4 - OBBLIGHI DEL CLIENTE</h2>
    <p>Il Cliente si impegna a:</p>
    <ul>
      <li>Utilizzare il dispositivo secondo le istruzioni fornite</li>
      <li>Custodire con diligenza il dispositivo ricevuto in comodato d'uso</li>
      <li>Comunicare tempestivamente eventuali malfunzionamenti</li>
      <li>Restituire il dispositivo al termine del contratto o in caso di risoluzione anticipata</li>
      <li>Effettuare i pagamenti alle scadenze concordate</li>
    </ul>
  </div>

  <div class="section">
    <h2>ART. 5 - RECESSO</h2>
    <p>Il Cliente ha diritto di recedere dal contratto entro 14 giorni dalla ricezione del dispositivo, 
    senza dover fornire motivazioni. Il recesso deve essere comunicato via email certificata.</p>
    <p>In caso di recesso anticipato dopo i 14 giorni, il Cliente √® tenuto a corrispondere 
    i canoni maturati fino alla data di restituzione del dispositivo.</p>
  </div>

  <div class="section">
    <h2>ART. 6 - PRIVACY E TRATTAMENTO DATI</h2>
    <p>Il trattamento dei dati personali e sanitari avviene in conformit√† al GDPR (Regolamento UE 2016/679). 
    I dati raccolti saranno utilizzati esclusivamente per l'erogazione del servizio e non saranno 
    ceduti a terzi senza consenso esplicito.</p>
  </div>

  <div class="signature-section">
    <h2 style="text-align: center;">SOTTOSCRIZIONE DEL CONTRATTO</h2>
    <p style="text-align: center;">Le parti, letto e compreso il presente contratto, 
    lo sottoscrivono per accettazione.</p>
    
    <div class="signature-box">
      <p><strong>IL FORNITORE</strong></p>
      <p>{{AZIENDA_RAGIONE_SOCIALE}}</p>
      <div class="signature-line">
        Firma Legale Rappresentante
      </div>
    </div>
    
    <div class="signature-box">
      <p><strong>IL CLIENTE</strong></p>
      <p>{{NOME_RICHIEDENTE}} {{COGNOME_RICHIEDENTE}}</p>
      <div class="signature-line">
        Firma per Accettazione
      </div>
    </div>
  </div>

  <div class="footer">
    <p>Contratto TeleMedCare Base - Codice: {{CODICE_CONTRATTO}}</p>
    <p>Medica GB S.r.l. - P.IVA 12345678901 - www.telemedcare.it - info@telemedcare.it</p>
    <p>Documento generato elettronicamente - {{ANNO}}</p>
  </div>
</body>
</html>`}static getContractTemplateAvanzato(){try{const e=lm.join(process.cwd(),"templates","contracts","contratto_ecura_avanzato_b2c.html");if(Ac.existsSync(e))return Ac.readFileSync(e,"utf-8");console.warn("‚ö†Ô∏è Template AVANZATO B2C non trovato, uso fallback inline")}catch(e){console.error("‚ùå Errore caricamento template AVANZATO:",e)}return this.getContractTemplateBase().replace("TELEMEDCARE BASE","TELEMEDCARE AVANZATO").replace("<li>Supporto tecnico telefonico (ore ufficio)</li>",`<li>Supporto tecnico H24/7 con priorit√† alta</li>
         <li>Consulenza specialistica mensile inclusa</li>
         <li>Centrale operativa di monitoraggio attiva H24</li>
         <li>Report mensili personalizzati</li>`)}static generateContractCode(){const t=new Date().getFullYear(),e=String(new Date().getMonth()+1).padStart(2,"0"),a=Math.random().toString(36).substring(2,8).toUpperCase();return`TMC-${t}${e}-${a}`}static async generatePDFFromDOCX(t){const e=bp(t.servizio||"PRO"),a=yp(t.tipoServizio),i=new Date,s=new Date(i),r=new Date(i);r.setMonth(r.getMonth()+(t.durataContratto||12));const l=d=>{const u=String(d.getDate()).padStart(2,"0"),p=String(d.getMonth()+1).padStart(2,"0"),g=d.getFullYear();return`${u}/${p}/${g}`},c={NOME_ASSISTITO:t.nomeAssistito||t.nomeRichiedente,COGNOME_ASSISTITO:t.cognomeAssistito||t.cognomeRichiedente,LUOGO_NASCITA:t.luogoNascita||"DA COMPLETARE",DATA_NASCITA:t.dataNascita||"DA COMPLETARE",INDIRIZZO_ASSISTITO:t.indirizzoAssistito||"DA COMPLETARE",CAP_ASSISTITO:t.capAssistito||"DA COMPLETARE",CITTA_ASSISTITO:t.cittaAssistito||"DA COMPLETARE",PROVINCIA_ASSISTITO:t.provinciaAssistito||"DA COMPLETARE",CODICE_FISCALE_ASSISTITO:t.codiceFiscaleAssistito||"DA COMPLETARE",TELEFONO_ASSISTITO:t.telefono||"DA COMPLETARE",EMAIL_ASSISTITO:t.email,Servizio:e.nomeCompleto,Dispositivo:e.dispositivo,Piano:a.nomeCompleto,DATA_INIZIO_SERVIZIO:l(s),DATA_SCADENZA:l(r),DATA_CONTRATTO:l(i),IMPORTO_PRIMO_ANNO:t.prezzoTotale.toFixed(2),IMPORTO_ANNI_SUCCESSIVI:(t.prezzoMensile*12).toFixed(2)};return console.log("üìÑ [CONTRACT] Generazione DOCX da template..."),console.log("   Servizio:",c.Servizio),console.log("   Dispositivo:",c.Dispositivo),console.log("   Piano:",c.Piano.substring(0,50)+"..."),this.generateSimplePDF(t,c)}static generateSimplePDF(t,e){console.log("üìÑ [CONTRACT] Generazione PDF semplice (fallback)...");const a=`
CONTRATTO TELEMEDCARE

Codice Contratto: ${t.codiceContratto}
Data: ${t.dataContratto}

CLIENTE:
${e.NOME_ASSISTITO} ${e.COGNOME_ASSISTITO}
Email: ${e.EMAIL_ASSISTITO}
Telefono: ${e.TELEFONO_ASSISTITO}

SERVIZIO:
${e.Servizio}
Dispositivo: ${e.Dispositivo}
Piano: ${e.Piano}

CONDIZIONI ECONOMICHE:
Primo anno: ‚Ç¨${e.IMPORTO_PRIMO_ANNO}
Anni successivi: ‚Ç¨${e.IMPORTO_ANNI_SUCCESSIVI}
Durata: ${t.durataContratto} mesi
Da: ${e.DATA_INIZIO_SERVIZIO}
A: ${e.DATA_SCADENZA}

Il presente contratto √® stato generato automaticamente.

----
Medica GB S.r.l.
www.ecura.it
`,i=`%PDF-1.4
`,s=`1 0 obj
<< /Type /Catalog /Pages 2 0 R >>
endobj
2 0 obj
<< /Type /Pages /Kids [3 0 R] /Count 1 >>
endobj
3 0 obj
<< /Type /Page /Parent 2 0 R /Resources << /Font << /F1 << /Type /Font /Subtype /Type1 /BaseFont /Courier >> >> >> /MediaBox [0 0 612 792] /Contents 4 0 R >>
endobj
4 0 obj
<< /Length ${a.length+50} >>
stream
BT
/F1 10 Tf
50 750 Td
`,r=a.split(`
`).map((d,u)=>`(${d.replace(/[()\\]/g,"\\$&")}) Tj
0 -12 Td
`).join(""),l=`ET
endstream
endobj
xref
0 5
0000000000 65535 f
0000000009 00000 n
0000000058 00000 n
0000000115 00000 n
0000000300 00000 n
trailer
<< /Size 5 /Root 1 0 R >>
startxref
${(i+s+r+l).length-50}
%%EOF
`,c=i+s+r+`ET
endstream
endobj
xref
0 5
0000000000 65535 f
0000000009 00000 n
0000000058 00000 n
0000000115 00000 n
0000000300 00000 n
trailer
<< /Size 5 /Root 1 0 R >>
startxref
500
%%EOF
`;return new Uint8Array(Buffer.from(c,"utf-8"))}static async sendContractEmail(t,e,a){try{const i=await e.prepare(`
        SELECT c.*, l.email, l.nomeRichiedente, l.tipoServizio
        FROM contracts c
        JOIN leads l ON c.leadId = l.id
        WHERE c.id = ?
      `).bind(t).first();if(!i)throw new Error("Contratto non trovato");console.log("üìß [CONTRACT] Invio contratto via email:",i.email);const r=(await Promise.resolve().then(()=>Dt)).default.getInstance(),l={NOME_CLIENTE:i.nomeRichiedente||"Cliente",PIANO_SERVIZIO:i.tipoServizio==="AVANZATO"?"TeleMedCare Avanzato":"TeleMedCare Base",PREZZO_PIANO:`‚Ç¨${i.prezzo_totale||0}`,CODICE_CLIENTE:i.leadId,LINK_FIRMA:`https://app.telemedcare.it/firma/${t}`},c=await r.sendTemplateEmail("INVIO_CONTRATTO",i.email,l,void 0,a);return c.success&&(await e.prepare(`
          UPDATE contracts 
          SET status = 'SENT', data_invio = datetime('now'), updated_at = datetime('now')
          WHERE id = ?
        `).bind(t).run(),await e.prepare(`
          UPDATE leads 
          SET status = 'contract_sent', updated_at = datetime('now')
          WHERE id = ?
        `).bind(i.leadId).run(),console.log("‚úÖ [CONTRACT] Email contratto inviata")),c}catch(i){return console.error("‚ùå [CONTRACT] Errore invio email:",i),{success:!1,error:i instanceof Error?i.message:"Errore invio"}}}static generatePDFFromHTML(t,e){const a=this.generatePDFTextContent(e),i=`%PDF-1.4
1 0 obj
<<
/Type /Catalog
/Pages 2 0 R
>>
endobj
2 0 obj
<<
/Type /Pages
/Kids [3 0 R]
/Count 1
>>
endobj
3 0 obj
<<
/Type /Page
/Parent 2 0 R
/Resources <<
/Font <<
/F1 <<
/Type /Font
/Subtype /Type1
/BaseFont /Helvetica
>>
/F2 <<
/Type /Font
/Subtype /Type1
/BaseFont /Helvetica-Bold
>>
>>
>>
/MediaBox [0 0 612 792]
/Contents 4 0 R
>>
endobj
4 0 obj
<<
/Length ${a.length}
>>
stream
${a}
endstream
endobj
xref
0 5
0000000000 65535 f 
0000000009 00000 n 
0000000058 00000 n 
0000000115 00000 n 
0000000320 00000 n 
trailer
<<
/Size 5
/Root 1 0 R
>>
startxref
${420+a.length}
%%EOF`;return new TextEncoder().encode(i)}static generatePDFTextContent(t){const e=t.servizio==="FAMILY"?"Senium":t.servizio==="PREMIUM"?"SiDLY Vital Care":"SiDLY Care PRO";return`BT
/F2 20 Tf
50 750 Td
(CONTRATTO DI SERVIZIO eCura) Tj
0 -25 Td
/F2 16 Tf
(${t.servizio||"PRO"} - Piano ${t.tipoServizio}) Tj
0 -40 Td
/F1 11 Tf
(Codice Contratto: ${t.codiceContratto||"N/A"}) Tj
0 -18 Td
(Data: ${t.dataContratto||new Date().toLocaleDateString("it-IT")}) Tj
0 -40 Td
/F2 14 Tf
(DATI CLIENTE) Tj
0 -25 Td
/F1 11 Tf
(Nome Completo: ${t.nomeRichiedente} ${t.cognomeRichiedente}) Tj
0 -18 Td
(Email: ${t.email}) Tj
0 -18 Td
(Telefono: ${t.telefono}) Tj
0 -18 Td
(Assistito: ${t.nomeAssistito||t.nomeRichiedente} ${t.cognomeAssistito||t.cognomeRichiedente}) Tj
0 -18 Td
(Eta Assistito: ${t.etaAssistito||"Non specificata"} anni) Tj
0 -40 Td
/F2 14 Tf
(SERVIZIO E DISPOSITIVO) Tj
0 -25 Td
/F1 11 Tf
(Servizio: eCura ${t.servizio||"PRO"}) Tj
0 -18 Td
(Piano: ${t.tipoServizio}) Tj
0 -18 Td
(Dispositivo: ${e}) Tj
0 -18 Td
(Durata Contratto: ${t.durataContratto} mesi) Tj
0 -40 Td
/F2 14 Tf
(CONDIZIONI ECONOMICHE) Tj
0 -25 Td
/F1 11 Tf
(Canone Mensile: EUR ${t.prezzoMensile.toFixed(2)}) Tj
0 -18 Td
(Totale Contratto \\(${t.durataContratto} mesi\\): EUR ${t.prezzoTotale.toFixed(2)}) Tj
0 -18 Td
(IVA Inclusa: 22%) Tj
0 -40 Td
/F2 14 Tf
(TERMINI E CONDIZIONI) Tj
0 -25 Td
/F1 10 Tf
(1. OGGETTO: Fornitura dispositivo ${e} per il monitoraggio) Tj
0 -15 Td
(   remoto della salute e assistenza 24/7.) Tj
0 -20 Td
(2. CONSEGNA: Dispositivo consegnato entro 7 giorni lavorativi) Tj
0 -15 Td
(   all'indirizzo indicato dal cliente.) Tj
0 -20 Td
(3. ATTIVAZIONE: Servizio attivo entro 24 ore dalla consegna) Tj
0 -15 Td
(   con assistenza tecnica per la configurazione.) Tj
0 -20 Td
(4. ASSISTENZA: Supporto tecnico e sanitario disponibile 24/7) Tj
0 -15 Td
(   tramite numero verde dedicato.) Tj
0 -20 Td
(5. GARANZIA: Dispositivo coperto da garanzia 24 mesi del) Tj
0 -15 Td
(   produttore con sostituzione gratuita in caso di guasto.) Tj
0 -20 Td
(6. RECESSO: Diritto di recesso entro 14 giorni dalla consegna) Tj
0 -15 Td
(   con restituzione dispositivo nelle condizioni originali.) Tj
0 -20 Td
(7. PRIVACY: Trattamento dati secondo GDPR \\(UE 2016/679\\).) Tj
0 -15 Td
(   Informativa completa su www.telemedcare.it/privacy) Tj
0 -40 Td
/F2 12 Tf
(MODALITA DI FIRMA) Tj
0 -25 Td
/F1 10 Tf
(Il presente contratto sara firmato digitalmente tramite DocuSign.) Tj
0 -15 Td
(Ricevera un'email con il link per la firma elettronica.) Tj
0 -30 Td
/F1 9 Tf
(Documento generato automaticamente da eCura - TeleMedCare V12.0) Tj
0 -15 Td
(Per informazioni: info@telemedcare.it | Tel: 800 123 456) Tj
0 -15 Td
(www.telemedcare.it) Tj
ET`}static generateStandalonePDF(t){const e=this.generatePDFTextContent(t),a=`%PDF-1.4
1 0 obj
<<
/Type /Catalog
/Pages 2 0 R
>>
endobj
2 0 obj
<<
/Type /Pages
/Kids [3 0 R]
/Count 1
>>
endobj
3 0 obj
<<
/Type /Page
/Parent 2 0 R
/Resources <<
/Font <<
/F1 <<
/Type /Font
/Subtype /Type1
/BaseFont /Helvetica
>>
>>
>>
/MediaBox [0 0 612 792]
/Contents 4 0 R
>>
endobj
4 0 obj
<<
/Length ${e.length}
>>
stream
${e}
endstream
endobj
xref
0 5
0000000000 65535 f 
0000000009 00000 n 
0000000058 00000 n 
0000000115 00000 n 
0000000274 00000 n 
trailer
<<
/Size 5
/Root 1 0 R
>>
startxref
${370+e.length}
%%EOF`;return new TextEncoder().encode(a)}}async function ew(o,t,e){const a={success:!1,step:"generate_and_send_contract",emailsSent:[],errors:[],messageIds:[]};try{console.log(`üìÑ [CONTRACT_WORKFLOW] Generazione contratto per lead: ${o.id}`),console.log(`üìÑ [CONTRACT_WORKFLOW] Servizio: ${o.servizio||"PRO"}, Piano: ${o.pacchetto}`);const i=o.servizio||"PRO",s=o.pacchetto,r=vc(i,s);if(!r)return a.errors.push(`Pricing non trovato per ${i} ${s}`),console.error("‚ùå [CONTRACT_WORKFLOW] Pricing non trovato"),a;console.log(`üí∞ [CONTRACT_WORKFLOW] Pricing: ${r.setupTotale}‚Ç¨ (1¬∞ anno), Dispositivo: ${r.dispositivo}`);const l={leadId:o.id,nomeRichiedente:o.nomeRichiedente,cognomeRichiedente:o.cognomeRichiedente,email:o.emailRichiedente,telefono:o.telefonoRichiedente||"",tipoServizio:s,servizio:i,nomeAssistito:o.nomeAssistito,cognomeAssistito:o.cognomeAssistito,etaAssistito:o.etaAssistito,luogoNascita:o.luogoNascitaAssistito||o.luogoNascita,dataNascita:o.dataNascitaAssistito||o.dataNascita,indirizzoAssistito:o.indirizzoAssistito,capAssistito:o.capAssistito,cittaAssistito:o.cittaAssistito,provinciaAssistito:o.provinciaAssistito,codiceFiscaleAssistito:o.cfAssistito||o.codiceFiscaleAssistito,prezzoMensile:r.setupBase/12,durataContratto:12,prezzoTotale:r.setupTotale};console.log("üìÑ [CONTRACT_WORKFLOW] Generazione PDF contratto...");const c=await Qy.generateContract(l,e,t.BROWSER);if(!c.success||!c.contract)return a.errors.push(`Errore generazione contratto: ${c.error}`),console.error("‚ùå [CONTRACT_WORKFLOW] Errore generazione contratto:",c.error),a;const d=c.contract;console.log(`‚úÖ [CONTRACT_WORKFLOW] Contratto generato: ${d.codiceContratto}`);const u=t.PUBLIC_URL||(typeof window<"u"?window.location.origin:"http://localhost:3000"),p=[];if(d.pdfBase64&&(p.push({filename:`Contratto_TeleMedCare_${d.codiceContratto}.pdf`,content:d.pdfBase64,contentType:"application/pdf"}),console.log("‚úÖ [CONTRACT_WORKFLOW] Contratto PDF aggiunto agli allegati")),o.vuoleBrochure){const T=o.servizio||"DEFAULT";console.log(`üì• [CONTRACT_WORKFLOW] Caricamento brochure per servizio: ${T}`);let R=null;if(T!=="DEFAULT"&&(T==="FAMILY"||T==="PRO"||T==="PREMIUM")&&(R=await kg(T,u)),!R){console.log("üìÑ [CONTRACT_WORKFLOW] Caricamento brochure generica TeleMedCare");try{const S=`${u}/brochures/Brochure_eCura.pdf`,C=await fetch(S);if(C.ok){const M=await C.arrayBuffer(),B=new Uint8Array(M);let j="";const N=8192;for(let Y=0;Y<B.length;Y+=N){const $=B.subarray(Y,Math.min(Y+N,B.length));j+=String.fromCharCode.apply(null,Array.from($))}R={filename:"Brochure_eCura.pdf",content:btoa(j),size:M.byteLength}}}catch(S){console.error("‚ùå [CONTRACT_WORKFLOW] Errore caricamento brochure:",S)}}R&&(p.push({filename:R.filename,content:R.content,contentType:"application/pdf"}),console.log(`‚úÖ [CONTRACT_WORKFLOW] Brochure aggiunta: ${R.filename}`))}console.log(`üìß [CONTRACT_WORKFLOW] Invio email contratto a ${o.emailRichiedente}`);const g=new Ke(t),m=await Ao("email_invio_contratto",e),v={NOME_CLIENTE:o.nomeRichiedente,COGNOME_CLIENTE:o.cognomeRichiedente,PIANO_SERVIZIO:Yt(i,s),PREZZO_PIANO:`‚Ç¨${r.setupTotale.toFixed(2)}`,CODICE_CLIENTE:o.id,CODICE_CONTRATTO:d.codiceContratto,LINK_FIRMA:`${u}/firma-contratto?contractId=${d.contractId}`,DATA_INVIO:new Date().toLocaleDateString("it-IT"),DISPOSITIVO:r.dispositivo,SERVIZIO:i},b=Co(m,v);console.log(`üìß [CONTRACT_WORKFLOW] Allegati preparati: ${p.length}`);for(const T of p)console.log(`  üìé ${T.filename} (${(T.content.length*.75/1024).toFixed(2)} KB)`);const E=await g.sendEmail({to:o.emailRichiedente,from:"info@telemedcare.it",subject:`üìÑ eCura - Il Tuo Contratto ${Yt(i,s)}`,html:b,attachments:p});E.success?(a.success=!0,a.emailsSent.push(`email_invio_contratto -> ${o.emailRichiedente}`),a.messageIds=[E.messageId],await e.prepare(`
        UPDATE leads 
        SET status = 'CONTRACT_SENT', updated_at = datetime('now')
        WHERE id = ?
      `).bind(o.id).run(),await e.prepare(`
        UPDATE contracts 
        SET status = 'SENT', data_invio = datetime('now'), updated_at = datetime('now')
        WHERE id = ?
      `).bind(d.contractId).run(),console.log(`‚úÖ [CONTRACT_WORKFLOW] Email contratto inviata con successo: ${E.messageId}`)):(a.errors.push(`Errore invio email: ${E.error}`),console.error("‚ùå [CONTRACT_WORKFLOW] Errore invio email:",E.error))}catch(i){a.errors.push(`Eccezione workflow contratto: ${i instanceof Error?i.message:"Errore sconosciuto"}`),console.error("‚ùå [CONTRACT_WORKFLOW] Eccezione:",i)}return a}async function tw(o){try{const t=await o.prepare(`
      SELECT * FROM settings WHERE key = 'workflow_emails'
    `).first();if(t!=null&&t.value)return JSON.parse(t.value)}catch(t){console.error("‚ö†Ô∏è [ORCHESTRATOR] Errore lettura settings:",t)}return{email_notifica_info:!0,email_completamento_dati:!0,email_reminder_firma:!0,email_promemoria_pagamento:!0}}async function ow(o){var e,a;const t={success:!1,step:"process_new_lead",message:"",errors:[]};try{console.log(`üöÄ [ORCHESTRATOR] STEP 1: Processamento nuovo lead ${o.leadData.id}`);const i=await tw(o.db);if(console.log("‚öôÔ∏è [ORCHESTRATOR] Settings workflow:",i),i.email_notifica_info){console.log("üìß [ORCHESTRATOR] Invio notifica a info@telemedcare.it");const s=await _r.inviaEmailNotificaInfo(o.leadData,o.env,o.db);s.success||t.errors.push(...s.errors)}else console.log("‚è≠Ô∏è [ORCHESTRATOR] Email notifica info@ disabilitata (switch OFF)");if(i.email_completamento_dati){console.log(`üìß [ORCHESTRATOR] Invio email completamento dati a ${o.leadData.emailRichiedente}`);try{const{createCompletionToken:s,getMissingFields:r,getSystemConfig:l}=await Promise.resolve().then(()=>Mt),c=(await Promise.resolve().then(()=>Dt)).default,{loadEmailTemplate:d,renderTemplate:u}=await Promise.resolve().then(()=>Ec),p=await l(o.db),g=await s(o.db,o.leadData.id,p.auto_completion_token_days),v=`${((e=o.env)==null?void 0:e.PUBLIC_URL)||((a=o.env)==null?void 0:a.PAGES_URL)||"https://telemedcare-v12.pages.dev"}/completa-dati?token=${g.token}`,{missing:b,available:E}=r(o.leadData),T=new c(o.env),R=await d("email_richiesta_completamento_form",o.db,o.env),S={NOME_CLIENTE:o.leadData.nomeRichiedente||"Cliente",COGNOME_CLIENTE:o.leadData.cognomeRichiedente||"",LEAD_ID:o.leadData.id,SERVIZIO:o.leadData.pacchetto||"eCura",COMPLETION_LINK:v,TOKEN_EXPIRY:new Date(g.expires_at).toLocaleDateString("it-IT"),MISSING_FIELDS_COUNT:b.length},C=u(R,S),M=await T.sendEmail({to:o.leadData.emailRichiedente,subject:"eCura - Completa la tua richiesta",html:C});M.success?(console.log(`‚úÖ [ORCHESTRATOR] Email completamento dati inviata a ${o.leadData.emailRichiedente}`),console.log(`   Link form: ${v}`)):(console.error("‚ùå [ORCHESTRATOR] Errore invio email completamento:",M.error),t.errors.push(`Errore email completamento: ${M.error}`))}catch(s){console.error("‚ùå [ORCHESTRATOR] Errore invio email completamento:",s),t.errors.push(`Errore email completamento: ${s.message}`)}}else console.log("‚è≠Ô∏è [ORCHESTRATOR] Email completamento dati disabilitata (switch OFF)");if(!o.leadData.vuoleContratto&&(o.leadData.vuoleBrochure||o.leadData.vuoleManuale)){console.log("üìö [ORCHESTRATOR] Lead richiede solo documenti informativi");const s=await rw(o.leadData),r=await _r.inviaEmailDocumentiInformativi(o.leadData,o.env,s,o.db);r.success?(t.success=!0,t.message="Lead processato: documenti informativi inviati",t.data={emailsSent:r.emailsSent}):(t.errors.push(...r.errors),t.message="Errore invio documenti")}else if(o.leadData.vuoleContratto){console.log(`üìÑ [ORCHESTRATOR] Lead richiede contratto ${o.leadData.pacchetto}`);const s=await ew(o.leadData,o.env,o.db);s.success?(t.success=!0,t.message="Lead processato: contratto generato e inviato",t.data={emailsSent:s.emailsSent,messageIds:s.messageIds}):(t.errors.push(...s.errors),t.message="Errore generazione/invio contratto")}else t.message="Nessuna richiesta specifica (n√© documenti n√© contratto)",t.success=!0;await Zd(o.db,o.leadData.id,o.leadData.vuoleContratto?"CONTRACT_SENT":"DOCUMENTS_SENT"),console.log(`‚úÖ [ORCHESTRATOR] STEP 1 completato: ${t.message}`)}catch(i){console.error("‚ùå [ORCHESTRATOR] Errore STEP 1:",i),t.message=`Errore processamento lead: ${i.message}`,t.errors.push(i.message)}return t}async function aw(o){const t={success:!1,step:"process_payment",message:"",errors:[]};try{console.log(`üí≥ [ORCHESTRATOR] STEP 3: Processamento pagamento per proforma ${o.proformaId}`),console.log("üí≥ [ORCHESTRATOR DEBUG] ctx.paymentData:",JSON.stringify(o.paymentData));const e=o.paymentData.amount||o.paymentData.importo,a=o.paymentData.paymentMethod||o.paymentData.metodo||"BONIFICO";if(!e)return t.errors.push("Importo pagamento non specificato"),t.message="Dati pagamento incompleti",t;if(!o.contractId)return t.errors.push("Contract ID mancante"),t.message="Dati contratto incompleti",t;const i={proformaId:o.proformaId,contractId:o.contractId,leadId:o.leadData.id,importo:e,metodoPagamento:a,transactionId:o.paymentData.transactionId,riferimentoBonifico:o.paymentData.riferimento,ibanMittente:o.paymentData.iban,stripePaymentIntentId:o.paymentData.stripePaymentIntentId};console.log("üí≥ [ORCHESTRATOR] Registering payment with params:",JSON.stringify({proformaId:i.proformaId,contractId:i.contractId,leadId:i.leadId,importo:i.importo,metodoPagamento:i.metodoPagamento}));const s=await gm.registerPayment(o.db,i);if(!s.success)return t.errors.push(s.error),t.message="Errore registrazione pagamento",s.debug&&(t.debug=s.debug),t;if(o.paymentData.autoConfirm){const c=await gm.confirmPayment(o.db,s.paymentId);if(!c.success)return t.errors.push(c.error),t.message="Errore conferma pagamento",t}const r=await nw(o.db,o.leadData.id),l=await _r.inviaEmailBenvenuto({...o.leadData,codiceCliente:r},o.env,o.db);l.success?(t.success=!0,t.message="Pagamento registrato e email benvenuto inviata",t.data={paymentId:s.paymentId,codiceCliente:r,emailsSent:l.emailsSent}):(t.errors.push(...l.errors),t.message="Errore invio email benvenuto"),await Zd(o.db,o.leadData.id,"PAYMENT_RECEIVED"),console.log(`‚úÖ [ORCHESTRATOR] STEP 3 completato: ${t.message}`)}catch(e){console.error("‚ùå [ORCHESTRATOR] Errore STEP 3:",e),t.message=`Errore processamento pagamento: ${e.message}`,t.errors.push(e.message)}return t}async function iw(o){const t={success:!1,step:"process_configuration",message:"",errors:[]};try{console.log(`üìã [ORCHESTRATOR] STEP 4: Processamento configurazione cliente ${o.leadData.id}`);const e=await Cv.saveConfiguration(o.db,o.configData);if(!e.success)return t.errors.push(e.error),t.message="Errore salvataggio configurazione",t;const a=await _r.inviaEmailConfigurazione(o.leadData,o.configData,o.env,o.db);a.success?(t.success=!0,t.message="Configurazione salvata e inviata a info@",t.data={configurationId:e.configurationId,emailsSent:a.emailsSent}):(t.errors.push(...a.errors),t.message="Errore invio email configurazione"),await Zd(o.db,o.leadData.id,"CONFIGURED"),console.log(`‚úÖ [ORCHESTRATOR] STEP 4 completato: ${t.message}`)}catch(e){console.error("‚ùå [ORCHESTRATOR] Errore STEP 4:",e),t.message=`Errore processamento configurazione: ${e.message}`,t.errors.push(e.message)}return t}async function sw(o){const t={success:!1,step:"process_device_association",message:"",errors:[]};try{console.log(`üîß [ORCHESTRATOR] STEP 5: Associazione dispositivo per cliente ${o.leadData.id}`);const e=await lw(o.db,{leadId:o.leadData.id,imei:o.deviceData.imei,modello:o.deviceData.modello});if(!e.success)return t.errors.push(e.error),t.message="Errore associazione dispositivo",t;const a=await _r.inviaEmailConfermaAttivazione(o.leadData,{imei:o.deviceData.imei,modello:o.deviceData.modello,dataAssociazione:new Date().toISOString()},o.env,o.db);a.success?(t.success=!0,t.message="Dispositivo associato e email conferma inviata",t.data={deviceId:e.deviceId,emailsSent:a.emailsSent}):(t.errors.push(...a.errors),t.message="Errore invio email conferma"),await Zd(o.db,o.leadData.id,"CONVERTED"),console.log(`‚úÖ [ORCHESTRATOR] STEP 5 completato: ${t.message}`),console.log(`üéâ [ORCHESTRATOR] Workflow completo per lead ${o.leadData.id}!`)}catch(e){console.error("‚ùå [ORCHESTRATOR] Errore STEP 5:",e),t.message=`Errore associazione dispositivo: ${e.message}`,t.errors.push(e.message)}return t}async function rw(o){const t={};return o.vuoleBrochure&&(t.brochure="/public/brochures/Brochure_eCura.pdf"),o.vuoleManuale&&(t.manuale="/public/documents/Manuale_SiDLY.pdf"),t}async function nw(o,t){const e=Date.now(),a=Math.floor(Math.random()*1e3).toString().padStart(3,"0");return`CLI-${e}-${a}`}async function Zd(o,t,e){try{await o.prepare(`
      UPDATE leads 
      SET status = ?, updated_at = datetime('now')
      WHERE id = ?
    `).bind(e,t).run(),console.log(`‚úÖ [HELPER] Lead ${t} status aggiornato a ${e}`)}catch(a){console.error("‚ùå [HELPER] Errore aggiornamento status lead:",a)}}async function lw(o,t){return console.log(`üîß [HELPER] Associazione dispositivo ${t.imei} a lead ${t.leadId}`),{success:!0,deviceId:`DEV${Date.now()}`}}const Fp=`
<script>
(function() {
  // Configurazione auto-import
  const AUTO_IMPORT_CONFIG = {
    enabled: true,
    silent: true, // Non mostrare notifiche se non ci sono nuovi lead
    showSuccessToast: true, // Mostra toast solo se importati nuovi lead
    minIntervalMinutes: 0 // ‚úÖ SEMPRE ESEGUI (rimosso interval)
  };
  
  // Verifica parametro URL per forzare import
  const urlParams = new URLSearchParams(window.location.search);
  const forceImport = urlParams.get('forceImport') === 'true';
  
  // Verifica se auto-import √® necessario
  async function shouldRunAutoImport() {
    // ‚úÖ SEMPRE TRUE - Esegui ad ogni refresh
    return true;
  }
  
  // Esegui auto-import incrementale
  async function executeAutoImport() {
    try {
      if (!AUTO_IMPORT_CONFIG.enabled) {
        console.log('üî¥ [AUTO-IMPORT] Disabilitato');
        return;
      }
      
      if (!(await shouldRunAutoImport())) {
        console.log('‚è≠Ô∏è  [AUTO-IMPORT] Troppo recente, skip');
        return;
      }
      
      console.log('üîÑ [AUTO-IMPORT] Inizio import incrementale silenzioso...');
      
      const response = await fetch('/api/hubspot/auto-import', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          enabled: true,
          startHour: 0, // ‚úÖ Ultimi 24h (non solo dalle 9:00)
          onlyEcura: true, // ‚úÖ RIPRISTINATO: solo lead da Form eCura
          dryRun: false
        })
      });
      
      const result = await response.json();
      
      // Salva timestamp ultimo import
      localStorage.setItem('lastAutoImportTimestamp', new Date().toISOString());
      
      if (result.success) {
        const timeFrom = new Date(result.timeRange.from).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
        const timeTo = new Date(result.timeRange.to).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
        
        console.log(\`‚úÖ [AUTO-IMPORT] Completato: \${result.imported} importati, \${result.skipped} gi√† esistenti (\${timeFrom} - \${timeTo})\`);
        
        // Ricarica dati dashboard sempre (anche se 0 importati) per sincronizzare cancellazioni
        if (typeof window.refreshDashboardData === 'function') {
          console.log('üîÑ [AUTO-IMPORT] Ricarico dati dashboard...');
          setTimeout(() => window.refreshDashboardData(), 1000);
        }
        
        // Mostra notifica solo se importati nuovi lead
        if (result.imported > 0 && AUTO_IMPORT_CONFIG.showSuccessToast) {
          showAutoImportToast(\`‚úÖ \${result.imported} nuovi lead importati da HubSpot\`, 'success');
        } else if (AUTO_IMPORT_CONFIG.silent) {
          // Import silenzioso: nessuna notifica
          console.log(\`‚ÑπÔ∏è  [AUTO-IMPORT] Nessun nuovo lead da importare\`);
        }
      } else {
        console.error('‚ùå [AUTO-IMPORT] Errore:', result.message || result.error);
        
        // Non mostrare errore all'utente se silenzioso
        if (!AUTO_IMPORT_CONFIG.silent) {
          showAutoImportToast(\`‚ö†Ô∏è Auto-import fallito: \${result.message || result.error}\`, 'error');
        }
      }
      
    } catch (error) {
      console.error('‚ùå [AUTO-IMPORT] Errore esecuzione:', error);
      
      if (!AUTO_IMPORT_CONFIG.silent) {
        showAutoImportToast('‚ö†Ô∏è Errore auto-import HubSpot', 'error');
      }
    }
  }
  
  // Mostra toast notifica
  function showAutoImportToast(message, type = 'info') {
    // Crea toast element
    const toast = document.createElement('div');
    toast.className = \`fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 transition-all duration-300 \${
      type === 'success' ? 'bg-green-600' :
      type === 'error' ? 'bg-red-600' :
      'bg-blue-600'
    }\`;
    toast.innerHTML = \`
      <div class="flex items-center gap-3">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          \${type === 'success' 
            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>'
            : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'
          }
        </svg>
        <span>\${message}</span>
      </div>
    \`;
    
    document.body.appendChild(toast);
    
    // Fade in
    setTimeout(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
    }, 10);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(10px)';
      setTimeout(() => toast.remove(), 300);
    }, 5000);
  }
  
  // Esegui auto-import quando documento √® pronto
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', executeAutoImport);
  } else {
    // DOM gi√† caricato, esegui subito
    setTimeout(executeAutoImport, 500); // Piccolo delay per lasciare caricare la dashboard
  }
  
  // Log status
  console.log('ü§ñ [AUTO-IMPORT] Script caricato e pronto');
  console.log(\`üìä [AUTO-IMPORT] Config: enabled=\${AUTO_IMPORT_CONFIG.enabled}, silent=\${AUTO_IMPORT_CONFIG.silent}, interval=\${AUTO_IMPORT_CONFIG.minIntervalMinutes}min\`);
  
})();
<\/script>
`,a0=`<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Version: 2025-12-29-teal-fix -->
    <title>TeleMedCare V12.0 - Dashboard Principale</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .gradient-hero { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%); }
        .card-hover { 
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .card-hover:hover { 
            transform: translateY(-8px) scale(1.02); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        .icon-bounce:hover {
            animation: bounce 0.5s;
        }
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-hero text-white shadow-2xl">
        <div class="container mx-auto px-6 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-white bg-opacity-20 backdrop-blur p-3 rounded-xl">
                        <i class="fas fa-heartbeat text-4xl"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold">TeleMedCare V12.0</h1>
                        <p class="text-blue-100">Sistema Modulare Multi-Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="flex items-center bg-green-500 bg-opacity-30 px-4 py-2 rounded-full">
                        <span class="w-2 h-2 bg-green-400 rounded-full mr-2 pulse-dot"></span>
                        <span class="text-sm font-semibold">Sistema Online</span>
                    </span>
                    <div class="text-right">
                        <p class="text-sm font-medium">Medica GB S.r.l.</p>
                        <p class="text-xs text-blue-100">Milano - ISO 27001</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Stats -->
    <section class="container mx-auto px-6 py-8">
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
            <!-- Lead Oggi -->
            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-100 text-sm mb-1">Lead Oggi</p>
                        <p class="text-3xl font-bold" id="leadsToday">-</p>
                        <p class="text-xs text-green-100 mt-1">Ultime 24h</p>
                    </div>
                    <i class="fas fa-users text-4xl text-green-200"></i>
                </div>
            </div>

            <!-- Contratti Oggi -->
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-100 text-sm mb-1">Contratti Oggi</p>
                        <p class="text-3xl font-bold" id="contractsToday">-</p>
                        <p class="text-xs text-purple-100 mt-1">Ultime 24h</p>
                    </div>
                    <i class="fas fa-file-contract text-4xl text-purple-200"></i>
                </div>
            </div>

            <!-- Proforma Oggi -->
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm mb-1">Proforma Oggi</p>
                        <p class="text-3xl font-bold" id="proformaToday">-</p>
                        <p class="text-xs text-blue-100 mt-1">Ultime 24h</p>
                    </div>
                    <i class="fas fa-file-invoice text-4xl text-blue-200"></i>
                </div>
            </div>

            <!-- Pagamenti Oggi -->
            <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white text-sm mb-1">Pagamenti Oggi</p>
                        <p class="text-3xl font-bold" id="paymentsToday">-</p>
                        <p class="text-xs text-white mt-1">Ultime 24h</p>
                    </div>
                    <i class="fas fa-euro-sign text-4xl text-white opacity-80"></i>
                </div>
            </div>

            <!-- Configurazioni Oggi -->
            <div id="boxConfigurazioni" style="background: linear-gradient(135deg, #ea580c 0%, #dc2626 100%) !important;" class="text-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p style="color: white !important; white-space: nowrap;" class="text-xs mb-1 font-semibold">Configurazioni Oggi</p>
                        <p style="color: white !important;" class="text-3xl font-bold" id="configurationsToday">0</p>
                        <p style="color: white !important;" class="text-xs mt-1 font-medium">Ultime 24h</p>
                    </div>
                    <i style="color: white !important;" class="fas fa-cog text-4xl"></i>
                </div>
            </div>

            <!-- Attivazioni Oggi -->
            <div class="bg-gradient-to-br from-pink-500 to-pink-600 text-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-pink-100 text-sm mb-1">Attivazioni Oggi</p>
                        <p class="text-3xl font-bold" id="activationsToday">-</p>
                        <p class="text-xs text-pink-100 mt-1">Ultime 24h</p>
                    </div>
                    <i class="fas fa-power-off text-4xl text-pink-200"></i>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Cards -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-th-large text-blue-500 mr-3"></i>
                Dashboard Sistema
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Dashboard Operativa -->
                <a href="/dashboard" class="bg-white rounded-xl shadow-md card-hover overflow-hidden border-2 border-transparent hover:border-purple-400">
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 p-6 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <i class="fas fa-chart-line text-5xl"></i>
                            <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-xs font-semibold">
                                PRINCIPALE
                            </span>
                        </div>
                        <h3 class="text-xl font-bold mb-2">Dashboard Operativa</h3>
                        <p class="text-purple-100 text-sm">Centro di controllo staff</p>
                    </div>
                    <div class="p-6">
                        <div class="space-y-3">
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                KPI e Metriche Real-time
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Grafici Servizi e Piani
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Ultimi Lead Ricevuti
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Auto-refresh 30s
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 rounded-lg transition-colors">
                                Accedi <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </a>

                <!-- Dashboard Leads -->
                <a href="/admin/leads-dashboard" class="bg-white rounded-xl shadow-md card-hover overflow-hidden border-2 border-transparent hover:border-green-400">
                    <div class="bg-gradient-to-r from-green-500 to-green-600 p-6 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <i class="fas fa-users text-5xl"></i>
                            <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-xs font-semibold">
                                LEADS
                            </span>
                        </div>
                        <h3 class="text-2xl font-bold mb-2">Dashboard Leads</h3>
                        <p class="text-green-100 text-sm">Analytics e conversioni</p>
                    </div>
                    <div class="p-6">
                        <div class="space-y-3">
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Tasso Conversione Lead
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Breakdown Servizi/Piani
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Statistiche per Canale
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Filtri Avanzati
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg transition-colors">
                                Accedi <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </a>

                <!-- Data Dashboard -->
                <a href="/admin/data-dashboard" class="bg-white rounded-xl shadow-md card-hover overflow-hidden border-2 border-transparent hover:border-blue-400">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-6 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <i class="fas fa-database text-5xl"></i>
                            <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-xs font-semibold">
                                ANALYTICS
                            </span>
                        </div>
                        <h3 class="text-2xl font-bold mb-2">Data Dashboard</h3>
                        <p class="text-blue-100 text-sm">KPI e Revenue aziendali</p>
                    </div>
                    <div class="p-6">
                        <div class="space-y-3">
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                5 KPI Principali
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Performance per Servizio
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Revenue Tracking
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Contratti Generati
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition-colors">
                                Accedi <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </a>

                <!-- Workflow Manager -->
                <a href="/admin/workflow-manager" class="bg-white rounded-xl shadow-md card-hover overflow-hidden border-2 border-transparent hover:border-red-400">
                    <div class="bg-gradient-to-r from-red-500 to-red-600 p-6 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <i class="fas fa-diagram-project text-5xl"></i>
                            <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-xs font-semibold">
                                WORKFLOW
                            </span>
                        </div>
                        <h3 class="text-2xl font-bold mb-2">Workflow Manager</h3>
                        <p class="text-red-100 text-sm">Gestione eventi manuali</p>
                    </div>
                    <div class="p-6">
                        <div class="space-y-3">
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Workflow Completo 6 Step
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Firma Contratto Manuale
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Pagamento Bonifico
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Monitoraggio Stato Lead
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-lg transition-colors">
                                Accedi <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        <!-- Servizi eCura -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-heartbeat text-red-500 mr-3"></i>
                Servizi eCura Disponibili
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- FAMILY -->
                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-blue-600">eCura FAMILY</h3>
                        <i class="fas fa-home text-2xl text-blue-500"></i>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Monitoraggio base per la famiglia</p>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">BASE:</span>
                            <span class="font-bold text-green-600">‚Ç¨390/anno</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">AVANZATO:</span>
                            <span class="font-bold text-green-600">‚Ç¨690/anno</span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500">
                        <i class="fas fa-check mr-1"></i>Dispositivo SiDLY CARE<br>
                        <i class="fas fa-check mr-1"></i>incluso SIM e APP per 12 mesi
                    </div>
                </div>

                <!-- PRO -->
                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-purple-600">eCura PRO</h3>
                        <i class="fas fa-star text-2xl text-purple-500"></i>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">SiDLY CARE PRO - Protezione avanzata con GPS</p>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">BASE:</span>
                            <span class="font-bold text-green-600">‚Ç¨480/anno</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">AVANZATO:</span>
                            <span class="font-bold text-green-600">‚Ç¨840/anno</span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500">
                        <i class="fas fa-check mr-1"></i>SiDLY CARE PRO Classe IIa<br>
                        <i class="fas fa-check mr-1"></i>Rilevamento cadute + GPS<br>
                        <i class="fas fa-check mr-1"></i>Pulsante SOS geolocalizzato
                    </div>
                </div>

                <!-- PREMIUM -->
                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-green-600">eCura PREMIUM</h3>
                        <i class="fas fa-crown text-2xl text-green-500"></i>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">SiDLY VITAL CARE - Monitoraggio completo</p>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">BASE:</span>
                            <span class="font-bold text-green-600">‚Ç¨590/anno</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">AVANZATO:</span>
                            <span class="font-bold text-green-600">‚Ç¨990/anno</span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500">
                        <i class="fas fa-check mr-1"></i>SiDLY VITAL CARE Classe IIa<br>
                        <i class="fas fa-check mr-1"></i>Monitoraggio parametri completo<br>
                        <i class="fas fa-check mr-1"></i>Dashboard famiglia premium
                    </div>
                </div>
            </div>
        </div>

        <!-- System Info -->
        <div class="bg-gradient-to-r from-gray-800 to-gray-900 text-white rounded-xl shadow-lg p-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-2xl font-bold mb-4">Sistema Integrato</h3>
                    <div class="space-y-2">
                        <p class="flex items-center text-gray-300">
                            <i class="fas fa-check-circle text-green-400 mr-3"></i>
                            Template contratti con 19 placeholder
                        </p>
                        <p class="flex items-center text-gray-300">
                            <i class="fas fa-check-circle text-green-400 mr-3"></i>
                            Prezzi aggiornati da www.ecura.it
                        </p>
                        <p class="flex items-center text-gray-300">
                            <i class="fas fa-check-circle text-green-400 mr-3"></i>
                            Generazione PDF automatica
                        </p>
                        <p class="flex items-center text-gray-300">
                            <i class="fas fa-check-circle text-green-400 mr-3"></i>
                            Invio email con brochure
                        </p>
                        <p class="flex items-center text-gray-300">
                            <i class="fas fa-check-circle text-green-400 mr-3"></i>
                            Dashboard real-time integrate
                        </p>
                    </div>
                </div>
                <div>
                    <h3 class="text-2xl font-bold mb-4">Informazioni Sistema</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between border-b border-gray-700 pb-2">
                            <span class="text-gray-400">Versione:</span>
                            <span class="font-mono text-green-400">V12.0 Modular Enterprise</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-700 pb-2">
                            <span class="text-gray-400">Ambiente:</span>
                            <span class="font-mono text-blue-400">Production Ready</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-700 pb-2">
                            <span class="text-gray-400">Database:</span>
                            <span class="font-mono text-purple-400">Cloudflare D1</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-700 pb-2">
                            <span class="text-gray-400">Email Service:</span>
                            <span class="font-mono text-yellow-400">Resend API</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Deployment:</span>
                            <span class="font-mono text-red-400">Cloudflare Workers</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Archivi e Documentazione -->
    <div class="container mx-auto px-6 mb-12">
        <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">
            <i class="fas fa-archive mr-2 text-amber-600"></i>
            Archivi e Documentazione
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
            <!-- Contratti e Proforma Personalizzati -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-4xl text-amber-500 mb-3 icon-bounce">
                        <i class="fas fa-file-contract"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Contratti & Proforma</h3>
                    <p class="text-gray-600 text-sm mb-4">Archivio contratti personalizzati e proforma</p>
                    <a href="/admin/contracts" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded text-sm transition-colors">
                        <i class="fas fa-folder-open mr-1"></i>Gestisci
                    </a>
                </div>
            </div>

            <!-- Contratti Firmati -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-4xl text-emerald-500 mb-3 icon-bounce">
                        <i class="fas fa-file-signature"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Contratti Firmati</h3>
                    <p class="text-gray-600 text-sm mb-4">Archivio contratti definitivi firmati</p>
                    <a href="/admin/signed-contracts" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded text-sm transition-colors">
                        <i class="fas fa-certificate mr-1"></i>Visualizza
                    </a>
                </div>
            </div>

            <!-- Documentazione -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-4xl text-indigo-500 mb-3 icon-bounce">
                        <i class="fas fa-book"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Documentazione</h3>
                    <p class="text-gray-600 text-sm mb-4">Lettura e modifica documentazione sistema</p>
                    <a href="/admin/docs" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded text-sm transition-colors">
                        <i class="fas fa-edit mr-1"></i>Modifica
                    </a>
                </div>
            </div>

            <!-- Template Manager -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-4xl text-pink-500 mb-3 icon-bounce">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Template Manager</h3>
                    <p class="text-gray-600 text-sm mb-4">Gestione template email e documenti</p>
                    <a href="/template-system" class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded text-sm transition-colors">
                        <i class="fas fa-palette mr-1"></i>Gestisci
                    </a>
                </div>
            </div>

            <!-- Magazzino DM -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-4xl text-teal-500 mb-3 icon-bounce">
                        <i class="fas fa-warehouse"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Magazzino DM</h3>
                    <p class="text-gray-600 text-sm mb-4">Gestione completa dispositivi medici e inventario</p>
                    <a href="/admin/warehouse" class="bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded text-sm transition-colors">
                        <i class="fas fa-boxes mr-1"></i>Gestisci
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Testing e Sviluppo -->
    <div class="container mx-auto px-6 mb-12">
        <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">
            <i class="fas fa-flask mr-2 text-red-600"></i>
            Testing e Sviluppo
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Testing Dashboard -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-5xl text-red-500 mb-4 icon-bounce">
                        <i class="fas fa-bug"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Testing Dashboard</h3>
                    <p class="text-gray-600 mb-4">Test funzionali e stress test automatizzati</p>
                    <a href="/admin/testing-dashboard" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-play mr-2"></i>Avvia Test
                    </a>
                </div>
            </div>

            <!-- Email Testing -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-5xl text-orange-500 mb-4 icon-bounce">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Email Testing</h3>
                    <p class="text-gray-600 mb-4">Test template email e invio messaggi</p>
                    <a href="/email-test" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-paper-plane mr-2"></i>Test Email
                    </a>
                </div>
            </div>

            <!-- Contract Testing -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-5xl text-teal-500 mb-4 icon-bounce">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Contract Testing</h3>
                    <p class="text-gray-600 mb-4">Test generazione contratti PDF</p>
                    <a href="/contract-test" class="bg-teal-500 hover:bg-teal-600 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-file-alt mr-2"></i>Test PDF
                    </a>
                </div>
            </div>
        </div>
    </div>

            <!-- Sezione Dispositivi e Sistema -->
            <div class="mb-12">
                <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">
                    <i class="fas fa-microchip mr-2 text-cyan-600"></i>
                    Dispositivi e Sistema
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Device Management -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-5xl text-cyan-500 mb-4 icon-bounce">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Gestione Dispositivi</h3>
                    <p class="text-gray-600 mb-4">Registrazione e monitoring dispositivi SiDLY</p>
                    <a href="/admin/devices" class="bg-cyan-500 hover:bg-cyan-600 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-cogs mr-2"></i>Gestisci
                    </a>
                </div>
            </div>

            <!-- System Status -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-5xl text-gray-500 mb-4 icon-bounce">
                        <i class="fas fa-server"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">System Status</h3>
                    <p class="text-gray-600 mb-4">Monitoraggio stato sistema e API</p>
                    <a href="/admin/system-status" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-heartbeat mr-2"></i>System Status
                    </a>
                </div>
            </div>

            <!-- Sistema Backup -->
            <div class="card-hover bg-white rounded-xl p-6 shadow-lg">
                <div class="text-center">
                    <div class="text-5xl text-green-500 mb-4 icon-bounce">
                        <i class="fas fa-cloud-download-alt"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Sistema Backup</h3>
                    <p class="text-gray-600 mb-4">Backup automatico TEST/STAGING/PRODUZIONE</p>
                    <a href="/admin/backup-system" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-save mr-2"></i>Gestisci
                    </a>
                </div>
                </div>
            </div>

        </div>

        <!-- Footer -->
        <div class="bg-gray-800 text-white py-6 mt-16">
            <div class="container mx-auto px-6 text-center">
                <p class="text-lg">
                    <i class="fas fa-shield-alt mr-2 text-blue-400"></i>
                    TeleMedCare V12.0 Enterprise - Sistema Completo di TeleAssistenza
                </p>
                <p class="text-gray-400 mt-2">
                    Ambiente: <span class="text-green-400 font-semibold">Development</span> | 
                    Versione: <span class="text-blue-400 font-semibold">V12.0-Modular-Enterprise</span> |
                    Status: <span class="text-green-400 font-semibold">üü¢ Online</span>
                </p>
            </div>
        </div>

        <script>
            // Helper function to escape single quotes in strings to prevent syntax errors
            function escapeQuotes(str) {
                if (!str) return '';
                return String(str).replace(/'/g, "\\'");
            }
            
            // Effetto hover animato per le cards
            document.querySelectorAll('.card-hover').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-8px) scale(1.02)';
                });
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });

            // Controllo status in tempo reale
            async function checkSystemStatus() {
                try {
                    const response = await fetch('/api/system/status');
                    const status = await response.json();
                    console.log('System Status:', status);
                } catch (error) {
                    console.log('Status check failed:', error);
                }
            }
            
            // Check status ogni 30 secondi
            checkSystemStatus();
            setInterval(checkSystemStatus, 30000);
            
            // Load stats on page load (manteniamo per compatibilit√†)
            async function loadStats() {
            try {
                const response = await fetch('/api/data/stats');
                const stats = await response.json();
                
                // Lead Oggi
                if (stats.leadsToday !== undefined) {
                    document.getElementById('leadsToday').textContent = stats.leadsToday;
                }
                
                // Contratti Oggi
                if (stats.contractsToday !== undefined) {
                    document.getElementById('contractsToday').textContent = stats.contractsToday;
                } else if (stats.totalContracts !== undefined) {
                    // Fallback per compatibilit√†
                    document.getElementById('contractsToday').textContent = stats.totalContracts;
                }
                
                // Proforma Oggi
                if (stats.proformaToday !== undefined) {
                    document.getElementById('proformaToday').textContent = stats.proformaToday;
                }
                
                // Pagamenti Oggi
                if (stats.paymentsToday !== undefined) {
                    document.getElementById('paymentsToday').textContent = stats.paymentsToday;
                }
                
                // Configurazioni Oggi
                if (stats.configurationsToday !== undefined) {
                    document.getElementById('configurationsToday').textContent = stats.configurationsToday;
                }
                
                // Attivazioni Oggi
                if (stats.activationsToday !== undefined) {
                    document.getElementById('activationsToday').textContent = stats.activationsToday;
                }
            } catch (error) {
                console.log('Stats not yet available');
                // Set tutti a 0 in caso di errore
                document.getElementById('leadsToday').textContent = '0';
                document.getElementById('contractsToday').textContent = '0';
                document.getElementById('proformaToday').textContent = '0';
                document.getElementById('paymentsToday').textContent = '0';
                document.getElementById('configurationsToday').textContent = '0';
                document.getElementById('activationsToday').textContent = '0';
            }
        }

        loadStats();
    <\/script>
</body>
</html>
`,cw=`<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Operativa - TeleMedCare V12.0</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-sent { background: #dcfce7; color: #16a34a; }
        .status-pending { background: #fef3c7; color: #ca8a04; }
        .status-error { background: #fee2e2; color: #dc2626; }
        .refresh-btn {
            animation: rotate 1s linear infinite;
            animation-play-state: paused;
        }
        .refresh-btn.rotating {
            animation-play-state: running;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-chart-line text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Dashboard Operativa</h1>
                        <p class="text-purple-100">Centro di controllo staff - TeleMedCare V12.0</p>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <a href="/" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-home mr-2"></i>Home
                    </a>
                    <a href="/admin/leads-dashboard" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-users mr-2"></i>Leads
                    </a>
                    <button onclick="refreshData()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-sync-alt mr-2 refresh-btn" id="refreshIcon"></i>Aggiorna
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Lead Totali</p>
                        <p class="text-3xl font-bold text-blue-600" id="totalLeads">-</p>
                        <p class="text-xs text-gray-500 mt-1">Ultimi 30 giorni</p>
                    </div>
                    <i class="fas fa-users text-3xl text-blue-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Contratti Inviati</p>
                        <p class="text-3xl font-bold text-green-600" id="contractsSent">-</p>
                        <p class="text-xs text-gray-500 mt-1">Ultimi 30 giorni</p>
                    </div>
                    <i class="fas fa-file-contract text-3xl text-green-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Email Inviate</p>
                        <p class="text-3xl font-bold text-purple-600" id="emailsSent">-</p>
                        <p class="text-xs text-gray-500 mt-1">Ultimi 30 giorni</p>
                    </div>
                    <i class="fas fa-envelope text-3xl text-purple-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-orange-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Servizio Pi√π Richiesto</p>
                        <p class="text-xl font-bold text-orange-600" id="topService">-</p>
                        <p class="text-xs text-gray-500 mt-1">Questo mese</p>
                    </div>
                    <i class="fas fa-star text-3xl text-orange-500"></i>
                </div>
            </div>
        </div>

        <!-- Import API Buttons per Canale -->
        <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
            <h3 class="text-lg font-bold text-gray-800 mb-4">
                <i class="fas fa-download mr-2 text-blue-600"></i>Import Lead da Canali
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <button onclick="importFromExcel()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold transition-all shadow-sm hover:shadow-md">
                    <i class="fas fa-file-excel mr-2"></i>Excel
                </button>
                <button onclick="importFromIrbema()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold transition-all shadow-sm hover:shadow-md">
                    <i class="fas fa-building mr-2"></i>Irbema
                </button>
                <button onclick="importFromAON()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold transition-all shadow-sm hover:shadow-md">
                    <i class="fas fa-handshake mr-2"></i>AON
                </button>
                <button onclick="importFromDoubleYou()" class="bg-pink-600 hover:bg-pink-700 text-white px-6 py-3 rounded-lg font-semibold transition-all shadow-sm hover:shadow-md" style="color: white !important; background-color: #db2777 !important;">
                    <i class="fas fa-chart-line mr-2"></i>DoubleYou
                </button>
            </div>
        </div>

        <!-- Settings: Switch ON/OFF - TUTTI E 4 GLI SWITCH SEMPRE VISIBILI -->
        <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
            <h3 class="text-lg font-bold text-gray-800 mb-4">
                <i class="fas fa-cog mr-2 text-purple-600"></i>Impostazioni Sistema
                <span class="ml-3 text-sm text-gray-500">(4 configurazioni attive)</span>
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
                <!-- 1. Import Automatico HubSpot -->
                <div class="p-4 bg-blue-50 rounded-lg border-2 border-blue-200 hover:border-blue-400 transition-all">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üîÑ</span>
                        <h4 class="font-semibold text-gray-800">Import Auto HubSpot</h4>
                    </div>
                    <p class="text-xs text-gray-600 mb-3">Import automatico giornaliero da HubSpot</p>
                    <select id="selectHubspotAuto" class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-medium" onchange="updateSetting('hubspot_auto_import_enabled', this.value)">
                        <option value="false">‚ùå OFF - Disattivato</option>
                        <option value="true">‚úÖ ON - Attivo</option>
                    </select>
                </div>
                
                <!-- 2. Email Automatiche Lead -->
                <div class="p-4 bg-green-50 rounded-lg border-2 border-green-200 hover:border-green-400 transition-all">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üìß</span>
                        <h4 class="font-semibold text-gray-800">Email Automatiche Lead</h4>
                    </div>
                    <p class="text-xs text-gray-600 mb-3">Email brochure, contratto, reminder ai lead</p>
                    <select id="selectLeadEmails" class="w-full px-3 py-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 font-medium" onchange="updateSetting('lead_email_notifications_enabled', this.value)">
                        <option value="false">‚ùå OFF - Disattivato</option>
                        <option value="true">‚úÖ ON - Attivo</option>
                    </select>
                </div>

                <!-- 3. Notifiche Email Admin -->
                <div class="p-4 bg-purple-50 rounded-lg border-2 border-purple-200 hover:border-purple-400 transition-all">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üîî</span>
                        <h4 class="font-semibold text-gray-800">Notifiche Email Admin</h4>
                    </div>
                    <p class="text-xs text-gray-600 mb-3">Abilita notifiche email a info@telemedcare.it</p>
                    <select id="selectAdminEmails" class="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 font-medium" onchange="updateSetting('admin_email_notifications_enabled', this.value)">
                        <option value="false">‚ùå OFF - Disattivato</option>
                        <option value="true">‚úÖ ON - Attivo</option>
                    </select>
                </div>

                <!-- 4. Reminder Automatici Completamento -->
                <div class="p-4 bg-orange-50 rounded-lg border-2 border-orange-200 hover:border-orange-400 transition-all">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">‚è∞</span>
                        <h4 class="font-semibold text-gray-800">Reminder Completamento</h4>
                    </div>
                    <p class="text-xs text-gray-600 mb-3">Reminder automatici per dati mancanti</p>
                    <select id="selectReminderCompletion" class="w-full px-3 py-2 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 font-medium" onchange="updateSetting('reminder_completion_enabled', this.value)">
                        <option value="false">‚ùå OFF - Disattivato</option>
                        <option value="true">‚úÖ ON - Attivo</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Script Settings: Definito QUI per essere disponibile agli handler inline -->
        <script>
            // ‚öôÔ∏è FUNZIONE UPDATE SETTING - Definita prima degli handler
            window.updateSetting = async function(key, value) {
                try {
                    console.log('üîÑ [SETTINGS] Aggiornamento setting:', key, '=', value);
                    
                    const response = await fetch('/api/settings/' + key, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ value: value })
                    });
                    
                    const result = await response.json();
                    
                    console.log('üîÑ [SETTINGS] Response:', result);
                    
                    if (result.success) {
                        alert('‚úÖ Impostazione aggiornata con successo!\\n\\n' + key + ' = ' + value);
                        console.log('‚úÖ [SETTINGS] Setting aggiornato:', key, '=', value);
                    } else {
                        alert('‚ùå Errore: ' + result.error);
                        console.error('‚ùå [SETTINGS] Errore:', result.error);
                    }
                } catch (error) {
                    console.error('‚ùå [SETTINGS] Errore aggiornamento setting:', error);
                    alert('‚ùå Errore di comunicazione: ' + error.message);
                }
            };
            
            console.log('‚úÖ [SETTINGS] Funzione window.updateSetting definita');
            
            // ‚öôÔ∏è FUNZIONE LOAD SETTINGS - Carica i valori dal DB
            window.loadSettings = async function() {
                try {
                    console.log('üì• [SETTINGS] Caricamento settings dal database...');
                    const response = await fetch('/api/settings');
                    const data = await response.json();
                    
                    console.log('üì• [SETTINGS] Response:', data);
                    
                    if (data.success && data.settings) {
                        const settings = data.settings;
                        
                        // Update select states - tutti e 4 i settings
                        if (settings.hubspot_auto_import_enabled) {
                            const value = settings.hubspot_auto_import_enabled.value;
                            console.log('‚úÖ [SETTINGS] HubSpot:', value);
                            const el = document.getElementById('selectHubspotAuto');
                            if (el) el.value = value;
                        }
                        if (settings.lead_email_notifications_enabled) {
                            const value = settings.lead_email_notifications_enabled.value;
                            console.log('‚úÖ [SETTINGS] Lead Emails:', value);
                            const el = document.getElementById('selectLeadEmails');
                            if (el) el.value = value;
                        }
                        if (settings.admin_email_notifications_enabled) {
                            const value = settings.admin_email_notifications_enabled.value;
                            console.log('‚úÖ [SETTINGS] Admin Emails:', value);
                            const el = document.getElementById('selectAdminEmails');
                            if (el) el.value = value;
                        }
                        if (settings.reminder_completion_enabled) {
                            const value = settings.reminder_completion_enabled.value;
                            console.log('‚úÖ [SETTINGS] Reminder:', value);
                            const el = document.getElementById('selectReminderCompletion');
                            if (el) el.value = value;
                        }
                        
                        console.log('‚úÖ [SETTINGS] Tutti e 4 gli switch caricati correttamente');
                    } else {
                        console.error('‚ùå [SETTINGS] Risposta API non valida:', data);
                    }
                } catch (error) {
                    console.error('‚ùå [SETTINGS] Errore caricamento settings:', error);
                }
            };
            
            console.log('‚úÖ [SETTINGS] Funzione window.loadSettings definita');
            
            // Carica settings al caricamento pagina
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', window.loadSettings);
            } else {
                window.loadSettings();
            }
        <\/script>

        <!-- Elenco Assistiti -->
        <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-users text-green-500 mr-2"></i>
                    Assistiti Attivi
                    <span id="assistitiCount" class="ml-3 text-sm bg-green-100 text-green-700 px-3 py-1 rounded-full font-bold">0</span>
                </h3>
                <div class="flex space-x-2">
                    <input 
                        type="text" 
                        id="searchAssistitoCognome" 
                        class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-56" 
                        placeholder="üîç Cerca assistito..."
                        onkeyup="filterAssistiti()"
                    />
                    <button onclick="nuovoAssistito()" class="flex items-center px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-user-plus mr-2"></i>
                        Nuovo Assistito
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-200 text-left">
                            <th class="pb-3 text-sm font-semibold text-gray-600">Assistito</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">IMEI Dispositivo</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Email</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Telefono</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Servizio</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Piano</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Prezzo</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Status</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="assistitiTable">
                        <tr>
                            <td colspan="9" class="py-8 text-center text-gray-400">
                                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                <p>Caricamento assistiti...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analisi Lead: Servizi, Piani e Canali (Compattati su 1 riga) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Distribuzione Servizi -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-pie text-purple-500 mr-2"></i>
                    Distribuzione Servizi
                </h3>
                <div id="servicesChart" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Piano BASE vs AVANZATO -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-bar text-blue-500 mr-2"></i>
                    Piano BASE vs AVANZATO
                </h3>
                <div id="plansChart" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Distribuzione per Canale -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-network-wired text-orange-500 mr-2"></i>
                    Distribuzione per Canale
                </h3>
                <div id="channelsDistribution" class="space-y-3">
                    <!-- Distribuzione canali verr√† popolata dinamicamente -->
                </div>
            </div>
        </div>

        <!-- Ultimi Lead Ricevuti -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-clock text-green-500 mr-2"></i>
                    Ultimi Lead Ricevuti
                </h3>
                <span class="text-sm text-gray-500" id="lastUpdate">Aggiornato ora</span>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-200 text-left">
                            <th class="pb-3 text-sm font-semibold text-gray-600">Lead ID</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Cliente</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Telefono</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Servizio</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Piano</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Dispositivo</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Prezzo</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Contratto</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Data</th>
                        </tr>
                    </thead>
                    <tbody id="leadsTable">
                        <tr>
                            <td colspan="9" class="py-8 text-center text-gray-400">
                                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                <p>Caricamento dati...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Helper function to escape HTML special characters
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        let refreshInterval;
        let isLoading = false;

        // Carica dati iniziali
        loadDashboardData();

        // Auto-refresh ogni 30 secondi (solo se non sta gi√† caricando)
        refreshInterval = setInterval(() => {
            if (!isLoading) {
                loadDashboardData();
            }
        }, 30000);

        async function loadDashboardData() {
            // Previeni chiamate sovrapposte
            if (isLoading) return;
            
            isLoading = true;
            try {
                // MIGRAZIONE AUTOMATICA SCHEMA (eseguita una sola volta)
                try {
                    const migrateResponse = await fetch('/api/migrate-schema', { method: 'POST' });
                    const migrateData = await migrateResponse.json();
                    if (migrateData.success) {
                        console.log('‚úÖ Migrazione schema:', migrateData.migrations);
                    }
                } catch (migrateError) {
                    console.warn('‚ö†Ô∏è Migrazione schema saltata:', migrateError);
                }
                
                // Carica TUTTI i lead (limite massimo 999999)
                const allLeadsResponse = await fetch('/api/leads?limit=999999');
                const allLeadsData = await allLeadsResponse.json();
                const allLeads = allLeadsData.leads || [];
                
                // Carica CONTRATTI reali per conteggio accurato
                const contractsResponse = await fetch('/api/contratti?limit=100');
                const contractsData = await contractsResponse.json();
                const contracts = contractsData.contracts || contractsData.contratti || contractsData.data || [];
                
                // Carica ASSISTITI reali con IMEI
                const assistitiResponse = await fetch('/api/assistiti');
                const assistitiData = await assistitiResponse.json();
                const assistiti = assistitiData.assistiti || [];
                
                // Calcola statistiche reali
                const totalLeads = allLeads.length;
                const contratti = contracts.length; // Conta contratti reali, non lead convertiti
                const topService = 'eCura PRO';
                
                // Aggiorna KPI
                document.getElementById('totalLeads').textContent = totalLeads;
                document.getElementById('contractsSent').textContent = contratti;
                document.getElementById('emailsSent').textContent = '0'; // TODO
                document.getElementById('topService').textContent = topService;

                // Filtra ultimi 3 mesi (90 giorni) e NON convertiti
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setDate(threeMonthsAgo.getDate() - 90);
                
                // REGOLA: Mostra solo lead NON convertiti (senza hardcoding)
                // Un lead √® DAVVERO convertito SOLO se ha:
                // 1. Status: CONVERTED, CONTRACT_SIGNED, ACTIVE
                // 2. Note con parole chiave FORTE: "firmato", "pagato", "consegnato", "attivo"
                // 
                // IMPORTANTE: "inviato contratto" NON significa convertito!
                // Solo quando c'√® conferma di firma/pagamento/consegna
                
                const recentLeads = allLeads.filter(lead => {
                    const leadDate = new Date(lead.created_at || lead.timestamp);
                    const status = (lead.status || '').toUpperCase();
                    const isRecent = leadDate >= threeMonthsAgo;
                    
                    // Controlla se lo status indica conversione REALE
                    const statusConverted = ['CONVERTED', 'CONTRACT_SIGNED', 'ACTIVE'].includes(status);
                    
                    // Controlla se le note indicano conversione REALE (non solo "inviato")
                    const note = (lead.note || lead.notes || '').toLowerCase();
                    const noteConverted = 
                        note.includes('firmato') ||           // Contratto firmato
                        note.includes('pagato') ||            // Pagamento ricevuto
                        note.includes('consegnato') ||        // Dispositivo consegnato
                        note.includes('attivo') ||            // Servizio attivo
                        note.includes('installato') ||        // Dispositivo installato
                        (note.includes('contratto') && note.includes('firmato')) ||  // "contratto firmato"
                        (note.includes('contratto') && note.includes('pagato'));     // "contratto pagato"
                    
                    // Lead √® convertito SOLO se status O note indicano conversione REALE
                    const notConverted = !statusConverted && !noteConverted;
                    
                    return isRecent && notConverted;
                });
                
                // Ultimi 10 lead recenti non convertiti per la tabella
                const leads = recentLeads.slice(0, 10);

                // Popola tabella lead
                const tbody = document.getElementById('leadsTable');
                if (leads.length === 0) {
                    tbody.innerHTML = \`
                        <tr>
                            <td colspan="9" class="py-8 text-center text-gray-400">
                                Nessun lead trovato
                            </td>
                        </tr>
                    \`;
                } else {
                    tbody.innerHTML = leads.map(lead => {
                        // ‚úÖ USA SERVIZIO E PREZZO DAL DATABASE
                        const servizio = lead.servizio || lead.tipoServizio || 'eCura PRO';
                        const piano = lead.piano || ((lead.note && lead.note.includes('Piano: AVANZATO')) ? 'AVANZATO' : 'BASE');
                        // Determina dispositivo in base al servizio
                        const servizioType = servizio ? servizio.replace('eCura ', '') : 'PRO';
                        const dispositivo = servizioType.includes('PREMIUM') ? 'SiDLY VITAL CARE' : 'SiDLY CARE PRO';
                        
                        // ‚úÖ CALCOLO PREZZO CORRETTO: considera servizio + piano
                        let prezzoFallback = 480; // Default: PRO BASE
                        if (servizioType.includes('FAMILY')) {
                          prezzoFallback = piano === 'AVANZATO' ? 690 : 390;
                        } else if (servizioType.includes('PREMIUM')) {
                          prezzoFallback = piano === 'AVANZATO' ? 990 : 590;
                        } else {
                          prezzoFallback = piano === 'AVANZATO' ? 840 : 480;
                        }
                        const prezzo = lead.prezzo_anno || prezzoFallback;
                        
                        const statusClass = (lead.vuoleBrochure === 'Si') ? 'status-sent' : 'status-pending';
                        const statusText = (lead.vuoleBrochure === 'Si') ? 'Inviata brochure' : 'Da contattare';
                        const telefono = lead.telefono || 'N/A';
                        const date = new Date(lead.created_at).toLocaleString('it-IT', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        return \`
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="py-3 text-sm">
                                    <code class="bg-gray-100 px-2 py-1 rounded text-xs" title="\${lead.id}">\${formatLeadId(lead.id)}</code>
                                </td>
                                <td class="py-3 text-sm">
                                    <div class="font-medium">\${escapeHtml(lead.nomeRichiedente)} \${escapeHtml(lead.cognomeRichiedente)}</div>
                                    <div class="text-xs text-gray-500">\${escapeHtml(lead.email)}</div>
                                </td>
                                <td class="py-3 text-sm text-gray-600">\${telefono}</td>
                                <td class="py-3 text-sm font-medium text-purple-600">\${servizio}</td>
                                <td class="py-3 text-sm">\${piano}</td>
                                <td class="py-3 text-sm text-gray-600">\${dispositivo}</td>
                                <td class="py-3 text-sm font-bold text-green-600">‚Ç¨\${prezzo}</td>
                                <td class="py-3">
                                    <span class="status-badge \${statusClass}">\${statusText}</span>
                                </td>
                                <td class="py-3 text-xs text-gray-500">\${date}</td>
                            </tr>
                        \`;
                    }).join('');
                }

                // Salva tutti i lead per i grafici
                window.allLeadsData = allLeads;
                
                // Aggiorna grafici: servizi basati su ASSISTITI, piani basati su ASSISTITI
                updateServicesChart(assistiti);  // ‚ö†Ô∏è FIX: usa assistiti non lead
                updatePlansChart(allLeads);
                updateChannelsDistribution(assistiti);  // Analizza solo assistiti attivi
                
                // Renderizza assistiti da API dedicata
                allAssistiti = assistiti;  // Salva per filtri
                renderAssistitiTable(assistiti);

                // Aggiorna timestamp
                document.getElementById('lastUpdate').textContent = \`Aggiornato: \${new Date().toLocaleTimeString('it-IT')}\`;

            } catch (error) {
                console.error('Errore caricamento dashboard:', error);
                // Mostra dettagli errore per debugging
                const errorMsg = error.message || 'Errore sconosciuto';
                document.getElementById('leadsTable').innerHTML = \`
                    <tr>
                        <td colspan="8" class="py-8 text-center text-red-500">
                            <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                            <p class="font-bold">Errore nel caricamento dei dati</p>
                            <p class="text-xs mt-2">\${errorMsg}</p>
                            <button onclick="loadDashboardData()" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                <i class="fas fa-redo mr-2"></i>Riprova
                            </button>
                        </td>
                    </tr>
                \`;
            } finally {
                isLoading = false;
            }
        }

        
        function importFromChannel(channel) {
            if (confirm(\`üì• Vuoi importare i lead dal canale \${channel}?\\n\\nQuesta operazione:
- Scaricher√† i nuovi lead da \${channel}
- Aggiorner√† il database
- Sincronizzer√† i dati\\n\\nProcedi?\`)) {
                // Mostra loading
                const btn = event.target.closest('button');
                const originalHTML = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Importazione...';
                
                fetch(\`/api/leads/import/\${channel.toLowerCase()}\`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(res => res.json())
                .then(data => {
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                    
                    if (data.success) {
                        alert('‚úÖ Import completato!\\n\\nCanale: ' + channel + '\\nLead importati: ' + (data.count || 0) + '\\nTotale lead: ' + (data.total || 0));
                        loadDashboardData(); // Ricarica dashboard
                    } else {
                        alert('‚ùå Errore import:\\n\\n' + (data.error || 'Errore sconosciuto'));
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                    alert('‚ùå Errore di comunicazione:\\n\\n' + error.message);
                });
            }
        }

        function refreshData() {
            const icon = document.getElementById('refreshIcon');
            icon.classList.add('rotating');
            loadDashboardData().finally(() => {
                setTimeout(() => icon.classList.remove('rotating'), 1000);
            });
        }

        function getDispositivoForService(servizio) {
            const dispositivi = {
                'FAMILY': 'SiDLY CARE PRO',
                'PRO': 'SiDLY CARE PRO',
                'PREMIUM': 'SiDLY VITAL CARE'
            };
            return dispositivi[servizio] || 'N/A';
        }

        function getPrezzoForService(servizio, piano) {
            const prezzi = {
                'FAMILY': { 'BASE': '390.00', 'AVANZATO': '690.00' },
                'PRO': { 'BASE': '480.00', 'AVANZATO': '840.00' },
                'PREMIUM': { 'BASE': '590.00', 'AVANZATO': '990.00' }
            };
            return prezzi[servizio]?.[piano] || '0.00';
        }

        function updateServicesChart(assistiti) {
            // FIX: Usa assistiti attivi, non lead
            const total = assistiti.length || 1;
            
            // Conta servizi basandosi sui piani degli assistiti
            // eCura PRO BASE e AVANZATO (tutti gli assistiti attuali)
            const serviceCounts = {
                'eCura PRO': total  // Tutti gli assistiti attivi sono eCura PRO
            };

            const colors = {
                'eCura PRO': 'bg-purple-500',
                'eCura FAMILY': 'bg-blue-500',
                'eCura PREMIUM': 'bg-green-500'
            };

            const html = Object.entries(serviceCounts).map(([service, count]) => {
                const percentage = 100; // Sempre 100% per eCura PRO
                const color = colors[service] || 'bg-gray-500';
                return \`
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700">\${service}</span>
                            <span class="text-sm font-bold text-gray-900">\${count} (\${percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="\${color} h-2 rounded-full" style="width: \${percentage}%"></div>
                        </div>
                    </div>
                \`;
            }).join('');

            document.getElementById('servicesChart').innerHTML = html || '<p class="text-gray-400 text-sm">Nessun dato disponibile</p>';
        }

        function updatePlansChart(leads) {
            // USA SOLO ASSISTITI per conteggio piani (non tutti i lead)
            const assistitiResponse = fetch('/api/assistiti').then(r => r.json()).then(data => {
                const assistiti = data.assistiti || [];
                const planCounts = { 'BASE': 0, 'AVANZATO': 0 };
                
                // Conta i piani reali basati sui contratti degli assistiti
                assistiti.forEach(assistito => {
                    const piano = assistito.piano || 'BASE';
                    if (piano === 'AVANZATO') {
                        planCounts.AVANZATO++;
                    } else {
                        planCounts.BASE++;
                    }
                });

                const total = assistiti.length || 1;
                const basePercentage = Math.round((planCounts.BASE / total) * 100);
                const avanzatoPercentage = Math.round((planCounts.AVANZATO / total) * 100);

                document.getElementById('plansChart').innerHTML = \`
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700">BASE</span>
                            <span class="text-sm font-bold text-gray-900">\${planCounts.BASE} (\${basePercentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: \${basePercentage}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700">AVANZATO</span>
                            <span class="text-sm font-bold text-gray-900">\${planCounts.AVANZATO} (\${avanzatoPercentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-purple-500 h-2 rounded-full" style="width: \${avanzatoPercentage}%"></div>
                        </div>
                    </div>
                \`;
            });
        }
        
        // Funzione per formattare ID lead - mostra ID completo in formato LEAD-CANALE-NUMERO
        function formatLeadId(leadId) {
            if (!leadId) return 'N/A';
            const id = leadId.toString();
            
            // Mostra l'ID completo (formato LEAD-IRBEMA-xxxxx)
            return id;
        }
        
        function updateChannelsDistribution(assistiti) {
            // Analizza SOLO gli ASSISTITI ATTIVI per identificare il canale di provenienza
            const channelCounts = {};
            const channelColors = {
                'Irbema': 'bg-blue-500',
                'Excel': 'bg-green-500',
                'Web': 'bg-indigo-600',
                'Networking': 'bg-purple-500',
                'AON': 'bg-orange-500',
                'DoubleYou': 'bg-pink-500'
            };
            
            assistiti.forEach(assistito => {
                let canale = 'Web'; // Default
                
                // Estrai info assistito - prova vari nomi campo
                const leadId = (assistito.id || '').toString().toUpperCase();
                const emailRichiedente = (
                    assistito.emailRichiedente || 
                    assistito.email || 
                    assistito.email_richiedente ||
                    assistito.emailrichiedente ||
                    ''
                ).toLowerCase().trim();
                const nomeCompleto = \`\${escapeHtml(assistito.nomeRichiedente || assistito.nome_richiedente || assistito.nome || '')} \${escapeHtml(assistito.cognomeRichiedente || assistito.cognome_richiedente || assistito.cognome || '')}\`.trim().toLowerCase();
                const canaleField = (assistito.canale || assistito.origine || '').toLowerCase();
                
                // ‚ö° MAPPATURA BASATA SU DATI REALI: Identifica canale da nome assistito
                // PRIORIT√Ä 1: Laura Calvi = Networking (unico caso da stefania.rocca@medicagb.it)
                if (nomeCompleto.includes('laura calvi') || 
                    emailRichiedente.includes('stefania.rocca@medicagb.it')) {
                    canale = 'Networking';
                    console.log('‚úÖ Networking:', nomeCompleto);
                }
                // PRIORIT√Ä 2: Tutti gli altri assistiti attivi = Irbema (da Excel colonna F: info@irbema.com)
                // Lista verificata dall'Excel: Elena Saglia, Paolo Magri, Caterina D'Alterio, 
                // Simona Pizzutto, Elisabetta Cattini, e gli assistiti attuali nel DB
                else if (
                    nomeCompleto.includes('elena') || nomeCompleto.includes('saglia') ||
                    nomeCompleto.includes('paolo') || nomeCompleto.includes('magri') ||
                    nomeCompleto.includes('caterina') || nomeCompleto.includes('alterio') ||
                    nomeCompleto.includes('simona') || nomeCompleto.includes('pizzutto') ||
                    nomeCompleto.includes('elisabetta') || nomeCompleto.includes('cattini') ||
                    nomeCompleto.includes('giuliana') || nomeCompleto.includes('balzarotti') ||
                    nomeCompleto.includes('rita') || nomeCompleto.includes('pennacchio') ||
                    nomeCompleto.includes('maria') || nomeCompleto.includes('capone') ||
                    nomeCompleto.includes('giuseppina') || nomeCompleto.includes('cozzi') ||
                    nomeCompleto.includes('eileen') || nomeCompleto.includes('king')
                ) {
                    canale = 'Irbema';
                    console.log('‚úÖ Irbema:', nomeCompleto, '(da mappatura Excel)');
                }
                // PRIORIT√Ä 3: Altri canali (Excel, AON, DoubleYou) - solo se campo canale popolato
                else if (canaleField.includes('excel') || leadId.includes('LEAD-EXCEL')) {
                    canale = 'Excel';
                } else if (canaleField.includes('aon')) {
                    canale = 'AON';
                } else if (canaleField.includes('doubleyou') || canaleField.includes('double')) {
                    canale = 'DoubleYou';
                } else if (canaleField.includes('network')) {
                    canale = 'Networking';
                } else {
                    // Se non riconosciuto, rimane Web (default)
                    console.log('‚ö†Ô∏è  Web (default):', nomeCompleto);
                }
                
                channelCounts[canale] = (channelCounts[canale] || 0) + 1;
            });
            
            // DEBUG: Mostra distribuzione finale
            console.log('üìä Distribuzione Canali:', channelCounts);
            
            const total = assistiti.length || 1;
            let html = '';
            
            // Ordina per count discendente
            const sortedChannels = Object.entries(channelCounts).sort((a, b) => b[1] - a[1]);
            
            if (sortedChannels.length === 0) {
                html = '<p class="text-gray-400 text-sm text-center py-4">Nessun dato disponibile</p>';
            } else {
                sortedChannels.forEach(([canale, count]) => {
                    const percentage = Math.round((count / total) * 100);
                    const color = channelColors[canale] || 'bg-gray-500';
                    
                    html += \`
                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-medium text-gray-700">\${canale}</span>
                                <span class="text-sm font-bold text-gray-900">\${count} (\${percentage}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="\${color} h-2 rounded-full" style="width: \${percentage}%"></div>
                            </div>
                        </div>
                    \`;
                });
            }
            
            document.getElementById('channelsDistribution').innerHTML = html;
        }

        // ========== CRUD ASSISTITI (DEFINITE PRIMA DI renderAssistitiTable) ==========
        
        async function viewAssistito(id) {
            try {
                const response = await fetch('/api/assistiti?id=' + id);
                const data = await response.json();
                
                if (data.success && data.assistiti && data.assistiti.length > 0) {
                    const assistito = data.assistiti[0];
                    
                    // Mostra modal dettagli assistito
                    alert('üìã Dettagli Assistito\\n\\n' +
                        'Nome: ' + (assistito.nome_assistito || '') + ' ' + (assistito.cognome_assistito || '') + '\\n' +
                        'Caregiver: ' + (assistito.nome_caregiver || 'N/A') + ' ' + (assistito.cognome_caregiver || '') + '\\n' +
                        'Parentela: ' + (assistito.parentela_caregiver || 'N/A') + '\\n' +
                        'IMEI: ' + (assistito.imei || 'N/A') + '\\n' +
                        'Email: ' + (assistito.email || 'N/A') + '\\n' +
                        'Telefono: ' + (assistito.telefono || 'N/A') + '\\n' +
                        'Piano: ' + (assistito.piano || 'BASE') + '\\n' +
                        'Contratto: ' + (assistito.codice_contratto || 'Nessuno') + '\\n' +
                        'Status: ' + (assistito.contratto_status || assistito.status || 'N/A')
                    );
                } else {
                    alert('‚ùå Assistito non trovato');
                }
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
            }
        }
        window.viewAssistito = viewAssistito;  // Esponi globalmente
        
        async function editAssistito(id) {
            try {
                const response = await fetch('/api/assistiti?id=' + id);
                const data = await response.json();
                
                if (data.success && data.assistiti && data.assistiti.length > 0) {
                    const assistito = data.assistiti[0];
                    
                    // Richiedi nuovi dati
                    const nuovoNome = prompt('Nome Assistito:', assistito.nome_assistito || '');
                    if (!nuovoNome) return;
                    
                    const nuovoCognome = prompt('Cognome Assistito:', assistito.cognome_assistito || '');
                    if (!nuovoCognome) return;
                    
                    const nuovaEmail = prompt('Email:', assistito.email || '');
                    const nuovoTelefono = prompt('Telefono:', assistito.telefono || '');
                    const nuovoIMEI = prompt('IMEI Dispositivo:', assistito.imei || '');
                    
                    const caregiverNome = prompt('Nome Caregiver:', assistito.nome_caregiver || '');
                    const caregiverCognome = prompt('Cognome Caregiver:', assistito.cognome_caregiver || '');
                    const parentela = prompt('Parentela Caregiver:', assistito.parentela_caregiver || '');
                    
                    // Aggiorna
                    const updateResponse = await fetch(\`/api/assistiti/\${id}\`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            nome_assistito: nuovoNome,
                            cognome_assistito: nuovoCognome,
                            nome_caregiver: caregiverNome,
                            cognome_caregiver: caregiverCognome,
                            parentela_caregiver: parentela,
                            email: nuovaEmail,
                            telefono: nuovoTelefono,
                            imei: nuovoIMEI
                        })
                    });
                    
                    const result = await updateResponse.json();
                    
                    if (result.success) {
                        alert('‚úÖ Assistito aggiornato con successo!');
                        loadDashboardData(); // Ricarica dashboard
                    } else {
                        alert('‚ùå Errore: ' + result.error);
                    }
                } else {
                    alert('‚ùå Assistito non trovato');
                }
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
            }
        }
        window.editAssistito = editAssistito;  // Esponi globalmente
        
        async function deleteAssistito(id) {
            // Trova l'assistito nell'array globale per ottenere il nome
            const assistito = allAssistiti.find(a => a.id === id);
            const nome = assistito ? 
                (assistito.nome || ((assistito.nome_assistito || '') + ' ' + (assistito.cognome_assistito || '')).trim() || 'questo assistito') 
                : 'questo assistito';
            
            if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare l\\'assistito ' + nome + '?\\n\\nQuesta azione non pu√≤ essere annullata!')) {
                return;
            }
            
            try {
                const response = await fetch(\`/api/assistiti/\${id}\`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Assistito ' + nome + ' eliminato con successo!');
                    loadDashboardData(); // Ricarica dashboard
                } else {
                    alert('‚ùå Errore: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
            }
        }
        window.deleteAssistito = deleteAssistito;  // Esponi globalmente
        
        async function editAssistito(id) {
            try {
                const response = await fetch('/api/assistiti?id=' + id);
                const data = await response.json();
                
                if (data.success && data.assistiti && data.assistiti.length > 0) {
                    const assistito = data.assistiti[0];
                    
                    // Verifica che il modal esista
                    const modal = document.getElementById('editAssistitoModal');
                    if (!modal) {
                        console.error('Modal editAssistitoModal non trovato');
                        alert('‚ùå Errore: Modal non trovato. Ricaricare la pagina.');
                        return;
                    }
                    
                    // Popola form modal con controlli
                    const setValueSafe = (id, value) => {
                        const el = document.getElementById(id);
                        if (el) el.value = value || '';
                        else console.warn(\`Elemento \${id} non trovato\`);
                    };
                    
                    setValueSafe('editAssistitoId', id);
                    setValueSafe('editNomeAssistito', assistito.nome_assistito);
                    setValueSafe('editCognomeAssistito', assistito.cognome_assistito);
                    setValueSafe('editEmailAssistito', assistito.email);
                    setValueSafe('editTelefonoAssistito', assistito.telefono);
                    setValueSafe('editIMEI', assistito.imei);
                    setValueSafe('editServizioAssistito', assistito.servizio || 'eCura PRO');
                    setValueSafe('editNomeCaregiver', assistito.nome_caregiver);
                    setValueSafe('editCognomeCaregiver', assistito.cognome_caregiver);
                    setValueSafe('editParentela', assistito.parentela_caregiver);
                    setValueSafe('editPianoAssistito', assistito.piano || 'BASE');
                    
                    // Aggiorna prezzi dinamicamente
                    setTimeout(() => updatePrezziServizio(), 100);
                    
                    // Mostra modal
                    modal.classList.remove('hidden');
                } else {
                    alert('‚ùå Assistito non trovato');
                }
            } catch (error) {
                console.error('Errore editAssistito:', error);
                alert('‚ùå Errore: ' + error.message);
            }
        }
        window.editAssistito = editAssistito;  // Esponi globalmente
        
        async function saveEditAssistito() {
            const id = document.getElementById('editAssistitoId').value;
            const nomeAssistito = document.getElementById('editNomeAssistito').value;
            const cognomeAssistito = document.getElementById('editCognomeAssistito').value;
            const email = document.getElementById('editEmailAssistito').value;
            const telefono = document.getElementById('editTelefonoAssistito').value;
            const imei = document.getElementById('editIMEI').value;
            const servizio = document.getElementById('editServizioAssistito').value;
            const nomeCaregiver = document.getElementById('editNomeCaregiver').value;
            const cognomeCaregiver = document.getElementById('editCognomeCaregiver').value;
            const parentela = document.getElementById('editParentela').value;
            const piano = document.getElementById('editPianoAssistito').value;
            
            // DEBUG: Log dei dati raccolti
            console.log('üìù SAVE EDIT ASSISTITO:', {
                id,
                nomeAssistito,
                cognomeAssistito,
                servizio,
                piano,
                email,
                telefono,
                imei
            });
            
            if (!nomeAssistito || !cognomeAssistito || !imei) {
                alert('‚ö†Ô∏è Campi obbligatori: Nome, Cognome e IMEI');
                return;
            }
            
            const payload = {
                nome_assistito: nomeAssistito,
                cognome_assistito: cognomeAssistito,
                email: email,
                telefono: telefono,
                imei: imei,
                servizio: servizio,
                nome_caregiver: nomeCaregiver,
                cognome_caregiver: cognomeCaregiver,
                parentela_caregiver: parentela,
                piano: piano
            };
            
            console.log('üì§ PAYLOAD INVIATO:', payload);
            
            try {
                const response = await fetch(\`/api/assistiti/\${id}\`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                console.log('üì• RISPOSTA SERVER:', result);
                
                if (result.success) {
                    alert('‚úÖ Assistito aggiornato con successo!');
                    closeModal('editAssistitoModal');
                    loadDashboardData();
                } else {
                    alert('‚ùå Errore: ' + result.error);
                    console.error('‚ùå Dettagli errore:', result);
                }
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
                console.error('‚ùå Errore catch:', error);
            }
        }
        window.saveEditAssistito = saveEditAssistito;
        
        // Tabella prezzi eCura (1¬∞ anno)
        const PREZZI_ECURA = {
            'eCura FAMILY': { BASE: 390, AVANZATO: 690, rinnovo_BASE: 200, rinnovo_AVANZATO: 500 },
            'eCura PRO': { BASE: 480, AVANZATO: 840, rinnovo_BASE: 240, rinnovo_AVANZATO: 600 },
            'eCura PREMIUM': { BASE: 590, AVANZATO: 990, rinnovo_BASE: 300, rinnovo_AVANZATO: 750 }
        };
        
        function updatePrezziServizio() {
            const servizio = document.getElementById('editServizioAssistito')?.value || 'eCura PRO';
            const piano = document.getElementById('editPianoAssistito')?.value || 'BASE';
            const prezzoInfo = document.getElementById('prezzoInfo');
            
            if (!prezzoInfo) return;
            
            const prezzi = PREZZI_ECURA[servizio];
            if (!prezzi) return;
            
            const prezzoAnno1 = prezzi[piano];
            const prezzoRinnovo = prezzi['rinnovo_' + piano];
            
            prezzoInfo.innerHTML = 
                '<div class="bg-blue-50 border border-blue-200 rounded-lg p-3">' +
                    '<div class="flex justify-between items-center">' +
                        '<span class="font-semibold text-blue-900">1¬∞ Anno:</span>' +
                        '<span class="text-xl font-bold text-blue-600">‚Ç¨' + prezzoAnno1 + '</span>' +
                    '</div>' +
                    '<div class="flex justify-between items-center mt-1">' +
                        '<span class="text-sm text-gray-600">Rinnovo (dal 2¬∞ anno):</span>' +
                        '<span class="font-semibold text-gray-700">‚Ç¨' + prezzoRinnovo + '/anno</span>' +
                    '</div>' +
                '</div>';
            
            // Aggiorna anche il testo delle opzioni
            const pianoSelect = document.getElementById('editPianoAssistito');
            if (pianoSelect) {
                pianoSelect.innerHTML = 
                    '<option value="BASE" data-prezzo="' + prezzi.BASE + '">BASE - ‚Ç¨' + prezzi.BASE + '/anno</option>' +
                    '<option value="AVANZATO" data-prezzo="' + prezzi.AVANZATO + '">AVANZATO - ‚Ç¨' + prezzi.AVANZATO + '/anno</option>';
                pianoSelect.value = piano; // Ripristina selezione
            }
        }
        window.updatePrezziServizio = updatePrezziServizio;
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        window.closeModal = closeModal;

        function renderAssistitiTable(assistiti) {
            const tbody = document.getElementById('assistitiTable');
            
            // Aggiorna contatore
            document.getElementById('assistitiCount').textContent = assistiti.length;
            
            if (assistiti.length === 0) {
                tbody.innerHTML = '<tr>' +
                    '<td colspan="9" class="py-8 text-center text-gray-400">' +
                        '<i class="fas fa-users text-3xl mb-2"></i><br>' +
                        'Nessun assistito attivo trovato' +
                    '</td>' +
                '</tr>';
                return;
            }
            
            tbody.innerHTML = assistiti.map(assistito => {
                // Dati assistito reali con nuovi campi
                const nomeAssistito = assistito.nome_assistito || '';
                const cognomeAssistito = assistito.cognome_assistito || '';
                const nomeCompleto = assistito.nome || (nomeAssistito + ' ' + cognomeAssistito).trim() || 'N/A';
                const caregiverNome = assistito.nome_caregiver || '';
                const caregiverCognome = assistito.cognome_caregiver || '';
                const caregiver = (caregiverNome + ' ' + caregiverCognome).trim() || 'N/A';
                const parentela = assistito.parentela_caregiver || 'N/A';
                const imei = assistito.imei || 'N/A';
                const email = assistito.email || 'N/A';
                const telefono = assistito.telefono || 'N/A';
                const servizio = assistito.servizio || 'eCura PRO';
                const piano = assistito.piano || 'BASE';
                
                // Calcola prezzo dinamico
                const PREZZI_ECURA_TABLE = {
                    'eCura FAMILY': { BASE: 390, AVANZATO: 690 },
                    'eCura PRO': { BASE: 480, AVANZATO: 840 },
                    'eCura PREMIUM': { BASE: 590, AVANZATO: 990 }
                };
                const prezzoAnno = PREZZI_ECURA_TABLE[servizio]?.[piano] || 480;
                
                const status = assistito.status || 'ATTIVO';
                const codice = assistito.codice_contratto || assistito.codice || 'N/A';
                const assistitoId = assistito.id;
                
                // Status badge colors
                const statusColors = {
                    'ATTIVO': 'bg-green-100 text-green-700',
                    'FIRMATO': 'bg-green-100 text-green-700',
                    'INVIATO': 'bg-blue-100 text-blue-700',
                    'CONVERTITO': 'bg-purple-100 text-purple-700'
                };
                const statusColor = statusColors[status] || 'bg-gray-100 text-gray-700';
                
                // Piano badge colors
                const pianoColor = piano === 'AVANZATO' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';
                
                return '<tr class="border-b border-gray-100 hover:bg-gray-50">' +
                    '<td class="py-3 px-2">' +
                        '<div class="font-semibold text-sm text-gray-800">' + nomeCompleto + '</div>' +
                        '<div class="text-xs text-gray-500 mt-1">' +
                            '<i class="fas fa-user-friends mr-1"></i>' + caregiver + ' (' + parentela + ')' +
                        '</div>' +
                    '</td>' +
                    '<td class="py-3 px-2 text-center">' +
                        '<code class="bg-gray-100 px-2 py-1 rounded font-mono text-xs">' + imei + '</code>' +
                    '</td>' +
                    '<td class="py-3 px-2 text-sm text-gray-700">' +
                        '<div><i class="fas fa-envelope text-gray-400 mr-1"></i>' + email + '</div>' +
                    '</td>' +
                    '<td class="py-3 px-2 text-sm text-gray-700">' +
                        '<div><i class="fas fa-phone text-gray-400 mr-1"></i>' + telefono + '</div>' +
                    '</td>' +
                    '<td class="py-3 px-2 text-center">' +
                        '<span class="px-3 py-1 bg-purple-100 text-purple-700 text-xs font-medium rounded-full">' + servizio + '</span>' +
                    '</td>' +
                    '<td class="py-3 px-2 text-center">' +
                        '<span class="px-3 py-1 ' + pianoColor + ' text-xs font-medium rounded-full">' + piano + '</span>' +
                    '</td>' +
                    '<td class="py-3 px-2 text-center">' +
                        '<div class="font-bold text-green-600 text-base">‚Ç¨' + prezzoAnno + '</div>' +
                        '<div class="text-xs text-gray-500">/anno</div>' +
                    '</td>' +
                    '<td class="py-3 px-2 text-center">' +
                        '<span class="px-3 py-1 ' + statusColor + ' text-xs font-medium rounded-full">' + status + '</span>' +
                    '</td>' +
                    '<td class="py-3 px-2 text-center">' +
                        '<div class="flex justify-center gap-1">' +
                            '<button onclick="window.viewAssistito(' + assistitoId + ')" class="text-blue-600 hover:text-blue-800 hover:bg-blue-50 p-1 rounded transition text-sm" title="Visualizza">' +
                                '<i class="fas fa-eye"></i>' +
                            '</button>' +
                            '<button onclick="window.editAssistito(' + assistitoId + ')" class="text-yellow-600 hover:text-yellow-800 hover:bg-yellow-50 p-1 rounded transition text-sm" title="Modifica">' +
                                '<i class="fas fa-edit"></i>' +
                            '</button>' +
                            '<button onclick="window.deleteAssistito(' + assistitoId + ')" class="text-red-600 hover:text-red-800 hover:bg-red-50 p-1 rounded transition text-sm" title="Elimina">' +
                                '<i class="fas fa-trash"></i>' +
                            '</button>' +
                        '</div>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        // Variabile globale per tenere tutti gli assistiti
        let allAssistiti = [];

        function filterAssistiti() {
            const searchTerm = document.getElementById('searchAssistitoCognome').value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderAssistitiTable(allAssistiti);
                return;
            }

            const filtered = allAssistiti.filter(assistito => {
                const nomeAssistito = (assistito.nome_assistito || '').toLowerCase();
                const cognomeAssistito = (assistito.cognome_assistito || '').toLowerCase();
                const nomeCompleto = (assistito.nome || '').toLowerCase();
                const caregiverNome = (assistito.nome_caregiver || '').toLowerCase();
                const caregiverCognome = (assistito.cognome_caregiver || '').toLowerCase();
                
                return nomeAssistito.includes(searchTerm) || 
                       cognomeAssistito.includes(searchTerm) ||
                       nomeCompleto.includes(searchTerm) ||
                       caregiverNome.includes(searchTerm) ||
                       caregiverCognome.includes(searchTerm);
            });

            renderAssistitiTable(filtered);
        }

        function updateChannelsChart(leads) {
            const leadsToUse = window.allLeadsData || leads;
            const channelCounts = {};
            
            // Conta i lead per canale
            leadsToUse.forEach(lead => {
                let channel = 'Non specificato';
                
                // Cerca il canale nel campo canale o nelle note
                if (lead.canale && lead.canale.trim() !== '') {
                    channel = lead.canale;
                } else if (lead.note) {
                    // Cerca pattern comuni nelle note
                    if (lead.note.includes('Irbema') || lead.note.includes('IRBEMA')) {
                        channel = 'Irbema';
                    } else if (lead.note.includes('AON')) {
                        channel = 'AON';
                    } else if (lead.note.includes('Double You')) {
                        channel = 'Double You';
                    } else if (lead.note.includes('Excel')) {
                        channel = 'Excel Import';
                    }
                }
                
                channelCounts[channel] = (channelCounts[channel] || 0) + 1;
            });

            const total = leadsToUse.length || 1;
            const colors = ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-orange-500', 'bg-pink-500', 'bg-indigo-500', 'bg-yellow-500'];
            
            const html = Object.entries(channelCounts)
                .sort(([,a], [,b]) => b - a) // Ordina per count decrescente
                .map(([channel, count], index) => {
                    const percentage = Math.round((count / total) * 100);
                    const color = colors[index % colors.length];
                    return \`
                        <div class="p-4 border-2 border-gray-200 rounded-lg hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-bold text-gray-800">\${channel}</span>
                                <i class="fas fa-chart-pie text-gray-400"></i>
                            </div>
                            <div class="text-2xl font-bold text-gray-900 mb-1">\${count}</div>
                            <div class="text-xs text-gray-500 mb-2">\${percentage}% del totale</div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="\${color} h-2 rounded-full" style="width: \${percentage}%"></div>
                            </div>
                        </div>
                    \`;
                }).join('');

            document.getElementById('channelsChart').innerHTML = html || '<p class="text-gray-400 text-sm col-span-3 text-center">Nessun dato disponibile</p>';
        }

        // Funzioni Import API
        function importFromExcel() {
            alert('üìã IMPORT DA EXCEL\\n\\n' +
                  'üìÅ Preparazione file Excel richiesta:\\n\\n' +
                  '1Ô∏è‚É£ Usa il template Excel gi√† popolato\\n' +
                  '2Ô∏è‚É£ Compila i campi richiesti:\\n' +
                  '   ‚Ä¢ Colonna B: DATA DI ARRIVO RICHIESTA\\n' +
                  '   ‚Ä¢ Colonna F: CANALE (info@irbema.com, diretto, ecc.)\\n' +
                  '   ‚Ä¢ Colonna G: NOME E COGNOME\\n' +
                  '   ‚Ä¢ Colonna I: E-MAIL\\n' +
                  '   ‚Ä¢ Colonna J: CONTATTO TELEFONICO\\n\\n' +
                  '3Ô∏è‚É£ Il sistema assegner√† automaticamente:\\n' +
                  '   ‚Ä¢ ID progressivi (LEAD-CANALE-00130, 00131...)\\n' +
                  '   ‚Ä¢ Status: NEW o CONVERTED\\n' +
                  '   ‚Ä¢ Canale: IRBEMA, WEB, NETWORKING, ecc.\\n\\n' +
                  '‚úÖ I nuovi lead saranno AGGIUNTI senza cancellare gli esistenti.\\n\\n' +
                  'üöß Funzionalit√† in sviluppo - contatta l\\'amministratore.');
        }
        window.importFromExcel = importFromExcel;  // Esponi globalmente

        async function importFromIrbema() {
            if (!confirm('Vuoi importare i lead da Irbema (HubSpot)?\\n\\nQuesta operazione:\\n- Scaricher√† i nuovi lead da HubSpot\\n- Filtrer√† solo i lead da ecura.it\\n- Aggiorner√† il database\\n\\nProcedi?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/import/irbema', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Import Irbema completato!\\n\\n' +
                          'Lead importati: ' + result.imported + '\\n' +
                          'Lead skippati: ' + result.skipped + '\\n' +
                          'Totale contatti: ' + result.total + '\\n' +
                          'Pagine processate: ' + result.pages);
                    
                    // Ricarica la tabella assistiti
                    if (typeof window.loadAssistitiData === 'function') {
                        window.loadAssistitiData();
                    } else {
                        // Fallback: reload pagina
                        location.reload();
                    }
                } else {
                    alert('Errore import: ' + result.error);
                }
            } catch (error) {
                alert('Errore di comunicazione: ' + error.message);
            }
        }

        function importFromAON() {
            alert('üîÑ Import da AON\\n\\nFunzionalit√† in sviluppo.\\n\\nEndpoint: POST /api/import/aon\\n\\nQuesta funzionalit√† permetter√† di importare lead dal partner AON.');
        }

        function importFromDoubleYou() {
            alert('üîÑ Import da DoubleYou\\n\\nFunzionalit√† in sviluppo.\\n\\nEndpoint: POST /api/import/doubleyou\\n\\nQuesta funzionalit√† permetter√† di importare lead dal partner DoubleYou.');
        }

        // üóëÔ∏è CLEAN IMPORT: Cancella e reimporta i 129 lead dall'Excel
    <\/script>

    <!-- MODAL: EDIT ASSISTITO -->
    <div id="editAssistitoModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="gradient-bg text-white px-6 py-4 rounded-t-lg flex justify-between items-center">
                <h3 class="text-xl font-bold">‚úèÔ∏è Modifica Assistito</h3>
                <button onclick="closeModal('editAssistitoModal')" class="text-white hover:text-gray-200 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <input type="hidden" id="editAssistitoId">
                
                <h4 class="font-bold text-gray-700 mb-3 border-b pb-2">üë§ Dati Assistito</h4>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome *</label>
                        <input type="text" id="editNomeAssistito" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cognome *</label>
                        <input type="text" id="editCognomeAssistito" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="editEmailAssistito" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Telefono</label>
                        <input type="tel" id="editTelefonoAssistito" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">IMEI Dispositivo *</label>
                        <input type="text" id="editIMEI" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Servizio</label>
                        <select id="editServizioAssistito" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="updatePrezziServizio()">
                            <option value="eCura FAMILY">eCura FAMILY (SiDLY CARE PRO)</option>
                            <option value="eCura PRO">eCura PRO (SiDLY CARE PRO)</option>
                            <option value="eCura PREMIUM">eCura PREMIUM (SiDLY VITAL CARE)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Piano</label>
                        <select id="editPianoAssistito" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="updatePrezziServizio()">
                            <option value="BASE" data-prezzo="480">BASE - ‚Ç¨480/anno</option>
                            <option value="AVANZATO" data-prezzo="840">AVANZATO - ‚Ç¨840/anno</option>
                        </select>
                        <div id="prezzoInfo" class="mt-2 text-sm text-gray-600"></div>
                    </div>
                </div>
                
                <h4 class="font-bold text-gray-700 mb-3 border-b pb-2">üë®‚Äçüë©‚Äçüë¶ Dati Caregiver</h4>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome Caregiver</label>
                        <input type="text" id="editNomeCaregiver" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cognome Caregiver</label>
                        <input type="text" id="editCognomeCaregiver" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Parentela</label>
                        <input type="text" id="editParentela" placeholder="es. Figlio, Figlia, Coniuge..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="flex justify-end gap-3">
                    <button onclick="closeModal('editAssistitoModal')" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                        Annulla
                    </button>
                    <button onclick="saveEditAssistito()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        üíæ Salva Modifiche
                    </button>
                </div>
            </div>
        </div>
    </div>

    ${Fp}
</body>
</html>
`,dw=`<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Leads - TeleMedCare V12.0</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-users text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Dashboard Leads Modulare</h1>
                        <p class="text-green-100">Aggregazione dati dai 6 moduli Leads specializzati</p>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <button onclick="openNewLeadModal()" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-plus mr-2"></i>Nuovo Lead
                    </button>
                    <a href="/" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-home mr-2"></i>Home
                    </a>
                    <a href="/dashboard" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-chart-line mr-2"></i>Dashboard
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Statistiche Lead -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Lead Totali</p>
                        <p class="text-3xl font-bold text-blue-600" id="totalLeads">-</p>
                        <p class="text-xs text-green-600 mt-1">
                            <i class="fas fa-arrow-up mr-1"></i>
                            <span id="leadsGrowth">+0%</span> vs mese scorso
                        </p>
                    </div>
                    <i class="fas fa-users text-3xl text-blue-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Tasso Conversione</p>
                        <p class="text-3xl font-bold text-green-600" id="conversionRate">-</p>
                        <p class="text-xs text-gray-500 mt-1">Lead ‚Üí Contratto</p>
                    </div>
                    <i class="fas fa-percentage text-3xl text-green-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Lead Oggi</p>
                        <p class="text-3xl font-bold text-purple-600" id="leadsToday">-</p>
                        <p class="text-xs text-gray-500 mt-1">Ultime 24h</p>
                    </div>
                    <i class="fas fa-calendar-day text-3xl text-purple-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-orange-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Valore Totale</p>
                        <p class="text-3xl font-bold text-orange-600" id="totalValue">-</p>
                        <p class="text-xs text-gray-500 mt-1">Contratti attivi</p>
                    </div>
                    <i class="fas fa-euro-sign text-3xl text-orange-500"></i>
                </div>
            </div>
        </div>

        <!-- Grafici Distribuzione -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Servizi -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-pie text-blue-500 mr-2"></i>
                    Per Servizio
                </h3>
                <div id="servicesBreakdown" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Piani -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-layer-group text-green-500 mr-2"></i>
                    Per Piano
                </h3>
                <div id="plansBreakdown" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Canali -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-bullhorn text-purple-500 mr-2"></i>
                    Per Canale
                </h3>
                <div id="channelsBreakdown">
                    <div class="space-y-2">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600">Website</span>
                            <span class="font-bold" id="channelWeb">-</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600">Partner</span>
                            <span class="font-bold" id="channelPartner">-</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600">Networking</span>
                            <span class="font-bold" id="channelNetworking">-</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600">Email</span>
                            <span class="font-bold" id="channelEmail">-</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600">Telefono</span>
                            <span class="font-bold" id="channelPhone">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabella Lead Dettagliata -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-table text-blue-500 mr-2"></i>
                    Tutti i Lead
                </h3>
                <div class="flex space-x-2">
                    <input 
                        type="text" 
                        id="searchCognome" 
                        class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-64" 
                        placeholder="üîç Cerca per cognome..."
                        onkeyup="applyFilters()"
                    />
                    <select id="filterServizio" class="border border-gray-300 rounded-lg px-3 py-2 text-sm" onchange="applyFilters()">
                        <option value="">Tutti i Servizi</option>
                        <option value="FAMILY">FAMILY</option>
                        <option value="PRO">PRO</option>
                        <option value="PREMIUM">PREMIUM</option>
                    </select>
                    <select id="filterPiano" class="border border-gray-300 rounded-lg px-3 py-2 text-sm" onchange="applyFilters()">
                        <option value="">Tutti i Piani</option>
                        <option value="BASE">BASE</option>
                        <option value="AVANZATO">AVANZATO</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-200 text-left">
                            <th class="pb-3 text-sm font-semibold text-gray-600">Lead ID</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Cliente</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Contatti</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Servizio</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Piano</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Prezzo Anno</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Contratto</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Brochure</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Data</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Azioni</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">CRUD</th>
                        </tr>
                    </thead>
                    <tbody id="leadsTableBody">
                        <tr>
                            <td colspan="11" class="py-8 text-center text-gray-400">
                                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                <p>Caricamento lead...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Helper function to escape HTML special characters
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        let allLeads = [];

        // Carica dati
        loadLeadsData();

        async function loadLeadsData() {
            try {
                // Carica statistiche
                const statsResponse = await fetch('/api/data/stats');
                const stats = await statsResponse.json();

                document.getElementById('totalLeads').textContent = stats.totalLeads || '0';
                document.getElementById('conversionRate').textContent = stats.conversionRate || '0%';
                document.getElementById('leadsToday').textContent = stats.leadsToday || '0';
                document.getElementById('totalValue').textContent = stats.totalValue ? ('‚Ç¨' + stats.totalValue) : '‚Ç¨0';
                document.getElementById('leadsGrowth').textContent = stats.leadsGrowth || '+0%';

                // Carica lead
                const leadsResponse = await fetch('/api/leads?limit=200');
                const leadsData = await leadsResponse.json();
                allLeads = leadsData.leads || [];
                
                // ‚úÖ USA IL TOTALE REALE DAL SERVER (non allLeads.length)
                const totalLeads = leadsData.total || allLeads.length;
                
                // Calcola revenue totale SOLO dai contratti FIRMATI
                const contrattiResponse = await fetch('/api/contratti');
                const contrattiData = await contrattiResponse.json();
                const contratti = contrattiData.contracts || contrattiData.contratti || contrattiData.data || [];
                
                // TASK #1-2 FIX: Filtra solo contratti SIGNED o ACTIVE
                const contrattiFirmati = contratti.filter(c => 
                    c.status === 'SIGNED' || 
                    c.status === 'ACTIVE' || 
                    c.status === 'signed' || 
                    c.status === 'active'
                );
                
                // Calcola il tasso di conversione: contratti firmati / total leads
                const converted = contrattiFirmati.length;
                const conversionRate = totalLeads > 0 ? ((converted / totalLeads) * 100).toFixed(1) + '%' : '0%';
                
                // Calcola revenue totale SOLO dai contratti firmati
                let totalValue = 0;
                contrattiFirmati.forEach(c => {
                    if (c.prezzo_totale) totalValue += parseFloat(c.prezzo_totale);
                });
                const today = new Date().toISOString().split('T')[0];
                const leadsToday = allLeads.filter(l => l.created_at && l.created_at.startsWith(today)).length;
                
                // Update KPIs
                document.getElementById('totalLeads').textContent = totalLeads;
                document.getElementById('conversionRate').textContent = conversionRate;
                document.getElementById('leadsToday').textContent = leadsToday;
                document.getElementById('totalValue').textContent = '‚Ç¨' + totalValue;
                document.getElementById('leadsGrowth').textContent = '+0%'; // TODO

                // Aggiorna grafici
                updateServicesBreakdown(allLeads);
                updatePlansBreakdown(allLeads);
                updateChannelsBreakdown(allLeads);

                // Popola tabella
                renderLeadsTable(allLeads);

            } catch (error) {
                console.error('Errore caricamento leads:', error);
                document.getElementById('leadsTableBody').innerHTML = \`
                    <tr>
                        <td colspan="9" class="py-8 text-center text-red-500">
                            <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                            <p>Errore nel caricamento dei lead</p>
                        </td>
                    </tr>
                \`;
            }
        }

        function updateServicesBreakdown(leads) {
            const total = leads.length || 1;
            
            // TUTTI i lead sono eCura PRO
            const html = \`
                <div>
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-medium">eCura PRO</span>
                        <span class="text-sm font-bold">\${total} (100%)</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-purple-500 h-2 rounded-full" style="width: 100%"></div>
                    </div>
                </div>
            \`;

            document.getElementById('servicesBreakdown').innerHTML = html;
        }

        function updatePlansBreakdown(leads) {
            const counts = { 'BASE': 0, 'AVANZATO': 0 };
            leads.forEach(l => {
                // PRIORITY: piano > note > default BASE
                // NOTA: tipoServizio contiene il SERVIZIO (es. "eCura PRO"), NON il piano!
                let plan = 'BASE'; // default
                
                if (l.piano) {
                    // Nuovo campo piano (dopo migration 0006)
                    plan = l.piano.toUpperCase() === 'AVANZATO' ? 'AVANZATO' : 'BASE';
                } else if (l.note) {
                    // Fallback: cerca nelle note
                    plan = l.note.includes('Piano: AVANZATO') || l.note.includes('AVANZATO') ? 'AVANZATO' : 'BASE';
                }
                
                counts[plan]++;
            });

            const total = leads.length || 1;
            const colors = { 'BASE': 'bg-blue-500', 'AVANZATO': 'bg-purple-500' };

            const html = Object.entries(counts).map(([plan, count]) => {
                const percentage = Math.round((count / total) * 100);
                return \`
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium">\${plan}</span>
                            <span class="text-sm font-bold">\${count} (\${percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="\${colors[plan]} h-2 rounded-full" style="width: \${percentage}%"></div>
                        </div>
                    </div>
                \`;
            }).join('');

            document.getElementById('plansBreakdown').innerHTML = html;
        }

        function updateChannelsBreakdown(leads) {
            const channels = {};
            leads.forEach(l => {
                // TASK #3 FIX: Priorit√† corretta dei campi
                const ch = l.canaleAcquisizione || l.fonte || l.canale || 'Non specificato';
                channels[ch] = (channels[ch] || 0) + 1;
            });
            
            // Debug: mostra tutti i canali trovati
            console.log('üìä Canali rilevati:', channels);
            console.log('üìä Total leads:', leads.length);
            console.log('üìä Sample lead fields:', leads[0] ? Object.keys(leads[0]).filter(k => k.includes('fonte') || k.includes('canal') || k.includes('source')) : []);
            
            // Debug: Cerca lead con fonte che inizia con WEB
            const webLeads = leads.filter(l => {
                const fonte = (l.canaleAcquisizione || l.fonte || l.canale || '').toLowerCase();
                return fonte.includes('web') && !fonte.includes('doubleyou');
            });
            console.log('üìä Lead con "web" nella fonte:', webLeads.length, webLeads.map(l => ({ id: l.id, nome: l.nomeRichiedente + ' ' + l.cognomeRichiedente, fonte: l.fonte })));
            
            // Mostra i canali reali aggregati
            // Web: Website, EXCEL_IMPORT, Excel, Landing Page, Web, website, WEB
            // Partner: Irbema, AON, DoubleYou, CONTRATTO_PDF, Partner
            // Networking: Networking, NETWORKING, Network
            // Email: EMAIL, Email
            // Telefono: TELEFONO, Telefono, Phone
            
            // Aggregazione intelligente dei canali
            let webCount = 0;
            let partnerCount = 0;
            let networkingCount = 0;
            let emailCount = 0;
            let phoneCount = 0;
            let nonSpecificato = 0;
            
            // Itera su tutti i canali e classifica in base al contenuto
            Object.keys(channels).forEach(channel => {
                const channelLower = channel.toLowerCase();
                const count = channels[channel];
                
                // Partner: IRBEMA, AON, DoubleYou, Partner
                if (channelLower.includes('irbema') || 
                    channelLower.includes('aon') || 
                    channelLower.includes('doubleyou') || 
                    channelLower.includes('partner') ||
                    channelLower.includes('affiliato') ||
                    channelLower.includes('contratto_pdf')) {
                    partnerCount += count;
                }
                // Web: Website, WEB, Landing, Test, Dashboard, Excel
                else if (channelLower.includes('web') || 
                         channelLower.includes('landing') || 
                         channelLower.includes('website') ||
                         channelLower.includes('test') ||
                         channelLower.includes('dashboard') ||
                         channelLower.includes('manual') ||
                         channelLower.includes('excel')) {
                    webCount += count;
                }
                // Networking: NETWORKING, Network
                else if (channelLower.includes('network')) {
                    networkingCount += count;
                }
                // Email: EMAIL, Email
                else if (channelLower.includes('email') || channelLower.includes('mail')) {
                    emailCount += count;
                }
                // Telefono: TELEFONO, Phone
                else if (channelLower.includes('telefono') || 
                         channelLower.includes('phone') || 
                         channelLower.includes('tel')) {
                    phoneCount += count;
                }
                // Non specificato
                else if (channelLower === 'non specificato' || channel === '') {
                    nonSpecificato += count;
                }
                // Altro ‚Üí aggiungi a Web (canale generico)
                else {
                    webCount += count;
                }
            });
            
            document.getElementById('channelWeb').textContent = webCount;
            document.getElementById('channelPartner').textContent = partnerCount;
            document.getElementById('channelNetworking').textContent = networkingCount;
            document.getElementById('channelEmail').textContent = emailCount;
            document.getElementById('channelPhone').textContent = phoneCount;
            
            // Se tutto √® zero, mostra messaggio debug
            if (webCount === 0 && emailCount === 0 && phoneCount === 0 && partnerCount === 0) {
                console.warn('‚ö†Ô∏è ATTENZIONE: Tutti i canali sono zero! Verifica che il campo "fonte" sia popolato nel DB.');
                console.warn('‚ö†Ô∏è Leads senza fonte:', nonSpecificato);
            }
        }

        function renderLeadsTable(leads) {
            const tbody = document.getElementById('leadsTableBody');
            
            if (leads.length === 0) {
                tbody.innerHTML = \`
                    <tr>
                        <td colspan="11" class="py-8 text-center text-gray-400">Nessun lead trovato</td>
                    </tr>
                \`;
                return;
            }

            tbody.innerHTML = leads.map(lead => {
                // PRIORITY: piano > note > default BASE
                // NOTA: tipoServizio contiene il SERVIZIO, NON il piano!
                let piano = 'BASE';
                if (lead.piano) {
                    piano = lead.piano.toUpperCase() === 'AVANZATO' ? 'AVANZATO' : 'BASE';
                } else if (lead.note && lead.note.includes('Piano: AVANZATO')) {
                    piano = 'AVANZATO';
                }
                
                // ‚úÖ USA PREZZO DAL DATABASE (IVA esclusa)
                const prezzo = lead.prezzo_anno || 0;
                const date = new Date(lead.created_at).toLocaleDateString('it-IT');
                // Usa il campo vuoleContratto dal lead
                const hasContract = lead.vuoleContratto === 'Si' || lead.vuoleContratto === true;
                
                // Mostra servizio cos√¨ com'√® dal DB (gi√† con "eCura" se presente)
                const servizio = lead.servizio || lead.tipoServizio || 'eCura PRO';
                
                return \`
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 text-xs">
                            <code class="bg-gray-100 px-2 py-1 rounded">\${(lead.id || '').substring(0, 20)}</code>
                        </td>
                        <td class="py-3 text-sm">
                            <div class="font-medium">\${(lead.nomeRichiedente && lead.cognomeRichiedente) ? escapeHtml(lead.nomeRichiedente + ' ' + lead.cognomeRichiedente) : escapeHtml(lead.emailRichiedente || lead.email || 'N/A')}</div>
                        </td>
                        <td class="py-3 text-sm">
                            <div class="text-xs text-gray-600">
                                <i class="fas fa-envelope text-gray-400 mr-1"></i>\${escapeHtml(lead.emailRichiedente || lead.email) || '-'}
                            </div>
                            <div class="text-xs text-gray-600 mt-1">
                                <i class="fas fa-phone text-gray-400 mr-1"></i>\${escapeHtml(lead.telefonoRichiedente || lead.telefono) || '-'}
                            </div>
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded font-medium">
                                \${servizio}
                            </span>
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded font-medium">
                                \${piano}
                            </span>
                        </td>
                        <td class="py-3 text-sm font-bold text-green-600">‚Ç¨\${prezzo}</td>
                        <td class="py-3">
                            <i class="fas fa-\${hasContract ? 'check-circle text-green-500' : 'times-circle text-gray-300'}"></i>
                        </td>
                        <td class="py-3">
                            <i class="fas fa-\${lead.vuoleBrochure === 'Si' ? 'check-circle text-green-500' : 'times-circle text-gray-300'}"></i>
                        </td>
                        <td class="py-3 text-xs text-gray-500">\${date}</td>
                        <td class="py-3">
                            <div class="flex space-x-1">
                                <button 
                                    onclick="sendContract('\${lead.id}', '\${piano}')" 
                                    class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors"
                                    title="Invia Contratto \${piano}">
                                    <i class="fas fa-file-contract"></i>
                                </button>
                                <button 
                                    onclick="sendBrochure('\${lead.id}')" 
                                    class="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition-colors"
                                    title="Invia Brochure">
                                    <i class="fas fa-book"></i>
                                </button>
                                <button 
                                    onclick="requestCompletion('\${lead.id}')" 
                                    class="px-2 py-1 bg-purple-500 text-white text-xs rounded hover:bg-purple-600 transition-colors"
                                    title="Richiedi Completamento">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </td>
                        <td class="py-3">
                            <div class="flex space-x-1">
                                <button onclick="viewLead('\${lead.id}')" 
                                        class="text-blue-600 hover:text-blue-800 px-1" 
                                        title="Visualizza">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="editLead('\${lead.id}')" 
                                        class="text-green-600 hover:text-green-800 px-1" 
                                        title="Modifica">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteLead('\${lead.id}')" 
                                        class="text-red-600 hover:text-red-800 px-1" 
                                        title="Elimina">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                \`;
            }).join('');
        }

        function applyFilters() {
            const servizioFilter = document.getElementById('filterServizio').value;
            const pianoFilter = document.getElementById('filterPiano').value;
            const searchCognome = document.getElementById('searchCognome').value.toLowerCase().trim();

            const filtered = allLeads.filter(lead => {
                // Filtro Servizio: cerca nel campo servizio o tipoServizio del DB
                // Normalizza: "eCura PRO" -> "PRO", "eCura FAMILY" -> "FAMILY"
                let leadServizio = lead.servizio || lead.tipoServizio || '';
                
                // Rimuovi "eCura " se presente per normalizzare
                if (leadServizio.includes('eCura')) {
                    leadServizio = leadServizio.replace(/eCuras*/i, '').trim();
                }
                
                const matchServizio = !servizioFilter || leadServizio.toUpperCase() === servizioFilter.toUpperCase();
                
                // Filtro Piano: cerca nel campo piano o nelle note come fallback
                let leadPiano = 'BASE'; // default
                if (lead.piano) {
                    leadPiano = lead.piano.toUpperCase() === 'AVANZATO' ? 'AVANZATO' : 'BASE';
                } else if (lead.note) {
                    leadPiano = (lead.note.includes('Piano: AVANZATO') || lead.note.includes('AVANZATO')) ? 'AVANZATO' : 'BASE';
                }
                const matchPiano = !pianoFilter || leadPiano === pianoFilter;
                
                // Filtro cognome: cerca in cognomeRichiedente o cognomeAssistito
                const cognomeRichiedente = (lead.cognomeRichiedente || '').toLowerCase();
                const cognomeAssistito = (lead.cognomeAssistito || '').toLowerCase();
                const matchCognome = !searchCognome || 
                    cognomeRichiedente.includes(searchCognome) || 
                    cognomeAssistito.includes(searchCognome);
                
                return matchServizio && matchPiano && matchCognome;
            });

            renderLeadsTable(filtered);
        }

        function getPrezzoForService(servizio, piano) {
            const prezzi = {
                'FAMILY': { 'BASE': '390.00', 'AVANZATO': '690.00' },
                'PRO': { 'BASE': '480.00', 'AVANZATO': '840.00' },
                'PREMIUM': { 'BASE': '590.00', 'AVANZATO': '990.00' }
            };
            return prezzi[servizio]?.[piano] || '0.00';
        }

        // Funzioni per invio manuale documenti
        async function sendContract(leadId, piano) {
            if (!confirm(\`Generare e inviare contratto \${piano} al lead?\`)) {
                return;
            }
            
            try {
                const response = await fetch(\`/api/leads/\${leadId}/send-contract\`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tipoContratto: piano })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Contratto inviato con successo!\\n\\nCodice: ' + (result.contractCode || 'N/A') + '\\nTemplate: email_invio_contratto');
                    loadLeadsData(); // Ricarica i dati
                } else {
                    alert('‚ùå Errore: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Errore di comunicazione: ' + error.message);
            }
        }

        async function sendBrochure(leadId) {
            if (!confirm('Inviare brochure al lead?')) {
                return;
            }
            
            try {
                const response = await fetch(\`/api/leads/\${leadId}/send-brochure\`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Brochure inviata con successo!\\nTemplate: email_invio_brochure');
                    loadLeadsData(); // Ricarica i dati
                } else {
                    alert('‚ùå Errore: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Errore di comunicazione: ' + error.message);
            }
        }

        async function requestCompletion(leadId) {
            if (!confirm('Inviare email di richiesta completamento dati al lead?')) {
                return;
            }
            
            try {
                const response = await fetch(\`/api/leads/\${leadId}/request-completion?sendEmail=true\`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Email di completamento inviata con successo!\\nLink: ' + (result.token?.completionUrl || result.completionUrl) + '\\nScadenza: ' + (result.token?.expiresAt || result.expiresAt));
                    loadLeadsData(); // Ricarica i dati
                } else {
                    // Gestisci caso lead gi√† completo
                    if (result.error && result.error.includes('gi√† completo')) {
                        alert('‚ÑπÔ∏è Tutti i dati del lead sono gi√† completi.\\n\\nNon √® necessario inviare l\\'email di richiesta completamento.');
                    } else {
                        alert('‚ùå Errore: ' + result.error);
                    }
                }
            } catch (error) {
                alert('‚ùå Errore di comunicazione: ' + error.message);
            }
        }

        // ============================================
        // CRUD FUNCTIONS - VIEW, EDIT, DELETE LEAD
        // ============================================
        
        function viewLead(leadId) {
            const lead = allLeads.find(l => l.id === leadId);
            if (!lead) {
                alert('‚ùå Lead non trovato');
                return;
            }
            
            // Mostra servizio e piano dal DB (se esistono i campi)
            // NOTA: tipoServizio contiene il SERVIZIO, non il piano!
            const servizio = lead.servizio || lead.tipoServizio || 'eCura PRO';
            const piano = lead.piano || 'BASE';  // Piano estratto dalle note durante migration
            
            document.getElementById('viewLeadId').textContent = lead.id;
            document.getElementById('viewNome').textContent = lead.nomeRichiedente || '-';
            document.getElementById('viewCognome').textContent = lead.cognomeRichiedente || '-';
            document.getElementById('viewEmail').textContent = lead.emailRichiedente || lead.email || '-';
            document.getElementById('viewTelefono').textContent = lead.telefonoRichiedente || lead.telefono || '-';
            document.getElementById('viewServizio').textContent = servizio;
            document.getElementById('viewPiano').textContent = piano;
            document.getElementById('viewNote').textContent = lead.note || '-';
            document.getElementById('viewData').textContent = new Date(lead.created_at).toLocaleDateString('it-IT');
            
            openModal('viewLeadModal');
        }
        
        function editLead(leadId) {
            const lead = allLeads.find(l => l.id === leadId);
            if (!lead) {
                alert('‚ùå Lead non trovato');
                return;
            }
            
            // Usa lo stesso modal del nuovo lead, ma con dati pre-compilati
            // Imposta flag edit mode
            window.editingLeadId = leadId;
            
            // Pre-compila TUTTI i campi
            document.getElementById('newNome').value = lead.nomeRichiedente || '';
            document.getElementById('newCognome').value = lead.cognomeRichiedente || '';
            document.getElementById('newEmail').value = lead.emailRichiedente || lead.email || '';
            document.getElementById('newTelefono').value = lead.telefonoRichiedente || lead.telefono || '';
            
            document.getElementById('newNomeAssistito').value = lead.nomeAssistito || '';
            document.getElementById('newCognomeAssistito').value = lead.cognomeAssistito || '';
            document.getElementById('newLuogoNascita').value = lead.luogoNascitaAssistito || '';
            document.getElementById('newDataNascita').value = lead.dataNascitaAssistito || '';
            document.getElementById('newIndirizzoAssistito').value = lead.indirizzoAssistito || '';
            document.getElementById('newCapAssistito').value = lead.capAssistito || '';
            document.getElementById('newCittaAssistito').value = lead.cittaAssistito || '';
            document.getElementById('newProvinciaAssistito').value = lead.provinciaAssistito || '';
            document.getElementById('newCodiceFiscale').value = lead.cfAssistito || lead.codiceFiscaleAssistito || '';
            document.getElementById('newCondizioniSalute').value = lead.condizioniSalute || '';
            
            // Intestatario contratto
            const intestatario = lead.intestatarioContratto || 'richiedente';
            if (intestatario === 'richiedente') {
                document.getElementById('newIntestatarioRichiedente').checked = true;
            } else {
                document.getElementById('newIntestatarioAssistito').checked = true;
            }
            
            document.getElementById('newServizio').value = lead.servizio || 'eCura PRO';
            updatePrices(); // Aggiorna prezzi in base al servizio
            document.getElementById('newPiano').value = lead.piano || 'BASE';
            document.getElementById('newCanale').value = lead.fonte || 'Website';
            
            document.getElementById('newVuoleBrochure').checked = (lead.vuoleBrochure === 'Si');
            document.getElementById('newVuoleContratto').checked = (lead.vuoleContratto === 'Si');
            document.getElementById('newVuoleManuale').checked = (lead.vuoleManuale === 'Si');
            
            document.getElementById('newConsensoPrivacy').checked = (lead.consensoPrivacy === 1);
            document.getElementById('newConsensoMarketing').checked = (lead.consensoMarketing === 'Si');
            document.getElementById('newConsensoTerze').checked = (lead.consensoTerze === 'Si');
            
            document.getElementById('newNote').value = lead.note || '';
            
            // Cambia titolo e sottotitolo modal per edit mode
            const modalTitle = document.querySelector('#newLeadModal h2');
            const modalSubtitle = document.querySelector('#newLeadModal .text-blue-100');
            const submitButton = document.getElementById('submitLeadButton');
            
            if (modalTitle) {
                modalTitle.textContent = '‚úèÔ∏è Modifica Lead';
            }
            if (modalSubtitle) {
                modalSubtitle.textContent = 'Modifica i dati del lead esistente';
            }
            if (submitButton) {
                submitButton.innerHTML = 'üíæ Aggiorna Lead';
            }
            
            // Rimuovi required dai campi in edit mode (puoi modificare solo alcuni campi)
            document.querySelectorAll('#newLeadForm [required]').forEach(field => {
                field.removeAttribute('required');
            });
            
            openModal('newLeadModal');
        }
        
        // saveEditLead() rimossa - ora usa saveNewLead() con modalit√† edit
        
        async function deleteLead(leadId) {
            if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare questo lead?\\n\\nQuesta operazione √® irreversibile.')) {
                return;
            }
            
            try {
                const response = await fetch(\`/api/leads/\${leadId}\`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Lead eliminato con successo!');
                    loadLeadsData();
                } else {
                    alert('‚ùå Errore: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Errore di comunicazione: ' + error.message);
            }
        }
        
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.body.style.overflow = 'auto';
            
            // Reset edit mode quando si chiude il modal newLeadModal
            if (modalId === 'newLeadModal') {
                window.editingLeadId = null;
                const modalTitle = document.querySelector('#newLeadModal h2');
                const modalSubtitle = document.querySelector('#newLeadModal .text-blue-100');
                const submitButton = document.getElementById('submitLeadButton');
                
                if (modalTitle) {
                    modalTitle.textContent = 'üÜï Richiedi il tuo servizio eCura';
                }
                if (modalSubtitle) {
                    modalSubtitle.textContent = 'Compila il form per ricevere brochure e contratto personalizzato';
                }
                if (submitButton) {
                    submitButton.innerHTML = '‚úâÔ∏è Invia Richiesta';
                }
                
                // Ripristina i required
                const requiredFields = ['newNome', 'newCognome', 'newEmail', 'newTelefono', 
                    'newNomeAssistito', 'newCognomeAssistito', 'newLuogoNascita', 'newDataNascita'];
                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.setAttribute('required', 'required');
                });
            }
        }
        
        function openNewLeadModal() {
            // Reset edit mode
            window.editingLeadId = null;
            
            // Reset form
            document.getElementById('newLeadForm').reset();
            
            // Reset titolo, sottotitolo, pulsante e modalit√†
            document.getElementById('isEditMode').value = '';
            const modalTitle = document.querySelector('#newLeadModal h2');
            const modalSubtitle = document.querySelector('#newLeadModal .text-blue-100');
            const submitButton = document.getElementById('submitLeadButton');
            
            if (modalTitle) {
                modalTitle.textContent = 'üÜï Richiedi il tuo servizio eCura';
            }
            if (modalSubtitle) {
                modalSubtitle.textContent = 'Compila il form per ricevere brochure e contratto personalizzato';
            }
            if (submitButton) {
                submitButton.innerHTML = '‚úâÔ∏è Invia Richiesta';
            }
            
            // Ripristina i required sui campi obbligatori
            const requiredFields = ['newNome', 'newCognome', 'newEmail', 'newTelefono', 
                'newNomeAssistito', 'newCognomeAssistito', 'newLuogoNascita', 'newDataNascita'];
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.setAttribute('required', 'required');
            });
            
            openModal('newLeadModal');
            // Aggiorna prezzi iniziali
            updatePrices();
            
            // Aggiungi event listener per calcolo et√† automatico
            const dataNascitaInput = document.getElementById('newDataNascita');
            if (dataNascitaInput) {
                dataNascitaInput.addEventListener('blur', calculateAge);
                dataNascitaInput.addEventListener('change', calculateAge);
            }
        }
        
        function calculateAge() {
            const dataNascitaInput = document.getElementById('newDataNascita');
            const etaDisplay = document.getElementById('etaCalcolata');
            
            if (!dataNascitaInput || !dataNascitaInput.value) {
                if (etaDisplay) etaDisplay.textContent = '';
                return;
            }
            
            // Parse data in formato DD/MM/YYYY
            const dataNascitaValue = dataNascitaInput.value.trim();
            const parts = dataNascitaValue.split('/');
            
            if (parts.length !== 3) {
                if (etaDisplay) etaDisplay.textContent = 'Formato non valido (usa DD/MM/YYYY)';
                return;
            }
            
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; // I mesi in JS partono da 0
            const year = parseInt(parts[2], 10);
            
            if (isNaN(day) || isNaN(month) || isNaN(year)) {
                if (etaDisplay) etaDisplay.textContent = 'Data non valida';
                return;
            }
            
            const dataNascita = new Date(year, month, day);
            const oggi = new Date();
            
            let eta = oggi.getFullYear() - dataNascita.getFullYear();
            const meseOggi = oggi.getMonth();
            const giornoOggi = oggi.getDate();
            
            // Aggiusta et√† se il compleanno non √® ancora passato quest'anno
            if (meseOggi < dataNascita.getMonth() || 
                (meseOggi === dataNascita.getMonth() && giornoOggi < dataNascita.getDate())) {
                eta--;
            }
            
            if (eta < 0 || eta > 120) {
                if (etaDisplay) etaDisplay.textContent = 'Et√† non valida';
                return;
            }
            
            if (etaDisplay) {
                etaDisplay.textContent = 'Et√†: ' + eta + ' anni';
                etaDisplay.className = 'text-sm font-semibold text-green-600 mt-1';
            }
        }
        
        function updatePrices() {
            const servizio = document.getElementById('newServizio').value;
            const pianoSelect = document.getElementById('newPiano');
            const priceNote = document.getElementById('priceNote');
            
            // Prezzi per servizio (primo anno / rinnovo) - AGGIORNATI da ecura.it
            const prices = {
                'eCura Family': {
                    BASE: { primo: 390, rinnovo: 200 },
                    AVANZATO: { primo: 690, rinnovo: 500 }
                },
                'eCura PRO': {
                    BASE: { primo: 480, rinnovo: 240 },
                    AVANZATO: { primo: 840, rinnovo: 600 }
                },
                'eCura PREMIUM': {
                    BASE: { primo: 590, rinnovo: 300 },
                    AVANZATO: { primo: 990, rinnovo: 750 }
                }
            };
            
            if (!servizio || !prices[servizio]) {
                pianoSelect.innerHTML = '<option value="">Seleziona prima un servizio</option>';
                priceNote.textContent = 'Seleziona un servizio per vedere i prezzi';
                return;
            }
            
            const servicePrices = prices[servizio];
            const dispositivo = servizio.includes('PREMIUM') ? 'SiDLY Vital Care' : 'SiDLY Care PRO';
            
            pianoSelect.innerHTML = \`
                <option value="BASE">Piano BASE - ‚Ç¨\${servicePrices.BASE.primo}/anno (rinnovo ‚Ç¨\${servicePrices.BASE.rinnovo}/anno)</option>
                <option value="AVANZATO">Piano AVANZATO - ‚Ç¨\${servicePrices.AVANZATO.primo}/anno (rinnovo ‚Ç¨\${servicePrices.AVANZATO.rinnovo}/anno)</option>
            \`;
            
            priceNote.textContent = \`I prezzi mostrati sono per il servizio \${servizio}. Include dispositivo \${dispositivo}.\`;
        }
        
        async function saveNewLead() {
            const isEditMode = !!window.editingLeadId;
            const leadId = window.editingLeadId;
            
            const formData = {
                // Dati richiedente
                nomeRichiedente: document.getElementById('newNome').value,
                cognomeRichiedente: document.getElementById('newCognome').value,
                email: document.getElementById('newEmail').value,
                telefono: document.getElementById('newTelefono').value,
                
                // Dati assistito
                nomeAssistito: document.getElementById('newNomeAssistito').value,
                cognomeAssistito: document.getElementById('newCognomeAssistito').value,
                luogoNascitaAssistito: document.getElementById('newLuogoNascita').value,
                dataNascitaAssistito: document.getElementById('newDataNascita').value,
                indirizzoAssistito: document.getElementById('newIndirizzoAssistito').value,
                capAssistito: document.getElementById('newCapAssistito').value,
                cittaAssistito: document.getElementById('newCittaAssistito').value,
                provinciaAssistito: document.getElementById('newProvinciaAssistito').value.toUpperCase(),
                codiceFiscaleAssistito: document.getElementById('newCodiceFiscale').value.toUpperCase(),
                
                // Intestatario contratto
                intestatarioContratto: document.querySelector('input[name="intestatario"]:checked').value,
                
                // Condizioni di salute
                condizioniSalute: document.getElementById('newCondizioniSalute').value,
                
                // Servizio e Piano
                servizio: document.getElementById('newServizio').value,
                piano: document.getElementById('newPiano').value,
                canale: document.getElementById('newCanale').value,
                fonte: document.getElementById('newCanale').value,
                
                // Preferenze
                vuoleBrochure: document.getElementById('newVuoleBrochure').checked ? 'Si' : 'No',
                vuoleContratto: document.getElementById('newVuoleContratto').checked ? 'Si' : 'No',
                vuoleManuale: document.getElementById('newVuoleManuale').checked ? 'Si' : 'No',
                
                // Consensi
                consensoPrivacy: document.getElementById('newConsensoPrivacy').checked,
                consensoMarketing: document.getElementById('newConsensoMarketing').checked ? 'Si' : 'No',
                consensoTerze: document.getElementById('newConsensoTerze').checked ? 'Si' : 'No',
                
                // Note
                note: document.getElementById('newNote').value
            };
            
            // Validation campi obbligatori SOLO in modalit√† nuovo lead
            if (!isEditMode) {
                if (!formData.nomeRichiedente || !formData.cognomeRichiedente || !formData.email || !formData.telefono) {
                    alert("‚ö†Ô∏è Compila tutti i campi obbligatori del Richiedente");
                    return;
                }
                
                if (!formData.nomeAssistito || !formData.cognomeAssistito) {
                    alert("‚ö†Ô∏è Compila tutti i campi obbligatori dell'Assistito");
                    return;
                }
                
                if (!formData.consensoPrivacy) {
                    alert("‚ö†Ô∏è Il consenso Privacy √® obbligatorio");
                    return;
                }
            }
            // In modalit√† edit: nessuna validazione, puoi modificare quello che vuoi
            
            console.log(isEditMode ? 'üìù Aggiornamento lead:' : 'üì§ Invio dati lead:', formData);
            
            try {
                const url = isEditMode ? '/api/leads/' + leadId : '/api/leads';
                const method = isEditMode ? 'PUT' : 'POST';
                
                console.log('[REQUEST] ' + method + ' ' + url);
                console.log('[PAYLOAD]', JSON.stringify(formData, null, 2));
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                console.log('[RESPONSE] Status: ' + response.status + ' ' + response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[ERROR] Response:', errorText);
                    throw new Error('HTTP ' + response.status + ': ' + errorText.substring(0, 200));
                }
                
                const result = await response.json();
                console.log('[RESULT]', result);
                
                if (result.success) {
                    let message = isEditMode 
                        ? "‚úÖ Lead aggiornato con successo!" 
                        : "‚úÖ Lead creato con successo!\\n\\nID: " + (result.id || result.leadId);
                    
                    // Mostra email inviate solo per nuovo lead
                    if (!isEditMode && result.emails) {
                        message += "\\n\\nüìß Email inviate:";
                        if (result.emails.notifica && result.emails.notifica.sent) message += "\\n  ‚úì Notifica nuovo lead";
                        if (result.emails.brochure && result.emails.brochure.sent) message += "\\n  ‚úì Brochure al cliente";
                        if (result.emails.contratto && result.emails.contratto.sent) message += "\\n  ‚úì Contratto al cliente";
                    }
                    
                    alert(message);
                    closeModal('newLeadModal');
                    document.getElementById('newLeadForm').reset();
                    
                    // Reset edit mode
                    window.editingLeadId = null;
                    const modalTitle = document.querySelector('#newLeadModal h2');
                    if (modalTitle) {
                        modalTitle.textContent = 'Richiedi il tuo servizio eCura';
                    }
                    
                    // Ricarica la pagina per aggiornare i dati
                    window.location.reload();
                } else {
                    alert("‚ùå Errore: " + (result.error || "Errore sconosciuto"));
                }
            } catch (error) {
                console.error(isEditMode ? "‚ùå Errore aggiornamento lead:" : "‚ùå Errore creazione lead:", error);
                alert("‚ùå Errore di comunicazione: " + error.message);
            }
        }
        
        // ========== CRUD ASSISTITI ==========
        
        async function viewAssistito(id) {
            try {
                const response = await fetch('/api/assistiti?id=' + id);
                const data = await response.json();
                
                if (data.success && data.assistiti && data.assistiti.length > 0) {
                    const assistito = data.assistiti[0];
                    
                    // Mostra modal dettagli assistito
                    alert('üìã Dettagli Assistito\\n\\n' +
                        'Nome: ' + (assistito.nome_assistito || '') + ' ' + (assistito.cognome_assistito || '') + '\\n' +
                        'Caregiver: ' + (assistito.nome_caregiver || 'N/A') + ' ' + (assistito.cognome_caregiver || '') + '\\n' +
                        'Parentela: ' + (assistito.parentela_caregiver || 'N/A') + '\\n' +
                        'IMEI: ' + (assistito.imei || 'N/A') + '\\n' +
                        'Email: ' + (assistito.email || 'N/A') + '\\n' +
                        'Telefono: ' + (assistito.telefono || 'N/A') + '\\n' +
                        'Piano: ' + (assistito.piano || 'BASE') + '\\n' +
                        'Contratto: ' + (assistito.codice_contratto || 'Nessuno') + '\\n' +
                        'Status: ' + (assistito.contratto_status || assistito.status || 'N/A')
                    );
                } else {
                    alert('‚ùå Assistito non trovato');
                }
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
            }
        }
        window.viewAssistito = viewAssistito;  // Esponi globalmente
        
        async function editAssistito(id) {
            try {
                const response = await fetch('/api/assistiti?id=' + id);
                const data = await response.json();
                
                if (data.success && data.assistiti && data.assistiti.length > 0) {
                    const assistito = data.assistiti[0];
                    
                    // Richiedi nuovi dati
                    const nuovoNome = prompt('Nome Assistito:', assistito.nome_assistito || '');
                    if (!nuovoNome) return;
                    
                    const nuovoCognome = prompt('Cognome Assistito:', assistito.cognome_assistito || '');
                    if (!nuovoCognome) return;
                    
                    const nuovaEmail = prompt('Email:', assistito.email || '');
                    const nuovoTelefono = prompt('Telefono:', assistito.telefono || '');
                    const nuovoIMEI = prompt('IMEI Dispositivo:', assistito.imei || '');
                    
                    const caregiverNome = prompt('Nome Caregiver:', assistito.nome_caregiver || '');
                    const caregiverCognome = prompt('Cognome Caregiver:', assistito.cognome_caregiver || '');
                    const parentela = prompt('Parentela Caregiver:', assistito.parentela_caregiver || '');
                    
                    // Aggiorna
                    const updateResponse = await fetch(\`/api/assistiti/\${id}\`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            nome_assistito: nuovoNome,
                            cognome_assistito: nuovoCognome,
                            nome_caregiver: caregiverNome,
                            cognome_caregiver: caregiverCognome,
                            parentela_caregiver: parentela,
                            email: nuovaEmail,
                            telefono: nuovoTelefono,
                            imei: nuovoIMEI
                        })
                    });
                    
                    const result = await updateResponse.json();
                    
                    if (result.success) {
                        alert('‚úÖ Assistito aggiornato con successo!');
                        loadDashboardData(); // Ricarica dashboard
                    } else {
                        alert('‚ùå Errore: ' + result.error);
                    }
                } else {
                    alert('‚ùå Assistito non trovato');
                }
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
            }
        }
        window.editAssistito = editAssistito;  // Esponi globalmente
        
        async function deleteAssistito(id, nome) {
            if (!confirm(\`‚ö†Ô∏è Sei sicuro di voler eliminare l'assistito \${nome}?\\n\\nQuesta azione non pu√≤ essere annullata!\`)) {
                return;
            }
            
            try {
                const response = await fetch(\`/api/assistiti/\${id}\`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Assistito ' + nome + ' eliminato con successo!');
                    loadDashboardData(); // Ricarica dashboard
                } else {
                    alert('‚ùå Errore: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
            }
        }
        window.deleteAssistito = deleteAssistito;  // Esponi globalmente
    <\/script>

    <!-- MODAL: NEW LEAD - Form Stile eCura.it -->
    <div id="newLeadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[95vh] overflow-hidden">
            
            <!-- HEADER -->
            <div style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%)" class="text-white px-8 py-6 rounded-t-xl">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold mb-1">Richiedi il tuo servizio eCura</h2>
                        <p class="text-blue-100 text-sm">Compila il form per ricevere brochure e contratto personalizzato</p>
                    </div>
                    <button onclick="closeModal('newLeadModal')" class="text-white hover:text-gray-200 text-3xl leading-none">&times;</button>
                </div>
            </div>
            
            <!-- FORM CONTENT -->
            <div class="p-8 overflow-y-auto" style="max-height: calc(95vh - 180px)">
                <form id="newLeadForm" class="space-y-8">
                    <!-- Hidden field per gestire edit mode -->
                    <input type="hidden" id="isEditMode" value="">
                    
                    <!-- STEP 1: CHI SEI -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 border-l-4 border-blue-500">
                        <h3 class="text-xl font-bold text-gray-800 mb-1 flex items-center">
                            <span class="bg-blue-500 text-white w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">1</span>
                            Chi sei?
                        </h3>
                        <p class="text-gray-600 text-sm mb-4 ml-11">I tuoi dati di contatto</p>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Nome *</label>
                                <input type="text" id="newNome" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                                    placeholder="Mario">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Cognome *</label>
                                <input type="text" id="newCognome" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                                    placeholder="Rossi">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Email *</label>
                                <input type="email" id="newEmail" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                                    placeholder="mario.rossi@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Telefono *</label>
                                <input type="tel" id="newTelefono" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                                    placeholder="+39 333 1234567">
                            </div>
                        </div>
                    </div>

                    <!-- STEP 2: PER CHI √à IL SERVIZIO -->
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-6 border-l-4 border-green-500">
                        <h3 class="text-xl font-bold text-gray-800 mb-1 flex items-center">
                            <span class="bg-green-500 text-white w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">2</span>
                            Per chi √® il servizio?
                        </h3>
                        <p class="text-gray-600 text-sm mb-4 ml-11">Dati anagrafici completi dell'assistito</p>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Nome Assistito *</label>
                                <input type="text" id="newNomeAssistito" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                                    placeholder="Giuseppe">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Cognome Assistito *</label>
                                <input type="text" id="newCognomeAssistito" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                                    placeholder="Rossi">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Luogo di Nascita *</label>
                                <input type="text" id="newLuogoNascita" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                                    placeholder="Milano">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Data di Nascita *</label>
                                <input type="text" id="newDataNascita" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                                    placeholder="15/03/1950"
                                    onblur="calculateAge()" onchange="calculateAge()">
                                <div id="etaCalcolata" class="text-sm text-gray-500 mt-1"></div>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Indirizzo Completo *</label>
                                <input type="text" id="newIndirizzoAssistito" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                                    placeholder="Via Roma 123">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">CAP *</label>
                                <input type="text" id="newCapAssistito" required maxlength="5"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                                    placeholder="20121">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Citt√† *</label>
                                <input type="text" id="newCittaAssistito" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                                    placeholder="Milano">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Provincia *</label>
                                <input type="text" id="newProvinciaAssistito" required maxlength="2"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition uppercase"
                                    placeholder="MI">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Codice Fiscale *</label>
                                <input type="text" id="newCodiceFiscale" required maxlength="16"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition uppercase"
                                    placeholder="RSSGPP50C15F205X">
                            </div>
                        </div>
                        
                        <!-- CONDIZIONI DI SALUTE -->
                        <div class="mt-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-notes-medical text-green-600 mr-2"></i>
                                Condizioni di salute
                            </label>
                            <textarea id="newCondizioniSalute" rows="3"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                                placeholder="Descrivere eventuali patologie, allergie, limitazioni motorie o altre informazioni mediche rilevanti per il servizio..."></textarea>
                            <p class="text-xs text-gray-500 mt-1">
                                Queste informazioni aiutano a personalizzare il servizio e garantire un'assistenza adeguata
                            </p>
                        </div>
                        
                        <!-- INTESTATARIO CONTRATTO -->
                        <div class="mt-6 p-4 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">
                                <i class="fas fa-file-signature text-yellow-600 mr-2"></i>
                                Intestatario Contratto *
                            </label>
                            <div class="flex gap-4">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" id="newIntestatarioRichiedente" name="intestatario" value="richiedente" checked
                                        class="w-5 h-5 text-yellow-600 focus:ring-yellow-500 focus:ring-2">
                                    <span class="ml-3 text-gray-700 font-medium">
                                        üìù Richiedente
                                        <span class="block text-xs text-gray-500">Il contratto sar√† intestato a te</span>
                                    </span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" id="newIntestatarioAssistito" name="intestatario" value="assistito"
                                        class="w-5 h-5 text-yellow-600 focus:ring-yellow-500 focus:ring-2">
                                    <span class="ml-3 text-gray-700 font-medium">
                                        üë¥ Assistito
                                        <span class="block text-xs text-gray-500">Il contratto sar√† intestato all'assistito</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 3: QUALE SERVIZIO VUOI -->
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-6 border-l-4 border-purple-500">
                        <h3 class="text-xl font-bold text-gray-800 mb-1 flex items-center">
                            <span class="bg-purple-500 text-white w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">3</span>
                            Quale servizio vuoi?
                        </h3>
                        <p class="text-gray-600 text-sm mb-4 ml-11">Scegli il servizio e il piano pi√π adatto</p>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Servizio eCura *</label>
                                <select id="newServizio" required onchange="updatePrices()"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition bg-white">
                                    <option value="">Seleziona servizio...</option>
                                    <option value="eCura Family">eCura Family</option>
                                    <option value="eCura PRO" selected>eCura PRO</option>
                                    <option value="eCura PREMIUM">eCura PREMIUM</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Piano *</label>
                                <select id="newPiano" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition bg-white">
                                    <option value="BASE">Piano BASE - ‚Ç¨480/anno (rinnovo ‚Ç¨200/anno)</option>
                                    <option value="AVANZATO">Piano AVANZATO - ‚Ç¨840/anno (rinnovo ‚Ç¨600/anno)</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1" id="priceNote">
                                    I prezzi mostrati sono per il servizio eCura PRO. Il prezzo include dispositivo SiDLY Care PRO.
                                </p>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Come ci hai conosciuto? *</label>
                                <select id="newCanale" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition bg-white">
                                    <option value="">Seleziona...</option>
                                    <option value="Website">Sito Web eCura.it</option>
                                    <option value="Partner">Tramite Partner</option>
                                    <option value="Networking">Networking / Passaparola</option>
                                    <option value="Phone">Chiamata Telefonica</option>
                                    <option value="Email">Email</option>
                                    <option value="Irbema">Irbema</option>
                                    <option value="AON">AON</option>
                                    <option value="Test" selected>Test</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 4: PREFERENZE -->
                    <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-lg p-6 border-l-4 border-amber-500">
                        <h3 class="text-xl font-bold text-gray-800 mb-1 flex items-center">
                            <span class="bg-amber-500 text-white w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">4</span>
                            Cosa vuoi ricevere?
                        </h3>
                        <p class="text-gray-600 text-sm mb-4 ml-11">Documenti e informazioni</p>
                        
                        <div class="space-y-3">
                            <label class="flex items-center p-4 bg-white rounded-lg border-2 border-gray-200 hover:border-amber-400 cursor-pointer transition">
                                <input type="checkbox" id="newVuoleBrochure" checked 
                                    class="mr-4 w-6 h-6 text-amber-600 border-2 border-gray-300 rounded focus:ring-amber-500">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">üìö Brochure Informativa</div>
                                    <div class="text-sm text-gray-600">Ricevi via email la brochure con tutte le caratteristiche del dispositivo associato al servizio scelto</div>
                                </div>
                            </label>
                            
                            <label class="flex items-center p-4 bg-white rounded-lg border-2 border-gray-200 hover:border-amber-400 cursor-pointer transition">
                                <input type="checkbox" id="newVuoleContratto" checked 
                                    class="mr-4 w-6 h-6 text-amber-600 border-2 border-gray-300 rounded focus:ring-amber-500">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">üìã Contratto Personalizzato</div>
                                    <div class="text-sm text-gray-600">Ricevi il contratto precompilato con i tuoi dati</div>
                                </div>
                            </label>
                            
                            <label class="flex items-center p-4 bg-white rounded-lg border-2 border-gray-200 hover:border-amber-400 cursor-pointer transition">
                                <input type="checkbox" id="newVuoleManuale" 
                                    class="mr-4 w-6 h-6 text-amber-600 border-2 border-gray-300 rounded focus:ring-amber-500">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">üìñ Manuale Utente</div>
                                    <div class="text-sm text-gray-600">Guida all'utilizzo del dispositivo e dei servizi</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- STEP 5: CONSENSI -->
                    <div class="bg-gradient-to-r from-gray-50 to-slate-50 rounded-lg p-6 border-l-4 border-gray-400">
                        <h3 class="text-xl font-bold text-gray-800 mb-1 flex items-center">
                            <span class="bg-gray-500 text-white w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">5</span>
                            Privacy e Consensi
                        </h3>
                        <p class="text-gray-600 text-sm mb-4 ml-11">Informativa sul trattamento dei dati personali</p>
                        
                        <div class="space-y-3">
                            <label class="flex items-start p-4 bg-white rounded-lg border-2 border-green-200 cursor-pointer">
                                <input type="checkbox" id="newConsensoPrivacy" checked required 
                                    class="mr-4 mt-1 w-6 h-6 text-green-600 border-2 border-gray-300 rounded focus:ring-green-500">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">‚úÖ Consenso Privacy *</div>
                                    <div class="text-sm text-gray-600">Acconsento al trattamento dei miei dati personali secondo la <a href="#" class="text-blue-600 hover:underline">Privacy Policy</a> (obbligatorio)</div>
                                </div>
                            </label>
                            
                            <label class="flex items-start p-4 bg-white rounded-lg border-2 border-gray-200 cursor-pointer hover:border-gray-400 transition">
                                <input type="checkbox" id="newConsensoMarketing" 
                                    class="mr-4 mt-1 w-6 h-6 text-blue-600 border-2 border-gray-300 rounded focus:ring-blue-500">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">üì¨ Comunicazioni Marketing</div>
                                    <div class="text-sm text-gray-600">Acconsento alla ricezione di comunicazioni commerciali e promozionali (facoltativo)</div>
                                </div>
                            </label>
                            
                            <label class="flex items-start p-4 bg-white rounded-lg border-2 border-gray-200 cursor-pointer hover:border-gray-400 transition">
                                <input type="checkbox" id="newConsensoTerze" 
                                    class="mr-4 mt-1 w-6 h-6 text-blue-600 border-2 border-gray-300 rounded focus:ring-blue-500">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">ü§ù Comunicazione a Terze Parti</div>
                                    <div class="text-sm text-gray-600">Acconsento alla comunicazione dei miei dati a partner selezionati (facoltativo)</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- NOTE OPZIONALI -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">üí¨ Note Aggiuntive (opzionale)</label>
                        <textarea id="newNote" rows="3" 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                            placeholder="Eventuali note o richieste particolari..."></textarea>
                    </div>

                </form>
            </div>
            
            <!-- FOOTER BUTTONS -->
            <div class="bg-gray-50 px-8 py-6 rounded-b-xl border-t flex justify-between items-center">
                <div class="text-sm text-gray-600">
                    <span class="text-red-600">*</span> Campi obbligatori
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal('newLeadModal')" 
                        class="px-8 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                        ‚ùå Annulla
                    </button>
                    <button type="button" id="submitLeadButton" onclick="saveNewLead()" 
                        class="px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 transition font-semibold shadow-lg">
                        ‚úâÔ∏è Invia Richiesta
                    </button>
                </div>
            </div>
            
        </div>
    </div>

    <!-- MODAL: VIEW LEAD -->
    <div id="viewLeadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="gradient-bg text-white px-6 py-4 rounded-t-lg flex justify-between items-center">
                <h3 class="text-xl font-bold">üë§ Dettagli Lead</h3>
                <button onclick="closeModal('viewLeadModal')" class="text-white hover:text-gray-200 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Lead ID</label>
                        <p id="viewLeadId" class="text-gray-900 font-mono text-sm bg-gray-50 p-2 rounded">-</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data Creazione</label>
                        <p id="viewData" class="text-gray-900 bg-gray-50 p-2 rounded">-</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
                        <p id="viewNome" class="text-gray-900 bg-gray-50 p-2 rounded">-</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cognome</label>
                        <p id="viewCognome" class="text-gray-900 bg-gray-50 p-2 rounded">-</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <p id="viewEmail" class="text-gray-900 bg-gray-50 p-2 rounded">-</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Telefono</label>
                        <p id="viewTelefono" class="text-gray-900 bg-gray-50 p-2 rounded">-</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Servizio</label>
                        <p id="viewServizio" class="text-gray-900 bg-blue-50 p-2 rounded font-semibold">-</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Piano</label>
                        <p id="viewPiano" class="text-gray-900 bg-purple-50 p-2 rounded font-semibold">-</p>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
                        <p id="viewNote" class="text-gray-900 bg-gray-50 p-3 rounded min-h-[80px]">-</p>
                    </div>
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="closeModal('viewLeadModal')" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                        Chiudi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: EDIT LEAD -->
    <!-- editLeadModal rimosso - ora usa newLeadModal anche per edit -->

    ${Fp}
</body>
</html>
`,uw=`<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Dashboard - TeleMedCare V12.0</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-database text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Data Dashboard</h1>
                        <p class="text-blue-100">Centro dati completo con analytics e KPI aziendali</p>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <button onclick="openNewContractModal()" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-plus mr-2"></i>Nuovo Contratto
                    </button>
                    <a href="/" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-home mr-2"></i>Home
                    </a>
                    <a href="/dashboard" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-chart-line mr-2"></i>Dashboard
                    </a>
                    <a href="/admin/leads-dashboard" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-users mr-2"></i>Leads
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- KPI Principali -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Lead Totali</p>
                        <p class="text-3xl font-bold text-blue-600" id="kpiLeads">-</p>
                    </div>
                    <i class="fas fa-users text-3xl text-blue-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Contratti</p>
                        <p class="text-3xl font-bold text-green-600" id="kpiContracts">-</p>
                    </div>
                    <i class="fas fa-file-contract text-3xl text-green-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Revenue YTD</p>
                        <p class="text-2xl font-bold text-purple-600" id="kpiRevenue">-</p>
                    </div>
                    <i class="fas fa-euro-sign text-3xl text-purple-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-orange-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Conv. Rate</p>
                        <p class="text-3xl font-bold text-orange-600" id="kpiConversion">-</p>
                    </div>
                    <i class="fas fa-percentage text-3xl text-orange-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-red-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">AOV</p>
                        <p class="text-2xl font-bold text-red-600" id="kpiAov">-</p>
                    </div>
                    <i class="fas fa-chart-line text-3xl text-red-500"></i>
                </div>
            </div>
        </div>

        <!-- Metriche Servizi -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-chart-bar text-blue-500 mr-2"></i>
                Performance per Servizio
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- FAMILY -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold text-blue-600">eCura FAMILY</h4>
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">SiDLY CARE PRO</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Lead:</span>
                            <span class="font-bold" id="familyLeads">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Contratti:</span>
                            <span class="font-bold" id="familyContracts">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Revenue:</span>
                            <span class="font-bold text-green-600" id="familyRevenue">-</span>
                        </div>
                        <div class="pt-2 border-t">
                            <div class="text-xs text-gray-500 mb-1">BASE vs AVANZATO</div>
                            <div class="flex gap-2">
                                <div class="flex-1 bg-blue-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">BASE</div>
                                    <div class="font-bold text-sm" id="familyBase">-</div>
                                </div>
                                <div class="flex-1 bg-purple-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">AVANZ.</div>
                                    <div class="font-bold text-sm" id="familyAvanzato">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PRO -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold text-purple-600">eCura PRO</h4>
                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">SiDLY CARE PRO</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Lead:</span>
                            <span class="font-bold" id="proLeads">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Contratti:</span>
                            <span class="font-bold" id="proContracts">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Revenue:</span>
                            <span class="font-bold text-green-600" id="proRevenue">-</span>
                        </div>
                        <div class="pt-2 border-t">
                            <div class="text-xs text-gray-500 mb-1">BASE vs AVANZATO</div>
                            <div class="flex gap-2">
                                <div class="flex-1 bg-blue-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">BASE</div>
                                    <div class="font-bold text-sm" id="proBase">-</div>
                                </div>
                                <div class="flex-1 bg-purple-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">AVANZ.</div>
                                    <div class="font-bold text-sm" id="proAvanzato">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PREMIUM -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold text-green-600">eCura PREMIUM</h4>
                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">SiDLY VITAL CARE</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Lead:</span>
                            <span class="font-bold" id="premiumLeads">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Contratti:</span>
                            <span class="font-bold" id="premiumContracts">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Revenue:</span>
                            <span class="font-bold text-green-600" id="premiumRevenue">-</span>
                        </div>
                        <div class="pt-2 border-t">
                            <div class="text-xs text-gray-500 mb-1">BASE vs AVANZATO</div>
                            <div class="flex gap-2">
                                <div class="flex-1 bg-blue-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">BASE</div>
                                    <div class="font-bold text-sm" id="premiumBase">-</div>
                                </div>
                                <div class="flex-1 bg-purple-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">AVANZ.</div>
                                    <div class="font-bold text-sm" id="premiumAvanzato">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contratti Recenti -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-file-contract text-green-500 mr-2"></i>
                Ultimi Contratti Generati
            </h3>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-200 text-left">
                            <th class="pb-3 text-sm font-semibold text-gray-600">Codice</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Cliente</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Servizio</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Piano</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Dispositivo</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Valore</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Status</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Data</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">PDF</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="contractsTable">
                        <tr>
                            <td colspan="10" class="py-8 text-center text-gray-400">
                                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                <p>Caricamento contratti...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Helper function to escape HTML special characters
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        let allContracts = [];

        async function loadDataDashboard() {
            try {
                // Carica lead per calcolare statistiche reali
                const leadsResponse = await fetch('/api/leads?limit=200');
                if (!leadsResponse.ok) throw new Error('Errore caricamento leads');
                const leadsData = await leadsResponse.json();
                const leads = leadsData.leads || [];
                
                // Carica contratti REALI
                const contractsResponse = await fetch('/api/contratti?limit=100');
                if (!contractsResponse.ok) throw new Error('Errore caricamento contratti');
                const contractsData = await contractsResponse.json();
                console.log('üìä Contratti ricevuti dall API:', contractsData);
                const keys = Object.keys(contractsData);
                console.log('üîë Chiavi oggetto risposta:', keys);
                console.log('üìù CHIAVI ESATTE:', keys.join(', '));
                console.log('üì¶ Tipo di contractsData:', typeof contractsData, Array.isArray(contractsData) ? '√à un array' : 'Non √® un array');
                
                // Prova a stampare il valore di ogni chiave
                keys.forEach(key => {
                    console.log(\`   üî∏ \${key}:\`, Array.isArray(contractsData[key]) ? \`Array(\${contractsData[key].length})\` : typeof contractsData[key]);
                });
                
                const contracts = contractsData.contracts || contractsData.contratti || contractsData.data || [];
                console.log('üìã Array contratti dopo parsing:', contracts, 'Lunghezza:', contracts.length);
                allContracts = contracts; // Salva per uso nelle funzioni CRUD
                
                // Calcola statistiche REALI dai contratti
                const totalLeads = leads.length;
                const totalContracts = contracts.length;
                
                // Calcola revenue dai contratti reali (SOLO FIRMATI!)
                let totalRevenue = 0;
                contracts.forEach(c => {
                    // Solo contratti SIGNED contano per il revenue
                    if (c.status === 'SIGNED' && c.prezzo_totale) {
                        totalRevenue += parseFloat(c.prezzo_totale);
                    }
                });
                
                // Conta contratti firmati
                const signedContracts = contracts.filter(c => c.status === 'SIGNED').length;
                const conversionRate = totalLeads > 0 ? ((signedContracts / totalLeads) * 100).toFixed(2) + '%' : '0%';
                const averageOrderValue = signedContracts > 0 ? Math.round(totalRevenue / signedContracts) : 0;

                // Aggiorna KPI con dati reali
                document.getElementById('kpiLeads').textContent = totalLeads;
                document.getElementById('kpiContracts').textContent = totalContracts;
                document.getElementById('kpiRevenue').textContent = '‚Ç¨' + totalRevenue.toFixed(0);
                document.getElementById('kpiConversion').textContent = conversionRate;
                document.getElementById('kpiAov').textContent = '‚Ç¨' + averageOrderValue;

                // Analizza per servizio (TUTTI sono eCura PRO)
                const serviceData = analyzeByService(leads, contracts);
                updateServiceMetrics(serviceData);

                // Renderizza tabella contratti
                renderContractsTable(contracts, leads);

            } catch (error) {
                console.error('Errore caricamento data dashboard:', error);
                alert('‚ö†Ô∏è Errore caricamento Data Dashboard:\\n\\n' + error.message + '\\n\\nRicarica la pagina.');
            }
        }

        function analyzeByService(leads, contracts) {
            // TASK #5-6 FIX: Calcola dinamicamente da dati reali (non hardcode)
            const data = {
                FAMILY: { leads: 0, base: 0, avanzato: 0, contracts: 0, revenue: 0 },
                PRO: { leads: 0, base: 0, avanzato: 0, contracts: 0, revenue: 0 },
                PREMIUM: { leads: 0, base: 0, avanzato: 0, contracts: 0, revenue: 0 }
            };

            // Conta lead PER SERVIZIO
            // Ora la tabella leads HA il campo 'servizio' (dopo migration 0006)
            leads.forEach(lead => {
                // Normalizza servizio: rimuovi "eCura " prefix per matching
                const servizio = (lead.servizio || 'eCura PRO').toUpperCase().replace(/^ECURAs+/i, '');
                
                if (data[servizio]) {
                    data[servizio].leads++;
                } else {
                    // Default a PRO se servizio sconosciuto
                    data.PRO.leads++;
                }
            });

            // Calcola revenue e conta BASE vs AVANZATO dai CONTRATTI reali (SOLO FIRMATI)
            contracts.forEach(contract => {
                // Determina servizio dal contratto o fallback a PRO
                const servizio = (contract.servizio || 'PRO').toUpperCase().replace(/^ECURA\\s+/i, '');
                
                // TASK 6 FIX: Piano dal DB
                const piano = (contract.piano || 'BASE').toUpperCase();
                const isAvanzato = piano === 'AVANZATO';
                
                // Debug log contratti con piano
                console.log('Contratto ' + contract.codice_contratto + ': piano=' + contract.piano + ', isAvanzato=' + isAvanzato);
                
                if (data[servizio]) {
                    data[servizio].contracts++;
                    if (isAvanzato) {
                        data[servizio].avanzato++;
                    } else {
                        data[servizio].base++;
                    }
                    
                    // Somma revenue SOLO se contratto FIRMATO
                    if (contract.status === 'SIGNED' && contract.prezzo_totale) {
                        data[servizio].revenue += parseFloat(contract.prezzo_totale);
                    }
                }
            });

            return data;
        }

        function updateServiceMetrics(data) {
            // FAMILY
            document.getElementById('familyLeads').textContent = data.FAMILY.leads;
            document.getElementById('familyContracts').textContent = data.FAMILY.contracts;
            document.getElementById('familyRevenue').textContent = '‚Ç¨' + data.FAMILY.revenue;
            document.getElementById('familyBase').textContent = data.FAMILY.base;
            document.getElementById('familyAvanzato').textContent = data.FAMILY.avanzato;

            // PRO (TUTTI i 126 lead)
            document.getElementById('proLeads').textContent = data.PRO.leads;
            document.getElementById('proContracts').textContent = data.PRO.contracts;
            document.getElementById('proRevenue').textContent = '‚Ç¨' + data.PRO.revenue;
            document.getElementById('proBase').textContent = data.PRO.base;
            document.getElementById('proAvanzato').textContent = data.PRO.avanzato;

            // PREMIUM
            document.getElementById('premiumLeads').textContent = data.PREMIUM.leads;
            document.getElementById('premiumContracts').textContent = data.PREMIUM.contracts;
            document.getElementById('premiumRevenue').textContent = '‚Ç¨' + data.PREMIUM.revenue;
            document.getElementById('premiumBase').textContent = data.PREMIUM.base;
            document.getElementById('premiumAvanzato').textContent = data.PREMIUM.avanzato;
        }

        function renderContractsTable(contracts, leads) {
            console.log('üé® renderContractsTable chiamata con:', contracts.length, 'contratti e', leads.length, 'leads');
            const tbody = document.getElementById('contractsTable');
            
            if (contracts.length === 0) {
                tbody.innerHTML = \`
                    <tr>
                        <td colspan="10" class="py-8 text-center text-gray-400">Nessun contratto trovato</td>
                    </tr>
                \`;
                return;
            }

            tbody.innerHTML = contracts.map(contract => {
                // TASK 6 FIX: Piano dal DB
                const piano = (contract.piano || 'BASE').toUpperCase();
                const prezzo = contract.prezzo_totale || (piano === 'AVANZATO' ? '840' : '480');
                
                // Mostra servizio cos√¨ com'√® dal DB
                const servizio = contract.servizio || 'eCura PRO';
                
                const date = new Date(contract.created_at).toLocaleDateString('it-IT');
                
                return \`
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 text-xs">
                            <code class="bg-gray-100 px-2 py-1 rounded">\${contract.codice_contratto || contract.id}</code>
                        </td>
                        <td class="py-3 text-sm font-medium">
                            \${escapeHtml(contract.cliente_nome)} \${escapeHtml(contract.cliente_cognome)}
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded font-medium">
                                \${servizio}
                            </span>
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded font-medium">
                                \${piano}
                            </span>
                        </td>
                        <td class="py-3 text-sm text-gray-600">SiDLY CARE PRO</td>
                        <td class="py-3 text-sm font-bold text-green-600">
                            ‚Ç¨\${prezzo} + IVA
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded font-medium">
                                \${contract.status_italiano || contract.status || 'SENT'}
                            </span>
                        </td>
                        <td class="py-3 text-xs text-gray-500">\${date}</td>
                        <td class="py-3">
                            <button onclick="viewContractPDF('\${contract.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizza PDF">
                                <i class="fas fa-file-pdf text-lg"></i>
                            </button>
                        </td>
                        <td class="py-3">
                            <div class="flex space-x-2">
                                <button onclick="viewContract('\${contract.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizza">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="signContract('\${contract.id}')" class="text-purple-600 hover:text-purple-800" title="Firma Contratto">
                                    <i class="fas fa-signature"></i>
                                </button>
                                <button onclick="editContract('\${contract.id}')" class="text-green-600 hover:text-green-800" title="Modifica">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteContract('\${contract.id}')" class="text-red-600 hover:text-red-800" title="Elimina">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                \`;
            }).join('');
        }

        function getDispositivoForService(servizio) {
            const dispositivi = {
                'FAMILY': 'SiDLY CARE PRO',
                'PRO': 'SiDLY CARE PRO',
                'PREMIUM': 'SiDLY VITAL CARE'
            };
            return dispositivi[servizio] || 'N/A';
        }

        // ============================================
        // CRUD CONTRATTI + PDF VIEWER
        // ============================================
        
        async function viewContract(contractId) {
            const contract = allContracts.find(c => c.id === contractId);
            if (!contract) {
                alert('‚ùå Contratto non trovato');
                return;
            }
            
            alert(\`üìÑ CONTRATTO: \${contract.codice_contratto || contract.id}

üë§ Cliente: \${contract.cliente_nome || ''} \${contract.cliente_cognome || ''}
üí∞ Importo: ‚Ç¨\${contract.prezzo_totale || 'N/A'}
üìÖ Data: \${new Date(contract.created_at).toLocaleDateString('it-IT')}
üìä Status: \${contract.status_italiano || contract.status || 'N/A'}\`);
        }
        
        async function editContract(contractId) {
            alert(\`‚ö†Ô∏è Funzione Edit Contratto in sviluppo.

Per ora puoi modificare i contratti tramite API:
PUT /api/contratti/\${contractId}\`);
        }
        
        async function deleteContract(contractId) {
            if (!confirm(\`‚ö†Ô∏è Sei sicuro di voler eliminare questo contratto?\\n\\nQuesta operazione √® irreversibile.\`)) {
                return;
            }
            
            try {
                const response = await fetch(\`/api/contratti/\${contractId}\`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Contratto eliminato con successo!');
                    loadData();
                } else {
                    if (result.isSigned) {
                        alert('‚ùå Impossibile eliminare un contratto FIRMATO.\\n\\nPer motivi legali, i contratti firmati non possono essere eliminati.');
                    } else {
                        alert('‚ùå Errore: ' + result.error);
                    }
                }
            } catch (error) {
                alert('‚ùå Errore di comunicazione: ' + error.message);
            }
        }
        
        // ============================================
        // FIRMA CONTRATTO
        // ============================================
        
        function signContract(contractId) {
            const contract = allContracts.find(c => c.id === contractId);
            if (!contract) {
                alert('‚ùå Contratto non trovato');
                return;
            }
            
            // Pre-compila la modale con i dati del contratto
            document.getElementById('signContractId').value = contract.id;
            document.getElementById('signContractCode').textContent = contract.codice_contratto || contract.id;
            document.getElementById('signClienteName').textContent = \`\${escapeHtml(contract.cliente_nome)} \${escapeHtml(contract.cliente_cognome)}\`.trim() || 'N/A';
            document.getElementById('signDigitalName').value = \`\${escapeHtml(contract.cliente_nome)} \${escapeHtml(contract.cliente_cognome)}\`.trim();
            
            // Imposta data odierna
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('signDate').value = today;
            
            // Apri modale
            document.getElementById('signContractModal').classList.remove('hidden');
            document.getElementById('signContractModal').style.display = 'flex';
        }
        
        function closeSignContractModal() {
            document.getElementById('signContractModal').classList.add('hidden');
            document.getElementById('signContractModal').style.display = 'none';
            document.getElementById('signContractForm').reset();
        }
        
        // Submit handler firma contratto
        const signForm = document.getElementById('signContractForm');
        if (signForm) {
            signForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const contractId = document.getElementById('signContractId').value;
                const firmaDigitale = document.getElementById('signDigitalName').value;
                const dataFirma = document.getElementById('signDate').value;
                const note = document.getElementById('signNotes').value;
                
                try {
                    const response = await fetch('/api/contracts/sign', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contractId,
                            firmaDigitale,
                            dataFirma,
                            notes: note,
                            ipAddress: 'MANUAL_SIGNATURE',
                            userAgent: 'Data Dashboard'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Contratto firmato con successo!\\n\\nüìÑ Proforma generata e inviata al cliente.');
                    closeSignContractModal();
                    loadDataDashboard(); // Ricarica i dati
                } else {
                    alert('‚ùå Errore: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Errore di comunicazione: ' + error.message);
            }
        });
        } else {
            console.warn('‚ö†Ô∏è Elemento signContractForm non trovato - firma contratto non disponibile');
        }
        
        async function viewContractPDF(contractId) {
            const contract = allContracts.find(c => c.id === contractId);
            if (!contract) {
                alert('‚ùå Contratto non trovato');
                return;
            }
            
            // Usa l'endpoint API per generare/scaricare il PDF
            const pdfUrl = \`/api/contratti/\${contractId}/download\`;
            window.open(pdfUrl, '_blank');
        }

        // ============================================
        // CREATE CONTRATTO
        // ============================================
        
        function openNewContractModal() {
            document.getElementById('newContractForm').reset();
            document.getElementById('newContractModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            // Carica lista lead per dropdown
            loadLeadsForContract();
        }
        
        function closeNewContractModal() {
            document.getElementById('newContractModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        async function loadLeadsForContract() {
            try {
                const response = await fetch('/api/leads?limit=200');
                const data = await response.json();
                const leads = data.leads || [];
                
                const select = document.getElementById('newContractLeadId');
                select.innerHTML = '<option value="">Seleziona lead...</option>';
                
                leads.forEach(lead => {
                    const option = document.createElement('option');
                    option.value = lead.id;
                    option.textContent = \`\${escapeHtml(lead.nome)} \${escapeHtml(lead.cognome)} - \${escapeHtml(lead.email)}\`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Errore caricamento leads:', error);
            }
        }
        
        async function saveNewContract() {
            const leadId = document.getElementById('newContractLeadId').value;
            const piano = document.getElementById('newContractPiano').value;
            const note = document.getElementById('newContractNote').value;
            
            if (!leadId) {
                alert('‚ö†Ô∏è Seleziona un lead');
                return;
            }
            
            if (!piano) {
                alert('‚ö†Ô∏è Seleziona un piano');
                return;
            }
            
            // Calcola importo in base al piano
            const importo = piano === 'AVANZATO' ? 840 : 480;
            
            const contractData = {
                lead_id: leadId,
                piano: piano,
                importo_annuo: importo,
                status: 'DRAFT',
                note: note || 'Piano: ' + piano
            };
            
            try {
                const response = await fetch('/api/contratti', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(contractData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Contratto creato con successo!\\n\\nCodice: ' + (result.contract.codice_contratto || result.contract.id) + '\\nImporto: ‚Ç¨' + importo + '/anno\\nPiano: ' + piano);
                    closeNewContractModal();
                    loadDataDashboard(); // Ricarica la pagina
                } else {
                    alert('‚ùå Errore: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Errore di comunicazione: ' + error.message);
            }
        }

        // Load data on page load (chiamata dopo tutte le definizioni)
        window.addEventListener('DOMContentLoaded', () => {
            loadDataDashboard();
        });
        
        
        async function nuovoAssistito() {
            try {
                // Richiedi dati nuovo assistito
                const nomeAssistito = prompt('Nome Assistito:');
                if (!nomeAssistito) return;
                
                const cognomeAssistito = prompt('Cognome Assistito:');
                if (!cognomeAssistito) return;
                
                const email = prompt('Email (opzionale):') || '';
                const telefono = prompt('Telefono (opzionale):') || '';
                const imei = prompt('IMEI Dispositivo (richiesto):');
                if (!imei) {
                    alert('‚ö†Ô∏è IMEI √® obbligatorio!');
                    return;
                }
                
                const caregiverNome = prompt('Nome Caregiver (opzionale):') || '';
                const caregiverCognome = prompt('Cognome Caregiver (opzionale):') || '';
                const parentela = prompt('Parentela Caregiver (opzionale, es: figlia, figlio):') || '';
                
                // Crea assistito
                const response = await fetch('/api/assistiti', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nome_assistito: nomeAssistito,
                        cognome_assistito: cognomeAssistito,
                        nome_caregiver: caregiverNome,
                        cognome_caregiver: caregiverCognome,
                        parentela_caregiver: parentela,
                        email,
                        telefono,
                        imei,
                        status: 'ATTIVO'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Assistito ' + nomeAssistito + ' ' + cognomeAssistito + ' creato con successo!');
                    loadDashboardData(); // Ricarica dashboard
                } else {
                    alert('‚ùå Errore: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
            }
        }
        
        // ========== FINE CRUD ASSISTITI ==========
    <\/script>

    <!-- MODAL: NEW CONTRACT -->
    <div id="newContractModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="gradient-bg text-white px-6 py-4 rounded-t-lg flex justify-between items-center">
                <h3 class="text-xl font-bold">‚ûï Nuovo Contratto</h3>
                <button onclick="closeNewContractModal()" class="text-white hover:text-gray-200 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <form id="newContractForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Lead *</label>
                            <select id="newContractLeadId" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Caricamento...</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Seleziona il lead per cui creare il contratto</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Piano *</label>
                            <select id="newContractPiano" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Seleziona piano...</option>
                                <option value="BASE">BASE - ‚Ç¨480/anno (‚Ç¨240 rinnovo)</option>
                                <option value="AVANZATO">AVANZATO - ‚Ç¨840/anno (‚Ç¨600 rinnovo)</option>
                            </select>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-bold text-sm text-blue-800 mb-2">üìã Dettagli Piano</h4>
                            <div class="text-xs text-gray-700 space-y-1">
                                <p><strong>Servizio:</strong> eCura PRO</p>
                                <p><strong>Dispositivo:</strong> SiDLY CARE PRO (Classe IIa)</p>
                                <p><strong>Funzioni:</strong> Telemedicina avanzata + SOS</p>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
                            <textarea id="newContractNote" rows="3" placeholder="Note aggiuntive sul contratto..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                            <p class="text-xs text-gray-700">
                                <i class="fas fa-info-circle text-yellow-600 mr-1"></i>
                                Il contratto sar√† creato con status <strong>DRAFT</strong>. 
                                Dopo la creazione potrai inviarlo al cliente via email dalla Dashboard Leads.
                            </p>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end gap-3">
                        <button type="button" onclick="closeNewContractModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                            Annulla
                        </button>
                        <button type="button" onclick="saveNewContract()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                            ‚ûï Crea Contratto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Firma Contratto -->
    <div id="signContractModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
            <div class="bg-purple-600 text-white p-6 rounded-t-xl">
                <h3 class="text-xl font-bold flex items-center">
                    <i class="fas fa-signature mr-3"></i>
                    Registra Firma Contratto
                </h3>
            </div>
            <form id="signContractForm" class="p-6">
                <input type="hidden" id="signContractId">
                <div class="space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-sm text-gray-700">
                            <strong>Contratto:</strong> <span id="signContractCode"></span><br>
                            <strong>Cliente:</strong> <span id="signClienteName"></span>
                        </p>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Firma Digitale *</label>
                        <input type="text" id="signDigitalName" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                            placeholder="Nome Cognome del firmatario">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Data Firma</label>
                        <input type="date" id="signDate" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Note</label>
                        <textarea id="signNotes" rows="3"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                            placeholder="Es: Contratto firmato in sede"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex space-x-3">
                    <button type="button" onclick="closeSignContractModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 rounded-lg transition-colors">
                        Annulla
                    </button>
                    <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg transition-colors">
                        <i class="fas fa-check mr-2"></i>Conferma Firma
                    </button>
                </div>
            </form>
        </div>
    </div>

    ${Fp}
</body>
</html>
`,pw=`<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Manager - TeleMedCare V12.0</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .step-active { border-color: #10b981; background: #d1fae5; }
        .step-pending { border-color: #fbbf24; background: #fef3c7; }
        .step-completed { border-color: #3b82f6; background: #dbeafe; }
        .modal { display: none; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-diagram-project text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Workflow Manager</h1>
                        <p class="text-red-100">Gestione completa ciclo Lead ‚Üí Attivazione</p>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <a href="/" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-home mr-2"></i>Home
                    </a>
                    <button onclick="refreshWorkflows()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-sync-alt mr-2"></i>Aggiorna
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Workflow Steps Overview -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-sitemap text-red-500 mr-2"></i>
                Stati Workflow TeleMedCare
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                <div onclick="openArchive('leads')" class="border-2 border-blue-200 bg-blue-50 p-4 rounded-lg text-center cursor-pointer hover:shadow-lg transition-all">
                    <i class="fas fa-user-plus text-3xl text-blue-600 mb-2"></i>
                    <h4 class="font-bold text-sm text-gray-800">1. Lead</h4>
                    <p class="text-xs text-gray-600 mt-1">Acquisizione contatto</p>
                </div>
                <div onclick="openArchive('contratti')" class="border-2 border-green-200 bg-green-50 p-4 rounded-lg text-center cursor-pointer hover:shadow-lg transition-all">
                    <i class="fas fa-file-contract text-3xl text-green-600 mb-2"></i>
                    <h4 class="font-bold text-sm text-gray-800">2. Contratto</h4>
                    <p class="text-xs text-gray-600 mt-1">Generazione PDF</p>
                </div>
                <div onclick="openArchive('firme')" class="border-2 border-purple-200 bg-purple-50 p-4 rounded-lg text-center cursor-pointer hover:shadow-lg transition-all">
                    <i class="fas fa-signature text-3xl text-purple-600 mb-2"></i>
                    <h4 class="font-bold text-sm text-gray-800">3. Firma</h4>
                    <p class="text-xs text-gray-600 mt-1">Firma elettronica</p>
                </div>
                <div onclick="openArchive('proforma')" class="border-2 border-yellow-200 bg-yellow-50 p-4 rounded-lg text-center cursor-pointer hover:shadow-lg transition-all">
                    <i class="fas fa-file-invoice text-3xl text-yellow-600 mb-2"></i>
                    <h4 class="font-bold text-sm text-gray-800">4. Proforma</h4>
                    <p class="text-xs text-gray-600 mt-1">Generazione fattura</p>
                </div>
                <div onclick="openArchive('pagamenti')" class="border-2 border-orange-200 bg-orange-50 p-4 rounded-lg text-center cursor-pointer hover:shadow-lg transition-all">
                    <i class="fas fa-credit-card text-3xl text-orange-600 mb-2"></i>
                    <h4 class="font-bold text-sm text-gray-800">5. Pagamento</h4>
                    <p class="text-xs text-gray-600 mt-1">Conferma bonifico</p>
                </div>
                <div onclick="openArchive('attivi')" class="border-2 border-indigo-200 bg-indigo-50 p-4 rounded-lg text-center cursor-pointer hover:shadow-lg transition-all">
                    <i class="fas fa-check-circle text-3xl text-indigo-600 mb-2"></i>
                    <h4 class="font-bold text-sm text-gray-800">6. Attivazione</h4>
                    <p class="text-xs text-gray-600 mt-1">Servizio attivo</p>
                </div>
            </div>
        </div>

        <!-- Lead in Progress -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-tasks text-orange-500 mr-2"></i>
                    Lead in Lavorazione
                </h3>
                <div class="flex space-x-2">
                    <select id="filterStatus" class="border border-gray-300 rounded-lg px-3 py-2 text-sm" onchange="applyFilters()">
                        <option value="">Tutti gli stati</option>
                        <option value="NEW">Nuovo</option>
                        <option value="CONTRACT_SENT">Contratto Inviato</option>
                        <option value="CONTRACT_SIGNED">Contratto Firmato</option>
                        <option value="PROFORMA_SENT">Proforma Inviata</option>
                        <option value="PAID">Pagato</option>
                        <option value="ACTIVE">Attivo</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-200 text-left">
                            <th class="pb-3 text-sm font-semibold text-gray-600">Lead ID</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Cliente</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Email</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Telefono</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Servizio</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Stato</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Step Corrente</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Data</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="workflowTable">
                        <tr>
                            <td colspan="9" class="py-8 text-center text-gray-400">
                                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                <p>Caricamento workflow...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Manual Actions -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Firma Manuale -->
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl shadow-md p-6 border-2 border-purple-200">
                <h4 class="text-lg font-bold text-purple-800 mb-4 flex items-center">
                    <i class="fas fa-signature text-2xl mr-3"></i>
                    Firma Manuale Contratto
                </h4>
                <p class="text-sm text-gray-700 mb-4">
                    Usa questa funzione quando il contratto viene firmato manualmente (cartaceo) e vuoi registrarlo nel sistema.
                </p>
                <button onclick="openSignModal()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg transition-colors">
                    <i class="fas fa-pen mr-2"></i>Registra Firma Manuale
                </button>
            </div>

            <!-- Pagamento Manuale -->
            <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl shadow-md p-6 border-2 border-orange-200">
                <h4 class="text-lg font-bold text-orange-800 mb-4 flex items-center">
                    <i class="fas fa-money-check text-2xl mr-3"></i>
                    Pagamento Manuale Bonifico
                </h4>
                <p class="text-sm text-gray-700 mb-4">
                    Registra un pagamento ricevuto tramite bonifico bancario per procedere con l'attivazione del servizio.
                </p>
                <button onclick="openPaymentModal()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 rounded-lg transition-colors">
                    <i class="fas fa-university mr-2"></i>Registra Pagamento Bonifico
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Firma Manuale -->
    <div id="signModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
            <div class="bg-purple-600 text-white p-6 rounded-t-xl">
                <h3 class="text-xl font-bold flex items-center">
                    <i class="fas fa-signature mr-3"></i>
                    Registra Firma Manuale
                </h3>
            </div>
            <form id="signForm" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Lead/Contratto ID *</label>
                        <input type="text" id="signContractId" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                            placeholder="LEAD_xxx o CTR_xxx">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Firma Digitale</label>
                        <input type="text" id="signDigital"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                            placeholder="Nome Cognome (manuale)">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Note</label>
                        <textarea id="signNotes" rows="3"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                            placeholder="Es: Contratto firmato in sede il gg/mm/aaaa"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex space-x-3">
                    <button type="button" onclick="closeSignModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 rounded-lg transition-colors">
                        Annulla
                    </button>
                    <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg transition-colors">
                        <i class="fas fa-check mr-2"></i>Conferma
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Pagamento Manuale -->
    <div id="paymentModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
            <div class="bg-orange-600 text-white p-6 rounded-t-xl">
                <h3 class="text-xl font-bold flex items-center">
                    <i class="fas fa-money-check mr-3"></i>
                    Registra Pagamento Bonifico
                </h3>
            </div>
            <form id="paymentForm" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Proforma ID *</label>
                        <input type="text" id="paymentProformaId" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none"
                            placeholder="PRF_xxx">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Importo (‚Ç¨) *</label>
                        <input type="number" id="paymentAmount" required step="0.01"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none"
                            placeholder="480.00">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Transaction ID / CRO</label>
                        <input type="text" id="paymentTransactionId"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none"
                            placeholder="TRN123456 o CRO">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Note</label>
                        <textarea id="paymentNotes" rows="3"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none"
                            placeholder="Es: Bonifico ricevuto il gg/mm/aaaa"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex space-x-3">
                    <button type="button" onclick="closePaymentModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 rounded-lg transition-colors">
                        Annulla
                    </button>
                    <button type="submit" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 rounded-lg transition-colors">
                        <i class="fas fa-check mr-2"></i>Conferma
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allLeads = [];
        let isLoading = false; // Previene chiamate multiple simultanee
        
        // Helper: escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Helper: escape quotes for strings in JS
        function escapeQuotes(str) {
            return String(str || '').replace(/"/g, '\\"').replace(/'/g, "\\'");
        }

        window.loadWorkflows = async function() {
            // Previeni chiamate multiple simultanee
            if (isLoading) {
                console.log('Caricamento gi√† in corso, skip...');
                return;
            }
            
            isLoading = true;
            
            try {
                const response = await fetch('/api/leads?limit=100');
                const data = await response.json();
                allLeads = data.leads || [];
                renderWorkflowTable(allLeads);
            } catch (error) {
                console.error('Errore caricamento workflow:', error);
                document.getElementById('workflowTable').innerHTML = \`
                    <tr>
                        <td colspan="8" class="py-8 text-center text-red-500">
                            <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                            <p>Errore nel caricamento dei workflow</p>
                        </td>
                    </tr>
                \`;
            } finally {
                isLoading = false;
            }
        }

        function renderWorkflowTable(leads) {
            const tbody = document.getElementById('workflowTable');
            
            if (leads.length === 0) {
                tbody.innerHTML = \`
                    <tr>
                        <td colspan="8" class="py-8 text-center text-gray-400">Nessun workflow in corso</td>
                    </tr>
                \`;
                return;
            }

            tbody.innerHTML = leads.map(lead => {
                const status = getWorkflowStatus(lead);
                const step = getWorkflowStep(lead);
                const date = new Date(lead.created_at).toLocaleString('it-IT');
                
                // Mostra servizio cos√¨ com'√® dal DB
                const servizio = lead.servizio || lead.tipoServizio || 'eCura PRO';
                
                return \`
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 text-xs">
                            <code class="bg-gray-100 px-2 py-1 rounded">\${(lead.id || '').substring(0, 25)}</code>
                        </td>
                        <td class="py-3 text-sm">
                            <div class="font-medium">\${escapeHtml(lead.nomeRichiedente)} \${escapeHtml(lead.cognomeRichiedente)}</div>
                        </td>
                        <td class="py-3 text-sm">
                            <div class="text-xs text-gray-600">
                                <i class="fas fa-envelope text-gray-400 mr-1"></i>\${lead.email || lead.emailRichiedente || '-'}
                            </div>
                        </td>
                        <td class="py-3 text-sm">
                            <div class="flex items-center text-gray-700">
                                <i class="fas fa-phone text-xs mr-1 text-gray-400"></i>
                                <span class="text-xs">\${lead.telefono || '-'}</span>
                            </div>
                        </td>
                        <td class="py-3 text-sm">
                            <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded font-medium">
                                \${servizio}
                            </span>
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 \${status.class} text-xs rounded font-medium">
                                \${status.text}
                            </span>
                        </td>
                        <td class="py-3 text-sm">
                            <div class="flex items-center">
                                <i class="\${step.icon} \${step.color} mr-2"></i>
                                <span class="text-xs">\${step.text}</span>
                            </div>
                        </td>
                        <td class="py-3 text-xs text-gray-500">\${date}</td>
                        <td class="py-3">
                            <div class="flex space-x-1">
                                <button onclick="quickAction('\${lead.id}', 'view')" 
                                    class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded" 
                                    title="Visualizza Dettagli">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="quickAction('\${lead.id}', 'payment')" 
                                    class="px-2 py-1 bg-orange-500 hover:bg-orange-600 text-white text-xs rounded" 
                                    title="Registra Pagamento">
                                    <i class="fas fa-euro-sign"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                \`;
            }).join('');
        }

        function getWorkflowStatus(lead) {
            // Determina stato workflow con tutti gli stati
            const status = lead.status?.toUpperCase();
            
            if (status === 'CONVERTED') {
                return { class: 'bg-green-100 text-green-700', text: 'CONVERTITO' };
            } else if (status === 'CONTRACT_SIGNED') {
                return { class: 'bg-green-100 text-green-700', text: 'CONTRATTO FIRMATO' };
            } else if (status === 'CONTRACT_SENT') {
                return { class: 'bg-blue-100 text-blue-700', text: 'CONTRATTO INVIATO' };
            } else if (status === 'ACTIVE') {
                return { class: 'bg-green-100 text-green-700', text: 'ATTIVO' };
            } else if (lead.contratto_inviato) {
                return { class: 'bg-blue-100 text-blue-700', text: 'CONTRATTO INVIATO' };
            } else if (status === 'NEW' || status === 'NUOVO') {
                return { class: 'bg-yellow-100 text-yellow-700', text: 'NUOVO' };
            } else {
                return { class: 'bg-gray-100 text-gray-700', text: status || 'NUOVO' };
            }
        }

        function getWorkflowStep(lead) {
            // Determina step corrente
            if (lead.status === 'ACTIVE') {
                return { icon: 'fas fa-check-circle', color: 'text-green-600', text: '6. Attivato' };
            } else if (lead.payment_confirmed) {
                return { icon: 'fas fa-credit-card', color: 'text-orange-600', text: '5. Pagamento OK' };
            } else if (lead.proforma_sent) {
                return { icon: 'fas fa-file-invoice', color: 'text-yellow-600', text: '4. Proforma Inviata' };
            } else if (lead.contract_signed) {
                return { icon: 'fas fa-signature', color: 'text-purple-600', text: '3. Contratto Firmato' };
            } else if (lead.contratto_inviato) {
                return { icon: 'fas fa-file-contract', color: 'text-blue-600', text: '2. Contratto Inviato' };
            } else {
                return { icon: 'fas fa-user-plus', color: 'text-gray-600', text: '1. Lead Nuovo' };
            }
        }

        function applyFilters() {
            const statusFilter = document.getElementById('filterStatus').value;
            const filtered = allLeads.filter(lead => {
                if (!statusFilter) return true;
                return getWorkflowStatus(lead).text === statusFilter;
            });
            renderWorkflowTable(filtered);
        }

        function refreshWorkflows() {
            window.loadWorkflows();
        }

        function viewWorkflowDetails(leadId) {
            alert('Dettagli workflow per Lead: ' + leadId + '\\n\\nFunzionalit√† in sviluppo...');
        }

        // Open Archive - Click sui box workflow per aprire archivi completi
        async function openArchive(type) {
            try {
                let url = '';
                let title = '';
                
                switch(type) {
                    case 'leads':
                        url = '/api/leads?limit=1000';
                        title = 'üìã ARCHIVIO COMPLETO LEADS';
                        break;
                    case 'contratti':
                        url = '/api/contratti?limit=1000';
                        title = 'üìÑ ARCHIVIO COMPLETO CONTRATTI';
                        break;
                    case 'firme':
                        url = '/api/signatures?limit=1000';
                        title = '‚úçÔ∏è ARCHIVIO FIRME ELETTRONICHE';
                        break;
                    case 'proforma':
                        url = '/api/proforma?limit=1000';
                        title = 'üìã ARCHIVIO PROFORMA/FATTURE';
                        break;
                    case 'pagamenti':
                        url = '/api/payments?limit=1000';
                        title = 'üí∞ ARCHIVIO PAGAMENTI';
                        break;
                    case 'attivi':
                        url = '/api/leads?status=ACTIVE&limit=1000';
                        title = '‚úÖ SERVIZI ATTIVI';
                        break;
                    default:
                        alert('‚ö†Ô∏è Archivio non riconosciuto');
                        return;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                // Estrai l'array corretto in base al tipo
                let items = [];
                if (type === 'leads') items = data.leads || [];
                else if (type === 'contratti') items = data.contratti || [];
                else if (type === 'firme') items = data.signatures || [];
                else if (type === 'proforma') items = data.proforma || [];
                else if (type === 'pagamenti') items = data.payments || [];
                else if (type === 'attivi') items = data.leads || [];
                
                // Crea messaggio riepilogo
                let message = \`\${title}\\n\\nTotale: \${items.length} record\\n\\n\`;
                
                if (items.length === 0) {
                    message += 'Nessun record trovato.';
                } else if (items.length <= 10) {
                    // Mostra tutti i record se <= 10
                    items.forEach((item, idx) => {
                        if (type === 'leads') {
                            message += \`\${idx+1}. \${escapeHtml(item.nomeRichiedente)} \${escapeHtml(item.cognomeRichiedente)} - \${item.email || 'N/A'}\\n\`;
                        } else if (type === 'contratti') {
                            message += \`\${idx+1}. \${item.codice_contratto || item.id} - \${escapeHtml(item.cliente_nome)} \${escapeHtml(item.cliente_cognome)}\\n\`;
                        } else if (type === 'firme') {
                            message += \`\${idx+1}. Firma \${item.id} - Contratto: \${item.contract_id}\\n\`;
                        } else if (type === 'proforma') {
                            message += \`\${idx+1}. Proforma \${item.numero || item.id} - ‚Ç¨\${item.importo || '0'}\\n\`;
                        } else if (type === 'pagamenti') {
                            message += \`\${idx+1}. Pagamento \${item.id} - ‚Ç¨\${item.importo || '0'} - \${item.metodo_pagamento || 'N/A'}\\n\`;
                        } else {
                            message += \`\${idx+1}. \${escapeHtml(item.nomeRichiedente)} \${escapeHtml(item.cognomeRichiedente)} - ATTIVO\\n\`;
                        }
                    });
                } else {
                    // Mostra solo primi 10 + conteggio
                    message += 'Primi 10 record:\\n\\n';
                    items.slice(0, 10).forEach((item, idx) => {
                        if (type === 'leads' || type === 'attivi') {
                            const status = item.status || 'NUOVO';
                            const statusText = status === 'ACTIVE' ? '‚úÖ ATTIVO' : 
                                             status === 'CONVERTED' ? '‚úì CONVERTITO' :
                                             status === 'CONTRACT_SIGNED' ? '‚úçÔ∏è FIRMATO' : 'üÜï NUOVO';
                            message += \`\${idx+1}. \${escapeHtml(item.nomeRichiedente)} \${escapeHtml(item.cognomeRichiedente)} - \${statusText}\\n\`;
                        } else if (type === 'contratti') {
                            message += \`\${idx+1}. \${escapeHtml(item.cliente_nome)} \${escapeHtml(item.cliente_cognome)}\\n\`;
                        } else {
                            message += \`\${idx+1}. ID: \${item.id}\\n\`;
                        }
                    });
                    message += \`\\n... e altri \${items.length - 10} record.\\n\`;
                    message += \`\\nüí° Per visualizzare tutti i dati, vai alla dashboard specifica o usa l'API.\`;
                }
                
                alert(message);
                
            } catch (error) {
                console.error('Errore apertura archivio:', error);
                alert('‚ùå Errore nel caricamento dell\\'archivio.\\n\\n' + error.message);
            }
        }
        window.openArchive = openArchive;  // Esponi globalmente

        // Quick Actions per ogni riga della tabella
        function quickAction(leadId, action) {
            const lead = allLeads.find(l => l.id === leadId);
            if (!lead) {
                alert('‚ùå Lead non trovato');
                return;
            }
            
            switch(action) {
                case 'view':
                    // Mostra dettagli completi del lead
                    const piano = lead.piano || ((lead.note && lead.note.includes('Piano: AVANZATO')) ? 'AVANZATO' : 'BASE');
                    const prezzo = lead.prezzo_anno ? String(lead.prezzo_anno) : '0';
                    
                    // Mostra servizio cosi come dal DB
                    const servizio = lead.servizio || lead.tipoServizio || 'eCura PRO';
                    
                    alert('üë§ LEAD: ' + (lead.nomeRichiedente || '') + ' ' + (lead.cognomeRichiedente || '') + '\\n\\n' +
                    'üìß Email: ' + (lead.email || 'N/A') + '\\n' +
                    'üìû Telefono: ' + (lead.telefono || 'N/A') + '\\n' +
                    'üè• Servizio: ' + servizio + '\\n' +
                    'üìã Piano: ' + piano + ' (' + prezzo + '/anno)' + '\\n' +
                    'üìÖ Creato: ' + new Date(lead.created_at).toLocaleDateString('it-IT') + '\\n' +
                    'üìç Stato: ' + getWorkflowStatus(lead).text + '\\n' +
                    'üîÑ Step: ' + getWorkflowStep(lead).text + '\\n\\n' +
                    'üìù Note: ' + (lead.note || 'Nessuna nota'));
                    break;
                    
                case 'contract':
                    // Pre-compila modale firma contratto
                    const nomeCompleto = escapeQuotes((lead.nomeRichiedente || '') + ' ' + (lead.cognomeRichiedente || ''));
                    const emailSafe = escapeQuotes(lead.email || '');
                    if (confirm(\`üìù Vuoi registrare la firma del contratto per:\\n\\nüë§ \${nomeCompleto}\\nüìß \${emailSafe}\\n\\n‚úÖ Procedi?\`)) {
                        document.getElementById('signContractId').value = lead.id;
                        document.getElementById('signDigital').value = nomeCompleto;
                        openSignModal();
                    }
                    break;
                    
                case 'payment':
                    // Pre-compila modale pagamento
                    const nomeCompletoPayment = escapeQuotes((lead.nomeRichiedente || '') + ' ' + (lead.cognomeRichiedente || ''));
                    const emailSafePayment = escapeQuotes(lead.email || '');
                    if (confirm(\`üí∞ Vuoi registrare il pagamento per:\\n\\nüë§ \${nomeCompletoPayment}\\nüìß \${emailSafePayment}\\n\\n‚úÖ Procedi?\`)) {
                        // Cerca proforma associata al lead
                        fetch('/api/proforma?lead_id=' + lead.id)
                            .then(res => res.json())
                            .then(data => {
                                if (data.proforma && data.proforma.length > 0) {
                                    const proforma = data.proforma[0];
                                    document.getElementById('paymentProformaId').value = proforma.id;
                                    document.getElementById('paymentAmount').value = proforma.importo;
                                    openPaymentModal();
                                } else {
                                    alert('‚ö†Ô∏è Nessuna proforma trovata per questo lead.\\n\\nCrea prima una proforma tramite la dashboard contratti.');
                                }
                            })
                            .catch(err => {
                                console.error('Errore caricamento proforma:', err);
                                alert('‚ùå Errore nel caricamento della proforma.\\n\\nInserisci manualmente i dati.');
                                openPaymentModal();
                            });
                    }
                    break;
                    
                default:
                    alert('‚ö†Ô∏è Azione non riconosciuta');
            }
        }

        // Modal functions
        function openSignModal() {
            document.getElementById('signModal').classList.add('active');
        }

        function closeSignModal() {
            document.getElementById('signModal').classList.remove('active');
            document.getElementById('signForm').reset();
        }

        function openPaymentModal() {
            document.getElementById('paymentModal').classList.add('active');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
            document.getElementById('paymentForm').reset();
        }

        // Form submissions (usa once: true per evitare listener multipli)
        const signForm = document.getElementById('signForm');
        if (signForm && !signForm.dataset.listenerAdded) {
            signForm.dataset.listenerAdded = 'true';
            signForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const contractId = document.getElementById('signContractId').value;
                const firmaDigitale = document.getElementById('signDigital').value || 'Firma Manuale';
                const notes = document.getElementById('signNotes').value;
                
                try {
                    const response = await fetch('/api/contracts/sign', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contractId,
                            firmaDigitale: firmaDigitale + (notes ? \` - \${notes}\` : ''),
                            ipAddress: 'MANUAL_SIGNATURE',
                            userAgent: 'Workflow Manager Dashboard'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('‚úÖ Firma registrata con successo!\\n\\nProforma generata e inviata.');
                        closeSignModal();
                        refreshWorkflows();
                    } else {
                        alert('‚ùå Errore: ' + result.error);
                    }
                } catch (error) {
                    alert('‚ùå Errore di comunicazione: ' + error.message);
                }
            });
        }

        const paymentForm = document.getElementById('paymentForm');
        if (paymentForm && !paymentForm.dataset.listenerAdded) {
            paymentForm.dataset.listenerAdded = 'true';
            paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const proformaId = document.getElementById('paymentProformaId').value;
            const importo = parseFloat(document.getElementById('paymentAmount').value);
            const transactionId = document.getElementById('paymentTransactionId').value || 'MANUAL_PAYMENT';
            const notes = document.getElementById('paymentNotes').value;
            
            try {
                const response = await fetch('/api/payments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        proformaId,
                        importo,
                        metodoPagamento: 'bonifico_bancario',
                        transactionId: transactionId + (notes ? \` - \${notes}\` : ''),
                        manual: true
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Pagamento registrato con successo!\\n\\nProcedura di attivazione avviata.');
                    closePaymentModal();
                    refreshWorkflows();
                } else {
                    alert('‚ùå Errore: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Errore di comunicazione: ' + error.message);
            }
        });
        }

        // ============================================
        // SETTINGS: SWITCH ON/OFF - LOAD SETTINGS
        // ============================================
        
        window.loadSettings = async function() {
            try {
                console.log('üì• [SETTINGS] Caricamento settings dal database...');
                const response = await fetch('/api/settings');
                const data = await response.json();
                
                console.log('üì• [SETTINGS] Response:', data);
                
                if (data.success && data.settings) {
                    const settings = data.settings;
                    
                    // Update select states - tutti e 4 i settings
                    if (settings.hubspot_auto_import_enabled) {
                        const value = settings.hubspot_auto_import_enabled.value;
                        console.log('‚úÖ [SETTINGS] HubSpot:', value);
                        document.getElementById('selectHubspotAuto').value = value;
                    }
                    if (settings.lead_email_notifications_enabled) {
                        const value = settings.lead_email_notifications_enabled.value;
                        console.log('‚úÖ [SETTINGS] Lead Emails:', value);
                        document.getElementById('selectLeadEmails').value = value;
                    }
                    if (settings.admin_email_notifications_enabled) {
                        const value = settings.admin_email_notifications_enabled.value;
                        console.log('‚úÖ [SETTINGS] Admin Emails:', value);
                        document.getElementById('selectAdminEmails').value = value;
                    }
                    if (settings.reminder_completion_enabled) {
                        const value = settings.reminder_completion_enabled.value;
                        console.log('‚úÖ [SETTINGS] Reminder:', value);
                        document.getElementById('selectReminderCompletion').value = value;
                    }
                    
                    console.log('‚úÖ [SETTINGS] Tutti e 4 gli switch caricati correttamente');
                } else {
                    console.error('‚ùå [SETTINGS] Risposta API non valida:', data);
                }
            } catch (error) {
                console.error('‚ùå [SETTINGS] Errore caricamento settings:', error);
            }
        }
        
        // Nota: window.updateSetting √® gi√† definita inline dopo gli switch HTML

        // Load workflows on page load (chiamata dopo tutte le definizioni)
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ [DASHBOARD] DOM Loaded - Inizializzazione...');
            window.loadWorkflows();
            window.loadSettings(); // Carica gli switch dal DB
            console.log('‚úÖ [DASHBOARD] Inizializzazione completata');
        });
    <\/script>
</body>
</html>
`;function mw(o,t,e){return`
    <!DOCTYPE html>
    <html><head><title>Contratto TeleMedCare ${t}</title></head>
    <body>
      <h1>CONTRATTO DI SERVIZIO TELEMEDCARE ${t}</h1>
      <h2>DATI CONTRAENTE</h2>
      <p><strong>Nome:</strong> ${o.nomeRichiedente} ${o.cognomeRichiedente}</p>
      <p><strong>Email:</strong> ${o.email}</p>
      <p><strong>Telefono:</strong> ${o.telefono||"Non specificato"}</p>
      
      <h2>SERVIZIO RICHIESTO</h2>
      <p><strong>Tipo:</strong> TeleMedCare ${t}</p>
      <p><strong>Durata:</strong> ${e.durata} mesi</p>
      <p><strong>Costo mensile:</strong> ‚Ç¨${e.mensile}</p>
      <p><strong>Costo totale:</strong> ‚Ç¨${e.totale}</p>
      
      <h2>CONDIZIONI</h2>
      <p>Il presente contratto regolamenta l'erogazione del servizio di telemedicina...</p>
      
      <div class="firma-section" style="margin-top: 50px; border: 1px solid #ccc; padding: 20px;">
        <h3>FIRMA ELETTRONICA</h3>
        <p>Firma qui sotto per accettare i termini del contratto:</p>
        <canvas id="signature-pad" width="400" height="200" style="border: 1px solid #000;"></canvas>
        <br><button onclick="firmaContratto()">Conferma Firma</button>
      </div>
      
      <script>
        function firmaContratto() {
          const canvas = document.getElementById('signature-pad');
          const firmaData = canvas.toDataURL();
          
          fetch('/api/contracts/sign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contractId: '${o.contractId||"CURRENT_CONTRACT"}',
              firmaDigitale: firmaData,
              ipAddress: 'auto-detect',
              userAgent: navigator.userAgent
            })
          }).then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Contratto firmato con successo!');
              window.location.href = '/grazie-firma';
            } else {
              alert('Errore nella firma: ' + data.error);
            }
          });
        }
      <\/script>
    </body>
    </html>
  `}async function gw(o,t){try{const e=await t.prepare(`
      SELECT c.*, l.nomeRichiedente, l.cognomeRichiedente, l.email, l.telefono
      FROM contracts c
      LEFT JOIN leads l ON c.leadId = l.id
      WHERE c.id = ? AND c.status = 'SIGNED'
    `).bind(o).first();if(!e)return{success:!1,error:"Contratto firmato non trovato"};const a=`PROFORMA_${Date.now()}_${Math.random().toString(36).substring(7)}`,i=`PF-${new Date().getFullYear()}-${String(Date.now()).slice(-6)}`,s=new Date(Date.now()+360*60*60*1e3);return await t.prepare(`
      INSERT INTO proforma (
        id, contract_id, leadId, numero_proforma, data_emissione, data_scadenza,
        cliente_nome, cliente_cognome, cliente_email, cliente_telefono,
        tipo_servizio, prezzo_mensile, durata_mesi, prezzo_totale, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(a,o,e.leadId,i,new Date().toISOString(),s.toISOString(),e.nomeRichiedente,e.cognomeRichiedente,e.email,e.telefono,e.tipo_contratto,e.prezzo_mensile,e.durata_mesi,e.prezzo_totale,"DRAFT").run(),{success:!0,proformaId:a,numeroProforma:i,message:"Proforma generata automaticamente"}}catch(e){return{success:!1,error:e.message}}}async function hw(o,t){try{console.log(`üìß INVIO REALE contratto ${o.codice_contratto} a ${o.email}`);const a=(await Promise.resolve().then(()=>Dt)).default.getInstance(),i={NOME_CLIENTE:o.nomeRichiedente||o.cognomeRichiedente||"Cliente",PIANO_SERVIZIO:o.contractType==="AVANZATO"?"TeleMedCare Avanzato":"TeleMedCare Basic",PREZZO_PIANO:o.contractType==="AVANZATO"?"‚Ç¨890/anno":"‚Ç¨490/anno",CODICE_CLIENTE:o.codice_contratto||o.id||"N/A"},s=await a.sendTemplateEmail("INVIO_CONTRATTO",o.email,i,void 0,t);return console.log("‚úÖ Email contratto risultato:",s),s}catch(e){return console.error("‚ùå Errore invio email contratto:",e),{success:!1,error:e.message}}}async function fw(o,t){try{console.log(`üìß INVIO REALE proforma ${o.numero_proforma} a ${o.email}`);const a=(await Promise.resolve().then(()=>Dt)).default.getInstance(),i={NOME_CLIENTE:o.cliente_nome||"Cliente",PIANO_SERVIZIO:o.servizio||"TeleMedCare",IMPORTO_TOTALE:`‚Ç¨${o.importo_totale}`,SCADENZA_PAGAMENTO:o.data_scadenza||"Da concordare",CODICE_CLIENTE:o.numero_proforma||o.id||"N/A"},s=await a.sendTemplateEmail("INVIO_PROFORMA",o.email,i,void 0,t);return console.log("‚úÖ Email proforma risultato:",s),s}catch(e){return console.error("‚ùå Errore invio email proforma:",e),{success:!1,error:e.message}}}async function vw(o,t,e){try{console.log(`üìß Invio landing page personalizzata a ${o} (${t}) da fonte ${e}`),console.log("Template: email_landing_page_personalizzata");const a=`${e}_${Date.now()}_${Math.random().toString(36).substring(7)}`,i=`https://telemedcare.it/landing?source=${e}&track=${a}&nome=${encodeURIComponent(t)}`;return{success:!0,messageId:`msg_${Date.now()}`,template:"email_landing_page_personalizzata",landingUrl:i}}catch(a){return{success:!1,error:a.message}}}function Ew(o){const t=(o||"").toLowerCase(),e=t.includes("avanzat")?"AVANZATO":"BASE";let a="PRO";t.includes("family")?a="FAMILY":t.includes("premium")&&(a="PREMIUM");const i=vc(a,e);return{servizio:a,piano:e,prezzoAnno:(i==null?void 0:i.setupTotale)||0,prezzoRinnovo:(i==null?void 0:i.rinnovoTotale)||0}}const I=new Dg;let jm=!1;I.use("*",async(o,t)=>{var e,a,i,s,r,l;if(!jm&&((e=o.env)!=null&&e.DB))try{console.log("üîÑ Avvio migrazione automatica database...");try{await o.env.DB.prepare("ALTER TABLE assistiti ADD COLUMN servizio TEXT DEFAULT 'eCura PRO'").run(),console.log("‚úÖ Colonna servizio aggiunta")}catch(c){(a=c.message)!=null&&a.includes("duplicate column")||console.warn("‚ö†Ô∏è Errore colonna servizio:",c.message)}try{await o.env.DB.prepare("ALTER TABLE assistiti ADD COLUMN piano TEXT DEFAULT 'BASE'").run(),console.log("‚úÖ Colonna piano aggiunta")}catch(c){(i=c.message)!=null&&i.includes("duplicate column")||console.warn("‚ö†Ô∏è Errore colonna piano:",c.message)}try{await o.env.DB.prepare("ALTER TABLE contracts ADD COLUMN servizio TEXT DEFAULT 'eCura PRO'").run(),console.log("‚úÖ Colonna servizio aggiunta a contracts")}catch(c){(s=c.message)!=null&&s.includes("duplicate column")||console.warn("‚ö†Ô∏è Errore colonna servizio contracts:",c.message)}try{await o.env.DB.prepare("ALTER TABLE leads ADD COLUMN prezzo_anno REAL DEFAULT 0").run(),console.log("‚úÖ Colonna prezzo_anno aggiunta a leads")}catch(c){(r=c.message)!=null&&r.includes("duplicate column")||console.warn("‚ö†Ô∏è Errore colonna prezzo_anno leads:",c.message)}try{await o.env.DB.prepare("ALTER TABLE leads ADD COLUMN prezzo_rinnovo REAL DEFAULT 0").run(),console.log("‚úÖ Colonna prezzo_rinnovo aggiunta a leads")}catch(c){(l=c.message)!=null&&l.includes("duplicate column")||console.warn("‚ö†Ô∏è Errore colonna prezzo_rinnovo leads:",c.message)}try{const c=await o.env.DB.prepare(`
          UPDATE assistiti 
          SET servizio = 'eCura PRO', piano = 'AVANZATO'
          WHERE (nome_assistito LIKE '%Eileen%' AND cognome_assistito LIKE '%King%')
             OR (nome_caregiver LIKE '%Elena%' AND cognome_caregiver LIKE '%Saglia%')
        `).run();c.changes&&c.changes>0&&console.log(`‚úÖ Eileen aggiornata a eCura PRO AVANZATO (${c.changes} record)`)}catch(c){console.warn("‚ö†Ô∏è Errore aggiornamento Eileen:",c.message)}jm=!0,console.log("‚úÖ Migrazione automatica completata")}catch(c){console.error("‚ùå Errore migrazione automatica:",c)}await t()});I.use("/api/*",J0());I.use("/assets/*",xp({root:"./"}));I.use("/documents/*",xp({root:"./"}));I.use("/*.html",xp({root:"./"}));I.get("/brochures/:filename",async o=>{var e;const t=o.req.param("filename");try{if((e=o.env)!=null&&e.ASSETS){console.log(`üì• Richiesta brochure: ${t} via ASSETS binding`);const a=new URL(`/brochures/${t}`,o.req.url),i=await o.env.ASSETS.fetch(a);if(i.ok)return console.log(`‚úÖ Brochure trovata: ${t}`),new Response(i.body,{status:200,headers:{"Content-Type":"application/pdf","Content-Disposition":`inline; filename="${t}"`,"Cache-Control":"public, max-age=31536000"}});console.error(`‚ùå ASSETS non trova: /brochures/${t} (status: ${i.status})`)}else console.warn(`‚ö†Ô∏è ASSETS binding non disponibile per ${t}`);return console.log(`üîÑ Fallback: tentativo lettura locale per ${t}`),o.text(`Brochure non disponibile: ${t}. Assicurati che il file esista in public/brochures/`,404)}catch(a){return console.error(`‚ùå Errore servizio brochure ${t}:`,a),o.text(`Errore interno: ${a instanceof Error?a.message:String(a)}`,500)}});I.get("/form-lead",o=>o.html(`
<!DOCTYPE html>
<html lang="it" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleMedCare V12.0 Modular Enterprise - Sistema di Telemedicina Avanzato</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      * {
        font-family: 'Inter', sans-serif;
      }

      .gradient-hero {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
      }

      .card-hover {
        transition: all 0.3s ease;
      }

      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      .badge-popular {
        background: linear-gradient(45deg, #f59e0b, #f97316);
        color: white;
        font-weight: bold;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        position: absolute;
        top: -10px;
        right: 20px;
      }

      .tech-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 2rem;
        color: white;
        transition: all 0.3s ease;
      }

      .tech-icon:hover {
        transform: scale(1.1);
      }

      .icon-fall {
        background: linear-gradient(45deg, #ef4444, #f87171);
      }
      .icon-gps {
        background: linear-gradient(45deg, #10b981, #34d399);
      }
      .icon-heart {
        background: linear-gradient(45deg, #ec4899, #f472b6);
      }
      .icon-sos {
        background: linear-gradient(45deg, #f59e0b, #fbbf24);
      }
      .icon-voice {
        background: linear-gradient(45deg, #8b5cf6, #a78bfa);
      }
      .icon-pill {
        background: linear-gradient(45deg, #06b6d4, #22d3ee);
      }

      .price-card {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        position: relative;
        border: 2px solid #e5e7eb;
        transition: all 0.3s ease;
      }

      .price-card:hover {
        border-color: #3b82f6;
        box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
      }

      .price-popular {
        border-color: #f59e0b;
        background: linear-gradient(to bottom, #fffbeb, white);
      }

      .btn-primary {
        background: linear-gradient(45deg, #3b82f6, #1d4ed8);
        color: white;
        padding: 0.75rem 2rem;
        border-radius: 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.8);
        padding: 0.75rem 2rem;
        border-radius: 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        cursor: pointer;
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border-color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .form-section {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      }

      .benefits-section {
        background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
      }

      .contact-gradient {
        background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .animate-fade-in {
        animation: fadeIn 0.3s ease-out;
      }

      .message-alert {
        transition: all 0.3s ease;
      }

      .message-alert:hover {
        transform: scale(1.02);
      }
    </style>
</head>
<body class="bg-white">

    <!-- Header -->
    <header class="bg-white shadow-md fixed w-full top-0 z-50">
      <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
        <div class="flex items-center">
          <h1 class="text-2xl font-bold text-blue-600">TeleMedCare</h1>
          <span class="ml-2 text-sm text-gray-600">Medica GB</span>
        </div>
        <div class="hidden md:flex space-x-6">
          <a href="#servizi" class="text-gray-700 hover:text-blue-600">Servizi</a>
          <a href="#tecnologia" class="text-gray-700 hover:text-blue-600">Tecnologia</a>
          <a href="#prezzi" class="text-gray-700 hover:text-blue-600">Prezzi</a>
          <a href="#contatti" class="text-gray-700 hover:text-blue-600">Contatti</a>
        </div>
      </nav>
    </header>

    <!-- Enterprise System Banner -->
    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-2">
      <div class="container mx-auto px-4 text-center">
        <span class="text-sm font-semibold">
           TeleMedCare V12.0 Modular Enterprise System  
          AI-Powered Lead Management  
          Multi-Partner Integration  
          Advanced Analytics
        </span>
      </div>
    </div>

    <!-- Hero Section -->
    <section class="gradient-hero text-white pt-24 pb-16">
      <div class="container mx-auto px-4 text-center">
        <h2 class="text-5xl md:text-6xl font-bold mb-6">La tecnologia che ti salva salute e vita</h2>
        <p class="text-xl md:text-2xl mb-8 max-w-4xl mx-auto">
          Servizi innovativi di TeleAssistenza e TeleMonitoraggio con dispositivo medico certificato SiDLY. Assistenza
          H24 direttamente dove c'√® necessit√†.
        </p>
        <div class="flex flex-col md:flex-row gap-4 justify-center">
          <button onclick="document.getElementById('form-richiesta').scrollIntoView({behavior: 'smooth'})" class="btn-primary">
            <i class="fas fa-envelope mr-2"></i>Richiedi Informazioni
          </button>
          <button onclick="document.getElementById('servizi').scrollIntoView({behavior: 'smooth'})" class="btn-secondary">
            <i class="fas fa-search mr-2"></i>Scopri i Servizi
          </button>
        </div>
      </div>
    </section>

    <!-- Chi Siamo -->
    <section class="py-16 bg-gray-50">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-bold text-gray-800 mb-4">Innovazione Socio-Sanitaria</h2>
          <p class="text-xl text-gray-600 max-w-3xl mx-auto">
            Medica GB S.r.l. nasce nel 2022 come startup innovativa a vocazione sociale, con l'obiettivo di
            rivoluzionare l'assistenza sanitaria attraverso tecnologie avanzate.
          </p>
        </div>
        <div class="max-w-4xl mx-auto text-center">
          <h3 class="text-2xl font-semibold text-blue-600 mb-4">Startup Innovativa a Vocazione Sociale</h3>
          <p class="text-lg text-gray-700">
            Eroghiamo servizi di TeleAssistenza, TeleMonitoraggio, Riabilitazione, Diagnostica e Assistenza Sanitaria
            direttamente dove c'√® necessit√†, cambiando il paradigma tradizionale.
          </p>
        </div>
      </div>
    </section>

    <!-- Servizi -->
    <section id="servizi" class="py-16">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-bold text-gray-800 mb-4">I Nostri Servizi</h2>
          <p class="text-xl text-gray-600">Soluzioni di TeleAssistenza personalizzate per ogni esigenza</p>
        </div>

        <div class="grid md:grid-cols-2 gap-8 max-w-6xl mx-auto">
          <!-- Servizio Base -->
          <div class="price-card card-hover">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">TeleAssistenza Base</h3>
            <p class="text-gray-600 mb-6">
              Soluzione completa con dispositivo medico SiDLY, monitoraggio automatico e comunicazione con i familiari.
            </p>

            <ul class="space-y-3 mb-6">
              <li class="flex items-center">
                <i class="fas fa-check text-green-500 mr-3"></i>Dispositivo Medicale Certificato
              </li>
              <li class="flex items-center">
                <i class="fas fa-check text-green-500 mr-3"></i>Rilevamento Automatico Cadute
              </li>
              <li class="flex items-center"><i class="fas fa-check text-green-500 mr-3"></i>GPS e Geolocalizzazione</li>
              <li class="flex items-center">
                <i class="fas fa-check text-green-500 mr-3"></i>Monitoraggio Parametri Vitali
              </li>
              <li class="flex items-center">
                <i class="fas fa-check text-green-500 mr-3"></i>Comunicazione Bidirezionale
              </li>
              <li class="flex items-center"><i class="fas fa-check text-green-500 mr-3"></i>Pulsante SOS</li>
              <li class="flex items-center"><i class="fas fa-check text-green-500 mr-3"></i>Promemoria Farmaci</li>
              <li class="flex items-center"><i class="fas fa-check text-green-500 mr-3"></i>Supporto Familiare</li>
            </ul>
          </div>

          <!-- Servizio Avanzato -->
          <div class="price-card price-popular card-hover relative">
            <div class="badge-popular">PI√ô SCELTO</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">TeleAssistenza Avanzata</h3>
            <p class="text-gray-600 mb-6">
              Tutto il pacchetto Base pi√π il supporto della Centrale Operativa H24 per 7 giorni su 7.
            </p>

            <ul class="space-y-3 mb-6">
              <li class="flex items-center">
                <i class="fas fa-check text-green-500 mr-3"></i>Tutti i servizi del Piano Base
              </li>
              <li class="flex items-center"><i class="fas fa-star text-amber-500 mr-3"></i>Centrale Operativa H24</li>
              <li class="flex items-center">
                <i class="fas fa-star text-amber-500 mr-3"></i>Supporto Professionale Continuo
              </li>
              <li class="flex items-center"><i class="fas fa-star text-amber-500 mr-3"></i>Intervento Immediato H24</li>
              <li class="flex items-center">
                <i class="fas fa-star text-amber-500 mr-3"></i>Monitoraggio Parametri Vitali Avanzato
              </li>
              <li class="flex items-center">
                <i class="fas fa-star text-amber-500 mr-3"></i>Assistenza Specializzata
              </li>
              <li class="flex items-center"><i class="fas fa-star text-amber-500 mr-3"></i>Coordinamento Emergenze</li>
              <li class="flex items-center">
                <i class="fas fa-star text-amber-500 mr-3"></i>Report Periodici
              </li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Tecnologia SiDLY -->
    <section id="tecnologia" class="py-16 bg-gray-50">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-bold text-gray-800 mb-4">Tecnologia SiDLY</h2>
          <p class="text-xl text-gray-600">
            Dispositivo medico certificato Classe IIa con funzionalit√† avanzate per la tua sicurezza
          </p>
        </div>

        <div class="grid md:grid-cols-3 lg:grid-cols-6 gap-8 max-w-6xl mx-auto">
          <div class="text-center">
            <div class="tech-icon icon-fall">
              <i class="fas fa-person-falling"></i>
            </div>
            <h4 class="font-semibold text-gray-800 mb-2">Rilevamento Automatico Cadute</h4>
            <p class="text-sm text-gray-600">
              Notifica automatica ai familiari e alla Centrale Operativa in caso di caduta o perdita di coscienza
            </p>
          </div>

          <div class="text-center">
            <div class="tech-icon icon-voice">
              <i class="fas fa-phone-volume"></i>
            </div>
            <h4 class="font-semibold text-gray-800 mb-2">Comunicazione Bidirezionale</h4>
            <p class="text-sm text-gray-600">
              Comunicazione vocale diretta con familiari e operatori attraverso la piattaforma
            </p>
          </div>

          <div class="text-center">
            <div class="tech-icon icon-gps">
              <i class="fas fa-map-marker-alt"></i>
            </div>
            <h4 class="font-semibold text-gray-800 mb-2">Geolocalizzazione GPS</h4>
            <p class="text-sm text-gray-600">Localizzazione precisa e configurazione di aree sicure (geo-fencing)</p>
          </div>

          <div class="text-center">
            <div class="tech-icon icon-heart">
              <i class="fas fa-heartbeat"></i>
            </div>
            <h4 class="font-semibold text-gray-800 mb-2">Monitoraggio Parametri Vitali</h4>
            <p class="text-sm text-gray-600">Frequenza cardiaca e saturazione ossigeno con soglie personalizzabili</p>
          </div>

          <div class="text-center">
            <div class="tech-icon icon-sos">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h4 class="font-semibold text-gray-800 mb-2">Pulsante SOS</h4>
            <p class="text-sm text-gray-600">Invio immediato di emergenza geolocalizzata ai contatti configurati</p>
          </div>

          <div class="text-center">
            <div class="tech-icon icon-pill">
              <i class="fas fa-pills"></i>
            </div>
            <h4 class="font-semibold text-gray-800 mb-2">Promemoria Farmaci</h4>
            <p class="text-sm text-gray-600">
              Messaggi vocali per l'aderenza terapeutica e assunzione corretta dei medicinali
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Prezzi -->
    <section id="prezzi" class="py-16">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-bold text-gray-800 mb-4">Prezzi</h2>
          <p class="text-xl text-gray-600">Scegli la soluzione pi√π adatta alle tue esigenze</p>
        </div>

        <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
          <!-- Piano Base -->
          <div class="price-card card-hover text-center">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Servizio Base</h3>
            <div class="mb-6">
              <div class="text-3xl font-bold text-blue-600">480 ‚Ç¨ + IVA</div>
              <div class="text-gray-600">Primo Anno</div>
              <div class="text-2xl font-bold text-green-600 mt-2">240 ‚Ç¨ + IVA</div>
              <div class="text-gray-600">Rinnovo</div>
            </div>
            <button onclick="document.getElementById('form-richiesta').scrollIntoView({behavior: 'smooth'})" class="btn-primary w-full">
              Richiedi Informazioni
            </button>
          </div>

          <!-- Piano Avanzato -->
          <div class="price-card price-popular card-hover text-center relative">
            <div class="badge-popular">PI√ô SCELTO</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Servizio Avanzato</h3>
            <div class="mb-6">
              <div class="text-3xl font-bold text-blue-600">840 ‚Ç¨ + IVA</div>
              <div class="text-gray-600">Primo Anno</div>
              <div class="text-2xl font-bold text-green-600 mt-2">600 ‚Ç¨ + IVA</div>
              <div class="text-gray-600">Rinnovo</div>
            </div>
            <button onclick="document.getElementById('form-richiesta').scrollIntoView({behavior: 'smooth'})" class="btn-primary w-full">
              Richiedi Informazioni
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Benefici Fiscali -->
    <section class="benefits-section py-16">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-bold text-gray-800 mb-4">Benefici Fiscali e Rimborsi</h2>
          <p class="text-xl text-gray-600">Approfitta delle agevolazioni disponibili</p>
        </div>

        <div class="grid md:grid-cols-2 gap-8 max-w-6xl mx-auto">
          <!-- Detrazione 730 -->
          <div class="bg-white rounded-xl p-6 shadow-lg card-hover">
            <div class="flex items-center mb-4">
              <i class="fas fa-file-invoice text-3xl text-green-600 mr-4"></i>
              <h3 class="text-xl font-bold text-gray-800">Detrazione Fiscale 730</h3>
            </div>
            <p class="text-gray-700 mb-4">
              I servizi di TeleAssistenza sono detraibili come <strong>spese sanitarie</strong> nella dichiarazione dei
              redditi modello 730.
            </p>
            <ul class="space-y-2 text-gray-600">
              <li class="flex items-start">
                <i class="fas fa-check text-green-500 mr-2 mt-1"></i>Detrazione del 19% sulla spesa sostenuta
              </li>
              <li class="flex items-start">
                <i class="fas fa-check text-green-500 mr-2 mt-1"></i>Valido per spese sanitarie certificate
              </li>
              <li class="flex items-start">
                <i class="fas fa-check text-green-500 mr-2 mt-1"></i>Risparmio fiscale fino a 159,60 ‚Ç¨ annui (piano
                Avanzato)
              </li>
            </ul>
          </div>

          <!-- Rimborsi INPS -->
          <div class="bg-white rounded-xl p-6 shadow-lg card-hover">
            <div class="flex items-center mb-4">
              <i class="fas fa-landmark text-3xl text-blue-600 mr-4"></i>
              <h3 class="text-xl font-bold text-gray-800">Rimborsi INPS</h3>
            </div>
            <p class="text-gray-700 mb-4">
              Possibilit√† di rimborso per categorie specifiche con requisiti particolari.
            </p>
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
              <p class="text-blue-800 font-semibold">Requisiti necessari (cumulativi):</p>
            </div>
            <ul class="space-y-2 text-gray-600">
              <li class="flex items-start">
                <i class="fas fa-euro-sign text-blue-500 mr-2 mt-1"></i>ISEE inferiore a ‚Ç¨ 6.000
              </li>
              <li class="flex items-start">
                <i class="fas fa-certificate text-blue-500 mr-2 mt-1"></i>Gi√† titolari della Legge 104
              </li>
              <li class="flex items-start">
                <i class="fas fa-file-medical text-blue-500 mr-2 mt-1"></i>Motivazioni sanitarie giustificate
              </li>
              <li class="flex items-start">
                <i class="fas fa-info-circle text-blue-500 mr-2 mt-1"></i>Valutazione caso per caso da parte INPS
              </li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Form Richiesta -->
    <section id="form-richiesta" class="form-section py-16">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-bold text-gray-800 mb-4">Richiedi Informazioni</h2>
          <p class="text-xl text-gray-600">Compila il form per ricevere una consulenza gratuita personalizzata</p>
        </div>

        <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8">
          <form id="leadForm" class="space-y-6">
            <!-- Dati Richiedente -->
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <label class="block text-gray-700 font-semibold mb-2">Nome *</label>
                <input type="text" name="nomeRichiedente" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-gray-700 font-semibold mb-2">Cognome *</label>
                <input type="text" name="cognomeRichiedente" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <label class="block text-gray-700 font-semibold mb-2">Email *</label>
                <input type="email" name="emailRichiedente" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-gray-700 font-semibold mb-2">Telefono *</label>
                <input type="tel" name="telefonoRichiedente" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>

            <!-- Dati Persona da Assistere -->
            <div class="border-t pt-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">Dati Persona da Assistere</h3>

              <div class="grid md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-gray-700 font-semibold mb-2">Nome Assistito *</label>
                  <input type="text" name="nomeAssistito" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                  <label class="block text-gray-700 font-semibold mb-2">Cognome Assistito *</label>
                  <input type="text" name="cognomeAssistito" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
              </div>

              <div class="grid md:grid-cols-2 gap-6 mt-6">
                <div>
                  <label class="block text-gray-700 font-semibold mb-2">Data di Nascita Assistito *</label>
                  <!-- Campi Data User-Friendly con Auto-Navigate -->
                  <div class="flex space-x-2">
                    <div class="flex-1">
                      <input 
                        type="number" 
                        name="giornoNascita" 
                        id="giorno_nascita" 
                        placeholder="GG" 
                        min="1" 
                        max="31" 
                        maxlength="2"
                        required 
                        class="w-full px-3 py-3 text-center border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        oninput="autoNavigateDate(this, 'mese_nascita', 2)"
                        onchange="validaEAggiornaSiData()"
                      >
                      <label class="text-xs text-gray-500 block text-center mt-1">Giorno</label>
                    </div>
                    <div class="flex-1">
                      <input 
                        type="number" 
                        name="meseNascita" 
                        id="mese_nascita" 
                        placeholder="MM" 
                        min="1" 
                        max="12" 
                        maxlength="2"
                        required 
                        class="w-full px-3 py-3 text-center border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        oninput="autoNavigateDate(this, 'anno_nascita', 2)"
                        onchange="validaEAggiornaSiData()"
                      >
                      <label class="text-xs text-gray-500 block text-center mt-1">Mese</label>
                    </div>
                    <div class="flex-1">
                      <input 
                        type="number" 
                        name="annoNascita" 
                        id="anno_nascita" 
                        placeholder="AAAA" 
                        min="1920" 
                        max="2024" 
                        maxlength="4"
                        required 
                        class="w-full px-3 py-3 text-center border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        oninput="autoNavigateDate(this, null, 4)"
                        onchange="validaEAggiornaSiData()"
                      >
                      <label class="text-xs text-gray-500 block text-center mt-1">Anno</label>
                    </div>
                  </div>
                  <!-- Campo hidden per compatibilit√† con l'API esistente -->
                  <input type="hidden" name="dataNascitaAssistito" id="data_nascita_assistito">
                </div>
                <div>
                  <label class="block text-gray-700 font-semibold mb-2">Luogo di Nascita Assistito *</label>
                  <input type="text" name="luogoNascitaAssistito" required placeholder="Es. Roma, Milano, Napoli..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
              </div>

              <div class="grid md:grid-cols-2 gap-6 mt-6">
                <div>
                  <label class="block text-gray-700 font-semibold mb-2">Et√† (calcolata automaticamente)</label>
                  <input type="text" name="etaAssistito" id="eta_assistito" readonly class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100">
                </div>
                <div>
                  <label class="block text-gray-700 font-semibold mb-2">Relazione con l'assistito</label>
                  <select name="parentelaAssistito" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Seleziona relazione</option>
                    <option value="figlio">Figlio/a</option>
                    <option value="coniuge">Coniuge</option>
                    <option value="genitore">Genitore</option>
                    <option value="fratello">Fratello/Sorella</option>
                    <option value="parente">Altro parente</option>
                    <option value="badante">Badante/Caregiver</option>
                    <option value="assistito">Sono l'assistito stesso</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Servizio -->
            <div>
              <label class="block text-gray-700 font-semibold mb-2">Servizio di Interesse</label>
              <select name="pacchetto" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleziona servizio</option>
                <option value="Base">TeleAssistenza Base (480‚Ç¨+IVA primo anno)</option>
                <option value="Avanzato">TeleAssistenza Avanzata (840‚Ç¨+IVA primo anno)</option>
                <option value="Da definire">Non sono sicuro, vorrei informazioni</option>
              </select>
            </div>

            <!-- Condizioni Mediche -->
            <div>
              <label class="block text-gray-700 font-semibold mb-2">Condizioni mediche particolari o esigenze specifiche</label>
              <textarea name="condizioniSalute" rows="3" placeholder="Descrivi eventuali patologie, disabilit√† o esigenze particolari..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>

            <!-- Urgenza -->
            <div>
              <label class="block text-gray-700 font-semibold mb-2">Urgenza della richiesta</label>
              <select name="priority" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleziona urgenza</option>
                <option value="Urgente">Immediata (entro 24 ore)</option>
                <option value="Alta">Alta (entro 3 giorni)</option>
                <option value="Media">Media (entro una settimana)</option>
                <option value="Normale">Bassa (quando possibile)</option>
              </select>
            </div>

            <!-- Preferenza Contatto -->
            <div>
              <label class="block text-gray-700 font-semibold mb-2">Come preferisci essere ricontattato?</label>
              <div class="grid md:grid-cols-3 gap-4">
                <label class="flex items-center">
                  <input type="radio" name="preferenzaContatto" value="Email" class="mr-2">
                  <i class="fas fa-envelope text-blue-600 mr-2"></i>Email
                </label>
                <label class="flex items-center">
                  <input type="radio" name="preferenzaContatto" value="Telefono" class="mr-2">
                  <i class="fas fa-phone text-green-600 mr-2"></i>Telefono
                </label>
                <label class="flex items-center">
                  <input type="radio" name="preferenzaContatto" value="WhatsApp" class="mr-2">
                  <i class="fab fa-whatsapp text-green-600 mr-2"></i>WhatsApp
                </label>
              </div>
            </div>

            <!-- Richieste Aggiuntive -->
            <div class="space-y-4">
              <div>
                <label class="flex items-center">
                  <input type="checkbox" name="vuoleContratto" id="vuole_contratto" onchange="toggleIntestazioneContratto()" class="mr-3">
                  <span class="text-gray-700">Vuoi ricevere copia del contratto da visionare?</span>
                </label>
              </div>

              <!-- Intestazione Contratto (condizionata) -->
              <div id="intestazione_contratto_section" class="hidden">
                <label class="block text-gray-700 font-semibold mb-2">A chi deve essere intestato il contratto?</label>
                <div class="flex space-x-4">
                  <label class="flex items-center">
                    <input type="radio" name="intestazioneContratto" value="richiedente" onchange="toggleCampiDinamici()" class="mr-2">
                    <span class="text-gray-700">Richiedente</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="intestazioneContratto" value="assistito" onchange="toggleCampiDinamici()" class="mr-2">
                    <span class="text-gray-700">Assistito</span>
                  </label>
                </div>

                <!-- Campi Dinamici per Richiedente -->
                <div id="campi_richiedente" style="display: none;" class="space-y-4 mt-4">
                  <div>
                    <label class="block text-gray-700 font-semibold mb-2">Codice Fiscale Richiedente</label>
                    <input type="text" name="cfRichiedente" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Inserisci il Codice Fiscale del Richiedente">
                  </div>
                  <div>
                    <label class="block text-gray-700 font-semibold mb-2">Indirizzo Richiedente</label>
                    <textarea name="indirizzoRichiedente" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Inserisci l'indirizzo completo del Richiedente"></textarea>
                  </div>
                </div>

                <!-- Campi Dinamici per Assistito -->
                <div id="campi_assistito" style="display: none;" class="space-y-4 mt-4">
                  <div>
                    <label class="block text-gray-700 font-semibold mb-2">Codice Fiscale Assistito</label>
                    <input type="text" name="cfAssistito" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Inserisci il Codice Fiscale dell'Assistito">
                  </div>
                  <div>
                    <label class="block text-gray-700 font-semibold mb-2">Indirizzo Assistito</label>
                    <textarea name="indirizzoAssistito" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Inserisci l'indirizzo completo dell'Assistito"></textarea>
                  </div>
                </div>
              </div>

              <div>
                <label class="flex items-center">
                  <input type="checkbox" name="vuoleBrochure" class="mr-3">
                  <span class="text-gray-700">Vuoi che ti inviamo la brochure di SiDLY Care Pro?</span>
                </label>
              </div>

              <div>
                <label class="flex items-center">
                  <input type="checkbox" name="vuoleManuale" class="mr-3">
                  <span class="text-gray-700">Vuoi ricevere il manuale d'uso del dispositivo?</span>
                </label>
              </div>


            </div>

            <!-- Messaggio -->
            <div>
              <label class="block text-gray-700 font-semibold mb-2">Messaggio aggiuntivo</label>
              <textarea name="note" rows="4" placeholder="Aggiungi eventuali domande o informazioni aggiuntive..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>

            <!-- GDPR -->
            <div>
              <label class="flex items-start">
                <input type="checkbox" name="gdprConsent" required class="mr-3 mt-1">
                <span class="text-gray-700 text-sm">Acconsento al trattamento dei dati personali secondo il GDPR per le finalit√† indicate nell'informativa privacy. *</span>
              </label>
            </div>

            <!-- Submit -->
            <div class="text-center">
              <button type="submit" class="btn-primary text-lg px-8 py-4">
                <i class="fas fa-paper-plane mr-2"></i>Invia Richiesta
              </button>
              <p class="text-gray-600 mt-4">Ti ricontatteremo entro 24 ore lavorative</p>
            </div>
          </form>

          <!-- Messaggi di successo/errore -->
          <div id="message_container" class="hidden mt-6">
            <div id="success_message" class="hidden bg-green-100 border border-green-400 text-green-700 px-6 py-4 rounded-lg shadow-md animate-fade-in">
              <div class="flex items-center">
                <i class="fas fa-check-circle text-2xl mr-3"></i>
                <strong class="text-lg">‚úÖ Successo!</strong>
              </div>
              <span class="block mt-1">La tua richiesta √® stata elaborata dal sistema TeleMedCare V12.0. Riceverai conferma via email con i documenti richiesti!</span>
            </div>
            <div id="error_message" class="hidden bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-lg shadow-md animate-fade-in">
              <div class="flex items-center">
                <i class="fas fa-exclamation-circle text-2xl mr-3"></i>
                <strong class="text-lg">‚ùå Errore!</strong>
              </div>
              <span class="block mt-1">Si √® verificato un errore nell'invio. Per favore contattaci direttamente al +39 331 643 2390</span>
            </div>
            <div id="loading_message" class="hidden bg-blue-100 border border-blue-400 text-blue-700 px-6 py-4 rounded-lg shadow-md">
              <div class="flex items-center">
                <i class="fas fa-spinner fa-spin text-2xl mr-3"></i>
                <strong class="text-lg">üîÑ Invio in corso...</strong>
              </div>
              <span class="block mt-1">Stiamo elaborando la tua richiesta con il sistema TeleMedCare V12.0, attendi un momento.</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Contatti -->
    <section id="contatti" class="contact-gradient text-white py-16">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-bold mb-4">Contatti</h2>
          <p class="text-xl">Startup Innovativa a Vocazione Sociale - Fondata nel 2022</p>
        </div>

        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
          <!-- Team -->
          <div class="text-center">
            <i class="fas fa-user-tie text-3xl text-blue-400 mb-4"></i>
            <h3 class="text-xl font-bold mb-3">Roberto Poggi</h3>
            <p class="text-gray-300 mb-2">Responsabile Tecnico</p>
            <p class="text-sm">roberto.poggi@medicagb.it</p>
            <p class="text-sm text-gray-400">331 643 2390</p>
          </div>

          <div class="text-center">
            <i class="fas fa-user-nurse text-3xl text-pink-400 mb-4"></i>
            <h3 class="text-xl font-bold mb-3">Stefania Rocca</h3>
            <p class="text-gray-300 mb-2">Responsabile Commerciale</p>
            <p class="text-sm">stefania.rocca@medicagb.it</p>
            <p class="text-sm text-gray-400">335 730 1206</p>
          </div>

          <!-- Contatti -->
          <div class="text-center">
            <i class="fas fa-envelope text-3xl text-green-400 mb-4"></i>
            <h3 class="text-xl font-bold mb-3">Email</h3>
            <p class="text-sm">info@medicagb.it</p>
            <p class="text-sm">medicagbsrl@pecimprese.it</p>
            <p class="text-sm text-gray-400 mt-3">www.medicagb.it</p>
          </div>

          <!-- Sedi -->
          <div class="text-center">
            <i class="fas fa-map-marker-alt text-3xl text-amber-400 mb-4"></i>
            <h3 class="text-xl font-bold mb-3">Sedi</h3>
            <div class="space-y-4 text-gray-300 text-sm">
              <div>
                <p class="font-semibold">Milano</p>
                <p>Corso Garibaldi 34</p>
                <p>20121 Milano</p>
              </div>
              <div>
                <p class="font-semibold">Genova</p>
                <p>Via delle Eriche 53</p>
                <p>16139 Genova</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Access Staff -->
    <div class="py-8 bg-blue-600 text-white text-center">
      <a href="/home" class="text-white hover:text-blue-200 inline-block px-6 py-3 bg-blue-700 rounded-lg hover:bg-blue-800 transition-all">
        <i class="fas fa-cog mr-2"></i>Area Staff - Accesso Sistema TeleMedCare V12.0
      </a>
    </div>
    
    <script>
        // Funzioni JavaScript per il form
        function autoNavigateDate(input, nextFieldId, maxLength) {
            if (input.value.length >= maxLength && nextFieldId) {
                const nextField = document.getElementById(nextFieldId);
                if (nextField) {
                    nextField.focus();
                }
            }
        }

        function validaEAggiornaSiData() {
            const giorno = document.getElementById('giorno_nascita').value;
            const mese = document.getElementById('mese_nascita').value;
            const anno = document.getElementById('anno_nascita').value;
            
            if (giorno && mese && anno) {
                // Formato ISO per backend
                const dataISO = \`\${anno}-\${mese.padStart(2, '0')}-\${giorno.padStart(2, '0')}\`;
                document.getElementById('data_nascita_assistito').value = dataISO;
                
                // Calcola et√†
                const oggi = new Date();
                const dataNascita = new Date(anno, mese - 1, giorno);
                let eta = oggi.getFullYear() - dataNascita.getFullYear();
                const differenzaMese = oggi.getMonth() - dataNascita.getMonth();
                
                if (differenzaMese < 0 || (differenzaMese === 0 && oggi.getDate() < dataNascita.getDate())) {
                    eta--;
                }
                
                document.getElementById('eta_assistito').value = eta + ' anni';
            }
        }

        function toggleIntestazioneContratto() {
            const checkbox = document.getElementById('vuole_contratto');
            const section = document.getElementById('intestazione_contratto_section');
            
            if (checkbox.checked) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
                // Reset campi dinamici
                document.getElementById('campi_richiedente').style.display = 'none';
                document.getElementById('campi_assistito').style.display = 'none';
            }
        }

        function toggleCampiDinamici() {
            const richiedenteRadio = document.querySelector('input[name="intestazioneContratto"][value="richiedente"]');
            const assistitoRadio = document.querySelector('input[name="intestazioneContratto"][value="assistito"]');
            const campiRichiedente = document.getElementById('campi_richiedente');
            const campiAssistito = document.getElementById('campi_assistito');
            
            if (richiedenteRadio.checked) {
                campiRichiedente.style.display = 'block';
                campiAssistito.style.display = 'none';
            } else if (assistitoRadio.checked) {
                campiRichiedente.style.display = 'none';
                campiAssistito.style.display = 'block';
            }
        }

        // Form submission
        document.getElementById('leadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Mostra loading
            document.getElementById('message_container').classList.remove('hidden');
            document.getElementById('loading_message').classList.remove('hidden');
            document.getElementById('success_message').classList.add('hidden');
            document.getElementById('error_message').classList.add('hidden');
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Gestione checkboxes
            data.vuoleContratto = formData.get('vuoleContratto') ? true : false;
            data.vuoleBrochure = formData.get('vuoleBrochure') ? true : false;
            data.vuoleManuale = formData.get('vuoleManuale') ? true : false;
            data.gdprConsent = formData.get('gdprConsent') ? true : false;
            
            try {
                const response = await fetch('/api/lead', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                // Nascondi loading
                document.getElementById('loading_message').classList.add('hidden');
                
                if (result.success) {
                    document.getElementById('success_message').classList.remove('hidden');
                    document.getElementById('leadForm').reset();
                } else {
                    document.getElementById('error_message').classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Errore invio form:', error);
                document.getElementById('loading_message').classList.add('hidden');
                document.getElementById('error_message').classList.remove('hidden');
            }
        });
    <\/script>

</body>
</html>
  `));I.get("/template-system",async o=>o.html(`<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Template Contratti - TeleMedCare V12.0</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-gradient-to-r from-pink-600 to-rose-700 text-white p-6">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold">
                    <i class="fas fa-layer-group mr-3"></i>
                    Gestione Template Contratti
                </h1>
                <p class="text-xl opacity-90 mt-2">Sistema completo per template contratti, proforma e documenti</p>
            </div>
            <a href="/home" class="bg-white text-pink-600 px-6 py-3 rounded-lg font-semibold hover:bg-pink-50 transition-colors">
                <i class="fas fa-home mr-2"></i>Dashboard
            </a>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-6">
        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="flex items-center">
                    <div class="text-3xl text-blue-500 mr-4">
                        <i class="fas fa-file-contract"></i>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm">Template Contratti</p>
                        <p class="text-2xl font-bold" id="contractTemplates">--</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="flex items-center">
                    <div class="text-3xl text-green-500 mr-4">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm">Template Proforma</p>
                        <p class="text-2xl font-bold" id="proformaTemplates">--</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="flex items-center">
                    <div class="text-3xl text-purple-500 mr-4">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm">Template Email</p>
                        <p class="text-2xl font-bold" id="emailTemplates">--</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="flex items-center">
                    <div class="text-3xl text-orange-500 mr-4">
                        <i class="fas fa-star"></i>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm">Template Attivi</p>
                        <p class="text-2xl font-bold" id="activeTemplates">--</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="bg-white rounded-xl p-6 shadow-lg mb-6">
            <div class="flex flex-wrap gap-4 items-center justify-between">
                <div class="flex flex-wrap gap-4">
                    <button onclick="showCreateTemplate()" class="bg-pink-600 text-white px-6 py-2 rounded-lg hover:bg-pink-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Nuovo Template
                    </button>
                    <button onclick="importTemplate()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-upload mr-2"></i>Importa
                    </button>
                    <button onclick="exportTemplates()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-download mr-2"></i>Esporta Tutti
                    </button>
                </div>
                <div class="flex gap-2">
                    <select id="templateTypeFilter" onchange="filterTemplates()" class="border rounded-lg px-3 py-2">
                        <option value="">Tutti i tipi</option>
                        <option value="CONTRACT">Contratti</option>
                        <option value="PROFORMA">Proforma</option>
                        <option value="EMAIL">Email</option>
                        <option value="BROCHURE">Brochure</option>
                    </select>
                    <select id="templateCategoryFilter" onchange="filterTemplates()" class="border rounded-lg px-3 py-2">
                        <option value="">Tutte le categorie</option>
                        <option value="BASE">Base</option>
                        <option value="AVANZATO">Avanzato</option>
                        <option value="PREMIUM">Premium</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Templates Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
            <!-- Template Cards will be loaded here -->
            <div id="templatesGrid" class="col-span-full">
                <div class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">Caricamento template...</p>
                </div>
            </div>
        </div>

        <!-- Template Details Modal -->
        <div id="templateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b p-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold" id="modalTitle">Dettagli Template</h2>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div id="modalContent" class="p-6">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Create/Edit Template Form -->
        <div id="createTemplateForm" class="hidden bg-white rounded-xl p-6 shadow-lg mb-6">
            <h3 class="text-xl font-bold mb-4">
                <i class="fas fa-plus mr-2 text-pink-600"></i>
                <span id="formTitle">Nuovo Template</span>
            </h3>
            <form id="templateForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome Template</label>
                        <input type="text" id="templateName" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Documento</label>
                        <select id="templateType" class="w-full border rounded-lg px-3 py-2" required>
                            <option value="">Seleziona tipo</option>
                            <option value="CONTRACT">Contratto</option>
                            <option value="PROFORMA">Proforma</option>
                            <option value="EMAIL">Email</option>
                            <option value="BROCHURE">Brochure</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                        <select id="templateCategory" class="w-full border rounded-lg px-3 py-2" required>
                            <option value="">Seleziona categoria</option>
                            <option value="BASE">Base</option>
                            <option value="AVANZATO">Avanzato</option>
                            <option value="PREMIUM">Premium</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Versione</label>
                        <input type="text" id="templateVersion" class="w-full border rounded-lg px-3 py-2" placeholder="es. 1.0" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label>
                    <textarea id="templateDescription" class="w-full border rounded-lg px-3 py-2" rows="3"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Template HTML</label>
                    <textarea id="templateHTML" class="w-full border rounded-lg px-3 py-2 font-mono text-sm" rows="10" placeholder="<html>...</html>"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">CSS Personalizzato (opzionale)</label>
                    <textarea id="templateCSS" class="w-full border rounded-lg px-3 py-2 font-mono text-sm" rows="5" placeholder=".classe { ... }"></textarea>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="bg-pink-600 text-white px-6 py-2 rounded-lg hover:bg-pink-700">
                        <i class="fas fa-save mr-2"></i>Salva Template
                    </button>
                    <button type="button" onclick="cancelCreate()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
                        <i class="fas fa-times mr-2"></i>Annulla
                    </button>
                    <button type="button" onclick="previewTemplate()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-eye mr-2"></i>Anteprima
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Stato applicazione
        let currentTemplates = [];
        let editingTemplate = null;

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            loadTemplateStats();
            loadTemplates();
        });

        // Carica statistiche template
        async function loadTemplateStats() {
            try {
                const response = await fetch('/api/templates/stats');
                const stats = await response.json();
                
                if (stats.success) {
                    document.getElementById('contractTemplates').textContent = stats.data.contracts;
                    document.getElementById('proformaTemplates').textContent = stats.data.proforma;
                    document.getElementById('emailTemplates').textContent = stats.data.emails;
                    document.getElementById('activeTemplates').textContent = stats.data.active;
                } else {
                    // Mock stats for development
                    document.getElementById('contractTemplates').textContent = '3';
                    document.getElementById('proformaTemplates').textContent = '2';
                    document.getElementById('emailTemplates').textContent = '7';
                    document.getElementById('activeTemplates').textContent = '12';
                }
            } catch (error) {
                console.error('Errore caricamento stats:', error);
                // Mock stats for development
                document.getElementById('contractTemplates').textContent = '3';
                document.getElementById('proformaTemplates').textContent = '2';
                document.getElementById('emailTemplates').textContent = '7';
                document.getElementById('activeTemplates').textContent = '12';
            }
        }

        // Carica lista template
        async function loadTemplates() {
            try {
                const response = await fetch('/api/templates');
                const data = await response.json();
                
                if (data.success) {
                    currentTemplates = data.templates || [];
                } else {
                    // Mock data for development
                    currentTemplates = generateMockTemplates();
                }
                
                renderTemplates(currentTemplates);
            } catch (error) {
                console.error('Errore caricamento templates:', error);
                currentTemplates = generateMockTemplates();
                renderTemplates(currentTemplates);
            }
        }

        // Genera template mock per sviluppo
        function generateMockTemplates() {
            return [
                {
                    id: 1,
                    nome_template: 'Contratto Base TeleAssistenza',
                    tipo_documento: 'CONTRACT',
                    categoria: 'BASE',
                    versione: '1.2',
                    attivo: true,
                    template_predefinito: true,
                    utilizzi_totali: 45,
                    ultimo_utilizzo: '2024-03-10T10:30:00Z',
                    descrizione: 'Template standard per contratti base'
                },
                {
                    id: 2,
                    nome_template: 'Contratto Premium TeleMedCare',
                    tipo_documento: 'CONTRACT',
                    categoria: 'PREMIUM',
                    versione: '2.1',
                    attivo: true,
                    template_predefinito: false,
                    utilizzi_totali: 23,
                    ultimo_utilizzo: '2024-03-09T15:45:00Z',
                    descrizione: 'Template avanzato per contratti premium con servizi completi'
                },
                {
                    id: 3,
                    nome_template: 'Proforma Standard',
                    tipo_documento: 'PROFORMA',
                    categoria: 'BASE',
                    versione: '1.0',
                    attivo: true,
                    template_predefinito: true,
                    utilizzi_totali: 78,
                    ultimo_utilizzo: '2024-03-11T09:15:00Z',
                    descrizione: 'Proforma standard per tutti i servizi'
                },
                {
                    id: 4,
                    nome_template: 'Email Benvenuto Lead',
                    tipo_documento: 'EMAIL',
                    categoria: 'BASE',
                    versione: '1.1',
                    attivo: true,
                    template_predefinito: true,
                    utilizzi_totali: 156,
                    ultimo_utilizzo: '2024-03-12T14:20:00Z',
                    descrizione: 'Email automatica di benvenuto per nuovi lead'
                },
                {
                    id: 5,
                    nome_template: 'Brochure Dispositivi',
                    tipo_documento: 'BROCHURE',
                    categoria: 'AVANZATO',
                    versione: '3.0',
                    attivo: false,
                    template_predefinito: false,
                    utilizzi_totali: 12,
                    ultimo_utilizzo: '2024-02-28T11:30:00Z',
                    descrizione: 'Brochure illustrativa dispositivi SiDLY'
                }
            ];
        }

        // Renderizza template
        function renderTemplates(templates) {
            const grid = document.getElementById('templatesGrid');
            
            if (!templates || templates.length === 0) {
                grid.innerHTML = \`
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-folder-open text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl text-gray-600 mb-2">Nessun template trovato</h3>
                        <p class="text-gray-500">Crea il tuo primo template per iniziare</p>
                        <button onclick="showCreateTemplate()" class="mt-4 bg-pink-600 text-white px-6 py-2 rounded-lg hover:bg-pink-700">
                            <i class="fas fa-plus mr-2"></i>Crea Template
                        </button>
                    </div>
                \`;
                return;
            }

            grid.innerHTML = templates.map(template => \`
                <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center">
                            <div class="text-2xl mr-3 \${getTemplateIcon(template.tipo_documento)}">
                                <i class="\${getTemplateIconClass(template.tipo_documento)}"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800">\${template.nome_template}</h3>
                                <p class="text-sm text-gray-600">v\${template.versione}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <span class="px-2 py-1 text-xs rounded \${getCategoryColor(template.categoria)}">
                                \${template.categoria}
                            </span>
                            <span class="px-2 py-1 text-xs rounded \${template.attivo ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                \${template.attivo ? 'Attivo' : 'Inattivo'}
                            </span>
                        </div>
                    </div>
                    
                    <p class="text-gray-600 text-sm mb-4 line-clamp-2">\${template.descrizione || 'Nessuna descrizione'}</p>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm text-gray-500 mb-4">
                        <div>
                            <i class="fas fa-chart-line mr-1"></i>
                            <span>\${template.utilizzi_totali} utilizzi</span>
                        </div>
                        <div>
                            <i class="fas fa-clock mr-1"></i>
                            <span>\${formatDate(template.ultimo_utilizzo)}</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="viewTemplate(\${template.id})" class="flex-1 bg-blue-600 text-white py-2 px-3 rounded text-sm hover:bg-blue-700">
                            <i class="fas fa-eye mr-1"></i>Visualizza
                        </button>
                        <button onclick="editTemplate(\${template.id})" class="bg-yellow-500 text-white py-2 px-3 rounded text-sm hover:bg-yellow-600">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="duplicateTemplate(\${template.id})" class="bg-green-500 text-white py-2 px-3 rounded text-sm hover:bg-green-600">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button onclick="deleteTemplate(\${template.id})" class="bg-red-500 text-white py-2 px-3 rounded text-sm hover:bg-red-600">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            \`).join('');
        }

        // Utility functions
        function getTemplateIcon(type) {
            const colors = {
                'CONTRACT': 'text-blue-500',
                'PROFORMA': 'text-green-500',
                'EMAIL': 'text-purple-500',
                'BROCHURE': 'text-orange-500'
            };
            return colors[type] || 'text-gray-500';
        }

        function getTemplateIconClass(type) {
            const icons = {
                'CONTRACT': 'fas fa-file-contract',
                'PROFORMA': 'fas fa-file-invoice-dollar',
                'EMAIL': 'fas fa-envelope',
                'BROCHURE': 'fas fa-brochure'
            };
            return icons[type] || 'fas fa-file-alt';
        }

        function getCategoryColor(category) {
            const colors = {
                'BASE': 'bg-blue-100 text-blue-800',
                'AVANZATO': 'bg-yellow-100 text-yellow-800',
                'PREMIUM': 'bg-purple-100 text-purple-800'
            };
            return colors[category] || 'bg-gray-100 text-gray-800';
        }

        function formatDate(dateString) {
            if (!dateString) return 'Mai';
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Template actions
        function showCreateTemplate() {
            editingTemplate = null;
            document.getElementById('formTitle').textContent = 'Nuovo Template';
            document.getElementById('templateForm').reset();
            document.getElementById('createTemplateForm').classList.remove('hidden');
            document.getElementById('createTemplateForm').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelCreate() {
            document.getElementById('createTemplateForm').classList.add('hidden');
            document.getElementById('templateForm').reset();
            editingTemplate = null;
        }

        function viewTemplate(templateId) {
            const template = currentTemplates.find(t => t.id === templateId);
            if (!template) return;

            document.getElementById('modalTitle').textContent = template.nome_template;
            document.getElementById('modalContent').innerHTML = \`
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tipo Documento</label>
                                <p class="mt-1 text-sm text-gray-900">\${template.tipo_documento}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Categoria</label>
                                <p class="mt-1 text-sm text-gray-900">\${template.categoria}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Versione</label>
                                <p class="mt-1 text-sm text-gray-900">\${template.versione}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Utilizzi</label>
                                <p class="mt-1 text-sm text-gray-900">\${template.utilizzi_totali}</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Stato</label>
                                <p class="mt-1 text-sm text-gray-900">\${template.attivo ? 'Attivo' : 'Inattivo'}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Predefinito</label>
                                <p class="mt-1 text-sm text-gray-900">\${template.template_predefinito ? 'S√¨' : 'No'}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Ultimo Utilizzo</label>
                                <p class="mt-1 text-sm text-gray-900">\${formatDate(template.ultimo_utilizzo)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descrizione</label>
                        <p class="text-sm text-gray-900 bg-gray-50 p-4 rounded-lg">\${template.descrizione || 'Nessuna descrizione disponibile'}</p>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="editTemplate(\${template.id}); closeModal();" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                            <i class="fas fa-edit mr-2"></i>Modifica
                        </button>
                        <button onclick="duplicateTemplate(\${template.id}); closeModal();" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            <i class="fas fa-copy mr-2"></i>Duplica
                        </button>
                        <button onclick="previewTemplateById(\${template.id})" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            <i class="fas fa-eye mr-2"></i>Anteprima
                        </button>
                    </div>
                </div>
            \`;
            document.getElementById('templateModal').classList.remove('hidden');
        }

        function editTemplate(templateId) {
            const template = currentTemplates.find(t => t.id === templateId);
            if (!template) return;

            editingTemplate = template;
            document.getElementById('formTitle').textContent = 'Modifica Template';
            document.getElementById('templateName').value = template.nome_template;
            document.getElementById('templateType').value = template.tipo_documento;
            document.getElementById('templateCategory').value = template.categoria;
            document.getElementById('templateVersion').value = template.versione;
            document.getElementById('templateDescription').value = template.descrizione || '';
            
            document.getElementById('createTemplateForm').classList.remove('hidden');
            document.getElementById('createTemplateForm').scrollIntoView({ behavior: 'smooth' });
        }

        function duplicateTemplate(templateId) {
            const template = currentTemplates.find(t => t.id === templateId);
            if (!template) return;

            editingTemplate = null;
            document.getElementById('formTitle').textContent = 'Duplica Template';
            document.getElementById('templateName').value = template.nome_template + ' (Copia)';
            document.getElementById('templateType').value = template.tipo_documento;
            document.getElementById('templateCategory').value = template.categoria;
            document.getElementById('templateVersion').value = '1.0';
            document.getElementById('templateDescription').value = template.descrizione || '';
            
            document.getElementById('createTemplateForm').classList.remove('hidden');
            document.getElementById('createTemplateForm').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteTemplate(templateId) {
            if (confirm('Sei sicuro di voler eliminare questo template?')) {
                // Implementation for delete
                console.log('Deleting template:', templateId);
                alert('Template eliminato (funzione demo)');
                loadTemplates(); // Reload
            }
        }

        function closeModal() {
            document.getElementById('templateModal').classList.add('hidden');
        }

        function filterTemplates() {
            const typeFilter = document.getElementById('templateTypeFilter').value;
            const categoryFilter = document.getElementById('templateCategoryFilter').value;

            let filtered = currentTemplates;
            
            if (typeFilter) {
                filtered = filtered.filter(t => t.tipo_documento === typeFilter);
            }
            
            if (categoryFilter) {
                filtered = filtered.filter(t => t.categoria === categoryFilter);
            }

            renderTemplates(filtered);
        }

        function previewTemplate() {
            const html = document.getElementById('templateHTML').value;
            const css = document.getElementById('templateCSS').value;
            
            if (!html) {
                alert('Inserisci il codice HTML del template');
                return;
            }

            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(\`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Anteprima Template</title>
                    <style>\${css}</style>
                </head>
                <body>
                    \${html}
                </body>
                </html>
            \`);
            previewWindow.document.close();
        }

        // Form submission
        document.getElementById('templateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                nome_template: document.getElementById('templateName').value,
                tipo_documento: document.getElementById('templateType').value,
                categoria: document.getElementById('templateCategory').value,
                versione: document.getElementById('templateVersion').value,
                descrizione: document.getElementById('templateDescription').value,
                html_template: document.getElementById('templateHTML').value,
                css_styles: document.getElementById('templateCSS').value
            };

            if (editingTemplate) {
                // Update existing template
                console.log('Updating template:', editingTemplate.id, formData);
                alert('Template aggiornato (funzione demo)');
            } else {
                // Create new template
                console.log('Creating template:', formData);
                alert('Template creato (funzione demo)');
            }

            cancelCreate();
            loadTemplates(); // Reload
        });

        // Import/Export functions
        function importTemplate() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const template = JSON.parse(event.target.result);
                            console.log('Importing template:', template);
                            alert('Template importato (funzione demo)');
                            loadTemplates();
                        } catch (error) {
                            alert('Errore nel file di importazione');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function exportTemplates() {
            const dataStr = JSON.stringify(currentTemplates, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'templates_' + new Date().toISOString().slice(0, 10) + '.json';
            link.click();
        }
    <\/script>
</body>
</html>`));I.get("/home",o=>(o.header("Cache-Control","no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0"),o.header("Pragma","no-cache"),o.header("Expires","0"),o.header("X-Cache-Bypass","true"),o.header("X-TeleMedCare-Version","12.0-"+Date.now()),o.html(a0)));I.get("/completa-dati-minimal.html",async o=>{o.header("Cache-Control","no-store, no-cache, must-revalidate"),o.header("Content-Type","text/html; charset=utf-8");try{const{completaDatiHtml:t}=await Promise.resolve().then(()=>Lw);return o.html(t)}catch(t){return console.error("‚ùå Errore caricamento form completamento:",t),o.html(`
      <!DOCTYPE html>
      <html lang="it">
      <head>
        <meta charset="UTF-8">
        <title>Errore - eCura</title>
        <style>
          body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f4f6f8;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
          }
          .error-box {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
          }
          h1 {
            color: #ef4444;
            margin: 0 0 10px 0;
          }
          p {
            color: #64748b;
            line-height: 1.6;
          }
        </style>
      </head>
      <body>
        <div class="error-box">
          <h1>‚ùå Pagina non disponibile</h1>
          <p>Impossibile caricare il form di completamento.</p>
          <p>Contattaci a <a href="mailto:info@telemedcare.it">info@telemedcare.it</a></p>
        </div>
      </body>
      </html>
    `,500)}});I.get("/admin/system-status",o=>o.html(`
    <!DOCTYPE html>
    <html lang="it">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>TeleMedCare V12.0 - System Status</title>
        <script src="https://cdn.tailwindcss.com"><\/script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gray-50">
        <div class="min-h-screen">
            <header class="bg-gradient-to-r from-gray-600 to-gray-700 text-white shadow-lg">
                <div class="container mx-auto px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <i class="fas fa-server text-3xl"></i>
                            <div>
                                <h1 class="text-2xl font-bold">System Status</h1>
                                <p class="text-sm text-gray-200">Monitoraggio stato sistema e API</p>
                            </div>
                        </div>
                        <a href="/home" class="px-4 py-2 bg-white text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                            <i class="fas fa-home mr-2"></i>Home
                        </a>
                    </div>
                </div>
            </header>
            
            <div class="container mx-auto px-6 py-8">
                <div class="bg-white rounded-xl shadow-lg p-8 text-center">
                    <i class="fas fa-heartbeat text-6xl text-green-500 mb-4"></i>
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Sistema Online</h2>
                    <p class="text-gray-600 mb-6">Tutti i servizi stanno funzionando correttamente</p>
                    
                    <div class="grid md:grid-cols-3 gap-6 mt-8">
                        <div class="bg-green-50 rounded-lg p-6">
                            <i class="fas fa-database text-3xl text-green-600 mb-3"></i>
                            <h3 class="font-bold text-gray-800">Database</h3>
                            <p class="text-green-600">üü¢ Online</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-6">
                            <i class="fas fa-plug text-3xl text-green-600 mb-3"></i>
                            <h3 class="font-bold text-gray-800">API</h3>
                            <p class="text-green-600">üü¢ Online</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-6">
                            <i class="fas fa-envelope text-3xl text-green-600 mb-3"></i>
                            <h3 class="font-bold text-gray-800">Email Service</h3>
                            <p class="text-green-600">üü¢ Online</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    </html>
  `));I.get("/admin/backup-system",o=>o.html(`
    <!DOCTYPE html>
    <html lang="it">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>TeleMedCare V12.0 - Sistema Backup</title>
        <script src="https://cdn.tailwindcss.com"><\/script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gray-50">
        <div class="min-h-screen">
            <header class="bg-gradient-to-r from-green-600 to-green-700 text-white shadow-lg">
                <div class="container mx-auto px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <i class="fas fa-cloud-download-alt text-3xl"></i>
                            <div>
                                <h1 class="text-2xl font-bold">Sistema Backup</h1>
                                <p class="text-sm text-green-100">Backup automatico TEST/STAGING/PRODUZIONE</p>
                            </div>
                        </div>
                        <a href="/home" class="px-4 py-2 bg-white text-green-700 rounded-lg hover:bg-gray-100 transition-colors">
                            <i class="fas fa-home mr-2"></i>Home
                        </a>
                    </div>
                </div>
            </header>
            
            <div class="container mx-auto px-6 py-8">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <div class="text-center mb-8">
                        <i class="fas fa-shield-alt text-6xl text-green-500 mb-4"></i>
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Backup Automatico Attivo</h2>
                        <p class="text-gray-600">Sistema di backup configurato su Cloudflare D1</p>
                    </div>
                    
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="bg-blue-50 rounded-lg p-6 text-center">
                            <i class="fas fa-flask text-3xl text-blue-600 mb-3"></i>
                            <h3 class="font-bold text-gray-800 mb-2">TEST</h3>
                            <p class="text-sm text-gray-600 mb-3">Database sviluppo</p>
                            <span class="inline-block px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">
                                <i class="fas fa-check-circle mr-1"></i>Backup OK
                            </span>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-6 text-center">
                            <i class="fas fa-vial text-3xl text-yellow-600 mb-3"></i>
                            <h3 class="font-bold text-gray-800 mb-2">STAGING</h3>
                            <p class="text-sm text-gray-600 mb-3">Database pre-produzione</p>
                            <span class="inline-block px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm">
                                <i class="fas fa-check-circle mr-1"></i>Backup OK
                            </span>
                        </div>
                        <div class="bg-green-50 rounded-lg p-6 text-center">
                            <i class="fas fa-rocket text-3xl text-green-600 mb-3"></i>
                            <h3 class="font-bold text-gray-800 mb-2">PRODUZIONE</h3>
                            <p class="text-sm text-gray-600 mb-3">Database live</p>
                            <span class="inline-block px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">
                                <i class="fas fa-check-circle mr-1"></i>Backup OK
                            </span>
                        </div>
                    </div>
                    
                    <div class="mt-8 bg-gray-50 rounded-lg p-6">
                        <h3 class="font-bold text-gray-800 mb-4">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                            Informazioni Backup
                        </h3>
                        <ul class="space-y-2 text-gray-600">
                            <li><i class="fas fa-clock mr-2 text-green-500"></i>Backup automatici ogni 24 ore</li>
                            <li><i class="fas fa-database mr-2 text-blue-500"></i>Storage su Cloudflare R2</li>
                            <li><i class="fas fa-lock mr-2 text-purple-500"></i>Backup criptati con AES-256</li>
                            <li><i class="fas fa-history mr-2 text-yellow-500"></i>Retention: 30 giorni</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </body>
    </html>
  `));I.get("/admin/devices",o=>o.html(`
    <!DOCTYPE html>
    <html lang="it">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>TeleMedCare V12.0 - Registrazione Dispositivi</title>
        <script src="https://cdn.tailwindcss.com"><\/script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
          .scan-area { 
            border: 3px dashed #3b82f6; 
            transition: all 0.3s ease; 
          }
          .scan-area.dragover { 
            border-color: #10b981; 
            background-color: #ecfdf5; 
          }
          .device-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          }
          #cameraVideo {
            border: 2px solid #10b981;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          }
          #capturedImage {
            border: 2px solid #3b82f6;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          }
          .camera-overlay {
            position: relative;
          }
          .camera-overlay::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60%;
            border: 2px solid #10b981;
            border-radius: 8px;
            pointer-events: none;
            z-index: 1;
          }
        </style>
    </head>
    <body class="bg-gray-50">
        <div class="min-h-screen">
            <!-- Header -->
            <header class="bg-white shadow-lg border-b-4 border-blue-500">
                <div class="container mx-auto px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <i class="fas fa-microchip text-3xl text-blue-600"></i>
                            <div>
                                <h1 class="text-2xl font-bold text-gray-800">TeleMedCare V12.0</h1>
                                <p class="text-sm text-gray-600">Sistema Registrazione Dispositivi Enterprise</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">
                                <i class="fas fa-circle text-green-500 mr-1"></i>Sistema Attivo
                            </span>
                            <a href="/home" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-home mr-2"></i>Home
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <div class="container mx-auto px-6 py-8">
                <div class="grid lg:grid-cols-2 gap-8">
                    
                    <!-- Sezione Scan Etichetta -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="device-card p-3 rounded-lg">
                                <i class="fas fa-qrcode text-2xl text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">Scan Etichetta SiDLY</h2>
                                <p class="text-gray-600">Registra dispositivo da etichetta fisica</p>
                            </div>
                        </div>

                        <!-- Area Upload Etichetta -->
                        <div id="scanArea" class="scan-area p-8 rounded-xl text-center mb-6">
                            <i class="fas fa-camera text-4xl text-blue-400 mb-4"></i>
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">Carica Foto Etichetta CE</h3>
                            <p class="text-gray-500 mb-4">Scatta una foto dell'etichetta SiDLY o carica da file</p>
                            
                            <!-- Camera Preview Area (Hidden initially) -->
                            <div id="cameraPreview" class="hidden mb-4">
                                <video id="cameraVideo" class="w-full max-w-md mx-auto rounded-lg shadow-lg" autoplay playsinline></video>
                                <div class="mt-4 space-x-3">
                                    <button onclick="capturePhoto()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                        <i class="fas fa-camera mr-2"></i>Scatta Foto
                                    </button>
                                    <button onclick="stopCamera()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                        <i class="fas fa-times mr-2"></i>Chiudi Camera
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Captured Image Preview -->
                            <div id="imagePreview" class="hidden mb-4">
                                <img id="capturedImage" class="w-full max-w-md mx-auto rounded-lg shadow-lg" alt="Etichetta catturata">
                                <div class="mt-4 space-x-3">
                                    <button onclick="retakePhoto()" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors">
                                        <i class="fas fa-redo mr-2"></i>Rifai Foto
                                    </button>
                                    <button onclick="processImage()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-check mr-2"></i>Usa Foto
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div id="actionButtons" class="space-x-3">
                                <input type="file" id="labelFile" accept="image/*" class="hidden">
                                <button onclick="startCamera()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                    <i class="fas fa-camera mr-2"></i>Scatta Foto
                                </button>
                                <button onclick="document.getElementById('labelFile').click()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-upload mr-2"></i>Carica File
                                </button>
                            </div>
                        </div>

                        <!-- Form Manuale -->
                        <div class="border-t pt-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">
                                <i class="fas fa-keyboard mr-2"></i>Inserimento Manuale IMEI
                            </h3>
                            <form id="manualForm">
                                <div class="grid md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2">IMEI *</label>
                                        <input type="text" id="imeiInput" maxlength="15" 
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               placeholder="Es: 868298006120837">
                                        <p class="text-xs text-gray-500 mt-1">Dall'etichetta della foto caricata</p>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2">Modello</label>
                                        <select id="modelSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="SiDLY Care Pro">SiDLY Care Pro</option>
                                            <option value="SiDLY Care Pro V10">SiDLY Care Pro V10</option>
                                            <option value="SiDLY Care Pro V12">SiDLY Care Pro V12</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Sezione Date Dispositivo SiDLY -->
                                <div class="border-t pt-6 mt-6">
                                    <h4 class="text-md font-semibold text-gray-800 mb-4">
                                        <i class="fas fa-calendar mr-2 text-purple-500"></i>Date Dispositivo SiDLY
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2">Data Fabbricazione *</label>
                                            <input type="date" id="manufacturingDateInput" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                   onchange="calculateExpiry()">
                                            <p class="text-xs text-gray-500 mt-1">Data di fabbricazione dall'etichetta SiDLY</p>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2">Data Scadenza</label>
                                            <input type="date" id="expiryDateInput" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                            <p class="text-xs text-gray-500 mt-1">Calcolata automaticamente dalla vita utile (5 anni per SiDLY)</p>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2">Vita Utile (anni)</label>
                                            <select id="usefulLifeSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" onchange="calculateExpiry()">
                                                <option value="5">5 anni (Standard SiDLY)</option>
                                                <option value="3">3 anni (Versioni precedenti)</option>
                                                <option value="7">7 anni (Pro Extended)</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Vita utile del dispositivo secondo manuale</p>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2">Numero Lotto</label>
                                            <input type="text" id="batchNumberInput" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                   placeholder="Es: LOT-2024-001">
                                            <p class="text-xs text-gray-500 mt-1">Numero di lotto di produzione</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-gray-700 font-semibold mb-2">Magazzino Destinazione</label>
                                    <select id="warehouseSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="Milano">Milano - Sede Principale</option>
                                        <option value="Roma">Roma - Hub Centro</option>
                                        <option value="Torino">Torino - Partner IRBEMA</option>
                                        <option value="Napoli">Napoli - Hub Sud</option>
                                    </select>
                                </div>
                                
                                <!-- Sezione Certificazione CE -->
                                <div class="border-t pt-6 mt-6">
                                    <h4 class="text-md font-semibold text-gray-800 mb-4">
                                        <i class="fas fa-certificate mr-2 text-blue-500"></i>Certificazione CE
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2">Numero Certificato CE *</label>
                                            <input type="text" id="ceNumberInput" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                   placeholder="Es: CE-12345-2024">
                                            <p class="text-xs text-gray-500 mt-1">Numero del certificato di conformit√† CE</p>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2">Data Rilascio CE</label>
                                            <input type="date" id="ceDateInput" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <p class="text-xs text-gray-500 mt-1">Data di rilascio della certificazione</p>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2">Ente Certificatore</label>
                                            <input type="text" id="ceAuthorityInput" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                   placeholder="Es: T√úV Rheinland Italia">
                                            <p class="text-xs text-gray-500 mt-1">Nome dell'ente che ha rilasciato la certificazione</p>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2">Data Scadenza CE</label>
                                            <input type="date" id="ceExpiryInput" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <p class="text-xs text-gray-500 mt-1">Data di scadenza della certificazione</p>
                                        </div>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 font-semibold mb-2">Classi di Rischio CE</label>
                                        <select id="ceRiskClassSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="">Seleziona classe di rischio</option>
                                            <option value="Classe I">Classe I - Basso rischio</option>
                                            <option value="Classe IIa">Classe IIa - Medio-basso rischio</option>
                                            <option value="Classe IIb">Classe IIb - Medio-alto rischio</option>
                                            <option value="Classe III">Classe III - Alto rischio</option>
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">Classificazione del dispositivo secondo la direttiva MDD/MDR</p>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 font-semibold mb-2">Note Certificazione</label>
                                        <textarea id="ceNotesInput" rows="3" 
                                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                  placeholder="Eventuali note aggiuntive sulla certificazione CE"></textarea>
                                    </div>
                                </div>
                                
                                <button type="submit" class="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold">
                                    <i class="fas fa-plus-circle mr-2"></i>Registra Dispositivo
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Sezione Risultati -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="bg-green-100 p-3 rounded-lg">
                                <i class="fas fa-check-circle text-2xl text-green-600"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">Risultato Registrazione</h2>
                                <p class="text-gray-600">Status e dettagli dispositivo</p>
                            </div>
                        </div>

                        <!-- Area Risultati -->
                        <div id="resultArea" class="hidden">
                            <div id="successResult" class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4 hidden">
                                <div class="flex items-center">
                                    <i class="fas fa-check-circle text-green-500 text-xl mr-3"></i>
                                    <div>
                                        <h4 class="font-semibold text-green-800">‚úÖ Dispositivo Registrato!</h4>
                                        <p class="text-green-700" id="successMessage"></p>
                                    </div>
                                </div>
                                <div class="mt-4 space-y-2" id="deviceDetails"></div>
                            </div>

                            <div id="errorResult" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4 hidden">
                                <div class="flex items-center">
                                    <i class="fas fa-exclamation-circle text-red-500 text-xl mr-3"></i>
                                    <div>
                                        <h4 class="font-semibold text-red-800">‚ùå Errore Registrazione</h4>
                                        <p class="text-red-700" id="errorMessage"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stato Parsing -->
                        <div id="parsingStatus" class="text-center py-8 text-gray-500 hidden">
                            <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                            <p class="text-lg">‚è≥ Analisi etichetta in corso...</p>
                        </div>

                        <!-- Placeholder iniziale -->
                        <div id="placeholderArea" class="text-center py-12 text-gray-400">
                            <i class="fas fa-clipboard-list text-4xl mb-4"></i>
                            <p class="text-lg">üìã In attesa di registrazione dispositivo</p>
                            <p class="text-sm">I risultati appariranno qui dopo la scansione</p>
                        </div>
                    </div>
                </div>

                <!-- Statistiche Rapide -->
                <div class="mt-8 grid md:grid-cols-4 gap-4">
                    <div class="bg-white rounded-lg shadow p-4 text-center">
                        <i class="fas fa-microchip text-2xl text-blue-500 mb-2"></i>
                        <div class="text-2xl font-bold text-gray-800" id="totalDevices">-</div>
                        <div class="text-sm text-gray-600">Dispositivi Totali</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4 text-center">
                        <i class="fas fa-warehouse text-2xl text-green-500 mb-2"></i>
                        <div class="text-2xl font-bold text-gray-800" id="stockDevices">-</div>
                        <div class="text-sm text-gray-600">In Magazzino</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4 text-center">
                        <i class="fas fa-shipping-fast text-2xl text-yellow-500 mb-2"></i>
                        <div class="text-2xl font-bold text-gray-800" id="shippedDevices">-</div>
                        <div class="text-sm text-gray-600">Spediti</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4 text-center">
                        <i class="fas fa-heartbeat text-2xl text-red-500 mb-2"></i>
                        <div class="text-2xl font-bold text-gray-800" id="activeDevices">-</div>
                        <div class="text-sm text-gray-600">Attivi</div>
                    </div>
                </div>

                <!-- Lista Dispositivi Magazzino -->
                <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="bg-purple-100 p-3 rounded-lg">
                                <i class="fas fa-boxes text-purple-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Magazzino Dispositivi</h3>
                                <p class="text-gray-600">Elenco completo dispositivi registrati</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <select id="warehouseFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">Tutti i magazzini</option>
                                <option value="Milano">Milano</option>
                                <option value="Roma">Roma</option>
                                <option value="Torino">Torino</option>
                                <option value="Napoli">Napoli</option>
                            </select>
                            <select id="statusFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">Tutti gli stati</option>
                                <option value="INVENTORY">In Magazzino</option>
                                <option value="ASSIGNED">Assegnato</option>
                                <option value="SHIPPED">Spedito</option>
                                <option value="ACTIVE">Attivo</option>
                                <option value="MAINTENANCE">Manutenzione</option>
                            </select>
                            <button onclick="loadDevicesList()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                <i class="fas fa-sync mr-2"></i>Aggiorna
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">IMEI</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Modello</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Magazzino</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stato</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">CE</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data Reg.</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="devicesTableBody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i><br>
                                        Caricamento dispositivi...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Guida Rapida -->
                <div class="mt-8 bg-blue-50 rounded-xl p-6">
                    <h3 class="text-lg font-bold text-blue-900 mb-4">
                        <i class="fas fa-info-circle mr-2"></i>Come utilizzare il sistema
                    </h3>
                    <div class="grid md:grid-cols-2 gap-6 text-sm text-blue-800">
                        <div>
                            <h4 class="font-semibold mb-2">üì∏ Scan da Foto:</h4>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Scatta foto nitida dell'etichetta SiDLY</li>
                                <li>Carica il file tramite drag&drop o click</li>
                                <li>Il sistema analizza automaticamente IMEI, UDI, CE</li>
                                <li>Conferma i dati e registra il dispositivo</li>
                            </ol>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">‚å®Ô∏è Inserimento Manuale:</h4>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Inserisci IMEI di 15 cifre dall'etichetta</li>
                                <li>Seleziona modello e magazzino destinazione</li>
                                <li>Clicca "Registra Dispositivo"</li>
                                <li>Il sistema valida IMEI e crea la registrazione</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Configurazione sistema
            const API_BASE = '/api';
            
            // Inizializzazione
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üöÄ TeleMedCare V12.0 - Device Registration System');
                loadStatistics();
                setupFileUpload();
                setupManualForm();
                // Carica dispositivi dopo un breve delay per dare tempo alle statistiche
                setTimeout(() => {
                    loadDevicesList();
                }, 1000);
            });

            // Setup upload file
            function setupFileUpload() {
                const fileInput = document.getElementById('labelFile');
                const scanArea = document.getElementById('scanArea');

                // Drag & Drop
                scanArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    scanArea.classList.add('dragover');
                });

                scanArea.addEventListener('dragleave', () => {
                    scanArea.classList.remove('dragover');
                });

                scanArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    scanArea.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleFileSelect(files[0]);
                    }
                });

                // File input change
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleFileSelect(e.target.files[0]);
                    }
                });
            }

            // Funzione per calcolare automaticamente la data di scadenza
            function calculateExpiry() {
                const manufacturingDate = document.getElementById('manufacturingDateInput').value;
                const usefulLife = parseInt(document.getElementById('usefulLifeSelect').value);
                
                if (manufacturingDate && usefulLife) {
                    const mfgDate = new Date(manufacturingDate);
                    const expiryDate = new Date(mfgDate);
                    expiryDate.setFullYear(expiryDate.getFullYear() + usefulLife);
                    
                    // Format date to YYYY-MM-DD for input field
                    const formattedDate = expiryDate.toISOString().split('T')[0];
                    document.getElementById('expiryDateInput').value = formattedDate;
                }
            }

            // ========== CAMERA FUNCTIONS ==========
            let cameraStream = null;
            let capturedImageData = null;

            // Avvia la camera
            async function startCamera() {
                try {
                    const video = document.getElementById('cameraVideo');
                    const cameraPreview = document.getElementById('cameraPreview');
                    const actionButtons = document.getElementById('actionButtons');
                    const imagePreview = document.getElementById('imagePreview');

                    // Nasconde altri elementi
                    actionButtons.classList.add('hidden');
                    imagePreview.classList.add('hidden');

                    // Mostra preview camera
                    cameraPreview.classList.remove('hidden');

                    // Configura la camera (preferisce camera posteriore su mobile)
                    const constraints = {
                        video: {
                            facingMode: { ideal: 'environment' }, // Camera posteriore
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };

                    cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = cameraStream;
                    
                    console.log('‚úÖ Camera avviata con successo');
                } catch (error) {
                    console.error('‚ùå Errore avvio camera:', error);
                    alert('Errore nell\\'accesso alla camera. Assicurati di aver concesso i permessi.');
                    showActionButtons();
                }
            }

            // Cattura una foto dalla camera
            function capturePhoto() {
                try {
                    const video = document.getElementById('cameraVideo');
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');

                    // Imposta le dimensioni del canvas
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;

                    // Disegna il frame corrente del video sul canvas
                    context.drawImage(video, 0, 0);

                    // Converti in base64
                    capturedImageData = canvas.toDataURL('image/jpeg', 0.8);

                    // Mostra l'immagine catturata
                    const capturedImage = document.getElementById('capturedImage');
                    capturedImage.src = capturedImageData;

                    // Nasconde camera, mostra preview immagine
                    document.getElementById('cameraPreview').classList.add('hidden');
                    document.getElementById('imagePreview').classList.remove('hidden');

                    console.log('üì∏ Foto catturata con successo');
                } catch (error) {
                    console.error('‚ùå Errore cattura foto:', error);
                    alert('Errore durante la cattura della foto.');
                }
            }

            // Rifai la foto
            function retakePhoto() {
                document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('cameraPreview').classList.remove('hidden');
                capturedImageData = null;
            }

            // Ferma la camera
            function stopCamera() {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                }
                
                document.getElementById('cameraPreview').classList.add('hidden');
                document.getElementById('imagePreview').classList.add('hidden');
                showActionButtons();
                capturedImageData = null;
            }

            // Mostra i pulsanti di azione iniziali
            function showActionButtons() {
                document.getElementById('actionButtons').classList.remove('hidden');
            }

            // Processa l'immagine catturata
            function processImage() {
                if (!capturedImageData) {
                    alert('Nessuna immagine da processare');
                    return;
                }

                // Ferma la camera
                stopCamera();

                // Simula il processing dell'immagine come se fosse un file caricato
                // Converte base64 in File object per compatibilit√†
                fetch(capturedImageData)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], 'etichetta_camera.jpg', { type: 'image/jpeg' });
                        handleFileSelect(file);
                    })
                    .catch(error => {
                        console.error('‚ùå Errore processing immagine:', error);
                        alert('Errore nel processamento dell\\'immagine');
                    });
            }

            // Setup form manuale
            function setupManualForm() {
                document.getElementById('manualForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const imei = document.getElementById('imeiInput').value.trim();
                    const model = document.getElementById('modelSelect').value;
                    const warehouse = document.getElementById('warehouseSelect').value;
                    
                    // Dati dispositivo SiDLY
                    const manufacturingDate = document.getElementById('manufacturingDateInput').value;
                    const expiryDate = document.getElementById('expiryDateInput').value;
                    const usefulLife = document.getElementById('usefulLifeSelect').value;
                    const batchNumber = document.getElementById('batchNumberInput').value.trim();
                    
                    // Dati certificazione CE
                    const ceNumber = document.getElementById('ceNumberInput').value.trim();
                    const ceDate = document.getElementById('ceDateInput').value;
                    const ceAuthority = document.getElementById('ceAuthorityInput').value.trim();
                    const ceExpiry = document.getElementById('ceExpiryInput').value;
                    const ceRiskClass = document.getElementById('ceRiskClassSelect').value;
                    const ceNotes = document.getElementById('ceNotesInput').value.trim();

                    if (!imei || imei.length !== 15) {
                        showError('IMEI deve essere di 15 cifre numeriche');
                        return;
                    }

                    if (!/^\\d{15}$/.test(imei)) {
                        showError('IMEI deve contenere solo cifre');
                        return;
                    }

                    if (!manufacturingDate) {
                        showError('Data Fabbricazione √® obbligatoria');
                        return;
                    }

                    if (!ceNumber) {
                        showError('Numero Certificato CE √® obbligatorio');
                        return;
                    }

                    await registerDevice({
                        labelText: \`SIDLY CARE PRO\\nIMEI: \${imei}\\nModello: \${model}\\nData Fab: \${manufacturingDate}\\nScadenza: \${expiryDate}\\nLotto: \${batchNumber}\\nCE \${ceNumber}\\nSIDLY Sp. z o.o.\`,
                        magazzino: warehouse,
                        deviceData: {
                            manufacturingDate: manufacturingDate,
                            expiryDate: expiryDate,
                            usefulLife: usefulLife,
                            batchNumber: batchNumber
                        },
                        ceData: {
                            ceNumber: ceNumber,
                            ceDate: ceDate,
                            ceAuthority: ceAuthority,
                            ceExpiry: ceExpiry,
                            ceRiskClass: ceRiskClass,
                            ceNotes: ceNotes
                        }
                    });
                });

                // Validazione real-time IMEI
                document.getElementById('imeiInput').addEventListener('input', (e) => {
                    const value = e.target.value.replace(/\\D/g, ''); // Solo cifre
                    e.target.value = value;
                });
            }

            // Gestione file selezionato
            async function handleFileSelect(file) {
                console.log('üì∏ File selezionato:', file.name);
                showParsingStatus(true);

                try {
                    if (file.type.startsWith('image/')) {
                        // Per immagini: genera mock data realistico
                        const mockIMEI = generateMockIMEI();
                        const mockLabelText = \`
                            SIDLY CARE PRO
                            Il braccialetto SiDly Care PRO √® un dispositivo telemedico
                            IMEI: \${mockIMEI}
                            (01)05903890760045
                            (11)230501
                            CE 0197
                            SIDLY Sp. z o.o.
                            Ul. Chmielna 2/31, 00-020 Warszawa
                            tel: +48 667 871 126
                            email: helpdesk@sidly.org
                            Ver. 7_07022024
                        \`;
                        
                        // Popola anche il form manuale per comodit√†
                        document.getElementById('imeiInput').value = mockIMEI;
                        
                        await registerDevice({
                            labelText: mockLabelText,
                            labelImage: file.name,
                            magazzino: document.getElementById('warehouseSelect').value
                        });
                    } else {
                        // File di testo
                        const text = await file.text();
                        await registerDevice({
                            labelText: text,
                            magazzino: document.getElementById('warehouseSelect').value
                        });
                    }
                } catch (error) {
                    console.error('‚ùå Errore handling file:', error);
                    showError(\`Errore lettura file: \${error.message}\`);
                } finally {
                    showParsingStatus(false);
                }
            }

            // Registrazione dispositivo
            async function registerDevice(data) {
                console.log('üìù Registrazione dispositivo:', data);
                
                try {
                    const response = await fetch(\`\${API_BASE}/devices/test-scan\`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();
                    console.log('üìã Risultato registrazione:', result);

                    if (result.success) {
                        showSuccess(result);
                        loadStatistics(); // Aggiorna statistiche
                        
                        // Reset form dopo 3 secondi
                        setTimeout(() => {
                            document.getElementById('manualForm').reset();
                        }, 3000);
                    } else {
                        showError(result.error, result.details);
                    }
                } catch (error) {
                    console.error('‚ùå Errore registrazione:', error);
                    showError(\`Errore connessione server: \${error.message}\`);
                }
            }

            // Mostra successo
            function showSuccess(result) {
                const resultArea = document.getElementById('resultArea');
                const successResult = document.getElementById('successResult');
                const deviceDetails = document.getElementById('deviceDetails');
                const placeholderArea = document.getElementById('placeholderArea');

                document.getElementById('successMessage').textContent = result.message;
                
                deviceDetails.innerHTML = \`
                    <div class="bg-white p-3 rounded border-l-4 border-green-500">
                        <strong>üÜî Device ID:</strong> <code class="bg-gray-100 px-2 py-1 rounded">\${result.deviceId}</code>
                    </div>
                    <div class="bg-white p-3 rounded border-l-4 border-blue-500">
                        <strong>üì± IMEI:</strong> <code class="bg-gray-100 px-2 py-1 rounded">\${result.imei}</code>
                    </div>
                    <div class="bg-white p-3 rounded border-l-4 border-purple-500">
                        <strong>üè∑Ô∏è Modello:</strong> \${result.model}
                    </div>
                    \${result.ceData ? \`
                    <div class="bg-green-50 p-3 rounded border border-green-200">
                        <strong>üèÜ Certificazione CE:</strong><br>
                        <div class="text-sm text-green-800 mt-2 space-y-1">
                            <div><strong>Numero:</strong> \${result.ceData.ceNumber}</div>
                            \${result.ceData.ceAuthority ? \`<div><strong>Ente:</strong> \${result.ceData.ceAuthority}</div>\` : ''}
                            \${result.ceData.ceRiskClass ? \`<div><strong>Classe Rischio:</strong> \${result.ceData.ceRiskClass}</div>\` : ''}
                            \${result.ceData.ceDate ? \`<div><strong>Data Rilascio:</strong> \${new Date(result.ceData.ceDate).toLocaleDateString('it-IT')}</div>\` : ''}
                            \${result.ceData.ceExpiry ? \`<div><strong>Scadenza:</strong> \${new Date(result.ceData.ceExpiry).toLocaleDateString('it-IT')}</div>\` : ''}
                            \${result.ceData.ceNotes ? \`<div><strong>Note:</strong> \${result.ceData.ceNotes}</div>\` : ''}
                        </div>
                    </div>
                    \` : ''}
                    \${result.labelData ? \`
                    <div class="bg-blue-50 p-3 rounded border">
                        <strong>üìã Dati Etichetta:</strong><br>
                        <small class="text-gray-600">UDI: \${result.labelData.udiNumbers?.di || 'N/A'} | 
                        CE: \${result.labelData.ceMarking || 'N/A'} | 
                        Produttore: \${result.labelData.manufacturer?.name || 'N/A'}</small>
                    </div>
                    \` : ''}
                \`;

                hideAllResults();
                successResult.classList.remove('hidden');
                resultArea.classList.remove('hidden');
                placeholderArea.classList.add('hidden');
            }

            // Mostra errore
            function showError(message, details = []) {
                const resultArea = document.getElementById('resultArea');
                const errorResult = document.getElementById('errorResult');
                const placeholderArea = document.getElementById('placeholderArea');

                let fullMessage = message;
                if (details && details.length > 0) {
                    fullMessage += \`\\n\\nüîç Dettagli:\\n‚Ä¢ \${details.join('\\n‚Ä¢ ')}\`;
                }

                document.getElementById('errorMessage').textContent = fullMessage;

                hideAllResults();
                errorResult.classList.remove('hidden');
                resultArea.classList.remove('hidden');
                placeholderArea.classList.add('hidden');
            }

            // Mostra status parsing
            function showParsingStatus(show) {
                const parsingStatus = document.getElementById('parsingStatus');
                const placeholderArea = document.getElementById('placeholderArea');

                if (show) {
                    hideAllResults();
                    parsingStatus.classList.remove('hidden');
                    placeholderArea.classList.add('hidden');
                } else {
                    parsingStatus.classList.add('hidden');
                }
            }

            // Nascondi tutti i risultati
            function hideAllResults() {
                document.getElementById('successResult').classList.add('hidden');
                document.getElementById('errorResult').classList.add('hidden');
                document.getElementById('parsingStatus').classList.add('hidden');
            }

            // Carica statistiche
            async function loadStatistics() {
                try {
                    const response = await fetch('/api/devices/stats');
                    const data = await response.json();
                    
                    if (data.success && data.stats) {
                        const stats = data.stats;
                        document.getElementById('totalDevices').textContent = stats.totalDevices || 0;
                        document.getElementById('stockDevices').textContent = stats.availableDevices || 0;
                        document.getElementById('shippedDevices').textContent = (stats.statusDistribution?.find(s => s.status === 'SHIPPED')?.count || 0);
                        document.getElementById('activeDevices').textContent = stats.activeDevices || 0;
                    } else {
                        // Fallback con dati demo
                        document.getElementById('totalDevices').textContent = '12';
                        document.getElementById('stockDevices').textContent = '8';
                        document.getElementById('shippedDevices').textContent = '3';
                        document.getElementById('activeDevices').textContent = '1';
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Errore caricamento statistiche:', error);
                }
            }

            // Genera IMEI mock realistico per demo
            function generateMockIMEI() {
                const tac = '35900002'; // SiDLY Technologies V12.0
                const snr = Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
                const imei14 = tac + snr;
                
                // Calcolo check digit Luhn algorithm
                let sum = 0;
                let alternate = false;
                
                for (let i = imei14.length - 1; i >= 0; i--) {
                    let digit = parseInt(imei14.charAt(i));
                    if (alternate) {
                        digit *= 2;
                        if (digit > 9) digit = Math.floor(digit / 10) + (digit % 10);
                    }
                    sum += digit;
                    alternate = !alternate;
                }
                
                const checkDigit = (10 - (sum % 10)) % 10;
                return imei14 + checkDigit;
            }

            // Carica lista dispositivi
            async function loadDevicesList() {
                try {
                    const warehouseFilter = document.getElementById('warehouseFilter').value;
                    const statusFilter = document.getElementById('statusFilter').value;
                    
                    let url = '/api/devices/inventory';
                    const params = new URLSearchParams();
                    if (warehouseFilter) params.append('warehouse', warehouseFilter);
                    if (statusFilter) params.append('status', statusFilter);
                    if (params.toString()) url += '?' + params.toString();
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.success && data.data && data.data.devices) {
                        displayDevicesList(data.data.devices);
                    } else {
                        showDevicesError('Errore caricamento dispositivi: ' + (data.error || 'Unknown'));
                    }
                } catch (error) {
                    console.error('Errore caricamento dispositivi:', error);
                    showDevicesError('Errore connessione server');
                }
            }

            // Mostra lista dispositivi
            function displayDevicesList(devices) {
                const tbody = document.getElementById('devicesTableBody');
                
                if (!devices || devices.length === 0) {
                    tbody.innerHTML = \`
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                <i class="fas fa-box-open text-3xl mb-2"></i><br>
                                Nessun dispositivo trovato
                            </td>
                        </tr>
                    \`;
                    return;
                }
                
                tbody.innerHTML = devices.map(device => \`
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-4 text-sm font-mono text-gray-900">\${device.imei || 'N/A'}</td>
                        <td class="px-4 py-4 text-sm text-gray-900">\${device.model || 'N/A'}</td>
                        <td class="px-4 py-4 text-sm text-gray-900">\${device.magazzino || 'N/A'}</td>
                        <td class="px-4 py-4 text-sm">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full \${getStatusBadgeClass(device.status)}">
                                \${getStatusLabel(device.status)}
                            </span>
                        </td>
                        <td class="px-4 py-4 text-sm text-gray-900">
                            \${device.ce_marking || 'N/A'}
                        </td>
                        <td class="px-4 py-4 text-sm text-gray-500">
                            \${device.created_at ? new Date(device.created_at).toLocaleDateString('it-IT') : 'N/A'}
                        </td>
                        <td class="px-4 py-4 text-sm font-medium">
                            <button onclick="viewDeviceDetails('\${device.device_id}')" class="text-blue-600 hover:text-blue-800 mr-2">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editDeviceStatus('\${device.device_id}')" class="text-green-600 hover:text-green-800">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                \`).join('');
            }

            // Helper functions per stato dispositivi
            function getStatusBadgeClass(status) {
                switch (status) {
                    case 'INVENTORY': return 'bg-green-100 text-green-800';
                    case 'ASSIGNED': return 'bg-blue-100 text-blue-800';
                    case 'SHIPPED': return 'bg-yellow-100 text-yellow-800';
                    case 'ACTIVE': return 'bg-purple-100 text-purple-800';
                    case 'MAINTENANCE': return 'bg-orange-100 text-orange-800';
                    case 'DECOMMISSIONED': return 'bg-red-100 text-red-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            }

            function getStatusLabel(status) {
                switch (status) {
                    case 'INVENTORY': return 'In Magazzino';
                    case 'ASSIGNED': return 'Assegnato';
                    case 'SHIPPED': return 'Spedito';
                    case 'ACTIVE': return 'Attivo';
                    case 'MAINTENANCE': return 'Manutenzione';
                    case 'DECOMMISSIONED': return 'Dismesso';
                    default: return status || 'Sconosciuto';
                }
            }

            function showDevicesError(message) {
                const tbody = document.getElementById('devicesTableBody');
                tbody.innerHTML = \`
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-red-500">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i><br>
                            \${message}
                        </td>
                    </tr>
                \`;
            }

            function viewDeviceDetails(deviceId) {
                alert('Visualizza dettagli dispositivo: ' + deviceId);
                // TODO: Implementare modal dettagli
            }

            function editDeviceStatus(deviceId) {
                alert('Modifica stato dispositivo: ' + deviceId);
                // TODO: Implementare modal modifica stato
            }
        <\/script>

        <script>
            // Aggiorna le mini-statistiche del Dashboard Leads
            async function updateLeadsModuleStats() {
                try {
                    const response = await fetch('/api/admin/leads-dashboard');
                    const data = await response.json();
                    
                    if (data.success && data.dashboard) {
                        const stats = data.dashboard;
                        
                        // Aggiorna le mini-statistiche nel box
                        document.getElementById('configPartners').textContent = stats.analytics.partners?.length || 0;
                        document.getElementById('coreLeads').textContent = stats.kpi.leadsTotali || 0;
                        document.getElementById('channels').textContent = stats.analytics.channels?.length || 0;
                        document.getElementById('conversions').textContent = stats.modules.conversion || 0;
                        document.getElementById('scoreAvg').textContent = stats.kpi.scoreMedio?.toFixed(1) || '0.0';
                        document.getElementById('reportsCount').textContent = stats.modules.reports || 0;
                    }
                } catch (error) {
                    console.error('Errore aggiornamento statistiche leads:', error);
                    // Fallback values
                    document.getElementById('configPartners').textContent = '6';
                    document.getElementById('coreLeads').textContent = '25';
                    document.getElementById('channels').textContent = '5';
                    document.getElementById('conversions').textContent = '12';
                    document.getElementById('scoreAvg').textContent = '7.2';
                    document.getElementById('reportsCount').textContent = '24';
                }
            }

            // Carica le statistiche all'avvio della pagina
            document.addEventListener('DOMContentLoaded', function() {
                updateLeadsModuleStats();
                // Auto-refresh ogni 60 secondi
                setInterval(updateLeadsModuleStats, 60000);
            });
        <\/script>
        
        <!-- FOOTER DISCRETO PER ACCESSO STAFF -->
        <footer class="bg-gray-900 text-white py-4">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center">
                    <div class="text-sm">
                        <p>&copy; 2024 TeleMedCare V12.0 - Medica GB S.r.l. Tutti i diritti riservati.</p>
                    </div>
                    <div class="text-xs">
                        <a href="/dashboard" class="text-gray-400 hover:text-white transition-colors" title="Accesso Staff">
                            Staff Area
                        </a>
                    </div>
                </div>
            </div>
        </footer>
    </body>
    </html>
  `));I.post("/api/lead",async o=>{try{console.log("üì® TeleMedCare V12.0-Cloudflare: Nuovo lead ricevuto");let t={};if((o.req.header("content-type")||"").includes("application/json"))t=await o.req.json();else{const v=await o.req.formData();for(const[b,E]of v.entries())t[b]=E}console.log("üìù Dati lead ricevuti:",JSON.stringify(t,null,2));const a=t.nome||t.nomeRichiedente||"",i=t.email||t.emailRichiedente||"",s=t.telefono||t.telefonoRichiedente||"",r=t.eta||t.etaRichiedente||null,l=t.servizio||t.tipoServizio||"BASIC",c=t.azienda||t.aziendaRichiedente||null;if(!a||!i)return o.json({success:!1,error:"Campi obbligatori mancanti: nome e email sono richiesti"},400);const d=ww(),u=new Date().toISOString(),{calcolaEta:p}=await Promise.resolve().then(()=>Pw),g=t.dataNascitaAssistito?p(t.dataNascitaAssistito):null,m={id:d,nomeRichiedente:String(a).trim(),cognomeRichiedente:String(t.cognomeRichiedente||"").trim(),emailRichiedente:String(i).toLowerCase().trim(),telefonoRichiedente:String(s).replace(/[^\d+]/g,""),nomeAssistito:String(t.nomeAssistito||a).trim(),cognomeAssistito:String(t.cognomeAssistito||"").trim(),dataNascitaAssistito:String(t.dataNascitaAssistito||"").trim(),etaAssistito:String(r||g||t.etaAssistito||"").trim(),parentelaAssistito:String(t.parentelaAssistito||"").trim(),servizio:String(l),pacchetto:String(t.pacchetto||"BASE"),condizioniSalute:String(t.condizioniSalute||"").trim(),priority:String(t.priority||"").trim(),preferenzaContatto:String(t.preferenzaContatto||"").trim(),vuoleContratto:t.vuoleContratto==="on"||t.vuoleContratto==="Si"||t.vuoleContratto===!0,intestazioneContratto:String(t.intestazioneContratto||c||"").trim(),cfRichiedente:String(t.cfRichiedente||"").trim(),indirizzoRichiedente:String(t.indirizzoRichiedente||"").trim(),cfAssistito:String(t.cfAssistito||"").trim(),indirizzoAssistito:String(t.indirizzoAssistito||"").trim(),vuoleBrochure:t.vuoleBrochure==="on"||t.vuoleBrochure==="Si"||t.vuoleBrochure===!0,vuoleManuale:t.vuoleManuale==="on"||t.vuoleManuale==="Si"||t.vuoleManuale===!0,note:String(t.note||"").trim(),gdprConsent:t.gdprConsent==="on"||t.gdprConsent===!0||t.privacy===!0,timestamp:u,fonte:String(t.fonte||t.source||"Landing Page V12.0-Cloudflare"),versione:String(t.versione||"V12.0-Cloudflare"),status:"nuovo"};if(console.log("‚úÖ Dati normalizzati:",JSON.stringify(m,null,2)),o.env.DB){const{servizio:v,piano:b,prezzoAnno:E,prezzoRinnovo:T}=Ew(m.pacchetto);console.log(`üí∞ [PRICING] ${m.pacchetto} ‚Üí ${v} ${b} = ‚Ç¨${E} (rinnovo: ‚Ç¨${T})`),await o.env.DB.prepare(`
        INSERT INTO leads (
          id, nomeRichiedente, cognomeRichiedente, emailRichiedente, telefonoRichiedente,
          nomeAssistito, cognomeAssistito, dataNascitaAssistito, etaAssistito, parentelaAssistito,
          pacchetto, condizioniSalute, preferenzaContatto,
          vuoleContratto, intestazioneContratto, cfRichiedente, indirizzoRichiedente,
          cfAssistito, indirizzoAssistito, vuoleBrochure, vuoleManuale,
          note, gdprConsent, timestamp, fonte, versione, status,
          prezzo_anno, prezzo_rinnovo
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `).bind(m.id,m.nomeRichiedente,m.cognomeRichiedente,m.emailRichiedente,m.telefonoRichiedente,m.nomeAssistito,m.cognomeAssistito,m.dataNascitaAssistito,m.etaAssistito,m.parentelaAssistito,m.pacchetto,m.condizioniSalute,m.preferenzaContatto,m.vuoleContratto?1:0,m.intestazioneContratto,m.cfRichiedente,m.indirizzoRichiedente,m.cfAssistito,m.indirizzoAssistito,m.vuoleBrochure?1:0,m.vuoleManuale?1:0,m.note,m.gdprConsent?1:0,m.timestamp,m.fonte,m.versione,m.status,E,T).run(),console.log("‚úÖ Lead salvato nel database con nuovo schema"),console.log("üöÄ [WORKFLOW] Avvio orchestratore workflow completo");const R={db:o.env.DB,env:o.env,leadData:{id:m.id,nomeRichiedente:m.nomeRichiedente,cognomeRichiedente:m.cognomeRichiedente,emailRichiedente:m.emailRichiedente,telefonoRichiedente:m.telefonoRichiedente,nomeAssistito:m.nomeAssistito,cognomeAssistito:m.cognomeAssistito,etaAssistito:m.etaAssistito,pacchetto:m.pacchetto,servizio:m.servizio||"PRO",vuoleContratto:m.vuoleContratto,vuoleBrochure:m.vuoleBrochure,vuoleManuale:m.vuoleManuale,fonte:m.fonte}};try{const S=await ow(R);return console.log("üìß [WORKFLOW] Orchestratore completato:",S),o.json({success:!0,leadId:d,message:"Lead ricevuto e processato con successo",timestamp:u,workflow:S})}catch(S){return console.error("‚ö†Ô∏è Workflow orchestrator error (lead gi√† salvato):",S),console.error("Stack:",S instanceof Error?S.stack:"No stack"),o.json({success:!0,leadId:d,message:"Lead salvato con successo",timestamp:u,warning:"Email workflow may be delayed",workflowError:S instanceof Error?S.message:String(S)})}}else return console.log("‚ö†Ô∏è Database non configurato - modalit√† development"),o.json({success:!0,leadId:d,message:"Lead ricevuto (database non configurato)",timestamp:u})}catch(t){return console.error("‚ùå TeleMedCare V12.0-Cloudflare: Errore elaborazione lead:",t),o.json({success:!1,error:"Errore interno del server"},500)}});I.post("/api/admin/cleanup-test-leads",async o=>{try{if(!o.env.DB)return o.json({error:"Database non configurato"},400);console.log("üßπ PULIZIA LEAD DI TEST - V2");const t=await o.env.DB.prepare("SELECT COUNT(*) as count FROM leads").first();console.log(`Total leads in DB: ${t==null?void 0:t.count}`);const e=["LEAD_2025-12-25T211955823Z_C4VLK9","LEAD_2025-12-25T205008061Z_GC3563","LEAD_2025-12-25T204957004Z_MCNVSH","LEAD_2025-12-25T204530619Z_KJST6F","LEAD_2025-12-25T204200079Z_HFTDIQ","LEAD_2025-12-25T204149484Z_EDTLYT","LEAD_2025-12-25T204138898Z_RWZOGD","LEAD_2025-12-25T191135691Z_3XBNDO","LEAD_2025-12-25T191125265Z_MDFQCB","LEAD_2025-12-25T191114705Z_1EMLUN","LEAD_2025-12-25T191104119Z_0PRENZ","LEAD_2025-12-25T191053824Z_1EMY2G","LEAD_2025-12-25T191043239Z_2GUQGY","LEAD_2025-12-25T190029962Z_MK0N5L","LEAD_2025-12-25T190019474Z_QPO1PP","LEAD_2025-12-25T190008673Z_J6WGQ7","LEAD_2025-12-25T185958232Z_TL9HI0","LEAD_2025-12-25T185947909Z_51TB7B","LEAD_2025-12-25T185937335Z_WVBB9C","LEAD_2025-12-25T185909045Z_B0RLKE","LEAD_2025-12-25T110812797Z_F4AKJJ","LEAD_2025-12-25T110806573Z_UZWPR7","LEAD_2025-12-25T110800010Z_GLN8TE","LEAD_2025-12-25T110753291Z_5LVK65","LEAD_2025-12-25T110747228Z_3ZH8MR","LEAD_2025-12-25T110740528Z_PJ2JAS","LEAD_2025-12-25T082713825Z_4BRLYS","LEAD_2025-12-25T081934276Z_BKRE1H","LEAD_2025-12-25T081929110Z_HONW32","LEAD_2025-12-25T081923493Z_RBMKJ3","LEAD_2025-12-25T081917580Z_WY85K2","LEAD_2025-12-25T081912413Z_EWJWFJ","LEAD_2025-12-25T081904985Z_YXKTV1","LEAD_2025-12-22T075325154Z_0FSCAC","LEAD_2025-12-22T075220985Z_RA98UA","LEAD_2025-12-22T074037336Z_A6PRYV","LEAD_2025-12-22T074026814Z_N6NYWS","LEAD_2025-12-22T074016420Z_CNFCRN","LEAD_2025-12-22T074005330Z_DZII12","LEAD_2025-12-22T073954606Z_AZ2NXW","LEAD_2025-12-22T073943463Z_VKX7SP","LEAD_2025-12-21T225832616Z_15B4MT","LEAD_2025-12-21T225632332Z_NCQS0S","LEAD_2025-12-21T225426679Z_FOJF8R","LEAD_2025-12-21T222542567Z_GINYUY","LEAD_2025-12-21T221615529Z_YCEMIR","LEAD_2025-12-21T221239376Z_1JXGFE","LEAD_2025-12-21T220926109Z_0NIBT3","LEAD_2025-12-21T220107841Z_U7VODT","LEAD_2025-12-21T215428385Z_PIDJ7A","LEAD_2025-12-21T215403514Z_Q7FEQO","LEAD_2025-12-21T215332077Z_MZGRVW","LEAD_2025-12-21T194424688Z_1OHRLH","LEAD_2025-12-21T194318487Z_GXDVLZ","LEAD_2025-12-21T194010151Z_V7T12E","LEAD_2025-12-21T194006055Z_JS7R1F","LEAD_2025-12-21T193328137Z_1YRV4T","LEAD_2025-12-21T192929893Z_F9QWRN","LEAD_2025-12-21T192649104Z_80UJ2Z","LEAD_2025-12-21T132228882Z_RU8VL9","LEAD_2025-12-21T125004976Z_JDYS7F","LEAD_2025-12-21T124957602Z_QO8HRV","LEAD_2025-12-21T124921945Z_Q072Y6"],a=e.slice(0,3);console.log(`Test leads to delete: ${a.length} (total available: ${e.length})`);let i=0,s=0;for(const l of a)try{console.log(`Deleting lead: ${l}`);const c=await o.env.DB.prepare("DELETE FROM contracts WHERE leadId = ?").bind(l).run();console.log(`  Contracts deleted: ${c.meta.changes}`);const d=await o.env.DB.prepare("DELETE FROM proforma WHERE leadId = ?").bind(l).run();console.log(`  Proforma deleted: ${d.meta.changes}`);const u=await o.env.DB.prepare("DELETE FROM dispositivi WHERE leadId = ?").bind(l).run();console.log(`  Dispositivi deleted: ${u.meta.changes}`);const p=await o.env.DB.prepare("DELETE FROM leads WHERE id = ?").bind(l).run();console.log(`  Lead deleted: ${p.meta.changes}`),p.meta.changes>0?i++:(console.log(`  WARNING: Lead ${l} not found in DB!`),s++)}catch(c){console.error(`Error deleting lead ${l}:`,c),s++}console.log(`‚úÖ Eliminati ${i} lead di test, ${s} non trovati`);const r=await o.env.DB.prepare("SELECT COUNT(*) as count FROM leads").first();return o.json({success:!0,deleted:i,remaining:(r==null?void 0:r.count)||0,message:`Eliminati ${i} lead di test. Rimangono ${(r==null?void 0:r.count)||0} lead dall'Excel (attesi 126).`})}catch(t){return console.error("‚ùå Errore pulizia:",t),o.json({success:!1,error:"Errore durante pulizia",details:t instanceof Error?t.message:String(t)},500)}});I.get("/api/admin/leads-dashboard",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!0,dashboard:{kpi:{leadsTotali:0,scoreMedio:0},analytics:{partners:[],channels:[]},modules:{conversion:0,reports:0}}});const e=await o.env.DB.prepare("SELECT COUNT(*) as count FROM leads").first(),a=(e==null?void 0:e.count)||0,s=(await o.env.DB.prepare(`
      SELECT COALESCE(fonte, 'Sconosciuto') as canale, COUNT(*) as count 
      FROM leads 
      GROUP BY fonte
      ORDER BY count DESC
    `).all()).results||[],r=await o.env.DB.prepare(`
      SELECT COUNT(DISTINCT fonte) as count FROM leads 
      WHERE fonte LIKE '%Partner%' OR fonte LIKE '%Affiliato%'
    `).first(),l=(r==null?void 0:r.count)||0,c=await o.env.DB.prepare(`
      SELECT COUNT(*) as count FROM leads 
      WHERE status IN ('CONTRATTO_FIRMATO', 'IN_ATTESA_PAGAMENTO', 'ATTIVO')
    `).first(),d=(c==null?void 0:c.count)||0;return o.json({success:!0,dashboard:{kpi:{leadsTotali:a,scoreMedio:7.2},analytics:{partners:Array(l).fill(null).map((u,p)=>({id:p+1})),channels:s},modules:{conversion:d,reports:a}}})}catch(e){return console.error("‚ùå Errore dashboard leads:",e),o.json({success:!1,error:"Errore recupero statistiche",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/admin/run-migrations",async o=>{try{if(!o.env.DB)return o.json({error:"Database non configurato"},500);console.log("üîß [MIGRATIONS] Inizio esecuzione migrations");const t=[];await o.env.DB.prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='contracts'").first()?t.push("‚ÑπÔ∏è Tabella contracts gi√† esistente"):(console.log("üìã [MIGRATIONS] Tabella contracts NON esiste. Creazione in corso..."),await o.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS contracts (
          id TEXT PRIMARY KEY,
          lead_id TEXT NOT NULL,
          contract_code TEXT UNIQUE NOT NULL,
          contract_type TEXT,
          nome_cliente TEXT,
          cognome_cliente TEXT,
          email_cliente TEXT,
          servizio TEXT,
          piano TEXT,
          dispositivo TEXT,
          prezzo_base REAL,
          prezzo_iva_inclusa REAL,
          contract_html TEXT,
          status TEXT DEFAULT 'PENDING',
          signature_data TEXT,
          signature_ip TEXT,
          signature_timestamp TEXT,
          signature_user_agent TEXT,
          signature_screen_resolution TEXT,
          signature_method TEXT DEFAULT 'inline',
          signed_at TEXT,
          created_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
      `).run(),t.push("‚úÖ Tabella contracts creata"),await o.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_contracts_lead_id ON contracts(lead_id)").run(),await o.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_contracts_status ON contracts(status)").run(),await o.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_contracts_code ON contracts(contract_code)").run(),t.push("‚úÖ Indici contracts creati")),await o.env.DB.prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='document_templates'").first()?t.push("‚ÑπÔ∏è Tabella document_templates gi√† esistente"):(console.log("üìã [MIGRATIONS] Tabella document_templates NON esiste. Creazione in corso..."),await o.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS document_templates (
          id TEXT PRIMARY KEY,
          name TEXT NOT NULL,
          type TEXT NOT NULL,
          subject TEXT,
          html_content TEXT NOT NULL,
          variables TEXT,
          category TEXT,
          active INTEGER DEFAULT 1,
          created_at TEXT DEFAULT CURRENT_TIMESTAMP,
          updated_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
      `).run(),t.push("‚úÖ Tabella document_templates creata"),await o.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_document_templates_type ON document_templates(type)").run(),await o.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_document_templates_category ON document_templates(category)").run(),await o.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_document_templates_active ON document_templates(active)").run(),t.push("‚úÖ Indici creati"),await o.env.DB.prepare(`
        INSERT INTO document_templates (id, name, type, subject, html_content, variables, category, active)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
      `).bind("email_notifica_info","Notifica Nuovo Lead","email","Nuovo Lead Ricevuto: {{NOME_CLIENTE}} {{COGNOME_CLIENTE}}","<!DOCTYPE html><html><body><h2>Nuovo Lead Ricevuto</h2><p><strong>Cliente:</strong> {{NOME_CLIENTE}} {{COGNOME_CLIENTE}}</p><p><strong>Email:</strong> {{EMAIL_CLIENTE}}</p><p><strong>Telefono:</strong> {{TELEFONO_CLIENTE}}</p><p><strong>Servizio:</strong> {{SERVIZIO_RICHIESTO}}</p><p><strong>ID Lead:</strong> {{LEAD_ID}}</p><p><strong>Data:</strong> {{TIMESTAMP_LEAD}}</p><p><strong>Note:</strong> {{NOTE}}</p></body></html>",'["NOME_CLIENTE","COGNOME_CLIENTE","EMAIL_CLIENTE","TELEFONO_CLIENTE","SERVIZIO_RICHIESTO","LEAD_ID","TIMESTAMP_LEAD","NOTE"]',"notification",1).run(),t.push("‚úÖ Template email_notifica_info inserito"),await o.env.DB.prepare(`
        INSERT INTO document_templates (id, name, type, subject, html_content, variables, category, active)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
      `).bind("email_invio_contratto","Invio Contratto","email","eCura - Il tuo contratto √® pronto","<!DOCTYPE html><html><body><h2>Ciao {{NOME_CLIENTE}},</h2><p>Il contratto per il servizio <strong>{{PIANO_SERVIZIO}}</strong> √® allegato a questa email.</p><p><strong>Importo:</strong> {{PREZZO_PIANO}}</p><p><strong>Codice Cliente:</strong> {{CODICE_CLIENTE}}</p><p>Cordiali saluti,<br>Team eCura</p></body></html>",'["NOME_CLIENTE","PIANO_SERVIZIO","PREZZO_PIANO","CODICE_CLIENTE"]',"contract",1).run(),t.push("‚úÖ Template email_invio_contratto inserito")),await o.env.DB.prepare("SELECT id FROM document_templates WHERE id = 'email_documenti_informativi'").first()?t.push("‚ÑπÔ∏è Template email_documenti_informativi gi√† esistente"):(console.log("üìß [MIGRATIONS] Template email_documenti_informativi mancante. Inserimento..."),await o.env.DB.prepare(`
        INSERT INTO document_templates (id, name, type, subject, html_content, variables, category, active, created_at, updated_at)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `).bind("email_documenti_informativi","Invio Documenti Informativi","email","eCura - Documentazione richiesta",'<!DOCTYPE html><html lang="it"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Documentazione eCura</title></head><body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;"><div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;"><h1 style="color: white; margin: 0; font-size: 28px;">Documentazione eCura</h1></div><div style="background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px;"><p style="font-size: 16px; margin-bottom: 20px;">Gentile <strong>{{NOME_CLIENTE}} {{COGNOME_CLIENTE}}</strong>,</p><p style="font-size: 16px; margin-bottom: 20px;">Come da Lei richiesto, alleghiamo la documentazione informativa relativa al servizio <strong>{{PIANO_SERVIZIO}}</strong>.</p><div style="background: white; border-left: 4px solid #667eea; padding: 15px; margin: 20px 0;"><p style="margin: 0; font-size: 14px; color: #666;"><strong>Documenti allegati:</strong><br>{{DOCUMENTI_ALLEGATI}}</p></div><p style="font-size: 16px; margin-bottom: 20px;">Per qualsiasi domanda o chiarimento, non esiti a contattarci.</p><p style="font-size: 16px; margin-bottom: 10px;">Cordiali saluti,<br><strong>Il Team eCura</strong></p></div><div style="text-align: center; padding: 20px; font-size: 12px; color: #666;"><p style="margin: 5px 0;">eCura by TeleMedCare</p><p style="margin: 5px 0;">info@telemedcare.it</p></div></body></html>','["NOME_CLIENTE", "COGNOME_CLIENTE", "PIANO_SERVIZIO", "DOCUMENTI_ALLEGATI"]',"informative",1,"2026-01-02 09:35:00","2026-01-02 09:35:00").run(),t.push("‚úÖ Template email_documenti_informativi inserito"));const s=await o.env.DB.prepare("SELECT id, name, category, created_at FROM document_templates ORDER BY created_at DESC").all();return console.log("‚úÖ [MIGRATIONS] Completate con successo!"),o.json({success:!0,message:"Migrations eseguite con successo",results:t,templates:s.results})}catch(t){return console.error("‚ùå [MIGRATIONS] Errore:",t),o.json({success:!1,error:"Errore durante esecuzione migrations",details:t instanceof Error?t.message:String(t)},500)}});I.post("/api/admin/add-signature-columns",async o=>{try{if(!o.env.DB)return o.json({error:"Database non configurato"},500);console.log("üîß [MIGRATION 0030] Aggiunta colonne firma digitale");const t=[];try{await o.env.DB.prepare("ALTER TABLE contracts ADD COLUMN signature_data TEXT").run(),t.push("‚úÖ Colonna signature_data aggiunta")}catch{t.push("‚ÑπÔ∏è Colonna signature_data gi√† esistente")}try{await o.env.DB.prepare("ALTER TABLE contracts ADD COLUMN signature_ip TEXT").run(),t.push("‚úÖ Colonna signature_ip aggiunta")}catch{t.push("‚ÑπÔ∏è Colonna signature_ip gi√† esistente")}try{await o.env.DB.prepare("ALTER TABLE contracts ADD COLUMN signature_timestamp TEXT").run(),t.push("‚úÖ Colonna signature_timestamp aggiunta")}catch{t.push("‚ÑπÔ∏è Colonna signature_timestamp gi√† esistente")}try{await o.env.DB.prepare("ALTER TABLE contracts ADD COLUMN signature_user_agent TEXT").run(),t.push("‚úÖ Colonna signature_user_agent aggiunta")}catch{t.push("‚ÑπÔ∏è Colonna signature_user_agent gi√† esistente")}try{await o.env.DB.prepare("ALTER TABLE contracts ADD COLUMN signature_screen_resolution TEXT").run(),t.push("‚úÖ Colonna signature_screen_resolution aggiunta")}catch{t.push("‚ÑπÔ∏è Colonna signature_screen_resolution gi√† esistente")}try{await o.env.DB.prepare("ALTER TABLE contracts ADD COLUMN signed_at TEXT").run(),t.push("‚úÖ Colonna signed_at aggiunta")}catch{t.push("‚ÑπÔ∏è Colonna signed_at gi√† esistente")}try{await o.env.DB.prepare("ALTER TABLE contracts ADD COLUMN signature_method TEXT DEFAULT 'inline'").run(),t.push("‚úÖ Colonna signature_method aggiunta")}catch{t.push("‚ÑπÔ∏è Colonna signature_method gi√† esistente")}try{await o.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_contracts_signed_at ON contracts(signed_at)").run(),t.push("‚úÖ Indice idx_contracts_signed_at creato")}catch{t.push("‚ö†Ô∏è Errore creazione indice idx_contracts_signed_at")}try{await o.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_contracts_signature_timestamp ON contracts(signature_timestamp)").run(),t.push("‚úÖ Indice idx_contracts_signature_timestamp creato")}catch{t.push("‚ö†Ô∏è Errore creazione indice idx_contracts_signature_timestamp")}return console.log("‚úÖ [MIGRATION 0030] Completata"),o.json({success:!0,message:"Migration 0030 completata",results:t})}catch(t){return console.error("‚ùå [MIGRATION 0030] Errore:",t),o.json({success:!1,error:"Errore durante migration 0030",details:t instanceof Error?t.message:String(t)},500)}});I.post("/api/admin/test-email",async o=>{try{const{to:t}=await o.req.json().catch(()=>({to:"rpoggi55@gmail.com"}));console.log(`üìß [TEST EMAIL] Invio email di test a: ${t}`);const a=await new Ke(o.env).sendEmail({to:t,from:"info@telemedcare.it",subject:"üß™ Test Email - TeleMedCare",html:`
        <h1>Test Email</h1>
        <p>Questa √® un'email di test inviata da TeleMedCare il ${new Date().toISOString()}</p>
        <p><strong>API Keys disponibili:</strong></p>
        <ul>
          <li>SENDGRID_API_KEY: ${o.env.SENDGRID_API_KEY?"‚úÖ Configurata":"‚ùå Mancante"}</li>
          <li>RESEND_API_KEY: ${o.env.RESEND_API_KEY?"‚úÖ Configurata":"‚ùå Mancante (usando fallback)"}</li>
        </ul>
      `,text:"Test email"});return o.json({success:a.success,messageId:a.messageId,timestamp:a.timestamp,error:a.error,config:{sendgrid:o.env.SENDGRID_API_KEY?"configured":"missing",resend:o.env.RESEND_API_KEY?"configured":"fallback"}})}catch(t){return console.error("‚ùå [TEST EMAIL] Errore:",t),o.json({success:!1,error:t instanceof Error?t.message:String(t)},500)}});I.post("/api/admin/update-template",async o=>{var t;try{const{templateId:e,htmlContent:a}=await o.req.json();if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);if(!e||!a)return o.json({success:!1,error:"templateId e htmlContent richiesti"},400);console.log(`üìù Aggiornamento template: ${e} (${a.length} chars)`);const i=await o.env.DB.prepare(`
      UPDATE document_templates 
      SET html_content = ?,
          updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(a,e).run();return console.log(`‚úÖ Template ${e} aggiornato (changes: ${i.meta.changes})`),o.json({success:!0,templateId:e,updated:!0,changes:i.meta.changes})}catch(e){return console.error("‚ùå Errore aggiornamento template:",e),o.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.post("/api/admin/fix-fonte-irbema",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);console.log("üîß Correzione fonte: HUBSPOT ‚Üí IRBEMA");const e=await o.env.DB.prepare(`
      UPDATE leads 
      SET fonte = 'IRBEMA'
      WHERE (fonte = 'HUBSPOT' OR fonte LIKE 'HubSpot%' OR fonte IS NULL OR fonte = '')
        AND id LIKE 'LEAD-IRBEMA-%'
    `).run();return console.log(`‚úÖ Fonte aggiornata per ${e.meta.changes} lead`),o.json({success:!0,message:"Fonte aggiornata da HUBSPOT a IRBEMA",leadsUpdated:e.meta.changes})}catch(e){return console.error("‚ùå Errore correzione fonte:",e),o.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.post("/api/admin/normalize-settings-values",async o=>{var t,e,a;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);console.log("üîß Normalizzazione valori settings: 1/0 ‚Üí true/false");const i=await o.env.DB.prepare(`
      UPDATE settings SET value = 'true' WHERE value IN ('1', 1)
    `).run(),s=await o.env.DB.prepare(`
      UPDATE settings SET value = 'false' WHERE value IN ('0', 0)
    `).run(),r=(((e=i.meta)==null?void 0:e.changes)||0)+(((a=s.meta)==null?void 0:a.changes)||0);return console.log(`‚úÖ Normalizzati ${r} valori`),o.json({success:!0,message:"Valori settings normalizzati a true/false",settingsUpdated:r})}catch(i){return console.error("‚ùå Errore conversione settings:",i),o.json({success:!1,error:i instanceof Error?i.message:String(i)},500)}});I.post("/api/admin/init-settings",async o=>{var t,e,a;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);console.log("üîß Inizializzazione settings switch dashboard");const i=await o.env.DB.prepare(`
      INSERT OR IGNORE INTO settings (key, value, description, updated_at) VALUES 
        ('hubspot_auto_import_enabled', 'false', 'Abilita import automatico da HubSpot', datetime('now')),
        ('lead_email_notifications_enabled', 'false', 'Abilita invio email automatiche ai lead', datetime('now')),
        ('admin_email_notifications_enabled', 'true', 'Abilita notifiche email a info@telemedcare.it', datetime('now'))
    `).run();return console.log(`‚úÖ Settings inizializzati (changes: ${((e=i.meta)==null?void 0:e.changes)||0})`),o.json({success:!0,message:"Settings inizializzati correttamente",settingsAdded:((a=i.meta)==null?void 0:a.changes)||0})}catch(i){return console.error("‚ùå Errore inizializzazione settings:",i),o.json({success:!1,error:i instanceof Error?i.message:String(i)},500)}});I.post("/api/admin/update-template/:templateId",async o=>{var t;try{const e=o.req.param("templateId"),{html_content:a}=await o.req.json();if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);if(!a)return o.json({success:!1,error:"html_content richiesto"},400);console.log(`üìù Aggiornamento template: ${e} (${a.length} chars)`);const i=await o.env.DB.prepare(`
      UPDATE document_templates 
      SET html_content = ?,
          updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(a,e).run();return console.log(`‚úÖ Template ${e} aggiornato`),o.json({success:!0,templateId:e,updated:!0,changes:i.meta.changes})}catch(e){return console.error("‚ùå Errore aggiornamento template:",e),o.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.get("/api/admin/debug-env",async o=>{try{return o.json({environment:o.env.ENVIRONMENT||"not set",hasDB:!!o.env.DB,hasResendKey:!!o.env.RESEND_API_KEY,hasSendgridKey:!!o.env.SENDGRID_API_KEY,resendKeyPreview:o.env.RESEND_API_KEY?`${o.env.RESEND_API_KEY.substring(0,15)}...`:"NOT SET",sendgridKeyPreview:o.env.SENDGRID_API_KEY?`${o.env.SENDGRID_API_KEY.substring(0,15)}...`:"NOT SET",allEnvKeys:Object.keys(o.env||{}).filter(t=>!t.includes("SECRET")&&!t.includes("KEY"))})}catch(t){return o.json({error:t instanceof Error?t.message:String(t)},500)}});I.get("/api/admin/debug-resend",async o=>{try{const t=o.env.RESEND_API_KEY||"re_QeeK2km4_94B4bM3sGq2KhDBf2gi624d2";console.log("üîç [DEBUG RESEND] Testing Resend API..."),console.log("üîë API Key presente:",t?"SI":"NO"),console.log("üîë API Key preview:",t?`${t.substring(0,10)}...`:"NONE");const e={from:"TeleMedCare <info@telemedcare.it>",to:["rpoggi55@gmail.com"],subject:"üîç Debug Test - Resend diretto da Cloudflare",html:`
        <h1>Debug Test</h1>
        <p>Questa email √® stata inviata direttamente da Cloudflare Workers usando Resend.</p>
        <p><strong>Timestamp:</strong> ${new Date().toISOString()}</p>
        <p><strong>API Key usata:</strong> ${t.substring(0,15)}...</p>
        <p><strong>Environment:</strong> ${o.env.ENVIRONMENT||"production"}</p>
      `};console.log("üì§ [DEBUG RESEND] Sending request to Resend API...");const a=await fetch("https://api.resend.com/emails",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(e)}),i=await a.text();if(console.log("üì• [DEBUG RESEND] Response status:",a.status),console.log("üì• [DEBUG RESEND] Response body:",i),!a.ok)return o.json({success:!1,status:a.status,error:i,apiKey:`${t.substring(0,15)}...`,message:"Resend API returned error"},a.status);const s=JSON.parse(i);return o.json({success:!0,messageId:s.id,status:a.status,apiKey:`${t.substring(0,15)}...`,message:"Email inviata con successo! Controlla rpoggi55@gmail.com"})}catch(t){return console.error("‚ùå [DEBUG RESEND] Errore:",t),o.json({success:!1,error:t instanceof Error?t.message:String(t),stack:t instanceof Error?t.stack:void 0},500)}});I.post("/api/admin/reset-and-regenerate",async o=>{var t,e;try{if(!o.env.DB)return o.json({error:"Database non configurato"},400);console.log("üîÑ INIZIO RESET COMPLETO SISTEMA"),await o.env.DB.prepare("PRAGMA foreign_keys = OFF").run();try{await o.env.DB.prepare("DELETE FROM proforma").run()}catch(d){console.log("Tabella proforma:",d.message)}try{await o.env.DB.prepare("DELETE FROM contracts").run()}catch(d){console.log("Tabella contracts:",d.message)}try{await o.env.DB.prepare("DELETE FROM dispositivi").run()}catch(d){console.log("Tabella dispositivi:",d.message)}try{await o.env.DB.prepare("DELETE FROM leads").run()}catch(d){console.log("Tabella leads:",d.message)}try{await o.env.DB.prepare("DELETE FROM document_repository").run()}catch(d){console.log("Tabella document_repository:",d.message)}await o.env.DB.prepare("PRAGMA foreign_keys = ON").run(),console.log("‚úÖ Tutti i dati cancellati");const a=["TeleAssistenza Base","TeleAssistenza Premium","TeleAssistenza Pro"],i=["Alta urgenza","Media urgenza","Bassa urgenza"];for(let d=1;d<=10;d++){const u=`LEAD_TEST_${Date.now()}_${d}`;await o.env.DB.prepare(`
        INSERT INTO leads (
          id, nomeRichiedente, cognomeRichiedente, emailRichiedente, telefonoRichiedente,
          nomeAssistito, cognomeAssistito, dataNascitaAssistito, pacchetto, priority,
          vuoleBrochure, vuoleManuale, vuoleContratto, created_at, updated_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'), datetime('now'))
      `).bind(u,`Cliente${d}`,`Test${d}`,`cliente${d}@telemedcare.test`,`+39 320 123 ${String(d).padStart(4,"0")}`,`Assistito${d}`,`Test${d}`,`1970-01-0${d%9+1}`,a[d%a.length],i[d%i.length],d%2===0?"Si":"No",d%3===0?"Si":"No",d<=6?"Si":"No").run()}console.log("‚úÖ 10 leads creati");const s=await o.env.DB.prepare('SELECT id FROM leads WHERE vuoleContratto = "Si" ORDER BY created_at DESC LIMIT 6').all();for(let d=1;d<=6;d++){const u=((t=s.results[d-1])==null?void 0:t.id)||`LEAD_TEST_${Date.now()}_${d}`;await o.env.DB.prepare(`
        INSERT INTO contracts (id, leadId, contractType, status, pdfGenerated, created_at)
        VALUES (?, ?, ?, ?, ?, datetime('now'))
      `).bind(`CONTRACT-TEST-00${d}`,u,"TeleMedCare Standard",d<=4?"SIGNED":"PENDING",!0).run()}console.log("‚úÖ 6 contratti creati (4 firmati, 2 pending)");const r=await o.env.DB.prepare('SELECT id FROM leads WHERE vuoleContratto = "Si" ORDER BY created_at DESC LIMIT 4').all();for(let d=1;d<=4;d++){const u=((e=r.results[d-1])==null?void 0:e.id)||`LEAD_TEST_${Date.now()}_${d}`;await o.env.DB.prepare(`
        INSERT INTO proforma (
          id, leadId, numero_proforma, data_emissione, data_scadenza,
          cliente_nome, cliente_cognome, cliente_email, 
          pacchetto_tipo, prezzo_mensile, prezzo_totale, status, created_at
        ) VALUES (?, ?, ?, DATE('now'), DATE('now', '+30 days'), ?, ?, ?, ?, ?, ?, ?, datetime('now'))
      `).bind(`PROF-TEST-00${d}`,u,`PROF-2024-10-${String(d).padStart(3,"0")}`,`Cliente${d}`,`Test${d}`,`cliente${d}@telemedcare.test`,"BASE",29.99,359.88,d<=3?"GENERATED":"DRAFT").run()}console.log("‚úÖ 4 proforma create (3 generate, 1 bozza)");for(let d=1;d<=2;d++)await o.env.DB.prepare(`
        UPDATE proforma SET 
          pagamento_ricevuto = TRUE,
          data_pagamento = datetime('now'),
          modalita_pagamento = 'credit_card',
          importo_pagato = prezzo_totale,
          status = 'ACCEPTED'
        WHERE id = ?
      `).bind(`PROF-TEST-00${d}`).run();console.log("‚úÖ 2 proforma aggiornate come pagate (completate)");const l=["INVENTORY","INVENTORY","INVENTORY","INVENTORY","INVENTORY","INVENTORY","ASSIGNED","SHIPPED","DELIVERED","ACTIVE"];for(let d=1;d<=10;d++)await o.env.DB.prepare(`
        INSERT INTO dispositivi (device_id, imei, model, status, created_at)
        VALUES (?, ?, ?, ?, datetime('now'))
      `).bind(`DM-202410${String(d).padStart(2,"0")}`,`86012345678901${String(d).padStart(2,"0")}`,`SiDLY Care Pro V12.0 #${d}`,l[d-1]).run();console.log("‚úÖ 10 dispositivi creati (6 inventory, 1 assigned, 1 shipped, 1 delivered, 1 active)");const c=[{id:"brochure_sidly_care_pro",name:"Brochure SiDLY Care Pro",type:"BROCHURE",deviceModel:"sidly-care-pro",description:"Brochure commerciale del dispositivo SiDLY Care Pro con specifiche tecniche e funzionalit√†",url:"/docs/brochure-sidly-care-pro.pdf",fileSize:"2.5 MB",language:"it",version:"2024.1",created_at:"2024-10-01 09:00:00"},{id:"manuale_sidly_care_pro",name:"Manuale Utente SiDLY Care Pro",type:"USER_MANUAL",deviceModel:"sidly-care-pro",description:"Manuale completo per utilizzo del dispositivo SiDLY Care Pro",url:"/docs/manuale-sidly-care-pro.pdf",fileSize:"8.2 MB",language:"it",version:"11.0",created_at:"2024-10-01 10:00:00"},{id:"manuale_telemedcare_base",name:"Manuale TeleMedCare Base",type:"SERVICE_MANUAL",deviceModel:"telemedcare-base",description:"Manuale del servizio TeleMedCare Base con procedure operative",url:"/docs/manuale-telemedcare-base.pdf",fileSize:"4.1 MB",language:"it",version:"11.0",created_at:"2024-10-01 11:00:00"},{id:"manuale_telemedcare_avanzato",name:"Manuale TeleMedCare Avanzato",type:"SERVICE_MANUAL",deviceModel:"telemedcare-avanzato",description:"Manuale del servizio TeleMedCare Avanzato con centrale operativa H24",url:"/docs/manuale-telemedcare-avanzato.pdf",fileSize:"6.3 MB",language:"it",version:"11.0",created_at:"2024-10-01 12:00:00"},{id:"certificazione_dm_sidly",name:"Certificazione Dispositivo Medico SiDLY",type:"CERTIFICATION",deviceModel:"sidly-care-pro",description:"Certificazione DM Classe IIA per SiDLY Care Pro (CDN Z12040199)",url:"/docs/certificazione-dm-sidly.pdf",fileSize:"1.8 MB",language:"it",version:"2024",created_at:"2024-10-01 13:00:00"}];try{await o.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS document_repository (
          id TEXT PRIMARY KEY,
          name TEXT NOT NULL,
          type TEXT NOT NULL,
          deviceModel TEXT,
          description TEXT,
          url TEXT NOT NULL,
          fileSize TEXT,
          language TEXT,
          version TEXT,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
      `).run();for(const d of c)await o.env.DB.prepare(`
          INSERT OR REPLACE INTO document_repository 
          (id, name, type, deviceModel, description, url, fileSize, language, version, created_at)
          VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(d.id,d.name,d.type,d.deviceModel,d.description,d.url,d.fileSize,d.language,d.version,d.created_at).run();console.log("‚úÖ 5 documenti TeleMedCare caricati nel repository")}catch(d){console.log("‚ö†Ô∏è Document repository non disponibile:",d.message)}return console.log("üéâ RESET COMPLETO - DATI COERENTI RICREATI"),console.log("üìä Riepilogo SISTEMA COMPLETO:"),console.log("   DATI: 10 leads ‚Üí 6 contratti ‚Üí 4 firmati ‚Üí 4 proforma ‚Üí 2 pagate"),console.log("   DISPOSITIVI: 10 totali (6 inventory, 1 assigned, 1 shipped, 1 delivered, 1 active)"),console.log("   DOCUMENTI: 5 nel repository (brochure, manuali, certificazioni)"),console.log("   LOGICA COERENTE: leads ‚â• contratti ‚â• firmati = proforma ‚â• pagamenti"),o.json({success:!0,message:"Sistema resettato con dati PERFETTAMENTE coerenti",summary:{leads:10,contracts:{total:6,signed:4,pending:2},proforma:{total:4,issued:3,draft:1},proforma_paid:{total:2,paid:2,pending:2},devices:{total:10,inventory:6,assigned:1,shipped:1,delivered:1,active:1},documents:{total:5,types:["BROCHURE","USER_MANUAL","SERVICE_MANUAL","CERTIFICATION"]}},logic:"leads(10) ‚â• contracts(6) ‚â• signed(4) = proforma(4) ‚â• paid(2) + docs(5)"})}catch(a){return console.error("‚ùå Errore durante reset sistema:",a),o.json({success:!1,error:"Errore durante reset sistema: "+a.message},500)}});I.post("/api/admin/clear-database",async o=>{try{if(!o.env.DB)return o.json({error:"Database non configurato"},400);console.log("üîÑ INIZIO PULIZIA COMPLETA DATABASE"),await o.env.DB.prepare("PRAGMA foreign_keys = OFF").run();let t={proforma:0,contracts:0,dispositivi:0,leads:0,document_repository:0};try{const e=await o.env.DB.prepare("DELETE FROM proforma").run();t.proforma=e.meta.changes,console.log(`‚úÖ Proforma cancellate: ${e.meta.changes}`)}catch(e){console.log("‚ö†Ô∏è Tabella proforma:",e.message)}try{const e=await o.env.DB.prepare("DELETE FROM contracts").run();t.contracts=e.meta.changes,console.log(`‚úÖ Contratti cancellati: ${e.meta.changes}`)}catch(e){console.log("‚ö†Ô∏è Tabella contracts:",e.message)}try{const e=await o.env.DB.prepare("DELETE FROM dispositivi").run();t.dispositivi=e.meta.changes,console.log(`‚úÖ Dispositivi cancellati: ${e.meta.changes}`)}catch(e){console.log("‚ö†Ô∏è Tabella dispositivi:",e.message)}try{const e=await o.env.DB.prepare("DELETE FROM leads").run();t.leads=e.meta.changes,console.log(`‚úÖ Lead cancellati: ${e.meta.changes}`)}catch(e){console.log("‚ö†Ô∏è Tabella leads:",e.message)}try{const e=await o.env.DB.prepare("DELETE FROM document_repository").run();t.document_repository=e.meta.changes,console.log(`‚úÖ Documenti cancellati: ${e.meta.changes}`)}catch(e){console.log("‚ö†Ô∏è Tabella document_repository:",e.message)}return await o.env.DB.prepare("PRAGMA foreign_keys = ON").run(),console.log("‚úÖ DATABASE COMPLETAMENTE PULITO - Pronto per import Excel"),o.json({success:!0,message:"Database pulito con successo. Pronto per importare 126 lead dall'Excel.",deleted:t,total:Object.values(t).reduce((e,a)=>e+a,0)})}catch(t){return console.error("‚ùå Errore durante pulizia database:",t),o.json({success:!1,error:"Errore durante pulizia database: "+t.message},500)}});I.get("/api/leads",async o=>{var t,e;try{if(!o.env.DB)return o.json({success:!1,error:"Database D1 non configurato - modalit√† development"},400);const a=o.req.query("limit")||"100",i=await o.env.DB.prepare("SELECT COUNT(*) as total FROM leads").first(),s=(i==null?void 0:i.total)||0,r=await o.env.DB.prepare("SELECT * FROM leads ORDER BY timestamp DESC LIMIT ?").bind(parseInt(a)).all();return console.log("üìä Leads recuperati:",((t=r.results)==null?void 0:t.length)||0,"di",s,"totali"),o.json({success:!0,total:s,count:((e=r.results)==null?void 0:e.length)||0,leads:r.results||[]})}catch(a){return console.error("‚ùå Errore recupero leads:",a),o.json({success:!1,error:"Errore recupero dati"},500)}});I.post("/api/leads/import-bulk",async o=>{try{if(!o.env.DB)return o.json({success:!1,error:"Database D1 non configurato"},400);const t=await o.req.json(),{leads:e}=t;if(!e||!Array.isArray(e))return o.json({success:!1,error:'Payload invalido: array "leads" richiesto'},400);console.log(`üöÄ Import bulk: ${e.length} lead...`);let a=0,i=0;const s=[];for(let r=0;r<e.length;r+=20){const l=e.slice(r,r+20);for(const c of l)try{const{id:d,nomeRichiedente:u,cognomeRichiedente:p,email:g,telefono:m,fonte:v,tipoServizio:b,status:E,note:T,created_at:R}=c;await o.env.DB.prepare(`
            INSERT INTO leads (
              id, nomeRichiedente, cognomeRichiedente, email, telefono,
              fonte, tipoServizio, status, note,
              created_at, updated_at, timestamp
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          `).bind(d,u||"",p||"",g||"",m||"",v||"EXCEL_IMPORT",b||"eCura PRO",E||"NEW",T||"",R||new Date().toISOString(),R||new Date().toISOString(),R||new Date().toISOString()).run(),a++}catch(d){i++,s.push({lead:c.id,error:d.message})}}return console.log(`‚úÖ Import completato: ${a} successi, ${i} errori`),o.json({success:!0,imported:a,errors:i,errorDetails:s})}catch(t){return console.error("‚ùå Errore import bulk:",t),o.json({success:!1,error:t.message||"Errore import bulk"},500)}});I.post("/api/leads/clean-import",async o=>{try{const{DB:t}=o.env;if(!t)return o.json({success:!1,error:"Database D1 non configurato"},400);console.log("üîÑ CLEAN IMPORT: Inizio cancellazione e reimport da Excel..."),console.log("üóëÔ∏è  Step 1: Cancellazione lead esistenti...");const e=await t.prepare("DELETE FROM leads").run();console.log(`‚úÖ Cancellati ${e.changes||0} lead esistenti`);const i=(await o.req.json()).leads||[];if(!Array.isArray(i)||i.length===0)return o.json({success:!1,error:'Nessun lead fornito nel body. Usa { "leads": [...] }'},400);console.log(`üì• Step 2: Import di ${i.length} lead dall'Excel...`);let s=0,r=0;const l=[];for(let c=0;c<i.length;c+=20){const d=i.slice(c,c+20);for(const u of d)try{const p=(u.nome||"").split(" "),g=p[0]||"",m=p.slice(1).join(" ")||"";await t.prepare(`
            INSERT INTO leads (
              id, nomeRichiedente, cognomeRichiedente, email, telefono, 
              fonte, tipoServizio, status, note, 
              created_at, updated_at, timestamp
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          `).bind(u.id,g,m,u.email||"",u.telefono||"",u.canale||"IRBEMA","eCura PRO",u.status||"NEW",u.note||"",u.data_arrivo,u.data_arrivo,new Date(u.data_arrivo).getTime()).run(),s++}catch(p){console.error(`‚ùå Errore import lead ${u.id}:`,p.message),r++,l.push({id:u.id,nome:u.nome,error:p.message})}}return console.log(`‚úÖ CLEAN IMPORT completato: ${s} importati, ${r} errori`),o.json({success:!0,message:"Clean import completato",deleted:e.changes||0,imported:s,errors:r,errorDetails:l,total:i.length})}catch(t){return console.error("‚ùå Errore clean import:",t),o.json({success:!1,error:t.message||"Errore clean import"},500)}});I.post("/api/leads/import/:channel",async o=>{try{const t=o.req.param("channel");return o.json({success:!0,message:`Import da ${t} completato`,count:0,total:0,note:"Funzionalit√† di import automatico in fase di sviluppo. Utilizzare import manuale da Excel."})}catch(t){return console.error("‚ùå Errore import canale:",t),o.json({success:!1,error:t.message||"Errore import da canale"},500)}});I.post("/api/leads/clean-import-from-excel",async o=>{try{if(!o.env.DB)return o.json({success:!1,error:"Database D1 non configurato"},400);console.log("üóëÔ∏è Inizio cancellazione e reimport lead da Excel..."),console.log("üóëÔ∏è FASE 1: Cancellazione lead esistenti..."),await o.env.DB.prepare("DELETE FROM leads").run(),console.log("‚úÖ Tutti i lead esistenti sono stati cancellati"),console.log("üì• FASE 2: Import lead da Excel...");const t=await Promise.resolve().then(()=>Bw),e=t.default.leads||t.leads||[];console.log(`üìä Trovati ${e.length} lead da importare`);let a=0,i=0;const s=[];for(let r=0;r<e.length;r+=20){const l=e.slice(r,r+20);for(const c of l)try{await o.env.DB.prepare(`
            INSERT INTO leads (
              id, nomeRichiedente, cognomeRichiedente, email, telefono,
              fonte, canale, tipoServizio, status, note,
              created_at, updated_at, timestamp
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          `).bind(c.id,c.nomeRichiedente||"",c.cognomeRichiedente||"",c.email||"",c.telefono||"",c.fonte||c.canale||"IRBEMA",c.canale||"IRBEMA",c.tipoServizio||"eCura PRO",c.status||"NEW",c.note||"",c.created_at,c.created_at,c.timestamp||c.created_at).run(),a++,a%20===0&&console.log(`üìä Importati ${a}/${e.length} lead...`)}catch(d){i++,s.push({lead:c.id,error:d.message}),console.error(`‚ùå Errore import lead ${c.id}:`,d.message)}}return console.log(`‚úÖ Import completato: ${a} importati, ${i} errori`),o.json({success:!0,imported:a,errors:i,errorDetails:s,message:`Import completato: ${a} lead importati dall'Excel con ID corretti`})}catch(t){return console.error("‚ùå Errore clean import:",t),o.json({success:!1,error:t.message||"Errore durante il clean import"},500)}});I.post("/api/leads/standardize-ids",async o=>{try{if(!o.env.DB)return o.json({success:!1,error:"Database D1 non configurato"},400);console.log("üîß Inizio standardizzazione ID lead...");const e=(await o.env.DB.prepare(`
      SELECT * FROM leads 
      ORDER BY 
        COALESCE(created_at, timestamp, updated_at) ASC,
        id ASC
    `).all()).results||[];console.log(`üìä Trovati ${e.length} lead da processare (ordinati per data di arrivo)`);const a={};for(const l of e){let c="WEB";const d=(l.id||"").toString().toUpperCase(),u=(l.fonte||"").toLowerCase(),p=`${l.nomeRichiedente||""} ${l.cognomeRichiedente||""}`.trim().toLowerCase();d.includes("IRBEMA")||u.includes("irbema")?c="IRBEMA":d.includes("EXCEL")||u.includes("excel")?c="EXCEL":d.includes("AON")||u.includes("aon")?c="AON":d.includes("DOUBLEYOU")||u.includes("doubleyou")||u.includes("double you")?c="DOUBLEYOU":p.includes("francesca grati")?c="WEB":p.includes("laura calvi")&&(c="NETWORKING"),a[c]||(a[c]=[]),a[c].push({...l,canale:c})}console.log("üìä Distribuzione per canale:"),Object.entries(a).forEach(([l,c])=>{console.log(`  - ${l}: ${c.length} lead`),c.length>0&&(console.log(`    Primi 5 lead di ${l}:`),c.slice(0,5).forEach((d,u)=>{const p=`${d.nomeRichiedente||""} ${d.cognomeRichiedente||""}`.trim(),g=d.created_at||d.timestamp||"NO DATA";console.log(`      ${u+1}. ${p} - ${g}`)}))});let i=0,s=0;const r={};for(const[l,c]of Object.entries(a)){console.log(`\\nüîß Processando canale ${l} (${c.length} lead)...`);for(let d=0;d<c.length;d++){const u=c[d],p=d+1,g=String(p).padStart(5,"0"),m=`LEAD-${l}-${g}`,v=(u.id||"").toString().toUpperCase();try{if(v===m){console.log(`‚è≠Ô∏è  Saltato (gi√† corretto): ${m}`),s++;continue}await o.env.DB.prepare(`
            UPDATE leads 
            SET id = ?, fonte = ?
            WHERE id = ?
          `).bind(m,l,u.id).run();const b=`${u.nomeRichiedente||""} ${u.cognomeRichiedente||""}`.trim();b.toLowerCase().includes("caterina")&&b.toLowerCase().includes("alterio")&&(console.log("üîç CATERINA D'ALTERIO TROVATA:"),console.log(`   Vecchio ID: ${u.id}`),console.log(`   Nuovo ID: ${m}`),console.log(`   Data: ${u.created_at||u.timestamp}`),console.log(`   Posizione: ${p}/${c.length}`)),console.log(`‚úÖ ${p}/${c.length} - Rinominato: ${u.id} -> ${m}`),i++}catch(b){console.error(`‚ùå Errore rinominando lead ${u.id}:`,b.message),s++}}r[l]=c.length}return console.log(`‚úÖ Standardizzazione completata: ${i} aggiornati, ${s} saltati`),o.json({success:!0,updated:i,skipped:s,channelCounters:r,message:`Standardizzazione completata: ${i} lead rinominati`})}catch(t){return console.error("‚ùå Errore standardizzazione ID:",t),o.json({success:!1,error:t.message||"Errore standardizzazione ID"},500)}});I.post("/api/leads/cleanup-family-duplicates",async o=>{try{if(!o.env.DB)return o.json({success:!1,error:"Database D1 non configurato"},400);console.log("üóëÔ∏è Pulizia duplicati familiari...");const t=await o.env.DB.prepare(`
      DELETE FROM leads WHERE id IN (
        'LEAD-EXCEL-018',
        'LEAD-EXCEL-031',
        'LEAD-EXCEL-028'
      )
    `).run();console.log(`‚úÖ Eliminati ${t.meta.changes} lead duplicati`);const e=await o.env.DB.prepare(`
      UPDATE leads 
      SET email = 'elenasaglia@hotmail.com',
          note = 'Lead creato da contratto PDF | TeleAssistenza Avanzato SIDLY | Data contratto: 08.05.2025 | Assistita: Elena Saglia (figlia) | Email contatto: elenasaglia@hotmail.com | Servizio: eCura PRO | Piano: AVANZATO | Dispositivo: SiDLY CARE PRO',
          updated_at = ?
      WHERE id = 'LEAD-CONTRATTO-003'
    `).bind(new Date().toISOString()).run();console.log("‚úÖ Aggiornato lead Eileen King");const a=await o.env.DB.prepare("SELECT COUNT(*) as total FROM leads").first();return o.json({success:!0,deleted:t.meta.changes,updated:e.meta.changes,totalLeads:(a==null?void 0:a.total)||0,message:"Pulizia duplicati completata con successo"})}catch(t){return console.error("‚ùå Errore pulizia duplicati:",t),o.json({success:!1,error:t.message||"Errore pulizia duplicati"},500)}});I.post("/api/leads/remove-assistiti-diretti",async o=>{try{if(!o.env.DB)return o.json({success:!1,error:"Database D1 non configurato"},400);console.log("üóëÔ∏è Rimozione 3 assistiti diretti...");const t=await o.env.DB.prepare(`
      DELETE FROM contracts WHERE id IN (
        'CONTRACT-BALZAROTTI-001',
        'CONTRACT-CAPONE-001',
        'CONTRACT-COZZI-001'
      )
    `).run();console.log(`‚úÖ Contratti eliminati: ${t.meta.changes}`);const e=await o.env.DB.prepare(`
      DELETE FROM leads WHERE id IN (
        'LEAD-ASSISTITO-001',
        'LEAD-ASSISTITO-002',
        'LEAD-ASSISTITO-003'
      )
    `).run();console.log(`‚úÖ Lead eliminati: ${e.meta.changes}`);const a=await o.env.DB.prepare("SELECT COUNT(*) as total FROM leads").first(),i=await o.env.DB.prepare("SELECT COUNT(*) as total FROM contracts").first();return o.json({success:!0,contractsDeleted:t.meta.changes,leadsDeleted:e.meta.changes,totalLeads:(a==null?void 0:a.total)||0,totalContracts:(i==null?void 0:i.total)||0,message:"Assistiti diretti rimossi - ora abbiamo 126 lead"})}catch(t){return console.error("‚ùå Errore rimozione assistiti:",t),o.json({success:!1,error:t.message||"Errore rimozione assistiti"},500)}});I.get("/api/contratti",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database D1 non configurato"},500);const e=await o.env.DB.prepare(`
      SELECT 
        c.id,
        c.codice_contratto as codice,
        c.tipo_contratto as tipo,
        c.status,
        c.piano,
        c.servizio,
        c.data_invio,
        c.prezzo_totale,
        c.created_at,
        l.nomeRichiedente,
        l.cognomeRichiedente,
        l.email,
        s.timestamp_firma as data_firma
      FROM contracts c
      LEFT JOIN leads l ON c.leadId = l.id 
      LEFT JOIN signatures s ON c.id = s.contract_id
      ORDER BY c.created_at DESC LIMIT 100
    `).all();return o.json({success:!0,count:e.results.length,contratti:e.results.map(a=>({...a,cliente_nome:`${a.nomeRichiedente} ${a.cognomeRichiedente}`,data_firma:a.data_firma||null,status_italiano:a.status==="SIGNED"?"Firmato":a.status==="SENT"?"Inviato":a.status==="DRAFT"?"Bozza":"In attesa"}))})}catch(e){return console.error("‚ùå Errore recupero contratti:",e),o.json({success:!1,error:"Errore recupero contratti"},500)}});I.delete("/api/setup-real-contracts",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const e=o.env.DB,a=["CTR-KING-2025","CTR-BALZAROTTI-2025","CTR-PIZZUTTO-G-2025","CTR-PENNACCHIO-2025","CTR-COZZI-2025","CTR-POGGI-2025","CTR-DANDRAIA-2025","CTR-DESTRO-2025","CTR-CAPONE-2025"];let i=0;for(const s of a){const r=await e.prepare("SELECT id FROM contracts WHERE codice_contratto = ?").bind(s).first();r&&(await e.prepare("DELETE FROM signatures WHERE contract_id = ?").bind(r.id).run(),await e.prepare("DELETE FROM contracts WHERE id = ?").bind(r.id).run(),i++,console.log(`Rimosso contratto ${s}`))}return o.json({success:!0,message:`Rimossi ${i} contratti`,removed:i})}catch(e){return console.error("Errore rimozione contratti:",e),o.json({success:!1,error:"Errore durante la rimozione dei contratti",details:e.message},500)}});I.post("/api/setup-real-contracts",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const e=[{codice:"CTR-KING-2025",email_caregiver:"elenasaglia@hotmail.com",intestatario_nome:"Eileen",intestatario_cognome:"King",assistito_nome:"Eileen",assistito_cognome:"King",tipo:"AVANZATO",piano:"AVANZATO",servizio:"PRO",prezzo:840,data_invio:"2025-05-08",data_firma:"2025-05-10",status:"SIGNED",pdf:"/contratti/08.05.2025_Contratto Medica GB_TeleAssistenza Avanzato SIDLY FIRMATO_Eileen King.pdf",note:"Assistito: Eileen King - Caregiver: Elena Saglia (figlia) - Contratto AVANZATO firmato 10/05/2025"},{codice:"CTR-BALZAROTTI-2025",email_caregiver:"paolo@paolomagri.com",intestatario_nome:"Giuliana",intestatario_cognome:"Balzarotti",assistito_nome:"Giuliana",assistito_cognome:"Balzarotti",tipo:"BASE",piano:"BASE",servizio:"PRO",prezzo:480,data_invio:"2025-06-13",data_firma:"2025-06-16",status:"SIGNED",pdf:"/contratti/13.06.2025_Contratto Medica GB_TeleAssistenza SIDLY BASE - Paolo Magri.pdf",note:"Assistito: Giuliana Balzarotti - Caregiver: Paolo Magri (figlio) - Contratto BASE firmato 16/06/2025"},{codice:"CTR-PIZZUTTO-G-2025",email_caregiver:"simona.pizzutto@coopbarbarab.it",cognome_fallback:"Pizzutto",intestatario_nome:"Gianni Paolo",intestatario_cognome:"Pizzutto",assistito_nome:"Gianni Paolo",assistito_cognome:"Pizzutto",tipo:"BASE",piano:"BASE",servizio:"PRO",prezzo:480,data_invio:"2025-05-08",data_firma:"2025-05-15",status:"SIGNED",pdf:"/contratti/12.05.2025_Contratto Medica GB_TeleAssistenza SIDLY BASE_Gianni Paolo Pizzutto_firmato.pdf",note:"Assistito: Gianni Paolo Pizzutto - Caregiver: Simona Pizzutto (figlia) - Contratto BASE firmato 15/05/2025"},{codice:"CTR-PENNACCHIO-2025",email_caregiver:"caterinadalterio108@gmail.com",intestatario_nome:"Rita",intestatario_cognome:"Pennacchio",assistito_nome:"Rita",assistito_cognome:"Pennacchio",tipo:"BASE",piano:"BASE",servizio:"PRO",prezzo:480,data_invio:"2025-05-08",data_firma:"2025-05-14",status:"SIGNED",pdf:"/contratti/12.05.2025_Contratto firmato SIDLY BASE_Pennacchio Rita - Contratto firmato.pdf",note:"Assistito: Rita Pennacchio - Caregiver: Caterina D'Alterio - Contratto BASE firmato 14/05/2025"},{codice:"CTR-COZZI-2025",email_caregiver:"elisabettacattini@gmail.com",intestatario_nome:"Giuseppina",intestatario_cognome:"Cozzi",assistito_nome:"Giuseppina",assistito_cognome:"Cozzi",tipo:"BASE",piano:"BASE",servizio:"PRO",prezzo:480,data_invio:"2025-07-10",data_firma:"2025-07-15",status:"SIGNED",pdf:"/contratti/Contratto_Giuseppina_Cozzi.pdf",note:"Assistito: Giuseppina Cozzi - Caregiver: Elisabetta Cattini (figlia) - Contratto BASE firmato 15/07/2025"},{codice:"CTR-POGGI-2025",email_caregiver:"manuela.poggi1@icloud.com",intestatario_nome:"Manuela",intestatario_cognome:"Poggi",assistito_nome:"Manuela",assistito_cognome:"Poggi",tipo:"BASE",piano:"BASE",servizio:"PRO",prezzo:480,data_invio:"2025-05-08",data_firma:null,status:"SENT",pdf:"/contratti/08.05.2025_Contratto Medica GB_TeleAssistenza base SIDLY_Sig.ra Manuela Poggi.pdf",note:"Assistito: Manuela Poggi - Contratto BASE inviato 08/05/2025 - NON FIRMATO"},{codice:"CTR-DANDRAIA-2025",email_caregiver:"dandraia.g@gmail.com",intestatario_nome:"Giovanni",intestatario_cognome:"Dandraia",assistito_nome:"Giovanni",assistito_cognome:"Dandraia",tipo:"BASE",piano:"BASE",servizio:"PRO",prezzo:480,data_invio:"2025-09-15",data_firma:null,status:"SENT",pdf:"/contratti/Contratto Medica GB_SIDLY_Signor Giovanni Dandraia.pdf",note:"Assistito: Giovanni Dandraia - Contratto BASE inviato - NON FIRMATO"},{codice:"CTR-DESTRO-2025",email_caregiver:"ettoredestro@gmail.com",intestatario_nome:"Ettore",intestatario_cognome:"Destro",assistito_nome:"Ettore",assistito_cognome:"Destro",tipo:"AVANZATO",piano:"AVANZATO",servizio:"PRO",prezzo:840,data_invio:"2025-09-23",data_firma:null,status:"SENT",pdf:"/contratti/23.09.2025_Contratto Medica GB_SIDLY_Ettore Destro_2 Servizi AVANZATI.pdf",note:"Assistito: Ettore Destro - 2 Servizi AVANZATI - Contratto inviato 23/09/2025 - NON FIRMATO"},{codice:"CTR-CAPONE-2025",email_caregiver:"gr@ecotorino.it",cognome_fallback:"Riela",intestatario_nome:"Maria",intestatario_cognome:"Capone",assistito_nome:"Maria",assistito_cognome:"Capone",tipo:"BASE",piano:"BASE",servizio:"PRO",prezzo:480,data_invio:"2025-06-28",data_firma:"2025-06-28",status:"SIGNED",pdf:"/contratti/28.06.2025_Contratto_Medica_GB_bracciale_SiDLY_Maria_Capone.pdf",note:"Assistito: Maria Capone - Caregiver: Giorgio Riela (figlio) - Contratto BASE firmato 28/06/2025"}],a=[];let i=0,s=0;for(const d of e)try{console.log(`
üîç Contratto ${d.codice}:`),console.log(`   üìß Email caregiver: ${d.email_caregiver}`),console.log(`   üë§ Intestatario: ${d.intestatario_nome} ${d.intestatario_cognome}`);let u=null,p="";if(d.email_caregiver&&(console.log(`   1Ô∏è‚É£ Ricerca per EMAIL: ${d.email_caregiver}`),u=await o.env.DB.prepare("SELECT id, email, nomeRichiedente, cognomeRichiedente, nomeAssistito, cognomeAssistito FROM leads WHERE LOWER(email) = LOWER(?)").bind(d.email_caregiver).first(),u?(p="EMAIL",console.log(`   ‚úÖ Lead trovato via EMAIL: ${u.nomeRichiedente} ${u.cognomeRichiedente}`)):console.log("   ‚ùå Email non trovata nel database")),!u&&d.intestatario_cognome&&(console.log(`   2Ô∏è‚É£ Fallback COGNOME ASSISTITO: ${d.intestatario_cognome}`),u=await o.env.DB.prepare("SELECT id, email, nomeRichiedente, cognomeRichiedente, nomeAssistito, cognomeAssistito FROM leads WHERE LOWER(cognomeAssistito) = LOWER(?) LIMIT 1").bind(d.intestatario_cognome).first(),u?(p="COGNOME_ASSISTITO",console.log(`   ‚úÖ Lead trovato via COGNOME: ${u.nomeAssistito} ${u.cognomeAssistito} (caregiver: ${u.nomeRichiedente})`)):console.log("   ‚ùå Cognome assistito non trovato")),!u&&d.intestatario_cognome&&(console.log(`   3Ô∏è‚É£ Ultimo tentativo COGNOME RICHIEDENTE: ${d.intestatario_cognome}`),u=await o.env.DB.prepare("SELECT id, email, nomeRichiedente, cognomeRichiedente, nomeAssistito, cognomeAssistito FROM leads WHERE LOWER(cognomeRichiedente) = LOWER(?) LIMIT 1").bind(d.intestatario_cognome).first(),u&&(p="COGNOME_RICHIEDENTE",console.log(`   ‚úÖ Lead trovato via COGNOME RICHIEDENTE: ${u.nomeRichiedente} ${u.cognomeRichiedente}`))),!u){const N=`Lead non trovato - email: ${d.email_caregiver||"N/A"}, cognome: ${d.intestatario_cognome||"N/A"}`;console.log(`   ‚ö†Ô∏è  SKIP ${d.codice}: ${N}`),a.push({codice:d.codice,success:!1,error:N}),s++;continue}console.log(`   üéØ Lead associato: ${u.id} (trovato via ${p})`);const g=d.intestatario_nome||u.nomeRichiedente||"",m=d.intestatario_cognome||u.cognomeRichiedente||"",v=`CONTRACT_${d.codice}_${Date.now()}`,b=new Date().toISOString(),E=d.tipo==="AVANZATO"?"Template_Contratto_Avanzato_TeleMedCare":"Template_Contratto_Base_TeleMedCare",T=`<html><body>
          <h1>Contratto ${d.tipo} - ${d.codice}</h1>
          <p><strong>Intestatario:</strong> ${g} ${m}</p>
          <p><strong>Assistito:</strong> ${d.assistito_nome||g} ${d.assistito_cognome||m}</p>
          <p><strong>PDF:</strong> ${d.pdf}</p>
        </body></html>`,R=new Date(d.data_invio),S=new Date(R.getTime()+720*60*60*1e3).toISOString();let C=d.prezzo||0;if(!C){const N=vc(d.servizio,d.piano);if(!N){a.push({codice:d.codice,success:!1,error:`Pricing non trovato per ${d.servizio} ${d.piano}`}),s++;continue}C=N.setupTotale}const M=Math.round(C/12),B=`eCura ${d.servizio}`;try{console.log(`   üì¶ Preparazione INSERT per ${d.codice}:`),console.log(`      - Lead ID: ${u.id}`),console.log(`      - Intestatario: ${g} ${m}`),console.log(`      - Prezzo: ‚Ç¨${C} (‚Ç¨${M}/mese)`),console.log(`      - Status: ${d.status}`),await o.env.DB.prepare(`
            INSERT INTO contracts (
              id, leadId, codice_contratto, tipo_contratto, template_utilizzato,
              contenuto_html, pdf_url, pdf_generated, 
              prezzo_mensile, durata_mesi, prezzo_totale,
              status, data_invio, data_scadenza,
              email_sent, email_template_used,
              piano, servizio,
              created_at, updated_at
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          `).bind(v,u.id,d.codice,d.tipo,E,T,d.pdf,1,M,12,C,d.status,d.data_invio,S,1,"email_invio_contratto",d.piano,B,b,b).run(),console.log(`   ‚úÖ Contratto inserito: ${d.codice}`)}catch(N){console.error(`   ‚ùå Errore INSERT contratto ${d.codice}:`,N),console.error("   ‚ùå Dettagli errore:",{message:N instanceof Error?N.message:String(N),contractId:v,leadId:u.id,codice:d.codice}),a.push({codice:d.codice,success:!1,error:`Errore DB: ${N instanceof Error?N.message:String(N)}`}),s++;continue}const j=d.status==="SIGNED"?"CONTRACT_SIGNED":"CONTRACT_SENT";await o.env.DB.prepare("UPDATE leads SET status = ?, updated_at = ? WHERE id = ?").bind(j,b,u.id).run(),d.status==="SIGNED"&&d.data_firma&&await o.env.DB.prepare(`
            INSERT INTO signatures (
              contract_id, firma_digitale, tipo_firma,
              ip_address, user_agent, timestamp_firma,
              hash_documento, certificato_firma, valida
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
          `).bind(v,"FIRMA_PDF_ESISTENTE","ELETTRONICA","0.0.0.0","Import from PDF",d.data_firma,`hash_${d.codice}`,"Contratto firmato importato da PDF",1).run(),a.push({codice:d.codice,success:!0,contractId:v,leadId:u.id,email:d.email_caregiver,signed:d.status==="SIGNED"}),i++,console.log(`‚úÖ Contratto ${d.codice} creato per lead ${u.id}`)}catch(u){console.error(`‚ùå Errore creazione contratto ${d.codice}:`,u),a.push({codice:d.codice,success:!1,error:u.message}),s++}const r=a.filter(d=>d.success&&d.signed).length,l=e.filter(d=>d.status==="SIGNED").reduce((d,u)=>d+(u.prezzo||0),0),c=a.filter(d=>d.success).map(d=>{const u=e.find(p=>p.codice===d.codice);return{codice:d.codice,intestatario:`${u.intestatario_nome} ${u.intestatario_cognome}`,cognome:u.intestatario_cognome,caregiver:u.email_caregiver,piano:u.piano,servizio:u.servizio,prezzo:u.prezzo,status:u.status,data_invio:u.data_invio,data_firma:u.data_firma}});return o.json({success:!0,message:`Creati ${i} contratti su ${e.length}`,creati:i,errori:s,firmati:r,revenue:l,conversionRate:"5.4%",aov:Math.round(l/(r||1)),risultati:a,contratti:c})}catch(e){return console.error("‚ùå Errore generale setup contratti:",e),o.json({success:!1,error:"Errore durante la creazione dei contratti",details:e.message},500)}});I.post("/api/contracts",async o=>{var t;try{const{leadId:e,tipoContratto:a="BASE"}=await o.req.json();if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const i=await o.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(e).first();if(!i)return o.json({success:!1,error:"Lead non trovato"},404);const s=`CONTRACT_${Date.now()}_${Math.random().toString(36).substring(7)}`,r=`TMC-${new Date().getFullYear()}-${String(Date.now()).slice(-6)}`,l={BASE:{mensile:39,totale:468,durata:12},AVANZATO:{mensile:69,totale:828,durata:12}},c=l[a]||l.BASE,d=a==="AVANZATO"?"Template_Contratto_Avanzato_TeleMedCare":"Template_Contratto_Base_TeleMedCare",u=mw(i,a,c);return await o.env.DB.prepare(`
      INSERT INTO contracts (
        id, leadId, codice_contratto, tipo_contratto, template_utilizzato,
        contenuto_html, prezzo_mensile, durata_mesi, prezzo_totale,
        status, data_scadenza, created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(s,e,r,a,d,u,c.mensile,c.durata,c.totale,"DRAFT",new Date(Date.now()+720*60*60*1e3).toISOString(),new Date().toISOString()).run(),await o.env.DB.prepare("UPDATE leads SET status = ? WHERE id = ?").bind("CONTRACT_GENERATED",e).run(),o.json({success:!0,contract:{id:s,codice:r,tipo:a,prezzo_totale:c.totale,status:"DRAFT"},message:"Contratto generato. Usare /api/contracts/send per inviarlo"})}catch(e){return console.error("‚ùå Errore creazione contratto:",e),o.json({success:!1,error:e.message},500)}});I.post("/api/documents/generate",async o=>{var t;try{const{leadId:e}=await o.req.json();if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);console.log(`üìÑ Richiesta generazione documenti per lead ${e}`);const{generateDocumentsForLead:a}=await Promise.resolve().then(()=>$w),i=await a(o.env.DB,e);return i.success?o.json({success:!0,message:"Documenti generati con successo",data:{contractId:i.contractId,contractPdfUrl:i.contractPdfUrl,proformaId:i.proformaId,proformaPdfUrl:i.proformaPdfUrl,tipoServizio:i.tipoServizio,prezzoBase:i.prezzoBase,prezzoIvaInclusa:i.prezzoIvaInclusa}}):o.json({success:!1,errors:i.errors},400)}catch(e){return console.error("‚ùå Errore generazione documenti:",e),o.json({success:!1,error:e instanceof Error?e.message:"Errore sconosciuto"},500)}});I.post("/api/contracts/send",async o=>{var t;try{const{contractId:e}=await o.req.json();if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const a=await o.env.DB.prepare(`
      SELECT c.*, l.nomeRichiedente, l.cognomeRichiedente, l.email, l.telefono
      FROM contracts c
      LEFT JOIN leads l ON c.leadId = l.id
      WHERE c.id = ?
    `).bind(e).first();if(!a)return o.json({success:!1,error:"Contratto non trovato"},404);const i=await hw(a,o.env);return i.success?(await o.env.DB.prepare(`
        UPDATE contracts SET 
          status = 'SENT', 
          data_invio = ?, 
          email_sent = true, 
          email_template_used = 'email_invio_contratto'
        WHERE id = ?
      `).bind(new Date().toISOString(),e).run(),await o.env.DB.prepare("UPDATE leads SET status = ? WHERE id = ?").bind("CONTRACT_SENT",a.leadId).run(),await o.env.DB.prepare(`
        INSERT INTO email_logs (leadId, contract_id, recipient_email, template_used, subject, status, provider_used, sent_at)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
      `).bind(a.leadId,e,a.email,"email_invio_contratto",`TeleMedCare - Contratto ${a.codice_contratto}`,"SENT","RESEND",new Date().toISOString()).run(),o.json({success:!0,message:`Contratto ${a.codice_contratto} inviato a ${a.email}`,email_status:i})):o.json({success:!1,error:"Errore invio email: "+i.error},500)}catch(e){return console.error("‚ùå Errore invio contratto:",e),o.json({success:!1,error:e.message},500)}});I.post("/api/proforma",async o=>{try{const{contractId:t}=await o.req.json(),e=await gw(t,o.env.DB);return o.json(e)}catch(t){return console.error("‚ùå Errore generazione proforma:",t),o.json({success:!1,error:t.message},500)}});I.post("/api/proforma/send",async o=>{var t;try{const{proformaId:e}=await o.req.json();if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const a=await o.env.DB.prepare(`
      SELECT p.*, l.nomeRichiedente, l.cognomeRichiedente, l.email
      FROM proforma p
      LEFT JOIN contracts c ON p.contract_id = c.id
      LEFT JOIN leads l ON c.leadId = l.id
      WHERE p.id = ?
    `).bind(e).first();if(!a)return o.json({success:!1,error:"Proforma non trovata"},404);const i=await fw(a);return i.success?(await o.env.DB.prepare(`
        UPDATE proforma SET 
          status = 'SENT',
          data_invio = ?,
          email_sent = true
        WHERE id = ?
      `).bind(new Date().toISOString(),e).run(),o.json({success:!0,message:`Proforma ${a.numero_proforma} inviata a ${a.email}`})):o.json({success:!1,error:"Errore invio email: "+i.error},500)}catch(e){return console.error("‚ùå Errore invio proforma:",e),o.json({success:!1,error:e.message},500)}});I.post("/api/payments",async o=>{var t;try{const{proformaId:e,importo:a,metodoPagamento:i,transactionId:s,stripePaymentIntentId:r}=await o.req.json();if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const l=await o.env.DB.prepare(`
      SELECT p.*, c.leadId, c.id as contract_id
      FROM proforma p
      LEFT JOIN contracts c ON p.contract_id = c.id
      WHERE p.id = ?
    `).bind(e).first();if(!l)return o.json({success:!1,error:"Proforma non trovata"},404);const c=await o.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(l.leadId).first();if(!c)return o.json({success:!1,error:"Lead non trovato"},404);console.log("üí≥ [ENDPOINT] Payment request data:",JSON.stringify({proformaId:e,importo:a,metodoPagamento:i,transactionId:s,proforma_contract_id:l.contract_id,leadId:c.id}));const d={db:o.env.DB,env:o.env,leadData:{id:c.id,nomeRichiedente:c.nomeRichiedente,cognomeRichiedente:c.cognomeRichiedente,emailRichiedente:c.email,telefonoRichiedente:c.telefono,nomeAssistito:c.nomeAssistito||c.nomeRichiedente,cognomeAssistito:c.cognomeAssistito||c.cognomeRichiedente,etaAssistito:c.etaAssistito?String(c.etaAssistito):null,pacchetto:c.tipoServizio||"BASE",vuoleContratto:!0,vuoleBrochure:c.vuoleBrochure==="Si",vuoleManuale:c.vuoleManuale==="Si",fonte:c.fonte||"LANDING_PAGE"},proformaId:e,contractId:l.contract_id,paymentData:{amount:a,paymentMethod:i,transactionId:s,stripePaymentIntentId:r}},u=await aw(d);return u.success?o.json({success:!0,message:u.message,data:u.data}):o.json({success:!1,error:u.message,errors:u.errors,debug:u.debug},400)}catch(e){return console.error("‚ùå Errore registrazione pagamento:",e),o.json({success:!1,error:e.message},500)}});I.get("/api/proforma",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!0,proforma:[]});const e=await o.env.DB.prepare(`
      SELECT 
        p.*,
        l.nomeRichiedente,
        l.cognomeRichiedente,
        l.email as cliente_email
      FROM proforma p
      LEFT JOIN contracts c ON p.contract_id = c.id
      LEFT JOIN leads l ON c.leadId = l.id
      ORDER BY p.created_at DESC
      LIMIT 100
    `).all();return o.json({success:!0,count:e.results.length,proforma:e.results.map(a=>({...a,cliente_nome:`${a.nomeRichiedente} ${a.cognomeRichiedente}`}))})}catch(e){return console.error("‚ùå Errore recupero proforma:",e),o.json({success:!1,error:"Errore recupero proforma"},500)}});I.get("/api/proforma/:id",async o=>{var e;const t=o.req.param("id");try{if(!((e=o.env)!=null&&e.DB))return o.json({success:!0,proforma:{id:t,numero_proforma:"PRO-MOCK-"+t,importo:480,status:"SENT"}});const a=await o.env.DB.prepare(`
      SELECT 
        p.*,
        l.nomeRichiedente,
        l.cognomeRichiedente,
        l.email as cliente_email,
        l.telefono as cliente_telefono
      FROM proforma p
      LEFT JOIN contracts c ON p.contract_id = c.id
      LEFT JOIN leads l ON c.leadId = l.id
      WHERE p.id = ?
    `).bind(t).first();return a?o.json({success:!0,proforma:a}):o.json({success:!1,error:"Proforma non trovata"},404)}catch(a){return console.error("‚ùå Errore recupero proforma:",a),o.json({success:!1,error:"Errore recupero proforma",details:a instanceof Error?a.message:String(a)},500)}});I.put("/api/proforma/:id",async o=>{var e;const t=o.req.param("id");try{const a=await o.req.json();if(!((e=o.env)!=null&&e.DB))return o.json({success:!0,message:"Proforma aggiornata (mock)"});if(!await o.env.DB.prepare("SELECT * FROM proforma WHERE id = ?").bind(t).first())return o.json({success:!1,error:"Proforma non trovata"},404);const s=[],r=[],l={status:"status",importo:"importo",note:"note",data_invio:"data_invio",data_scadenza:"data_scadenza"};for(const[d,u]of Object.entries(l))a[d]!==void 0&&(s.push(`${u} = ?`),r.push(a[d]));if(s.length===0)return o.json({success:!1,error:"Nessun campo da aggiornare"},400);s.push("updated_at = ?"),r.push(new Date().toISOString()),r.push(t);const c=`UPDATE proforma SET ${s.join(", ")} WHERE id = ?`;return await o.env.DB.prepare(c).bind(...r).run(),console.log("‚úÖ Proforma aggiornata:",t),o.json({success:!0,message:"Proforma aggiornata con successo",id:t})}catch(a){return console.error("‚ùå Errore aggiornamento proforma:",a),o.json({success:!1,error:"Errore aggiornamento proforma",details:a instanceof Error?a.message:String(a)},500)}});I.delete("/api/proforma/:id",async o=>{var e;const t=o.req.param("id");try{if(!((e=o.env)!=null&&e.DB))return o.json({success:!0,message:"Proforma eliminata (mock)"});const a=await o.env.DB.prepare("SELECT * FROM proforma WHERE id = ?").bind(t).first();return a?a.status==="PAID"?o.json({success:!1,error:"Impossibile eliminare una proforma pagata",isPaid:!0},400):(await o.env.DB.prepare("DELETE FROM proforma WHERE id = ?").bind(t).run(),await o.env.DB.prepare("DELETE FROM payments WHERE proforma_id = ?").bind(t).run(),console.log("‚úÖ Proforma eliminata:",t),o.json({success:!0,message:"Proforma eliminata con successo",id:t})):o.json({success:!1,error:"Proforma non trovata"},404)}catch(a){return console.error("‚ùå Errore eliminazione proforma:",a),o.json({success:!1,error:"Errore eliminazione proforma",details:a instanceof Error?a.message:String(a)},500)}});I.post("/api/configurations",async o=>{var t;try{const e=await o.req.json(),{leadId:a,contattiEmergenza:i,datiMedici:s,preferenzeUtilizzo:r}=e;if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const l=await o.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(a).first();if(!l)return o.json({success:!1,error:"Lead non trovato"},404);const c=Date.now(),d=Math.floor(Math.random()*1e3).toString().padStart(3,"0"),u=`CLI-${c}-${d}`,p={db:o.env.DB,env:o.env,leadData:{id:l.id,nomeRichiedente:l.nomeRichiedente,cognomeRichiedente:l.cognomeRichiedente,emailRichiedente:l.email,telefonoRichiedente:l.telefono,nomeAssistito:l.nomeAssistito||l.nomeRichiedente,cognomeAssistito:l.cognomeAssistito||l.cognomeRichiedente,etaAssistito:l.etaAssistito?String(l.etaAssistito):null,pacchetto:l.tipoServizio||"BASE",vuoleContratto:!0,vuoleBrochure:l.vuoleBrochure==="Si",vuoleManuale:l.vuoleManuale==="Si",fonte:l.fonte||"LANDING_PAGE"},configData:{leadId:a,codiceCliente:u,contattiEmergenza:i,datiMedici:s,preferenzeUtilizzo:r,nomeCompletoAssistito:`${l.nomeAssistito||l.nomeRichiedente} ${l.cognomeAssistito||l.cognomeRichiedente}`,dataNascitaAssistito:l.dataNascitaAssistito||"",indirizzoCompletoAssistito:l.indirizzoAssistito||"",cittaAssistito:l.cittaAssistito||"",capAssistito:l.capAssistito||"",provinciaAssistito:l.provinciaAssistito||"",compilazioneTimestamp:new Date().toISOString()}},g=await iw(p);return g.success?o.json({success:!0,message:g.message,data:g.data}):o.json({success:!1,error:g.message,errors:g.errors},400)}catch(e){return console.error("‚ùå Errore salvataggio configurazione:",e),o.json({success:!1,error:e.message},500)}});I.post("/api/devices/associate",async o=>{var t;try{const{leadId:e,deviceId:a,deviceImei:i,configurationId:s}=await o.req.json();if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const r=await o.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(e).first();if(!r)return o.json({success:!1,error:"Lead non trovato"},404);const l={db:o.env.DB,env:o.env,leadData:{id:r.id,nomeRichiedente:r.nomeRichiedente,cognomeRichiedente:r.cognomeRichiedente,emailRichiedente:r.email,telefonoRichiedente:r.telefono,nomeAssistito:r.nomeAssistito||r.nomeRichiedente,cognomeAssistito:r.cognomeAssistito||r.cognomeRichiedente,etaAssistito:r.etaAssistito?String(r.etaAssistito):null,pacchetto:r.tipoServizio||"BASE",vuoleContratto:!0,vuoleBrochure:r.vuoleBrochure==="Si",vuoleManuale:r.vuoleManuale==="Si",fonte:r.fonte||"LANDING_PAGE"},deviceData:{deviceId:a,deviceImei:i,configurationId:s}},c=await sw(l);return c.success?o.json({success:!0,message:c.message,data:c.data}):o.json({success:!1,error:c.message,errors:c.errors},400)}catch(e){return console.error("‚ùå Errore associazione dispositivo:",e),o.json({success:!1,error:e.message},500)}});I.post("/api/leads/external",async o=>{var t;try{const{fonte:e,leads:a}=await o.req.json();if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const i=[];for(const s of a)try{const r=`LEAD_${e}_${Date.now()}_${Math.random().toString(36).substring(7)}`;await o.env.DB.prepare(`
          INSERT INTO leads (
            id, nomeRichiedente, cognomeRichiedente, email, telefono,
            fonte, tipoServizio, vuoleContratto, consensoPrivacy, status,
            external_source_id, external_data
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(r,s.nome,s.cognome,s.email,s.telefono||"",e,s.tipoServizio||"BASE","Si",!0,"NEW",s.externalId||null,JSON.stringify(s)).run();const l=await vw(s.email,s.nome,e);i.push({leadId:r,email:s.email,email_sent:l.success,status:"CREATED"})}catch(r){i.push({email:s.email,error:r.message,status:"ERROR"})}return o.json({success:!0,processed:i.length,results:i,message:`${i.filter(s=>s.status==="CREATED").length} leads creati da fonte ${e}`})}catch(e){return console.error("‚ùå Errore creazione leads esterni:",e),o.json({success:!1,error:e.message},500)}});I.post("/api/webhooks/hubspot",async o=>{try{console.log("üì• Webhook HubSpot ricevuto da eCura");const{handleHubSpotWebhook:t}=await Promise.resolve().then(()=>jw),e=await t(o.req.raw,o.env);return new Response(e.body,{status:e.status,headers:e.headers})}catch(t){return console.error("‚ùå Errore webhook HubSpot:",t),o.json({success:!1,error:t instanceof Error?t.message:"Errore sconosciuto"},500)}});I.post("/api/webhooks/docusign",async o=>{try{console.log("üì• [WEBHOOK] DocuSign evento ricevuto");const t=await o.req.json(),e=o.env.DB,{DocuSignWebhookHandler:a}=await Promise.resolve().then(()=>Vw),i=await a.handleWebhook(t,e,o.env);return console.log("‚úÖ [WEBHOOK] DocuSign processato:",i),o.json({success:i.success,message:i.message,envelopeId:i.envelopeId,status:i.status,actions:i.actions})}catch(t){return console.error("‚ùå [WEBHOOK] Errore DocuSign:",t),o.json({success:!1,error:t instanceof Error?t.message:"Errore webhook DocuSign"},500)}});I.post("/api/webhooks/stripe",async o=>{try{console.log("üì• [WEBHOOK] Stripe evento ricevuto");const t=await o.req.json(),e=o.env.DB,{StripeWebhookHandler:a}=await Promise.resolve().then(()=>Gw),i=await a.processWebhook(t,e);return console.log("‚úÖ [WEBHOOK] Stripe processato:",i),o.json({success:i.success,message:i.message,eventType:t.type})}catch(t){return console.error("‚ùå [WEBHOOK] Errore Stripe:",t),o.json({success:!1,error:t instanceof Error?t.message:"Errore webhook Stripe"},500)}});I.get("/api/contratti/:id/view",async o=>{var e;const t=o.req.param("id");try{if(!((e=o.env)!=null&&e.DB))return o.html(`
        <!DOCTYPE html>
        <html>
        <head><title>Contratto TMC-2024-${t.padStart(3,"0")}</title></head>
        <body style="font-family: Arial; padding: 20px;">
          <h1>Contratto TeleMedCare</h1>
          <p><strong>Codice:</strong> TMC-2024-${t.padStart(3,"0")}</p>
          <p><strong>Tipo:</strong> Base</p>
          <p><strong>Data:</strong> ${new Date().toLocaleDateString("it-IT")}</p>
          <h2>Dettagli Servizio</h2>
          <p>Servizio di telemedicina per assistenza sanitaria domiciliare.</p>
          <p><strong>Status:</strong> Firmato</p>
        </body>
        </html>
      `);const a=await o.env.DB.prepare(`
      SELECT c.*, l.name as cliente_nome, l.email as cliente_email
      FROM contracts c 
      LEFT JOIN leads l ON c.lead_id = l.id 
      WHERE c.id = ?
    `).bind(t).first();return a?o.html(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>Contratto ${a.codice}</title>
        <style>body { font-family: Arial; padding: 20px; }</style>
      </head>
      <body>
        <h1>Contratto TeleMedCare</h1>
        <p><strong>Codice:</strong> ${a.codice}</p>
        <p><strong>Cliente:</strong> ${a.cliente_nome}</p>
        <p><strong>Email:</strong> ${a.cliente_email}</p>
        <p><strong>Tipo:</strong> ${a.tipo}</p>
        <p><strong>Data Firma:</strong> ${new Date(a.data_firma).toLocaleDateString("it-IT")}</p>
        <h2>Dettagli Servizio</h2>
        <p>${a.dettagli||"Servizio di telemedicina per assistenza sanitaria domiciliare."}</p>
        <p><strong>Status:</strong> ${a.status}</p>
      </body>
      </html>
    `):o.html("<h1>Contratto non trovato</h1>",404)}catch(a){return console.error("‚ùå Errore visualizzazione contratto:",a),o.html("<h1>Errore visualizzazione contratto</h1>",500)}});I.get("/api/contratti/:id/download",async o=>{var e;const t=o.req.param("id");try{if(!((e=o.env)!=null&&e.DB)){const i=`%PDF-1.4
1 0 obj
<< /Type /Catalog /Pages 2 0 R >>
endobj
2 0 obj
<< /Type /Pages /Kids [3 0 R] /Count 1 >>
endobj
3 0 obj
<< /Type /Page /Parent 2 0 R /Resources << /Font << /F1 << /Type /Font /Subtype /Type1 /BaseFont /Helvetica >> >> >> /MediaBox [0 0 612 792] /Contents 4 0 R >>
endobj
4 0 obj
<< /Length 55 >>
stream
BT
/F1 12 Tf
100 700 Td
(Contratto TeleMedCare TMC-2024-${t.padStart(3,"0")}) Tj
ET
endstream
endobj
xref
0 5
0000000000 65535 f 
0000000009 00000 n 
0000000058 00000 n 
0000000115 00000 n 
0000000281 00000 n 
trailer
<< /Size 5 /Root 1 0 R >>
startxref
386
%%EOF`;return new Response(i,{headers:{"Content-Type":"application/pdf","Content-Disposition":`attachment; filename="contratto-TMC-2024-${t.padStart(3,"0")}.pdf"`}})}const a=await o.env.DB.prepare("SELECT * FROM contracts WHERE id = ?").bind(t).first();return a?a.pdf_url?o.redirect(a.pdf_url):a.contenuto_html?o.html(a.contenuto_html):o.json({error:"PDF e HTML non disponibili per questo contratto"},404):o.json({error:"Contratto non trovato"},404)}catch(a){return console.error("‚ùå Errore download contratto:",a),o.json({error:"Errore download contratto"},500)}});I.get("/api/contratti/:id",async o=>{var e;const t=o.req.param("id");try{if(!((e=o.env)!=null&&e.DB))return o.json({success:!0,contratto:{id:t,codice_contratto:"TMC-MOCK-"+t,tipo_contratto:"BASE",status:"SENT"}});const a=await o.env.DB.prepare(`
      SELECT 
        c.*,
        l.nomeRichiedente,
        l.cognomeRichiedente,
        l.email as cliente_email,
        l.telefono as cliente_telefono
      FROM contracts c
      LEFT JOIN leads l ON c.leadId = l.id
      WHERE c.id = ?
    `).bind(t).first();return a?o.json({success:!0,contratto:a}):o.json({success:!1,error:"Contratto non trovato"},404)}catch(a){return console.error("‚ùå Errore recupero contratto:",a),o.json({success:!1,error:"Errore recupero contratto",details:a instanceof Error?a.message:String(a)},500)}});I.put("/api/contratti/:id",async o=>{var e;const t=o.req.param("id");try{const a=await o.req.json();if(!((e=o.env)!=null&&e.DB))return o.json({success:!0,message:"Contratto aggiornato (mock)"});if(!await o.env.DB.prepare("SELECT * FROM contracts WHERE id = ?").bind(t).first())return o.json({success:!1,error:"Contratto non trovato"},404);const s=[],r=[],l={status:"status",tipo_contratto:"tipo_contratto",prezzo_totale:"prezzo_totale",note:"note",data_invio:"data_invio"};for(const[d,u]of Object.entries(l))a[d]!==void 0&&(s.push(`${u} = ?`),r.push(a[d]));if(s.length===0)return o.json({success:!1,error:"Nessun campo da aggiornare"},400);s.push("updated_at = ?"),r.push(new Date().toISOString()),r.push(t);const c=`UPDATE contracts SET ${s.join(", ")} WHERE id = ?`;return await o.env.DB.prepare(c).bind(...r).run(),console.log("‚úÖ Contratto aggiornato:",t),o.json({success:!0,message:"Contratto aggiornato con successo",id:t})}catch(a){return console.error("‚ùå Errore aggiornamento contratto:",a),o.json({success:!1,error:"Errore aggiornamento contratto",details:a instanceof Error?a.message:String(a)},500)}});I.delete("/api/contratti/:id",async o=>{var e;const t=o.req.param("id");try{if(!((e=o.env)!=null&&e.DB))return o.json({success:!0,message:"Contratto eliminato (mock)"});const a=await o.env.DB.prepare("SELECT * FROM contracts WHERE id = ?").bind(t).first();return a?a.status==="SIGNED"?o.json({success:!1,error:"Impossibile eliminare un contratto firmato",isSigned:!0},400):(await o.env.DB.prepare("DELETE FROM contracts WHERE id = ?").bind(t).run(),await o.env.DB.prepare("DELETE FROM signatures WHERE contract_id = ?").bind(t).run(),console.log("‚úÖ Contratto eliminato:",t),o.json({success:!0,message:"Contratto eliminato con successo",id:t})):o.json({success:!1,error:"Contratto non trovato"},404)}catch(a){return console.error("‚ùå Errore eliminazione contratto:",a),o.json({success:!1,error:"Errore eliminazione contratto",details:a instanceof Error?a.message:String(a)},500)}});I.post("/api/leads/:id/send-contract",async o=>{var e;const t=o.req.param("id");try{if(!((e=o.env)!=null&&e.DB))return o.json({success:!1,error:"Database non configurato"},500);const a=await o.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(t).first();if(!a)return o.json({success:!1,error:"Lead non trovato"},404);console.log("üìÑ Creazione contratto per lead:",t);const i=Date.now(),s=`TMC-${new Date().getFullYear()}${String(new Date().getMonth()+1).padStart(2,"0")}-${Math.random().toString(36).substring(2,8).toUpperCase()}`,r=`contract-${i}`,l=a.servizio||"eCura PRO",c=a.piano||"BASE",d={id:t,nomeRichiedente:a.nomeRichiedente,cognomeRichiedente:a.cognomeRichiedente,emailRichiedente:a.email,telefonoRichiedente:a.telefono||"",nomeAssistito:a.nomeAssistito||a.nomeRichiedente,cognomeAssistito:a.cognomeAssistito||a.cognomeRichiedente,luogoNascitaAssistito:a.luogoNascitaAssistito||"",dataNascitaAssistito:a.dataNascitaAssistito||"",indirizzoAssistito:a.indirizzoAssistito||"",capAssistito:a.capAssistito||"",cittaAssistito:a.cittaAssistito||"",provinciaAssistito:a.provinciaAssistito||"",cfAssistito:a.codiceFiscaleAssistito||"",condizioniSalute:a.condizioniSalute||"",pacchetto:c,servizio:l,intestatarioContratto:a.intestatarioContratto||"richiedente",vuoleBrochure:!0,vuoleManuale:!1,vuoleContratto:!0},u={contractId:r,contractCode:s,contractPdfUrl:"",tipoServizio:c,servizio:l,prezzoBase:c==="AVANZATO"?840:480,prezzoIvaInclusa:c==="AVANZATO"?1024.8:585.6},{inviaEmailContratto:p}=await Promise.resolve().then(()=>Sp),g={};l.includes("PRO")||l.includes("FAMILY")?g.brochure="/brochures/Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf":l.includes("PREMIUM")&&(g.brochure="/brochures/Medica-GB-SiDLY_Vital_Care_ITA-compresso.pdf");const m=await p(d,u,o.env,g,o.env.DB);return m.success?(await o.env.DB.prepare(`
        UPDATE leads SET 
          vuoleContratto = 'Si',
          status = 'CONTRACT_SENT',
          updated_at = ?
        WHERE id = ?
      `).bind(new Date().toISOString(),t).run(),o.json({success:!0,message:"Contratto inviato con successo",contractId:r,contractCode:s})):o.json({success:!1,error:"Errore invio contratto",details:m.errors.join(", ")},500)}catch(a){return console.error("‚ùå Errore invio contratto:",a),o.json({success:!1,error:"Errore invio contratto",details:a instanceof Error?a.message:String(a)},500)}});I.post("/api/leads/:id/send-brochure",async o=>{var e;const t=o.req.param("id");try{if(!((e=o.env)!=null&&e.DB))return o.json({success:!1,error:"Database non configurato"},500);const a=await o.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(t).first();if(!a)return o.json({success:!1,error:"Lead non trovato"},404);const i=(a.servizio||"eCura PRO").replace("eCura ","").toUpperCase(),s=(a.piano||"BASE").toUpperCase();console.log(`üì• [BROCHURE] Invio brochure per ${i} ${s}`);const r=[];let l="";if(i==="PRO"||i==="FAMILY"?l="Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf":i==="PREMIUM"&&(l="Medica-GB-SiDLY_Vital_Care_ITA-compresso.pdf"),l)try{const g=`/brochures/${l}`;console.log(`üì• [BROCHURE] Fetch brochure da: ${g}`);const m=await fetch(new URL(g,o.req.url).toString());if(m.ok){const v=await m.arrayBuffer(),b=Buffer.from(v).toString("base64");r.push({filename:l,content:b,contentType:"application/pdf"}),console.log(`üìé [BROCHURE] Allegato: ${(b.length*.75/1024).toFixed(2)} KB`)}else return console.error("‚ùå [BROCHURE] Brochure non trovata:",m.status),o.json({success:!1,error:`Brochure non disponibile (${m.status})`},500)}catch(g){return console.error("‚ùå [BROCHURE] Errore caricamento brochure:",g),o.json({success:!1,error:"Brochure non disponibile"},500)}else return o.json({success:!1,error:"Servizio non valido"},400);const d=(await Promise.resolve().then(()=>Dt)).default.getInstance(),u={NOME_CLIENTE:a.nomeRichiedente||"Cliente",LEAD_ID:t,SERVIZIO:`eCura ${i}`,PIANO:s==="AVANZATO"?"Avanzato":"Base",NOME_ASSISTITO:a.nomeAssistito||a.nomeRichiedente||"",COGNOME_ASSISTITO:a.cognomeAssistito||a.cognomeRichiedente||""};console.log("üìß [BROCHURE] Invio email con allegato brochure...");const p=await d.sendTemplateEmail("DOCUMENTI_INFORMATIVI",a.email,u,r,o.env);return p.success?(await o.env.DB.prepare(`
        UPDATE leads SET 
          vuoleBrochure = 'Si',
          status = CASE 
            WHEN status = 'NEW' THEN 'BROCHURE_SENT'
            ELSE status
          END,
          updated_at = ?
        WHERE id = ?
      `).bind(new Date().toISOString(),t).run(),await o.env.DB.prepare(`
        INSERT INTO email_logs (
          leadId, recipient_email, template_used, 
          subject, status, provider_used, sent_at
        ) VALUES (?, ?, ?, ?, ?, 'RESEND', ?)
      `).bind(t,a.email,"email_invio_brochure",`eCura - Brochure ${i}`,p.success?"SENT":"SIMULATED",new Date().toISOString()).run(),console.log("‚úÖ [BROCHURE] Brochure inviata con successo"),o.json({success:!0,message:`Brochure ${l} inviata a ${a.email}`,emailStatus:p.success?"sent":"simulated",attachments:r.length})):o.json({success:!1,error:"Errore invio email: "+p.error},500)}catch(a){return console.error("‚ùå [BROCHURE] Errore invio brochure:",a),o.json({success:!1,error:"Errore invio brochure",details:a instanceof Error?a.message:String(a)},500)}});I.get("/api/leads/:id",async o=>{var e;const t=o.req.param("id");try{if(console.log(`üìã GET /api/leads/${t}`),!((e=o.env)!=null&&e.DB))return o.json({id:parseInt(t),name:`Lead Mock ${t}`,email:`lead${t}@example.com`,phone:`+39 123 456 7${t}${t}`,status:"new"});const a=await o.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(t).first();return a?(console.log(`‚úÖ Lead ${t} recuperato`),o.json(a)):(console.log(`‚ùå Lead ${t} non trovato`),o.json({error:"Lead non trovato"},404))}catch(a){return console.error("‚ùå Errore recupero lead:",a),o.json({error:"Errore recupero lead",details:a instanceof Error?a.message:String(a)},500)}});I.post("/api/leads/:id/complete",async o=>{var e,a,i,s;const t=o.req.param("id");try{const r=o.req.header("content-type")||"";let l;if(r.includes("application/json"))l=await o.req.json();else{const m=await o.req.formData();l={};for(const[v,b]of m.entries())l[v]=b}if(console.log(`üìù COMPLETE Lead ${t} da form email:`,JSON.stringify(l,null,2)),!((e=o.env)!=null&&e.DB))return o.text("‚úÖ Grazie! I tuoi dati sono stati salvati con successo. Ti contatteremo presto.",200,{"Content-Type":"text/html; charset=utf-8"});const c=[],d=[],u={nomeRichiedente:"nomeRichiedente",cognomeRichiedente:"cognomeRichiedente",emailRichiedente:"emailRichiedente",email:"emailRichiedente",telefonoRichiedente:"telefonoRichiedente",telefono:"telefonoRichiedente",nomeAssistito:"nomeAssistito",cognomeAssistito:"cognomeAssistito",dataNascitaAssistito:"dataNascitaAssistito",luogoNascitaAssistito:"luogoNascitaAssistito",cittaAssistito:"cittaAssistito",cfAssistito:"cfAssistito",codiceFiscaleAssistito:"cfAssistito",indirizzoAssistito:"indirizzoAssistito",condizioniSalute:"condizioniSalute",cfIntestatario:"cfIntestatario",codiceFiscaleIntestatario:"cfIntestatario",indirizzoIntestatario:"indirizzoIntestatario",capIntestatario:"capIntestatario",cittaIntestatario:"cittaIntestatario",provinciaIntestatario:"provinciaIntestatario",servizio:"servizio",piano:"piano",note:"note",gdprConsent:"gdprConsent"};for(const[m,v]of Object.entries(u))l[m]!==void 0&&l[m]!==""&&(c.push(`${v} = ?`),m==="gdprConsent"?d.push(l[m]==="1"||l[m]==="true"||l[m]===!0?1:0):d.push(l[m]));if(c.length===0)return o.text("‚ùå Nessun dato da aggiornare",400);d.push(t);const p=`UPDATE leads SET ${c.join(", ")}, updated_at = datetime('now') WHERE id = ?`;console.log("üîç Query UPDATE:",p),console.log("üîç Binds:",d),console.log("üîç Lead ID:",t);const g=await o.env.DB.prepare(p).bind(...d).run();if(console.log("üîç Update result:",JSON.stringify(g)),console.log("üîç Rows affected:",((a=g.meta)==null?void 0:a.changes)||0),((i=g.meta)==null?void 0:i.changes)===0)return console.error("‚ùå Nessun lead aggiornato - ID non trovato:",t),o.json({success:!1,error:"Lead non trovato",message:`Impossibile trovare il lead con ID: ${t}`},404);try{console.log("üîî [COMPLETAMENTO] Verifico se inviare contratto automaticamente...");const m=await o.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(t).first();if(m){const{inviaEmailContratto:v}=await Promise.resolve().then(()=>Sp),{isLeadComplete:b}=await Promise.resolve().then(()=>Mt);if(b(m)){console.log("‚úÖ [COMPLETAMENTO] Lead completo ‚Üí Invio contratto automatico");const E=await o.env.DB.prepare("SELECT value FROM settings WHERE key = 'auto_contract_workflow_enabled'").first();if((E==null?void 0:E.value)==="true"){const R=Date.now(),S=`TMC-${new Date().getFullYear()}${String(new Date().getMonth()+1).padStart(2,"0")}-${Math.random().toString(36).substring(2,8).toUpperCase()}`,C=`contract-${R}`,M=m.servizio||"eCura PRO",B=m.piano||"BASE",j={contractId:C,contractCode:S,contractPdfUrl:"",tipoServizio:B,servizio:M,prezzoBase:B==="AVANZATO"?840:480,prezzoIvaInclusa:B==="AVANZATO"?1024.8:585.6},N={};M.includes("PRO")||M.includes("FAMILY")?N.brochure="/brochures/Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf":M.includes("PREMIUM")&&(N.brochure="/brochures/Medica-GB-SiDLY_Vital_Care_ITA-compresso.pdf");const D=await v(m,j,o.env,N,o.env.DB);D.success?(console.log("‚úÖ [COMPLETAMENTO] Contratto inviato con successo!"),await o.env.DB.prepare(`
                UPDATE leads SET 
                  vuoleContratto = 'Si',
                  status = 'CONTRACT_SENT',
                  updated_at = ?
                WHERE id = ?
              `).bind(new Date().toISOString(),t).run()):console.error("‚ùå [COMPLETAMENTO] Errore invio contratto:",D.errors)}else console.log("‚ÑπÔ∏è [COMPLETAMENTO] Workflow contratto automatico disabilitato")}else console.log("‚ÑπÔ∏è [COMPLETAMENTO] Lead non ancora completo, contratto non inviato")}}catch(m){console.error("‚ö†Ô∏è [COMPLETAMENTO] Errore trigger contratto:",m)}return o.json({success:!0,message:"Dati salvati con successo",updated:((s=g.meta)==null?void 0:s.changes)||0})}catch(r){return console.error("‚ùå Errore completamento lead:",r),o.json({success:!1,error:"Errore salvataggio dati",message:r instanceof Error?r.message:String(r)},500)}});I.put("/api/leads/:id",async o=>{var e,a;const t=o.req.param("id");try{const i=await o.req.json();if(console.log(`üìù UPDATE Lead ${t}:`,JSON.stringify(i,null,2)),!((e=o.env)!=null&&e.DB))return o.json({success:!0,message:"Lead aggiornato (mock)"});const s=[],r=[],l={nomeRichiedente:"nomeRichiedente",cognomeRichiedente:"cognomeRichiedente",email:"email",telefono:"telefono",codiceFiscaleRichiedente:"codiceFiscaleRichiedente",indirizzoRichiedente:"indirizzoRichiedente",nomeAssistito:"nomeAssistito",cognomeAssistito:"cognomeAssistito",luogoNascitaAssistito:"luogoNascitaAssistito",dataNascitaAssistito:"dataNascitaAssistito",indirizzoAssistito:"indirizzoAssistito",capAssistito:"capAssistito",cittaAssistito:"cittaAssistito",provinciaAssistito:"provinciaAssistito",codiceFiscaleAssistito:"codiceFiscaleAssistito",cfAssistito:"cfAssistito",servizio:"servizio",piano:"piano",canale:"fonte",fonte:"fonte",vuoleBrochure:"vuoleBrochure",vuoleContratto:"vuoleContratto",vuoleManuale:"vuoleManuale",consensoPrivacy:"consensoPrivacy",consensoMarketing:"consensoMarketing",consensoTerze:"consensoTerze",condizioniSalute:"condizioniSalute",intestatarioContratto:"intestatarioContratto",note:"note",status:"status"};for(const[u,p]of Object.entries(l))i[u]!==void 0&&(s.push(`${p} = ?`),r.push(i[u]));if(i.servizio||i.piano)try{const u=await o.env.DB.prepare("SELECT servizio, piano FROM leads WHERE id = ?").bind(t).first(),p=i.servizio||(u==null?void 0:u.servizio)||"eCura PRO",g=i.piano||(u==null?void 0:u.piano)||"BASE",m=p.replace("eCura ","").toUpperCase();console.log(`üí∞ [UPDATE] Ricalcolo prezzi per ${p} ${g}`);const{calculatePrice:v}=await Promise.resolve().then(()=>p0),b=v(m,g);s.push("prezzo_anno = ?","prezzo_rinnovo = ?"),r.push(b.setupBase,b.rinnovoBase),console.log(`‚úÖ [UPDATE] Prezzi calcolati: ‚Ç¨${b.setupBase}/anno, ‚Ç¨${b.rinnovoBase}/rinnovo`)}catch(u){console.error("‚ö†Ô∏è [UPDATE] Errore calcolo prezzi:",u)}s.push("updated_at = ?"),r.push(new Date().toISOString()),r.push(t);const c=`UPDATE leads SET ${s.join(", ")} WHERE id = ?`;console.log("üîç Query SQL:",c),console.log("üîç Binds:",r);const d=await o.env.DB.prepare(c).bind(...r).run();return console.log("‚úÖ Lead aggiornato:",t,"- Rows affected:",((a=d.meta)==null?void 0:a.changes)||0),o.json({success:!0,message:"Lead aggiornato con successo"})}catch(i){return console.error("‚ùå Errore aggiornamento lead:",i),console.error("‚ùå Error details:",i instanceof Error?i.message:String(i)),o.json({success:!1,error:"Errore aggiornamento lead",details:i instanceof Error?i.message:String(i)},500)}});I.post("/api/leads/:id/convert",async o=>{var e;const t=o.req.param("id");try{if(!((e=o.env)!=null&&e.DB))return o.json({success:!0,message:"Lead convertito (mock)"});const a=await o.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(t).first();if(!a)return o.json({error:"Lead non trovato"},404);const i=`ASS-${Date.now()}-${Math.random().toString(36).substr(2,9).toUpperCase()}`;return await o.env.DB.prepare(`
      INSERT INTO assistiti (codice, nome, email, telefono, status, lead_id, created_at)
      VALUES (?, ?, ?, ?, 'attivo', ?, ?)
    `).bind(i,a.name,a.email,a.phone,t,new Date().toISOString()).run(),await o.env.DB.prepare("UPDATE leads SET status = ? WHERE id = ?").bind("converted",t).run(),o.json({success:!0,message:"Lead convertito in assistito con successo",codice_assistito:i})}catch(a){return console.error("‚ùå Errore conversione lead:",a),o.json({error:"Errore conversione lead"},500)}});I.get("/firma-contratto",async o=>o.req.query("contractId")?o.html(`
    <!DOCTYPE html>
    <html lang="it">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Firma Contratto TeleMedCare</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
            .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
            .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
            .header h1 { font-size: 28px; margin-bottom: 10px; }
            .content { padding: 40px; }
            .loading { text-align: center; padding: 60px; color: #667eea; font-size: 18px; }
            .error { background: #fee; border: 2px solid #e74c3c; color: #c0392b; padding: 20px; border-radius: 10px; margin: 20px 0; }
            .contract-box { background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 10px; padding: 20px; margin: 20px 0; max-height: 400px; overflow-y: auto; }
            .signature-box { border: 3px dashed #667eea; border-radius: 10px; margin: 30px 0; padding: 20px; background: #f8f9fa; }
            canvas { border: 2px solid #667eea; border-radius: 8px; cursor: crosshair; display: block; width: 100%; max-width: 600px; margin: 0 auto; background: white; }
            .button-group { display: flex; gap: 15px; margin-top: 20px; justify-content: center; flex-wrap: wrap; }
            button { padding: 15px 30px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
            .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
            .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4); }
            .btn-secondary { background: #6c757d; color: white; }
            .btn-secondary:hover { background: #5a6268; }
            .checkbox-group { margin: 20px 0; padding: 15px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; }
            label { display: flex; align-items: flex-start; cursor: pointer; }
            input[type="checkbox"] { margin-right: 10px; margin-top: 3px; width: 20px; height: 20px; }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>‚úçÔ∏è Firma Digitale Contratto</h1>
                <p>TeleMedCare - Servizio eCura</p>
            </div>
            
            <div class="content">
                <div id="loading" class="loading">
                    ‚è≥ Caricamento contratto in corso...
                </div>
                
                <div id="error" class="error" style="display:none;"></div>
                
                <div id="contractContent" style="display:none;">
                    <div class="contract-info">
                        <h2>üìÑ Dettagli Contratto</h2>
                        <p><strong>Cliente:</strong> <span id="clientName"></span></p>
                        <p><strong>Servizio:</strong> <span id="serviceName"></span></p>
                        <p><strong>Piano:</strong> <span id="planName"></span></p>
                        <p><strong>Dispositivo:</strong> <span id="deviceName"></span></p>
                        <p><strong>Investimento:</strong> <span id="price"></span></p>
                        <p><strong>Codice Contratto:</strong> <strong id="contractCode"></strong></p>
                    </div>
                    
                    <div class="contract-box" id="contractHtml"></div>
                    
                    <div class="button-group" style="margin-top: 20px;">
                        <button type="button" class="btn-secondary" onclick="printContract()">
                            üñ®Ô∏è Stampa Contratto
                        </button>
                        <button type="button" class="btn-secondary" onclick="downloadContract()">
                            üì• Scarica PDF
                        </button>
                    </div>
                    
                    <div class="signature-box">
                        <h3 style="margin-bottom: 15px;">‚úçÔ∏è Firma qui sotto con il mouse o il dito</h3>
                        <canvas id="signatureCanvas" width="600" height="200"></canvas>
                        <div class="button-group">
                            <button type="button" class="btn-secondary" id="clearBtn">üóëÔ∏è Cancella Firma</button>
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="consentCheckbox" required>
                            <span>Dichiaro di aver letto e compreso il contratto. Confermo la mia firma digitale.</span>
                        </label>
                    </div>
                    
                    <div class="button-group">
                        <button type="button" class="btn-primary" id="signButton">‚úÖ Firma e Invia Contratto</button>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            const contractId = new URLSearchParams(window.location.search).get('contractId');
            
            async function loadContract() {
                if (!contractId) {
                    showError('ID contratto mancante');
                    return;
                }
                
                try {
                    const response = await fetch(\`/api/contracts/\${contractId}\`);
                    if (!response.ok) throw new Error('Contratto non trovato');
                    
                    const contractData = await response.json();
                    
                    document.getElementById('clientName').textContent = \`\${contractData.nomeCliente || ''} \${contractData.cognomeCliente || ''}\`;
                    document.getElementById('serviceName').textContent = contractData.servizio || 'eCura PRO';
                    document.getElementById('planName').textContent = contractData.piano || 'AVANZATO';
                    document.getElementById('deviceName').textContent = contractData.dispositivo || 'SiDLY Care PRO';
                    document.getElementById('price').textContent = contractData.prezzo || '‚Ç¨1.024,80/anno';
                    document.getElementById('contractCode').textContent = contractData.contractCode || '';
                    document.getElementById('contractHtml').innerHTML = contractData.contractHtml || '<p>Contenuto contratto non disponibile</p>';
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('contractContent').style.display = 'block';
                    
                    initCanvas();
                } catch (error) {
                    showError('Errore caricamento contratto: ' + error.message);
                }
            }
            
            function showError(message) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').textContent = '‚ùå ' + message;
                document.getElementById('error').style.display = 'block';
            }
            
            let canvas, ctx, drawing = false;
            
            function initCanvas() {
                canvas = document.getElementById('signatureCanvas');
                ctx = canvas.getContext('2d');
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);
                
                canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e.touches[0]); });
                canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
                canvas.addEventListener('touchend', stopDrawing);
                
                document.getElementById('clearBtn').addEventListener('click', clearCanvas);
                document.getElementById('signButton').addEventListener('click', submitSignature);
            }
            
            function startDrawing(e) {
                drawing = true;
                const rect = canvas.getBoundingClientRect();
                ctx.beginPath();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            }
            
            function draw(e) {
                if (!drawing) return;
                const rect = canvas.getBoundingClientRect();
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                ctx.stroke();
            }
            
            function stopDrawing() {
                drawing = false;
            }
            
            function clearCanvas() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            
            function isCanvasEmpty() {
                const blank = document.createElement('canvas');
                blank.width = canvas.width;
                blank.height = canvas.height;
                return canvas.toDataURL() === blank.toDataURL();
            }
            
            async function submitSignature() {
                if (!document.getElementById('consentCheckbox').checked) {
                    alert('Per favore, accetta il consenso prima di firmare');
                    return;
                }
                
                if (isCanvasEmpty()) {
                    alert('Per favore, firma il contratto prima di inviare');
                    return;
                }
                
                const signButton = document.getElementById('signButton');
                signButton.disabled = true;
                signButton.textContent = '‚è≥ Invio firma in corso...';
                
                try {
                    const signatureData = canvas.toDataURL('image/png');
                    const response = await fetch('/api/contracts/sign', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contractId,
                            signatureData,
                            timestamp: new Date().toISOString(),
                            userAgent: navigator.userAgent,
                            screenResolution: \`\${screen.width}x\${screen.height}\`
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('‚úÖ Contratto firmato con successo!\\n\\nRiceverai una copia via email a breve.');
                        window.location.href = '/';
                    } else {
                        // Mostra errore dettagliato
                        let errorMsg = 'Errore durante la firma del contratto:\\n\\n';
                        errorMsg += result.error || 'Errore sconosciuto';
                        if (result.error === 'Contratto gi√† firmato') {
                            errorMsg += '\\n\\nQuesto contratto √® gi√† stato firmato in precedenza.';
                        } else if (result.error === 'Contratto non trovato') {
                            errorMsg += '\\n\\nID contratto non valido o scaduto.';
                        }
                        throw new Error(errorMsg);
                    }
                } catch (error) {
                    alert('‚ùå ' + error.message);
                    signButton.disabled = false;
                    signButton.textContent = '‚úÖ Firma e Invia Contratto';
                }
            }
            
            function printContract() {
                const contractHtml = document.getElementById('contractHtml').innerHTML;
                const contractCode = document.getElementById('contractCode').textContent;
                const clientName = document.getElementById('clientName').textContent;
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(\`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Contratto \${contractCode} - \${clientName}</title>
                        <style>
                            body { font-family: Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; }
                            h1, h2 { color: #333; }
                            .party { background: #f9f9f9; border-left: 4px solid #0066cc; padding: 15px; margin: 20px 0; }
                            @media print { body { padding: 0; } }
                        </style>
                    </head>
                    <body>
                        \${contractHtml}
                        <div style="margin-top: 60px; padding-top: 20px; border-top: 2px solid #ccc;">
                            <p style="text-align: center; color: #666; font-size: 12px;">
                                Documento stampato da TeleMedCare - Contratto \${contractCode}<br>
                                Cliente: \${clientName}<br>
                                Data stampa: \${new Date().toLocaleString('it-IT')}
                            </p>
                        </div>
                    </body>
                    </html>
                \`);
                printWindow.document.close();
                setTimeout(() => printWindow.print(), 250);
            }
            
            function downloadContract() {
                alert('üì• Funzionalit√† download PDF in arrivo!\\n\\nPer ora puoi stampare il contratto e salvarlo come PDF dal dialog di stampa.');
                printContract();
            }
            
            loadContract();
        <\/script>
    </body>
    </html>
  `):o.html(`
      <!DOCTYPE html>
      <html lang="it">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Errore</title>
        <style>
          body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; text-align: center; }
          h1 { color: #e74c3c; }
        </style>
      </head>
      <body>
        <h1>‚ùå Errore</h1>
        <p>ID contratto mancante</p>
        <p>Contatta <a href="mailto:info@telemedcare.it">info@telemedcare.it</a> per assistenza.</p>
      </body>
      </html>
    `,400));I.get("/dashboard-live",async o=>o.redirect("/test-email-debug"));I.get("/test-email-debug",async o=>o.html(`
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEST Email Count - TeleMedCare</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 30px auto; padding: 20px; background: #f5f7fa; }
        .container { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #667eea; margin-bottom: 20px; }
        .result { padding: 20px; margin: 15px 0; border-radius: 8px; }
        .success { background: #d4edda; border-left: 5px solid #28a745; }
        .error { background: #f8d7da; border-left: 5px solid #dc3545; }
        .info { background: #d1ecf1; border-left: 5px solid #17a2b8; }
        .kpi { font-size: 64px; font-weight: bold; color: #667eea; text-align: center; margin: 20px 0; }
        .kpi-label { text-align: center; color: #666; font-size: 18px; margin-bottom: 10px; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; max-height: 400px; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 30px 0; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; text-align: center; }
        .stat-value { font-size: 48px; font-weight: bold; margin: 10px 0; }
        .stat-label { font-size: 14px; opacity: 0.9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêõ Test Diagnostico Email Count</h1>
        
        <div id="status" class="result info">
            ‚è≥ Caricamento in corso...
        </div>
        
        <div id="stats"></div>
        <div id="result"></div>
        
        <h3>üìã Log di Debug:</h3>
        <pre id="logs"></pre>
    </div>
    
    <script>
        const logs = [];
        
        function log(msg) {
            const time = new Date().toISOString().split('T')[1].split('.')[0];
            logs.push(\`[\${time}] \${msg}\`);
            console.log(msg);
            document.getElementById('logs').textContent = logs.join('\\n');
        }
        
        async function test() {
            try {
                log('üöÄ START TEST');
                log('üì° Fetch /api/leads?limit=100...');
                
                const res = await fetch('/api/leads?limit=100');
                log(\`‚úÖ Status: \${res.status}\`);
                
                const data = await res.json();
                const leads = data.leads || [];
                log(\`‚úÖ Lead caricati: \${leads.length}\`);
                
                const now = new Date();
                const cutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                log(\`üìÖ Cutoff: \${cutoff.toISOString()}\`);
                
                let emailCount = 0;
                let contractCount = 0;
                
                leads.forEach(lead => {
                    const date = new Date(lead.created_at || lead.timestamp);
                    if (date >= cutoff) {
                        if (lead.vuoleBrochure === 'Si' || lead.vuoleContratto === 'Si' || lead.vuoleManuale === 'Si') {
                            emailCount++;
                        }
                        if (lead.vuoleContratto === 'Si') {
                            contractCount++;
                        }
                    }
                });
                
                log(\`üìß Email count: \${emailCount}\`);
                log(\`üìù Contract count: \${contractCount}\`);
                
                document.getElementById('status').className = 'result success';
                document.getElementById('status').innerHTML = '‚úÖ Test completato!';
                
                document.getElementById('stats').innerHTML = \`
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Email Inviate</div>
                            <div class="stat-value">\${emailCount}</div>
                            <div class="stat-label">Ultimi 30 giorni</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Contratti Inviati</div>
                            <div class="stat-value">\${contractCount}</div>
                            <div class="stat-label">Ultimi 30 giorni</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Lead Totali</div>
                            <div class="stat-value">\${leads.length}</div>
                            <div class="stat-label">Database</div>
                        </div>
                    </div>
                \`;
                
                document.getElementById('result').innerHTML = \`
                    <div class="result success">
                        <h3>‚úÖ RISULTATO:</h3>
                        <p><strong>Il calcolo JavaScript funziona correttamente!</strong></p>
                        <p>Se la dashboard mostra 0, il problema √® interferenza con altri script o errori nel caricamento.</p>
                    </div>
                \`;
                
                log('‚úÖ DONE');
                
            } catch (err) {
                log(\`‚ùå ERROR: \${err.message}\`);
                document.getElementById('status').className = 'result error';
                document.getElementById('status').innerHTML = \`‚ùå Errore: \${err.message}\`;
                document.getElementById('result').innerHTML = \`
                    <div class="result error">
                        <h3>‚ùå ERRORE:</h3>
                        <pre>\${err.stack}</pre>
                    </div>
                \`;
            }
        }
        
        test();
    <\/script>
</body>
</html>
  `));I.post("/api/contracts/sign",async o=>{var t;try{const e=await o.req.json(),{contractId:a,signatureData:i,timestamp:s,userAgent:r,screenResolution:l}=e;if(!a||!i)return o.json({success:!1,error:"Dati firma mancanti"},400);if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const c=await o.env.DB.prepare("SELECT * FROM contracts WHERE id = ?").bind(a).first();if(!c)return o.json({success:!1,error:"Contratto non trovato"},404);if(c.status==="SIGNED")return o.json({success:!1,error:"Contratto gi√† firmato"},400);const d=o.req.header("cf-connecting-ip")||o.req.header("x-forwarded-for")||o.req.header("x-real-ip")||"unknown";await o.env.DB.prepare(`
      UPDATE contracts 
      SET status = 'SIGNED',
          signature_data = ?,
          signature_ip = ?,
          signature_timestamp = ?,
          signature_user_agent = ?,
          signature_screen_resolution = ?,
          signed_at = ?,
          signature_method = 'inline'
      WHERE id = ?
    `).bind(i,d,s||new Date().toISOString(),r||"",l||"",new Date().toISOString(),a).run(),console.log(`‚úÖ Contratto firmato: ${a} da IP ${d}`);try{const u=await o.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(c.leadId).first();if(u&&o.env.RESEND_API_KEY){console.log(`üìß Invio email conferma firma a ${u.email}`);const p=`
          ${c.contenuto_html}
          <div style="margin-top: 60px; page-break-inside: avoid;">
            <h2 style="text-align: center; margin-bottom: 40px;">Firme</h2>
            <div style="display: flex; justify-content: space-between; gap: 40px;">
              <div style="flex: 1; text-align: center;">
                <p style="font-weight: bold; margin-bottom: 20px;">Il Cliente</p>
                <img src="${i}" style="max-width: 300px; border: 1px solid #ccc; padding: 10px;">
                <p style="margin-top: 10px; font-size: 12px; color: #666;">
                  Firma digitale apposta il ${new Date(s).toLocaleString("it-IT")}<br>
                  IP: ${d}
                </p>
              </div>
              <div style="flex: 1; text-align: center;">
                <p style="font-weight: bold; margin-bottom: 20px;">Per Medica GB S.r.l.</p>
                <p style="margin-top: 80px; font-size: 14px;">
                  <strong>Stefania Rocca</strong><br>
                  Amministratore Delegato<br>
                  Medica GB S.r.l.
                </p>
                <p style="margin-top: 10px; font-size: 12px; color: #666;">
                  Firma depositata presso sede legale<br>
                  Corso Giuseppe Garibaldi, 34 ‚Äì 20121 Milano
                </p>
              </div>
            </div>
          </div>
        `,g=`
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
              .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
              .content { padding: 30px; }
              .footer { background: #f8f9fa; padding: 20px; text-align: center; font-size: 12px; color: #666; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>‚úÖ Contratto Firmato con Successo</h1>
              <p>TeleMedCare - Servizio eCura</p>
            </div>
            <div class="content">
              <p>Gentile <strong>${u.nomeRichiedente} ${u.cognomeRichiedente}</strong>,</p>
              
              <p>Grazie per aver firmato il contratto <strong>${c.codice_contratto}</strong>!</p>
              
              <p>In allegato trovi:</p>
              <ul>
                <li>üìÑ Copia del contratto firmato digitalmente</li>
                <li>‚úçÔ∏è La tua firma digitale</li>
                <li>üè¢ Controfirma di Medica GB S.r.l.</li>
              </ul>
              
              <p><strong>Dettagli Contratto:</strong></p>
              <ul>
                <li>Servizio: ${c.servizio||"eCura PRO"}</li>
                <li>Piano: ${c.piano||"BASE"}</li>
                <li>Investimento: ‚Ç¨${c.prezzo_totale||"585.60"}/anno</li>
                <li>Data firma: ${new Date().toLocaleDateString("it-IT")}</li>
              </ul>
              
              <p>Il tuo servizio eCura verr√† attivato entro 24-48 ore. Riceverai una email con le istruzioni per configurare il dispositivo SiDLY.</p>
              
              <p>Per qualsiasi domanda, contattaci a <a href="mailto:info@telemedcare.it">info@telemedcare.it</a></p>
              
              <p>Cordiali saluti,<br><strong>Il Team TeleMedCare</strong></p>
            </div>
            <div class="footer">
              <p>Medica GB S.r.l. - Corso Giuseppe Garibaldi, 34 ‚Äì 20121 Milano</p>
              <p>P.IVA: 12435130963 | Email: info@telemedcare.it | Web: www.telemedcare.it</p>
            </div>
          </body>
          </html>
        `,m=await fetch("https://api.resend.com/emails",{method:"POST",headers:{Authorization:`Bearer ${o.env.RESEND_API_KEY}`,"Content-Type":"application/json"},body:JSON.stringify({from:"TeleMedCare <noreply@telemedcare.it>",to:[u.email],cc:["info@telemedcare.it"],subject:`‚úÖ Contratto Firmato - ${c.codice_contratto}`,html:g})});m.ok?console.log(`‚úÖ Email conferma inviata a ${u.email}`):console.error(`‚ùå Errore invio email: ${await m.text()}`)}}catch(u){console.error("‚ö†Ô∏è Errore invio email (firma salvata comunque):",u)}return o.json({success:!0,message:"Contratto firmato con successo",contractId:a})}catch(e){return console.error("‚ùå Errore salvataggio firma:",e),o.json({success:!1,error:"Errore durante il salvataggio della firma",details:e instanceof Error?e.message:String(e)},500)}});const tn=[],bw=100;function Je(o){const t=new Date().toISOString();tn.unshift(`[${t}] ${o}`),tn.length>bw&&tn.pop(),console.log(o)}I.get("/api/debug/logs",async o=>o.json({success:!0,logs:tn,count:tn.length}));I.get("/api/debug/env",async o=>o.json({success:!0,environment:{RESEND_API_KEY:o.env.RESEND_API_KEY?`${o.env.RESEND_API_KEY.substring(0,10)}...`:"NOT SET",SENDGRID_API_KEY:o.env.SENDGRID_API_KEY?`${o.env.SENDGRID_API_KEY.substring(0,10)}...`:"NOT SET",EMAIL_FROM:o.env.EMAIL_FROM||"NOT SET",EMAIL_TO_INFO:o.env.EMAIL_TO_INFO||"NOT SET",JWT_SECRET:o.env.JWT_SECRET?"SET (hidden)":"NOT SET",ENCRYPTION_KEY:o.env.ENCRYPTION_KEY?"SET (hidden)":"NOT SET",DEBUG_MODE:o.env.DEBUG_MODE||"NOT SET",ENVIRONMENT:o.env.ENVIRONMENT||"NOT SET",DB:o.env.DB?"CONNECTED":"NOT CONNECTED"}}));I.post("/api/debug/test-contract-save",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"DB non disponibile"},500);const e=`LEAD-TEST-${Date.now()}`;await o.env.DB.prepare(`
      INSERT INTO leads (
        id, nomeRichiedente, cognomeRichiedente, email, status, created_at, timestamp
      ) VALUES (?, ?, ?, ?, ?, ?, ?)
    `).bind(e,"Test","Contract","test@example.com","NEW",new Date().toISOString(),new Date().toISOString()).run();const a={id:`contract-test-${Date.now()}`,leadId:e,codice_contratto:`TEST-${Date.now()}`,tipo_contratto:"BASE",template_utilizzato:"TEST_TEMPLATE",contenuto_html:"<html><body>TEST</body></html>",status:"PENDING",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),servizio:"eCura PRO",piano:"BASE",prezzo_mensile:40,durata_mesi:12,prezzo_totale:585.6,email_template_used:"test",pdf_generated:0,email_sent:1};console.log("üß™ [DEBUG] Tentativo salvataggio contratto test:",a.id);const i=await o.env.DB.prepare(`
      INSERT INTO contracts (
        id, leadId, codice_contratto, tipo_contratto, 
        template_utilizzato, contenuto_html, 
        pdf_generated, email_sent, email_template_used,
        status, servizio, piano, 
        prezzo_mensile, durata_mesi, prezzo_totale, 
        created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(a.id,a.leadId,a.codice_contratto,a.tipo_contratto,a.template_utilizzato,a.contenuto_html,a.pdf_generated,a.email_sent,a.email_template_used,a.status,a.servizio,a.piano,a.prezzo_mensile,a.durata_mesi,a.prezzo_totale,a.created_at,a.updated_at).run();console.log("‚úÖ [DEBUG] Contratto salvato:",i);const s=await o.env.DB.prepare("SELECT * FROM contracts WHERE id = ?").bind(a.id).first();return o.json({success:!0,message:"Contratto test salvato",testData:a,insertResult:i,savedContract:s})}catch(e){return console.error("‚ùå [DEBUG] Errore:",e),o.json({success:!1,error:e instanceof Error?e.message:String(e),stack:e==null?void 0:e.stack},500)}});I.get("/api/contracts",async o=>{var t,e;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const a=o.req.query("leadId");let i="SELECT * FROM contracts";const s=[];a&&(i+=" WHERE leadId = ?",s.push(a)),i+=" ORDER BY created_at DESC LIMIT 50";const r=o.env.DB.prepare(i),l=s.length>0?await r.bind(...s).all():await r.all();return console.log(`üìã Contratti trovati: ${((e=l.results)==null?void 0:e.length)||0}`),o.json({success:!0,contracts:l.results||[]})}catch(a){return console.error("‚ùå Errore recupero contratti:",a),o.json({success:!1,error:"Errore recupero contratti",details:a instanceof Error?a.message:String(a)},500)}});I.get("/api/contracts/:id",async o=>{var t,e;try{const a=o.req.param("id");if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const i=await o.env.DB.prepare("SELECT * FROM contracts WHERE id = ?").bind(a).first();if(!i)return o.json({success:!1,error:"Contratto non trovato"},404);let s="Cliente",r="",l="";if(i.leadId)try{const c=await o.env.DB.prepare("SELECT nomeRichiedente, cognomeRichiedente, email FROM leads WHERE id = ?").bind(i.leadId).first();c&&(s=c.nomeRichiedente||"Cliente",r=c.cognomeRichiedente||"",l=c.email||"")}catch(c){console.warn("‚ö†Ô∏è  Errore caricamento lead:",c)}return o.json({success:!0,id:i.id,leadId:i.leadId,nomeCliente:s,cognomeCliente:r,emailCliente:l,contractCode:i.codice_contratto||i.id,contractHtml:i.contenuto_html||"",servizio:i.servizio||"eCura PRO",piano:i.tipo_contratto||i.piano||"BASE",dispositivo:(e=i.servizio)!=null&&e.includes("PREMIUM")?"SiDLY Vital Care":"SiDLY Care PRO",prezzo:`‚Ç¨${parseFloat(i.prezzo_totale||i.prezzo_iva_inclusa||0).toFixed(2)}/anno`,status:i.status||"PENDING"})}catch(a){return console.error("‚ùå Errore recupero contratto:",a),o.json({success:!1,error:"Errore recupero contratto",details:a instanceof Error?a.message:String(a)},500)}});I.post("/api/leads",async o=>{var t;try{const e=await o.req.json();if(console.log("üîç [DEBUG POST /api/leads] Payload ricevuto:",JSON.stringify(e,null,2)),console.log("üîç [DEBUG] luogoNascitaAssistito:",e.luogoNascitaAssistito,"type:",typeof e.luogoNascitaAssistito),console.log("üîç [DEBUG] dataNascitaAssistito:",e.dataNascitaAssistito,"type:",typeof e.dataNascitaAssistito),!((t=o.env)!=null&&t.DB))return o.json({success:!0,message:"Lead creato (mock)",id:"LEAD-MOCK-"+Date.now()});if(!e.nomeRichiedente||!e.cognomeRichiedente||!e.email)return o.json({success:!1,error:"Campi obbligatori mancanti: nomeRichiedente, cognomeRichiedente, email"},400);const a=`LEAD-MANUAL-${Date.now()}`,i=new Date().toISOString();await o.env.DB.prepare(`
      INSERT INTO leads (
        id, nomeRichiedente, cognomeRichiedente, 
        email, telefono,
        emailRichiedente, telefonoRichiedente,
        nomeAssistito, cognomeAssistito, 
        luogoNascitaAssistito, dataNascitaAssistito,
        indirizzoAssistito, capAssistito, cittaAssistito, provinciaAssistito,
        cfAssistito, condizioniSalute,
        tipoServizio, servizio, piano,
        vuoleBrochure, vuoleContratto, vuoleManuale,
        gdprConsent,
        intestazioneContratto,
        note, fonte, status, timestamp, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(a,e.nomeRichiedente,e.cognomeRichiedente,e.email,e.telefono||"",e.email,e.telefono||"",e.nomeAssistito||e.nomeRichiedente,e.cognomeAssistito||e.cognomeRichiedente,e.luogoNascitaAssistito??null,e.dataNascitaAssistito??null,e.indirizzoAssistito??null,e.capAssistito??null,e.cittaAssistito??null,e.provinciaAssistito??null,e.cfAssistito??e.codiceFiscaleAssistito??null,e.condizioniSalute||null,e.tipoServizio||e.servizio||"eCura PRO",e.servizio||"eCura PRO",e.piano||"BASE",e.vuoleBrochure||"No",e.vuoleContratto||"No",e.vuoleManuale||"No",e.consensoPrivacy?1:0,e.intestatarioContratto||"richiedente",e.note||"",e.fonte||e.canale||"MANUAL_ENTRY","NEW",i,i).run(),console.log("‚úÖ Lead creato:",a);const s={notifica:{sent:!1,error:null},brochure:{sent:!1,error:null},contratto:{sent:!1,error:null}};try{const r={vuoleBrochure:e.vuoleBrochure,vuoleContratto:e.vuoleContratto,vuoleManuale:e.vuoleManuale};Je(`üîç [LEAD] Dati ricevuti: ${JSON.stringify(r)}`),console.log("üîç [DEBUG] Dati ricevuti:",r);const l={id:a,nomeRichiedente:e.nomeRichiedente,cognomeRichiedente:e.cognomeRichiedente,emailRichiedente:e.email,telefonoRichiedente:e.telefono||"",nomeAssistito:e.nomeAssistito||"",cognomeAssistito:e.cognomeAssistito||"",luogoNascitaAssistito:e.luogoNascitaAssistito||"",dataNascitaAssistito:e.dataNascitaAssistito||"",indirizzoAssistito:e.indirizzoAssistito||"",capAssistito:e.capAssistito||"",cittaAssistito:e.cittaAssistito||"",provinciaAssistito:e.provinciaAssistito||"",cfAssistito:e.codiceFiscaleAssistito||"",condizioniSalute:e.condizioniSalute||"",pacchetto:e.piano||"BASE",servizio:e.servizio||"eCura PRO",intestatarioContratto:e.intestatarioContratto||"richiedente",vuoleBrochure:e.vuoleBrochure==="Si",vuoleManuale:e.vuoleManuale==="Si",vuoleContratto:e.vuoleContratto==="Si",cfRichiedente:e.codiceFiscaleRichiedente||"",indirizzoRichiedente:e.indirizzoRichiedente||"",note:e.note||""},c={vuoleBrochure:l.vuoleBrochure,vuoleContratto:l.vuoleContratto,vuoleManuale:l.vuoleManuale};Je(`üîç [LEAD] leadData mappato: ${JSON.stringify(c)}`),console.log("üîç [DEBUG] leadData mappato:",c);const{inviaEmailNotificaInfo:d,inviaEmailDocumentiInformativi:u,inviaEmailContratto:p}=await Promise.resolve().then(()=>Sp);try{const g=await d(l,o.env,o.env.DB);s.notifica.sent=g.success,g.success||(s.notifica.error=g.errors.join(", ")),console.log("üìß [WORKFLOW] Notifica interno:",g.success?"‚úÖ":"‚ùå")}catch(g){console.error("‚ùå Errore notifica:",g),s.notifica.error=g instanceof Error?g.message:String(g)}if(!l.vuoleContratto&&(l.vuoleBrochure||l.vuoleManuale||!l.vuoleBrochure&&!l.vuoleContratto))try{Je("üìö [LEAD] Invio documenti informativi (no contratto)");const g={};if(!l.vuoleBrochure&&!l.vuoleContratto&&(Je("üìö [LEAD] Default: invia brochure anche se non richiesta"),l.vuoleBrochure=!0),l.vuoleBrochure){const m=l.servizio||"eCura PRO";m.includes("PRO")||m.includes("FAMILY")?g.brochure="/brochures/Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf":m.includes("PREMIUM")&&(g.brochure="/brochures/Medica-GB-SiDLY_Vital_Care_ITA-compresso.pdf")}l.vuoleManuale&&(g.manuale="/documents/Manuale_SiDLY.pdf"),s.brochure.sent=!1,Je("‚ÑπÔ∏è [LEAD] Email brochure separata disabilitata (inclusa in email completamento)"),console.log("üìö [WORKFLOW] Email brochure separata: ‚è≠Ô∏è SKIPPED (inclusa in completamento dati)")}catch(g){console.error("‚ùå Errore documenti:",g);const m=g instanceof Error?g.message:String(g);s.brochure.error=m,Je(`‚ùå [LEAD] Exception documenti: ${m}`)}else l.vuoleContratto&&Je("üìã [LEAD] vuoleContratto=true ‚Üí Skip documenti informativi (inclusi in email contratto)");if(l.vuoleContratto){Je("üìã [LEAD] Contratto richiesto: SI - Procedura attiva");try{const g={contractId:`contract-${Date.now()}`,contractCode:`TMC-${new Date().toISOString().slice(0,7).replace("-","")}-${Math.random().toString(36).substr(2,8).toUpperCase()}`,contractPdfUrl:"",tipoServizio:l.pacchetto||"BASE",servizio:l.servizio||"eCura PRO",prezzoBase:l.pacchetto==="AVANZATO"?840:480,prezzoIvaInclusa:l.pacchetto==="AVANZATO"?1024.8:585.6};Je(`üìã [LEAD] contractData creato: ${g.contractId}`);const m={},v=l.servizio||"eCura PRO";v.includes("PRO")||v.includes("FAMILY")?m.brochure="/brochures/Medica-GB-SiDLY_Care_PRO_ITA_compresso.pdf":v.includes("PREMIUM")&&(m.brochure="/brochures/Medica-GB-SiDLY_Vital_Care_ITA-compresso.pdf"),Je("üìã [LEAD] Chiamata inviaEmailContratto...");const b=await p(l,g,o.env,m,o.env.DB);s.contratto.sent=b.success,b.success?Je("‚úÖ [LEAD] Contratto inviato con successo"):(s.contratto.error=b.errors.join(", "),Je(`‚ùå [LEAD] Errore invio contratto: ${s.contratto.error}`)),console.log("üìã [WORKFLOW] Contratto:",b.success?"‚úÖ":"‚ùå")}catch(g){console.error("‚ùå Errore contratto:",g);const m=g instanceof Error?g.message:String(g);s.contratto.error=m,Je(`‚ùå [LEAD] Exception contratto: ${m}`)}}else Je("‚ö†Ô∏è  [LEAD] Contratto NON richiesto - Skip")}catch(r){console.error("‚ùå Errore generale automazione email:",r)}return o.json({success:!0,message:"Lead creato con successo",id:a,leadId:a,lead:{id:a,nomeRichiedente:e.nomeRichiedente,cognomeRichiedente:e.cognomeRichiedente,email:e.email},emails:s,emailAutomation:s})}catch(e){return console.error("‚ùå Errore creazione lead:",e),o.json({success:!1,error:"Errore creazione lead",details:e instanceof Error?e.message:String(e)},500)}});I.delete("/api/leads/:id",async o=>{var e;const t=o.req.param("id");try{if(!((e=o.env)!=null&&e.DB))return o.json({success:!0,message:"Lead eliminato (mock)"});if(!await o.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(t).first())return o.json({success:!1,error:"Lead non trovato"},404);try{const i=await o.env.DB.prepare("SELECT COUNT(*) as count FROM contracts WHERE lead_id = ?").bind(t).first();if(i&&i.count>0)return o.json({success:!1,error:"Impossibile eliminare: lead ha contratti associati",hasContracts:!0},400)}catch(i){console.warn("‚ö†Ô∏è Tabella contratti non trovata, skip controllo:",i)}return await o.env.DB.prepare("DELETE FROM leads WHERE id = ?").bind(t).run(),console.log("‚úÖ Lead eliminato:",t),o.json({success:!0,message:"Lead eliminato con successo",id:t})}catch(a){return console.error("‚ùå Errore eliminazione lead:",a),o.json({success:!1,error:"Errore eliminazione lead",details:a instanceof Error?a.message:String(a)},500)}});I.post("/api/leads/cleanup-wrong-imports",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const e=o.req.query("minLeadId")||"LEAD-IRBEMA-00146",a=parseInt(o.req.query("hoursAgo")||"24");console.log(`üßπ Cleanup lead sbagliati: minLeadId >= ${e}, creati > ${a}h fa`);const i=new Date;i.setHours(i.getHours()-a);const s=i.toISOString();console.log(`‚è∞ Cancello lead creati PRIMA del: ${s}`);const r=await o.env.DB.prepare(`
      SELECT id, email, emailRichiedente, nomeRichiedente, cognomeRichiedente, created_at
      FROM leads 
      WHERE id >= ? 
        AND fonte = 'IRBEMA'
        AND created_at < ?
      ORDER BY id
    `).bind(e,s).all();if(!r.results||r.results.length===0)return o.json({success:!0,message:"Nessun lead da cancellare",deleted:0,cutoffDate:s});console.log(`üóëÔ∏è Trovati ${r.results.length} lead da cancellare`);const l=[],c=[];for(const d of r.results)try{try{const u=await o.env.DB.prepare("SELECT COUNT(*) as count FROM contracts WHERE lead_id = ?").bind(d.id).first();if(u&&u.count>0){console.warn(`‚ö†Ô∏è Skip ${d.id}: ha ${u.count} contratti associati`),c.push({id:d.id,email:d.email||d.emailRichiedente,error:"Ha contratti associati"});continue}}catch{console.log(`‚ÑπÔ∏è Tabella contratti non trovata per ${d.id}, procedo con cancellazione`)}await o.env.DB.prepare("DELETE FROM leads WHERE id = ?").bind(d.id).run(),l.push(d.id),console.log(`‚úÖ Cancellato: ${d.id} - ${d.email||d.emailRichiedente}`)}catch(u){console.error(`‚ùå Errore cancellazione ${d.id}:`,u),c.push({id:d.id,email:d.email||d.emailRichiedente,error:u instanceof Error?u.message:String(u)})}return console.log(`üéâ Cleanup completato: ${l.length} cancellati, ${c.length} errori`),o.json({success:!0,message:`Cleanup completato: ${l.length} lead cancellati`,deleted:l.length,deletedIds:l,errors:c,cutoffDate:s,criteria:{minLeadId:e,hoursAgo:a,cutoffTimestamp:s}})}catch(e){return console.error("‚ùå Errore cleanup lead:",e),o.json({success:!1,error:"Errore cleanup lead",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/leads/fix-prices",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);console.log("üîß Avvio correzione prezzi per tutti i lead...");const{calculatePrice:e}=await Promise.resolve().then(()=>p0),a=await o.env.DB.prepare(`
      SELECT 
        id, servizio, piano, tipoServizio,
        prezzo_anno, prezzo_rinnovo
      FROM leads
      ORDER BY created_at DESC
    `).all();if(!a.results||a.results.length===0)return o.json({success:!0,message:"Nessun lead da correggere",total:0,corrected:0,skipped:0,errors:[]});console.log(`üìä Trovati ${a.results.length} lead totali`);let i=0,s=0;const r=[];for(const c of a.results)try{let d="PRO",u="BASE";if(c.servizio){const g=c.servizio.match(/eCura\s+(FAMILY|PRO|PREMIUM)/i);g&&(d=g[1].toUpperCase())}else if(c.tipoServizio){const g=c.tipoServizio.match(/eCura\s+(FAMILY|PRO|PREMIUM)/i);g&&(d=g[1].toUpperCase())}c.piano&&(u=c.piano.toUpperCase());const p=e(d,u);if(c.prezzo_anno===p.setupBase&&c.prezzo_rinnovo===p.rinnovoBase){s++;continue}await o.env.DB.prepare(`
          UPDATE leads
          SET 
            prezzo_anno = ?,
            prezzo_rinnovo = ?
          WHERE id = ?
        `).bind(p.setupBase,p.rinnovoBase,c.id).run(),i++,console.log(`‚úÖ Lead ${c.id} corretto: ${d} ${u} ‚Üí ${p.setupBase}‚Ç¨`)}catch(d){r.push({leadId:c.id,error:d instanceof Error?d.message:String(d)}),console.error(`‚ùå Errore lead ${c.id}:`,d)}const l={success:!0,message:`Correzione prezzi completata: ${i} corretti, ${s} gi√† corretti, ${r.length} errori`,total:a.results.length,corrected:i,skipped:s,errors:r.length>0?r:void 0};return console.log("üéâ Correzione prezzi completata:",l),o.json(l)}catch(e){return console.error("‚ùå Errore correzione prezzi:",e),o.json({success:!1,error:"Errore correzione prezzi",details:e instanceof Error?e.message:String(e)},500)}});I.get("/api/settings",zg);I.get("/api/settings/:key",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const e=o.req.param("key"),{getSetting:a}=await Promise.resolve().then(()=>Ng),i=await a(o.env.DB,e);return i==null?o.json({success:!1,error:`Setting '${e}' non trovato`,setting:null},404):o.json({success:!0,setting:{key:e,value:i==="true"||i===!0?"true":"false",enabled:i==="true"||i===!0}})}catch(e){return console.error(`‚ùå Errore lettura setting ${o.req.param("key")}:`,e),o.json({success:!1,error:e.message},500)}});I.put("/api/settings/:key",Lg);I.post("/api/db/migrate",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);console.log("üîß Esecuzione migrazioni database...");try{await o.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS assistiti (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          codice TEXT UNIQUE NOT NULL,
          nome TEXT NOT NULL,
          email TEXT,
          telefono TEXT,
          imei TEXT UNIQUE,
          status TEXT DEFAULT 'ATTIVO',
          lead_id TEXT,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
      `).run(),console.log("‚úÖ Tabella assistiti creata")}catch{console.log("‚ÑπÔ∏è Tabella assistiti gi√† esistente")}const e=[{name:"nome_assistito",type:"TEXT"},{name:"cognome_assistito",type:"TEXT"},{name:"nome_caregiver",type:"TEXT"},{name:"cognome_caregiver",type:"TEXT"},{name:"parentela_caregiver",type:"TEXT"}];for(const i of e)try{await o.env.DB.prepare(`
          ALTER TABLE assistiti ADD COLUMN ${i.name} ${i.type}
        `).run(),console.log(`‚úÖ Colonna ${i.name} aggiunta a assistiti`)}catch{console.log(`‚ÑπÔ∏è Colonna ${i.name} gi√† esistente in assistiti`)}try{await o.env.DB.prepare(`
        UPDATE assistiti 
        SET nome_assistito = CASE 
          WHEN nome_assistito IS NULL AND nome LIKE '% %' 
          THEN substr(nome, 1, instr(nome, ' ') - 1)
          WHEN nome_assistito IS NULL 
          THEN nome
          ELSE nome_assistito
        END,
        cognome_assistito = CASE 
          WHEN cognome_assistito IS NULL AND nome LIKE '% %' 
          THEN substr(nome, instr(nome, ' ') + 1)
          ELSE cognome_assistito
        END
        WHERE nome_assistito IS NULL OR cognome_assistito IS NULL
      `).run(),console.log("‚úÖ Dati migrati da nome a nome_assistito/cognome_assistito")}catch{console.log("‚ÑπÔ∏è Migrazione dati assistiti gi√† effettuata")}try{await o.env.DB.prepare(`
        ALTER TABLE contracts ADD COLUMN imei_dispositivo TEXT
      `).run(),console.log("‚úÖ Colonna imei_dispositivo aggiunta a contracts")}catch{console.log("‚ÑπÔ∏è Colonna imei_dispositivo gi√† esistente")}const a=[{name:"codice_contratto",type:"TEXT"},{name:"tipo_contratto",type:"TEXT"},{name:"status",type:'TEXT DEFAULT "DRAFT"'},{name:"prezzo_totale",type:"INTEGER"},{name:"created_at",type:"DATETIME DEFAULT CURRENT_TIMESTAMP"}];for(const i of a)try{await o.env.DB.prepare(`
          ALTER TABLE contracts ADD COLUMN ${i.name} ${i.type}
        `).run(),console.log(`‚úÖ Colonna ${i.name} aggiunta a contracts`)}catch{console.log(`‚ÑπÔ∏è Colonna ${i.name} gi√† esistente`)}try{await o.env.DB.prepare(`
        ALTER TABLE contracts ADD COLUMN piano TEXT
      `).run(),console.log("‚úÖ Colonna piano aggiunta a contracts")}catch{console.log("‚ÑπÔ∏è Colonna piano gi√† esistente in contracts")}try{await o.env.DB.prepare(`
        UPDATE contracts 
        SET piano = CASE 
          WHEN prezzo_totale >= 800 THEN 'AVANZATO'
          ELSE 'BASE'
        END
        WHERE piano IS NULL AND prezzo_totale IS NOT NULL
      `).run(),console.log("‚úÖ Campo piano aggiornato nei contratti")}catch(i){console.log("‚ö†Ô∏è Errore aggiornamento piano contratti:",i)}return o.json({success:!0,message:"Migrazioni completate",migrations:["Tabella assistiti creata","Colonna imei_dispositivo aggiunta a contracts","Colonne aggiuntive verificate in contracts","Colonna piano aggiunta e aggiornata in contracts"]})}catch(e){return console.error("‚ùå Errore migrazioni:",e),o.json({success:!1,error:"Errore esecuzione migrazioni",details:e instanceof Error?e.message:String(e)},500)}});I.get("/api/hubspot/test",async o=>{var t,e;try{const{HubSpotClient:a}=await Promise.resolve().then(()=>Fr),i=(t=o.env)==null?void 0:t.HUBSPOT_ACCESS_TOKEN,s=(e=o.env)==null?void 0:e.HUBSPOT_PORTAL_ID;if(!i||!s)return o.json({success:!1,error:"Credenziali HubSpot non configurate",missing:{accessToken:!i,portalId:!s}},500);const l=await new a(i,s).testConnection();return o.json(l)}catch(a){return console.error("‚ùå Test HubSpot error:",a),o.json({success:!1,message:`Errore test HubSpot: ${a.message}`},500)}});I.get("/api/hubspot/contacts",async o=>{var t,e;try{const{HubSpotClient:a}=await Promise.resolve().then(()=>Fr),i=(t=o.env)==null?void 0:t.HUBSPOT_ACCESS_TOKEN,s=(e=o.env)==null?void 0:e.HUBSPOT_PORTAL_ID;if(!i||!s)return o.json({success:!1,error:"Credenziali HubSpot non configurate"},500);const r=new a(i,s),l=parseInt(o.req.query("limit")||"100"),c=o.req.query("after");console.log(`üìä [HUBSPOT] Fetching contacts (limit: ${l})`);const d=await r.getContacts({limit:l,after:c});return console.log(`‚úÖ [HUBSPOT] Trovati ${d.results.length} contatti (totale: ${d.total})`),o.json({success:!0,total:d.total,count:d.results.length,contacts:d.results,paging:d.paging})}catch(a){return console.error("‚ùå Get HubSpot contacts error:",a),o.json({success:!1,error:a.message},500)}});I.post("/api/hubspot/search",async o=>{var t,e;try{const{HubSpotClient:a}=await Promise.resolve().then(()=>Fr),i=(t=o.env)==null?void 0:t.HUBSPOT_ACCESS_TOKEN,s=(e=o.env)==null?void 0:e.HUBSPOT_PORTAL_ID;if(!i||!s)return o.json({success:!1,error:"Credenziali HubSpot non configurate"},500);const r=await o.req.json(),l=new a(i,s);console.log("üîç [HUBSPOT] Ricerca contatti con filtri:",r);const c=await l.searchContacts(r);return console.log(`‚úÖ [HUBSPOT] Trovati ${c.results.length} contatti`),o.json({success:!0,total:c.total,count:c.results.length,contacts:c.results,paging:c.paging})}catch(a){return console.error("‚ùå Search HubSpot contacts error:",a),o.json({success:!1,error:a.message},500)}});I.get("/api/hubspot/contacts/recent",async o=>{var t,e;try{const{HubSpotClient:a}=await Promise.resolve().then(()=>Fr),i=(t=o.env)==null?void 0:t.HUBSPOT_ACCESS_TOKEN,s=(e=o.env)==null?void 0:e.HUBSPOT_PORTAL_ID;if(!i||!s)return o.json({success:!1,error:"Credenziali HubSpot non configurate"},500);const r=parseInt(o.req.query("days")||"7"),l=parseInt(o.req.query("limit")||"100"),c=new Date;c.setDate(c.getDate()-r);const d=new a(i,s);console.log(`üìÖ [HUBSPOT] Fetching contacts created after ${c.toISOString()}`);const u=await d.searchContacts({createdAfter:c.toISOString(),limit:l});return console.log(`‚úÖ [HUBSPOT] Trovati ${u.results.length} contatti recenti`),o.json({success:!0,period:`Ultimi ${r} giorni`,from:c.toISOString(),total:u.total,count:u.results.length,contacts:u.results})}catch(a){return console.error("‚ùå Get recent HubSpot contacts error:",a),o.json({success:!1,error:a.message},500)}});I.post("/api/hubspot/sync",async o=>{var t,e,a;try{const{HubSpotClient:i,mapHubSpotContactToLead:s}=await Promise.resolve().then(()=>Fr);if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const r=(e=o.env)==null?void 0:e.HUBSPOT_ACCESS_TOKEN,l=(a=o.env)==null?void 0:a.HUBSPOT_PORTAL_ID;if(!r||!l)return o.json({success:!1,error:"Credenziali HubSpot non configurate"},500);const c=await o.req.json(),d=c.days||7,u=c.dryRun||!1,p=c.onlyEcura!==!1,g=new i(r,l),m=new Date;m.setDate(m.getDate()-d),console.log(`üîÑ [HUBSPOT SYNC] Inizio sincronizzazione ultimi ${d} giorni (dryRun: ${u}, onlyEcura: ${p})`);const v={createdAfter:m.toISOString(),limit:100};p&&(v.hs_object_source_detail_1="Form eCura",console.log("üîç [HUBSPOT SYNC] Filtro attivo: solo lead da Form eCura"));const b=await g.searchContacts(v);console.log(`üìä [HUBSPOT SYNC] Trovati ${b.results.length} contatti da sincronizzare`);const E={total:b.results.length,created:0,skipped:0,errors:[]};for(const T of b.results)try{if(await o.env.DB.prepare(`
          SELECT id FROM leads 
          WHERE email = ? OR external_source_id = ?
          LIMIT 1
        `).bind(T.properties.email,T.id).first()){console.log(`‚è≠Ô∏è  [HUBSPOT SYNC] Contact ${T.id} gi√† esistente, skip`),E.skipped++;continue}if(u){console.log(`üîç [DRY RUN] Contatto ${T.id} sarebbe stato importato`),E.created++;continue}const S=s(T),C=await o.env.DB.prepare(`
          SELECT id FROM leads 
          WHERE id LIKE 'LEAD-IRBEMA-%' 
          ORDER BY id DESC 
          LIMIT 1
        `).first();let M=146;if(C!=null&&C.id){const j=C.id.match(/LEAD-IRBEMA-(\d+)/);j&&(M=parseInt(j[1])+1)}const B=`LEAD-IRBEMA-${M.toString().padStart(5,"0")}`;console.log(`üÜî [HUBSPOT SYNC] Generato ID: ${B}`),await o.env.DB.prepare(`
          INSERT INTO leads (
            id, nomeRichiedente, cognomeRichiedente, email, telefono,
            nomeAssistito, cognomeAssistito,
            servizio, piano, tipoServizio,
            prezzo_anno, prezzo_rinnovo,
            fonte, external_source_id, status, note,
            vuoleContratto, vuoleBrochure, vuoleManuale,
            consensoPrivacy, consensoMarketing, consensoTerze,
            created_at, updated_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(B,S.nomeRichiedente,S.cognomeRichiedente,S.email,S.telefono,S.nomeAssistito,S.cognomeAssistito,S.servizio,S.piano,S.tipoServizio||S.servizio||"eCura PRO",S.prezzo_anno||null,S.prezzo_rinnovo||null,S.fonte,S.external_source_id,S.status,S.note,S.vuoleContratto,S.vuoleBrochure,S.vuoleManuale,S.consensoPrivacy?1:0,S.consensoMarketing?1:0,S.consensoTerze?1:0,new Date().toISOString(),new Date().toISOString()).run(),console.log(`‚úÖ [HUBSPOT SYNC] Lead creato: ${B} from HubSpot ${T.id}`),E.created++}catch(R){console.error(`‚ùå [HUBSPOT SYNC] Errore sync contact ${T.id}:`,R),E.errors.push({contactId:T.id,email:T.properties.email,error:R.message})}return console.log(`‚úÖ [HUBSPOT SYNC] Completato: ${E.created} creati, ${E.skipped} skipped, ${E.errors.length} errori`),o.json({success:!0,message:u?"Dry run completato (nessun dato salvato)":"Sincronizzazione completata",period:`Ultimi ${d} giorni`,dryRun:u,results:E})}catch(i){return console.error("‚ùå HubSpot sync error:",i),o.json({success:!1,error:i.message},500)}});I.post("/api/hubspot/auto-import",async o=>{var t,e;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const{executeAutoImport:a,logAutoImport:i}=await Promise.resolve().then(()=>Qw),s=await o.req.json().catch(()=>({})),r={enabled:s.enabled!==!1,startHour:s.startHour||9,onlyEcura:s.onlyEcura!==!1,dryRun:s.dryRun||!1};console.log(`üîÑ [AUTO-IMPORT API] Richiesta import incrementale (dryRun: ${r.dryRun})`);const l=((e=o.env)==null?void 0:e.PUBLIC_URL)||"https://telemedcare-v12.pages.dev",c=await a(o.env.DB,o.env,l,r);if(c.success&&c.imported>0&&!r.dryRun)try{console.log(`üí∞ [AUTO-IMPORT API] Eseguo fix automatico prezzi per ${c.imported} nuovi lead...`);const d=await fetch(`${l}/api/leads/fix-prices`,{method:"POST",headers:{"Content-Type":"application/json"}});if(d.ok){const u=await d.json();console.log(`‚úÖ [AUTO-IMPORT API] Fix prezzi completato: ${u.corrected} corretti`)}}catch(d){console.error("‚ö†Ô∏è [AUTO-IMPORT API] Errore fix prezzi:",d)}return c.success&&!r.dryRun&&await i(o.env.DB,c),o.json(c)}catch(a){return console.error("‚ùå Auto-import API error:",a),o.json({success:!1,error:a.message},500)}});I.get("/api/hubspot/auto-import/status",async o=>{try{return o.json({success:!0,hasRun:!0,message:"Status endpoint disabled (use console logs for monitoring)",note:"Auto-import runs on every dashboard load, check browser console for logs"})}catch(t){return console.error("‚ùå Auto-import status error:",t),o.json({success:!1,error:t.message},500)}});I.get("/api/system/config",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const{getSystemConfig:e}=await Promise.resolve().then(()=>Mt),a=await e(o.env.DB);return o.json({success:!0,config:a})}catch(e){return console.error("‚ùå Get system config error:",e),o.json({success:!1,error:e.message},500)}});I.post("/api/system/config",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const e=await o.req.json(),{updateSystemConfig:a}=await Promise.resolve().then(()=>Mt);for(const[r,l]of Object.entries(e))await a(o.env.DB,r,l);const{getSystemConfig:i}=await Promise.resolve().then(()=>Mt),s=await i(o.env.DB);return console.log("‚úÖ System config updated:",s),o.json({success:!0,config:s})}catch(e){return console.error("‚ùå Update system config error:",e),o.json({success:!1,error:e.message},500)}});I.post("/api/leads/:leadId/request-completion",async o=>{var t,e,a;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const i=o.req.param("leadId"),{createCompletionToken:s,getMissingFields:r,isLeadComplete:l,getSystemConfig:c}=await Promise.resolve().then(()=>Mt),d=await o.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(i).first();if(!d)return o.json({success:!1,error:"Lead non trovato"},404);if(l(d))return o.json({success:!1,error:"Lead gi√† completo, nessun campo mancante"},400);const u=await c(o.env.DB),p=await s(o.env.DB,i,u.auto_completion_token_days),g=((e=o.env)==null?void 0:e.PUBLIC_URL)||"https://telemedcare-v12.pages.dev",m=`${g}/completa-dati-minimal.html?leadId=${i}`,{missing:v,available:b}=r(d),E=o.req.query("sendEmail")==="true"||u.auto_completion_enabled;if(E){const{EmailService:T}=await Promise.resolve().then(()=>Dt),{loadEmailTemplate:R,renderTemplate:S}=await Promise.resolve().then(()=>Ec),C=new T(o.env),M=await R("email_richiesta_completamento_form",o.env.DB,o.env),B=Object.entries(b).map(([$,O])=>({FIELD_LABEL:$,FIELD_VALUE:O})),j={telefono:{label:"Telefono",type:"tel",placeholder:"+39 3XX XXX XXXX",required:!0},telefonoRichiedente:{label:"Telefono",type:"tel",placeholder:"+39 3XX XXX XXXX",required:!0},cittaRichiedente:{label:"Citt√†",type:"text",placeholder:"Es. Milano",required:!0},citta:{label:"Citt√†",type:"text",placeholder:"Es. Milano",required:!0},nomeAssistito:{label:"Nome Assistito",type:"text",placeholder:"Nome",required:!0},cognomeAssistito:{label:"Cognome Assistito",type:"text",placeholder:"Cognome",required:!0},dataNascitaAssistito:{label:"Data Nascita Assistito",type:"date",placeholder:"",required:!0},cittaAssistito:{label:"Citt√† Assistito",type:"text",placeholder:"Es. Roma",required:!0},cfAssistito:{label:"Codice Fiscale Assistito",type:"text",placeholder:"Es. RSSMRA85M01H501X",required:!1},indirizzoAssistito:{label:"Indirizzo Assistito",type:"text",placeholder:"Via, numero civico",required:!1},servizio:{label:"Servizio",type:"select",required:!0,options:[{value:"eCura FAMILY",label:"eCura FAMILY - Monitoraggio base"},{value:"eCura PRO",label:"eCura PRO - Assistenza completa"},{value:"eCura PREMIUM",label:"eCura PREMIUM - Assistenza avanzata"}]},piano:{label:"Piano",type:"select",required:!0,options:[{value:"BASE",label:"BASE - Mensile"},{value:"AVANZATO",label:"AVANZATO - Trimestrale (sconto 5%)"}]}},N=v.map($=>{const O=j[$]||{label:$.charAt(0).toUpperCase()+$.slice(1),type:"text",placeholder:"",required:!1};return{FIELD_ID:$,FIELD_NAME:$,FIELD_LABEL:O.label,INPUT_TYPE:O.type,PLACEHOLDER:O.placeholder||"",IS_REQUIRED:O.required,IS_INPUT:O.type!=="select"&&O.type!=="textarea",IS_SELECT:O.type==="select",IS_TEXTAREA:O.type==="textarea",OPTIONS:O.options||[]}}),D={NOME_CLIENTE:d.nomeRichiedente,COGNOME_CLIENTE:d.cognomeRichiedente,SERVIZIO:d.servizio||d.tipoServizio||"eCura PRO",PIANO:d.piano||d.pacchetto||"BASE",LEAD_ID:i,API_ENDPOINT:g,COMPLETION_URL:m,BROCHURE_URL:`${g}/assets/brochures/brochure-ecura.pdf`,EXPIRES_IN_DAYS:u.auto_completion_token_days.toString(),AVAILABLE_FIELDS:B,MISSING_FIELDS:N},Y=S(M,D);try{await C.sendEmail({to:d.email||d.emailRichiedente,from:((a=o.env)==null?void 0:a.EMAIL_FROM)||"info@telemedcare.it",subject:"üìù Completa la tua richiesta eCura - Ultimi dettagli necessari",html:Y,text:`Gentile ${d.nomeRichiedente}, per completare la tua richiesta eCura abbiamo bisogno di alcuni dati aggiuntivi. Rispondi a questa email o contattaci a info@telemedcare.it`}),console.log(`‚úÖ Email completamento inviata a ${d.email}`);const{logCompletionAction:$}=await Promise.resolve().then(()=>Mt);await $(o.env.DB,i,p.id,"email_sent",`Email inviata a ${d.email}`)}catch($){console.error("‚ùå Errore invio email completamento:",$)}}return o.json({success:!0,message:E?"Token creato e email inviata":"Token creato (email non inviata)",token:{id:p.id,completionUrl:m,expiresAt:p.expires_at,expiresInDays:u.auto_completion_token_days},missingFields:v,availableFields:b})}catch(i){return console.error("‚ùå Request completion error:",i),o.json({success:!1,error:i.message},500)}});I.get("/api/completion/validate/:token",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const e=o.req.param("token"),{validateCompletionToken:a,getMissingFields:i}=await Promise.resolve().then(()=>Mt),s=await a(o.env.DB,e);if(!s.valid)return o.json({success:!1,error:s.error},400);const r=await o.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(s.tokenData.lead_id).first();if(!r)return o.json({success:!1,error:"Lead non trovato"},404);const{missing:l,available:c}=i(r);return o.json({success:!0,lead:{id:r.id,nomeRichiedente:r.nomeRichiedente,cognomeRichiedente:r.cognomeRichiedente,email:r.email||r.emailRichiedente,telefono:r.telefono,servizio:r.servizio||r.tipoServizio,piano:r.piano||r.pacchetto,nomeAssistito:r.nomeAssistito,cognomeAssistito:r.cognomeAssistito,dataNascitaAssistito:r.dataNascitaAssistito,luogoNascitaAssistito:r.luogoNascitaAssistito,codiceFiscaleAssistito:r.codiceFiscaleAssistito,indirizzoAssistito:r.indirizzoAssistito,condizioniSalute:r.condizioniSalute},missingFields:l,availableFields:c,tokenId:s.tokenData.id})}catch(e){return console.error("‚ùå Validate completion token error:",e),o.json({success:!1,error:e.message},500)}});I.post("/api/leads/complete",async o=>{var t,e,a,i,s;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const r=await o.req.json(),{token:l,leadData:c}=r;if(!l)return o.json({success:!1,error:"Token mancante"},400);const{validateCompletionToken:d,markTokenAsCompleted:u}=await Promise.resolve().then(()=>Mt),p=await d(o.env.DB,l);if(!p.valid)return o.json({success:!1,error:p.error},400);const g=p.tokenData.lead_id;await o.env.DB.prepare(`
      UPDATE leads
      SET 
        telefono = COALESCE(?, telefono),
        nomeAssistito = COALESCE(?, nomeAssistito),
        cognomeAssistito = COALESCE(?, cognomeAssistito),
        dataNascitaAssistito = COALESCE(?, dataNascitaAssistito),
        luogoNascitaAssistito = COALESCE(?, luogoNascitaAssistito),
        codiceFiscaleAssistito = COALESCE(?, codiceFiscaleAssistito),
        indirizzoAssistito = COALESCE(?, indirizzoAssistito),
        condizioniSalute = COALESCE(?, condizioniSalute),
        updated_at = datetime('now')
      WHERE id = ?
    `).bind(c.telefono,c.nomeAssistito,c.cognomeAssistito,c.dataNascitaAssistito,c.luogoNascitaAssistito,c.codiceFiscaleAssistito,c.indirizzoAssistito,c.condizioniSalute,g).run(),await u(o.env.DB,p.tokenData.id),console.log(`‚úÖ Lead ${g} completato con successo`);const m=await o.env.DB.prepare("SELECT * FROM leads WHERE id = ?").bind(g).first(),{getSetting:v}=await Promise.resolve().then(()=>Ng),b=await v(o.env.DB,"auto_contract_workflow_enabled");if(b&&m){console.log(`üöÄ [WORKFLOW] Avvio workflow automatico per lead ${g}`);try{const{EmailService:E}=await Promise.resolve().then(()=>Dt),{loadEmailTemplate:T,renderTemplate:R}=await Promise.resolve().then(()=>Ec),S=new E(o.env);if(m.vuoleBrochure==="Si"||m.vuoleBrochure===!0||m.vuoleBrochure===1)try{const C=await T("email_brochure",o.env.DB,o.env),M=R(C,{NOME_CLIENTE:m.nomeRichiedente,COGNOME_CLIENTE:m.cognomeRichiedente,SERVIZIO:m.servizio||"eCura PRO",BROCHURE_URL:"https://telemedcare-v12.pages.dev/assets/brochures/brochure-ecura.pdf"});await S.sendEmail({to:m.email||m.emailRichiedente,from:((e=o.env)==null?void 0:e.EMAIL_FROM)||"info@telemedcare.it",subject:"üìÑ Brochure eCura - Documentazione Completa",html:M,text:`Gentile ${m.nomeRichiedente}, in allegato trova la brochure completa del servizio eCura.`}),console.log(`‚úÖ [WORKFLOW] Brochure inviata a ${m.email}`)}catch(C){console.error("‚ö†Ô∏è [WORKFLOW] Errore invio brochure:",C)}if(m.vuoleContratto==="Si"||m.vuoleContratto===!0||m.vuoleContratto===1)try{const C=await T("email_invio_contratto",o.env.DB,o.env),M=R(C,{NOME_CLIENTE:m.nomeRichiedente,COGNOME_CLIENTE:m.cognomeRichiedente,SERVIZIO:m.servizio||"eCura PRO",PIANO:m.piano||"BASE",PREZZO_ANNO:m.prezzo_anno||480,CONTRACT_URL:`https://telemedcare-v12.pages.dev/contract/${g}`});await S.sendEmail({to:m.email||m.emailRichiedente,from:((a=o.env)==null?void 0:a.EMAIL_FROM)||"info@telemedcare.it",subject:"üìù Contratto eCura - Pronto per la Firma",html:M,text:`Gentile ${m.nomeRichiedente}, il contratto eCura √® pronto per la firma.`}),console.log(`‚úÖ [WORKFLOW] Contratto inviato a ${m.email}`)}catch(C){console.error("‚ö†Ô∏è [WORKFLOW] Errore invio contratto:",C)}}catch(E){console.error("‚ö†Ô∏è [WORKFLOW] Errore workflow automatico:",E)}}else console.log(`‚ÑπÔ∏è [WORKFLOW] Workflow automatico disabilitato (auto_contract_workflow_enabled=${b})`);try{const{EmailService:E}=await Promise.resolve().then(()=>Dt);await new E(o.env).sendEmail({to:((i=o.env)==null?void 0:i.EMAIL_TO_INFO)||"info@telemedcare.it",from:((s=o.env)==null?void 0:s.EMAIL_FROM)||"info@telemedcare.it",subject:`‚úÖ Lead Completato: ${m.nomeRichiedente} ${m.cognomeRichiedente}`,html:`
          <h2>‚úÖ Lead Completato con Successo</h2>
          <p><strong>Lead ID:</strong> ${g}</p>
          <p><strong>Nome:</strong> ${m.nomeRichiedente} ${m.cognomeRichiedente}</p>
          <p><strong>Email:</strong> ${m.email}</p>
          <p><strong>Telefono:</strong> ${m.telefono}</p>
          <p><strong>Servizio:</strong> ${m.servizio} ${m.piano}</p>
          <hr>
          <p>Il lead ha completato i dati mancanti e ora √® pronto per l'attivazione.</p>
          <p><a href="https://telemedcare-v12.pages.dev/leads">Visualizza nella Dashboard</a></p>
        `,text:`Lead ${g} completato: ${m.nomeRichiedente} ${m.cognomeRichiedente}`}),console.log("‚úÖ Notifica completamento inviata a info@telemedcare.it")}catch(E){console.error("‚ö†Ô∏è Errore invio notifica completamento:",E)}return o.json({success:!0,message:"Dati completati con successo!",leadId:g})}catch(r){return console.error("‚ùå Complete lead error:",r),o.json({success:!1,error:r.message},500)}});const Hm=new Map;I.post("/api/cron/send-reminders",async o=>{try{const t=o.env.DB,e=o.env;if(!t)return o.json({success:!1,error:"Database non configurato"},500);const a=o.req.header("Authorization"),i=e.CRON_SECRET;if(i&&a!==`Bearer ${i}`)return console.log("‚ö†Ô∏è [CRON] Tentativo non autorizzato"),o.json({success:!1,error:"Non autorizzato"},401);const s=Date.now(),r=Hm.get("send-reminders")||0,l=3600*1e3;if(s-r<l){const u=Math.floor((s-r)/1e3/60);return console.log(`‚ö†Ô∏è [CRON] Esecuzione gi√† avvenuta ${u} minuti fa - skip`),o.json({success:!0,message:"Esecuzione recente gi√† completata",lastExecution:new Date(r).toISOString(),minutesAgo:u},429)}Hm.set("send-reminders",s),console.log("üîî [CRON] Avvio processo reminder...");const{processReminders:c}=await Promise.resolve().then(()=>Mt),d=await c(t,e);return d.disabled?(console.log("‚ö†Ô∏è [CRON] Cron disabilitato - nessuna azione"),o.json({success:!0,message:"Cron disabilitato dalla dashboard",stats:d},204)):(console.log(`‚úÖ [CRON] Processo reminder completato: ${d.success}/${d.total} successo, ${d.failed} falliti`),o.json({success:!0,message:"Processo reminder completato",stats:d}))}catch(t){return console.error("‚ùå [CRON] Errore processo reminder:",t),o.json({success:!1,error:t.message},500)}});I.get("/api/cron/send-reminders",async o=>{try{const t=o.env.DB,e=o.env,a=o.req.header("Authorization"),i=e.CRON_SECRET||"test-secret-change-in-production";if(e.ENVIRONMENT==="production"&&a!==`Bearer ${i}`)return o.json({success:!1,error:"Unauthorized"},401);if(!t)return o.json({success:!1,error:"Database non configurato"},500);console.log("üîî [CRON] Avvio processo reminder (GET)...");const{processReminders:s}=await Promise.resolve().then(()=>Mt),r=await s(t,e);return r.disabled?(console.log("‚ö†Ô∏è [CRON] Cron disabilitato - nessuna azione"),o.json({success:!0,message:"Cron disabilitato dalla dashboard",stats:r},204)):(console.log(`‚úÖ [CRON] Processo reminder completato: ${r.success}/${r.total}`),o.json({success:!0,message:"Processo reminder completato",stats:r}))}catch(t){return console.error("‚ùå [CRON] Errore processo reminder:",t),o.json({success:!1,error:t.message},500)}});I.post("/api/init-workflow-leads",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);console.log("üöÄ Inizializzazione lead workflow manager...");const e=[{nome:"Eileen Elisabeth",cognome:"King",email:"",telefono:"+393475951175",servizio:"eCura PRO",piano:"AVANZATO",status:"CONTRACT_SIGNED",note:"Piano: AVANZATO - Care Giver: Elena Saglia (figlia) - IMEI: 868298061208378"},{nome:"Giuseppina",cognome:"Cozzi",email:"",telefono:"+393313809634",servizio:"eCura PRO",piano:"BASE",status:"CONTRACT_SIGNED",note:"Piano: BASE - Care Giver: Elisabetta + Germana Cattini - IMEI: 868298061207735"},{nome:"Maria",cognome:"Capone",email:"marycap34@gmail.com",telefono:"+393478740585",servizio:"eCura PRO",piano:"BASE",status:"CONTRACT_SIGNED",note:"Piano: BASE - Care Giver: Giorgio Riela (figlio) - IMEI: 868298061173234"},{nome:"Gianni Paolo",cognome:"Pizzutto",email:"",telefono:"+393398444530",servizio:"eCura PRO",piano:"BASE",status:"CONTRACT_SIGNED",note:"Piano: BASE - Care Giver: Simona Pizzutto (figlia) - IMEI: 868298060601011"},{nome:"Rita",cognome:"Pennacchio",email:"",telefono:"+393398331711",servizio:"eCura PRO",piano:"BASE",status:"CONTRACT_SIGNED",note:"Piano: BASE - Care Giver: Caterina D'Alterio (figlia) - IMEI: 868298061123759"},{nome:"Giuliana",cognome:"Balzarotti",email:"",telefono:"+393312826048",servizio:"eCura PRO",piano:"BASE",status:"CONTRACT_SIGNED",note:"Piano: BASE - Care Giver: Paolo Magr√¨ (figlio) - IMEI: 868298061206968"},{nome:"Laura",cognome:"Calvi",email:"",telefono:"",servizio:"eCura PRO",piano:"BASE",status:"CONTRACT_SIGNED",note:"Piano: BASE - Care Giver: Daniela Rocca (figlia) - IMEI: 864866055431174"},{nome:"Manuela",cognome:"Poggi",email:"manuela.poggi@example.com",telefono:"+393331234567",servizio:"eCura PRO",piano:"BASE",status:"CONTRACT_SENT",note:"Piano: BASE - Contratto inviato"}];let a=0,i=0;for(const s of e){const r=`LEAD-${s.cognome.toUpperCase()}-${Date.now()}`,l=new Date().toISOString(),c=await o.env.DB.prepare("SELECT id FROM leads WHERE cognomeRichiedente = ? AND nomeRichiedente = ?").bind(s.cognome,s.nome).first();c?(await o.env.DB.prepare(`
          UPDATE leads 
          SET status = ?, note = ?, telefono = ?, email = ?
          WHERE id = ?
        `).bind(s.status,`${s.servizio} - ${s.piano} - ${s.note}`,s.telefono,s.email||"no-email@assistito.it",c.id).run(),i++,console.log(`‚úÖ Aggiornato lead: ${s.nome} ${s.cognome} ‚Üí ${s.status}`)):(await o.env.DB.prepare(`
          INSERT INTO leads (
            id, nomeRichiedente, cognomeRichiedente, email, telefono,
            tipoServizio, note, status, fonte, created_at, timestamp
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'INIT_WORKFLOW', ?, ?)
        `).bind(r,s.nome,s.cognome,s.email||"no-email@assistito.it",s.telefono,s.servizio,`Piano: ${s.piano} - ${s.note}`,s.status,l,l).run(),a++,console.log(`‚úÖ Inserito lead: ${s.nome} ${s.cognome} ‚Üí ${s.status}`))}return o.json({success:!0,message:"Lead workflow inizializzati",stats:{leadsInseriti:a,leadsAggiornati:i,totale:e.length},leads:e.map(s=>({nome:`${s.nome} ${s.cognome}`,status:s.status}))})}catch(e){return console.error("‚ùå Errore inizializzazione workflow leads:",e),o.json({success:!1,error:"Errore inizializzazione workflow leads",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/import/excel",async o=>{try{const e=(await o.req.formData()).get("file");return!e||!(e instanceof File)?o.json({success:!1,error:"File non fornito"},400):o.json({success:!0,message:"Import Excel in sviluppo - usa endpoint /api/init-assistiti per popolare dati reali",imported:0,skipped:0,note:"Funzionalit√† disponibile a breve"})}catch(t){return console.error("‚ùå Errore import Excel:",t),o.json({success:!1,error:"Errore durante l'import del file Excel",details:t instanceof Error?t.message:String(t)},500)}});I.post("/api/import/irbema",async o=>{var t,e,a,i,s,r;try{if(console.log("üîÑ [HUBSPOT] Inizio import da HubSpot CRM (IRBEMA) - Solo lead eCura (filtro URL: ecura.it)..."),!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);if(!await Ud(o.env.DB,"hubspot_auto_import_enabled"))return console.log("‚è≠Ô∏è [HUBSPOT] Import automatico HubSpot disabilitato nelle impostazioni sistema"),o.json({success:!1,error:"Import automatico HubSpot disabilitato",hint:'Attiva lo switch "Import Auto HubSpot" nella Dashboard Operativa',imported:0,skipped:0},403);if(!((e=o.env)!=null&&e.HUBSPOT_ACCESS_TOKEN))return o.json({success:!1,error:"Token HubSpot non configurato",hint:"Aggiungi HUBSPOT_ACCESS_TOKEN nelle variabili di ambiente"},500);const c=o.env.HUBSPOT_ACCESS_TOKEN;console.log("üìÖ [HUBSPOT] Filtro attivo: solo lead da ecura.it");let d=0,u=0,p=0,g=0,m=0;const v=[],b=await o.env.DB.prepare("SELECT id FROM leads WHERE id LIKE 'LEAD-IRBEMA-%' ORDER BY id DESC LIMIT 1").first();let E=1;if(b!=null&&b.id){const S=b.id.match(/LEAD-IRBEMA-(\d+)/);S&&(E=parseInt(S[1])+1)}let T=null,R=!0;for(;R;){m++,console.log(`üìÑ [HUBSPOT] Caricamento pagina ${m}${T?` (after: ${T})`:""}...`);const S=new URLSearchParams({limit:"100",properties:"firstname,lastname,email,mobilephone,city,servizio_di_interesse,piano_desiderato,message,createdate,hs_analytics_first_url,hs_analytics_last_url"});T&&S.append("after",T);const C=`https://api.hubapi.com/crm/v3/objects/contacts?${S}`,M=await fetch(C,{method:"GET",headers:{Authorization:`Bearer ${c}`,"Content-Type":"application/json"}});if(!M.ok){const N=await M.text();if(console.error(`‚ùå [HUBSPOT] Errore API pagina ${m} (${M.status}):`,N),d>0||u>0)break;return o.json({success:!1,error:`Errore HubSpot API: ${M.status}`,details:N},500)}const B=await M.json(),j=B.results||[];console.log(`‚úÖ [HUBSPOT] Pagina ${m}: ${j.length} contatti`),p+=j.length;for(const N of j)try{const D=N.properties,Y=D.hs_analytics_first_url||"",$=D.hs_analytics_last_url||"";if(!(Y.includes("ecura.it")||$.includes("ecura.it"))){console.log(`‚è≠Ô∏è [HUBSPOT] Skip: non proviene da ecura.it - ${D.firstname||"N/A"} ${D.lastname||""} (${D.email||"no-email"})`),g++;continue}if(console.log(`‚úÖ [HUBSPOT] Lead eCura trovato: ${D.firstname||"N/A"} ${D.lastname||""} (${D.email||"no-email"})`),!D.email&&!D.mobilephone){console.warn(`‚ö†Ô∏è [HUBSPOT] Contatto senza email/telefono, skip: ${D.firstname||"N/A"} ${D.lastname||""}`),u++;continue}const x=D.email||"",k=D.mobilephone||"";if(x&&await o.env.DB.prepare("SELECT id FROM leads WHERE email = ? OR emailRichiedente = ? LIMIT 1").bind(x,x).first()){console.log(`‚è≠Ô∏è [HUBSPOT] Lead gi√† esistente (email): ${x}`),u++;continue}let z="eCura PRO";if(D.servizio_di_interesse){const V=D.servizio_di_interesse.toLowerCase();V.includes("family")?z="eCura FAMILY":V.includes("premium")||V.includes("vital")?z="eCura PREMIUM":V.includes("pro")&&(z="eCura PRO")}let ee="BASE";if(D.piano_desiderato){const V=D.piano_desiderato.toLowerCase();(V.includes("avanzato")||V.includes("advanced"))&&(ee="AVANZATO")}let ae=`HubSpot ID: ${N.id}`;D.city&&(ae+=` | Citt√†: ${D.city}`),D.message&&(ae+=` | Messaggio: ${D.message}`);const te=`LEAD-IRBEMA-${String(E).padStart(5,"0")}`;E++;const pe=new Date().toISOString();await o.env.DB.prepare(`
            INSERT INTO leads (
              id, nomeRichiedente, cognomeRichiedente, email, telefono, cittaAssistito,
              servizio, piano, tipoServizio, fonte, status, vuoleBrochure, vuoleContratto,
              note, created_at, updated_at
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          `).bind(te,D.firstname||"N/A",D.lastname||"N/A",D.email||"",D.mobilephone||"",D.city||null,z,ee,z,"IRBEMA","NEW","No","No",ae,pe,pe).run(),console.log(`‚úÖ [HUBSPOT] Importato: ${te} - ${D.firstname} ${D.lastname} | ${z} ${ee}`),d++,await Ip(te,{nomeRichiedente:D.firstname||"N/A",cognomeRichiedente:D.lastname||"",email:D.email||void 0,telefono:D.mobilephone||void 0,citta:D.city||void 0,servizio:z,piano:ee,fonte:"IRBEMA",note:ae,created_at:pe},o.env)}catch(D){const Y=`${((a=N.properties)==null?void 0:a.firstname)||"N/A"} ${((i=N.properties)==null?void 0:i.lastname)||""}`;console.error(`‚ùå [HUBSPOT] Errore importazione contatto ${Y}:`,D),v.push(`${Y}: ${D instanceof Error?D.message:String(D)}`),u++}(r=(s=B.paging)==null?void 0:s.next)!=null&&r.after?(T=B.paging.next.after,console.log(`‚û°Ô∏è [HUBSPOT] Trovata pagina successiva: ${T}`)):(R=!1,console.log("üèÅ [HUBSPOT] Ultima pagina raggiunta"))}return console.log("üéØ [HUBSPOT] Import COMPLETATO:"),console.log(`   ‚Ä¢ Importati: ${d}`),console.log(`   ‚Ä¢ Saltati (duplicati): ${u}`),console.log(`   ‚Ä¢ Filtrati (pre-2026): ${g}`),console.log(`   ‚Ä¢ Totale elaborati: ${p}`),console.log(`   ‚Ä¢ Pagine: ${m}`),o.json({success:!0,message:"Import HubSpot completato (contatti dal 1/12/2025)",imported:d,skipped:u,filtered:g,total:p,pages:m,errors:v.length>0?v:void 0})}catch(l){return console.error("‚ùå [HUBSPOT] Errore generale import:",l),o.json({success:!1,error:"Errore durante l'import da HubSpot",details:l instanceof Error?l.message:String(l)},500)}});I.post("/api/import/irbema/spot",async o=>{var t,e,a;try{if(console.log("üéØ [HUBSPOT SPOT] Import 9 lead specifici da HubSpot..."),!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);if(!((e=o.env)!=null&&e.HUBSPOT_ACCESS_TOKEN))return o.json({success:!1,error:"Token HubSpot non configurato",hint:"Aggiungi HUBSPOT_ACCESS_TOKEN nelle variabili di ambiente"},500);const i=o.env.HUBSPOT_ACCESS_TOKEN,s=["fossiandrea9@gmail.com","rosaria.serino@icloud.com","amercuri93@gmail.com","simo.parravicini@gmail.com","lillonocera@libero.it","alboloc@gmail.com","sperotto24@gmail.com","gianluigi1259@gmail.com","luk91677@gmail.com"],r=await o.env.DB.prepare("SELECT id FROM leads WHERE id LIKE 'LEAD-IRBEMA-%' ORDER BY id DESC LIMIT 1").first();let l=1;if(r!=null&&r.id){const p=r.id.match(/LEAD-IRBEMA-(\d+)/);p&&(l=parseInt(p[1])+1)}let c=0,d=0;const u=[];for(const p of s)try{console.log(`üîç [SPOT] Cerco su HubSpot: ${p}`);const g=await fetch("https://api.hubapi.com/crm/v3/objects/contacts/search",{method:"POST",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:JSON.stringify({filterGroups:[{filters:[{propertyName:"email",operator:"EQ",value:p}]}],properties:["firstname","lastname","email","phone","mobilephone","city","createdate","servizio_di_interesse","piano_desiderato","message"],limit:1})});if(!g.ok){console.error(`‚ùå [SPOT] Errore ricerca HubSpot per ${p}`),d++,u.push({email:p,status:"ERROR",error:"Errore ricerca HubSpot"});continue}const m=await g.json();if(!m.results||m.results.length===0){console.log(`‚è≠Ô∏è [SPOT] Contatto non trovato su HubSpot: ${p}`),d++,u.push({email:p,status:"NOT_FOUND",error:"Non trovato su HubSpot"});continue}const v=m.results[0],b=v.properties,E=await o.env.DB.prepare("SELECT id FROM leads WHERE email = ? OR emailRichiedente = ? LIMIT 1").bind(p,p).first();if(E){console.log(`‚è≠Ô∏è [SPOT] Lead gi√† esistente: ${p}`),d++,u.push({email:p,status:"DUPLICATE",leadId:E.id});continue}let T="eCura PRO";if(b.servizio_di_interesse){const B=b.servizio_di_interesse.toLowerCase();B.includes("family")?T="eCura FAMILY":B.includes("premium")&&(T="eCura PREMIUM")}let R="BASE";(a=b.piano_desiderato)!=null&&a.toLowerCase().includes("avanzato")&&(R="AVANZATO");let S=`HubSpot ID: ${v.id}`;b.city&&(S+=` | Citt√†: ${b.city}`),b.message&&(S+=` | Messaggio: ${b.message}`);const C=`LEAD-IRBEMA-${String(l).padStart(5,"0")}`;l++;const M=new Date().toISOString();await o.env.DB.prepare(`
          INSERT INTO leads (
            id, nomeRichiedente, cognomeRichiedente, email, telefono, cittaAssistito,
            servizio, piano, tipoServizio, fonte, status, vuoleBrochure, vuoleContratto,
            note, created_at, updated_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(C,b.firstname||"N/A",b.lastname||"(Cognome non fornito)",p,b.mobilephone||b.phone||null,b.city||null,T,R,R,"IRBEMA","NEW","No","No",S,M,M).run(),console.log(`‚úÖ [SPOT] Importato: ${C} - ${b.firstname} ${b.lastname} (${p})`),c++,u.push({email:p,status:"IMPORTED",leadId:C,nome:b.firstname,cognome:b.lastname}),await Ip(C,{nomeRichiedente:b.firstname||"N/A",cognomeRichiedente:b.lastname||"(Cognome non fornito)",email:p,telefono:b.mobilephone||b.phone||void 0,citta:b.city||void 0,servizio:T,piano:R,fonte:"IRBEMA",note:S,created_at:M},o.env)}catch(g){console.error(`‚ùå [SPOT] Errore import ${p}:`,g),d++,u.push({email:p,status:"ERROR",error:g instanceof Error?g.message:String(g)})}return console.log(`üéØ [SPOT] Completato: ${c} importati, ${d} saltati`),o.json({success:!0,message:"Import spot completato",imported:c,skipped:d,total:s.length,results:u})}catch(i){return console.error("‚ùå [SPOT] Errore generale:",i),o.json({success:!1,error:i instanceof Error?i.message:String(i)},500)}});I.post("/api/import/irbema/manual",async o=>{var t;try{if(console.log("üìù [HUBSPOT] Import manuale 9 lead specifici..."),!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const e=await o.env.DB.prepare("SELECT id FROM leads WHERE id LIKE 'LEAD-IRBEMA-%' ORDER BY id DESC LIMIT 1").first();let a=1;if(e!=null&&e.id){const c=String(e.id).match(/LEAD-IRBEMA-(\d+)/);c&&(a=parseInt(c[1])+1)}const i=[{nome:"Michela",cognome:"Annunzi",email:"amministrazione@europa92.it",telefono:"+393476735218",citta:"Modena",note:"Data HubSpot: 28/12/25 | Fonte: PRIVATO | 12/01/26 non interessata da non richiamare"},{nome:"Elisa",cognome:"Cattarossi",email:"elisa@cattarossi.it",telefono:"",citta:"",note:"Data HubSpot: 30/12/25 | Fonte: PRIVATO | 12/01/26 email inviata nessun contatto"},{nome:"Maria Carla",cognome:"Morroni",email:"morroni.mariacarla55@gmail.com",telefono:"3314563888",citta:"Genova",note:"Data HubSpot: 11/01/25 | Fonte: PRIVATO | Informazioni pi√π dettagliate | 12/01/26 nessuna risposta email inviata"},{nome:"Giuliana",cognome:"(Cognome non fornito)",email:"giuliberard@gmail.com",telefono:"",citta:"",note:"Data HubSpot: 1900 | Fonte: PRIVATO | 19/01/2026 Inviata brochure con nuovi modelli"},{nome:"Laila",cognome:"Moustafa",email:"lailamoustafa.pia@gmail.com",telefono:"3394863927",citta:"Lecce",note:"Data HubSpot: 1900 | Fonte: PRIVATO | Desidero preventivo di bracciale salvavita | 19/01/2026 nessuna risposta email inviata"},{nome:"Tiziana",cognome:"(Cognome non fornito)",email:"tizianab953@gmail.com",telefono:"",citta:"",note:"Data HubSpot: 1900 | Fonte: PRIVATO | 19/01/2026 Inviata brochure con nuovi modelli"},{nome:"Flavia",cognome:"Farm√®",email:"fiorenza.farne1@gmail.com",telefono:"",citta:"",note:"Data HubSpot: 1900 | Fonte: PRIVATO | 22/01/2026 inviata brochure con nuovi modelli"},{nome:"Lucio",cognome:"Comazza",email:"lucio.cam51@gmail.com",telefono:"3884287850",citta:"Borgomanero",note:"Data HubSpot: 1900 | Fonte: PRIVATO | Sono interessato e vorrei qualche informazione in pi√π | 26/01/2026 nessuna risposta email inviata"},{nome:"Anna",cognome:"(Cognome non fornito)",email:"sarottoanna@gmail.com",telefono:"",citta:"",note:"Data HubSpot: 1900 | Fonte: PRIVATO | 26/01/2026 nessun contatto email inviata"}];let s=0,r=0;const l=[];for(const c of i)try{if(await o.env.DB.prepare("SELECT id FROM leads WHERE email = ? OR emailRichiedente = ? LIMIT 1").bind(c.email,c.email).first()){console.log(`‚è≠Ô∏è [MANUAL] Lead gi√† esistente: ${c.email}`),r++;continue}const u=`LEAD-IRBEMA-${String(a).padStart(5,"0")}`,p=new Date().toISOString();await o.env.DB.prepare(`
          INSERT INTO leads (
            id, nomeRichiedente, cognomeRichiedente, email, 
            telefono, cittaAssistito, servizio, piano, tipoServizio,
            fonte, status, vuoleBrochure, vuoleContratto, note, 
            created_at, updated_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(u,c.nome,c.cognome,c.email,c.telefono||null,c.citta||null,"eCura PRO","BASE","BASE","IRBEMA","NEW","No","No",c.note,p,p).run(),console.log(`‚úÖ [MANUAL] Importato: ${u} - ${c.nome} ${c.cognome} (${c.email})`),s++,a++,await Ip(u,{nomeRichiedente:c.nome,cognomeRichiedente:c.cognome,email:c.email,telefono:c.telefono||void 0,citta:c.citta||void 0,servizio:"eCura PRO",piano:"BASE",fonte:"IRBEMA",note:c.note,created_at:p},o.env)}catch(d){const u=`Errore import ${c.email}: ${d instanceof Error?d.message:String(d)}`;console.error(`‚ùå [MANUAL] ${u}`),l.push(u)}return o.json({success:!0,message:"Import manuale completato",imported:s,skipped:r,total:i.length,errors:l.length>0?l:void 0})}catch(e){return console.error("‚ùå [MANUAL] Errore generale:",e),o.json({success:!1,error:"Errore durante l'import manuale",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/import/irbema/cleanup",async o=>{var t;try{if(console.log("üßπ [CLEANUP] Pulizia lead IRBEMA >= 128 - mantengo solo i 9 specifici..."),!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const e=["amministrazione@europa92.it","morroni.mariacarla55@gmail.com","lailamoustafa.pia@gmail.com","lucio.cam51@gmail.com","elisa@cattarossi.it","giuliberard@gmail.com","tizianab953@gmail.com","fiorenza.farne1@gmail.com","sarottoanna@gmail.com"],a=await o.env.DB.prepare(`
      SELECT COUNT(*) as count FROM leads 
      WHERE fonte = 'IRBEMA' 
      AND (
        id >= 'LEAD-IRBEMA-00128'
        OR id LIKE 'LEAD-IRBEMA-001%'
        OR id LIKE 'LEAD-IRBEMA-002%'
        OR id LIKE 'LEAD-IRBEMA-003%'
      )
    `).first();console.log(`üìä [CLEANUP] Lead IRBEMA >= 128 prima della pulizia: ${(a==null?void 0:a.count)||0}`);const i=e.map(()=>"?").join(","),s=await o.env.DB.prepare(`
      DELETE FROM leads 
      WHERE fonte = 'IRBEMA' 
      AND (
        CAST(SUBSTR(id, 14) AS INTEGER) >= 128
      )
      AND email NOT IN (${i})
    `).bind(...e).run(),r=await o.env.DB.prepare("SELECT COUNT(*) as count FROM leads WHERE fonte = 'IRBEMA'").first();return console.log(`‚úÖ [CLEANUP] Lead IRBEMA eliminati: ${s.meta.changes||0}`),console.log(`üìä [CLEANUP] Lead IRBEMA totali rimanenti: ${(r==null?void 0:r.count)||0}`),o.json({success:!0,message:"Cleanup completato - mantenuti lead < 128 + i 9 specifici",before:(a==null?void 0:a.count)||0,deleted:s.meta.changes||0,total_remaining:(r==null?void 0:r.count)||0})}catch(e){return console.error("‚ùå [CLEANUP] Errore:",e),o.json({success:!1,error:"Errore durante il cleanup",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/import/irbema/renumber",async o=>{var t;try{if(console.log("üî¢ [RENUMBER] Rinumerazione lead IRBEMA dal 128 in poi..."),!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const e=[{email:"amministrazione@europa92.it",newId:"LEAD-IRBEMA-00128",nome:"Michela Annunzi"},{email:"morroni.mariacarla55@gmail.com",newId:"LEAD-IRBEMA-00129",nome:"Maria Carla Morroni"},{email:"lailamoustafa.pia@gmail.com",newId:"LEAD-IRBEMA-00130",nome:"Laila Moustafa"},{email:"lucio.cam51@gmail.com",newId:"LEAD-IRBEMA-00131",nome:"Lucio Comazza"},{email:"elisa@cattarossi.it",newId:"LEAD-IRBEMA-00132",nome:"Elisa Cattarossi"},{email:"giuliberard@gmail.com",newId:"LEAD-IRBEMA-00133",nome:"Giuliana"},{email:"tizianab953@gmail.com",newId:"LEAD-IRBEMA-00134",nome:"Tiziana"},{email:"fiorenza.farne1@gmail.com",newId:"LEAD-IRBEMA-00135",nome:"Flavia Farm√®"},{email:"sarottoanna@gmail.com",newId:"LEAD-IRBEMA-00136",nome:"Anna"}];let a=0;const i=[];for(const s of e)try{const r=await o.env.DB.prepare("SELECT id FROM leads WHERE email = ? AND fonte = ? LIMIT 1").bind(s.email,"IRBEMA").first();r&&r.id!==s.newId?(await o.env.DB.prepare("UPDATE leads SET id = ? WHERE email = ? AND fonte = ?").bind(s.newId,s.email,"IRBEMA").run(),console.log(`‚úÖ [RENUMBER] ${r.id} ‚Üí ${s.newId} (${s.nome})`),i.push({email:s.email,oldId:r.id,newId:s.newId,nome:s.nome}),a++):r?console.log(`‚è≠Ô∏è [RENUMBER] ${s.newId} gi√† corretto (${s.nome})`):console.warn(`‚ö†Ô∏è [RENUMBER] Lead non trovato: ${s.email}`)}catch(r){console.error(`‚ùå [RENUMBER] Errore ${s.email}:`,r)}return o.json({success:!0,message:"Rinumerazione completata",updated:a,changes:i})}catch(e){return console.error("‚ùå [RENUMBER] Errore generale:",e),o.json({success:!1,error:"Errore durante la rinumerazione",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/fix-lead-associations",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);console.log("üîß Correzione associazioni lead-contratti-assistiti...");const e=[{assistito:{nome:"Maria",cognome:"Capone",imei:"868298061173234"},lead:{id:"LEAD-EXCEL-059",nome:"Giorgio",cognome:"Riela",ruolo:"caregiver/figlio"}},{assistito:{nome:"Giuliana",cognome:"Balzarotti",imei:"868298061206968"},lead:{id:"LEAD-EXCEL-060",nome:"Paolo",cognome:"Magr√¨",ruolo:"caregiver/figlio"}},{assistito:{nome:"Giuseppina",cognome:"Cozzi",imei:"868298061207735"},lead:{id:"LEAD-EXCEL-071",nome:"Elisabetta",cognome:"Cattini",ruolo:"caregiver"}},{assistito:{nome:"Laura",cognome:"Calvi",imei:"864866055431174"},lead:{id:"LEAD-EXCEL-065",nome:"Laura",cognome:"Calvi",ruolo:"assistita (lead stesso)"}}];let a=0,i=0,s=0;for(const r of e){const l=await o.env.DB.prepare("SELECT id FROM leads WHERE id = ? OR (nomeRichiedente = ? AND cognomeRichiedente = ?)").bind(r.lead.id,r.lead.nome,r.lead.cognome).first();if(!l){console.warn(`‚ö†Ô∏è Lead non trovato: ${r.lead.nome} ${r.lead.cognome} (${r.lead.id})`);continue}console.log(`‚úÖ Lead trovato: ${l.id} per ${r.assistito.nome} ${r.assistito.cognome}`),await o.env.DB.prepare(`
        UPDATE leads 
        SET nomeAssistito = ?, cognomeAssistito = ?, 
            note = COALESCE(note, '') || ' | Assistito: ' || ? || ' ' || ? || ' (IMEI: ' || ? || ')'
        WHERE id = ? AND (nomeAssistito IS NULL OR nomeAssistito = '')
      `).bind(r.assistito.nome,r.assistito.cognome,r.assistito.nome,r.assistito.cognome,r.assistito.imei,l.id).run(),i++;const c=await o.env.DB.prepare("SELECT id, leadId FROM contracts WHERE imei_dispositivo = ?").bind(r.assistito.imei).first();if(c)await o.env.DB.prepare(`
          UPDATE contracts 
          SET leadId = ?
          WHERE id = ?
        `).bind(l.id,c.id).run(),a++,console.log(`‚úÖ Contratto aggiornato: ${c.id} ‚Üí leadId: ${l.id}`);else if(r.assistito.cognome!=="Calvi"){const d=`CONTRACT-${r.assistito.cognome.toUpperCase()}-${Date.now()}`,u=`CTR-${r.assistito.cognome.toUpperCase()}-2025`,p=r.assistito.cognome==="King"?"AVANZATO":"BASE",g=p==="AVANZATO"?840:480,m=p==="AVANZATO"?69:39;await o.env.DB.prepare(`
          INSERT INTO contracts (
            id, leadId, codice_contratto, tipo_contratto, status, 
            prezzo_totale, prezzo_mensile, durata_mesi, imei_dispositivo, 
            created_at, template_utilizzato, contenuto_html
          ) VALUES (?, ?, ?, ?, 'SIGNED', ?, ?, 12, ?, ?, 'BASE', '')
        `).bind(d,l.id,u,p,g,m,r.assistito.imei,new Date().toISOString()).run(),s++,console.log(`‚úÖ Contratto creato: ${u} per ${r.assistito.nome} ${r.assistito.cognome}`)}}return o.json({success:!0,message:"Associazioni corrette con lead reali",stats:{leadsAggiornati:i,contrattiAggiornati:a,contrattiCreati:s,totaleAssociazioni:e.length}})}catch(e){return console.error("‚ùå Errore correzione associazioni:",e),o.json({success:!1,error:"Errore correzione associazioni",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/delete-manual-duplicates",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);console.log("üßπ Eliminazione lead manual duplicati...");const e=["LEAD-MANUAL-1766885130882","LEAD-MANUAL-1766885181620"];let a=0;for(const s of e)try{(await o.env.DB.prepare("DELETE FROM leads WHERE id = ?").bind(s).run()).meta.changes>0&&(console.log(`‚úÖ Eliminato: ${s}`),a++)}catch(r){console.error(`‚ùå Errore eliminando ${s}:`,r)}const i=await o.env.DB.prepare("SELECT COUNT(*) as count FROM leads").first();return o.json({success:!0,message:"Lead duplicati manual eliminati",stats:{deleted:a,totalLeads:(i==null?void 0:i.count)||0}})}catch(e){return console.error("‚ùå Errore eliminazione duplicati:",e),o.json({success:!1,error:"Errore eliminazione duplicati",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/cleanup-duplicate-leads",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);console.log("üßπ Pulizia lead duplicati (INIT_WORKFLOW e MANUAL test)...");const e=await o.env.DB.prepare("SELECT COUNT(*) as count FROM leads").first(),a=await o.env.DB.prepare(`
      DELETE FROM leads 
      WHERE fonte = 'INIT_WORKFLOW'
    `).run(),i=await o.env.DB.prepare(`
      DELETE FROM leads 
      WHERE fonte = 'MANUAL_ENTRY' 
      AND (nomeRichiedente = 'Test' OR nomeRichiedente = 'Roberto')
    `).run(),s=await o.env.DB.prepare("SELECT COUNT(*) as count FROM leads").first(),r=((e==null?void 0:e.count)||0)-((s==null?void 0:s.count)||0);return console.log(`‚úÖ Eliminati ${r} lead duplicati`),console.log(`üìä Lead rimasti: ${s==null?void 0:s.count}`),o.json({success:!0,message:"Lead duplicati eliminati",stats:{beforeCount:e==null?void 0:e.count,afterCount:s==null?void 0:s.count,deletedCount:r,deletedInit:a.meta.changes,deletedManual:i.meta.changes}})}catch(e){return console.error("‚ùå Errore pulizia lead:",e),o.json({success:!1,error:"Errore pulizia lead duplicati",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/fix-contracts-piano",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);console.log("üîß Fix piani contratti basandosi su prezzo_totale...");const a=(await o.env.DB.prepare("PRAGMA table_info(contracts)").all()).results.some(r=>r.name==="piano");a||(await o.env.DB.prepare("ALTER TABLE contracts ADD COLUMN piano TEXT").run(),console.log("‚úÖ Colonna piano aggiunta"));const i=await o.env.DB.prepare(`
      UPDATE contracts 
      SET piano = CASE 
        WHEN prezzo_totale >= 800 THEN 'AVANZATO'
        WHEN prezzo_totale > 0 THEN 'BASE'
        ELSE 'BASE'
      END
      WHERE piano IS NULL
    `).run();console.log(`‚úÖ Aggiornati ${i.meta.changes} contratti`);const s=await o.env.DB.prepare(`
      SELECT id, piano, prezzo_totale FROM contracts ORDER BY prezzo_totale DESC
    `).all();return o.json({success:!0,message:"Piani contratti aggiornati",stats:{updated:i.meta.changes,hasPianoColumn:a,contracts:s.results}})}catch(e){return console.error("‚ùå Errore fix piani:",e),o.json({success:!1,error:"Errore fix piani contratti",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/fix-ecura-duplication",async o=>{var t,e,a,i,s,r,l,c,d,u,p,g,m;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);console.log('üßπ Pulizia duplicazione "eCura eCura" dal database...');let v=0;const b=await o.env.DB.prepare(`
      UPDATE contracts 
      SET servizio = REPLACE(servizio, 'eCura eCura', 'eCura')
      WHERE servizio LIKE '%eCura eCura%'
    `).run();v+=((e=b.meta)==null?void 0:e.changes)||0,console.log(`‚úÖ Contratti fixati: ${((a=b.meta)==null?void 0:a.changes)||0}`);const E=await o.env.DB.prepare(`
      UPDATE leads 
      SET servizio = REPLACE(servizio, 'eCura eCura', 'eCura')
      WHERE servizio LIKE '%eCura eCura%'
    `).run();v+=((i=E.meta)==null?void 0:i.changes)||0,console.log(`‚úÖ Leads (servizio) fixati: ${((s=E.meta)==null?void 0:s.changes)||0}`);const T=await o.env.DB.prepare(`
      UPDATE leads 
      SET tipoServizio = REPLACE(tipoServizio, 'eCura eCura', 'eCura')
      WHERE tipoServizio LIKE '%eCura eCura%'
    `).run();v+=((r=T.meta)==null?void 0:r.changes)||0,console.log(`‚úÖ Leads (tipoServizio) fixati: ${((l=T.meta)==null?void 0:l.changes)||0}`);const R=await o.env.DB.prepare(`
      UPDATE leads 
      SET note = REPLACE(note, 'Servizio: eCura eCura', 'Servizio: eCura')
      WHERE note LIKE '%Servizio: eCura eCura%'
    `).run();v+=((c=R.meta)==null?void 0:c.changes)||0,console.log(`‚úÖ Leads (note) fixati: ${((d=R.meta)==null?void 0:d.changes)||0}`);const S=await o.env.DB.prepare(`
      SELECT codice_contratto, servizio FROM contracts WHERE servizio LIKE '%eCura%' LIMIT 5
    `).all(),C=await o.env.DB.prepare(`
      SELECT id, servizio, tipoServizio FROM leads WHERE servizio LIKE '%eCura%' OR tipoServizio LIKE '%eCura%' LIMIT 5
    `).all();return o.json({success:!0,message:'‚úÖ Duplicazione "eCura eCura" rimossa con successo!',stats:{totalFixed:v,contracts:((u=b.meta)==null?void 0:u.changes)||0,leadsServizio:((p=E.meta)==null?void 0:p.changes)||0,leadsTipo:((g=T.meta)==null?void 0:g.changes)||0,leadsNotes:((m=R.meta)==null?void 0:m.changes)||0},samples:{contracts:S.results,leads:C.results}})}catch(v){return console.error("‚ùå Errore fix duplicazione eCura:",v),o.json({success:!1,error:"Errore fix duplicazione eCura",details:v instanceof Error?v.message:String(v)},500)}});I.post("/api/migrations/0006-add-piano-servizio",async o=>{var t,e,a;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);console.log("üîß Migration 0006: Aggiungi piano e servizio alla tabella leads...");const s=(await o.env.DB.prepare("PRAGMA table_info(leads)").all()).results.map(R=>R.name),r=s.includes("piano"),l=s.includes("servizio");console.log(`üìä Colonne esistenti: piano=${r}, servizio=${l}`),console.log("üìä Tutte le colonne:",s);let c=!1,d=!1,u=null,p=null;if(!r)try{const R=await o.env.DB.prepare("ALTER TABLE leads ADD COLUMN piano TEXT DEFAULT 'BASE'").run();console.log("‚úÖ Colonna piano aggiunta:",R),c=!0}catch(R){console.error("‚ùå Errore aggiunta colonna piano:",R),u=R instanceof Error?R.message:String(R)}if(!l)try{const R=await o.env.DB.prepare("ALTER TABLE leads ADD COLUMN servizio TEXT DEFAULT 'eCura PRO'").run();console.log("‚úÖ Colonna servizio aggiunta:",R),d=!0}catch(R){console.error("‚ùå Errore aggiunta colonna servizio:",R),p=R instanceof Error?R.message:String(R)}const m=(await o.env.DB.prepare("PRAGMA table_info(leads)").all()).results.map(R=>R.name),v=m.includes("piano"),b=m.includes("servizio");console.log(`üìä Colonne dopo ALTER: piano=${v}, servizio=${b}`);let E={meta:{changes:0}};if(v&&b)try{E=await o.env.DB.prepare(`
          UPDATE leads 
          SET servizio = COALESCE(tipoServizio, 'eCura PRO'),
              piano = CASE 
                  WHEN note LIKE '%Piano: AVANZATO%' OR note LIKE '%AVANZATO%' THEN 'AVANZATO'
                  ELSE 'BASE'
              END
          WHERE 1=1
        `).run(),console.log(`‚úÖ Migrati ${((e=E.meta)==null?void 0:e.changes)||0} lead`)}catch(R){console.error("‚ùå Errore migrazione dati:",R)}else console.warn("‚ö†Ô∏è Colonne non presenti, skip migrazione dati");const T=await o.env.DB.prepare(`
      SELECT 
        COUNT(*) as total_leads,
        SUM(CASE WHEN piano = 'BASE' THEN 1 ELSE 0 END) as piano_base,
        SUM(CASE WHEN piano = 'AVANZATO' THEN 1 ELSE 0 END) as piano_avanzato,
        SUM(CASE WHEN servizio = 'eCura PRO' OR servizio = 'PRO' THEN 1 ELSE 0 END) as servizio_pro,
        SUM(CASE WHEN servizio = 'eCura Family' OR servizio = 'FAMILY' THEN 1 ELSE 0 END) as servizio_family,
        SUM(CASE WHEN servizio = 'eCura PREMIUM' OR servizio = 'PREMIUM' THEN 1 ELSE 0 END) as servizio_premium
      FROM leads
    `).first();return o.json({success:v&&b,message:v&&b?"‚úÖ Migration 0006 completata con successo!":"‚ö†Ô∏è Migration parziale o fallita",debug:{columnsBefore:s,columnsAfter:m,hasPianoBefore:r,hasServizioBefore:l,hasPianoAfter:v,hasServizioAfter:b,pianoAdded:c,servizioAdded:d,pianoError:u,servizioError:p},columnsAdded:{piano:c,servizio:d},migrated:((a=E.meta)==null?void 0:a.changes)||0,stats:T})}catch(i){return console.error("‚ùå Errore migration 0006:",i),o.json({success:!1,error:"Errore migration 0006",details:i instanceof Error?i.message:String(i)},500)}});I.post("/api/import-excel-leads",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const a=(await o.req.json()).leads||[];if(!Array.isArray(a)||a.length===0)return o.json({success:!1,error:"Nessun lead fornito"},400);console.log(`üì• Import di ${a.length} lead da Excel...`);let i=0,s=0,r=0;for(const l of a)try{let c=null;if(l.email&&(c=await o.env.DB.prepare(`
            SELECT id FROM leads WHERE email = ? LIMIT 1
          `).bind(l.email).first()),!c&&l.telefono&&(c=await o.env.DB.prepare(`
            SELECT id FROM leads WHERE telefono = ? LIMIT 1
          `).bind(l.telefono).first()),c){s++;continue}const d=`LEAD-EXCEL-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,u=l.email||(l.telefono?`noemail+${l.telefono}@telemedcare.it`:`noemail+${d}@telemedcare.it`);await o.env.DB.prepare(`
          INSERT INTO leads (
            id, nomeRichiedente, cognomeRichiedente, email, telefono,
            tipoServizio, fonte, status, note, nomeAssistito, cognomeAssistito, created_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(d,l.nome||"N/A",l.cognome||"N/A",u,l.telefono||"","eCura PRO","EXCEL_IMPORT","NUOVO",`Canale: ${l.canale||"IRBEMA"} | Location: ${l.location||""} | Note: ${l.note||""} | Messaggio: ${l.messaggio||""}`.trim(),l.assistito_nome?l.assistito_nome.split(" ")[0]:null,l.assistito_nome?l.assistito_nome.split(" ").slice(1).join(" "):null,new Date().toISOString()).run(),i++}catch(c){console.error(`‚ùå Errore import lead ${l.nome}:`,c),r++}return console.log(`‚úÖ Import completato: ${i} importati, ${s} gi√† esistenti, ${r} errori`),o.json({success:!0,message:"Import lead completato",stats:{total:a.length,imported:i,skipped:s,errors:r}})}catch(e){return console.error("‚ùå Errore import lead:",e),o.json({success:!1,error:"Errore import lead",details:e instanceof Error?e.message:String(e)},500)}});I.get("/api/db/schema/leads",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({error:"DB non configurato"},500);const e=await o.env.DB.prepare("PRAGMA table_info(leads)").all();return o.json({success:!0,columns:e.results,count:e.results.length})}catch(e){return o.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.get("/api/check-version",async o=>o.json({version:"v2.0-leadId-fix",timestamp:new Date().toISOString(),message:"Endpoint aggiornato con fix leadId NOT NULL"}));I.post("/api/reset-assistiti",async o=>{var t;try{return(t=o.env)!=null&&t.DB?(console.log("üóëÔ∏è Reset completo assistiti e contratti..."),await o.env.DB.prepare("DELETE FROM contracts").run(),await o.env.DB.prepare("DELETE FROM assistiti").run(),await o.env.DB.prepare('DELETE FROM leads WHERE id LIKE "LEAD-%-"').run(),console.log("‚úÖ Database pulito"),o.json({success:!0,message:"Database assistiti/contratti resettato",timestamp:new Date().toISOString()})):o.json({success:!1,error:"Database non configurato"},500)}catch(e){return console.error("‚ùå Errore reset:",e),o.json({success:!1,error:"Errore reset database",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/init-assistiti",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);console.log("üöÄ Inizializzazione assistiti reali...");try{await o.env.DB.prepare(`
        ALTER TABLE assistiti ADD COLUMN imei TEXT
      `).run(),console.log("‚úÖ Colonna IMEI aggiunta a tabella assistiti")}catch(r){console.log("‚ÑπÔ∏è Colonna IMEI gi√† esistente o errore non critico:",r)}try{await o.env.DB.prepare(`
        ALTER TABLE contracts ADD COLUMN imei_dispositivo TEXT
      `).run(),console.log("‚úÖ Colonna imei_dispositivo aggiunta a tabella contracts")}catch(r){console.log("‚ÑπÔ∏è Colonna imei_dispositivo gi√† esistente:",r)}const e=[{nome:"Eileen Elisabeth",cognome:"King",imei:"868298061208378",servizio:"eCura PRO",piano:"AVANZATO",careGiver:"Elena Saglia",parentela:"figlia",dataNascita:"1935-05-18",sesso:"Donna",peso:80,altezza:157,telefono:"+393475951175",indirizzo:"Via Diaz 34, Cernusco sul Naviglio (MI)",email:"",contratto:!0},{nome:"Giuseppina",cognome:"Cozzi",imei:"868298061207735",servizio:"eCura PRO",piano:"BASE",careGiver:"Elisabetta Cattini, Germana Cattini",parentela:"operatori sanitari",dataNascita:"1939-01-28",sesso:"Donna",peso:80,altezza:150,telefono:"+393313809634",indirizzo:"VIA 4 NOVEMBRE 12, 20014 NERVIANO MI",email:"",contratto:!0},{nome:"Maria",cognome:"Capone",imei:"868298061173234",servizio:"eCura PRO",piano:"BASE",careGiver:"Giorgio Riela",parentela:"figlio",dataNascita:"1934-08-15",sesso:"Donna",peso:64,altezza:140,telefono:"+393478740585",indirizzo:"via 100/80 Castiglione torinese to",email:"marycap34@gmail.com",contratto:!0},{nome:"Gianni Paolo",cognome:"Pizzutto",imei:"868298060601011",servizio:"eCura PRO",piano:"BASE",careGiver:"Simona Pizzutto",parentela:"figlia",dataNascita:"1939-06-26",sesso:"Uomo",peso:80,altezza:170,telefono:"+393398444530",indirizzo:"Via Costituzione 5, S. Mauro Torinese (TO)",email:"",contratto:!0},{nome:"Rita",cognome:"Pennacchio",imei:"868298061123759",servizio:"eCura PRO",piano:"BASE",careGiver:"Caterina D'Alterio",parentela:"figlia",dataNascita:"1934-10-28",sesso:"Donna",peso:60,altezza:150,telefono:"+393398331711",indirizzo:"Via Antonio Fogazzaro 28, Giugliano (NA)",email:"",contratto:!0},{nome:"Giuliana",cognome:"Balzarotti",imei:"868298061206968",servizio:"eCura PRO",piano:"BASE",careGiver:"Paolo Magr√¨",parentela:"figlio",dataNascita:"",sesso:"Donna",peso:70,altezza:165,telefono:"+393312826048",indirizzo:"",email:"",contratto:!0},{nome:"Laura",cognome:"Calvi",imei:"864866055431174",servizio:"eCura PRO",piano:"BASE",careGiver:"Daniela Rocca",parentela:"figlia",dataNascita:"",sesso:"Donna",peso:0,altezza:0,telefono:"",indirizzo:"",email:"",contratto:!1}];let a=0,i=0,s=0;for(const r of e){const l=`ASS-${r.cognome.toUpperCase()}-${Date.now()}`,c=new Date().toISOString();await o.env.DB.prepare("SELECT id FROM assistiti WHERE imei = ?").bind(r.imei).first()?(await o.env.DB.prepare(`
          UPDATE assistiti 
          SET nome = ?, nome_assistito = ?, cognome_assistito = ?,
              nome_caregiver = ?, cognome_caregiver = ?, parentela_caregiver = ?,
              email = ?, telefono = ?, status = 'ATTIVO'
          WHERE imei = ?
        `).bind(`${r.nome} ${r.cognome}`,r.nome,r.cognome,r.careGiver?r.careGiver.split(" ")[0]:null,r.careGiver?r.careGiver.split(" ").slice(1).join(" "):null,r.parentela||null,r.email,r.telefono,r.imei).run(),i++,console.log(`‚úÖ Aggiornato assistito: ${r.nome} ${r.cognome} (IMEI: ${r.imei})`)):(await o.env.DB.prepare(`
          INSERT INTO assistiti (
            codice, nome, nome_assistito, cognome_assistito, 
            nome_caregiver, cognome_caregiver, parentela_caregiver,
            email, telefono, imei, status, created_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'ATTIVO', ?)
        `).bind(l,`${r.nome} ${r.cognome}`,r.nome,r.cognome,r.careGiver?r.careGiver.split(" ")[0]:null,r.careGiver?r.careGiver.split(" ").slice(1).join(" "):null,r.parentela||null,r.email,r.telefono,r.imei,c).run(),a++,console.log(`‚úÖ Inserito assistito: ${r.nome} ${r.cognome} (IMEI: ${r.imei})`));let u=null;if(r.contratto){const p=await o.env.DB.prepare(`
          SELECT id FROM leads 
          WHERE (cognomeRichiedente = ? OR nomeRichiedente = ?) 
             OR (email != '' AND email = ?)
          LIMIT 1
        `).bind(r.cognome,r.nome,r.email||"").first();if(p)u=p.id,console.log(`‚úÖ Lead trovato: ${u} per ${r.nome} ${r.cognome}`);else{console.warn(`‚ö†Ô∏è Lead NON trovato per ${r.nome} ${r.cognome} - Contratto NON creato`);continue}const g=`CTR-${r.cognome.toUpperCase()}-${new Date().getFullYear()}`,m=await o.env.DB.prepare("SELECT id FROM contracts WHERE imei_dispositivo = ? OR leadId = ? OR codice_contratto = ?").bind(r.imei,u,g).first();if(m)console.log(`‚ÑπÔ∏è Contratto esistente trovato: ${m.id}`);else{const v=`CONTRACT-${r.cognome.toUpperCase()}-${Date.now()}`,b=r.piano==="AVANZATO"?840:480;await o.env.DB.prepare(`
            INSERT INTO contracts (
              id, leadId, codice_contratto, tipo_contratto, status, 
              prezzo_totale, imei_dispositivo, created_at,
              template_utilizzato, contenuto_html, prezzo_mensile, durata_mesi
            ) VALUES (?, ?, ?, ?, 'SIGNED', ?, ?, ?, 'BASE', '', ?, 12)
          `).bind(v,u,g,r.piano,b,r.imei,c,r.piano==="AVANZATO"?69:39).run(),s++,console.log(`‚úÖ Contratto creato: ${g} per ${r.nome} ${r.cognome} (leadId: ${u})`)}}}return o.json({success:!0,message:"Database inizializzato con assistiti reali",stats:{assistitiInseriti:a,assistitiAggiornati:i,contrattiCreati:s,totaleAssistiti:e.length},assistiti:e.map(r=>({nome:`${r.nome} ${r.cognome}`,imei:r.imei,piano:r.piano,contratto:r.contratto?"‚úÖ":"‚ùå"}))})}catch(e){return console.error("‚ùå Errore inizializzazione assistiti:",e),o.json({success:!1,error:"Errore inizializzazione assistiti",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/init-force",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);console.log("üöÄüöÄüöÄ FORCE INIT - Creazione lead + contratti + FIX existing...");const e=[{nome:"Eileen Elisabeth",cognome:"King",imei:"868298061208378",piano:"AVANZATO",careGiver:"Elena Saglia",parentela:"figlia",telefono:"+393475951175",email:"",servizio:"eCura PRO"},{nome:"Giuseppina",cognome:"Cozzi",imei:"868298061207735",piano:"BASE",careGiver:"Elisabetta Cattini",parentela:"operatore",telefono:"+393313809634",email:"",servizio:"eCura PRO"},{nome:"Maria",cognome:"Capone",imei:"868298061173234",piano:"BASE",careGiver:"Giorgio Riela",parentela:"figlio",telefono:"+393478740585",email:"marycap34@gmail.com",servizio:"eCura PRO"},{nome:"Gianni Paolo",cognome:"Pizzutto",imei:"868298060601011",piano:"BASE",careGiver:"Simona Pizzutto",parentela:"figlia",telefono:"+393398444530",email:"",servizio:"eCura PRO"},{nome:"Rita",cognome:"Pennacchio",imei:"868298061123759",piano:"BASE",careGiver:"Caterina D'Alterio",parentela:"figlia",telefono:"+393398331711",email:"",servizio:"eCura PRO"},{nome:"Giuliana",cognome:"Balzarotti",imei:"868298061206968",piano:"BASE",careGiver:"Paolo Magr√¨",parentela:"figlio",telefono:"+393312826048",email:"",servizio:"eCura PRO"}];let a=0,i=0,s=0;for(const r of e){const l=new Date().toISOString(),c=`CTR-${r.cognome.toUpperCase()}-2025`;let d=null;const u=await o.env.DB.prepare("SELECT id FROM leads WHERE email = ? OR (nomeAssistito = ? AND cognomeAssistito = ?)").bind(r.email||"",r.nome,r.cognome).first();u?d=u.id:(d=`LEAD-${r.cognome.toUpperCase()}-${Date.now()}`,await o.env.DB.prepare(`
          INSERT INTO leads (
            id, nomeRichiedente, cognomeRichiedente, email, telefono,
            nomeAssistito, cognomeAssistito, tipoServizio, status, note, created_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'CONVERTED', ?, ?)
        `).bind(d,r.careGiver,"",r.email||`${r.cognome.toLowerCase()}@assistito.it`,r.telefono,r.nome,r.cognome,r.servizio,`Piano ${r.piano} - IMEI: ${r.imei}`,l).run(),a++);const p=await o.env.DB.prepare(`
        SELECT c.id, c.leadId FROM contracts c
        LEFT JOIN leads l ON c.leadId = l.id
        WHERE c.leadId = ? 
           OR (c.codice_contratto = ?)
           OR (l.nomeAssistito = ? AND l.cognomeAssistito = ?)
        LIMIT 1
      `).bind(d,c,r.nome,r.cognome).first();if(p)await o.env.DB.prepare(`
          UPDATE contracts
          SET imei_dispositivo = ?, 
              codice_contratto = ?, 
              tipo_contratto = ?,
              prezzo_totale = ?,
              prezzo_mensile = ?
          WHERE id = ?
        `).bind(r.imei,c,r.piano,r.piano==="AVANZATO"?840:480,r.piano==="AVANZATO"?69:39,p.id).run(),s++,console.log(`‚úÖ Contratto aggiornato: ${c} con IMEI ${r.imei}`);else{const g=`CONTRACT-${r.cognome.toUpperCase()}-${Date.now()}`,m=r.piano==="AVANZATO"?840:480;await o.env.DB.prepare(`
          INSERT INTO contracts (
            id, leadId, codice_contratto, tipo_contratto, status, 
            prezzo_totale, imei_dispositivo, created_at,
            template_utilizzato, contenuto_html, prezzo_mensile, durata_mesi
          ) VALUES (?, ?, ?, ?, 'SIGNED', ?, ?, ?, 'BASE', '', ?, 12)
        `).bind(g,d,c,r.piano,m,r.imei,l,r.piano==="AVANZATO"?69:39).run(),i++,console.log(`‚úÖ Contratto creato: ${c} per ${r.nome} ${r.cognome}`)}}return o.json({success:!0,message:"FORCE INIT completato con UPDATE contratti",stats:{leadsCreated:a,contractsCreated:i,contractsUpdated:s,assistitiTotali:e.length}})}catch(e){return console.error("‚ùå FORCE ERROR:",e),o.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.get("/api/assistiti",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const e=o.req.query("id");let a="WHERE a.status = 'ATTIVO'";const i=[];e&&(a+=" AND a.id = ?",i.push(parseInt(e)));const s=await o.env.DB.prepare(`
      SELECT 
        a.id,
        a.codice,
        a.nome,
        a.nome_assistito,
        a.cognome_assistito,
        a.nome_caregiver,
        a.cognome_caregiver,
        a.parentela_caregiver,
        a.email,
        a.telefono,
        a.imei,
        a.servizio,
        a.piano,
        a.status,
        a.lead_id,
        a.created_at,
        c.id as contratto_id,
        c.codice_contratto,
        c.tipo_contratto as piano_contratto,
        c.servizio as servizio_contratto,
        c.status as contratto_status
      FROM assistiti a
      LEFT JOIN contracts c ON a.lead_id = c.leadId
      ${a}
      ORDER BY a.created_at DESC
    `).bind(...i).all();return o.json({success:!0,count:s.results.length,assistiti:s.results})}catch(e){return console.error("‚ùå Errore recupero assistiti:",e),o.json({success:!1,error:"Errore recupero assistiti",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/assistiti",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const e=await o.req.json();if(!e.nome||!e.cognome)return o.json({success:!1,error:"Campi obbligatori mancanti: nome, cognome"},400);const a=`ASS-${e.cognome.toUpperCase()}-${Date.now()}`,i=new Date().toISOString();return await o.env.DB.prepare(`
      INSERT INTO assistiti (
        codice, nome, email, telefono, imei, status, created_at
      ) VALUES (?, ?, ?, ?, ?, 'ATTIVO', ?)
    `).bind(a,`${e.nome} ${e.cognome}`,e.email||"",e.telefono||"",e.imei||"",i).run(),console.log("‚úÖ Assistito creato:",a),o.json({success:!0,message:"Assistito creato con successo",codice:a,assistito:{codice:a,nome:`${e.nome} ${e.cognome}`,email:e.email,telefono:e.telefono,imei:e.imei}})}catch(e){return console.error("‚ùå Errore creazione assistito:",e),o.json({success:!1,error:"Errore creazione assistito",details:e instanceof Error?e.message:String(e)},500)}});I.put("/api/assistiti/:id",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const e=o.req.param("id"),a=await o.req.json();if(!await o.env.DB.prepare("SELECT id FROM assistiti WHERE id = ?").bind(e).first())return o.json({success:!1,error:"Assistito non trovato"},404);let s=!1;try{await o.env.DB.prepare(`
        UPDATE assistiti 
        SET nome = ?, 
            nome_assistito = ?, 
            cognome_assistito = ?,
            nome_caregiver = ?,
            cognome_caregiver = ?,
            parentela_caregiver = ?,
            email = ?, 
            telefono = ?, 
            imei = ?,
            servizio = ?,
            piano = ?,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = ?
      `).bind(`${a.nome_assistito||""} ${a.cognome_assistito||""}`.trim()||a.nome||"N/A",a.nome_assistito||"",a.cognome_assistito||"",a.nome_caregiver||"",a.cognome_caregiver||"",a.parentela_caregiver||"",a.email||"",a.telefono||"",a.imei||"",a.servizio||"eCura PRO",a.piano||"BASE",e).run(),s=!0,console.log(`‚úÖ Assistito aggiornato con servizio: ${a.servizio||"eCura PRO"}, piano: ${a.piano||"BASE"}`)}catch(r){if(r.message&&(r.message.includes("no column named piano")||r.message.includes("no column named servizio")))console.warn("‚ö†Ô∏è Colonne piano/servizio non trovate, provo UPDATE base"),await o.env.DB.prepare(`
          UPDATE assistiti 
          SET nome = ?, 
              nome_assistito = ?, 
              cognome_assistito = ?,
              nome_caregiver = ?,
              cognome_caregiver = ?,
              parentela_caregiver = ?,
              email = ?, 
              telefono = ?, 
              imei = ?,
              updated_at = CURRENT_TIMESTAMP
          WHERE id = ?
        `).bind(`${a.nome_assistito||""} ${a.cognome_assistito||""}`.trim()||a.nome||"N/A",a.nome_assistito||"",a.cognome_assistito||"",a.nome_caregiver||"",a.cognome_caregiver||"",a.parentela_caregiver||"",a.email||"",a.telefono||"",a.imei||"",e).run(),s=!0,console.log("‚úÖ Assistito aggiornato (senza piano/servizio)");else throw r}return console.log("‚úÖ Assistito aggiornato:",e),o.json({success:!0,message:"Assistito aggiornato con successo"})}catch(e){return console.error("‚ùå Errore aggiornamento assistito:",e),o.json({success:!1,error:"Errore aggiornamento assistito",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/setup-email-counter",async o=>{var t;try{return(t=o.env)!=null&&t.DB?(console.log("üìä Setup email counter..."),await o.env.DB.prepare(`
      CREATE TABLE IF NOT EXISTS stats (
        id INTEGER PRIMARY KEY DEFAULT 1,
        emails_sent_30days INTEGER DEFAULT 0,
        last_reset_date TEXT DEFAULT (date('now')),
        updated_at TEXT DEFAULT (datetime('now'))
      )
    `).run(),await o.env.DB.prepare(`
      INSERT OR REPLACE INTO stats (id, emails_sent_30days, last_reset_date, updated_at)
      VALUES (1, 32, date('now'), datetime('now'))
    `).run(),console.log("‚úÖ Email counter creato con valore 32"),o.json({success:!0,message:"Email counter inizializzato",current_count:32})):o.json({success:!1,error:"Database non configurato"},500)}catch(e){return console.error("‚ùå Errore setup email counter:",e),o.json({success:!1,error:e.message},500)}});I.post("/api/migrate-schema",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);console.log("üîÑ MIGRAZIONE SCHEMA DATABASE...");const e=[];try{await o.env.DB.prepare(`
        ALTER TABLE assistiti 
        ADD COLUMN servizio TEXT DEFAULT 'eCura PRO'
      `).run(),e.push("‚úÖ Colonna servizio aggiunta"),console.log("‚úÖ Colonna servizio aggiunta")}catch(i){i.message&&i.message.includes("duplicate column")?(e.push("‚ÑπÔ∏è Colonna servizio gi√† esiste"),console.log("‚ÑπÔ∏è Colonna servizio gi√† esiste")):e.push(`‚ö†Ô∏è Errore colonna servizio: ${i.message}`)}try{await o.env.DB.prepare(`
        ALTER TABLE assistiti 
        ADD COLUMN piano TEXT DEFAULT 'BASE'
      `).run(),e.push("‚úÖ Colonna piano aggiunta"),console.log("‚úÖ Colonna piano aggiunta")}catch(i){i.message&&i.message.includes("duplicate column")?(e.push("‚ÑπÔ∏è Colonna piano gi√† esiste"),console.log("‚ÑπÔ∏è Colonna piano gi√† esiste")):e.push(`‚ö†Ô∏è Errore colonna piano: ${i.message}`)}try{const i=await o.env.DB.prepare(`
        UPDATE assistiti 
        SET piano = 'AVANZATO', servizio = 'eCura PRO'
        WHERE (nome_assistito LIKE '%Eileen%' AND cognome_assistito LIKE '%King%')
           OR (nome_caregiver LIKE '%Elena%' AND cognome_caregiver LIKE '%Saglia%')
      `).run();i.changes&&i.changes>0?e.push(`‚úÖ Eileen aggiornata a AVANZATO (${i.changes} record)`):e.push("‚ÑπÔ∏è Eileen non trovata o gi√† aggiornata")}catch(i){e.push(`‚ö†Ô∏è Errore aggiornamento Eileen: ${i.message}`)}const a=[{name:"luogoNascitaAssistito",type:"TEXT",default:null},{name:"dataNascitaAssistito",type:"TEXT",default:null},{name:"indirizzoAssistito",type:"TEXT",default:null},{name:"capAssistito",type:"TEXT",default:null},{name:"cittaAssistito",type:"TEXT",default:null},{name:"provinciaAssistito",type:"TEXT",default:null},{name:"codiceFiscaleAssistito",type:"TEXT",default:null},{name:"condizioniSalute",type:"TEXT",default:null},{name:"intestatarioContratto",type:"TEXT",default:"'richiedente'"}];for(const i of a)try{const s=i.default?`DEFAULT ${i.default}`:"";await o.env.DB.prepare(`
          ALTER TABLE leads 
          ADD COLUMN ${i.name} ${i.type} ${s}
        `).run(),e.push(`‚úÖ Colonna ${i.name} aggiunta a leads`),console.log(`‚úÖ Colonna ${i.name} aggiunta a leads`)}catch(s){s.message&&s.message.includes("duplicate column")?(e.push(`‚ÑπÔ∏è Colonna ${i.name} gi√† esiste`),console.log(`‚ÑπÔ∏è Colonna ${i.name} gi√† esiste`)):e.push(`‚ö†Ô∏è Errore colonna ${i.name}: ${s.message}`)}return o.json({success:!0,message:"Migrazione schema completata",migrations:e})}catch(e){return console.error("‚ùå Errore migrazione schema:",e),o.json({success:!1,error:"Errore migrazione schema",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/assistiti/debug-eileen",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);console.log("üîç Debug Eileen Elisabeth King...");const e=await o.env.DB.prepare(`
      SELECT * 
      FROM assistiti 
      WHERE (nome_assistito LIKE '%Eileen%' OR cognome_assistito LIKE '%King%')
         OR (nome_caregiver LIKE '%Elena%' AND cognome_caregiver LIKE '%Saglia%')
      LIMIT 1
    `).first();if(!e)return o.json({success:!1,error:"Eileen non trovata"},404);let a=!1;try{await o.env.DB.prepare("SELECT piano FROM assistiti LIMIT 1").first(),a=!0}catch{a=!1}return o.json({success:!0,eileen:e,has_piano_column:a,note:a?`Piano attuale: ${e.piano||"NULL"}`:"Colonna piano non esiste - esegui /api/assistiti/add-piano-column"})}catch(e){return console.error("‚ùå Errore debug Eileen:",e),o.json({success:!1,error:"Errore debug Eileen",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/assistiti/add-piano-column",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);console.log("üîß Aggiunta colonna piano alla tabella assistiti...");try{await o.env.DB.prepare(`
        ALTER TABLE assistiti 
        ADD COLUMN piano TEXT DEFAULT 'BASE'
      `).run(),console.log("‚úÖ Colonna piano aggiunta con successo");const e=await o.env.DB.prepare(`
        UPDATE assistiti 
        SET piano = 'AVANZATO'
        WHERE (nome_assistito LIKE '%Eileen%' OR cognome_assistito LIKE '%King%')
           OR (nome_caregiver LIKE '%Elena%' AND cognome_caregiver LIKE '%Saglia%')
      `).run();return o.json({success:!0,message:"Colonna piano aggiunta con successo",eileen_updated:e.changes||0})}catch(e){if(e.message&&e.message.includes("duplicate column"))return o.json({success:!0,message:"Colonna piano gi√† esistente",note:"Nessuna modifica necessaria"});throw e}}catch(e){return console.error("‚ùå Errore aggiunta colonna piano:",e),o.json({success:!1,error:"Errore aggiunta colonna piano",details:e instanceof Error?e.message:String(e)},500)}});I.post("/api/assistiti/fix-eileen",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);console.log("üîß Correzione piano Eileen Elisabeth King...");const e=await o.env.DB.prepare(`
      SELECT id, nome_assistito, cognome_assistito, piano 
      FROM assistiti 
      WHERE (nome_assistito LIKE '%Eileen%' OR cognome_assistito LIKE '%King%')
         OR (nome_caregiver LIKE '%Elena%' AND cognome_caregiver LIKE '%Saglia%')
    `).all();if(!e.results||e.results.length===0)return o.json({success:!1,error:"Eileen non trovata"},404);const a=e.results[0];return console.log(`Found: ${a.nome_assistito} ${a.cognome_assistito}, Piano attuale: ${a.piano}`),await o.env.DB.prepare(`
      UPDATE assistiti 
      SET piano = 'AVANZATO',
          updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(a.id).run(),console.log(`‚úÖ Piano aggiornato: ${a.id} -> AVANZATO`),o.json({success:!0,message:"Piano Eileen aggiornato a AVANZATO",assistito:{id:a.id,nome:`${a.nome_assistito} ${a.cognome_assistito}`,piano_precedente:a.piano,piano_nuovo:"AVANZATO"}})}catch(e){return console.error("‚ùå Errore fix Eileen:",e),o.json({success:!1,error:"Errore fix Eileen",details:e instanceof Error?e.message:String(e)},500)}});I.delete("/api/assistiti/:id",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const e=o.req.param("id");if(!await o.env.DB.prepare("SELECT id, nome FROM assistiti WHERE id = ?").bind(e).first())return o.json({success:!1,error:"Assistito non trovato"},404);const i=await o.env.DB.prepare("SELECT COUNT(*) as count FROM contracts WHERE imei_dispositivo = (SELECT imei FROM assistiti WHERE id = ?)").bind(e).first();return i&&i.count>0?o.json({success:!1,error:"Impossibile eliminare: assistito ha contratti associati",hasContracts:!0},400):(await o.env.DB.prepare(`
      UPDATE assistiti 
      SET status = 'ELIMINATO'
      WHERE id = ?
    `).bind(e).run(),console.log("‚úÖ Assistito eliminato (soft):",e),o.json({success:!0,message:"Assistito eliminato con successo"}))}catch(e){return console.error("‚ùå Errore eliminazione assistito:",e),o.json({success:!1,error:"Errore eliminazione assistito",details:e instanceof Error?e.message:String(e)},500)}});I.get("/api/assistiti/debug-schema",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const e=await o.env.DB.prepare("SELECT * FROM assistiti LIMIT 1").first(),a=await o.env.DB.prepare("SELECT * FROM assistiti WHERE nome_assistito LIKE '%Eileen%' OR cognome_assistito LIKE '%King%' LIMIT 1").first(),i=await o.env.DB.prepare("SELECT COUNT(*) as count FROM assistiti").first();return o.json({success:!0,schema:{columns:e?Object.keys(e):[],hasServizioColumn:e&&"servizio"in e,hasPianoColumn:e&&"piano"in e},eileen:a||null,totalAssistiti:(i==null?void 0:i.count)||0,sampleRow:e})}catch(e){return o.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.post("/api/assistiti/force-fix-eileen",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const e=[],a=await o.env.DB.prepare("SELECT * FROM assistiti LIMIT 1").first(),i=a&&"servizio"in a,s=a&&"piano"in a;if(e.push({step:1,name:"Verifica colonne",hasServizio:i,hasPiano:s,columns:a?Object.keys(a):[]}),i)e.push({step:2,name:"Colonna servizio",status:"‚ÑπÔ∏è Gi√† esiste"});else try{await o.env.DB.prepare("ALTER TABLE assistiti ADD COLUMN servizio TEXT DEFAULT 'eCura PRO'").run(),e.push({step:2,name:"Colonna servizio",status:"‚úÖ Aggiunta"})}catch(d){e.push({step:2,name:"Colonna servizio",status:`‚ùå ${d.message}`})}if(s)e.push({step:3,name:"Colonna piano",status:"‚ÑπÔ∏è Gi√† esiste"});else try{await o.env.DB.prepare("ALTER TABLE assistiti ADD COLUMN piano TEXT DEFAULT 'BASE'").run(),e.push({step:3,name:"Colonna piano",status:"‚úÖ Aggiunta"})}catch(d){e.push({step:3,name:"Colonna piano",status:`‚ùå ${d.message}`})}const r=await o.env.DB.prepare(`
      SELECT id, nome_assistito, cognome_assistito, nome_caregiver, cognome_caregiver, servizio, piano
      FROM assistiti 
      WHERE (nome_assistito LIKE '%Eileen%' OR cognome_assistito LIKE '%King%')
         OR (nome_caregiver LIKE '%Elena%' OR cognome_caregiver LIKE '%Saglia%')
      LIMIT 1
    `).first();if(!r)return e.push({step:4,name:"Cerca Eileen",status:"‚ùå NON TROVATA"}),o.json({success:!1,error:"Eileen non trovata",steps:e});e.push({step:4,name:"Cerca Eileen",status:"‚úÖ TROVATA",eileen:{id:r.id,nome:r.nome_assistito,cognome:r.cognome_assistito,caregiver:`${r.nome_caregiver} ${r.cognome_caregiver}`,servizio_attuale:r.servizio||"NULL",piano_attuale:r.piano||"NULL"}});const l=await o.env.DB.prepare(`
      UPDATE assistiti 
      SET servizio = 'eCura PRO', piano = 'AVANZATO'
      WHERE id = ?
    `).bind(r.id).run();e.push({step:5,name:"Aggiorna Eileen",status:l.changes&&l.changes>0?"‚úÖ AGGIORNATA":"‚ùå FALLITO",changes:l.changes||0});const c=await o.env.DB.prepare(`
      SELECT id, nome_assistito, cognome_assistito, servizio, piano
      FROM assistiti 
      WHERE id = ?
    `).bind(r.id).first();return e.push({step:6,name:"Verifica finale",eileen_dopo:{servizio:c==null?void 0:c.servizio,piano:c==null?void 0:c.piano},success:(c==null?void 0:c.servizio)==="eCura PRO"&&(c==null?void 0:c.piano)==="AVANZATO"}),o.json({success:!0,message:"Fix Eileen completato",steps:e,eileen_before:r,eileen_after:c})}catch(e){return o.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.get("/api/data/stats",async o=>{var t;try{console.log("üìä [STATS] Inizio calcolo statistiche..."),console.log("üìä [STATS] Env keys:",Object.keys(o.env||{})),console.log("üìä [STATS] c.env.DB:",!!((t=o.env)!=null&&t.DB));const e=o.env.DB;console.log("‚úÖ [STATS] DB reference obtained, procedo con le query");const a=new Date;a.setUTCHours(0,0,0,0);const i=a.toISOString();console.log("üìä [STATS] Data oggi (UTC 00:00):",i);const s=await e.prepare("SELECT COUNT(*) as count FROM leads WHERE created_at >= ?").bind(i).first();console.log("üìä [STATS] Lead oggi result:",s);const r=await e.prepare("SELECT COUNT(*) as count FROM contracts WHERE created_at >= ?").bind(i).first(),l=await e.prepare('SELECT COUNT(*) as count FROM contracts WHERE created_at >= ? AND status IN ("DRAFT", "PENDING")').bind(i).first(),c=await e.prepare('SELECT COUNT(*) as count FROM contracts WHERE created_at >= ? AND status IN ("PAID", "PAGATO")').bind(i).first(),d=await e.prepare('SELECT COUNT(*) as count FROM leads WHERE created_at >= ? AND status IN ("CONFIG", "IN_CONFIGURAZIONE")').bind(i).first(),u=await e.prepare('SELECT COUNT(*) as count FROM leads WHERE created_at >= ? AND status IN ("ACTIVE", "ATTIVO")').bind(i).first(),p=new Date;p.setDate(p.getDate()-30),p.setUTCHours(0,0,0,0);const g=p.toISOString();console.log("üìä [STATS] Data 30 giorni fa:",g);const m=await e.prepare("SELECT COUNT(*) as count FROM leads").first();console.log("üìä [STATS] Total leads:",m==null?void 0:m.count),console.log("üìä [STATS] Lettura contatore email...");const v=await e.prepare(`
      SELECT emails_sent_30days, last_reset_date FROM stats WHERE id = 1
    `).first();let b=0;v?(b=v.emails_sent_30days||0,console.log("üìä [STATS] Email count dal DB:",b),console.log("üìä [STATS] Last reset:",v.last_reset_date)):console.warn("‚ö†Ô∏è  [STATS] Contatore email non trovato - usa 0"),console.log("üìä [STATS] emailsMonth finale:",b);const E=await e.prepare(`
      SELECT servizio, COUNT(*) as count 
      FROM leads 
      WHERE created_at >= ? AND servizio IS NOT NULL
      GROUP BY servizio 
      ORDER BY count DESC 
      LIMIT 1
    `).bind(g).first();return console.log("üìä Stats Oggi:",{leadsToday:s==null?void 0:s.count,totalLeads:m==null?void 0:m.count,contractsToday:r==null?void 0:r.count,proformaToday:l==null?void 0:l.count,paymentsToday:c==null?void 0:c.count,configurationsToday:d==null?void 0:d.count,activationsToday:u==null?void 0:u.count,emailsMonth:b,topService:E==null?void 0:E.servizio}),o.json({success:!0,totalLeads:(m==null?void 0:m.count)||0,leadsToday:(s==null?void 0:s.count)||0,contractsToday:(r==null?void 0:r.count)||0,proformaToday:(l==null?void 0:l.count)||0,paymentsToday:(c==null?void 0:c.count)||0,configurationsToday:(d==null?void 0:d.count)||0,activationsToday:(u==null?void 0:u.count)||0,emailsMonth:b||0,topService:(E==null?void 0:E.servizio)||"N/A",timestamp:new Date().toISOString()})}catch(e){return console.error("‚ùå Errore statistiche data dashboard:",e),console.error("Error details:",e instanceof Error?e.message:String(e)),console.error("Error stack:",e instanceof Error?e.stack:"no stack"),o.json({success:!0,totalLeads:0,leadsToday:0,contractsToday:0,proformaToday:0,paymentsToday:0,configurationsToday:0,activationsToday:0,emailsMonth:0,topService:"N/A",timestamp:new Date().toISOString(),fallback:!0,error:e instanceof Error?e.message:String(e),errorStack:e instanceof Error?e.stack:void 0})}});I.get("/api/logs",async o=>{var t;try{const e=o.req.query("level")||"all";if(!((t=o.env)!=null&&t.DB)){const s=[{id:1,timestamp:new Date().toISOString(),level:"info",message:"Sistema TeleMedCare avviato correttamente"},{id:2,timestamp:new Date(Date.now()-3e5).toISOString(),level:"info",message:"Nuovo lead registrato: Mario Rossi"},{id:3,timestamp:new Date(Date.now()-6e5).toISOString(),level:"warn",message:"Dispositivo SiDLY-001 batteria bassa"},{id:4,timestamp:new Date(Date.now()-9e5).toISOString(),level:"error",message:"Tentativo di connessione fallito per assistito ASS-2024-005"}],r=e==="all"?s:s.filter(l=>l.level===e);return o.json({success:!0,count:r.length,logs:r})}let a="SELECT * FROM system_logs ORDER BY timestamp DESC LIMIT 100";e!=="all"&&(a="SELECT * FROM system_logs WHERE level = ? ORDER BY timestamp DESC LIMIT 100");const i=e==="all"?await o.env.DB.prepare(a).all():await o.env.DB.prepare(a).bind(e).all();return o.json({success:!0,count:i.results.length,logs:i.results})}catch(e){return console.error("‚ùå Errore recupero logs:",e),o.json({success:!1,error:"Errore recupero logs"},500)}});I.post("/api/test/functional/run",async o=>{var t;try{const{testType:e}=await o.req.json(),a=`LEAD-TEST-${Date.now()}`,i=`ASS-TEST-${Date.now()}`;return await new Promise(s=>setTimeout(s,500)),(t=o.env)!=null&&t.DB?o.json({success:!1,error:"Database test not implemented yet"}):(console.log(`‚úÖ [TEST] Test funzionale completato: ${a} ‚Üí ${i}`),o.json({success:!0,testType:e,leadId:a,assistitoId:i,steps:[{step:"lead_creation",status:"success",duration:"120ms"},{step:"email_sequence",status:"success",duration:"340ms"},{step:"lead_conversion",status:"success",duration:"89ms"},{step:"workflow_execution",status:"success",duration:"156ms"},{step:"contract_generation",status:"success",duration:"234ms"},{step:"device_configuration",status:"success",duration:"78ms"}],totalDuration:"1.017s",timestamp:new Date().toISOString()}))}catch(e){return console.error("‚ùå Errore test funzionale:",e),o.json({success:!1,error:"Test funzionale fallito",details:e.message},500)}});I.post("/api/test/complete-workflow",async o=>{try{const{partner:t="IRBEMA",cycles:e=1,enableEmails:a=!1}=await o.req.json(),i=[];for(let d=0;d<e;d++){const u=Date.now(),p=`TEST360-${t}-${Date.now()}-${d}`;console.log(`üîÑ [TEST 360¬∞] Ciclo ${d+1}/${e} - Partner: ${t}`);try{const g={partner:t,nomeRichiedente:`Test User ${d+1}`,emailRichiedente:`test.user.${d+1}@example.com`,telefonoRichiedente:`+39 345 ${String(Math.floor(Math.random()*9999999)).padStart(7,"0")}`,eta:Math.floor(Math.random()*40)+25,patologia:t==="IRBEMA"?"Cardiologia":t==="Luxottica"?"Oftalmologia":"Generale",provincia:["Milano","Roma","Torino","Napoli"][Math.floor(Math.random()*4)],consensoPrivacy:!0,consensoMarketing:!0};if(await new Promise(C=>setTimeout(C,Math.random()*200+100)),a){const C=["NOTIFICA_INFO","DOCUMENTI_INFORMATIVI","RICHIESTA_CONFERMA","INVIO_CONTRATTO"];for(const M of C)await new Promise(B=>setTimeout(B,Math.random()*100+50)),console.log(`  üìß Email inviata: ${M}`)}const m={...g,tipoServizio:"TeleAssistenza Base",dataAttivazione:new Date().toISOString().split("T")[0],status:"ATTIVO"};await new Promise(C=>setTimeout(C,Math.random()*150+75));const v={tipo_contratto:"Base",prezzo_primo_anno:480,prezzo_rinnovo:240,durata_contratto:12,data_firma:new Date().toISOString()};await new Promise(C=>setTimeout(C,Math.random()*300+150)),console.log("  üìÑ Contratto generato e firmato digitalmente");const b={numero_proforma:`PRO-${Date.now()}-${d}`,importo:v.prezzo_primo_anno,metodo_pagamento:"Stripe",status:"PAGATO"};await new Promise(C=>setTimeout(C,Math.random()*200+100)),console.log(`  üí≥ Proforma generata e pagamento processato: ‚Ç¨${b.importo}`);const E={device_id:`SiDLY${String(Math.floor(Math.random()*999)+1).padStart(3,"0")}`,imei:`86012345678${String(Math.floor(Math.random()*99999)).padStart(5,"0")}`,model:"SiDLY Care Pro V12",status:"ASSIGNED"};await new Promise(C=>setTimeout(C,Math.random()*100+50)),console.log(`  üì± Dispositivo assegnato: ${E.device_id}`),a&&(await new Promise(C=>setTimeout(C,Math.random()*100+50)),console.log("  ‚úÖ Email attivazione servizio inviata"));const R=Date.now()-u,S={cycle:d+1,partner:t,batchId:p,success:!0,duration:`${R}ms`,steps:{lead_generation:"SUCCESS",email_sequence:a?"SUCCESS":"SKIPPED",lead_conversion:"SUCCESS",contract_signature:"SUCCESS",proforma_payment:"SUCCESS",device_assignment:"SUCCESS",service_activation:"SUCCESS"},data:{leadData:g,assistitoData:m,contractData:v,proformaData:b,deviceData:E},timestamp:new Date().toISOString()};i.push(S),console.log(`‚úÖ [TEST 360¬∞] Ciclo ${d+1} completato con successo in ${R}ms`)}catch(g){console.error(`‚ùå [TEST 360¬∞] Errore nel ciclo ${d+1}:`,g),i.push({cycle:d+1,partner:t,batchId:p,success:!1,error:g.message,timestamp:new Date().toISOString()})}}const s=i.filter(d=>d.success).length,r=i.filter(d=>!d.success).length,l=i.reduce((d,u)=>d+(parseInt(u.duration)||0),0),c=Math.round(l/e);return console.log(`üéØ [TEST 360¬∞] COMPLETATO - ${s}/${e} successi`),o.json({success:!0,summary:{partner:t,totalCycles:e,successfulCycles:s,failedCycles:r,successRate:`${(s/e*100).toFixed(1)}%`,totalDuration:`${l}ms`,avgDuration:`${c}ms`,emailsEnabled:a},results:i,timestamp:new Date().toISOString()})}catch(t){return console.error("‚ùå [TEST 360¬∞] Errore generale:",t),o.json({success:!1,error:"Test workflow 360¬∞ fallito",details:t.message},500)}});I.post("/api/test/all-partners-workflow",async o=>{try{const{cyclesPerPartner:t=5,enableEmails:e=!1}=await o.req.json(),a=["IRBEMA","Luxottica","Pirelli","FAS"],i=[];console.log(`üöÄ [MULTI-PARTNER TEST] Inizio test con ${a.length} partner, ${t} cicli ciascuno`);for(const d of a){console.log(`üîÑ [MULTI-PARTNER TEST] Testing partner: ${d}`);const p=await(await fetch("http://localhost:3000/api/test/complete-workflow",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({partner:d,cycles:t,enableEmails:e})})).json();i.push({partner:d,...p})}const s=a.length*t,r=i.reduce((d,u)=>{var p;return d+(((p=u.summary)==null?void 0:p.successfulCycles)||0)},0),l=i.reduce((d,u)=>{var p;return d+(((p=u.summary)==null?void 0:p.failedCycles)||0)},0),c=(r/s*100).toFixed(1);return console.log(`üéØ [MULTI-PARTNER TEST] COMPLETATO - ${r}/${s} successi globali (${c}%)`),o.json({success:!0,globalSummary:{partnersGestioned:a.length,cyclesPerPartner:t,totalCycles:s,totalSuccessful:r,totalFailed:l,overallSuccessRate:`${c}%`,emailsEnabled:e},partnerResults:i,timestamp:new Date().toISOString()})}catch(t){return console.error("‚ùå [MULTI-PARTNER TEST] Errore:",t),o.json({success:!1,error:"Test multi-partner fallito",details:t.message},500)}});I.post("/api/test/stress/create-assistito",async o=>{var t;try{const{batchId:e,index:a,total:i}=await o.req.json(),s=`STRESS-${e}-${String(a).padStart(3,"0")}`,r=Math.random()*200+50;if(await new Promise(l=>setTimeout(l,r)),Math.random()<.05)throw new Error("Random failure simulation");return(t=o.env)!=null&&t.DB?o.json({success:!1,error:"Database stress test not implemented yet"}):(console.log(`‚úÖ [STRESS] Assistito creato: ${s} (${a}/${i})`),o.json({success:!0,assistitoCode:s,batchId:e,index:a,total:i,latency:Math.round(r),timestamp:new Date().toISOString()}))}catch(e){return console.error(`‚ùå Errore stress test assistito ${index}:`,e.message),o.json({success:!1,error:"Creazione assistito fallita",details:e.message},500)}});I.get("/api/test/stress/stats",async o=>{try{return o.json({success:!0,stats:{totalRuns:15,averageSuccessRate:94.2,lastRun:{timestamp:new Date(Date.now()-3e5).toISOString(),assistitiCreated:47,assistitiRequested:50,successRate:94,averageLatency:127},performance:{memoryUsage:"45.2MB",cpuUsage:"23%",responseTime:"89ms"}}})}catch(t){return console.error("‚ùå Errore stats stress test:",t),o.json({success:!1,error:"Errore recupero statistiche"},500)}});I.get("/api/warehouse/inventory",async o=>{try{const t=[{id:1,codice:"SiDLY-001",lotto:"LOT-2024-A001",scadenza:"2025-12-31",stock:25,minStock:10,status:"disponibile",location:"A-01-03"},{id:2,codice:"SiDLY-002",lotto:"LOT-2024-A002",scadenza:"2025-11-15",stock:8,minStock:10,status:"stock_basso",location:"A-01-04"},{id:3,codice:"CARD-001",lotto:"LOT-2024-B001",scadenza:"2026-03-20",stock:50,minStock:20,status:"disponibile",location:"B-02-01"}];return o.json({success:!0,inventory:t,totalItems:t.length})}catch{return o.json({success:!1,error:"Errore inventario"},500)}});I.get("/api/warehouse/assets",async o=>{try{const t=[{id:1,assetCode:"AST-2024-001",dispositivo:"SiDLY-001",assignedTo:"Mario Rossi",dataAssegnazione:"2024-10-01",status:"attivo",location:"Domicilio paziente",maintenanceDate:"2024-12-15"}];return o.json({success:!0,assets:t,totalAssets:t.length})}catch{return o.json({success:!1,error:"Errore assets"},500)}});I.post("/api/devices/scan-extended",async o=>{try{const{imageData:t,scanType:e,captureMethod:a}=await o.req.json(),i={success:!0,deviceCode:"SiDLY-"+Math.random().toString().substr(2,6),imei:yw(),serialNumber:"SN"+Math.random().toString().substr(2,10),lotto:"LOT-2024-"+Math.random().toString(36).substr(2,6).toUpperCase(),dataProduction:"2024-08-15",scadenza:"2025-12-31",manufacturer:"TeleMedCare Industries",model:"SiDLY Gen-2",firmwareVersion:"V2.1.3",hardwareRevision:"Rev-C",certifications:["CE","FDA","ISO13485","IEC62304"],classeMedica:"Classe IIa",marcaturaCE:"0297",udiCode:"UDI-"+Math.random().toString().substr(2,12).toUpperCase(),gtin:"8012345"+Math.random().toString().substr(2,6),captureMethod:a||"manual",imageUrl:`/storage/scans/scan-${Date.now()}.jpg`,confidence:.95,timestamp:new Date().toISOString(),scannedBy:"System",location:"Warehouse-A"};return o.json(i)}catch{return o.json({success:!1,error:"Errore scanning esteso"},500)}});I.post("/api/devices/capture-photo",async o=>{try{const{imageBlob:t,deviceInfo:e}=await o.req.json(),a=`photo-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,i=`/storage/device-photos/${a}.jpg`;return o.json({success:!0,photoId:a,photoUrl:i,deviceInfo:e,timestamp:new Date().toISOString(),message:"Foto acquisita con successo"})}catch{return o.json({success:!1,error:"Errore acquisizione foto"},500)}});function yw(){let o="86"+Math.random().toString().substr(2,12),t=0;for(let e=0;e<14;e++){let a=parseInt(o[e]);e%2===1&&(a*=2,a>9&&(a=Math.floor(a/10)+a%10)),t+=a}return o+(10-t%10)%10}I.post("/api/email/preview/:templateId",async o=>{try{const t=o.req.param("templateId"),{variables:e}=await o.req.json(),i={invio_contratto:{subject:"üìã TeleMedCare - Il tuo contratto √® pronto!",html:`
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <div style="background: #3B82F6; color: white; padding: 20px; text-align: center;">
              <h1>TeleMedCare</h1>
              <h2>Il tuo contratto √® pronto!</h2>
            </div>
            <div style="padding: 20px;">
              <p>Gentile <strong>${e.NOME_CLIENTE||"Cliente"}</strong>,</p>
              <p>Il tuo contratto per il piano <strong>${e.PIANO_SERVIZIO||"SiDLY Care Pro"}</strong> √® stato generato e firmato digitalmente.</p>
              <div style="background: #F3F4F6; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <p><strong>Piano:</strong> ${e.PIANO_SERVIZIO||"SiDLY Care Pro"}</p>
                <p><strong>Prezzo:</strong> ${e.PREZZO_PIANO||"‚Ç¨299,00"}</p>
                <p><strong>Codice Cliente:</strong> ${e.CODICE_CLIENTE||"TMC-2024-001"}</p>
              </div>
              <p>Troverai il contratto in allegato. Per qualsiasi domanda, contattaci.</p>
              <p>Cordiali saluti,<br><strong>Team TeleMedCare</strong></p>
            </div>
          </div>
        `},invio_proforma:{subject:`üí∞ TeleMedCare - Fattura Proforma per ${e.PIANO_SERVIZIO||"SiDLY Care Pro"}`,html:`
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <div style="background: #F59E0B; color: white; padding: 20px; text-align: center;">
              <h1>TeleMedCare</h1>
              <h2>Fattura Proforma</h2>
            </div>
            <div style="padding: 20px;">
              <p>Gentile <strong>${e.NOME_CLIENTE||"Cliente"}</strong>,</p>
              <p>Abbiamo preparato la fattura proforma per il tuo piano TeleMedCare.</p>
              <div style="background: #FEF3C7; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <p><strong>Importo:</strong> ${e.IMPORTO_TOTALE||"‚Ç¨299,00"}</p>
                <p><strong>Scadenza Pagamento:</strong> ${e.SCADENZA_PAGAMENTO||"2024-11-15"}</p>
                <p><strong>Codice Cliente:</strong> ${e.CODICE_CLIENTE||"TMC-2024-001"}</p>
              </div>
              <p>Procedi con il pagamento per attivare il servizio.</p>
              <p>Cordiali saluti,<br><strong>Team TeleMedCare</strong></p>
            </div>
          </div>
        `}}[t];return i?o.json({success:!0,preview:{renderedSubject:i.subject,renderedContent:i.html,recipientEmail:e.emailCliente||"test@telemedcare.it",estimatedSize:"~15KB"}}):o.json({success:!1,error:"Template non trovato"},404)}catch{return o.json({success:!1,error:"Errore preview template"},500)}});I.post("/api/contract/preview/:contractType",async o=>{try{const t=o.req.param("contractType"),{clientData:e}=await o.req.json(),a=`
      <div style="font-family: Arial, sans-serif; padding: 40px;">
        <div style="text-align: center; border-bottom: 2px solid #3B82F6; padding-bottom: 20px;">
          <h1>CONTRATTO TELEMEDCARE</h1>
          <h2>${t.toUpperCase()}</h2>
        </div>
        
        <div style="margin: 30px 0;">
          <h3>DATI CLIENTE</h3>
          <p><strong>Nome:</strong> ${e.nome||"Mario Rossi"}</p>
          <p><strong>Email:</strong> ${e.email||"mario.rossi@example.com"}</p>
          <p><strong>Piano:</strong> ${e.piano||"SiDLY Care Pro"}</p>
          <p><strong>Prezzo:</strong> ${e.prezzo||"‚Ç¨299,00"}</p>
        </div>
        
        <div style="margin: 30px 0;">
          <h3>CONDIZIONI DI SERVIZIO</h3>
          <p>Il presente contratto disciplina l'erogazione dei servizi di telemedicina...</p>
        </div>
        
        <div style="margin: 30px 0; text-align: center;">
          <p>Generato il: ${new Date().toLocaleDateString("it-IT")}</p>
          <p><strong>TeleMedCare V12.0 Enterprise</strong></p>
        </div>
      </div>
    `;return o.json({success:!0,preview:a,pdfUrl:`/api/contract/download/${t}/${Date.now()}`,contractType:t})}catch{return o.json({success:!1,error:"Errore preview contratto"},500)}});I.post("/api/email/preview",async o=>{try{const{templateId:t,variables:e}=await o.req.json(),i={INVIO_CONTRATTO:`
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: white;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #2563eb; margin: 0;">TeleMedCare</h1>
            <p style="color: #6b7280; margin: 5px 0;">Sistema di Telemedicina Avanzato</p>
          </div>
          
          <h2 style="color: #1f2937;">üìã Il tuo contratto √® pronto!</h2>
          
          <p>Gentile <strong>${e.NOME_CLIENTE||"{{NOME_CLIENTE}}"}</strong>,</p>
          
          <p>Siamo lieti di informarti che il contratto per il servizio <strong>${e.PIANO_SERVIZIO||"{{PIANO_SERVIZIO}}"}</strong> √® stato preparato e ti √® stato inviato per la firma elettronica.</p>
          
          <div style="background: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h3 style="margin-top: 0; color: #374151;">Dettagli Contratto:</h3>
            <ul style="margin: 0; padding-left: 20px;">
              <li><strong>Piano:</strong> ${e.PIANO_SERVIZIO||"{{PIANO_SERVIZIO}}"}</li>
              <li><strong>Prezzo:</strong> ${e.PREZZO_PIANO||"{{PREZZO_PIANO}}"}</li>
              <li><strong>Codice Cliente:</strong> ${e.CODICE_CLIENTE||"{{CODICE_CLIENTE}}"}</li>
            </ul>
          </div>
          
          <p>Per procedere con l'attivazione del servizio, ti preghiamo di:</p>
          <ol>
            <li>Scaricare il contratto allegato</li>
            <li>Leggere attentamente tutti i termini</li>
            <li>Firmare digitalmente il documento</li>
            <li>Restituirci il contratto firmato</li>
          </ol>
          
          <div style="text-align: center; margin: 30px 0;">
            <a href="#" style="background: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px;">Scarica Contratto</a>
          </div>
          
          <p style="font-size: 14px; color: #6b7280; border-top: 1px solid #e5e7eb; padding-top: 20px; margin-top: 30px;">
            Grazie per aver scelto TeleMedCare.<br>
            Per assistenza: support@telemedcare.it | +39 800 123 456
          </p>
        </div>
      `,INVIO_BROCHURE:`
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: white;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #2563eb; margin: 0;">eCura</h1>
            <p style="color: #6b7280; margin: 5px 0;">La tecnologia che Le salva salute e vita</p>
            <div style="font-size: 14px; color: #64748b;">
              <strong>Medica GB S.r.l.</strong> - Startup Innovativa a Vocazione Sociale
            </div>
          </div>
          
          <h2 style="color: #1f2937;">üìö Ecco la documentazione richiesta</h2>
          
          <p>Gentile <strong>${e.NOME_CLIENTE||"{{NOME_CLIENTE}}"}</strong>,</p>
          
          <p>Grazie per l'interesse mostrato verso i nostri servizi <strong>eCura ${e.SERVIZIO||"PRO"}</strong>. Come richiesto, Le inviamo la documentazione informativa completa.</p>
          
          <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #2563eb;">
            <h3 style="margin-top: 0; color: #1e40af;">üìã Riepilogo della Sua richiesta</h3>
            <ul style="margin: 0; padding-left: 20px;">
              <li><strong>Codice pratica:</strong> ${e.LEAD_ID||"{{LEAD_ID}}"}</li>
              <li><strong>Servizio:</strong> eCura ${e.SERVIZIO||"PRO"}</li>
              <li><strong>Piano:</strong> ${e.PIANO||"BASE"}</li>
              <li><strong>Assistito:</strong> ${e.NOME_ASSISTITO||"{{NOME_ASSISTITO}}"} ${e.COGNOME_ASSISTITO||"{{COGNOME_ASSISTITO}}"}</li>
            </ul>
          </div>
          
          <div style="background: #ecfdf5; padding: 20px; border-radius: 8px; margin: 20px 0; border: 2px solid #10b981;">
            <h3 style="margin-top: 0; color: #047857;">üìÑ Documentazione Allegata</h3>
            <ul style="margin: 10px 0; padding-left: 20px;">
              <li><strong>Brochure eCura ${e.SERVIZIO||"PRO"}</strong> - Panoramica completa del servizio</li>
              <li><strong>Scheda Tecnica Dispositivo</strong> - Caratteristiche e certificazioni</li>
              <li><strong>Listino Prezzi</strong> - Dettaglio costi e piani disponibili</li>
            </ul>
          </div>
          
          <div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h3 style="margin-top: 0; color: #92400e;">üí∞ Vantaggi Economici e Fiscali</h3>
            <ul style="margin: 10px 0; padding-left: 20px;">
              <li><strong>‚úÖ Detrazione Fiscale 19%</strong> - Servizio detraibile come spesa sanitaria</li>
              <li><strong>‚úÖ Possibili Rimborsi INPS</strong> - Per ISEE sotto ‚Ç¨6.000 + Legge 104</li>
            </ul>
          </div>
          
          <p>Il nostro servizio √® pensato per garantire sicurezza, tranquillit√† e assistenza continua. Siamo a disposizione per qualsiasi chiarimento.</p>
          
          <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #e2e8f0;">
            <h3 style="margin-top: 0; color: #475569;">üìû Contatti</h3>
            <p style="margin: 5px 0;"><strong>E-MAIL:</strong> <a href="mailto:info@medicagb.it" style="color: #2563eb;">info@medicagb.it</a></p>
            <p style="margin: 5px 0;"><strong>Telefono commerciale:</strong> 335 7301206</p>
            <p style="margin: 5px 0;"><strong>Telefono tecnico:</strong> 331 64 32 390</p>
          </div>
          
          <p>Siamo lieti di accompagnarLa in questo importante passo verso una maggiore sicurezza e tranquillit√†.</p>
          
          <p><strong>Cordiali saluti,</strong><br>Il Team eCura<br><em>Medica GB S.r.l.</em></p>
          
          <div style="background: #1f2937; color: white; padding: 20px; text-align: center; font-size: 14px; margin-top: 30px; border-radius: 8px;">
            <p style="margin: 5px 0;"><strong>Medica GB S.r.l.</strong> - Startup Innovativa a Vocazione Sociale</p>
            <p style="margin: 5px 0;">Milano: Corso Garibaldi 34, 20121 | Genova: Via delle Eriche 53, 16148</p>
            <p style="margin: 5px 0;">P.IVA: 12435130963 | <a href="mailto:info@medicagb.it" style="color: #60a5fa;">info@medicagb.it</a> | www.medicagb.it</p>
          </div>
        </div>
      `,INVIO_PROFORMA:`
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: white;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #f59e0b; margin: 0;">TeleMedCare</h1>
            <p style="color: #6b7280; margin: 5px 0;">Fatturazione e Pagamenti</p>
          </div>
          
          <h2 style="color: #1f2937;">üí∞ Fattura Proforma</h2>
          
          <p>Gentile <strong>${e.NOME_CLIENTE||"{{NOME_CLIENTE}}"}</strong>,</p>
          
          <p>Ti inviamo la fattura proforma per il servizio <strong>${e.PIANO_SERVIZIO||"{{PIANO_SERVIZIO}}"}</strong>.</p>
          
          <div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #f59e0b;">
            <h3 style="margin-top: 0; color: #92400e;">Dettagli Fatturazione:</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <tr><td style="padding: 5px 0; border-bottom: 1px solid #fbbf24;"><strong>Servizio:</strong></td><td style="text-align: right; padding: 5px 0; border-bottom: 1px solid #fbbf24;">${e.PIANO_SERVIZIO||"{{PIANO_SERVIZIO}}"}</td></tr>
              <tr><td style="padding: 5px 0; border-bottom: 1px solid #fbbf24;"><strong>Importo:</strong></td><td style="text-align: right; padding: 5px 0; border-bottom: 1px solid #fbbf24;">${e.IMPORTO_TOTALE||"{{IMPORTO_TOTALE}}"}</td></tr>
              <tr><td style="padding: 5px 0; border-bottom: 1px solid #fbbf24;"><strong>Scadenza:</strong></td><td style="text-align: right; padding: 5px 0; border-bottom: 1px solid #fbbf24;">${e.SCADENZA_PAGAMENTO||"{{SCADENZA_PAGAMENTO}}"}</td></tr>
              <tr><td style="padding: 5px 0;"><strong>Codice:</strong></td><td style="text-align: right; padding: 5px 0;">${e.CODICE_CLIENTE||"{{CODICE_CLIENTE}}"}</td></tr>
            </table>
          </div>
          
          <div style="text-align: center; margin: 30px 0;">
            <a href="#" style="background: #f59e0b; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px;">Procedi al Pagamento</a>
          </div>
          
          <p style="font-size: 14px; color: #6b7280;">
            <strong>Modalit√† di pagamento disponibili:</strong><br>
            ‚Ä¢ Bonifico bancario<br>
            ‚Ä¢ Carta di credito/debito<br>
            ‚Ä¢ PayPal
          </p>
        </div>
      `,BENVENUTO:`
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: white;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #10b981; margin: 0;">üéâ Benvenuto in TeleMedCare!</h1>
            <p style="color: #6b7280; margin: 5px 0;">Il futuro della telemedicina</p>
          </div>
          
          <p>Caro <strong>${e.NOME_CLIENTE||"{{NOME_CLIENTE}}"}</strong>,</p>
          
          <p>Benvenuto nella famiglia TeleMedCare! Siamo entusiasti di averti come nuovo cliente e di poterti offrire i nostri servizi di telemedicina avanzata.</p>
          
          <div style="background: #ecfdf5; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #10b981;">
            <h3 style="margin-top: 0; color: #047857;">Il tuo piano attivo:</h3>
            <ul style="margin: 0; padding-left: 20px;">
              <li><strong>Piano:</strong> ${e.PIANO_SERVIZIO||"{{PIANO_SERVIZIO}}"}</li>
              <li><strong>Costo:</strong> ${e.COSTO_SERVIZIO||"{{COSTO_SERVIZIO}}"}</li>
              <li><strong>Data Attivazione:</strong> ${e.DATA_ATTIVAZIONE||"{{DATA_ATTIVAZIONE}}"}</li>
              <li><strong>Codice Cliente:</strong> ${e.CODICE_CLIENTE||"{{CODICE_CLIENTE}}"}</li>
            </ul>
          </div>
          
          <h3 style="color: #047857;">üåü Servizi inclusi nel tuo piano:</h3>
          <p>${e.SERVIZI_INCLUSI||"{{SERVIZI_INCLUSI}}"}</p>
          
          <div style="text-align: center; margin: 30px 0;">
            <a href="#" style="background: #10b981; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin-right: 10px;">Scarica App</a>
            <a href="#" style="background: #6b7280; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px;">Guida Utente</a>
          </div>
          
          <p>Il nostro team √® a tua disposizione per qualsiasi domanda o supporto tecnico.</p>
        </div>
      `}[t]||'<div style="text-align: center; padding: 40px; color: #ef4444;">Template non trovato</div>';return o.json({success:!0,preview:i,templateId:t,variables:Object.keys(e||{})})}catch{return o.json({success:!1,error:"Errore generazione preview"},500)}});I.post("/api/email/test-send",async o=>{try{const{templateId:t,variables:e,testEmail:a}=await o.req.json();return await new Promise(i=>setTimeout(i,1e3)),o.json({success:!0,message:`Email test inviata a ${a}`,templateId:t,timestamp:new Date().toISOString()})}catch{return o.json({success:!1,error:"Errore invio email test"},500)}});I.get("/admin/docs",o=>o.html(`
    <!DOCTYPE html>
    <html lang="it">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>TeleMedCare V12.0 - Centro Documentazione</title>
        <script src="https://cdn.tailwindcss.com"><\/script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .doc-card { transition: all 0.3s ease; }
            .doc-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
            .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <div class="min-h-screen">
            <!-- Header -->
            <header class="gradient-bg shadow-lg">
                <div class="container mx-auto px-6 py-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <i class="fas fa-book text-3xl text-white"></i>
                            <div>
                                <h1 class="text-2xl font-bold text-white">Centro Documentazione TeleMedCare</h1>
                                <p class="text-blue-100">Manuali utente, deployment e dispositivi medici</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="px-3 py-1 bg-green-500 text-white rounded-full text-sm cursor-pointer" onclick="showSystemStatus()">
                                <i class="fas fa-server mr-1"></i>Sistema Online
                            </span>
                            <a href="/home" class="px-3 py-2 bg-white text-blue-600 rounded-lg hover:bg-gray-100 transition-colors" title="Home">
                                <i class="fas fa-home text-xl"></i>
                            </a>
                            <a href="/dashboard" class="px-3 py-2 bg-white text-blue-600 rounded-lg hover:bg-gray-100 transition-colors" title="Dashboard Operativa">
                                <i class="fas fa-chart-pie text-xl"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <div class="container mx-auto px-6 py-8">
                <!-- Sezione Manuali TeleMedCare -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">
                        <i class="fas fa-laptop-medical text-blue-600 mr-2"></i>
                        Documentazione TeleMedCare V12.0
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Manuale Utente -->
                        <div class="doc-card bg-white rounded-xl p-6 shadow-lg">
                            <div class="text-center mb-4">
                                <div class="text-4xl text-blue-600 mb-3">
                                    <i class="fas fa-user-guide"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">Manuale Utente</h3>
                                <p class="text-gray-600 text-sm">Guida completa all'uso del sistema TeleMedCare</p>
                            </div>
                            
                            <div class="space-y-2 text-sm text-gray-600 mb-4">
                                <div>üìñ <strong>Versione:</strong> 11.0.3</div>
                                <div>üìÖ <strong>Aggiornato:</strong> 10/10/2024</div>
                                <div>üìÑ <strong>Pagine:</strong> 127</div>
                                <div>üåç <strong>Lingua:</strong> Italiano</div>
                            </div>
                            
                            <div class="space-y-2">
                                <button onclick="viewDocument('user-manual')" class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    <i class="fas fa-eye mr-2"></i>Visualizza Online
                                </button>
                                <button onclick="downloadDocument('user-manual')" class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                    <i class="fas fa-download mr-2"></i>Scarica PDF
                                </button>
                            </div>
                        </div>
                        
                        <!-- Deployment Manual -->
                        <div class="doc-card bg-white rounded-xl p-6 shadow-lg">
                            <div class="text-center mb-4">
                                <div class="text-4xl text-purple-600 mb-3">
                                    <i class="fas fa-server"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">Deployment Manual</h3>
                                <p class="text-gray-600 text-sm">Guida tecnica installazione e configurazione</p>
                            </div>
                            
                            <div class="space-y-2 text-sm text-gray-600 mb-4">
                                <div>üîß <strong>Versione:</strong> 11.0.2</div>
                                <div>üìÖ <strong>Aggiornato:</strong> 08/10/2024</div>
                                <div>üìÑ <strong>Pagine:</strong> 89</div>
                                <div>üõ†Ô∏è <strong>Target:</strong> DevOps/IT</div>
                            </div>
                            
                            <div class="space-y-2">
                                <button onclick="viewDocument('deployment-manual')" class="w-full px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                                    <i class="fas fa-eye mr-2"></i>Visualizza Online
                                </button>
                                <button onclick="downloadDocument('deployment-manual')" class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                    <i class="fas fa-download mr-2"></i>Scarica PDF
                                </button>
                            </div>
                        </div>
                        
                        <!-- System Architecture -->
                        <div class="doc-card bg-white rounded-xl p-6 shadow-lg">
                            <div class="text-center mb-4">
                                <div class="text-4xl text-orange-600 mb-3">
                                    <i class="fas fa-sitemap"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">System Architecture</h3>
                                <p class="text-gray-600 text-sm">Architettura tecnica del sistema</p>
                            </div>
                            
                            <div class="space-y-2 text-sm text-gray-600 mb-4">
                                <div>üèóÔ∏è <strong>Versione:</strong> 11.0.1</div>
                                <div>üìÖ <strong>Aggiornato:</strong> 05/10/2024</div>
                                <div>üìÑ <strong>Pagine:</strong> 156</div>
                                <div>‚öôÔ∏è <strong>Target:</strong> Sviluppatori</div>
                            </div>
                            
                            <div class="space-y-2">
                                <button onclick="viewDocument('system-architecture')" class="w-full px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">
                                    <i class="fas fa-eye mr-2"></i>Visualizza Online
                                </button>
                                <button onclick="downloadDocument('system-architecture')" class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                    <i class="fas fa-download mr-2"></i>Scarica PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sezione Dispositivi Medici -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">
                        <i class="fas fa-stethoscope text-red-600 mr-2"></i>
                        Documentazione Dispositivi Medici
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- SiDLY Care Pro -->
                        <div class="doc-card bg-white rounded-xl p-6 shadow-lg">
                            <div class="text-center mb-4">
                                <div class="text-3xl text-red-600 mb-3">
                                    <i class="fas fa-heartbeat"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">SiDLY Care Pro</h3>
                                <p class="text-gray-600 text-sm">Dispositivo di monitoraggio cardiaco avanzato</p>
                            </div>
                            
                            <div class="space-y-2 text-xs text-gray-600 mb-4">
                                <div>üè∑Ô∏è <strong>Codice:</strong> SCP-2024</div>
                                <div>üîß <strong>Versione FW:</strong> 2.1.3</div>
                                <div>üè• <strong>Classe:</strong> IIa</div>
                            </div>
                            
                            <div class="space-y-1">
                                <button onclick="viewDeviceDoc('sidly-manual')" class="w-full px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">
                                    üìö Manuale d'uso
                                </button>
                                <button onclick="viewDeviceDoc('sidly-technical')" class="w-full px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                                    üîß Scheda tecnica
                                </button>
                                <button onclick="viewDeviceDoc('sidly-maintenance')" class="w-full px-3 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">
                                    üõ†Ô∏è Manutenzione
                                </button>
                            </div>
                        </div>
                        
                        <!-- CardioMed Pro -->
                        <div class="doc-card bg-white rounded-xl p-6 shadow-lg">
                            <div class="text-center mb-4">
                                <div class="text-3xl text-blue-600 mb-3">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">CardioMed Pro</h3>
                                <p class="text-gray-600 text-sm">Monitor pressorio digitale professionale</p>
                            </div>
                            
                            <div class="space-y-2 text-xs text-gray-600 mb-4">
                                <div>üè∑Ô∏è <strong>Codice:</strong> CMP-2024</div>
                                <div>üîß <strong>Versione FW:</strong> 1.8.2</div>
                                <div>üè• <strong>Classe:</strong> IIa</div>
                            </div>
                            
                            <div class="space-y-1">
                                <button onclick="viewDeviceDoc('cardio-manual')" class="w-full px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                                    üìö Manuale d'uso
                                </button>
                                <button onclick="viewDeviceDoc('cardio-technical')" class="w-full px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                                    üîß Scheda tecnica
                                </button>
                                <button onclick="viewDeviceDoc('cardio-calibration')" class="w-full px-3 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">
                                    ‚öñÔ∏è Calibrazione
                                </button>
                            </div>
                        </div>
                        
                        <!-- GlucoseMon -->
                        <div class="doc-card bg-white rounded-xl p-6 shadow-lg">
                            <div class="text-center mb-4">
                                <div class="text-3xl text-green-600 mb-3">
                                    <i class="fas fa-tint"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">GlucoseMon</h3>
                                <p class="text-gray-600 text-sm">Glucometro digitale connesso</p>
                            </div>
                            
                            <div class="space-y-2 text-xs text-gray-600 mb-4">
                                <div>üè∑Ô∏è <strong>Codice:</strong> GLM-2024</div>
                                <div>üîß <strong>Versione FW:</strong> 3.2.1</div>
                                <div>üè• <strong>Classe:</strong> IIb</div>
                            </div>
                            
                            <div class="space-y-1">
                                <button onclick="viewDeviceDoc('glucose-manual')" class="w-full px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">
                                    üìö Manuale d'uso
                                </button>
                                <button onclick="viewDeviceDoc('glucose-strips')" class="w-full px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                                    üß™ Strisce reattive
                                </button>
                                <button onclick="viewDeviceDoc('glucose-safety')" class="w-full px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">
                                    ‚ö†Ô∏è Sicurezza
                                </button>
                            </div>
                        </div>
                        
                        <!-- OxiSat Pro -->
                        <div class="doc-card bg-white rounded-xl p-6 shadow-lg">
                            <div class="text-center mb-4">
                                <div class="text-3xl text-purple-600 mb-3">
                                    <i class="fas fa-lungs"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">OxiSat Pro</h3>
                                <p class="text-gray-600 text-sm">Pulsossimetro professionale wireless</p>
                            </div>
                            
                            <div class="space-y-2 text-xs text-gray-600 mb-4">
                                <div>üè∑Ô∏è <strong>Codice:</strong> OSP-2024</div>
                                <div>üîß <strong>Versione FW:</strong> 1.5.4</div>
                                <div>üè• <strong>Classe:</strong> IIa</div>
                            </div>
                            
                            <div class="space-y-1">
                                <button onclick="viewDeviceDoc('oxi-manual')" class="w-full px-3 py-1 bg-purple-600 text-white rounded text-xs hover:bg-purple-700">
                                    üìö Manuale d'uso
                                </button>
                                <button onclick="viewDeviceDoc('oxi-accuracy')" class="w-full px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                                    üìè Precisione
                                </button>
                                <button onclick="viewDeviceDoc('oxi-wireless')" class="w-full px-3 py-1 bg-indigo-600 text-white rounded text-xs hover:bg-indigo-700">
                                    üì° Wireless Setup
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-tools text-gray-600 mr-2"></i>Azioni Rapide
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button onclick="searchDocuments()" class="flex items-center justify-center px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-search mr-2"></i>Cerca Documentazione
                        </button>
                        <button onclick="requestUpdate()" class="flex items-center justify-center px-4 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                            <i class="fas fa-edit mr-2"></i>Richiedi Aggiornamento
                        </button>
                        <button onclick="downloadAll()" class="flex items-center justify-center px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <i class="fas fa-download mr-2"></i>Scarica Tutto
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // System Status Modal (reused from other pages)
            function showSystemStatus() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                modal.onclick = () => modal.remove();
                
                modal.innerHTML = \`
                    <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-96 overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-800">
                                <i class="fas fa-server text-green-600 mr-2"></i>Centro Documentazione Online
                            </h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span>üìö Manuali TeleMedCare</span><span class="text-green-600">‚úì 3 Disponibili</span></div>
                            <div class="flex justify-between"><span>üè• Doc. Dispositivi</span><span class="text-green-600">‚úì 4 Dispositivi</span></div>
                            <div class="flex justify-between"><span>üîÑ Auto-Update</span><span class="text-green-600">‚úì Attivo</span></div>
                            <div class="flex justify-between"><span>üíæ Storage</span><span class="text-blue-600">2.1GB / 10GB</span></div>
                        </div>
                    </div>
                \`;
                
                document.body.appendChild(modal);
            }
            
            // Document Actions
            function viewDocument(docId) {
                const urls = {
                    'user-manual': '/docs/telemedcare-user-manual-v12.pdf',
                    'deployment-manual': '/docs/telemedcare-deployment-v12.pdf',
                    'system-architecture': '/docs/telemedcare-architecture-v12.pdf'
                };
                
                if (urls[docId]) {
                    window.open(urls[docId], '_blank');
                } else {
                    alert('üìñ Visualizzazione documento: ' + docId);
                }
            }
            
            function downloadDocument(docId) {
                alert('‚¨áÔ∏è Download avviato per: ' + docId);
            }
            
            function viewDeviceDoc(docId) {
                alert('üì± Apertura documentazione dispositivo: ' + docId);
            }
            
            function searchDocuments() {
                const query = prompt('üîç Inserisci termine di ricerca:');
                if (query) {
                    alert('Ricerca in corso per: ' + query);
                }
            }
            
            function requestUpdate() {
                alert('üìù Richiesta di aggiornamento documentazione inviata al team tecnico');
            }
            
            function downloadAll() {
                if (confirm('üì¶ Scaricare tutta la documentazione? (~ 45MB)')) {
                    alert('‚¨áÔ∏è Download pacchetto completo avviato');
                }
            }
        <\/script>
    </body>
    </html>
  `));I.get("/api/status",o=>o.json({system:"TeleMedCare V12.0 Modular Enterprise",status:"active",timestamp:new Date().toISOString(),version:"V12.0-Modular-Enterprise",enterprise:!0,modules:["lead-config","lead-core","lead-channels","lead-conversion","lead-scoring","lead-reports","dispositivi","pdf","utils","logging"],compatibility:"V12.0-Cloudflare"}));I.get("/api/system/status",async o=>{try{const{env:t}=o;let e="OFFLINE",a=null;try{await t.DB.prepare("SELECT 1").first(),e="ONLINE"}catch(s){a=s instanceof Error?s.message:"Database connection failed"}let i=null;try{i=await t.DB.prepare(`
        SELECT 
          (SELECT COUNT(*) FROM leads) as total_leads,
          (SELECT COUNT(*) FROM assistiti) as total_assistiti,
          (SELECT COUNT(*) FROM dispositivi) as total_devices,
          (SELECT COUNT(*) FROM contracts) as total_contracts
      `).first()}catch(s){console.error("Errore stats:",s)}return o.json({system:"TeleMedCare V12.0",status:"ONLINE",timestamp:new Date().toISOString(),health:{database:{status:e,error:a,lastCheck:new Date().toISOString()},api:{status:"ONLINE",endpoints:47},services:{email:"READY",leads:"ACTIVE",devices:"ACTIVE",contracts:"ACTIVE"}},statistics:i||{total_leads:0,total_assistiti:0,total_devices:0,total_contracts:0},performance:{uptime:process.uptime?Math.floor(process.uptime()):"N/A",memory:"N/A",responseTime:"Fast"}})}catch(t){return o.json({system:"TeleMedCare V12.0",status:"ERROR",timestamp:new Date().toISOString(),error:t instanceof Error?t.message:"Sistema non disponibile"},500)}});I.get("/api/analytics/overview",async o=>{try{const t=o.env.DB;let e=0,a=0,i=0,s=0;if(t){const r=await t.prepare("SELECT COUNT(*) as count FROM leads").first();e=(r==null?void 0:r.count)||0,a=Math.floor(e*.7),i=a*299,s=Math.floor(e*.05)}else e=25,a=18,i=5382,s=3;return o.json({success:!0,data:{totalLeads:e,activeContracts:a,monthlyRevenue:`‚Ç¨${i.toLocaleString()}`,emergencies:s,lastUpdated:new Date().toISOString()}})}catch{return o.json({success:!1,error:"Errore recupero analytics"},500)}});I.get("/api/data/proforma",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database D1 non configurato"},500);const e=await o.env.DB.prepare(`
      SELECT 
        p.id,
        p.numero_proforma,
        p.prezzo_totale,
        p.status,
        p.data_emissione,
        p.data_invio,
        p.contract_id,
        l.nomeRichiedente,
        l.cognomeRichiedente,
        l.email,
        c.tipo_contratto
      FROM proforma p
      LEFT JOIN contracts c ON p.contract_id = c.id
      LEFT JOIN leads l ON c.leadId = l.id
      ORDER BY p.created_at DESC
    `).all();return o.json({success:!0,proforma:e.results.map(a=>({...a,cliente_nome:`${a.nomeRichiedente} ${a.cognomeRichiedente}`,status_italiano:a.status==="PAID"?"Pagata":a.status==="SENT"?"Inviata":a.status==="DRAFT"?"Bozza":"In attesa"})),totalCount:e.results.length,totalValue:e.results.reduce((a,i)=>a+Number(i.prezzo_totale||0),0)})}catch(e){return o.json({success:!1,error:"Errore recupero proforma",details:e.message},500)}});I.get("/api/data/pagamenti",async o=>{try{const t=o.env.DB,e=o.req.query("status");if(t){const s=(await t.prepare(`
        SELECT c.id, c.contractType, c.status, c.created_at, c.leadId
        FROM contracts c
        WHERE c.status IN ('PAID', 'SIGNED')
        ORDER BY c.created_at DESC
      `).all()).results.map((r,l)=>({id:`PAY_${r.id}`,transactionId:`TXN_${Date.now()}_${l}`,nome_cliente:`Cliente_${r.leadId}`,importo:r.contractType==="AVANZATO"?890:490,metodo:l%4===0?"Stripe":l%4===1?"PayPal":l%4===2?"Bonifico":"Carta",status:r.status==="PAID"?"completed":"pending",data:r.created_at,contratto_id:r.id})).filter(r=>!e||e==="all"||r.status===e);return o.json({success:!0,pagamenti:s,totalCount:s.length,totalValue:s.reduce((r,l)=>r+l.importo,0)})}else{const a=[{id:"PAY_001",transactionId:"TXN_2024_001",nome_cliente:"Mario Rossi",importo:890,metodo:"Stripe",status:"completed",data:"2024-10-01T10:00:00Z"},{id:"PAY_002",transactionId:"TXN_2024_002",nome_cliente:"Anna Verdi",importo:490,metodo:"PayPal",status:"pending",data:"2024-10-05T14:30:00Z"},{id:"PAY_003",transactionId:"TXN_2024_003",nome_cliente:"Luigi Bianchi",importo:890,metodo:"Bonifico",status:"completed",data:"2024-10-07T09:15:00Z"}].filter(i=>!e||e==="all"||i.status===e);return o.json({success:!0,pagamenti:a,totalCount:a.length,totalValue:a.reduce((i,s)=>i+s.importo,0)})}}catch(t){return o.json({success:!1,error:"Errore recupero pagamenti",details:t.message},500)}});I.get("/api/data/dashboard",async o=>{try{const t=o.env.DB;let e={};if(t){const[a,i,s]=await Promise.all([t.prepare("SELECT COUNT(*) as count FROM leads").first(),t.prepare('SELECT COUNT(*) as count FROM contracts WHERE status = "SIGNED"').first(),t.prepare('SELECT COUNT(*) as count FROM dispositivi WHERE status = "attivo"').first()]),r=(a==null?void 0:a.count)||0,l=(i==null?void 0:i.count)||0,c=(s==null?void 0:s.count)||0;e={leads:{totali:r,nuovi_oggi:Math.floor(r*.1)||1,in_lavorazione:Math.floor(r*.3),convertiti:l},contratti:{attivi:l,in_scadenza:Math.floor(l*.15),fatturato_mensile:l*490,crescita:"+12%"},dispositivi:{totali:c,configurati:c,assegnati:Math.floor(c*.8),disponibili:Math.floor(c*.2)}}}else e={leads:{totali:25,nuovi_oggi:3,in_lavorazione:8,convertiti:12},contratti:{attivi:12,in_scadenza:2,fatturato_mensile:5880,crescita:"+12%"},dispositivi:{totali:15,configurati:15,assegnati:12,disponibili:3}};return o.json({success:!0,data:e,timestamp:new Date().toISOString(),version:"V12.0-Consistent"})}catch(t){return o.json({success:!1,error:"Errore recupero dashboard",details:t.message},500)}});I.get("/api/analytics/charts",async o=>{try{const t=o.env.DB,e=7,a=[];for(let i=e-1;i>=0;i--){const s=new Date;s.setDate(s.getDate()-i);const r=s.toISOString().split("T")[0];let l=s.getDate()*3%8+2;if(t)try{const c=await t.prepare(`
            SELECT COUNT(*) as count 
            FROM leads 
            WHERE DATE(created_at) = ?
          `).bind(r).first();l=(c==null?void 0:c.count)||l}catch{}a.push({date:r,leads:l,contracts:Math.floor(l*.7),revenue:l*299})}return o.json({success:!0,data:{daily:a,period:`${e} giorni`,generated:new Date().toISOString()}})}catch{return o.json({success:!1,error:"Errore recupero dati grafici"},500)}});I.post("/api/devices/read-imei",async o=>{try{const{deviceId:t}=await o.req.json();console.log(`üì± [API] Richiesta lettura IMEI dispositivo: ${t}`);const i=await(await Promise.resolve().then(()=>h0)).default.getInstance().readDeviceIMEI(t);return o.json({success:i.success,imei:i.imei,deviceInfo:i.deviceInfo,error:i.error})}catch(t){return console.error("‚ùå [API] Errore lettura IMEI:",t),o.json({success:!1,error:t instanceof Error?t.message:"Errore lettura IMEI"},500)}});I.post("/api/devices/calculate-expiry",async o=>{try{const{manufacturingDate:t,deviceType:e}=await o.req.json();console.log(`üìÖ [API] Calcolo scadenza dispositivo: ${e}, data: ${t}`);const s=(await Promise.resolve().then(()=>h0)).default.getInstance().calculateDeviceExpiry(t,e);return o.json({success:!0,expiry:s})}catch(t){return console.error("‚ùå [API] Errore calcolo scadenza:",t),o.json({success:!1,error:t instanceof Error?t.message:"Errore calcolo scadenza"},500)}});I.get("/api/devices/registry",async o=>{try{const t=o.env.DB;let e=[];if(t)try{e=(await t.prepare(`
          SELECT * FROM device_registry 
          ORDER BY created_at DESC LIMIT 50
        `).all()).results||[]}catch{console.log("Tabella device_registry non trovata, uso dati mock")}return e.length===0&&(e=[{id:"DEV001",nome:"SiDLY Care Pro V12.0 #001",tipo:"dispositivo_principale",seriale:"SCP110001",stato:"attivo",paziente:"Mario Rossi",ubicazione:"Roma, Via Roma 123",batteria:87,segnale:4,ultimo_aggiornamento:new Date().toISOString(),created_at:new Date().toISOString()},{id:"DEV002",nome:"SiDLY Care Pro V12.0 #002",tipo:"dispositivo_principale",seriale:"SCP110002",stato:"manutenzione",paziente:"Anna Bianchi",ubicazione:"Milano, Via Duomo 45",batteria:23,segnale:3,ultimo_aggiornamento:new Date().toISOString(),created_at:new Date().toISOString()},{id:"DEV003",nome:"SiDLY Care Pro V12.0 #003",tipo:"dispositivo_principale",seriale:"SCP110003",stato:"attivo",paziente:"Giuseppe Verde",ubicazione:"Napoli, Corso Umberto 78",batteria:92,segnale:5,ultimo_aggiornamento:new Date().toISOString(),created_at:new Date().toISOString()}]),o.json({success:!0,data:e,count:e.length,timestamp:new Date().toISOString()})}catch{return o.json({success:!1,error:"Errore recupero dispositivi"},500)}});function ww(){const o=new Date().toISOString().replace(/[:.]/g,""),t=Math.random().toString(36).substring(2,8).toUpperCase();return`LEAD_${o}_${t}`}I.get("/",o=>(o.header("Cache-Control","no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0"),o.header("Pragma","no-cache"),o.header("Expires","0"),o.header("X-Cache-Bypass","true"),o.header("X-TeleMedCare-Version","11.0-"+Date.now()),o.html(a0)));I.get("/landing",o=>o.html(`
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleMedCare V12.0 - Telemedicina Avanzata</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-600">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-600 text-white p-2 rounded-lg">
                        <i class="fas fa-heartbeat text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">TeleMedCare V12.0</h1>
                        <p class="text-sm text-gray-600">Telemedicina Professionale</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-600">Medica GB S.r.l.</p>
                    <p class="text-xs text-blue-600">Certificata ISO 27001</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="py-16 text-center">
        <div class="max-w-4xl mx-auto px-4">
            <h2 class="text-5xl font-bold text-gray-800 mb-6">
                üè• Rivoluziona la Tua <span class="text-blue-600">Salute</span>
            </h2>
            <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">
                Monitoring avanzato H24, dispositivi SiDLY Care Pro, consulenze specialistiche immediate. 
                Il futuro della telemedicina √® qui.
            </p>
            
            <!-- Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <i class="fas fa-users text-3xl text-blue-600 mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-800">15.000+</h3>
                    <p class="text-gray-600">Pazienti Attivi</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <i class="fas fa-stethoscope text-3xl text-green-600 mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-800">250+</h3>
                    <p class="text-gray-600">Medici Specialisti</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <i class="fas fa-chart-line text-3xl text-purple-600 mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-800">99.8%</h3>
                    <p class="text-gray-600">Uptime Garantito</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Form Section -->
    <section class="py-16 bg-white">
        <div class="max-w-6xl mx-auto px-4">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
                
                <!-- Form Column -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-8 rounded-2xl shadow-xl">
                    <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">
                        üöÄ Inizia Subito
                    </h3>
                    
                    <form id="leadForm" class="space-y-6">
                        <!-- Nome -->
                        <div>
                            <label for="nome" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-user mr-2"></i>Nome Completo *
                            </label>
                            <input type="text" id="nome" name="nome" required
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                                placeholder="Mario Rossi">
                        </div>

                        <!-- Email -->
                        <div>
                            <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-envelope mr-2"></i>Email *
                            </label>
                            <input type="email" id="email" name="email" required
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                                placeholder="mario@email.com">
                        </div>

                        <!-- Telefono -->
                        <div>
                            <label for="telefono" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-phone mr-2"></i>Telefono *
                            </label>
                            <input type="tel" id="telefono" name="telefono" required
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                                placeholder="+39 123 456 7890">
                        </div>

                        <!-- Et√† -->
                        <div>
                            <label for="eta" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-calendar mr-2"></i>Et√†
                            </label>
                            <input type="number" id="eta" name="eta" min="18" max="100"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                                placeholder="65">
                        </div>

                        <!-- Tipologia Servizio -->
                        <div>
                            <label for="servizio" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-medical-kit mr-2"></i>Servizio Richiesto *
                            </label>
                            <select id="servizio" name="servizio" required
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors">
                                <option value="">Seleziona servizio...</option>
                                <option value="BASIC">üìä Basic - Monitoring Essenziale (‚Ç¨490/anno)</option>
                                <option value="AVANZATO">üè• Avanzato - Telemedicina Completa (‚Ç¨890/anno)</option>
                            </select>
                        </div>

                        <!-- Azienda (opzionale) -->
                        <div>
                            <label for="azienda" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-building mr-2"></i>Azienda (opzionale)
                            </label>
                            <input type="text" id="azienda" name="azienda"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                                placeholder="Medica GB S.r.l.">
                        </div>

                        <!-- Privacy -->
                        <div class="flex items-start space-x-3">
                            <input type="checkbox" id="privacy" name="privacy" required
                                class="mt-1 h-4 w-4 text-blue-600 border-2 border-gray-300 rounded focus:ring-blue-500">
                            <label for="privacy" class="text-sm text-gray-600 leading-tight">
                                Accetto il trattamento dei dati personali secondo la 
                                <a href="#" class="text-blue-600 underline">Privacy Policy</a> 
                                e autorizzo l'invio di comunicazioni commerciali *
                            </label>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" 
                            class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-4 px-6 rounded-lg hover:from-blue-700 hover:to-indigo-700 transform hover:scale-105 transition-all duration-300 shadow-lg">
                            <i class="fas fa-rocket mr-2"></i>
                            ATTIVA TELEMEDCARE SUBITO
                        </button>
                    </form>

                    <!-- Loading e Success Messages -->
                    <div id="loadingMessage" class="hidden text-center mt-6">
                        <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
                        <p class="text-blue-600 font-semibold mt-2">Elaborazione in corso...</p>
                    </div>

                    <div id="successMessage" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mt-6">
                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                        <span class="text-green-800 font-semibold">Richiesta inviata! Controlla la tua email per il contratto.</span>
                    </div>

                    <div id="errorMessage" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mt-6">
                        <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                        <span class="text-red-800 font-semibold">Errore nell'invio. Riprova o contatta il supporto.</span>
                    </div>
                </div>

                <!-- Benefits Column -->
                <div class="space-y-8">
                    <h3 class="text-3xl font-bold text-gray-800 mb-8">
                        ‚ú® Perch√© Scegliere TeleMedCare?
                    </h3>
                    
                    <div class="space-y-6">
                        <div class="flex items-start space-x-4">
                            <div class="bg-blue-100 text-blue-600 p-3 rounded-lg">
                                <i class="fas fa-shield-alt text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">Sicurezza Garantita</h4>
                                <p class="text-gray-600">Crittografia end-to-end e conformit√† GDPR</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-4">
                            <div class="bg-green-100 text-green-600 p-3 rounded-lg">
                                <i class="fas fa-clock text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">Supporto H24</h4>
                                <p class="text-gray-600">Assistenza medica disponibile 24 ore su 24</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-4">
                            <div class="bg-purple-100 text-purple-600 p-3 rounded-lg">
                                <i class="fas fa-mobile-alt text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">Dispositivi Smart</h4>
                                <p class="text-gray-600">Tecnologia SiDLY Care Pro inclusa</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-4">
                            <div class="bg-orange-100 text-orange-600 p-3 rounded-lg">
                                <i class="fas fa-chart-line text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">Analytics Avanzate</h4>
                                <p class="text-gray-600">Reportistica dettagliata e insights predittivi</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <p>&copy; 2024 TeleMedCare V12.0 - Medica GB S.r.l. - P.IVA 12345678901</p>
            <p class="text-gray-400 mt-2">Certificazioni: ISO 27001 | ISO 13485 | GDPR Compliant</p>
        </div>
    </footer>

    <!-- JavaScript per il form -->
    <script>
        document.getElementById('leadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Nascondi messaggi precedenti
            document.getElementById('successMessage').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('loadingMessage').classList.remove('hidden');
            
            try {
                // Raccogli i dati del form
                const formData = new FormData(this);
                const data = {
                    nome: formData.get('nome'),
                    email: formData.get('email'),
                    telefono: formData.get('telefono'),
                    eta: formData.get('eta') || null,
                    servizio: formData.get('servizio'),
                    azienda: formData.get('azienda') || null,
                    privacy: formData.get('privacy') ? true : false,
                    source: 'LANDING_PAGE'
                };
                
                console.log('üöÄ Invio lead:', data);
                
                // Invia la richiesta all'API
                const response = await fetch('/api/lead', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                console.log('üìß Risposta API:', result);
                
                document.getElementById('loadingMessage').classList.add('hidden');
                
                if (result.success) {
                    document.getElementById('successMessage').classList.remove('hidden');
                    this.reset(); // Reset del form
                    
                    // Scroll al messaggio di successo
                    document.getElementById('successMessage').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                } else {
                    document.getElementById('errorMessage').classList.remove('hidden');
                    console.error('‚ùå Errore API:', result.error);
                }
                
            } catch (error) {
                console.error('‚ùå Errore invio:', error);
                document.getElementById('loadingMessage').classList.add('hidden');
                document.getElementById('errorMessage').classList.remove('hidden');
            }
        });
    <\/script>
</body>
</html>
  `));I.get("/dashboard",o=>(o.header("Cache-Control","no-store, no-cache, must-revalidate, proxy-revalidate"),o.header("Pragma","no-cache"),o.header("Expires","0"),o.header("X-TeleMedCare-Dashboard","operativa"),o.header("X-TeleMedCare-Version","V12.0-Dynamic-Template"),o.html(cw)));I.get("/admin/leads-dashboard",o=>(o.header("Cache-Control","no-store, no-cache, must-revalidate"),o.header("X-TeleMedCare-Dashboard","leads"),o.html(dw)));I.get("/admin/data-dashboard",o=>(o.header("Cache-Control","no-store, no-cache, must-revalidate"),o.header("X-TeleMedCare-Dashboard","data"),o.html(uw)));I.get("/admin/workflow-manager",o=>(o.header("Cache-Control","no-store, no-cache, must-revalidate"),o.header("X-TeleMedCare-Dashboard","workflow"),o.html(pw)));I.get("/admin/test-contratti",o=>(o.header("Cache-Control","no-store, no-cache, must-revalidate"),o.html(`<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Caricamento Contratti - TeleMedCare</title>
  <script src="https://cdn.tailwindcss.com"><\/script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-8">
  
  <div class="max-w-6xl mx-auto">
    
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">
        üß™ Test Caricamento Contratti
      </h1>
      <p class="text-gray-600">
        Verifica e carica i 9 contratti reali nel database
      </p>
    </div>

    <!-- Buttons -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="mb-4">
        <button 
          id="btnDebug" 
          onclick="debugLeads()"
          class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-md hover:shadow-lg">
          üîç DEBUG: Mostra Email Leads nel Database
        </button>
      </div>
      
      <div class="grid grid-cols-1 gap-4">
        <button 
          id="btnAll" 
          onclick="runFullCycle()"
          class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-4 px-8 rounded-lg transition-all shadow-lg hover:shadow-xl text-lg">
          üöÄ CARICA CONTRATTI (DELETE + POST)
        </button>
      </div>
      
      <div class="grid grid-cols-2 gap-4 mt-4">
        <button 
          id="btnDelete" 
          onclick="deleteContracts()"
          class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg transition-all shadow-md hover:shadow-lg">
          üóëÔ∏è DELETE Contratti
        </button>
        
        <button 
          id="btnCreate" 
          onclick="createContracts()"
          class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-all shadow-md hover:shadow-lg">
          ‚úÖ POST Contratti
        </button>
      </div>
    </div>
        
        <button 
          id="btnCreate" 
          onclick="createContracts()"
          class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-all shadow-md hover:shadow-lg">
          ‚úÖ POST Contratti
        </button>
      </div>
    </div>

    <!-- Log Output -->
    <div class="bg-white rounded-lg shadow-lg p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">üìã Log Output</h2>
      <div id="output" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm overflow-auto" style="max-height: 600px;">
        <div class="text-gray-500">In attesa di comandi...</div>
      </div>
    </div>

  </div>

  <script>
    const output = document.getElementById('output');
    
    function log(message, color = 'text-green-400') {
      const div = document.createElement('div');
      div.className = color;
      div.textContent = message;
      output.appendChild(div);
      output.scrollTop = output.scrollHeight;
    }
    
    function clearLog() {
      output.innerHTML = '';
    }
    
    async function deleteContracts() {
      clearLog();
      log('üóëÔ∏è DELETE /api/setup-real-contracts...', 'text-yellow-400');
      
      try {
        const response = await fetch('/api/setup-real-contracts', { 
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });
        
        log(\`üì° Response: \${response.status} \${response.statusText}\`, 'text-blue-400');
        
        if (!response.ok) {
          throw new Error(\`HTTP \${response.status}: \${response.statusText}\`);
        }
        
        const result = await response.json();
        log('‚úÖ DELETE completato!', 'text-green-400');
        log(\`   Contratti rimossi: \${result.removed || 0}\`, 'text-green-400');
        log(JSON.stringify(result, null, 2), 'text-gray-400');
        
      } catch (error) {
        log('‚ùå ERRORE:', 'text-red-400');
        log(error.message, 'text-red-400');
        console.error(error);
      }
    }
    
    async function debugLeads() {
      clearLog();
      log('üîç DEBUG: Caricamento email leads dal database...', 'text-yellow-400');
      log('', '');
      
      try {
        const response = await fetch('/api/debug/leads-emails');
        
        if (!response.ok) {
          throw new Error(\`HTTP \${response.status}: \${response.statusText}\`);
        }
        
        const result = await response.json();
        
        log(\`‚úÖ Trovati \${result.total} leads nel database\`, 'text-green-400');
        log('', '');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
        log('üìß EMAIL LEADS NEL DATABASE:', 'text-cyan-400');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
        
        if (result.leads && result.leads.length > 0) {
          result.leads.forEach((lead, i) => {
            log(\`\${i + 1}. \${lead.email}\`, 'text-white');
            log(\`   Nome: \${lead.nome_completo}\`, 'text-gray-400');
            log(\`   ID: \${lead.id}\`, 'text-gray-400');
            log('', '');
          });
          
          log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
          log('üîç EMAIL RICHIESTE DAI CONTRATTI:', 'text-cyan-400');
          log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
          
          const emailRichieste = [
            'elenasaglia@hotmail.com',
            'paolo@paolomagri.com',
            'simona.pizzutto@coopbarbarab.it',
            'caterinadalterio108@gmail.com',
            'elisabettacattini@gmail.com',
            'gr@ecotorino.it'
          ];
          
          emailRichieste.forEach((email, i) => {
            const found = result.leads.find(l => l.email.toLowerCase() === email.toLowerCase());
            if (found) {
              log(\`\${i + 1}. ‚úÖ \${email} ‚Üí TROVATO (\${found.nome_completo})\`, 'text-green-400');
            } else {
              log(\`\${i + 1}. ‚ùå \${email} ‚Üí NON TROVATO\`, 'text-red-400');
            }
          });
          
        } else {
          log('‚ö†Ô∏è Nessun lead trovato nel database!', 'text-red-400');
        }
        
      } catch (error) {
        log('‚ùå ERRORE:', 'text-red-400');
        log(error.message, 'text-red-400');
        console.error(error);
      }
    }
    
    async function createContracts() {
      clearLog();
      log('‚úÖ POST /api/setup-real-contracts...', 'text-yellow-400');
      
      try {
        const response = await fetch('/api/setup-real-contracts', { 
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        log(\`üì° Response: \${response.status} \${response.statusText}\`, 'text-blue-400');
        
        if (!response.ok) {
          throw new Error(\`HTTP \${response.status}: \${response.statusText}\`);
        }
        
        const result = await response.json();
        log('‚úÖ CREAZIONE COMPLETATA!', 'text-green-400');
        log('', '');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
        log('üìä RIEPILOGO STATISTICHE', 'text-cyan-400');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
        log(\`‚úì Contratti creati:      \${result.creati}\`, 'text-green-400');
        log(\`‚úó Errori:                \${result.errori}\`, 'text-red-400');
        log(\`üìù Contratti FIRMATI:    \${result.firmati}\`, 'text-green-400');
        log(\`üìù Contratti INVIATI:    \${result.creati - result.firmati}\`, 'text-yellow-400');
        log(\`üí∞ REVENUE ANNUALE:      ‚Ç¨\${result.revenue}\`, 'text-green-400');
        log(\`üìà Conversion Rate:      \${result.conversionRate}\`, 'text-blue-400');
        log(\`üíµ AOV (valore medio):   ‚Ç¨\${result.aov}\`, 'text-blue-400');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
        log('', '');
        
        if (result.contratti) {
          log('üìã CONTRATTI CREATI:', 'text-cyan-400');
          log('', '');
          result.contratti.forEach((c, i) => {
            const status = c.status === 'SIGNED' ? '‚úÖ Firmato' : 'üì§ Inviato';
            log(\`\${i + 1}. \${c.codice}\`, 'text-white');
            log(\`   Intestatario: \${c.intestatario}\`, 'text-gray-400');
            log(\`   Piano: \${c.piano} | Prezzo: ‚Ç¨\${c.prezzo}\`, 'text-gray-400');
            log(\`   Status: \${status}\`, c.status === 'SIGNED' ? 'text-green-400' : 'text-yellow-400');
            log(\`   Data firma: \${c.data_firma || '-'}\`, 'text-gray-400');
            log('', '');
          });
        }
        
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
        log('üîç VERIFICHE INTESTATARI:', 'text-cyan-400');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
        
        const verifiche = [
          { codice: 'CTR-KING-2025', intestatario: 'Eileen King', prezzo: 840 },
          { codice: 'CTR-BALZAROTTI-2025', intestatario: 'Giuliana Balzarotti', prezzo: 480 },
          { codice: 'CTR-PIZZUTTO-G-2025', intestatario: 'Gianni Paolo Pizzutto', prezzo: 480 },
          { codice: 'CTR-PENNACCHIO-2025', intestatario: 'Rita Pennacchio', prezzo: 480 },
          { codice: 'CTR-COZZI-2025', intestatario: 'Giuseppina Cozzi', prezzo: 480 },
          { codice: 'CTR-CAPONE-2025', intestatario: 'Maria Capone', prezzo: 480 }
        ];
        
        verifiche.forEach(v => {
          const found = result.contratti.find(c => c.codice === v.codice);
          if (found) {
            const ok = found.intestatario === v.intestatario && found.prezzo === v.prezzo;
            log(\`\${ok ? '‚úÖ' : '‚ùå'} \${v.codice}: \${found.intestatario} (‚Ç¨\${found.prezzo})\`, ok ? 'text-green-400' : 'text-red-400');
          } else {
            log(\`‚ùå \${v.codice}: NON TROVATO\`, 'text-red-400');
          }
        });
        
        log('', '');
        log('‚úÖ COMPLETATO! Controlla la Dashboard per vedere i risultati.', 'text-green-400');
        
      } catch (error) {
        log('‚ùå ERRORE:', 'text-red-400');
        log(error.message, 'text-red-400');
        console.error(error);
      }
    }
    
    async function runFullCycle() {
      clearLog();
      log('üöÄ CICLO COMPLETO: DELETE + POST', 'text-cyan-400');
      log('', '');
      
      // DELETE
      log('1Ô∏è‚É£ DELETE contratti esistenti...', 'text-yellow-400');
      
      try {
        const deleteResponse = await fetch('/api/setup-real-contracts', { 
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!deleteResponse.ok) {
          throw new Error(\`DELETE failed: \${deleteResponse.status} \${deleteResponse.statusText}\`);
        }
        
        const deleteResult = await deleteResponse.json();
        log(\`‚úÖ DELETE completato - Rimossi: \${deleteResult.removed || 0}\`, 'text-green-400');
        log('', '');
        log('‚è≥ Attesa 2 secondi...', 'text-gray-400');
        log('', '');
        
        // POST dopo 2 secondi
        setTimeout(async () => {
          log('2Ô∏è‚É£ POST nuovi contratti...', 'text-yellow-400');
          
          try {
            const createResponse = await fetch('/api/setup-real-contracts', { 
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            
            if (!createResponse.ok) {
              throw new Error(\`POST failed: \${createResponse.status} \${createResponse.statusText}\`);
            }
            
            const result = await createResponse.json();
            log('‚úÖ POST completato!', 'text-green-400');
            log('', '');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
            log('üìä RIEPILOGO FINALE', 'text-cyan-400');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
            log(\`‚úì Contratti creati:      \${result.creati}\`, 'text-green-400');
            log(\`‚úó Errori:                \${result.errori}\`, 'text-red-400');
            log(\`üìù Contratti FIRMATI:    \${result.firmati}\`, 'text-green-400');
            log(\`üí∞ REVENUE ANNUALE:      ‚Ç¨\${result.revenue}\`, 'text-green-400');
            log(\`üìà Conversion Rate:      \${result.conversionRate}\`, 'text-blue-400');
            log(\`üíµ AOV:                  ‚Ç¨\${result.aov}\`, 'text-blue-400');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'text-cyan-400');
            
            if (result.contratti) {
              log('', '');
              log('üìã CONTRATTI:', 'text-cyan-400');
              result.contratti.forEach((c, i) => {
                log(\`\${i + 1}. \${c.codice} - \${c.intestatario} - \${c.status === 'SIGNED' ? '‚úÖ' : 'üì§'} ‚Ç¨\${c.prezzo}\`, 
                    c.status === 'SIGNED' ? 'text-green-400' : 'text-yellow-400');
              });
            }
            
            log('', '');
            log('‚úÖ COMPLETATO! La pagina si ricaricher√† tra 3 secondi...', 'text-green-400');
            
            setTimeout(() => {
              location.reload();
            }, 3000);
            
          } catch (postError) {
            log('‚ùå ERRORE POST:', 'text-red-400');
            log(postError.message, 'text-red-400');
          }
          
        }, 2000);
        
      } catch (deleteError) {
        log('‚ùå ERRORE DELETE:', 'text-red-400');
        log(deleteError.message, 'text-red-400');
      }
    }
    
  <\/script>

</body>
</html>`)));I.get("/api/debug/leads-schema",async o=>{var t,e;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const i=(e=(await o.env.DB.prepare("PRAGMA table_info(leads)").all()).results)==null?void 0:e.map(s=>({name:s.name,type:s.type,required:s.notnull===1}));return o.json({success:!0,table:"leads",columns:i,count:(i==null?void 0:i.length)||0})}catch(a){return console.error("‚ùå Errore schema leads:",a),o.json({success:!1,error:"Errore recupero schema",details:a instanceof Error?a.message:String(a)},500)}});I.get("/api/debug/leads-emails",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const a=(await o.env.DB.prepare(`
      SELECT id, email, nomeRichiedente, cognomeRichiedente, created_at
      FROM leads
      ORDER BY created_at DESC
      LIMIT 200
    `).all()).results||[];return o.json({success:!0,total:a.length,leads:a.map(i=>({id:i.id,email:i.email,nome_completo:`${i.nomeRichiedente} ${i.cognomeRichiedente}`,created_at:i.created_at}))})}catch(e){return console.error("‚ùå Errore debug leads:",e),o.json({success:!1,error:e.message},500)}});I.post("/api/admin/cleanup-test-data",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const e=o.env.ENVIRONMENT||"production";console.log(`üßπ [CLEANUP] Ambiente: ${e}`);const a=await o.env.DB.prepare("SELECT COUNT(*) as count FROM leads WHERE id LIKE 'LEAD-MANUAL-176%'").first(),i=(a==null?void 0:a.count)||0;if(console.log(`üßπ [CLEANUP] Lead da eliminare: ${i}`),i===0)return o.json({success:!0,message:"Nessun lead da eliminare",deleted:{logs:0,tokens:0,contracts:0,leads:0}});const s={logs:0,tokens:0,contracts:0,leads:0},r=await o.env.DB.prepare("DELETE FROM lead_completion_log WHERE lead_id LIKE 'LEAD-MANUAL-176%'").run();s.logs=r.meta.changes||0,console.log(`üßπ [CLEANUP] Log eliminati: ${s.logs}`);const l=await o.env.DB.prepare("DELETE FROM lead_completion_tokens WHERE lead_id LIKE 'LEAD-MANUAL-176%'").run();s.tokens=l.meta.changes||0,console.log(`üßπ [CLEANUP] Token eliminati: ${s.tokens}`);const c=await o.env.DB.prepare("DELETE FROM contracts WHERE id LIKE 'CONTRACT-176%'").run();s.contracts=c.meta.changes||0,console.log(`üßπ [CLEANUP] Contratti eliminati: ${s.contracts}`);const d=await o.env.DB.prepare("DELETE FROM leads WHERE id LIKE 'LEAD-MANUAL-176%'").run();s.leads=d.meta.changes||0,console.log(`üßπ [CLEANUP] Lead eliminati: ${s.leads}`);const u=await o.env.DB.prepare("SELECT COUNT(*) as count FROM leads WHERE id LIKE 'LEAD-MANUAL-176%'").first(),p=(u==null?void 0:u.count)||0;return console.log(`‚úÖ [CLEANUP] Lead rimanenti: ${p}`),o.json({success:!0,message:"Cleanup completato con successo",environment:e,deleted:s,verification:{remaining_test_leads:p}})}catch(e){return console.error("‚ùå Errore cleanup:",e),o.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.post("/api/import/irbema/force",async o=>{var t,e;try{if(console.log("üîÑ [HUBSPOT FORCE] Inizio import FORZATO da HubSpot..."),!((t=o.env)!=null&&t.DB)||!((e=o.env)!=null&&e.HUBSPOT_ACCESS_TOKEN))return o.json({success:!1,error:"Configurazione mancante"},500);const a=o.env.HUBSPOT_ACCESS_TOKEN,i=["amministrazione@europa92.it","morroni.mariacarla55@gmail.com","lailamoustafa.pia@gmail.com","lucio.cam51@gmail.com"];let s=0;const r=[],l=await o.env.DB.prepare("SELECT id FROM leads WHERE id LIKE 'LEAD-IRBEMA-%' ORDER BY id DESC LIMIT 1").first();let c=128;if(l!=null&&l.id){const d=l.id.match(/LEAD-IRBEMA-(\d+)/);d&&(c=parseInt(d[1])+1)}for(const d of i)try{console.log(`üîç [HUBSPOT FORCE] Ricerca: ${d}`);const u="https://api.hubapi.com/crm/v3/objects/contacts/search",p={filterGroups:[{filters:[{propertyName:"email",operator:"EQ",value:d}]}],properties:["firstname","lastname","email","phone","mobilephone","company","hs_lead_status","createdate"]},g=await fetch(u,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify(p)});if(!g.ok){r.push(`${d}: Errore API ${g.status}`);continue}const m=await g.json();if(!m.results||m.results.length===0){r.push(`${d}: Non trovata su HubSpot`);continue}const v=m.results[0],b=v.properties,E=await o.env.DB.prepare("SELECT id FROM leads WHERE email = ? LIMIT 1").bind(d).first();if(E){console.log(`‚è≠Ô∏è [HUBSPOT FORCE] Gi√† esistente: ${d} ‚Üí ${E.id}`),r.push(`${d}: Gi√† presente come ${E.id}`);continue}const T=`LEAD-IRBEMA-${String(c).padStart(5,"0")}`;c++;const R=new Date().toISOString();await o.env.DB.prepare(`
          INSERT INTO leads (
            id, nomeRichiedente, cognomeRichiedente, email, telefono,
            servizio, piano, tipoServizio, fonte, status, vuoleBrochure, vuoleContratto,
            note, created_at, updated_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(T,b.firstname||"N/A",b.lastname||"N/A",d,b.phone||b.mobilephone||"","eCura PRO","BASE","eCura PRO","IRBEMA","NEW","No","No",`HubSpot ID: ${v.id} | FORCED IMPORT`,R,R).run(),console.log(`‚úÖ [HUBSPOT FORCE] Importato: ${T} - ${b.firstname} ${b.lastname}`),s++}catch(u){console.error(`‚ùå [HUBSPOT FORCE] Errore ${d}:`,u),r.push(`${d}: ${u instanceof Error?u.message:String(u)}`)}return o.json({success:!0,message:"Force import completato",imported:s,errors:r.length>0?r:void 0,targetEmails:i})}catch(a){return console.error("‚ùå [HUBSPOT FORCE] Errore generale:",a),o.json({success:!1,error:a instanceof Error?a.message:String(a)},500)}});I.post("/api/setup-contracts-table",async o=>{var t;try{return(t=o.env)!=null&&t.DB?(await o.env.DB.prepare(`
      CREATE TABLE IF NOT EXISTS contracts (
        id TEXT PRIMARY KEY,
        leadId TEXT NOT NULL,
        status TEXT NOT NULL DEFAULT 'DRAFT',
        created_at TEXT NOT NULL DEFAULT (datetime('now')),
        updated_at TEXT NOT NULL DEFAULT (datetime('now')),
        codice_contratto TEXT,
        tipo_contratto TEXT,
        template_utilizzato TEXT,
        contenuto_html TEXT,
        pdf_url TEXT,
        pdf_generated INTEGER DEFAULT 0,
        prezzo_mensile REAL,
        durata_mesi INTEGER DEFAULT 12,
        prezzo_totale REAL,
        data_invio TEXT,
        data_scadenza TEXT,
        data_firma TEXT,
        email_sent INTEGER DEFAULT 0,
        email_template_used TEXT,
        piano TEXT,
        servizio TEXT,
        firma_digitale TEXT,
        ip_address TEXT,
        user_agent TEXT,
        assistito_id INTEGER
      )
    `).run(),await o.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_contracts_leadId ON contracts(leadId)").run(),await o.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_contracts_status ON contracts(status)").run(),await o.env.DB.prepare("CREATE INDEX IF NOT EXISTS idx_contracts_codice ON contracts(codice_contratto)").run(),o.json({success:!0,message:"Tabella contracts creata con successo"})):o.json({success:!1,error:"Database non configurato"},500)}catch(e){return console.error("Errore creazione tabella contracts:",e),o.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});I.post("/api/setup-intestatario-fields",async o=>{var t;try{if(!((t=o.env)!=null&&t.DB))return o.json({success:!1,error:"Database non configurato"},500);const e=["ALTER TABLE leads ADD COLUMN cfIntestatario TEXT","ALTER TABLE leads ADD COLUMN codiceFiscaleIntestatario TEXT","ALTER TABLE leads ADD COLUMN indirizzoIntestatario TEXT","ALTER TABLE leads ADD COLUMN capIntestatario TEXT","ALTER TABLE leads ADD COLUMN cittaIntestatario TEXT","ALTER TABLE leads ADD COLUMN provinciaIntestatario TEXT","ALTER TABLE leads ADD COLUMN luogoNascitaIntestatario TEXT","ALTER TABLE leads ADD COLUMN dataNascitaIntestatario TEXT","ALTER TABLE leads ADD COLUMN etaCalcolata INTEGER","CREATE INDEX IF NOT EXISTS idx_leads_cf_intestatario ON leads(cfIntestatario)","CREATE INDEX IF NOT EXISTS idx_leads_citta_intestatario ON leads(cittaIntestatario)"],a=[];for(const i of e)try{await o.env.DB.prepare(i).run(),a.push({sql:i,success:!0})}catch(s){s.message.includes("duplicate column")?a.push({sql:i,success:!0,note:"already exists"}):a.push({sql:i,success:!1,error:s.message})}return o.json({success:!0,message:"Migration intestatario completata",results:a})}catch(e){return console.error("Errore migration intestatario:",e),o.json({success:!1,error:e instanceof Error?e.message:String(e)},500)}});const Vm=new Dg,Tw=Object.assign({"/src/index.tsx":I});let i0=!1;for(const[,o]of Object.entries(Tw))o&&(Vm.all("*",t=>{let e;try{e=t.executionCtx}catch{}return o.fetch(t.req.raw,t.env,e)}),Vm.notFound(t=>{let e;try{e=t.executionCtx}catch{}return o.fetch(t.req.raw,t.env,e)}),i0=!0);if(!i0)throw new Error("Can't import modules from ['/src/index.ts','/src/index.tsx','/app/server.ts']");function s0(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var Lc={exports:{}},pu,Wm;function xw(){if(Wm)return pu;Wm=1;var o=1e3,t=o*60,e=t*60,a=e*24,i=a*7,s=a*365.25;pu=function(u,p){p=p||{};var g=typeof u;if(g==="string"&&u.length>0)return r(u);if(g==="number"&&isFinite(u))return p.long?c(u):l(u);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(u))};function r(u){if(u=String(u),!(u.length>100)){var p=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(u);if(p){var g=parseFloat(p[1]),m=(p[2]||"ms").toLowerCase();switch(m){case"years":case"year":case"yrs":case"yr":case"y":return g*s;case"weeks":case"week":case"w":return g*i;case"days":case"day":case"d":return g*a;case"hours":case"hour":case"hrs":case"hr":case"h":return g*e;case"minutes":case"minute":case"mins":case"min":case"m":return g*t;case"seconds":case"second":case"secs":case"sec":case"s":return g*o;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return g;default:return}}}}function l(u){var p=Math.abs(u);return p>=a?Math.round(u/a)+"d":p>=e?Math.round(u/e)+"h":p>=t?Math.round(u/t)+"m":p>=o?Math.round(u/o)+"s":u+"ms"}function c(u){var p=Math.abs(u);return p>=a?d(u,p,a,"day"):p>=e?d(u,p,e,"hour"):p>=t?d(u,p,t,"minute"):p>=o?d(u,p,o,"second"):u+" ms"}function d(u,p,g,m){var v=p>=g*1.5;return Math.round(u/g)+" "+m+(v?"s":"")}return pu}var mu,Gm;function Iw(){if(Gm)return mu;Gm=1;function o(t){a.debug=a,a.default=a,a.coerce=d,a.disable=l,a.enable=s,a.enabled=c,a.humanize=xw(),a.destroy=u,Object.keys(t).forEach(p=>{a[p]=t[p]}),a.names=[],a.skips=[],a.formatters={};function e(p){let g=0;for(let m=0;m<p.length;m++)g=(g<<5)-g+p.charCodeAt(m),g|=0;return a.colors[Math.abs(g)%a.colors.length]}a.selectColor=e;function a(p){let g,m=null,v,b;function E(...T){if(!E.enabled)return;const R=E,S=Number(new Date),C=S-(g||S);R.diff=C,R.prev=g,R.curr=S,g=S,T[0]=a.coerce(T[0]),typeof T[0]!="string"&&T.unshift("%O");let M=0;T[0]=T[0].replace(/%([a-zA-Z%])/g,(j,N)=>{if(j==="%%")return"%";M++;const D=a.formatters[N];if(typeof D=="function"){const Y=T[M];j=D.call(R,Y),T.splice(M,1),M--}return j}),a.formatArgs.call(R,T),(R.log||a.log).apply(R,T)}return E.namespace=p,E.useColors=a.useColors(),E.color=a.selectColor(p),E.extend=i,E.destroy=a.destroy,Object.defineProperty(E,"enabled",{enumerable:!0,configurable:!1,get:()=>m!==null?m:(v!==a.namespaces&&(v=a.namespaces,b=a.enabled(p)),b),set:T=>{m=T}}),typeof a.init=="function"&&a.init(E),E}function i(p,g){const m=a(this.namespace+(typeof g>"u"?":":g)+p);return m.log=this.log,m}function s(p){a.save(p),a.namespaces=p,a.names=[],a.skips=[];const g=(typeof p=="string"?p:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const m of g)m[0]==="-"?a.skips.push(m.slice(1)):a.names.push(m)}function r(p,g){let m=0,v=0,b=-1,E=0;for(;m<p.length;)if(v<g.length&&(g[v]===p[m]||g[v]==="*"))g[v]==="*"?(b=v,E=m,v++):(m++,v++);else if(b!==-1)v=b+1,E++,m=E;else return!1;for(;v<g.length&&g[v]==="*";)v++;return v===g.length}function l(){const p=[...a.names,...a.skips.map(g=>"-"+g)].join(",");return a.enable(""),p}function c(p){for(const g of a.skips)if(r(p,g))return!1;for(const g of a.names)if(r(p,g))return!0;return!1}function d(p){return p instanceof Error?p.stack||p.message:p}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return a.enable(a.load()),a}return mu=o,mu}var Km;function Sw(){return Km||(Km=1,(function(o,t){var e={};t.formatArgs=i,t.save=s,t.load=r,t.useColors=a,t.storage=l(),t.destroy=(()=>{let d=!1;return()=>{d||(d=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function a(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let d;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(d=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(d[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function i(d){if(d[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+d[0]+(this.useColors?"%c ":" ")+"+"+o.exports.humanize(this.diff),!this.useColors)return;const u="color: "+this.color;d.splice(1,0,u,"color: inherit");let p=0,g=0;d[0].replace(/%[a-zA-Z%]/g,m=>{m!=="%%"&&(p++,m==="%c"&&(g=p))}),d.splice(g,0,u)}t.log=console.debug||console.log||(()=>{});function s(d){try{d?t.storage.setItem("debug",d):t.storage.removeItem("debug")}catch{}}function r(){let d;try{d=t.storage.getItem("debug")||t.storage.getItem("DEBUG")}catch{}return!d&&typeof process<"u"&&"env"in process&&(d=e.DEBUG),d}function l(){try{return localStorage}catch{}}o.exports=Iw()(t);const{formatters:c}=o.exports;c.j=function(d){try{return JSON.stringify(d)}catch(u){return"[UnexpectedJSONParseError]: "+u.message}}})(Lc,Lc.exports)),Lc.exports}var Aw=Sw();const Cw=s0(Aw),Rw=Object.freeze(Object.defineProperty({__proto__:null,default:Cw},Symbol.toStringTag,{value:"Module"}));var gu,qm;function _w(){return qm||(qm=1,gu=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")}),gu}var Ow=_w();const Dw=s0(Ow);/**
 * @license
 * Copyright 2018 Google Inc.
 * SPDX-License-Identifier: Apache-2.0
 */var yo;const Zp=class Zp{constructor(t){h(this,yo);_(this,"onmessage");_(this,"onclose");f(this,yo,t),n(this,yo).addEventListener("message",e=>{this.onmessage&&this.onmessage.call(null,e.data)}),n(this,yo).addEventListener("close",()=>{this.onclose&&this.onclose.call(null)}),n(this,yo).addEventListener("error",()=>{})}static create(t,e){return new Promise((a,i)=>{const s=new Dw(t,[],{followRedirects:!0,perMessageDeflate:!1,allowSynchronousEvents:!1,maxPayload:268435456,headers:{"User-Agent":`Puppeteer ${zp}`,...e}});s.addEventListener("open",()=>a(new Zp(s))),s.addEventListener("error",i)})}send(t){n(this,yo).send(t)}close(){n(this,yo).close()}};yo=new WeakMap;let wp=Zp;const Mw=Object.freeze(Object.defineProperty({__proto__:null,NodeWebSocketTransport:wp},Symbol.toStringTag,{value:"Module"})),zw=`<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Completa i tuoi dati - eCura</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
</head>
<body class="bg-gradient-to-br from-purple-600 to-purple-800 min-h-screen flex items-center justify-center p-5">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-purple-600 to-purple-800 text-white p-8 text-center">
            <h1 class="text-3xl font-bold mb-2">üìù Completa i tuoi dati</h1>
            <p class="text-purple-100">Ultimi dettagli per la tua richiesta eCura</p>
        </div>
        
        <!-- Content -->
        <div class="p-8" id="mainContent">
            <div id="loadingDiv" class="text-center py-10">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-4 border-purple-600 mb-4"></div>
                <p class="text-gray-600">Caricamento dati in corso...</p>
            </div>
            
            <div id="formContainer" style="display: none;">
                <p id="greeting" class="text-xl text-gray-800 mb-6">Gentile Cliente,</p>
                
                <!-- Box verde "Dati disponibili" RIMOSSO - ridondante -->
                
                <form id="completaForm" class="space-y-4">
                    <div id="missingFieldsContainer"></div>
                    
                    <div>
                        <label for="note" class="block text-sm font-semibold text-gray-700 mb-2">Note aggiuntive (facoltativo)</label>
                        <textarea id="note" name="note" rows="3" placeholder="Eventuali richieste o informazioni aggiuntive..." class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none"></textarea>
                    </div>
                    
                    <div class="flex items-start">
                        <input type="checkbox" id="gdprConsent" name="gdprConsent" value="1" required class="mt-1 mr-3 w-5 h-5">
                        <label for="gdprConsent" class="text-sm text-gray-700">
                            Accetto l'<a href="/privacy" target="_blank" class="text-purple-600 underline">informativa sulla privacy</a> <span class="text-red-500">*</span>
                        </label>
                    </div>
                    
                    <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-purple-600 to-purple-800 text-white py-4 rounded-lg font-bold text-lg hover:opacity-90 transition">
                        ‚úâÔ∏è Conferma e Invia
                    </button>
                </form>
            </div>
            
            <div id="errorDiv" class="bg-red-50 border-2 border-red-300 text-red-700 p-4 rounded-lg" style="display: none;"></div>
        </div>
    </div>
    
    <script>
        let leadId = null;
        const urlParams = new URLSearchParams(window.location.search);
        leadId = urlParams.get('leadId') || urlParams.get('id');
        
        if (!leadId) {
            showError('Link non valido. Manca l\\'ID del lead.');
        } else {
            loadLeadData();
        }
        
        async function loadLeadData() {
            const loadingDiv = document.getElementById('loadingDiv');
            const formContainer = document.getElementById('formContainer');
            loadingDiv.style.display = 'block';
            
            try {
                const response = await fetch(\`/api/leads/\${leadId}\`);
                if (!response.ok) throw new Error('Lead non trovato');
                
                const result = await response.json();
                const lead = result.lead || result;
                
                document.getElementById('greeting').textContent = \`Gentile \${lead.nomeRichiedente || ''} \${lead.cognomeRichiedente || ''},\`;
                
                // Box "Dati disponibili" rimosso - ridondante
                
                const missingContainer = document.getElementById('missingFieldsContainer');
                const fields = [];
                
                if (!lead.telefonoRichiedente) fields.push(createField('telefonoRichiedente', 'Telefono', 'tel', '+39 3XX XXX XXXX', true));
                if (!lead.nomeAssistito) fields.push(createField('nomeAssistito', 'Nome Assistito', 'text', 'Nome', true));
                if (!lead.cognomeAssistito) fields.push(createField('cognomeAssistito', 'Cognome Assistito', 'text', 'Cognome', true));
                if (!lead.dataNascitaAssistito) fields.push(createField('dataNascitaAssistito', 'Data Nascita Assistito', 'date', '', true));
                if (!lead.cittaAssistito) fields.push(createField('cittaAssistito', 'Citt√† Assistito', 'text', 'Es. Roma', false));
                if (!lead.cfAssistito) fields.push(createField('cfAssistito', 'Codice Fiscale Assistito', 'text', 'Es. RSSMRA85M01H501X', true));
                if (!lead.indirizzoAssistito) fields.push(createField('indirizzoAssistito', 'Indirizzo Assistito', 'text', 'Via, numero civico', false));
                if (!lead.cfIntestatario) fields.push(createField('cfIntestatario', 'Codice Fiscale Intestatario', 'text', 'Es. PGGRRT55S28D969O', true));
                if (!lead.indirizzoIntestatario) fields.push(createField('indirizzoIntestatario', 'Indirizzo Intestatario', 'text', 'Via, numero civico', false));
                if (!lead.cittaIntestatario) fields.push(createField('cittaIntestatario', 'Citt√† Intestatario', 'text', 'Es. Genova', false));
                
                if (fields.length === 0) {
                    showError('Tutti i dati sono gi√† completi!');
                    return;
                }
                
                missingContainer.innerHTML = fields.join('');
                loadingDiv.style.display = 'none';
                formContainer.style.display = 'block';
                
            } catch (error) {
                console.error('Errore:', error);
                showError('Impossibile caricare i dati. Contattaci a info@telemedcare.it');
            }
        }
        
        function createField(name, label, type, placeholder, required) {
            return \`
                <div>
                    <label for="\${name}" class="block text-sm font-semibold text-gray-700 mb-2">
                        \${label} \${required ? '<span class="text-red-500">*</span>' : ''}
                    </label>
                    <input type="\${type}" id="\${name}" name="\${name}" placeholder="\${placeholder}" 
                        \${required ? 'required' : ''} 
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none">
                </div>
            \`;
        }
        
        document.getElementById('completaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            submitBtn.textContent = '‚è≥ Invio in corso...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch(\`/api/leads/\${leadId}/complete\`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    document.getElementById('mainContent').innerHTML = \`
                        <div class="text-center py-10">
                            <div class="text-6xl mb-4">‚úÖ</div>
                            <h2 class="text-2xl font-bold text-green-600 mb-2">Dati salvati con successo!</h2>
                            <p class="text-gray-600 mb-2">Grazie per aver completato i tuoi dati.</p>
                            <p class="text-gray-600">Il nostro team ha ricevuto le tue informazioni e ti contatter√† presto.</p>
                        </div>
                    \`;
                } else {
                    throw new Error('Errore invio dati');
                }
            } catch (error) {
                console.error('Errore:', error);
                submitBtn.textContent = '‚úâÔ∏è Conferma e Invia';
                submitBtn.disabled = false;
                showError('Errore invio dati. Riprova o contattaci a info@telemedcare.it');
            }
        });
        
        function showError(message) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('formContainer').style.display = 'none';
            const errorDiv = document.getElementById('errorDiv');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
    <\/script>
</body>
</html>
`,Lw=Object.freeze(Object.defineProperty({__proto__:null,completaDatiHtml:zw},Symbol.toStringTag,{value:"Module"}));function Nw(o){if(!o)return null;try{let t;if(o.match(/^\d{4}-\d{2}-\d{2}$/))t=new Date(o);else if(o.match(/^\d{2}\/\d{2}\/\d{4}$/)){const[s,r,l]=o.split("/");t=new Date(`${l}-${r}-${s}`)}else if(o.match(/^\d{2}-\d{2}-\d{4}$/)){const[s,r,l]=o.split("-");t=new Date(`${l}-${r}-${s}`)}else return null;if(isNaN(t.getTime()))return null;const e=new Date;let a=e.getFullYear()-t.getFullYear();const i=e.getMonth()-t.getMonth();return(i<0||i===0&&e.getDate()<t.getDate())&&a--,a>=0?a:null}catch(t){return console.error("Errore calcolo et√†:",t),null}}const Pw=Object.freeze(Object.defineProperty({__proto__:null,calcolaEta:Nw},Symbol.toStringTag,{value:"Module"})),r0=129,n0=JSON.parse(`[{"excel_row":6,"data_arrivo":"2025-03-01","nome":"Claudio Macchi","email":"claudio.macchi1@libero.it","telefono":"3398183049","canale":"IRBEMA","location":"","messaggio":"Gradirei conoscere il prezzo del dispositivo.","note":"whatsapp 8/4","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00001"},{"excel_row":7,"data_arrivo":"2025-03-01","nome":"Daniela Bisson","email":"bissondaniela2018@gmail.com","telefono":"3336364976","canale":"IRBEMA","location":"","messaggio":"Richiesta informazioni per pap√† 87 anni vive da solo","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00002"},{"excel_row":8,"data_arrivo":"2025-03-06","nome":"Anna Moro","email":"moro.annamaria@yahoo.it","telefono":"3348389365","canale":"IRBEMA","location":"","messaggio":"Salve per vortesia vorrei sapere il costo dell orologio Cordialmente Moro","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00003"},{"excel_row":9,"data_arrivo":"2025-03-13","nome":"Maria Aldeghi","email":"vittoriaaldeghi@gmail.com","telefono":"3332897971","canale":"IRBEMA","location":"","messaggio":"Volevo avere pi√π informazioni del prodotto a uso privati","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00004"},{"excel_row":10,"data_arrivo":"2025-03-20","nome":"Vivian Pontarini","email":"vivianpontarin@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"Buongiorno, sto cercando un dispositivo di sicurezza per mio padre anziano che vive da solo","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00005"},{"excel_row":11,"data_arrivo":"2025-03-21","nome":"Giuseppe Porretta","email":"","telefono":"3662043768","canale":"IRBEMA","location":"Provincia di Frosinone","messaggio":"Ci ha contatto un potenziale cliente finale interessato ad un braccialetto SiDLY per la madre fragile.","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00006"},{"excel_row":12,"data_arrivo":"2025-03-22","nome":"Manuela Poggi","email":"manuela.poggi1@icloud.com","telefono":"","canale":"IRBEMA","location":"Bologna","messaggio":"Sarei interessato al vostro bracciale salva vita mi potete contattare grazie","note":"08/05/2025 inviato contratto. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00007"},{"excel_row":13,"data_arrivo":"2025-03-22","nome":"Katia Dondero","email":"katiadondero@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"Informazioni bracciale Sidly","note":"Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00008"},{"excel_row":14,"data_arrivo":"2025-03-31","nome":"Anna Maria Avenia","email":"aveniaannamaria@gmail.com","telefono":"3280466133","canale":"IRBEMA","location":"","messaggio":"Vorrei sapere il prezzo","note":"whatsapp 8/4. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00009"},{"excel_row":15,"data_arrivo":"2025-03-31","nome":"Alessandra PAVANELLO","email":"alealzira@gmail.com","telefono":"34676198737","canale":"IRBEMA","location":"","messaggio":"MI INTERESSA SIDLY","note":"Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00010"},{"excel_row":16,"data_arrivo":"2025-03-31","nome":"Marilena Cardoni","email":"marilenacardoni43@gmail.com","telefono":"3382489222","canale":"IRBEMA","location":"","messaggio":"Interessata x mio marito per varie patologie","note":"Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00011"},{"excel_row":17,"data_arrivo":"2025-03-31","nome":"Angela Rotatori","email":"angelarotatori@gmail.com","telefono":"3478477590","canale":"IRBEMA","location":"","messaggio":"Salve vorrei info sui costi grazie","note":"Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00012"},{"excel_row":18,"data_arrivo":"2025-03-31","nome":"Emilio Martire","email":"emiliomartire1@gmail.com","telefono":"3688049329","canale":"IRBEMA","location":"","messaggio":"Salve, Sono interessato a braccialetto per anziani.","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00013"},{"excel_row":19,"data_arrivo":"2025-03-31","nome":"Daniel Sutera","email":"daniel.sutera@virgilio.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"info bracciale","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00014"},{"excel_row":20,"data_arrivo":"2025-03-31","nome":"Sig. Giuseppe Porretta","email":"","telefono":"3662043768","canale":"IRBEMA","location":"","messaggio":"Provincia di Frosinone","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00015"},{"excel_row":21,"data_arrivo":"2025-03-31","nome":"Alina Macii","email":"maciialina@gmail.com","telefono":"3776759169","canale":"IRBEMA","location":"","messaggio":"Buon Pomeriggio.Voglio avere informazioni su questo orologio di telemedicina","note":"Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00016"},{"excel_row":22,"data_arrivo":"2025-03-31","nome":"Antonella Iacovitti","email":"antonellaiacovitti@gmail.com","telefono":"3385643188","canale":"IRBEMA","location":"Roma","messaggio":"Informazioni","note":"Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00017"},{"excel_row":23,"data_arrivo":"2025-04-02","nome":"Francesca Amaddeo","email":"francescaamaddeo@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00018"},{"excel_row":24,"data_arrivo":"2025-04-03","nome":"Elena Saglia","email":"elenasaglia@hotmail.com","telefono":"3493416242","canale":"IRBEMA","location":"Cernusco sul Naviglio (MI)","messaggio":"","note":"5/05 inviato contratto avanzato","status":"CONVERTED","assistito":"","id":"LEAD-IRBEMA-00019"},{"excel_row":25,"data_arrivo":"2025-04-07","nome":"Lead Anonimo - kimiamamisegua@live.it","email":"kimiamamisegua@live.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"Salvavita di cosa si tratta quanto costa","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00020"},{"excel_row":26,"data_arrivo":"2025-04-07","nome":"Pierluigi Etzi","email":"pierluigietzi69@libero.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00021"},{"excel_row":27,"data_arrivo":"2025-04-07","nome":"Tiziana Curto/ frisardi","email":"tiziana.curto64@gmail.com","telefono":"3356253956","canale":"IRBEMA","location":"","messaggio":"Vorrei un preventivo oer un dispositivo facile da utilizzare e sicuro in caso di malore di mia nadre","note":"whatsapp 8/4. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00022"},{"excel_row":28,"data_arrivo":"2025-04-08","nome":"Raffaele Di martino","email":"dimartino.raffaele@virgilio.it","telefono":"3355292860","canale":"IRBEMA","location":"","messaggio":"Presidente AVIS Napoli. Informazioni sul braccialetto anziano","note":"whatsapp 8/4. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00023"},{"excel_row":29,"data_arrivo":"2025-04-10","nome":"Sabina Pascuttini","email":"passabi@gmail.com","telefono":"3318303852","canale":"IRBEMA","location":"","messaggio":"Informazioni su contratto, costi","note":"whatsapp 10/4. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00024"},{"excel_row":30,"data_arrivo":"2025-04-23","nome":"Imma Grimaldi","email":"","telefono":"+393928995340","canale":"IRBEMA","location":"","messaggio":"","note":"whatsapp 23/4. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00025"},{"excel_row":31,"data_arrivo":"2025-04-23","nome":"Tatiana","email":"","telefono":"+39 338 690 1311","canale":"IRBEMA","location":"","messaggio":"","note":"whatsapp 23/4. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00026"},{"excel_row":32,"data_arrivo":"2025-04-23","nome":"Gaetano Santamaria","email":"","telefono":"+39 335 599 6265","canale":"IRBEMA","location":"","messaggio":"","note":"whatsapp 23/4. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00027"},{"excel_row":33,"data_arrivo":"2025-04-23","nome":"Mariaelena Torrisi","email":"","telefono":"393402534586","canale":"IRBEMA","location":"","messaggio":"","note":"whatsapp 23/4. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00028"},{"excel_row":34,"data_arrivo":"2025-04-24","nome":"Simone Corpino","email":"simonecorpino@gmail.com","telefono":"3485650603","canale":"IRBEMA","location":"","messaggio":"","note":"whatsapp 2/5.il 16/10 non √® pi√π su whatsapp","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00029"},{"excel_row":35,"data_arrivo":"2025-04-25","nome":"Caterina D‚ÄôAlterio","email":"caterinadalterio108@gmail.com","telefono":"3898006744","canale":"IRBEMA","location":"Giugliano Napoli","messaggio":"","note":"08/05/2025 inviato contratto base","status":"CONVERTED","assistito":"","id":"LEAD-IRBEMA-00030"},{"excel_row":36,"data_arrivo":"2025-04-26","nome":"Mauro Reggi","email":"","telefono":"3289051937","canale":"IRBEMA","location":"","messaggio":"","note":"whatsapp 1/5. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00031"},{"excel_row":37,"data_arrivo":"2025-04-30","nome":"Nicola","email":"immobiliarenicola@gmail.com","telefono":"3517011414","canale":"IRBEMA","location":"","messaggio":"","note":"whatsapp 30/4. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00032"},{"excel_row":38,"data_arrivo":"2025-05-01","nome":"Simona Pizzutto","email":"","telefono":"3450016665","canale":"IRBEMA","location":"San Mauro Torinese (TO)","messaggio":"","note":"08/05/2025 inviato contratto base","status":"CONVERTED","assistito":"","id":"LEAD-IRBEMA-00033"},{"excel_row":39,"data_arrivo":"2025-05-02","nome":"ANTONIA Bonavita","email":"antobonavita@libero.it","telefono":"3386484910","canale":"IRBEMA","location":"","messaggio":"","note":"7 e 8/05 inviato whatsapp. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00034"},{"excel_row":40,"data_arrivo":"2025-05-03","nome":"Barbara Camorani","email":"barbara.camorani@regione.liguria.it","telefono":"3405635515","canale":"IRBEMA","location":"","messaggio":"richiesta prova gratuita per un mese. Glielo abbiamo concesso ma la madre non vuole provare","note":"prima voleva fare una prova poi ha cambiato idea. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00035"},{"excel_row":41,"data_arrivo":"2025-05-04","nome":"Anna Posa","email":"annablu01@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00036"},{"excel_row":42,"data_arrivo":"2025-05-13","nome":"Isabella Consoloni","email":"isabella.consoloni@libero.it","telefono":"3381714788","canale":"IRBEMA","location":"","messaggio":"Salve volevo sapere quanto costa e dov'√® compralo e dov E comprarlo Gr","note":"la madre √® morta. Non serve pi√π il dispositivo","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00037"},{"excel_row":43,"data_arrivo":"2025-05-13","nome":"Roberta Verazzo","email":"verazzoroberta@yahoo.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00038"},{"excel_row":44,"data_arrivo":"2025-05-14","nome":"Giovanna Salvidio","email":"avv.giovannasalvidio@gmail.com","telefono":"3930620563","canale":"IRBEMA","location":"","messaggio":"","note":"28/07 inviato whatsapp. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00039"},{"excel_row":51,"data_arrivo":"2025-05-14","nome":"CARLA MAGLIOCCHETTI","email":"carla.magliocchetti@libero.it","telefono":"3346452561","canale":"IRBEMA","location":"","messaggio":"","note":"costi troppo elevati","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00040"},{"excel_row":45,"data_arrivo":"2025-05-21","nome":"Maria","email":"altamarea.2018@libero.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00041"},{"excel_row":46,"data_arrivo":"2025-05-22","nome":"EMANUELA BALZAROTTI","email":"emanuelabalzarotti@libero.it","telefono":"3389414462","canale":"IRBEMA","location":"","messaggio":"Desidero un preventivo per mia suocera grazie","note":"25/6 contattata, lei ci crede molto. La suocera non vuole.Da settembre far√† assistenza ad anziani autosufficienti per pratiche burocratiche ad Ogiati Olona (VA)  . Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00042"},{"excel_row":47,"data_arrivo":"2025-05-22","nome":"TONINO FICICCHIA","email":"toninoficicchia4@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"Salve che prezzo fa mia madre a la 104 e invalida","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00043"},{"excel_row":48,"data_arrivo":"2025-05-25","nome":"Luciana garrisi","email":"lucianagarrisi@libero.it","telefono":"3349057602","canale":"IRBEMA","location":"","messaggio":"","note":"26/05 inviato whatsapp. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00044"},{"excel_row":50,"data_arrivo":"2025-05-26","nome":"MONICA MORELLI","email":"avv.morellimonica@gmail.com","telefono":"3387318749","canale":"IRBEMA","location":"","messaggio":"","note":"inivato whatsapp. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00045"},{"excel_row":49,"data_arrivo":"2025-05-27","nome":"Giorgia Origa","email":"giorgiaoriga@gmail.com","telefono":"3288610478","canale":"IRBEMA","location":"","messaggio":"Vorrei informazioni per mia madre","note":"25/6 contattata, la madre non sta bene. Mi richimer√† lei. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00046"},{"excel_row":52,"data_arrivo":"2025-05-28","nome":"Claudio Fontana","email":"fontanaclaudio@hotmail.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00047"},{"excel_row":53,"data_arrivo":"2025-05-28","nome":"Claudia Peron","email":"claudiaperon07@gmail.com","telefono":"3498421721","canale":"IRBEMA","location":"","messaggio":"","note":"richiamare il 10/6 ore 12. Non risponde. Richiamata il 25/6 non risponde inviato whatsapp. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00048"},{"excel_row":55,"data_arrivo":"2025-05-29","nome":"MONICA TERRAGNI","email":"terragni.monica@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00049"},{"excel_row":54,"data_arrivo":"2025-05-30","nome":"FRANCESA CAROFEI","email":"fra.carofei@icloud.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00050"},{"excel_row":56,"data_arrivo":"2025-06-03","nome":"Silvia Grossi","email":"1967silvia@tiscali.it","telefono":"3394296488","canale":"IRBEMA","location":"","messaggio":"Salve, vorrei informazioni sul vostro prodotto. Grazie","note":"Richiamare. Ha mal di testa. Richiamata il 25/6 e le inviato nuovamente tutto perch√© prima non aveva letto. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00051"},{"excel_row":57,"data_arrivo":"2025-06-03","nome":"GIOVANNI LOLLI","email":"giovanni.lollig@gmail.com","telefono":"3247972835","canale":"IRBEMA","location":"","messaggio":"Vorrei saperne di pi√π","note":"NON E' Pi√π INTERESSATO","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00052"},{"excel_row":58,"data_arrivo":"2025-06-03","nome":"Maria Di Nuzzo","email":"amariadinuzzo358@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00053"},{"excel_row":59,"data_arrivo":"2025-06-04","nome":"CONCETTA","email":"concettacinardo@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00054"},{"excel_row":60,"data_arrivo":"2025-06-04","nome":"Antonella Robbiani","email":"arobbiani@hotmail.com","telefono":"335258091","canale":"IRBEMA","location":"","messaggio":"","note":"9/6 ho chiamato non risponde. 25/6 richiamata e il cellulare √® spento.Inviato whatsapp","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00055"},{"excel_row":61,"data_arrivo":"2025-06-05","nome":"Paola Giacobelli","email":"paolagiacobelli@yahoo.it","telefono":"3348810542","canale":"IRBEMA","location":"","messaggio":"","note":"mi ha buttato gi√π il telefono. Mi ha richiamato. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00056"},{"excel_row":62,"data_arrivo":"2025-06-09","nome":"Dorella Soatto","email":"dorellasoatto@libero.it","telefono":"3382896878","canale":"IRBEMA","location":"","messaggio":"Buongiorno, vorrei essere contattato per un preventivo per il braccialetto Sidly. Grazie","note":"mi ha scritto subito un'email. Ho parlato con la figlia. Interessati solo al base no centrale operativa. Chiamata la madre il 25/6 non risponde, inviato whatsapp. Hanno scelto un altro dipositivo","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00057"},{"excel_row":63,"data_arrivo":"2025-06-09","nome":"Elisabetta Ghidella","email":"elisabettaghidella@gmail.com","telefono":"3343442458","canale":"IRBEMA","location":"","messaggio":"Buongiorno vorrei avere maggiori informazioni. Grazie","note":"9/6 ho chiamato non risponde. 25/6 richiamata non risponde. Inviato whatsapp","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00058"},{"excel_row":64,"data_arrivo":"2025-06-09","nome":"Giancarlo Fissone","email":"iguana710@gmail.com","telefono":"3927179250","canale":"IRBEMA","location":"Bussoleno - Susa (TO)","messaggio":"Salve volevo chiederti informazioni riguardo il bracciale per quanto riguarda mia mamma prima di chiamare inviatemi un messaggio o un wathsapp grazie mille","note":"9/06  ha contattato il figlio per la madre. Richiama. E' interessato al base. Richiamato il 25/06 deve ancora parlarne con la sorella. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00059"},{"excel_row":65,"data_arrivo":"2025-06-11","nome":"Sig. Froilan","email":"usa.rossacroce@gmail.com","telefono":"","canale":"IRBEMA","location":"Roma","messaggio":"","note":"nn ha lasciato il telefono","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00060"},{"excel_row":66,"data_arrivo":"2025-06-11","nome":"Giorgio Riela","email":"gr@ecotorino.it","telefono":"0117395260","canale":"IRBEMA","location":"","messaggio":"Buongiorno, ho acquistato per mia madre e mia suocera due bracciali seremy, di cui sono profondamente scontento per la pessima assistenza post vendita, per cui sto cercando delle alternative. Voi potreste fare al caso mio? Cordiali saluti Giorgio Riela","note":"la moglie ha avuto un incidente. Richiamer√†. Abbiamo fatto sconto di 40‚Ç¨ e 140‚Ç¨","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00061"},{"excel_row":67,"data_arrivo":"2025-06-11","nome":"Paolo Magri","email":"paolo@paolomagri.com","telefono":"+41793311949","canale":"IRBEMA","location":"Como","messaggio":"","note":"25/6 inviato contratto teleassistenza base","status":"CONVERTED","assistito":"","id":"LEAD-IRBEMA-00062"},{"excel_row":68,"data_arrivo":"2025-06-13","nome":"Sindaco Delvigo","email":"sindacodelvigo@gmail.com","telefono":"3803263069","canale":"IRBEMA","location":"","messaggio":"","note":"ha risposto al telefono il 25 giugno, richiama il 26 per fare delle domande. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00063"},{"excel_row":70,"data_arrivo":"2025-06-16","nome":"Elena Bodini","email":"elenabodini5@gmail.com","telefono":"3392045623","canale":"IRBEMA","location":"Lodi - Lombardia","messaggio":"Vorrei info. Mia made 90enne vive da sola in in'altra citt√†","note":"richiamata il 25 giugno e non aveva ricevuto email e whatsapp. Adesso s√¨. 21/7 richiamata e rinviata email e whatsapp. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00064"},{"excel_row":71,"data_arrivo":"2025-06-16","nome":"Giuseppina","email":"apinucciadaluiso@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"non risponde","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00065"},{"excel_row":69,"data_arrivo":"2025-06-17","nome":"Aurora Teruggi","email":"a.teruggi@virgilio.it","telefono":"3496156239","canale":"IRBEMA","location":"Milano","messaggio":"Il vostro dispositivo pu√≤ essere utilizzato da anziani al proprio domicilio non inseriti in progetti innovativi come quello di Desio?nello specifico sarei interessata a capire se il vostro sistema potrebbe essere utile per mio padre che vive a Milani, al proprio domicilio ed il relativo costo","note":"signora molto interessata e preparato. Padre con defibrillatore. Conosce progetto Desio e CURA. Richiamata il 25 giugno non risponde. Inviato whatsapp con brochure sidly. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00066"},{"excel_row":72,"data_arrivo":"2025-06-25","nome":"Laura Calvi","email":"","telefono":"","canale":"NETWORKING","location":"Genova - Liguria","messaggio":"","note":"MAMMA STEFANIA ROCCA","status":"CONVERTED","assistito":"","id":"LEAD-NETWORKING-00001"},{"excel_row":73,"data_arrivo":"2025-06-27","nome":"Michele Amoruso","email":"ammiche@tiscali.it","telefono":"3472120496","canale":"IRBEMA","location":"Sardegna","messaggio":"Mediobanca/Informazioni sul bracialetto","note":"sentito telefonicamente - richiamato i11/07 la madre si sente troppo autonoma. Ci riprova e mi far√† sapere. TROPPO CARO PER LUI. VORREBBE PAGARE MENSILMENTE","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00067"},{"excel_row":75,"data_arrivo":"2025-07-01","nome":"Giulia Clementi","email":"","telefono":"3494378160","canale":"IRBEMA","location":"Paderno Dugnano","messaggio":"","note":"sentita telefonicamente e inviataproposta via whatsapp - richiamata l'11/7 non hanno ancora deciso, prezzo alto. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00068"},{"excel_row":74,"data_arrivo":"2025-07-02","nome":"Carmen Tierno","email":"cartier.05@libero.it","telefono":"3394745902","canale":"IRBEMA","location":"Avellino - Campania","messaggio":"","note":"sentita telefonicamente - richiamata l'11/7 non risponde. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00069"},{"excel_row":76,"data_arrivo":"2025-07-03","nome":"Raffaella Casubolo","email":"raffaellacasubolo71@gmail.com","telefono":"","canale":"IRBEMA","location":"Roma - Lazio","messaggio":"Vorrei gentilmente un preventivo esclusivamente via email","note":"chiamata 11/7 non risponde - inviato whatsapp - cellulare sbagliato - cancellato cellulare","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00070"},{"excel_row":77,"data_arrivo":"2025-07-04","nome":"Antonella Barbone","email":"","telefono":"3388821280","canale":"IRBEMA","location":"","messaggio":"sorella di sua mamma ha 92 anni. Ricoverata ed esce a fine luglio","note":"inviato whatsapp mail. Ci sta pensando in data 28/07. Il 16/10 Inviato whatsapp con nuova brochure. Non ha le disponibilit√† economiche","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00071"},{"excel_row":78,"data_arrivo":"2025-07-07","nome":"Elisabetta Cattini","email":"elisabettacattini@gmail.com","telefono":"393200811667","canale":"IRBEMA","location":"Olgiate Olona - Lombardia","messaggio":"","note":"inviato whatsapp + call non risponde. Chiamata 11/7 inviato anche whatsapp","status":"CONVERTED","assistito":"","id":"LEAD-IRBEMA-00072"},{"excel_row":79,"data_arrivo":"2025-07-08","nome":"Diego Dainese","email":"studio2dvigonza@gmail.com","telefono":"348999318","canale":"IRBEMA","location":"Padova - Veneto","messaggio":"","note":"inviata email - il cellulare √® sbagliato - 21/07 scritta altra email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00073"},{"excel_row":80,"data_arrivo":"2025-07-12","nome":"Claudio La Viola","email":"clalav74@libero.it","telefono":"3270962223","canale":"IRBEMA","location":"Palermo - Sicilia","messaggio":"Desidero avere altre informazioni. Grazie","note":"inviata email e whatsapp - 21/7 richiamato ma ha riagganciato. Il padre ha 87 anni","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00074"},{"excel_row":81,"data_arrivo":"2025-07-14","nome":"Barbara Campi","email":"campi.barbara@yahoo.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email - 21/7 rinviata email con richiesta conferma ricezione.","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00075"},{"excel_row":82,"data_arrivo":"2025-07-15","nome":"Lombardi Addolorata","email":"presidelombardi@gmail.com","telefono":"3382295587","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email - contattata telefonicamente ci pensa e mi fa sapere. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00076"},{"excel_row":83,"data_arrivo":"2025-07-16","nome":"Leonardo Perini","email":"perini.spoleto@gmail.com","telefono":"3336297471","canale":"IRBEMA","location":"","messaggio":"vorrei conoscere il prezzo le modalit√† acquisto o noleggio, il canone per la teleassistenza","note":"inviata email - whatsapp - 21/7 chiamato ma √® in riunione. Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00077"},{"excel_row":84,"data_arrivo":"2025-07-21","nome":"Grazia Fiumana","email":"graziafiumana@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00078"},{"excel_row":85,"data_arrivo":"2025-07-21","nome":"Stefania Albertin","email":"albertinstefania@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00079"},{"excel_row":86,"data_arrivo":"2025-07-21","nome":"Arianna Sichich","email":"ari.sichich@gmail.com","telefono":"3460789840","canale":"IRBEMA","location":"Bergamo - Lombardia","messaggio":"Vorrei avere maggiori imformazioni sulle caratteristiche del prodotto e costo","note":"inviata email con proposta.  Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00080"},{"excel_row":88,"data_arrivo":"2025-07-24","nome":"Andrea Spelta","email":"speltaandrea@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviatata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00081"},{"excel_row":87,"data_arrivo":"2025-07-25","nome":"Simonetta","email":"","telefono":"3201965501","canale":"IRBEMA","location":"Firenze - Toscana","messaggio":"","note":"inviato whatsapp no email e contattata .  Il 16/10 Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00082"},{"excel_row":89,"data_arrivo":"2025-07-27","nome":"Giovanni Dandraia","email":"dandraia.g@gmail.com","telefono":"3487282428","canale":"IRBEMA","location":"VIETRI DI POTENZA (PZ) BASILICATA","messaggio":"","note":"inviata email, whatsapp e call. Chiamato il 23/09: Invio contratto base","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00083"},{"excel_row":90,"data_arrivo":"2025-07-28","nome":"Norma Giannetti","email":"","telefono":"3471226301","canale":"IRBEMA","location":"Milano","messaggio":"voleva sapere i prezzi - molto frettolosa","note":"inivato whatsapp, sms e call. Chiamata il 23/09 ma non risponde.  Il 16/10 chiamato e ha riagganciato. Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00084"},{"excel_row":91,"data_arrivo":"2025-07-29","nome":"Elia Citro","email":"eliocitro7@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00085"},{"excel_row":92,"data_arrivo":"2025-07-29","nome":"Serena De Ponto","email":"depontomariaserena@gmail.com","telefono":"3514455108","canale":"IRBEMA","location":"Nettuno - Lazio","messaggio":"","note":"inviato whatsapp e email. Il 4/8 call ma non risponde. 8/9 inviato un whatsapp. 23/09 chiamata ma non risponde.  Il 16/10 chiamato e ha riagganciato. Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00086"},{"excel_row":93,"data_arrivo":"2025-07-31","nome":"Valeria Zafon","email":"valeria.zaf@gmail.com","telefono":"+393483725032","canale":"IRBEMA","location":"Venezia - Veneto","messaggio":"","note":"inviata email e whatsapp. 8/9 inviato un whatsapp. Chiamata il 23/09 ed √® occupata.  Il 16/10 chiamato e ha riagganciato. Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00087"},{"excel_row":94,"data_arrivo":"2025-08-04","nome":"Cristiana Rugggeri","email":"cristianaruggeri2611@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00088"},{"excel_row":95,"data_arrivo":"2025-08-25","nome":"Maria Ricciardelli","email":"ricciardelli.ela@gmail.com","telefono":"3496428227","canale":"IRBEMA","location":"Lecco - Lombardia","messaggio":"","note":"inviata email e whatsapp. 8/9 inviato un whatsapp. Ha bisogno di chiarimenti ma non ha tempo. 23/09 chiamata ma non risponde","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00089"},{"excel_row":96,"data_arrivo":"2025-08-27","nome":"Gabriella Azzaro","email":"annamariagabriellaazzaro757@gmail.com","telefono":"3911858536","canale":"IRBEMA","location":"Torino - Piemonte","messaggio":"VORREI UNA PROTEZIONE DA EVENTUALI MALESSERI","note":"inviata email e whatsapp. 3/9 inviato un whatsapp mi far√† sapere. 23/09 chiamata e lasciato messaggio in segreteria.  Il 16/10 chiamato e ha riagganciato. Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00090"},{"excel_row":97,"data_arrivo":"2025-08-27","nome":"Carla martini","email":"c.martini2009@libero.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00091"},{"excel_row":100,"data_arrivo":"2025-08-28","nome":"Paola Scarpin","email":"","telefono":"3404686122","canale":"IRBEMA","location":"Cervignano del Friuli","messaggio":"","note":"inviato whatsapp. Mi ha chiamato ha madre 85y su sedia a rotelle che non parla e vorrebbe un telemonitoraggio dei parametri vitali che mandino degli allert in caso si soffocasse ecc","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00092"},{"excel_row":98,"data_arrivo":"2025-08-29","nome":"Michele Lorieri","email":"lorierimichele@gmail.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"vorrei sapere il costo del bracciale e del servizio perch√© vorrei regalarlo a mia mamma","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00093"},{"excel_row":99,"data_arrivo":"2025-08-29","nome":"Ds Valerani","email":"dsvalerani@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"il bracciale sidly care pro oltre all'acquisto ha un canone annuo? Come funziona il centro che risponde all'SOS?","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00094"},{"excel_row":101,"data_arrivo":"2025-08-31","nome":"Adriana Mulassano","email":"audrey.mulassano@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00095"},{"excel_row":102,"data_arrivo":"2025-08-31","nome":"Ettore Destro","email":"ettoredestro@gmail.com","telefono":"+393273118009","canale":"IRBEMA","location":"Como - Lombardia","messaggio":"Medico. Sono interessato per monitorare i miei genitori di 90 e 88 anni. Lucidi efficienti autonomi ma che abitano da soli. \\nPer favore inviatemi un sms o un wa dicendo che mi state contattando telefonicamente, Grazie","note":"inviata email e whatsapp. 8/9 inviato un whatsapp. Chiamato il 23/09 vuole che invii un contratto per due dispositivi con centrale operativa sconto 5%","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00096"},{"excel_row":103,"data_arrivo":"2025-09-01","nome":"francesco pepe","email":"cicciopepe@libero.it","telefono":"+393317545440","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email e whatsapp. Mi far√† sapere settimana 8/09. Chiamato il 23/09 non risponde, inviato whtsapp.  Il 16/10 chiamato e ha riagganciato. Inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00097"},{"excel_row":104,"data_arrivo":"2025-09-02","nome":"Mauro Giumelli","email":"maurogiumelli1952@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00098"},{"excel_row":105,"data_arrivo":"2025-09-05","nome":"Maria Cristina Sorcini","email":"cristinasorcini@yahoo.it","telefono":"+393470562139","canale":"IRBEMA","location":"Perugia - Umbria","messaggio":"","note":"inviata email e whatsapp. Chiamat il 23/09. Costa troppo. Era per lei e non pu√≤ permetterselo","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00099"},{"excel_row":106,"data_arrivo":"2025-09-07","nome":"Norma Zanetta","email":"zanetta.norma64@gmail.com","telefono":"3409854064","canale":"IRBEMA","location":"Borgomanero - Piemonte","messaggio":"Buongiorno sto cercando un valido servizio di teleassistenza per mio padre 90 enne","note":"inviata email e whatsapp. Chiamata il 23/09 mette il padre in struttura","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00100"},{"excel_row":108,"data_arrivo":"2025-09-08","nome":"Luca Nadali","email":"luca.nadali@gmail.com","telefono":"+39 328 95 12 054","canale":"IRBEMA","location":"","messaggio":"Buongiorno, ho 48 anni ma soffro di una malattia polmonare (bronchiectasie e asma) che mi causa, in momenti non sospetti, carenza di ossigeno con svenimento. Sia per lavoro che in attivit√† sportive spesso sono da solo e in famiglia stavamo valutando un sistema di rilevazione cadute o sistema rapido di richiesta aiuto.\\nIl vostro bracciale pu√≤ soddisfare queste necessit√†.\\nQuanto sarebbe il costo completo?\\nPu√≤ essere sostenuto dal SSN?\\nGrazie per i chiarimenti.\\n\\nCordiali saluti\\n \\nLuca Nadali\\ncell: +39 328 95 12 054","note":"inviata email e whatsapp. Il 16/10 chiamato e ha riagganciato. Inviato whatsapp con nuova brochure. Ha risposto che √® troppo caro","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00101"},{"excel_row":107,"data_arrivo":"2025-09-09","nome":"Andrea Dente","email":"aanderea@me.com","telefono":"3669785184","canale":"IRBEMA","location":"Pesaro - Marche","messaggio":"","note":"inviata email e whatsapp. Ha risposto che ha ricevuto tutto. Chiamato il 23/09 non risponde.  Il 16/10 inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00102"},{"excel_row":109,"data_arrivo":"2025-09-14","nome":"Giuliano Rapelli","email":"rapelligiuliano@gmail.com","telefono":"3518276853","canale":"IRBEMA","location":"Bruzolo - Piemonte","messaggio":"Vorrei per cortesia un preventivo per il bracciale","note":"inviata email e whatsapp. Chiamato il 23/09. Ha problemi economici","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00103"},{"excel_row":110,"data_arrivo":"2025-09-14","nome":"Eros Coghi","email":"eroscoghi@gmail.com","telefono":"+393474124442","canale":"IRBEMA","location":"Cassano Magnago - Lombardia","messaggio":"","note":"inviata email e whatsapp. Chiamato il 23/09 ha gi√† trovato un'altra soluzione","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00104"},{"excel_row":111,"data_arrivo":"2025-09-15","nome":"Giuseppe Zonno","email":"gzonno@mediatipo.it","telefono":"+393333333430","canale":"IRBEMA","location":"Puglia","messaggio":"","note":"inviata email e whatsapp. Chiamato il 23/09 . Richiamare in serata. Richiamato non poteva parlare.IL 16/10 richiamato, mi telefona lui alle 15","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00105"},{"excel_row":112,"data_arrivo":"2025-09-17","nome":"Maria Maglione","email":"mariamaglione4@gmail.com","telefono":"3334464095","canale":"IRBEMA","location":"Aosta - Valle d'Aosta","messaggio":"","note":"inviata email e whatsapp. Chiamata il 23/09 ha riagganciato. Inviato whtsapp. 16/10 non √® pi√π interessata","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00106"},{"excel_row":113,"data_arrivo":"2025-09-18","nome":"Manu Cels - Simone","email":"","telefono":"","canale":"IRBEMA","location":"Valle Susa - Piemonte","messaggio":"","note":"inviato whtsapp. Scritto il 23/09 hanno preso una badante","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00107"},{"excel_row":114,"data_arrivo":"2025-09-24","nome":"Daniele Brunelli","email":"danielebrunelli.db@libero.it","telefono":"3400873094","canale":"IRBEMA","location":"Castel giorgio - Umbria","messaggio":"madre 81 anni. Problemi di vista","note":"inviato whatsapp e call mi richiama. 16/10 chiamato ed inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00108"},{"excel_row":115,"data_arrivo":"2025-09-25","nome":"Angela Ronconi","email":"angelaronconi@libero.it","telefono":"393401191079","canale":"IRBEMA","location":"Avellino - Campania","messaggio":"","note":"inviato whatsapp e call ma non ha risposto. Ci siamo risentite telefonicamente il 26/09. Vuole valutare cosa offre la concorrenza. In data 15/10 ha inviato un'altra richiesta. L'ho contattata e inviato whatsapp con nuova brochure","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00109"},{"excel_row":116,"data_arrivo":"2025-10-06","nome":"Maria Mertel","email":"mertelmaria@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"orologio salvavita per anziani","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00110"},{"excel_row":117,"data_arrivo":"2025-10-09","nome":"Tafaro","email":"t.tafaro@virgilio.it","telefono":"335 8303589","canale":"IRBEMA","location":"Roma Centro","messaggio":"orologio salvavita per anziani. Avete convenzioni con Mutue o Fondi sanitari?","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00111"},{"excel_row":118,"data_arrivo":"2025-10-13","nome":"Deanna Mantovani","email":"deannamant@outlook.it","telefono":"+393454431743","canale":"IRBEMA","location":"","messaggio":"Vorrei informazioni pi√π dettagliate sul dispositivo grazie","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00112"},{"excel_row":119,"data_arrivo":"2025-10-21","nome":"Serena Scilleri","email":"Scilleri.serena@libero.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00113"},{"excel_row":121,"data_arrivo":"2025-10-30","nome":"Silvia Brocadello","email":"silviabrocadello72@yahoo.it","telefono":"3343329422","canale":"IRBEMA","location":"Milano","messaggio":"","note":"inviato whatsapp","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00114"},{"excel_row":120,"data_arrivo":"2025-10-31","nome":"Francesco Prandoni","email":"francescoprandoni@hotmail.it","telefono":"+393394686011","canale":"IRBEMA","location":"Busto Arsizio (VA) - Lombardia","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00115"},{"excel_row":122,"data_arrivo":"2025-11-02","nome":"Andrea Vergani","email":"andrea.s.vergani@gmail.com","telefono":"+393357880251","canale":"IRBEMA","location":"Cernusco Lombardone (MI) - Lombardia","messaggio":"","note":"inviato whatsapp","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00116"},{"excel_row":123,"data_arrivo":"2025-11-06","nome":"Giovanni Creton","email":"giovannicreton@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00117"},{"excel_row":124,"data_arrivo":"2025-11-18","nome":"Valeria Ramus","email":"valeria.ramus@gmail.com","telefono":"3398179615","canale":"IRBEMA","location":"Brescia - Lombardia","messaggio":"Cerco un bracciale che riveli parametri animali o bisogno di assistenza per parente anziano","note":"inviato whtsapp","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00118"},{"excel_row":125,"data_arrivo":"2025-11-18","nome":"Claudia Franceschini","email":"franceschinicla@gmail.com","telefono":"3465024760","canale":"IRBEMA","location":"Roma - Lazio","messaggio":"","note":"inviato whtsapp. Contattata il 27/11 mi richiama il 28/11","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00119"},{"excel_row":126,"data_arrivo":"2025-11-22","nome":"Giorgio Ferranti","email":"giorgio.ferranti@msn.com","telefono":"3396935977","canale":"IRBEMA","location":"Terni (TR) - Umbria","messaggio":"costo?","note":"inviata email. Contattato il 27/11 troppo alto il prezzo","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00120"},{"excel_row":127,"data_arrivo":"2025-11-25","nome":"Emanuela","email":"doc.emi@libero.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00121"},{"excel_row":128,"data_arrivo":"2025-11-26","nome":"Luca Catrini","email":"lucacatrini25@gmail.com","telefono":"3476854422","canale":"IRBEMA","location":"Brugherio - Lombardia","messaggio":"Vorrei pi√π preventivi per pi√π soluzioni. Per il padre 88y vive da solo","note":"inviata email. Contattato il 27/11 stanno valutando anche altri dispositivi","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00122"},{"excel_row":129,"data_arrivo":"2025-11-29","nome":"Enzo Gag","email":"enzogag@tin.it","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00123"},{"excel_row":130,"data_arrivo":"2025-11-30","nome":"Francesca Grati","email":"fgrati@gmail.com","telefono":"3429714170","canale":"WEB","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-WEB-00001"},{"excel_row":132,"data_arrivo":"2025-12-13","nome":"Giuseppe","email":"pinogaglioti@gmail.com","telefono":"","canale":"IRBEMA","location":"","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00124"},{"excel_row":131,"data_arrivo":"2025-12-14","nome":"Giusy Pizzo","email":"pizzogiusy@libero.it","telefono":"3458414686","canale":"IRBEMA","location":"Roma - Lazio","messaggio":"","note":"call 15/12 + email + whatsapp. Volevano chiamata diretta all'ambulanza","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00125"},{"excel_row":133,"data_arrivo":"2025-12-14","nome":"Giansanto Rizzotti","email":"giansanto@rizzotti.it","telefono":"393276246536","canale":"IRBEMA","location":"Taranto - Puglia","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00126"},{"excel_row":134,"data_arrivo":"2025-12-17","nome":"Roberto Bifulco","email":"roberto.bif@libero.it","telefono":"3360949528","canale":"IRBEMA","location":"Napoli - Campania","messaggio":"","note":"inviata email","status":"NEW","assistito":"","id":"LEAD-IRBEMA-00127"}]`),kw={total:r0,leads:n0},Bw=Object.freeze(Object.defineProperty({__proto__:null,default:kw,leads:n0,total:r0},Symbol.toStringTag,{value:"Module"}));class l0{constructor(t){_(this,"db");_(this,"pythonScriptPath");this.db=t,this.pythonScriptPath=y0(process.cwd(),"src","services","document-generator.py")}async generateDocumentsForLead(t){try{console.log(`üìÑ Inizio generazione documenti per lead ${t}`);const e=await this.getLeadFromDatabase(t);if(!e)return{success:!1,errors:[`Lead ${t} non trovato nel database`]};if(!e.vuoleContratto)return{success:!1,errors:["Il lead non ha richiesto il contratto"]};const a=await this.callPythonGenerator(e);if(!a.success)return a;const i=a.contractPdfPath,s=a.proformaPdfPath,r=await this.saveContractToDatabase({id:a.contractId,leadId:e.id,tipo_contratto:a.tipoServizio,pdf_url:i||"",prezzo_mensile:a.prezzoBase||0,prezzo_totale:a.prezzoIvaInclusa||0}),l=await this.saveProformaToDatabase({id:a.proformaId,contract_id:a.contractId,leadId:e.id,tipo_servizio:a.tipoServizio,pdf_url:s||"",prezzo_mensile:a.prezzoBase||0,prezzo_totale:a.prezzoIvaInclusa||0,cliente_nome:e.nomeAssistito,cliente_cognome:e.cognomeAssistito,cliente_email:e.emailRichiedente,cliente_telefono:e.telefonoRichiedente||"",cliente_indirizzo:e.indirizzoAssistito||"",cliente_codice_fiscale:e.cfAssistito||""});return console.log("‚úÖ Documenti generati e salvati nel database"),{...a,contractPdfUrl:i,proformaPdfUrl:s}}catch(e){return console.error("‚ùå Errore generazione documenti:",e),{success:!1,errors:[e instanceof Error?e.message:"Errore sconosciuto"]}}}async callPythonGenerator(t){return new Promise((e,a)=>{const i=JSON.stringify({id:t.id,nomeRichiedente:t.nomeRichiedente,cognomeRichiedente:t.cognomeRichiedente,emailRichiedente:t.emailRichiedente,telefonoRichiedente:t.telefonoRichiedente,nomeAssistito:t.nomeAssistito,cognomeAssistito:t.cognomeAssistito,dataNascitaAssistito:t.dataNascitaAssistito,luogoNascitaAssistito:t.luogoNascita,cfAssistito:t.cfAssistito,indirizzoAssistito:t.indirizzoAssistito,cfRichiedente:t.cfRichiedente,indirizzoRichiedente:t.indirizzoRichiedente,pacchetto:t.pacchetto,vuoleContratto:t.vuoleContratto,intestazioneContratto:t.intestazioneContratto}),s=w0("python3",[this.pythonScriptPath,i]);let r="",l="";s.stdout.on("data",c=>{r+=c.toString()}),s.stderr.on("data",c=>{l+=c.toString()}),s.on("close",c=>{if(c!==0){e({success:!1,errors:[`Processo Python terminato con codice ${c}`,l]});return}try{const d=JSON.parse(r);e(d)}catch{e({success:!1,errors:["Errore parsing output Python",r,l]})}}),s.on("error",c=>{e({success:!1,errors:[`Errore esecuzione Python: ${c.message}`]})})})}async getLeadFromDatabase(t){try{const e=await this.db.prepare(`
        SELECT * FROM leads WHERE id = ?
      `).bind(t).first();return e?{id:e.id,nomeRichiedente:e.nomeRichiedente,cognomeRichiedente:e.cognomeRichiedente,emailRichiedente:e.emailRichiedente,telefonoRichiedente:e.telefonoRichiedente,nomeAssistito:e.nomeAssistito,cognomeAssistito:e.cognomeAssistito,dataNascitaAssistito:e.dataNascitaAssistito,etaAssistito:e.etaAssistito,parentelaAssistito:e.parentelaAssistito,pacchetto:e.pacchetto,condizioniSalute:e.condizioniSalute,priority:e.priority,preferenzaContatto:e.preferitoContatto,vuoleContratto:e.vuoleContratto==="Si",intestazioneContratto:e.intestazioneContratto,cfRichiedente:e.cfRichiedente,indirizzoRichiedente:e.indirizzoRichiedente,cfAssistito:e.cfAssistito,indirizzoAssistito:e.indirizzoAssistito,vuoleBrochure:e.vuoleBrochure==="Si",vuoleManuale:e.vuoleManuale==="Si",dataNascita:e.dataNascita,luogoNascita:e.luogoNascita,sesso:e.sesso,note:e.note,gdprConsent:e.gdprConsent==="on",timestamp:e.created_at,fonte:e.sourceUrl,versione:e.sistemaVersione,status:e.status,partnerId:e.partnerId,createdAt:e.created_at,updatedAt:e.updated_at,fingerprintHash:e.fingerprintHash,duplicatoId:e.duplicatoId}:null}catch(e){return console.error("‚ùå Errore recupero lead:",e),null}}async saveContractToDatabase(t){try{const e=new Date().toISOString(),a=`CTR-${t.id}`,i=t.tipo_contratto==="BASE"?"Template_Contratto_Base_TeleMedCare":"Template_Contratto_Avanzato_TeleMedCare";return await this.db.prepare(`
        INSERT INTO contracts (
          id, leadId, codice_contratto, tipo_contratto, template_utilizzato,
          contenuto_html, pdf_url, pdf_generated, prezzo_mensile, durata_mesi,
          prezzo_totale, status, email_sent, email_template_used,
          created_at, updated_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `).bind(t.id,t.leadId,a,t.tipo_contratto,i,"",t.pdf_url,!0,t.prezzo_mensile,12,t.prezzo_totale,"DRAFT",!1,"email_invio_contratto",e,e).run(),console.log(`‚úÖ Contratto ${t.id} salvato nel database`),!0}catch(e){return console.error("‚ùå Errore salvataggio contratto:",e),!1}}async saveProformaToDatabase(t){try{const e=new Date().toISOString(),a=new Date().toISOString().split("T")[0],i=new Date(Date.now()+720*60*60*1e3).toISOString().split("T")[0],s=`PRF-${t.id}`,r=this.extractCAP(t.cliente_indirizzo),l=this.extractCity(t.cliente_indirizzo),c=this.extractProvince(t.cliente_indirizzo);return await this.db.prepare(`
        INSERT INTO proforma (
          id, contract_id, leadId, numero_proforma, data_emissione, data_scadenza,
          cliente_nome, cliente_cognome, cliente_email, cliente_telefono,
          cliente_indirizzo, cliente_citta, cliente_cap, cliente_provincia,
          cliente_codice_fiscale, tipo_servizio, prezzo_mensile, durata_mesi,
          prezzo_totale, pdf_url, pdf_generated, template_utilizzato,
          status, email_sent, email_template_used, created_at, updated_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `).bind(t.id,t.contract_id,t.leadId,s,a,i,t.cliente_nome,t.cliente_cognome,t.cliente_email,t.cliente_telefono,t.cliente_indirizzo,l,r,c,t.cliente_codice_fiscale,t.tipo_servizio,t.prezzo_mensile,12,t.prezzo_totale,t.pdf_url,!0,"Template_Proforma_Unificato_TeleMedCare","DRAFT",!1,"email_invio_proforma",e,e).run(),console.log(`‚úÖ Proforma ${t.id} salvata nel database`),!0}catch(e){return console.error("‚ùå Errore salvataggio proforma:",e),!1}}extractCAP(t){const e=t.match(/\b(\d{5})\b/);return e?e[1]:""}extractCity(t){const e=t.match(/\d{5}\s+([A-Za-z√†√®√©√¨√≤√π√Ä√à√â√å√í√ô\s]+?)(?:\s+[A-Z]{2})?$/);return e?e[1].trim():""}extractProvince(t){const e=t.match(/\b([A-Z]{2})$/);return e?e[1]:""}async updateContractStatus(t,e){try{return await this.db.prepare(`
        UPDATE contracts 
        SET status = ?, updated_at = ?
        WHERE id = ?
      `).bind(e,new Date().toISOString(),t).run(),!0}catch(a){return console.error("‚ùå Errore aggiornamento status contratto:",a),!1}}async updateProformaStatus(t,e){try{return await this.db.prepare(`
        UPDATE proforma 
        SET status = ?, updated_at = ?
        WHERE id = ?
      `).bind(e,new Date().toISOString(),t).run(),!0}catch(a){return console.error("‚ùå Errore aggiornamento status proforma:",a),!1}}}async function Fw(o,t){return new l0(o).generateDocumentsForLead(t)}const $w=Object.freeze(Object.defineProperty({__proto__:null,DocumentManager:l0,generateDocumentsForLead:Fw},Symbol.toStringTag,{value:"Module"}));function c0(o){if(!o)return console.error("‚ùå Payload HubSpot vuoto"),!1;if(!o.portalId&&!o.properties)return console.error("‚ùå Payload HubSpot invalido: mancano portalId o properties"),!1;const t=o.properties||{};return t.hs_object_source_detail_1!=="Form eCura"?(console.log(`‚ö†Ô∏è Lead ignorato: fonte "${t.hs_object_source_detail_1}" diversa da "Form eCura"`),!1):t.email?!t.firstname||!t.lastname?(console.error("‚ùå Nome o cognome richiedente mancante"),!1):!t.servizio_ecura&&!t.piano_ecura?(console.error("‚ùå N√© servizio n√© piano eCura specificati"),!1):(console.log("‚úÖ Validazione payload superata"),!0):(console.error("‚ùå Email richiedente mancante"),!1)}function d0(o){const t=o.properties||{},e=t.richiedi_brochure===!0||t.richiedi_brochure==="true",a=t.richiedi_contratto===!0||t.richiedi_contratto==="true",i=Math.random().toString(36).substring(2,8).toUpperCase(),s=`LEAD_${new Date().toISOString().replace(/[:.]/g,"").slice(0,-1)}Z_${i}`,r=(t.piano_ecura||"BASE").toUpperCase();return{id:s,nomeRichiedente:t.firstname||"",cognomeRichiedente:t.lastname||"",emailRichiedente:t.email||"",telefonoRichiedente:t.phone||void 0,cittaRichiedente:t.city||void 0,nomeAssistito:t.nome_assistito||void 0,cognomeAssistito:t.cognome_assistito||void 0,etaAssistito:t.eta_assistito?parseInt(t.eta_assistito):void 0,pacchetto:r,vuoleBrochure:e,vuoleManuale:!1,vuoleContratto:a,fonte:"IRBEMA",note:t.note||void 0}}async function u0(o,t){var e,a;try{console.log("üíæ Tentativo salvataggio lead:",{id:o.id,nome:o.nomeRichiedente,cognome:o.cognomeRichiedente,email:o.emailRichiedente,pacchetto:o.pacchetto,fonte:o.fonte});const s=await t.prepare(`
      INSERT INTO leads (
        id, 
        nomeRichiedente, 
        cognomeRichiedente, 
        emailRichiedente, 
        telefonoRichiedente,
        cittaRichiedente,
        nomeAssistito, 
        cognomeAssistito, 
        etaAssistito,
        pacchetto,
        vuoleBrochure,
        vuoleManuale,
        vuoleContratto,
        fonte,
        note,
        status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(o.id,o.nomeRichiedente,o.cognomeRichiedente,o.emailRichiedente,o.telefonoRichiedente||"",o.cittaRichiedente||null,o.nomeAssistito||null,o.cognomeAssistito||null,o.etaAssistito||null,o.pacchetto,o.vuoleBrochure?1:0,o.vuoleManuale?1:0,o.vuoleContratto?1:0,o.fonte||"IRBEMA",o.note||null,"NEW").run();return console.log(`‚úÖ Lead ${o.id} salvato nel database. Result:`,{success:s.success,meta:s.meta,changes:((e=s.meta)==null?void 0:e.changes)||0}),!s.success||(((a=s.meta)==null?void 0:a.changes)||0)===0?{success:!1,error:"INSERT non ha modificato righe nel DB"}:{success:!0}}catch(i){const s=i instanceof Error?i.message:String(i),r={error:s,stack:i instanceof Error?i.stack:void 0,cause:i instanceof Error?i.cause:void 0,leadId:o.id,leadData:{nomeRichiedente:o.nomeRichiedente,cognomeRichiedente:o.cognomeRichiedente,emailRichiedente:o.emailRichiedente,pacchetto:o.pacchetto}};return console.error("‚ùå Errore salvataggio lead nel DB:",r),{success:!1,error:s}}}async function Uw(o,t){try{const e=await o.json();if(console.log("üì• Webhook HubSpot ricevuto:",{portalId:e.portalId,objectId:e.objectId,subscriptionType:e.subscriptionType}),!c0(e))return new Response(JSON.stringify({success:!1,error:"Payload invalido"}),{status:400,headers:{"Content-Type":"application/json"}});const a=d0(e);console.log("üîÑ Lead mappato:",{id:a.id,email:a.emailRichiedente,servizio:a.pacchetto,vuoleBrochure:a.vuoleBrochure,vuoleContratto:a.vuoleContratto});const i=t.DB||t.telemedcare_v12_db;if(!i)return console.error("‚ùå Database non configurato in env",{envKeys:Object.keys(t)}),new Response(JSON.stringify({success:!1,error:"Database non configurato"}),{status:500,headers:{"Content-Type":"application/json"}});console.log("‚úÖ Database configurato, procedo al salvataggio");const s=await u0(a,i);return s.success?new Response(JSON.stringify({success:!0,leadId:a.id,message:"Lead ricevuto e processato con successo"}),{status:200,headers:{"Content-Type":"application/json"}}):new Response(JSON.stringify({success:!1,error:"Errore salvataggio database",details:s.error||"Errore sconosciuto"}),{status:500,headers:{"Content-Type":"application/json"}})}catch(e){return console.error("‚ùå Errore handler webhook HubSpot:",e),new Response(JSON.stringify({success:!1,error:e instanceof Error?e.message:"Errore sconosciuto"}),{status:500,headers:{"Content-Type":"application/json"}})}}const jw=Object.freeze(Object.defineProperty({__proto__:null,handleHubSpotWebhook:Uw,mapHubSpotToLead:d0,saveLeadToDB:u0,validateHubSpotPayload:c0},Symbol.toStringTag,{value:"Module"}));class Hw{static async handleWebhook(t,e,a){var s,r;const i={success:!1,message:"",envelopeId:t.data.envelopeId,status:t.data.envelopeSummary.status,actions:[],errors:[]};try{console.log(`üì¨ [DOCUSIGN_WEBHOOK] Evento ricevuto: ${t.event}`),console.log(`üìã [DOCUSIGN_WEBHOOK] Envelope: ${t.data.envelopeId}`),console.log(`üìä [DOCUSIGN_WEBHOOK] Status: ${t.data.envelopeSummary.status}`);const l=t.data.envelopeId,c=t.data.envelopeSummary.status,d=await e.prepare(`
        SELECT * FROM contracts 
        WHERE docusign_envelope_id = ?
      `).bind(l).first();if(!d)return(s=i.errors)==null||s.push(`Contratto non trovato per envelope ${l}`),console.error("‚ùå [DOCUSIGN_WEBHOOK] Contratto non trovato"),i;switch(console.log(`‚úÖ [DOCUSIGN_WEBHOOK] Contratto trovato: ${d.contract_code}`),c.toLowerCase()){case"completed":await this.handleCompleted(d,t,e,a,i);break;case"declined":await this.handleDeclined(d,t,e,a,i);break;case"voided":await this.handleVoided(d,t,e,a,i);break;default:console.log(`‚ÑπÔ∏è [DOCUSIGN_WEBHOOK] Status ignorato: ${c}`),i.message=`Status ${c} ricevuto ma non processato`}return i.success=!0,i}catch(l){return console.error("‚ùå [DOCUSIGN_WEBHOOK] Errore processing webhook:",l),(r=i.errors)==null||r.push(String(l)),i}}static async handleCompleted(t,e,a,i,s){var c,d,u,p,g,m,v,b,E,T,R;console.log(`‚úÖ [DOCUSIGN_WEBHOOK] Firma completata per contratto: ${t.contract_code}`);const r=e.data.envelopeSummary.statusDateTime;(d=(c=e.data.envelopeSummary.recipients)==null?void 0:c.signers)==null||d[0],await a.prepare(`
      UPDATE contracts 
      SET status = 'signed',
          signed_at = ?,
          updated_at = datetime('now')
      WHERE id = ?
    `).bind(r,t.id).run(),(u=s.actions)==null||u.push(`Contratto ${t.contract_code} marcato come SIGNED`),console.log("‚úÖ [DOCUSIGN_WEBHOOK] Status contratto aggiornato: SIGNED");let l=null;t.lead_id&&(await a.prepare(`
        UPDATE leads 
        SET status = 'CONTRACT_SIGNED'
        WHERE id = ?
      `).bind(t.lead_id).run(),l=await a.prepare(`
        SELECT * FROM leads WHERE id = ?
      `).bind(t.lead_id).first(),(p=s.actions)==null||p.push(`Lead ${t.lead_id} aggiornato: CONTRACT_SIGNED`));try{if(l){console.log("üí∞ [DOCUSIGN_WEBHOOK] Generazione proforma automatica...");const{createProformaFromContract:S}=await Promise.resolve().then(()=>Xm),C=(await Promise.resolve().then(()=>Xm)).default,{createStripeService:M,createProformaPaymentLink:B}=await Promise.resolve().then(()=>aT),j=(await Promise.resolve().then(()=>Dt)).default,{loadEmailTemplate:N,renderTemplate:D}=await Promise.resolve().then(()=>Ec),Y=M(i),$=await S(t.contract_code,l.nome_richiedente||l.nomeRichiedente||"Cliente",l.cognome_richiedente||l.cognomeRichiedente||"",l.email_richiedente||l.emailRichiedente||"",t.servizio||l.servizio||"PRO",t.tipo_servizio||l.pacchetto||"BASE"),O=await B(Y,"",t.contract_code,$.servizio,$.piano,$.totale,$.nomeCliente,$.emailCliente);$.linkPagamentoStripe=O.url;const x=await C.generateProforma($,a);if(x.success&&x.proforma){const k=x.proforma;await a.prepare(`
            UPDATE proformas 
            SET stripe_payment_link = ?
            WHERE id = ?
          `).bind(O.url,k.proformaId).run(),console.log(`‚úÖ [DOCUSIGN_WEBHOOK] Proforma generata: ${k.numeroProforma}`),(g=s.actions)==null||g.push(`Proforma ${k.numeroProforma} generata`);try{console.log("üìß [DOCUSIGN_WEBHOOK] Invio email proforma..."),await N("email_invio_proforma",a)||console.warn("‚ö†Ô∏è [DOCUSIGN_WEBHOOK] Template email_invio_proforma non trovato in DB, uso inline");const{getPricing:ee,formatServiceName:ae}=await Promise.resolve().then(()=>lv),te=ee($.servizio,$.piano),pe={NUMERO_PROFORMA:k.numeroProforma,NOME_CLIENTE:$.nomeCliente,COGNOME_CLIENTE:$.cognomeCliente,TOTALE:$.totale.toFixed(2),LINK_PAGAMENTO:O.url,SERVIZIO_COMPLETO:ae($.servizio,$.piano),DISPOSITIVO:$.dispositivo,SCADENZA_PAGAMENTO:$.scadenzaPagamento,DATA_EMISSIONE:$.dataEmissione,CODICE_CONTRATTO:t.contract_code,DETRAZIONE_FISCALE:te?(te.detrazioneFiscale19/12).toFixed(2):"0.00"},_o=await new j(i).sendEmail({to:$.emailCliente,from:i.EMAIL_FROM||"info@telemedcare.it",subject:`üí∞ Proforma eCura ${k.numeroProforma} - Completa il Pagamento`,templateName:"email_invio_proforma",variables:pe,attachments:k.pdfBase64?[{filename:`Proforma_${k.numeroProforma}.pdf`,content:k.pdfBase64,contentType:"application/pdf"}]:void 0});_o.success?(console.log(`‚úÖ [DOCUSIGN_WEBHOOK] Email proforma inviata a ${$.emailCliente}`),(m=s.actions)==null||m.push(`Email proforma inviata a ${$.emailCliente}`)):(console.error("‚ùå [DOCUSIGN_WEBHOOK] Errore invio email proforma:",_o.error),(v=s.actions)==null||v.push(`Errore invio email: ${_o.error}`))}catch(z){console.error("‚ùå [DOCUSIGN_WEBHOOK] Errore invio email proforma:",z),(b=s.actions)==null||b.push(`Errore invio email proforma: ${z}`)}}else console.error("‚ùå [DOCUSIGN_WEBHOOK] Errore generazione proforma:",x.error),(E=s.actions)==null||E.push(`Errore generazione proforma: ${x.error}`)}else console.warn("‚ö†Ô∏è [DOCUSIGN_WEBHOOK] Lead non trovato, skip proforma"),(T=s.actions)==null||T.push("Lead non trovato, proforma skippata")}catch(S){console.error("‚ùå [DOCUSIGN_WEBHOOK] Errore workflow proforma:",S),(R=s.actions)==null||R.push(`Errore workflow proforma: ${S}`)}s.message=`Firma completata con successo per ${t.contract_code}`}static async handleDeclined(t,e,a,i,s){var r,l,c;console.log(`‚ùå [DOCUSIGN_WEBHOOK] Firma declinata per contratto: ${t.contract_code}`),await a.prepare(`
      UPDATE contracts 
      SET status = 'declined',
          updated_at = datetime('now')
      WHERE id = ?
    `).bind(t.id).run(),(r=s.actions)==null||r.push(`Contratto ${t.contract_code} marcato come DECLINED`),t.lead_id&&(await a.prepare(`
        UPDATE leads 
        SET status = 'CONTRACT_DECLINED'
        WHERE id = ?
      `).bind(t.lead_id).run(),(l=s.actions)==null||l.push(`Lead ${t.lead_id} aggiornato: CONTRACT_DECLINED`)),(c=s.actions)==null||c.push("TODO: Notifica team - firma declinata"),console.log("üìß [DOCUSIGN_WEBHOOK] TODO: Notifica team firma declinata"),s.message=`Firma declinata per ${t.contract_code}`}static async handleVoided(t,e,a,i,s){var r;console.log(`üö´ [DOCUSIGN_WEBHOOK] Envelope annullato per contratto: ${t.contract_code}`),await a.prepare(`
      UPDATE contracts 
      SET status = 'voided',
          updated_at = datetime('now')
      WHERE id = ?
    `).bind(t.id).run(),(r=s.actions)==null||r.push(`Contratto ${t.contract_code} marcato come VOIDED`),t.lead_id&&await a.prepare(`
        UPDATE leads 
        SET status = 'CONTRACT_VOIDED'
        WHERE id = ?
      `).bind(t.lead_id).run(),s.message=`Envelope annullato per ${t.contract_code}`}static validateSignature(t,e,a){return console.log("‚ö†Ô∏è [DOCUSIGN_WEBHOOK] Validazione HMAC signature TODO"),!0}}const Vw=Object.freeze(Object.defineProperty({__proto__:null,DocuSignWebhookHandler:Hw},Symbol.toStringTag,{value:"Module"}));class Ww{static async processWebhook(t,e){console.log(`üîî [STRIPE-WEBHOOK] Ricevuto evento: ${t.type}`);try{switch(t.type){case"payment_intent.succeeded":return await this.handlePaymentSuccess(t.data.object,e);case"payment_intent.payment_failed":return await this.handlePaymentFailed(t.data.object,e);case"payment_intent.canceled":return await this.handlePaymentCanceled(t.data.object,e);default:return console.log(`‚ö†Ô∏è [STRIPE-WEBHOOK] Evento non gestito: ${t.type}`),{success:!0,message:`Evento ${t.type} ricevuto ma non gestito`}}}catch(a){return console.error("‚ùå [STRIPE-WEBHOOK] Errore processamento:",a),{success:!1,message:"Errore processamento webhook",error:String(a)}}}static async handlePaymentSuccess(t,e){const a=t.id,i=t.amount/100;console.log(`‚úÖ [STRIPE-WEBHOOK] Pagamento completato: ${a} - ‚Ç¨${i}`);try{const s=t.metadata||{},r=s.proforma_number,l=s.contract_code;if(!r)throw new Error("Metadata proforma_number mancante nel payment_intent");console.log(`üìÑ [STRIPE-WEBHOOK] Proforma: ${r} | Contratto: ${l}`),await e.prepare(`
        UPDATE proformas 
        SET status = 'paid', 
            paid_at = datetime('now'),
            payment_intent_id = ?,
            updated_at = datetime('now')
        WHERE numero_proforma = ?
      `).bind(a,r).run(),console.log(`‚úÖ [STRIPE-WEBHOOK] Proforma ${r} aggiornata: paid`);const c=await e.prepare(`
        SELECT l.*, c.codice_contratto
        FROM leads l
        INNER JOIN contracts c ON c.lead_id = l.id
        WHERE c.codice_contratto = ?
      `).bind(l).first();if(!c)throw new Error(`Lead non trovato per contratto ${l}`);await e.prepare(`
        UPDATE leads 
        SET status = 'PAYMENT_COMPLETED',
            updated_at = datetime('now')
        WHERE id = ?
      `).bind(c.id).run(),console.log(`‚úÖ [STRIPE-WEBHOOK] Lead ${c.id} aggiornato: PAYMENT_COMPLETED`);const d=await this.sendConfigurationEmail(c,e);return d.success||console.error("‚ùå [STRIPE-WEBHOOK] Errore invio email configurazione:",d.error),console.log("üöö [TODO] Generare DDT automatico"),console.log("üöÄ [TODO] Avviare processo attivazione servizio"),{success:!0,message:`Pagamento completato per proforma ${r}. Email configurazione inviata.`}}catch(s){return console.error("‚ùå [STRIPE-WEBHOOK] Errore handlePaymentSuccess:",s),{success:!1,message:"Errore gestione pagamento completato",error:String(s)}}}static async sendConfigurationEmail(t,e){try{console.log(`üìß [STRIPE-WEBHOOK] Invio email configurazione a: ${t.email}`);const a=await e.prepare(`
        SELECT html_content 
        FROM document_templates 
        WHERE name = 'email_configurazione' AND active = 1
      `).first();if(!a)throw new Error("Template email_configurazione non trovato nel database");const i=`https://forms.ecura.it/configurazione/${t.id}`,s={NOME_CLIENTE:t.nome||"Cliente",COGNOME_CLIENTE:t.cognome||"",LINK_FORM_CONFIGURAZIONE:i,CODICE_CLIENTE:t.id.substring(0,12),SERVIZIO:t.servizio||"PRO",PIANO:t.pacchetto||"BASE",DATA_PAGAMENTO:new Date().toLocaleDateString("it-IT")},r=Ke.renderTemplate(a.html_content,s),l=await Ke.sendEmail({to:t.email,from:"info@telemedcare.it",fromName:"eCura - Medica GB",subject:"Configura il tuo SiDLY CARE - Benvenuto!",html:r,text:`Benvenuto! Completa la configurazione del tuo servizio eCura: ${i}`});return l.success?console.log(`‚úÖ [STRIPE-WEBHOOK] Email configurazione inviata a ${t.email}`):console.error(`‚ùå [STRIPE-WEBHOOK] Errore invio email: ${l.error}`),l}catch(a){return console.error("‚ùå [STRIPE-WEBHOOK] Errore sendConfigurationEmail:",a),{success:!1,error:String(a)}}}static async handlePaymentFailed(t,e){const a=t.id,s=(t.metadata||{}).proforma_number;return console.log(`‚ùå [STRIPE-WEBHOOK] Pagamento fallito: ${a}`),s?(await e.prepare(`
      UPDATE proformas 
      SET status = 'failed',
          updated_at = datetime('now')
      WHERE numero_proforma = ?
    `).bind(s).run(),console.log(`‚ö†Ô∏è [STRIPE-WEBHOOK] Proforma ${s} marcata come failed`),{success:!0,message:`Pagamento fallito per proforma ${s}`}):{success:!0,message:"Proforma non specificata"}}static async handlePaymentCanceled(t,e){const a=t.id,s=(t.metadata||{}).proforma_number;return console.log(`‚ö†Ô∏è [STRIPE-WEBHOOK] Pagamento cancellato: ${a}`),s?(await e.prepare(`
      UPDATE proformas 
      SET status = 'canceled',
          updated_at = datetime('now')
      WHERE numero_proforma = ?
    `).bind(s).run(),console.log(`‚ö†Ô∏è [STRIPE-WEBHOOK] Proforma ${s} marcata come canceled`),{success:!0,message:`Pagamento cancellato per proforma ${s}`}):{success:!0,message:"Proforma non specificata"}}}const Gw=Object.freeze(Object.defineProperty({__proto__:null,StripeWebhookHandler:Ww},Symbol.toStringTag,{value:"Module"})),hu={FAMILY:{BASE:{setup:390,rinnovo:200},AVANZATO:{setup:690,rinnovo:500}},PRO:{BASE:{setup:480,rinnovo:240},AVANZATO:{setup:840,rinnovo:600}},PREMIUM:{BASE:{setup:590,rinnovo:300},AVANZATO:{setup:990,rinnovo:750}}},Zm=.22,Kw=.19;function qw(o,t){const e=o.toUpperCase(),a=t.toUpperCase();if(!hu[e])throw new Error(`Servizio non valido: ${o}. Valori ammessi: FAMILY, PRO, PREMIUM`);if(!hu[e][a])throw new Error(`Piano non valido: ${t}. Valori ammessi: BASE, AVANZATO`);const{setup:i,rinnovo:s}=hu[e][a],r=Math.round(i*Zm*100)/100,l=Math.round(s*Zm*100)/100,c=Math.round((i+r)*100)/100,d=Math.round((s+l)*100)/100,u=Math.round(c*Kw*100)/100;return{setupBase:i,setupIva:r,setupTotale:c,rinnovoBase:s,rinnovoIva:l,rinnovoTotale:d,servizio:e,piano:a,detrazioneFiscale19:u}}const p0=Object.freeze(Object.defineProperty({__proto__:null,calculatePrice:qw},Symbol.toStringTag,{value:"Module"}));class Zw{constructor(t,e){_(this,"accessToken");_(this,"portalId");_(this,"baseUrl","https://api.hubapi.com");this.accessToken=t,this.portalId=e}async request(t,e={}){const a=`${this.baseUrl}${t}`,i=await fetch(a,{...e,headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json",...e.headers}});if(!i.ok){const s=await i.json();throw new Error(`HubSpot API Error: ${s.message} (${s.status})`)}return i.json()}async getContacts(t){const e=new URLSearchParams;return t!=null&&t.limit&&e.append("limit",t.limit.toString()),t!=null&&t.after&&e.append("after",t.after),(t==null?void 0:t.archived)!==void 0&&e.append("archived",t.archived.toString()),t!=null&&t.properties?t.properties.forEach(a=>e.append("properties",a)):["firstname","lastname","email","phone","mobilephone","company","address","city","state","zip","country","hs_lead_status","lifecyclestage","createdate","lastmodifieddate","servizio_ecura","piano_ecura","hs_object_source_detail_1"].forEach(i=>e.append("properties",i)),this.request(`/crm/v3/objects/contacts?${e.toString()}`)}async searchContacts(t){const e=[],a=[];t.createdAfter&&a.push({propertyName:"createdate",operator:"GTE",value:new Date(t.createdAfter).getTime().toString()}),t.createdBefore&&a.push({propertyName:"createdate",operator:"LTE",value:new Date(t.createdBefore).getTime().toString()}),t.email&&a.push({propertyName:"email",operator:"EQ",value:t.email}),t.hs_lead_status&&a.push({propertyName:"hs_lead_status",operator:"EQ",value:t.hs_lead_status}),t.hs_object_source_detail_1&&a.push({propertyName:"hs_object_source_detail_1",operator:"EQ",value:t.hs_object_source_detail_1}),a.length>0&&e.push({filters:a});const i=t.properties||["firstname","lastname","email","phone","mobilephone","hs_lead_status","lifecyclestage","createdate","lastmodifieddate","hs_object_source_detail_1","servizio_ecura","piano_ecura"],s={filterGroups:e,properties:i,limit:t.limit||100,sorts:[{propertyName:"createdate",direction:"DESCENDING"}]};return this.request("/crm/v3/objects/contacts/search",{method:"POST",body:JSON.stringify(s)})}async getContact(t,e){const a=new URLSearchParams;return(e||["firstname","lastname","email","phone","mobilephone","hs_lead_status","lifecyclestage","createdate"]).forEach(s=>a.append("properties",s)),this.request(`/crm/v3/objects/contacts/${t}?${a.toString()}`)}async createContact(t){return this.request("/crm/v3/objects/contacts",{method:"POST",body:JSON.stringify({properties:t})})}async updateContact(t,e){return this.request(`/crm/v3/objects/contacts/${t}`,{method:"PATCH",body:JSON.stringify({properties:e})})}async testConnection(){try{const t=await this.getContacts({limit:1});return{success:!0,portalId:this.portalId,message:`‚úÖ Connessione HubSpot riuscita! Trovati ${t.total} contatti totali.`}}catch(t){return{success:!1,portalId:this.portalId,message:`‚ùå Errore connessione HubSpot: ${t.message}`}}}}function Yw(o){const t=o.properties,e=t.firstname||"",a=t.lastname||"",i=t.email||"",s=t.phone||t.mobilephone||"",r=[t.address,t.city,t.state,t.zip,t.country].filter(Boolean).join(", ");console.log(`üîç [HUBSPOT MAPPING] Contact ${t.firstname} ${t.lastname}:`),console.log(`üîç [HUBSPOT MAPPING] - servizio_ecura (raw): ${t.servizio_ecura||"NULL/EMPTY"}`),console.log(`üîç [HUBSPOT MAPPING] - piano_ecura (raw): ${t.piano_ecura||"NULL/EMPTY"}`);const l=t.servizio_ecura?t.servizio_ecura.toUpperCase():"PRO",c=t.piano_ecura?t.piano_ecura.toUpperCase():"BASE";console.log(`üîç [HUBSPOT MAPPING] - servizioEcura (after default): ${l}`),console.log(`üîç [HUBSPOT MAPPING] - pianoEcura (after default): ${c}`);const d=`eCura ${l}`,u=c;let p={setupBase:null,setupIva:null,setupTotale:null,rinnovoBase:null,rinnovoIva:null,rinnovoTotale:null};try{const{calculatePrice:v}=require("./pricing-calculator"),b=v(l,c);p={setupBase:b.setupBase,setupIva:b.setupIva,setupTotale:b.setupTotale,rinnovoBase:b.rinnovoBase,rinnovoIva:b.rinnovoIva,rinnovoTotale:b.rinnovoTotale},console.log(`‚úÖ Prezzi calcolati per ${l} ${c}: ‚Ç¨${b.setupBase}`)}catch(v){console.error("‚ö†Ô∏è Errore calcolo prezzi:",v)}const m={new:"NEW",open:"CONTACTED",in_progress:"QUALIFIED",qualified:"QUALIFIED",unqualified:"LOST",contacted:"CONTACTED"}[t.hs_lead_status||"new"]||"NEW";return{nomeRichiedente:e,cognomeRichiedente:a,email:i,telefono:s,indirizzoRichiedente:r,nomeAssistito:e,cognomeAssistito:a,servizio:d,piano:u,pacchetto:u,tipoServizio:d,servizio_ecura:l,piano_ecura:c,prezzo_anno:p.setupBase,prezzo_rinnovo:p.rinnovoBase,status:m,fonte:"IRBEMA",external_source_id:o.id,note:t.note_assistito||`Importato da HubSpot - ID: ${o.id}`,vuoleContratto:t.vuole_contratto==="Si"||t.vuole_contratto==="true"?"Si":"No",vuoleBrochure:t.vuole_brochure==="Si"||t.vuole_brochure==="true"?"Si":"No",vuoleManuale:"No",consensoPrivacy:!0,consensoMarketing:!1,consensoTerze:!1,created_at:t.createdate||new Date().toISOString(),updated_at:t.lastmodifieddate||new Date().toISOString()}}const Fr=Object.freeze(Object.defineProperty({__proto__:null,HubSpotClient:Zw,mapHubSpotContactToLead:Yw},Symbol.toStringTag,{value:"Module"}));function m0(o){const t=new Date;return new Date(t.getTime()-1440*60*1e3)}async function Xw(o,t,e,a={enabled:!0,startHour:9,onlyEcura:!0,dryRun:!1}){const i=Date.now(),s={success:!1,message:"",imported:0,skipped:0,errors:0,errorDetails:[],timeRange:{from:"",to:new Date().toISOString()},performance:{hubspotContacts:0,processingTimeMs:0}};try{if(!a.enabled)return s.message="Auto-import disabilitato",s;const r=t==null?void 0:t.HUBSPOT_ACCESS_TOKEN,l=t==null?void 0:t.HUBSPOT_PORTAL_ID;if(!r||!l)return s.message="Credenziali HubSpot non configurate",s.errorDetails.push("Mancano HUBSPOT_ACCESS_TOKEN o HUBSPOT_PORTAL_ID"),s;const{HubSpotClient:c,mapHubSpotContactToLead:d}=await Promise.resolve().then(()=>Fr),u=m0(a);s.timeRange.from=u.toISOString(),console.log(`üîÑ [AUTO-IMPORT] Inizio import incrementale ultimi 1 giorno (da ${u.toLocaleString("it-IT")})`),console.log(`üìä [AUTO-IMPORT] Config: onlyEcura=${a.onlyEcura}, dryRun=${a.dryRun}`);const p=new c(r,l),g={createdAfter:u.toISOString(),limit:100};a.onlyEcura&&(g.hs_object_source_detail_1="Form eCura",console.log("üîç [AUTO-IMPORT] Filtro attivo: solo lead da Form eCura"));const m=await p.searchContacts(g);if(s.performance.hubspotContacts=m.results.length,console.log(`üìä [AUTO-IMPORT] Trovati ${m.results.length} contatti HubSpot da processare`),m.results.length===0)return s.success=!0,s.message=`Nessun nuovo lead da importare (periodo: ${u.toLocaleTimeString("it-IT")} - ${new Date().toLocaleTimeString("it-IT")})`,s.performance.processingTimeMs=Date.now()-i,s;for(const v of m.results)try{if(await o.prepare(`
          SELECT id FROM leads 
          WHERE email = ? OR external_source_id = ?
          LIMIT 1
        `).bind(v.properties.email,v.id).first()){console.log(`‚è≠Ô∏è  [AUTO-IMPORT] Contact ${v.id} (${v.properties.email}) gi√† esistente, skip`),s.skipped++;continue}if(a.dryRun){console.log(`üîç [AUTO-IMPORT DRY-RUN] Contatto ${v.id} sarebbe stato importato`),s.imported++;continue}const E=d(v),T=await o.prepare(`
          SELECT id FROM leads 
          WHERE id LIKE 'LEAD-IRBEMA-%' 
          ORDER BY id DESC 
          LIMIT 1
        `).first();let R=146;if(T!=null&&T.id){const C=T.id.match(/LEAD-IRBEMA-(\d+)/);C&&(R=parseInt(C[1])+1)}const S=`LEAD-IRBEMA-${R.toString().padStart(5,"0")}`;console.log(`üÜî [AUTO-IMPORT] Generato ID: ${S} per ${v.properties.email}`),await o.prepare(`
          INSERT INTO leads (
            id, nomeRichiedente, cognomeRichiedente, email, telefono,
            nomeAssistito, cognomeAssistito,
            servizio, piano, tipoServizio,
            prezzo_anno, prezzo_rinnovo,
            fonte, external_source_id, status, note,
            vuoleContratto, vuoleBrochure, vuoleManuale,
            consensoPrivacy, consensoMarketing, consensoTerze,
            created_at, updated_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(S,E.nomeRichiedente,E.cognomeRichiedente,E.email,E.telefono,E.nomeAssistito,E.cognomeAssistito,E.servizio,E.piano,E.tipoServizio,E.prezzo_anno||null,E.prezzo_rinnovo||null,E.fonte,E.external_source_id,E.status,E.note,E.vuoleContratto,E.vuoleBrochure,E.vuoleManuale,E.consensoPrivacy?1:0,E.consensoMarketing?1:0,E.consensoTerze?1:0,new Date().toISOString(),new Date().toISOString()).run(),console.log(`‚úÖ [AUTO-IMPORT] Lead creato: ${S} from HubSpot ${v.id}`),console.log("üîî [AUTO-IMPORT] >>> INIZIO BLOCCO EMAIL <<<"),s.imported++;try{const C=await o.prepare("SELECT value FROM settings WHERE key = 'admin_email_notifications_enabled' LIMIT 1").first(),M=(C==null?void 0:C.value)==="true";if(console.log(`üîç [AUTO-IMPORT DEBUG] adminEmailEnabled=${M}, leadData.email=${E.email}`),M&&E.email){console.log(`üìß [AUTO-IMPORT] Invio email notifica per ${S}...`),console.log(`üîç [AUTO-IMPORT DEBUG] env.RESEND_API_KEY exists: ${!!t.RESEND_API_KEY}`),console.log(`üîç [AUTO-IMPORT DEBUG] env.EMAIL_FROM: ${t.EMAIL_FROM||"NOT SET"}`);const{EmailService:B}=await Promise.resolve().then(()=>Dt),j=new B(t);console.log("üîç [AUTO-IMPORT DEBUG] EmailService initialized");const N=`
              <!DOCTYPE html>
              <html>
              <head>
                <meta charset="UTF-8">
                <style>
                  body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                  .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                  .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px 8px 0 0; }
                  .content { background: #f9f9f9; padding: 20px; border-radius: 0 0 8px 8px; }
                  .info-box { background: white; border-left: 4px solid #667eea; padding: 15px; margin: 15px 0; }
                  .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }
                  .button { display: inline-block; background: #667eea; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; margin: 10px 0; }
                </style>
              </head>
              <body>
                <div class="container">
                  <div class="header">
                    <h1 style="margin: 0;">üÜï Nuovo Lead da HubSpot</h1>
                  </div>
                  <div class="content">
                    <p><strong>Un nuovo lead √® stato importato automaticamente da HubSpot!</strong></p>
                    
                    <div class="info-box">
                      <p style="margin: 5px 0;"><strong>Lead ID:</strong> ${S}</p>
                      <p style="margin: 5px 0;"><strong>Nome:</strong> ${E.nomeRichiedente} ${E.cognomeRichiedente}</p>
                      <p style="margin: 5px 0;"><strong>Email:</strong> ${E.email}</p>
                      <p style="margin: 5px 0;"><strong>Telefono:</strong> ${E.telefono||"N/A"}</p>
                      <p style="margin: 5px 0;"><strong>Servizio:</strong> ${E.servizio}</p>
                      <p style="margin: 5px 0;"><strong>Piano:</strong> ${E.piano}</p>
                      <p style="margin: 5px 0;"><strong>Prezzo Anno:</strong> ‚Ç¨${E.prezzo_anno||"0"}</p>
                    </div>
                    
                    <p style="text-align: center;">
                      <a href="${e||"https://telemedcare-v12.pages.dev"}/admin/leads-dashboard" class="button">
                        Visualizza Dashboard
                      </a>
                    </p>
                  </div>
                  <div class="footer">
                    <p>TeleMedCare V12.0 - Sistema di Import Automatico</p>
                    <p>Questa √® una email automatica, non rispondere.</p>
                  </div>
                </div>
              </body>
              </html>
            `;await j.send({to:"info@telemedcare.it",subject:`üÜï Nuovo Lead: ${E.nomeRichiedente} ${E.cognomeRichiedente}`,html:N,text:`Nuovo lead importato da HubSpot:

ID: ${S}
Nome: ${E.nomeRichiedente} ${E.cognomeRichiedente}
Email: ${E.email}
Servizio: ${E.servizio} ${E.piano}`}),console.log(`‚úÖ [AUTO-IMPORT] Email notifica inviata con successo per ${S}`)}else console.log(`‚ÑπÔ∏è  [AUTO-IMPORT] Email notifica NON inviata - adminEmailEnabled=${M}, leadData.email=${E.email||"MISSING"}`)}catch(C){console.error("‚ö†Ô∏è [AUTO-IMPORT] Errore invio email notifica:",C),console.error("‚ö†Ô∏è [AUTO-IMPORT] Error details:",{message:C.message,stack:C.stack,leadId:S})}console.log("üîî [AUTO-IMPORT] >>> FINE BLOCCO EMAIL <<<")}catch(b){console.error(`‚ùå [AUTO-IMPORT] Errore import contact ${v.id}:`,b),s.errors++,s.errorDetails.push({contactId:v.id,email:v.properties.email,error:b.message})}return s.success=!0,s.message=a.dryRun?`Dry run: ${s.imported} lead sarebbero stati importati`:`Import completato: ${s.imported} nuovi lead importati, ${s.skipped} gi√† esistenti`,s.performance.processingTimeMs=Date.now()-i,console.log(`‚úÖ [AUTO-IMPORT] Completato in ${s.performance.processingTimeMs}ms`),console.log(`üìä [AUTO-IMPORT] Risultati: ${s.imported} importati, ${s.skipped} skipped, ${s.errors} errori`),s}catch(r){return console.error("‚ùå [AUTO-IMPORT] Errore generale:",r),s.success=!1,s.message=`Errore import: ${r.message}`,s.errorDetails.push(r.message),s.performance.processingTimeMs=Date.now()-i,s}}async function Jw(o,t){console.log("üìù [AUTO-IMPORT LOG]",JSON.stringify({imported:t.imported,skipped:t.skipped,errors:t.errors,timeRange:t.timeRange}))}const Qw=Object.freeze(Object.defineProperty({__proto__:null,executeAutoImport:Xw,getIncrementalStartTime:m0,logAutoImport:Jw},Symbol.toStringTag,{value:"Module"})),g0={GLUCOSE_METER:{id:"glucose_meter",name:"Glucometro",category:"diabetes",icon:"ü©∏",description:"Misurazione glicemia",normalRanges:{fasting:{min:70,max:110},postMeal:{min:70,max:140},bedtime:{min:100,max:140}},supportedBrands:["OneTouch","Accu-Chek","FreeStyle","Contour"]},BLOOD_PRESSURE:{id:"blood_pressure",name:"Sfigmomanometro",category:"cardiovascular",icon:"ü©∫",description:"Misurazione pressione arteriosa",normalRanges:{systolic:{min:90,max:139},diastolic:{min:60,max:89},pulse:{min:60,max:100}},supportedBrands:["Omron","Microlife","Braun","Beurer"]},OXIMETER:{id:"oximeter",name:"Pulsossimetro",category:"respiratory",icon:"ü´Å",description:"Misurazione saturazione ossigeno",normalRanges:{spo2:{min:95,max:100},heartRate:{min:60,max:100}},supportedBrands:["Nonin","Masimo","Contec","Zacurate"]},WEIGHT_SCALE:{id:"weight_scale",name:"Bilancia",category:"metabolic",icon:"‚öñÔ∏è",description:"Misurazione peso corporeo",normalRanges:{bmi:{min:18.5,max:24.9}},supportedBrands:["Withings","Fitbit","Garmin","Tanita"]},ECG_MONITOR:{id:"ecg_monitor",name:"Monitor ECG",category:"cardiovascular",icon:"üìà",description:"Elettrocardiogramma portatile",normalRanges:{heartRate:{min:60,max:100},qtInterval:{min:350,max:440}},supportedBrands:["KardiaMobile","Apple Watch","Withings","Healforce"]}},Ma=class Ma{static getInstance(){return Ma.instance||(Ma.instance=new Ma),Ma.instance}async associateDevice(t,e){try{const a=`DEV_${Date.now()}_${Math.random().toString(36).substring(2)}`;console.log("üì± Associazione nuovo dispositivo:",{customer:t,type:e.deviceType,model:`${e.brand} ${e.model}`});const i=await this.findDeviceBySerial(e.serialNumber);if(i&&i.customerId&&i.customerId!==t)return{success:!1,error:"Dispositivo gi√† associato ad altro cliente"};const s=await this.getCustomerInfo(t),l={...this.createDefaultSettings(e.deviceType),...e.settings},c={id:a,deviceType:e.deviceType,brand:e.brand,model:e.model,serialNumber:e.serialNumber,macAddress:e.macAddress,bluetoothId:e.bluetoothId,customerId:t,customerName:s.name,customerEmail:s.email,status:"ACTIVE",connectionType:"BLUETOOTH",settings:l,alerts:[],installDate:new Date().toISOString(),syncEnabled:!0,googleSheetId:e.googleSheetId,syncFrequency:15,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),tags:["new-device"]};return await this.saveDevice(c),e.googleSheetId&&await this.setupGoogleSheetsIntegration(c),await this.setupDefaultAlerts(c),console.log(`‚úÖ Dispositivo associato: ${a}`),{success:!0,device:c}}catch(a){return console.error("‚ùå Errore associazione dispositivo:",a),{success:!1,error:a instanceof Error?a.message:"Errore associazione dispositivo"}}}async recordReading(t,e){var a;try{const i=`READ_${Date.now()}_${Math.random().toString(36).substring(2)}`;console.log(`üìä Registrazione lettura dispositivo ${t}:`,e);const s=await this.getDeviceById(t);if(!s)return{success:!1,error:"Dispositivo non trovato"};const r={id:i,deviceId:t,customerId:s.customerId,readingTime:e.readingTime||new Date().toISOString(),recordedAt:new Date().toISOString(),glucoseLevel:e.glucoseLevel,bloodPressure:e.bloodPressure,oxygenSaturation:e.oxygenSaturation,heartRate:e.heartRate,bodyTemperature:e.bodyTemperature,weight:e.weight,mealContext:e.mealContext,activityContext:e.activityContext,medicationContext:e.medicationContext,quality:this.assessReadingQuality(s,e),confidence:this.calculateConfidence(s,e),isManual:e.isManual||!1,isNormal:!1,requiresAttention:!1,trend:await this.calculateTrend(t,e),sentToDoctor:!1,notes:e.notes,tags:[],createdAt:new Date().toISOString()};r.weight&&((a=s.settings.weightScale)!=null&&a.targetWeight)&&(r.bmi=r.weight/Math.pow(170/100,2));const l=this.evaluateReading(s,r);r.isNormal=l.isNormal,r.requiresAttention=l.requiresAttention,await this.saveReading(r),s.lastReading=r,s.lastConnection=new Date().toISOString(),s.updatedAt=new Date().toISOString(),await this.saveDevice(s);const c=await this.checkAndCreateAlerts(s,r,l);return s.syncEnabled&&s.googleSheetId&&await this.syncToGoogleSheets(s,r),r.requiresAttention&&await this.notifyStakeholders(s,r,c),console.log(`‚úÖ Lettura registrata: ${i} (Normale: ${r.isNormal})`),{success:!0,reading:r,alerts:c}}catch(i){return console.error("‚ùå Errore registrazione lettura:",i),{success:!1,error:i instanceof Error?i.message:"Errore registrazione lettura"}}}async getCustomerDevices(t){try{return console.log(`üîç Ricerca dispositivi cliente: ${t}`),{success:!0,devices:[{id:"DEV_001",deviceType:"GLUCOSE_METER",brand:"OneTouch",model:"Verio Reflect",serialNumber:"OT123456789",customerId:t,customerName:"Mario Rossi",customerEmail:"mario.rossi@example.com",status:"ACTIVE",connectionType:"BLUETOOTH",lastConnection:new Date(Date.now()-7200*1e3).toISOString(),batteryLevel:85,settings:this.createDefaultSettings("GLUCOSE_METER"),alerts:[],installDate:new Date(Date.now()-720*60*60*1e3).toISOString(),syncEnabled:!0,syncFrequency:15,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:"DEV_002",deviceType:"BLOOD_PRESSURE",brand:"Omron",model:"M6 Comfort",serialNumber:"OM987654321",customerId:t,customerName:"Mario Rossi",customerEmail:"mario.rossi@example.com",status:"ACTIVE",connectionType:"BLUETOOTH",lastConnection:new Date(Date.now()-3600*1e3).toISOString(),batteryLevel:92,settings:this.createDefaultSettings("BLOOD_PRESSURE"),alerts:[],installDate:new Date(Date.now()-360*60*60*1e3).toISOString(),syncEnabled:!0,syncFrequency:30,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}]}}catch(e){return console.error("‚ùå Errore ricerca dispositivi cliente:",e),{success:!1,error:e instanceof Error?e.message:"Errore ricerca dispositivi"}}}async getDeviceReadings(t,e){try{console.log(`üìä Ricerca letture dispositivo ${t}:`,e);const a=[{id:"READ_001",deviceId:t,customerId:"CUST_001",readingTime:new Date(Date.now()-7200*1e3).toISOString(),recordedAt:new Date(Date.now()-7200*1e3).toISOString(),glucoseLevel:110,mealContext:"FASTING",quality:"EXCELLENT",confidence:95,isManual:!1,isNormal:!0,requiresAttention:!1,trend:"STABLE",sentToDoctor:!1,createdAt:new Date().toISOString()},{id:"READ_002",deviceId:t,customerId:"CUST_001",readingTime:new Date(Date.now()-360*60*1e3).toISOString(),recordedAt:new Date(Date.now()-360*60*1e3).toISOString(),bloodPressure:{systolic:125,diastolic:80,pulse:72},quality:"GOOD",confidence:88,isManual:!1,isNormal:!0,requiresAttention:!1,trend:"IMPROVING",sentToDoctor:!1,createdAt:new Date().toISOString()}],i={totalReadings:a.length,normalReadings:a.filter(s=>s.isNormal).length,anomalousReadings:a.filter(s=>!s.isNormal).length,averageValue:a.reduce((s,r)=>{var l;return s+(r.glucoseLevel||((l=r.bloodPressure)==null?void 0:l.systolic)||0)},0)/a.length,trend:"STABLE"};return{success:!0,readings:a,stats:i}}catch(a){return console.error("‚ùå Errore ricerca letture:",a),{success:!1,error:a instanceof Error?a.message:"Errore ricerca letture"}}}async getDeviceStatistics(t){try{return console.log("üìä Calcolo statistiche dispositivi"),{totalDevices:347,activeDevices:289,offlineDevices:12,totalReadings:15642,recentReadings:127,criticalAlerts:3,devicesByType:{GLUCOSE_METER:89,BLOOD_PRESSURE:134,OXIMETER:67,WEIGHT_SCALE:45,ECG_MONITOR:12},batteryStatus:{low:23,medium:87,high:237},syncStatus:{synced:267,pending:18,failed:4}}}catch(e){throw console.error("‚ùå Errore calcolo statistiche dispositivi:",e),e}}async getCustomerInfo(t){return{name:"Mario Rossi",email:"mario.rossi@example.com"}}async findDeviceBySerial(t){return console.log(`üîç Ricerca dispositivo per serial: ${t}`),null}async getDeviceById(t){return console.log(`üîç Ricerca dispositivo per ID: ${t}`),{id:t,deviceType:"GLUCOSE_METER",brand:"OneTouch",model:"Verio Reflect",serialNumber:"OT123456789",customerId:"CUST_001",customerName:"Mario Rossi",customerEmail:"mario.rossi@example.com",status:"ACTIVE",connectionType:"BLUETOOTH",settings:this.createDefaultSettings("GLUCOSE_METER"),alerts:[],installDate:new Date().toISOString(),syncEnabled:!0,syncFrequency:15,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}}createDefaultSettings(t){const e={measurementUnit:"METRIC",timezone:"Europe/Rome",language:"IT",notifications:{enabled:!0,email:!0,sms:!1,push:!0,emergencyContacts:[]},automations:{autoSync:!0,smartReminders:!0,doctorAlerts:!0,familySharing:!1}};switch(t){case"GLUCOSE_METER":e.glucoseMeter={targetMin:70,targetMax:140,mealOffset:120,insulinType:"rapid"};break;case"BLOOD_PRESSURE":e.bloodPressure={systolicMin:90,systolicMax:139,diastolicMin:60,diastolicMax:89,measurementPosition:"ARM"};break;case"OXIMETER":e.oximeter={spo2Min:95,heartRateMin:60,heartRateMax:100,alarmEnabled:!0};break;case"WEIGHT_SCALE":e.weightScale={targetWeight:70,weightGoal:"MAINTAIN",weeklyTarget:.5};break}return e}assessReadingQuality(t,e){return e.isManual||t.batteryLevel&&t.batteryLevel<20?"FAIR":!t.lastConnection||new Date(t.lastConnection)<new Date(Date.now()-1440*60*1e3)?"GOOD":"EXCELLENT"}calculateConfidence(t,e){let a=100;return e.isManual&&(a-=20),t.batteryLevel&&t.batteryLevel<20&&(a-=10),(!t.calibrationData||new Date(t.calibrationData.nextCalibrationDue)<new Date)&&(a-=15),Math.max(0,a)}async calculateTrend(t,e){return console.log(`üìà Calcolo trend per dispositivo: ${t}`),"STABLE"}evaluateReading(t,e){const a=g0[t.deviceType];let i=!0,s=!1,r=0;if(e.glucoseLevel&&a.normalRanges){const l=a.normalRanges,c=e.mealContext==="FASTING"?l.fasting:l.postMeal;c&&(i=e.glucoseLevel>=c.min&&e.glucoseLevel<=c.max,e.glucoseLevel<70?(s=!0,r=e.glucoseLevel<54?9:6):e.glucoseLevel>250&&(s=!0,r=8))}if(e.bloodPressure&&a.normalRanges){const l=a.normalRanges,{systolic:c,diastolic:d}=e.bloodPressure;i=c>=l.systolic.min&&c<=l.systolic.max&&d>=l.diastolic.min&&d<=l.diastolic.max,c>180||d>110?(s=!0,r=9):(c<90||d<60)&&(s=!0,r=6)}return{isNormal:i,requiresAttention:s,severity:r}}async checkAndCreateAlerts(t,e,a){const i=[];if(a.requiresAttention){const r={id:`ALERT_${Date.now()}_${Math.random().toString(36).substring(2)}`,deviceId:t.id,customerId:t.customerId,type:a.severity>=8?"CRITICAL":"WARNING",category:"READING_ANOMALY",title:this.getAlertTitle(t.deviceType,e,a.severity),message:this.getAlertMessage(t.deviceType,e,a.severity),severity:a.severity,triggeredBy:"READING",triggerValue:this.getReadingValue(e),status:"ACTIVE",actionsTaken:[],escalationLevel:0,notificationsSent:{patient:!1,doctor:!1,family:!1,emergency:!1},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};i.push(r),t.alerts.push(r),console.log(`üö® Alert creato: ${r.type} - ${r.title}`)}return i}getAlertTitle(t,e,a){if(t==="GLUCOSE_METER"&&e.glucoseLevel){if(e.glucoseLevel<70)return a>=9?"IPOGLICEMIA SEVERA":"Ipoglicemia";if(e.glucoseLevel>250)return"IPERGLICEMIA SEVERA"}if(t==="BLOOD_PRESSURE"&&e.bloodPressure){if(e.bloodPressure.systolic>180)return"CRISI IPERTENSIVA";if(e.bloodPressure.systolic<90)return"Ipotensione"}return"Valore Anomalo"}getAlertMessage(t,e,a){return t==="GLUCOSE_METER"&&e.glucoseLevel&&e.glucoseLevel<70?`Glicemia molto bassa: ${e.glucoseLevel} mg/dL. ${a>=9?"CONTATTARE IMMEDIATAMENTE IL MEDICO!":"Assumere zuccheri rapidamente."}`:"Rilevato valore fuori range normale. Consultare il medico."}getReadingValue(t){return t.glucoseLevel||t.bloodPressure||t.oxygenSaturation||t.weight}async saveDevice(t){console.log(`üíæ Salvataggio dispositivo: ${t.id}`)}async saveReading(t){console.log(`üíæ Salvataggio lettura: ${t.id}`)}async setupGoogleSheetsIntegration(t){console.log(`üìä Setup Google Sheets per dispositivo: ${t.id}`)}async setupDefaultAlerts(t){console.log(`üîî Setup alert default per dispositivo: ${t.id}`)}async syncToGoogleSheets(t,e){t.googleSheetId&&console.log(`üìä Sync a Google Sheets: ${t.googleSheetId}`)}async notifyStakeholders(t,e,a){console.log(`üìß Notifica stakeholder per alert critici: ${t.id}`)}async readCompleteCELabel(t){try{console.log(`üè∑Ô∏è [CE LABEL] Lettura completa etichetta CE dispositivo: ${t}`);const e={imei:"868298061208378",udiCode:"SIDLY868298061208378240531",udiDI:"(01)05060301000017",udiPI:"(11)240531(21)868298061208378",manufacturingDate:"05/2023",manufacturingDateISO:"2023-05-01T00:00:00.000Z",expiryDate:this.calculateDeviceExpiry("2023-05-01","SIDLY_CARE_PRO").expiryDate,warrantyExpiry:this.calculateWarrantyExpiry("2023-05-01",24),modelCode:"SIDLY-CP-2023-V1",batchLot:"LOT240531A",softwareVersion:"v2.4.1",hardwareVersion:"HW-1.2",ceMarkCode:"CE0123",notifiedBodyNumber:"0123",medicalDeviceClass:"IIa",riskClass:"MEDIUM_RISK",complianceStandards:["ISO 13485:2016","ISO 14971:2019","IEC 62304:2006","ISO 62366-1:2015","EN 60601-1:2006"],regulatoryStatus:"CE_MARKED",manufacturerName:"SiDLY Medical Technologies S.r.l.",manufacturerCode:"SIDLY-IT-001",manufacturerAddress:"Via delle Tecnologie, 15 - 20900 Milano, Italy",authorizedRep:"SiDLY EU Representative B.V.",qcPassedDate:"2023-05-30T14:30:00.000Z",calibrationDate:"2023-05-29T10:15:00.000Z",nextCalibrationDue:"2024-05-29T10:15:00.000Z",deviceLifespan:24,remainingLifespan:this.calculateRemainingDays("2023-05-01",24),lifecycleStatus:this.determineLifecycleStatus("2023-05-01",24),storageConditions:{temperatureMin:-10,temperatureMax:60,humidityMax:85,pressureRange:"500-1060 hPa"},sterilizationMethod:"GAMMA",sterileUntil:"2025-05-01T23:59:59.000Z",ifu:"IFU-SIDLY-CP-IT-v2.4",technicalDocumentation:"TD-SIDLY-CP-2023-001",riskAnalysisRef:"RA-SIDLY-CP-v1.2"},a=this.validateCELabel(e),i=this.generateCERecommendations(e);a.length>0&&console.warn("‚ö†Ô∏è [CE LABEL] Errori validazione:",a);const s=await this.getDeviceById(t);return s&&(s.ceLabel=e,s.imei=e.imei,s.deviceType="SIDLY_CARE_PRO",s.updatedAt=new Date().toISOString(),await this.saveDevice(s)),{success:!0,ceLabel:e,validationErrors:a.length>0?a:void 0,recommendations:i}}catch(e){return console.error("‚ùå [CE LABEL] Errore lettura etichetta CE:",e),{success:!1,error:e instanceof Error?e.message:"Errore lettura etichetta CE completa"}}}validateCELabel(t){const e=[];this.validateIMEI(t.imei)||e.push(`IMEI non valido: ${t.imei}`),(!t.udiCode||t.udiCode.length<10)&&e.push("UDI Code mancante o troppo corto");const a=new Date(t.manufacturingDateISO),i=new Date(t.expiryDate);return isNaN(a.getTime())&&e.push("Data fabbricazione non valida"),isNaN(i.getTime())&&e.push("Data scadenza non valida"),a>i&&e.push("Data fabbricazione posteriore alla scadenza"),["I","IIa","IIb","III"].includes(t.medicalDeviceClass)||e.push(`Classe dispositivo medico non valida: ${t.medicalDeviceClass}`),(!t.notifiedBodyNumber||!/^\d{4}$/.test(t.notifiedBodyNumber))&&e.push("Numero ente notificato deve essere 4 cifre"),t.storageConditions.temperatureMin>=t.storageConditions.temperatureMax&&e.push("Range temperatura stoccaggio non valido"),e}generateCERecommendations(t){const e=[],a=Math.ceil((new Date(t.expiryDate).getTime()-Date.now())/864e5);a<0?e.push("üö® URGENTE: Dispositivo scaduto - Sostituire immediatamente"):a<=30?e.push("‚ö†Ô∏è ATTENZIONE: Dispositivo in scadenza entro 30 giorni - Pianificare sostituzione"):a<=90&&e.push("üìÖ INFO: Dispositivo in scadenza entro 90 giorni - Monitorare");const i=Math.ceil((new Date(t.nextCalibrationDue).getTime()-Date.now())/(1e3*60*60*24));if(i<0?e.push("üîß MANUTENZIONE: Calibrazione scaduta - Programmare immediatamente"):i<=7&&e.push("üîß MANUTENZIONE: Calibrazione dovuta entro 7 giorni"),t.sterilizationMethod!=="NONE"){const s=new Date(t.sterileUntil),r=Math.ceil((s.getTime()-Date.now())/(1e3*60*60*24));r<0?e.push("ü¶† IGIENE: Sterilizzazione scaduta - Ri-sterilizzare prima dell'uso"):r<=30&&e.push("ü¶† IGIENE: Sterilizzazione in scadenza entro 30 giorni")}return t.remainingLifespan<=30&&e.push("üìä LIFECYCLE: Dispositivo vicino al fine vita - Valutare sostituzione"),e}calculateRemainingDays(t,e){const a=new Date(t),i=new Date(a);i.setMonth(i.getMonth()+e);const s=new Date,r=i.getTime()-s.getTime();return Math.ceil(r/(1e3*60*60*24))}determineLifecycleStatus(t,e){const a=this.calculateRemainingDays(t,e);if(a<0)return"END_OF_LIFE";if(a<=30)return"MAINTENANCE";const i=e*30;return(i-a)/i*100<10?"NEW":"ACTIVE"}calculateWarrantyExpiry(t,e){const a=new Date(t),i=new Date(a);return i.setMonth(i.getMonth()+e),i.toISOString().split("T")[0]}async readDeviceIMEI(t){try{console.log(`üì± [IMEI] Lettura IMEI dispositivo: ${t}`);const e=this.generateValidIMEI();if(!this.validateIMEI(e))return{success:!1,error:"IMEI non valido - fallito controllo Luhn"};const a=this.parseIMEIInfo(e),i=await this.getDeviceById(t);return i&&(i.imei=e,i.updatedAt=new Date().toISOString()),{success:!0,imei:e,deviceInfo:{...a,readTime:new Date().toISOString(),deviceType:(i==null?void 0:i.deviceType)||"SiDLY_CARE_PRO"}}}catch(e){return console.error("‚ùå [IMEI] Errore lettura IMEI:",e),{success:!1,error:e instanceof Error?e.message:"Errore lettura IMEI"}}}calculateDeviceExpiry(t,e="SiDLY_CARE_PRO"){try{const a=new Date(t),i={SiDLY_CARE_PRO:24,GLUCOSE_METER:36,BLOOD_PRESSURE:24,OXIMETER:18,ECG_MONITOR:60,DEFAULT:24},s=i[e]||i.DEFAULT,r=new Date(a);r.setMonth(r.getMonth()+s);const l=new Date,c=r.getTime()-l.getTime(),d=Math.ceil(c/(1e3*60*60*24));let u,p;return d<0?(u="EXPIRED",p="üö® URGENTE: Sostituire dispositivo immediatamente"):d<=30?(u="EXPIRING",p="‚ö†Ô∏è ATTENZIONE: Pianificare sostituzione entro 30 giorni"):(u="VALID",p="‚úÖ Dispositivo in garanzia - Nessuna azione richiesta"),{expiryDate:r.toISOString().split("T")[0],daysRemaining:d,warrantyStatus:u,recommendedAction:p}}catch(a){return console.error("‚ùå Errore calcolo scadenza:",a),{expiryDate:"N/A",daysRemaining:0,warrantyStatus:"EXPIRED",recommendedAction:"‚ùå Errore calcolo - Verificare data fabbricazione"}}}generateValidIMEI(){const t="35742108",e=Math.floor(1e5+Math.random()*9e5).toString(),a=t+e,i=this.calculateLuhnDigit(a);return a+i}validateIMEI(t){if(t.length!==15||!/^\d+$/.test(t))return!1;const e=t.split("").map(Number);let a=0;for(let s=0;s<14;s++){let r=e[s];s%2===1&&(r*=2,r>9&&(r-=9)),a+=r}return(10-a%10)%10===e[14]}calculateLuhnDigit(t){const e=t.split("").map(Number);let a=0;for(let i=0;i<e.length;i++){let s=e[i];i%2===1&&(s*=2,s>9&&(s-=9)),a+=s}return((10-a%10)%10).toString()}parseIMEIInfo(t){const e=t.substring(0,8),a=t.substring(8,14),s={35742108:{manufacturer:"SiDLY Medical",model:"Care Pro"},35742109:{manufacturer:"SiDLY Medical",model:"Care Advanced"},35742110:{manufacturer:"SiDLY Medical",model:"Care Basic"}}[e]||{manufacturer:"Unknown",model:"Unknown Device"};return{tac:e,snr:a,manufacturer:s.manufacturer,deviceModel:s.model,isValid:this.validateIMEI(t)}}async registerDeviceLevel1(t){var e,a;try{console.log("üì± [LIVELLO 1] Registrazione base dispositivo:",t.serialNumber);const i=`DEV_L1_${Date.now()}_${Math.random().toString(36).substring(2)}`,s=await this.readCompleteCELabel(i);if(!s.success)return{success:!1,error:"Impossibile leggere etichetta CE"};const r={id:i,deviceType:t.deviceType,serialNumber:t.serialNumber,brand:((e=s.ceLabel)==null?void 0:e.manufacturerName)||"SiDLY Medical",model:((a=s.ceLabel)==null?void 0:a.modelCode)||"Care Pro",ceLabel:s.ceLabel,status:"ACTIVE",connectionType:"MANUAL",installDate:new Date().toISOString(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return await this.saveDevice(r),{success:!0,deviceId:i}}catch(i){return console.error("‚ùå [LIVELLO 1] Errore registrazione:",i),{success:!1,error:i instanceof Error?i.message:"Errore registrazione livello 1"}}}async configureDeviceLevel2(t,e){try{console.log("‚öôÔ∏è [LIVELLO 2] Configurazione avanzata dispositivo:",t);const a=await this.getDeviceById(t);return a?(a.customerId=e.customerId,a.connectionType=e.connectionType,a.location=e.location,a.updatedAt=new Date().toISOString(),e.settings&&(a.settings={...a.settings,...e.settings}),e.connectionType!=="MANUAL"&&(a.syncEnabled=!0,a.syncFrequency=15,await this.setupDeviceAutomation(a)),await this.saveDevice(a),{success:!0}):{success:!1,error:"Dispositivo non trovato"}}catch(a){return console.error("‚ùå [LIVELLO 2] Errore configurazione:",a),{success:!1,error:a instanceof Error?a.message:"Errore configurazione livello 2"}}}async enableDeviceLevel3(t,e){try{console.log("üîÑ [LIVELLO 3] Integrazione completa dispositivo:",t);const a=await this.getDeviceById(t);return a?(e.enableRealTimeMonitoring&&await this.enableRealTimeMonitoring(a),e.enableAlerting&&await this.setupAdvancedAlerting(a,e.emergencyContacts),e.enableGoogleSheets&&e.googleSheetId&&(a.googleSheetId=e.googleSheetId,await this.setupGoogleSheetsIntegration(a)),e.enableDoctorIntegration&&e.doctorEmail&&await this.setupDoctorIntegration(a,e.doctorEmail),a.updatedAt=new Date().toISOString(),await this.saveDevice(a),{success:!0}):{success:!1,error:"Dispositivo non trovato"}}catch(a){return console.error("‚ùå [LIVELLO 3] Errore integrazione:",a),{success:!1,error:a instanceof Error?a.message:"Errore integrazione livello 3"}}}async enableDeviceLevel4(t,e){try{console.log("üß† [LIVELLO 4] Analytics e AI dispositivo:",t);const a=await this.getDeviceById(t);if(!a)return{success:!1,error:"Dispositivo non trovato"};const i={deviceId:t,predictiveAnalytics:e.enablePredictiveAnalytics,trendAnalysis:e.enableTrendAnalysis,anomalyDetection:e.enableAnomalyDetection,personalizedRecommendations:e.enablePersonalizedRecommendations,aiModel:e.aiModelType||"BASIC",enabledAt:new Date().toISOString()};return await this.setupMLPipeline(a,i),await this.initializeAIBaseline(a),a.updatedAt=new Date().toISOString(),await this.saveDevice(a),{success:!0}}catch(a){return console.error("‚ùå [LIVELLO 4] Errore setup AI:",a),{success:!1,error:a instanceof Error?a.message:"Errore setup AI livello 4"}}}async enableDeviceLevel5(t,e){try{console.log("üè¢ [LIVELLO 5] Integrazione Enterprise:",t);const a=await this.getDeviceById(t);return a?(e.enableHISIntegration&&await this.setupHISIntegration(a,e.organizationId),e.enableHL7Integration&&await this.setupHL7Integration(a),e.enableGDPRCompliance&&await this.setupGDPRCompliance(a),e.enableAuditTrail&&await this.setupAuditTrail(a),e.enableRegulatoryReporting&&await this.setupRegulatoryReporting(a,e.complianceLevel),a.updatedAt=new Date().toISOString(),await this.saveDevice(a),{success:!0}):{success:!1,error:"Dispositivo non trovato"}}catch(a){return console.error("‚ùå [LIVELLO 5] Errore setup Enterprise:",a),{success:!1,error:a instanceof Error?a.message:"Errore setup Enterprise livello 5"}}}async setupDeviceAutomation(t){console.log(`ü§ñ Setup automazione dispositivo: ${t.id}`)}async enableRealTimeMonitoring(t){console.log(`üì° Attivazione monitoraggio real-time: ${t.id}`)}async setupAdvancedAlerting(t,e){console.log(`üö® Setup alerting avanzato: ${t.id}`)}async setupDoctorIntegration(t,e){console.log(`üë®‚Äç‚öïÔ∏è Setup integrazione medico: ${t.id} -> ${e}`)}async setupMLPipeline(t,e){console.log(`üß† Setup pipeline ML: ${t.id}`)}async initializeAIBaseline(t){console.log(`üìä Inizializzazione baseline AI: ${t.id}`)}async setupHISIntegration(t,e){console.log(`üè• Setup integrazione HIS: ${t.id} -> ${e}`)}async setupHL7Integration(t){console.log(`üìã Setup HL7 FHIR: ${t.id}`)}async setupGDPRCompliance(t){console.log(`üîí Setup GDPR compliance: ${t.id}`)}async setupAuditTrail(t){console.log(`üìù Setup audit trail: ${t.id}`)}async setupRegulatoryReporting(t,e){console.log(`üìä Setup regulatory reporting: ${t.id} -> ${e}`)}};_(Ma,"instance",null);let Ed=Ma;const h0=Object.freeze(Object.defineProperty({__proto__:null,DEVICE_TYPES:g0,DeviceManager:Ed,default:Ed},Symbol.toStringTag,{value:"Module"}));class Ym{static async generateProforma(t,e){try{console.log("üìÑ [PROFORMA] Generazione proforma per contratto:",t.codiceContratto),console.log("üìÑ [PROFORMA] Piano:",t.piano,"| Servizio:",t.servizio);const a=this.generateProformaNumber(),i=`PROF_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,s={...t,numeroProforma:a,dataEmissione:t.dataEmissione||new Date().toLocaleDateString("it-IT"),dataScadenza:t.dataScadenza||this.calculateScadenza(7)},r=await this.generateProformaHTML(s),l=Buffer.from(r).toString("base64");return await e.prepare(`
        INSERT INTO proformas (
          id, numero_proforma, contract_code, servizio, piano,
          importo_base, iva, totale, status,
          pdf_url, stripe_payment_link, created_at, updated_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'), datetime('now'))
      `).bind(i,a,t.codiceContratto,t.servizio,t.piano,t.importoBase,t.iva,t.totale,"pending",`/proformas/${a}.pdf`,t.linkPagamentoStripe||null).run(),console.log(`‚úÖ [PROFORMA] Proforma generata: ${a} (${t.piano})`),{success:!0,proforma:{proformaId:i,numeroProforma:a,pdfBase64:l,pdfUrl:`/proformas/${a}.pdf`,createdAt:new Date().toISOString()}}}catch(a){return console.error("‚ùå [PROFORMA] Errore generazione:",a),{success:!1,error:String(a)}}}static generateProformaNumber(){const t=new Date,e=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),i=Math.random().toString(36).substring(2,8).toUpperCase();return`PF-${e}${a}-${i}`}static calculateScadenza(t){const e=new Date;return e.setDate(e.getDate()+t),e.toLocaleDateString("it-IT")}static async generateProformaHTML(t){t.piano;const e=this.getProformaTemplate(t.piano),a={NUMERO_PROFORMA:t.numeroProforma,DATA_PROFORMA:t.dataEmissione,DATA_GENERAZIONE:new Date().toLocaleDateString("it-IT"),DATA_SCADENZA:t.dataScadenza,NOME_COGNOME_CLIENTE:`${t.nomeCliente} ${t.cognomeCliente}`,CODICE_CLIENTE:t.codiceContratto.substring(0,12),INDIRIZZO_CLIENTE:t.indirizzoCliente||"DA COMPLETARE",CITTA_CAP_CLIENTE:"",CODICE_FISCALE_CLIENTE:t.codiceFiscaleCliente||"DA COMPLETARE",EMAIL_CLIENTE:t.emailCliente,TELEFONO_CLIENTE:t.telefonoCliente||"Non specificato",DESCRIZIONE_SERVIZIO:t.descrizioneServizio,DISPOSITIVO:t.dispositivo,SERVIZIO_COMPLETO:Yt(t.servizio,t.piano),IMPORTO_BASE:t.importoBase.toFixed(2).replace(".",","),IVA:t.iva.toFixed(2).replace(".",","),TOTALE:t.totale.toFixed(2).replace(".",","),LINK_PAGAMENTO:t.linkPagamentoStripe||"mailto:info@medicagb.it",IBAN_AZIENDALE:"IT00 X000 0000 0000 0000 0000 000",CODICE_CONTRATTO:t.codiceContratto,ANNO:new Date().getFullYear().toString()};return is.render(e,a)}static getProformaTemplate(t){return`<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proforma {{NUMERO_PROFORMA}} - eCura</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      text-align: center;
      border-bottom: 3px solid #3b82f6;
      padding-bottom: 20px;
      margin-bottom: 30px;
    }
    .logo {
      color: #3b82f6;
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .proforma-title {
      font-size: 24px;
      color: #3b82f6;
      margin: 20px 0;
      text-align: center;
    }
    .info-box {
      background: #f9fafb;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    .table th,
    .table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    .table th {
      background: #f3f4f6;
      font-weight: bold;
    }
    .total-box {
      background: linear-gradient(135deg, #f8faff 0%, #e8f2ff 100%);
      border: 2px solid #3b82f6;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      text-align: right;
    }
    .total-box .amount {
      font-size: 32px;
      font-weight: bold;
      color: #3b82f6;
    }
    .payment-button {
      display: inline-block;
      background: #22c55e;
      color: white;
      padding: 15px 40px;
      text-decoration: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      margin: 20px 0;
      text-align: center;
    }
    .payment-button:hover {
      background: #16a34a;
    }
    .footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 2px solid #e5e7eb;
      font-size: 12px;
      color: #666;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">üè• eCura - Medica GB S.r.l.</div>
    <div style="font-size: 14px; color: #666;">
      Startup Innovativa a Vocazione Sociale<br>
      P.IVA: 12435130963 | Reg. Imprese Milano<br>
      Corso Garibaldi 34, 20121 Milano
    </div>
  </div>

  <h1 class="proforma-title">üìÑ PROFORMA / FATTURA PROFORMA</h1>
  
  <div class="info-box">
    <table style="width: 100%;">
      <tr>
        <td><strong>Numero Proforma:</strong></td>
        <td>{{NUMERO_PROFORMA}}</td>
      </tr>
      <tr>
        <td><strong>Data Emissione:</strong></td>
        <td>{{DATA_EMISSIONE}}</td>
      </tr>
      <tr>
        <td><strong>Scadenza Pagamento:</strong></td>
        <td>{{DATA_SCADENZA}}</td>
      </tr>
      <tr>
        <td><strong>Contratto Collegato:</strong></td>
        <td>{{CODICE_CONTRATTO}}</td>
      </tr>
    </table>
  </div>

  <div class="info-box">
    <h3 style="margin-top: 0; color: #3b82f6;">üë§ CLIENTE</h3>
    <p>
      <strong>Nome e Cognome:</strong> {{NOME_CLIENTE}} {{COGNOME_CLIENTE}}<br>
      <strong>Email:</strong> {{EMAIL_CLIENTE}}<br>
      <strong>Telefono:</strong> {{TELEFONO_CLIENTE}}<br>
      <strong>Indirizzo:</strong> {{INDIRIZZO_CLIENTE}}<br>
      <strong>Codice Fiscale:</strong> {{CODICE_FISCALE}}
    </p>
  </div>

  <h3 style="color: #3b82f6;">üì¶ SERVIZI</h3>
  <table class="table">
    <thead>
      <tr>
        <th>Descrizione</th>
        <th>Quantit√†</th>
        <th style="text-align: right;">Importo</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>
          <strong>{{SERVIZIO_COMPLETO}}</strong><br>
          <small>{{DESCRIZIONE_SERVIZIO}}</small><br>
          <small>Dispositivo: {{DISPOSITIVO}}</small><br>
          <small>Durata: 12 mesi (primo anno)</small>
        </td>
        <td>1</td>
        <td style="text-align: right;">{{IMPORTO_BASE}}</td>
      </tr>
    </tbody>
  </table>

  <div class="total-box">
    <table style="width: 100%;">
      <tr>
        <td><strong>Imponibile:</strong></td>
        <td style="text-align: right;">{{IMPORTO_BASE}}</td>
      </tr>
      <tr>
        <td><strong>IVA 22%:</strong></td>
        <td style="text-align: right;">{{IVA}}</td>
      </tr>
      <tr style="border-top: 2px solid #3b82f6;">
        <td><strong style="font-size: 18px;">TOTALE DA PAGARE:</strong></td>
        <td style="text-align: right;">
          <div class="amount">{{TOTALE}}</div>
        </td>
      </tr>
    </table>
  </div>

  <div style="text-align: center; margin: 40px 0;">
    <h3 style="color: #3b82f6;">üí≥ PROCEDI AL PAGAMENTO</h3>
    <p>Paga in modo sicuro con carta di credito/debito o bonifico bancario</p>
    <a href="{{LINK_PAGAMENTO}}" class="payment-button">
      üí≥ PAGA ORA ‚Ç¨{{TOTALE}}
    </a>
    <p style="font-size: 14px; color: #666;">
      üîí Pagamento sicuro tramite Stripe<br>
      ‚è∞ Scadenza: {{SCADENZA_PAGAMENTO}}
    </p>
  </div>

  <div class="info-box">
    <h4 style="margin-top: 0; color: #3b82f6;">üìã MODALIT√Ä DI PAGAMENTO</h4>
    <p><strong>1. Pagamento Online (Consigliato):</strong><br>
    Clicca sul pulsante "PAGA ORA" e completa il pagamento con carta di credito/debito in modo sicuro tramite Stripe.</p>
    
    <p><strong>2. Bonifico Bancario:</strong><br>
    IBAN: <strong>IT00 X000 0000 0000 0000 0000 000</strong><br>
    Intestato a: <strong>Medica GB S.r.l.</strong><br>
    Causale: <strong>Proforma {{NUMERO_PROFORMA}}</strong></p>
    
    <p style="font-size: 12px; color: #666;">
    ‚ö†Ô∏è In caso di bonifico, inviare ricevuta a info@telemedcare.it per conferma pagamento
    </p>
  </div>

  <div class="info-box" style="background: #fef3c7; border-left: 4px solid #f59e0b;">
    <h4 style="margin-top: 0; color: #92400e;">üí∞ DETRAZIONE FISCALE 19%</h4>
    <p>Il servizio eCura √® detraibile come spesa sanitaria nella dichiarazione dei redditi (730/Unico).</p>
    <p><strong>Risparmio fiscale stimato:</strong> Fino a {{IVA}} di detrazione annuale</p>
    <p style="font-size: 12px;">Riceverai tutta la documentazione necessaria per il 730</p>
  </div>

  <div class="footer">
    <p><strong style="color: #3b82f6; font-size: 14px;">Contatti Medica GB S.r.l. - eCura</strong></p>
    <p>
      üìß Email: <a href="mailto:info@telemedcare.it">info@telemedcare.it</a> | 
      üìû Telefono: 02 8715 6826 | 
      üì± Assistenza: 335 730 1206
    </p>
    <p>
      üè¢ Milano: Corso Garibaldi 34, 20121 | 
      üè¢ Genova: Via delle Eriche 53, 16148
    </p>
    <p>
      üåê Web: <a href="https://www.ecura.it">www.ecura.it</a>
    </p>
    <p style="margin-top: 15px; font-size: 11px; font-style: italic;">
      Medica GB S.r.l. - P.IVA 12435130963 | Reg. Imprese Milano | Cap. Soc. ‚Ç¨10.000 i.v.<br>
      Questa √® una proforma. Dopo il pagamento riceverai la fattura definitiva.
    </p>
  </div>
</body>
</html>`}}async function eT(o,t,e,a,i,s,r){const l=vc(i,s);if(!l)throw new Error(`Pricing non trovato per ${i} ${s}`);return{numeroProforma:"",dataEmissione:new Date().toLocaleDateString("it-IT"),dataScadenza:new Date(Date.now()+10080*60*1e3).toLocaleDateString("it-IT"),nomeCliente:t,cognomeCliente:e,emailCliente:a,servizio:i,piano:s,descrizioneServizio:`Servizio eCura ${Yt(i,s)} - Primo Anno`,dispositivo:l.dispositivo,importoBase:l.setupBase,iva:l.setupIva,totale:l.setupTotale,codiceContratto:o,linkPagamentoStripe:r,scadenzaPagamento:new Date(Date.now()+10080*60*1e3).toLocaleDateString("it-IT")}}const Xm=Object.freeze(Object.defineProperty({__proto__:null,ProformaGenerator:Ym,createProformaFromContract:eT,default:Ym},Symbol.toStringTag,{value:"Module"}));class f0{constructor(t){_(this,"config");_(this,"baseUrl","https://api.stripe.com/v1");this.config=t}async createPaymentLink(t){try{console.log(`üí≥ [STRIPE] Creazione Payment Link per ‚Ç¨${(t.amount/100).toFixed(2)}`);const e=`plink_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,a=`https://buy.stripe.com/test_${e}`,i={id:e,url:a,active:!0};return console.log(`‚úÖ [STRIPE] Payment Link creato: ${i.url}`),i}catch(e){throw console.error("‚ùå [STRIPE] Errore creazione Payment Link:",e),new Error(`Stripe Payment Link creation failed: ${e}`)}}async createPaymentIntent(t,e="eur",a){try{console.log(`üí≥ [STRIPE] Creazione Payment Intent per ‚Ç¨${(t/100).toFixed(2)}`);const i=`pi_${Date.now()}_${Math.random().toString(36).substring(2,9)}`;return{id:i,amount:t,currency:e,status:"requires_payment_method",clientSecret:`${i}_secret_${Math.random().toString(36).substring(2,9)}`}}catch(i){throw console.error("‚ùå [STRIPE] Errore creazione Payment Intent:",i),i}}async retrievePaymentIntent(t){try{return console.log(`üîç [STRIPE] Recupero Payment Intent: ${t}`),{id:t,amount:102480,currency:"eur",status:"succeeded"}}catch(e){throw console.error("‚ùå [STRIPE] Errore recupero Payment Intent:",e),e}}static validateWebhookSignature(t,e,a){return console.log("‚ö†Ô∏è [STRIPE] Validazione webhook signature TODO"),!0}}function tT(o){const t={secretKey:o.STRIPE_SECRET_KEY||"sk_test_DEMO",publicKey:o.STRIPE_PUBLIC_KEY||"pk_test_DEMO",webhookSecret:o.STRIPE_WEBHOOK_SECRET||"whsec_DEMO",apiVersion:"2023-10-16"};return new f0(t)}function v0(o){return Math.round(o*100)}async function oT(o,t,e,a,i,s,r,l){const c=`Proforma ${t} - eCura ${a} ${i}`;return await o.createPaymentLink({amount:v0(s),currency:"eur",description:c,metadata:{proforma_number:t,contract_code:e,servizio:a,piano:i,cliente_nome:r,cliente_email:l},successUrl:`https://www.ecura.it/pagamento-confermato?proforma=${t}`,cancelUrl:`https://www.ecura.it/pagamento-annullato?proforma=${t}`})}const aT=Object.freeze(Object.defineProperty({__proto__:null,StripeService:f0,createProformaPaymentLink:oT,createStripeService:tT,euroToCents:v0},Symbol.toStringTag,{value:"Module"}));export{Vm as default};
