<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleMedCare V11.0 - Documentazione</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* Editor styles */
        .editor-container { min-height: 500px; }
        textarea.editor {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            tab-size: 2;
        }
        .category-badge {
            @apply px-2 py-1 text-xs rounded-full font-medium;
        }
        .category-technical { @apply bg-blue-100 text-blue-800; }
        .category-user { @apply bg-green-100 text-green-800; }
        .category-admin { @apply bg-purple-100 text-purple-800; }
        .category-api { @apply bg-yellow-100 text-yellow-800; }
        .category-deployment { @apply bg-red-100 text-red-800; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-book text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Centro Documentazione</h1>
                        <p class="text-blue-100">TeleMedCare V11.0 Modular Enterprise</p>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <a href="/admin/data-dashboard" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-dashboard mr-2"></i>Dashboard
                    </a>
                    <a href="/admin/environments" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-cogs mr-2"></i>Ambienti
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Tecnica</p>
                        <p class="text-2xl font-bold text-blue-600" id="technicalCount">0</p>
                    </div>
                    <i class="fas fa-code text-2xl text-blue-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Utente</p>
                        <p class="text-2xl font-bold text-green-600" id="userCount">0</p>
                    </div>
                    <i class="fas fa-user text-2xl text-green-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Admin</p>
                        <p class="text-2xl font-bold text-purple-600" id="adminCount">0</p>
                    </div>
                    <i class="fas fa-shield-alt text-2xl text-purple-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-yellow-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">API</p>
                        <p class="text-2xl font-bold text-yellow-600" id="apiCount">0</p>
                    </div>
                    <i class="fas fa-plug text-2xl text-yellow-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-red-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Deployment</p>
                        <p class="text-2xl font-bold text-red-600" id="deploymentCount">0</p>
                    </div>
                    <i class="fas fa-rocket text-2xl text-red-500"></i>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Sidebar -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Search -->
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-search text-blue-500 mr-2"></i>
                        Ricerca
                    </h3>
                    
                    <div class="space-y-3">
                        <input type="text" id="searchInput" placeholder="Cerca nella documentazione..." 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        
                        <select id="categoryFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Tutte le categorie</option>
                            <option value="technical">Tecnica</option>
                            <option value="user">Utente</option>
                            <option value="admin">Admin</option>
                            <option value="api">API</option>
                            <option value="deployment">Deployment</option>
                        </select>
                        
                        <button id="searchBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-search mr-2"></i>Cerca
                        </button>
                    </div>
                </div>

                <!-- Actions -->
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-tools text-green-500 mr-2"></i>
                        Azioni
                    </h3>
                    
                    <div class="space-y-3">
                        <button id="newSectionBtn" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-plus mr-2"></i>Nuova Sezione
                        </button>
                        
                        <button id="initDocsBtn" class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-database mr-2"></i>Inizializza Docs
                        </button>
                        
                        <button id="generateDocsBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-magic mr-2"></i>Genera Auto
                        </button>
                        
                        <button id="refreshDocsBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-sync mr-2"></i>Aggiorna Lista
                        </button>
                    </div>
                </div>

                <!-- Categories Navigation -->
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-folder text-indigo-500 mr-2"></i>
                        Categorie
                    </h3>
                    
                    <div id="categoriesNav" class="space-y-2">
                        <!-- Categories loaded dynamically -->
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Editor/Viewer -->
                <div id="editorPanel" class="bg-white rounded-xl shadow-sm hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold flex items-center">
                                <i class="fas fa-edit text-blue-500 mr-2"></i>
                                <span id="editorTitle">Editor Documentazione</span>
                            </h3>
                            <div class="flex space-x-2">
                                <button id="saveBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-all">
                                    <i class="fas fa-save mr-2"></i>Salva
                                </button>
                                <button id="cancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-all">
                                    <i class="fas fa-times mr-2"></i>Annulla
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6 editor-container">
                        <form id="docForm">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Titolo</label>
                                    <input type="text" id="docTitle" required
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Categoria</label>
                                    <select id="docCategory" required
                                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">Seleziona categoria</option>
                                        <option value="technical">Tecnica</option>
                                        <option value="user">Utente</option>
                                        <option value="admin">Admin</option>
                                        <option value="api">API</option>
                                        <option value="deployment">Deployment</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tags (separati da virgola)</label>
                                <input type="text" id="docTags" placeholder="tag1, tag2, tag3"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Contenuto (Markdown)</label>
                                <textarea id="docContent" rows="20" required
                                          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent editor"
                                          placeholder="# Titolo Sezione&#10;&#10;Scrivi il contenuto in formato Markdown..."></textarea>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Documentation List -->
                <div id="docsList" class="bg-white rounded-xl shadow-sm">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-list text-indigo-500 mr-2"></i>
                            Documentazione Disponibile
                        </h3>
                    </div>
                    <div class="p-6">
                        <div id="documentsContainer" class="space-y-4">
                            <!-- Documents loaded dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Modal -->
    <div id="statusModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
            <div class="text-center">
                <div id="statusIcon" class="text-4xl mb-4"></div>
                <h3 id="statusTitle" class="text-lg font-semibold mb-2"></h3>
                <p id="statusMessage" class="text-gray-600 mb-4"></p>
                <button onclick="closeStatusModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-all">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- View Modal -->
    <div id="viewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 id="viewTitle" class="text-lg font-semibold"></h3>
                <div class="flex space-x-2">
                    <button id="editFromViewBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-all">
                        <i class="fas fa-edit mr-1"></i>Modifica
                    </button>
                    <button onclick="closeViewModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition-all">
                        <i class="fas fa-times mr-1"></i>Chiudi
                    </button>
                </div>
            </div>
            <div id="viewContent" class="prose max-w-none">
                <!-- Content rendered here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        let currentEditingSection = null;
        let allDocuments = [];

        // Modal management
        function showStatusModal(icon, title, message, isSuccess = true) {
            document.getElementById('statusIcon').innerHTML = icon
            document.getElementById('statusIcon').className = `text-4xl mb-4 ${isSuccess ? 'text-green-500' : 'text-red-500'}`
            document.getElementById('statusTitle').textContent = title
            document.getElementById('statusMessage').textContent = message
            document.getElementById('statusModal').classList.remove('hidden')
            document.getElementById('statusModal').classList.add('flex')
        }

        function closeStatusModal() {
            document.getElementById('statusModal').classList.add('hidden')
            document.getElementById('statusModal').classList.remove('flex')
        }

        function showViewModal(section) {
            document.getElementById('viewTitle').textContent = section.title
            document.getElementById('viewContent').innerHTML = marked.parse(section.content)
            document.getElementById('editFromViewBtn').onclick = () => {
                closeViewModal()
                editSection(section)
            }
            document.getElementById('viewModal').classList.remove('hidden')
            document.getElementById('viewModal').classList.add('flex')
        }

        function closeViewModal() {
            document.getElementById('viewModal').classList.add('hidden')
            document.getElementById('viewModal').classList.remove('flex')
        }

        // Documentation functions
        async function loadDocumentation() {
            try {
                const response = await axios.get('/api/docs/sections')
                
                if (response.data.success) {
                    allDocuments = response.data.sections
                    displayDocuments(allDocuments)
                    updateStatistics(response.data.categories)
                    updateCategoriesNav(response.data.categories)
                }
            } catch (error) {
                console.error('Errore caricamento documentazione:', error)
                showStatusModal('<i class="fas fa-times-circle"></i>', 'Errore', 'Errore nel caricamento della documentazione', false)
            }
        }

        function displayDocuments(documents) {
            const container = document.getElementById('documentsContainer')
            container.innerHTML = ''
            
            if (documents.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-file-text text-4xl mb-4"></i>
                        <p>Nessuna documentazione trovata</p>
                        <button onclick="initializeDocumentation()" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-all">
                            Inizializza Documentazione
                        </button>
                    </div>
                `
                return
            }
            
            documents.forEach(doc => {
                const docCard = document.createElement('div')
                docCard.className = 'border border-gray-200 rounded-lg p-4 card-hover cursor-pointer'
                docCard.onclick = () => showViewModal(doc)
                
                const categoryClass = `category-${doc.category}`
                
                docCard.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <h4 class="font-medium text-gray-900">${doc.title}</h4>
                                <span class="category-badge ${categoryClass}">${doc.category}</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">${doc.content.substring(0, 150)}...</p>
                            <div class="flex items-center space-x-4 text-xs text-gray-500">
                                <span><i class="fas fa-user mr-1"></i>${doc.author}</span>
                                <span><i class="fas fa-calendar mr-1"></i>${new Date(doc.last_updated).toLocaleDateString('it-IT')}</span>
                                <span><i class="fas fa-tag mr-1"></i>${doc.version}</span>
                            </div>
                            ${doc.tags && doc.tags.length > 0 ? `
                                <div class="mt-2 flex flex-wrap gap-1">
                                    ${doc.tags.map(tag => `<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">${tag}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="event.stopPropagation(); editSection(${JSON.stringify(doc).replace(/"/g, '&quot;')})" 
                                    class="text-blue-500 hover:text-blue-700 p-2">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                `
                
                container.appendChild(docCard)
            })
        }

        function updateStatistics(categories) {
            document.getElementById('technicalCount').textContent = (categories.technical || []).length
            document.getElementById('userCount').textContent = (categories.user || []).length
            document.getElementById('adminCount').textContent = (categories.admin || []).length
            document.getElementById('apiCount').textContent = (categories.api || []).length
            document.getElementById('deploymentCount').textContent = (categories.deployment || []).length
        }

        function updateCategoriesNav(categories) {
            const container = document.getElementById('categoriesNav')
            container.innerHTML = ''
            
            Object.entries(categories).forEach(([category, docs]) => {
                const categoryButton = document.createElement('button')
                categoryButton.className = `w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 transition-all category-${category} text-sm`
                categoryButton.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="capitalize">${category}</span>
                        <span class="text-xs">${docs.length}</span>
                    </div>
                `
                categoryButton.onclick = () => filterByCategory(category)
                container.appendChild(categoryButton)
            })
        }

        function filterByCategory(category) {
            const filtered = allDocuments.filter(doc => doc.category === category)
            displayDocuments(filtered)
            document.getElementById('categoryFilter').value = category
        }

        async function searchDocumentation() {
            try {
                const query = document.getElementById('searchInput').value
                const category = document.getElementById('categoryFilter').value
                
                if (!query && !category) {
                    displayDocuments(allDocuments)
                    return
                }
                
                const params = new URLSearchParams()
                if (query) params.append('q', query)
                if (category) params.append('category', category)
                
                const response = await axios.get(`/api/docs/search?${params}`)
                
                if (response.data.success) {
                    displayDocuments(response.data.results)
                }
            } catch (error) {
                console.error('Errore ricerca:', error)
                showStatusModal('<i class="fas fa-times-circle"></i>', 'Errore', 'Errore nella ricerca', false)
            }
        }

        function showEditor(section = null) {
            currentEditingSection = section
            
            if (section) {
                document.getElementById('editorTitle').textContent = `Modifica: ${section.title}`
                document.getElementById('docTitle').value = section.title
                document.getElementById('docCategory').value = section.category
                document.getElementById('docContent').value = section.content
                document.getElementById('docTags').value = section.tags ? section.tags.join(', ') : ''
            } else {
                document.getElementById('editorTitle').textContent = 'Nuova Sezione'
                document.getElementById('docForm').reset()
            }
            
            document.getElementById('editorPanel').classList.remove('hidden')
            document.getElementById('docsList').classList.add('hidden')
        }

        function hideEditor() {
            document.getElementById('editorPanel').classList.add('hidden')
            document.getElementById('docsList').classList.remove('hidden')
            currentEditingSection = null
            document.getElementById('docForm').reset()
        }

        function editSection(section) {
            showEditor(section)
        }

        async function saveSection() {
            try {
                const title = document.getElementById('docTitle').value
                const category = document.getElementById('docCategory').value
                const content = document.getElementById('docContent').value
                const tagsInput = document.getElementById('docTags').value
                const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag) : []
                
                if (!title || !category || !content) {
                    showStatusModal('<i class="fas fa-exclamation-triangle"></i>', 'Attenzione', 'Compila tutti i campi obbligatori', false)
                    return
                }
                
                const sectionData = {
                    title,
                    category,
                    content,
                    tags,
                    author: 'admin',
                    version: '1.0.0'
                }
                
                let response
                if (currentEditingSection) {
                    // Update existing section
                    response = await axios.put(`/api/docs/sections/${currentEditingSection.id}`, sectionData)
                } else {
                    // Create new section
                    response = await axios.post('/api/docs/sections', sectionData)
                }
                
                if (response.data.success) {
                    showStatusModal('<i class="fas fa-check-circle"></i>', 'Successo!', 
                        currentEditingSection ? 'Sezione aggiornata con successo' : 'Sezione creata con successo')
                    hideEditor()
                    await loadDocumentation()
                } else {
                    showStatusModal('<i class="fas fa-times-circle"></i>', 'Errore', response.data.error || 'Errore nel salvataggio', false)
                }
            } catch (error) {
                console.error('Errore salvataggio:', error)
                showStatusModal('<i class="fas fa-times-circle"></i>', 'Errore', 'Errore di connessione al server', false)
            }
        }

        async function initializeDocumentation() {
            try {
                showStatusModal('<i class="fas fa-spinner fa-spin"></i>', 'Inizializzazione...', 'Inizializzando documentazione TeleMedCare...')
                
                const response = await axios.post('/api/docs/initialize')
                
                if (response.data.success) {
                    showStatusModal('<i class="fas fa-check-circle"></i>', 'Successo!', 'Documentazione inizializzata con successo')
                    await loadDocumentation()
                } else {
                    showStatusModal('<i class="fas fa-times-circle"></i>', 'Errore', response.data.error || 'Errore nell\'inizializzazione', false)
                }
            } catch (error) {
                console.error('Errore inizializzazione:', error)
                showStatusModal('<i class="fas fa-times-circle"></i>', 'Errore', 'Errore di connessione al server', false)
            }
        }

        async function generateDocumentation() {
            try {
                showStatusModal('<i class="fas fa-spinner fa-spin"></i>', 'Generazione...', 'Generando documentazione automatica...')
                
                const response = await axios.post('/api/docs/generate')
                
                if (response.data.success) {
                    showStatusModal('<i class="fas fa-check-circle"></i>', 'Successo!', `Generate ${response.data.createdSections.length} sezioni automatiche`)
                    await loadDocumentation()
                } else {
                    showStatusModal('<i class="fas fa-times-circle"></i>', 'Errore', response.data.error || 'Errore nella generazione', false)
                }
            } catch (error) {
                console.error('Errore generazione:', error)
                showStatusModal('<i class="fas fa-times-circle"></i>', 'Errore', 'Errore di connessione al server', false)
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Search
            document.getElementById('searchBtn').addEventListener('click', searchDocumentation)
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchDocumentation()
            })
            document.getElementById('categoryFilter').addEventListener('change', searchDocumentation)
            
            // Actions
            document.getElementById('newSectionBtn').addEventListener('click', () => showEditor())
            document.getElementById('initDocsBtn').addEventListener('click', initializeDocumentation)
            document.getElementById('generateDocsBtn').addEventListener('click', generateDocumentation)
            document.getElementById('refreshDocsBtn').addEventListener('click', loadDocumentation)
            
            // Editor
            document.getElementById('saveBtn').addEventListener('click', saveSection)
            document.getElementById('cancelBtn').addEventListener('click', hideEditor)
            
            // Load documentation on start
            loadDocumentation()
        })
    </script>
</body>
</html>