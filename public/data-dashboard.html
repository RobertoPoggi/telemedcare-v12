<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="build-id" content="20260215-1012">
    <title>Data Dashboard - TeleMedCare V12.0</title>
    <!-- Build: 2026-02-15 10:12 - Filtri + Fix Conteggi Servizi -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-database text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Data Dashboard</h1>
                        <p class="text-blue-100">Centro dati completo con analytics e KPI aziendali</p>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <a href="/" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-home mr-2"></i>Home
                    </a>
                    <a href="/dashboard" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-chart-line mr-2"></i>Dashboard
                    </a>
                    <a href="/admin/leads-dashboard" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-users mr-2"></i>Leads
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- KPI Principali -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Lead Totali</p>
                        <p class="text-3xl font-bold text-blue-600" id="kpiLeads">-</p>
                    </div>
                    <i class="fas fa-users text-3xl text-blue-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Contratti</p>
                        <p class="text-3xl font-bold text-green-600" id="kpiContracts">-</p>
                    </div>
                    <i class="fas fa-file-contract text-3xl text-green-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Revenue YTD</p>
                        <p class="text-2xl font-bold text-purple-600" id="kpiRevenue">-</p>
                    </div>
                    <i class="fas fa-euro-sign text-3xl text-purple-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-orange-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">Conv. Rate</p>
                        <p class="text-3xl font-bold text-orange-600" id="kpiConversion">-</p>
                    </div>
                    <i class="fas fa-percentage text-3xl text-orange-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-red-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm mb-1">AOV</p>
                        <p class="text-2xl font-bold text-red-600" id="kpiAov">-</p>
                    </div>
                    <i class="fas fa-chart-line text-3xl text-red-500"></i>
                </div>
            </div>
        </div>

        <!-- Metriche Servizi -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-chart-bar text-blue-500 mr-2"></i>
                Performance per Servizio
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- FAMILY -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold text-blue-600">eCura FAMILY</h4>
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">SiDLY CARE PRO</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Lead:</span>
                            <span class="font-bold" id="familyLeads">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Contratti:</span>
                            <span class="font-bold" id="familyContracts">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Revenue:</span>
                            <span class="font-bold text-green-600" id="familyRevenue">-</span>
                        </div>
                        <div class="pt-2 border-t">
                            <div class="text-xs text-gray-500 mb-1">BASE vs AVANZATO</div>
                            <div class="flex gap-2">
                                <div class="flex-1 bg-blue-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">BASE</div>
                                    <div class="font-bold text-sm" id="familyBase">-</div>
                                </div>
                                <div class="flex-1 bg-purple-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">AVANZ.</div>
                                    <div class="font-bold text-sm" id="familyAvanzato">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PRO -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold text-purple-600">eCura PRO</h4>
                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">SiDLY CARE PRO</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Lead:</span>
                            <span class="font-bold" id="proLeads">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Contratti:</span>
                            <span class="font-bold" id="proContracts">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Revenue:</span>
                            <span class="font-bold text-green-600" id="proRevenue">-</span>
                        </div>
                        <div class="pt-2 border-t">
                            <div class="text-xs text-gray-500 mb-1">BASE vs AVANZATO</div>
                            <div class="flex gap-2">
                                <div class="flex-1 bg-blue-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">BASE</div>
                                    <div class="font-bold text-sm" id="proBase">-</div>
                                </div>
                                <div class="flex-1 bg-purple-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">AVANZ.</div>
                                    <div class="font-bold text-sm" id="proAvanzato">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PREMIUM -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold text-green-600">eCura PREMIUM</h4>
                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">SiDLY VITAL CARE</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Lead:</span>
                            <span class="font-bold" id="premiumLeads">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Contratti:</span>
                            <span class="font-bold" id="premiumContracts">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Revenue:</span>
                            <span class="font-bold text-green-600" id="premiumRevenue">-</span>
                        </div>
                        <div class="pt-2 border-t">
                            <div class="text-xs text-gray-500 mb-1">BASE vs AVANZATO</div>
                            <div class="flex gap-2">
                                <div class="flex-1 bg-blue-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">BASE</div>
                                    <div class="font-bold text-sm" id="premiumBase">-</div>
                                </div>
                                <div class="flex-1 bg-purple-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">AVANZ.</div>
                                    <div class="font-bold text-sm" id="premiumAvanzato">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contratti Recenti -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-file-contract text-green-500 mr-2"></i>
                Contratti
            </h3>
            
            <!-- Filtri Contratti -->
            <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">
                        <i class="fas fa-calendar mr-1"></i> Data Scadenza
                    </label>
                    <select id="filterScadenza" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Tutte</option>
                        <option value="expired">Scaduti</option>
                        <option value="30">Prossimi 30 giorni</option>
                        <option value="60">Prossimi 60 giorni</option>
                        <option value="90">Prossimi 90 giorni</option>
                        <option value="180">Prossimi 6 mesi</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">
                        <i class="fas fa-user mr-1"></i> Cognome Cliente
                    </label>
                    <input 
                        type="text" 
                        id="filterCognome" 
                        placeholder="Cerca per cognome..."
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">
                        <i class="fas fa-check-circle mr-1"></i> Stato
                    </label>
                    <select id="filterStato" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Tutti</option>
                        <option value="SIGNED">Firmato</option>
                        <option value="SENT">Inviato</option>
                        <option value="DRAFT">Bozza</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">
                        <i class="fas fa-mobile-alt mr-1"></i> Dispositivo
                    </label>
                    <select id="filterDispositivo" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Tutti</option>
                        <option value="SIDLY VITAL CARE">SiDLY VITAL CARE</option>
                        <option value="SIDLY CARE PRO">SiDLY CARE PRO</option>
                    </select>
                </div>
            </div>

            <!-- Contatore risultati e reset filtri -->
            <div class="mb-4 flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    <span id="contractsCount">0</span> contratti trovati
                </div>
                <button 
                    id="resetFilters" 
                    class="text-sm text-blue-600 hover:text-blue-800 font-medium"
                    onclick="resetContractFilters()"
                >
                    <i class="fas fa-redo mr-1"></i> Reset Filtri
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-200 text-left">
                            <th class="pb-3 text-sm font-semibold text-gray-600">Codice</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Cliente</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Servizio</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Piano</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Dispositivo</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Valore</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Status</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Data</th>
                            <th class="pb-3 text-sm font-semibold text-gray-600">Scadenza</th>
                        </tr>
                    </thead>
                    <tbody id="contractsTable">
                        <tr>
                            <td colspan="9" class="py-8 text-center text-gray-400">
                                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                <p>Caricamento contratti...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Helper function to escape HTML special characters
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        loadDataDashboard();

        async function loadDataDashboard() {
            try {
                // Carica statistiche generali
                const statsResponse = await fetch('/api/data/stats');
                const stats = await statsResponse.json();

                document.getElementById('kpiLeads').textContent = stats.totalLeads || '0';
                document.getElementById('kpiContracts').textContent = stats.totalContracts || '0';
                document.getElementById('kpiRevenue').textContent = stats.totalRevenue ? `€${stats.totalRevenue}` : '€0';
                document.getElementById('kpiConversion').textContent = stats.conversionRate || '0%';
                document.getElementById('kpiAov').textContent = stats.averageOrderValue ? `€${stats.averageOrderValue}` : '€0';

                // Carica lead per servizio
                const leadsResponse = await fetch('/api/leads?limit=200');
                const leadsData = await leadsResponse.json();
                const leads = leadsData.leads || [];

                // Analizza per servizio
                const serviceData = analyzeByService(leads);
                updateServiceMetrics(serviceData);

                // Carica contratti
                const contractsResponse = await fetch('/api/contratti?limit=200');
                const contractsData = await contractsResponse.json();
                const contracts = contractsData.contratti || [];
                
                // Salva i contratti globalmente per i filtri
                window.allContracts = contracts;
                
                renderContractsTable(contracts);
                
                // Aggiungi event listeners per i filtri
                document.getElementById('filterScadenza').addEventListener('change', applyContractFilters);
                document.getElementById('filterCognome').addEventListener('input', applyContractFilters);
                document.getElementById('filterStato').addEventListener('change', applyContractFilters);
                document.getElementById('filterDispositivo').addEventListener('change', applyContractFilters);

            } catch (error) {
                console.error('Errore caricamento data dashboard:', error);
            }
        }

        function applyContractFilters() {
            const filters = {
                scadenza: document.getElementById('filterScadenza').value,
                cognome: document.getElementById('filterCognome').value.toLowerCase().trim(),
                stato: document.getElementById('filterStato').value,
                dispositivo: document.getElementById('filterDispositivo').value
            };

            let filtered = window.allContracts || [];

            // Filtro cognome
            if (filters.cognome) {
                filtered = filtered.filter(c => 
                    (c.cliente_cognome || '').toLowerCase().includes(filters.cognome)
                );
            }

            // Filtro stato
            if (filters.stato) {
                filtered = filtered.filter(c => c.status === filters.stato);
            }

            // Filtro dispositivo
            if (filters.dispositivo) {
                filtered = filtered.filter(c => {
                    const dispositivo = getDispositivoForService(c.servizio || c.tipo_servizio);
                    return dispositivo.includes(filters.dispositivo);
                });
            }

            // Filtro data scadenza
            if (filters.scadenza) {
                const today = new Date();
                filtered = filtered.filter(c => {
                    if (!c.data_scadenza) return false;
                    
                    const scadenza = new Date(c.data_scadenza);
                    const diffTime = scadenza - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (filters.scadenza === 'expired') {
                        return diffDays < 0;
                    } else {
                        const days = parseInt(filters.scadenza);
                        return diffDays >= 0 && diffDays <= days;
                    }
                });
            }

            renderContractsTable(filtered);
        }

        function resetContractFilters() {
            document.getElementById('filterScadenza').value = '';
            document.getElementById('filterCognome').value = '';
            document.getElementById('filterStato').value = '';
            document.getElementById('filterDispositivo').value = '';
            renderContractsTable(window.allContracts || []);
        }

        function analyzeByService(leads) {
            const data = {
                FAMILY: { leads: 0, base: 0, avanzato: 0, revenue: 0 },
                PRO: { leads: 0, base: 0, avanzato: 0, revenue: 0 },
                PREMIUM: { leads: 0, base: 0, avanzato: 0, revenue: 0 }
            };

            const prezzi = {
                'FAMILY': { 'BASE': 390, 'AVANZATO': 690 },
                'PRO': { 'BASE': 480, 'AVANZATO': 840 },
                'PREMIUM': { 'BASE': 590, 'AVANZATO': 990 }
            };

            // Funzione per normalizzare il nome del servizio
            function normalizeServizio(servizio) {
                if (!servizio) return null;
                const s = servizio.toUpperCase();
                if (s.includes('FAMILY')) return 'FAMILY';
                if (s.includes('PRO') && !s.includes('PREMIUM')) return 'PRO';
                if (s.includes('PREMIUM')) return 'PREMIUM';
                return null;
            }

            leads.forEach(lead => {
                const servizioNormalized = normalizeServizio(lead.servizio);
                const piano = lead.pacchetto || 'BASE';
                
                if (servizioNormalized && data[servizioNormalized]) {
                    data[servizioNormalized].leads++;
                    
                    if (piano === 'BASE') {
                        data[servizioNormalized].base++;
                    } else {
                        data[servizioNormalized].avanzato++;
                    }

                    if (lead.contratto_inviato && prezzi[servizioNormalized]?.[piano]) {
                        data[servizioNormalized].revenue += prezzi[servizioNormalized][piano];
                    }
                }
            });

            return data;
        }

        function updateServiceMetrics(data) {
            // FAMILY
            document.getElementById('familyLeads').textContent = data.FAMILY.leads;
            document.getElementById('familyContracts').textContent = data.FAMILY.base + data.FAMILY.avanzato;
            document.getElementById('familyRevenue').textContent = `€${data.FAMILY.revenue.toFixed(0)}`;
            document.getElementById('familyBase').textContent = data.FAMILY.base;
            document.getElementById('familyAvanzato').textContent = data.FAMILY.avanzato;

            // PRO
            document.getElementById('proLeads').textContent = data.PRO.leads;
            document.getElementById('proContracts').textContent = data.PRO.base + data.PRO.avanzato;
            document.getElementById('proRevenue').textContent = `€${data.PRO.revenue.toFixed(0)}`;
            document.getElementById('proBase').textContent = data.PRO.base;
            document.getElementById('proAvanzato').textContent = data.PRO.avanzato;

            // PREMIUM
            document.getElementById('premiumLeads').textContent = data.PREMIUM.leads;
            document.getElementById('premiumContracts').textContent = data.PREMIUM.base + data.PREMIUM.avanzato;
            document.getElementById('premiumRevenue').textContent = `€${data.PREMIUM.revenue.toFixed(0)}`;
            document.getElementById('premiumBase').textContent = data.PREMIUM.base;
            document.getElementById('premiumAvanzato').textContent = data.PREMIUM.avanzato;
        }

        function renderContractsTable(contracts) {
            const tbody = document.getElementById('contractsTable');
            const countElement = document.getElementById('contractsCount');
            
            // Aggiorna contatore
            countElement.textContent = contracts.length;
            
            if (contracts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="py-8 text-center text-gray-400">Nessun contratto trovato</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = contracts.map(contract => {
                const dispositivo = getDispositivoForService(contract.servizio || contract.tipo_servizio);
                const date = new Date(contract.created_at).toLocaleDateString('it-IT');
                
                // Data scadenza con evidenziazione
                let scadenzaHtml = '<span class="text-gray-400 text-xs">N/A</span>';
                if (contract.data_scadenza) {
                    const scadenza = new Date(contract.data_scadenza);
                    const today = new Date();
                    const diffTime = scadenza - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    let colorClass = 'text-gray-600';
                    let icon = '';
                    
                    if (diffDays < 0) {
                        colorClass = 'text-red-600 font-bold';
                        icon = '<i class="fas fa-exclamation-triangle mr-1"></i>';
                    } else if (diffDays <= 30) {
                        colorClass = 'text-orange-600 font-semibold';
                        icon = '<i class="fas fa-clock mr-1"></i>';
                    } else if (diffDays <= 90) {
                        colorClass = 'text-yellow-600';
                        icon = '<i class="fas fa-calendar-check mr-1"></i>';
                    }
                    
                    scadenzaHtml = `<span class="${colorClass} text-xs">${icon}${scadenza.toLocaleDateString('it-IT')}</span>`;
                }
                
                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 text-xs">
                            <code class="bg-gray-100 px-2 py-1 rounded">${contract.codice_contratto || contract.id}</code>
                        </td>
                        <td class="py-3 text-sm font-medium">
                            ${escapeHtml(contract.cliente_nome)} ${escapeHtml(contract.cliente_cognome)}
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded font-medium">
                                ${contract.servizio || contract.tipo_servizio || 'N/A'}
                            </span>
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded font-medium">
                                ${contract.piano || 'N/A'}
                            </span>
                        </td>
                        <td class="py-3 text-sm text-gray-600">${dispositivo}</td>
                        <td class="py-3 text-sm font-bold text-green-600">
                            €${parseFloat(contract.prezzo_totale || 0).toFixed(2)}
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded font-medium">
                                ${contract.status || 'SENT'}
                            </span>
                        </td>
                        <td class="py-3 text-xs text-gray-500">${date}</td>
                        <td class="py-3">${scadenzaHtml}</td>
                    </tr>
                `;
            }).join('');
        }

        function getDispositivoForService(servizio) {
            const dispositivi = {
                'FAMILY': 'SiDLY CARE PRO',
                'PRO': 'SiDLY CARE PRO',
                'PREMIUM': 'SiDLY VITAL CARE'
            };
            return dispositivi[servizio] || 'N/A';
        }
    </script>
</body>
</html>
