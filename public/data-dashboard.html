<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="build-id" content="20260215-1046">
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="eCura Dashboard">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="eCura">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#3b82f6">
    
    <!-- Icons -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png">
    
    <title>Data Dashboard - TeleMedCare V12.0</title>
    <!-- Build: 2026-02-15 22:46 - PWA Icons + Mobile Responsive + Assistiti -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-database text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Data Dashboard</h1>
                        <p class="text-blue-100">Centro dati completo con analytics e KPI aziendali</p>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <a href="/" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-home mr-2"></i>Home
                    </a>
                    <a href="/dashboard" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-chart-line mr-2"></i>Dashboard
                    </a>
                    <a href="/admin/leads-dashboard" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-users mr-2"></i>Leads
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- KPI Principali -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 md:gap-6 mb-6 md:mb-8">
            <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm card-hover border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-xs md:text-sm mb-1">Lead Totali</p>
                        <p class="text-2xl md:text-3xl font-bold text-blue-600" id="kpiLeads">-</p>
                    </div>
                    <i class="fas fa-users text-2xl md:text-3xl text-blue-500"></i>
                </div>
            </div>

            <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm card-hover border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-xs md:text-sm mb-1">Contratti</p>
                        <p class="text-2xl md:text-3xl font-bold text-green-600" id="kpiContracts">-</p>
                    </div>
                    <i class="fas fa-file-contract text-2xl md:text-3xl text-green-500"></i>
                </div>
            </div>

            <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm card-hover border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-xs md:text-sm mb-1">Revenue YTD</p>
                        <p class="text-xl md:text-2xl font-bold text-purple-600" id="kpiRevenue">-</p>
                    </div>
                    <i class="fas fa-euro-sign text-2xl md:text-3xl text-purple-500"></i>
                </div>
            </div>

            <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm card-hover border-l-4 border-orange-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-xs md:text-sm mb-1">Conv. Rate</p>
                        <p class="text-2xl md:text-3xl font-bold text-orange-600" id="kpiConversion">-</p>
                    </div>
                    <i class="fas fa-percentage text-2xl md:text-3xl text-orange-500"></i>
                </div>
            </div>

            <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm card-hover border-l-4 border-red-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-xs md:text-sm mb-1">AOV</p>
                        <p class="text-xl md:text-2xl font-bold text-red-600" id="kpiAov">-</p>
                    </div>
                    <i class="fas fa-chart-line text-2xl md:text-3xl text-red-500"></i>
                </div>
            </div>
        </div>

        <!-- Metriche Servizi -->
        <div class="bg-white rounded-xl shadow-sm p-4 md:p-6 mb-6 md:mb-8">
            <h3 class="text-base md:text-lg font-bold text-gray-800 mb-4 md:mb-6 flex items-center">
                <i class="fas fa-chart-bar text-blue-500 mr-2"></i>
                Performance per Servizio
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                <!-- FAMILY -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold text-blue-600">eCura FAMILY</h4>
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">SiDLY CARE PRO</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Lead:</span>
                            <span class="font-bold" id="familyLeads">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Contratti:</span>
                            <span class="font-bold" id="familyContracts">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Revenue:</span>
                            <span class="font-bold text-green-600" id="familyRevenue">-</span>
                        </div>
                        <div class="pt-2 border-t">
                            <div class="text-xs text-gray-500 mb-1">BASE vs AVANZATO</div>
                            <div class="flex gap-2">
                                <div class="flex-1 bg-blue-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">BASE</div>
                                    <div class="font-bold text-sm" id="familyBase">-</div>
                                </div>
                                <div class="flex-1 bg-purple-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">AVANZ.</div>
                                    <div class="font-bold text-sm" id="familyAvanzato">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PRO -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold text-purple-600">eCura PRO</h4>
                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">SiDLY CARE PRO</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Lead:</span>
                            <span class="font-bold" id="proLeads">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Contratti:</span>
                            <span class="font-bold" id="proContracts">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Revenue:</span>
                            <span class="font-bold text-green-600" id="proRevenue">-</span>
                        </div>
                        <div class="pt-2 border-t">
                            <div class="text-xs text-gray-500 mb-1">BASE vs AVANZATO</div>
                            <div class="flex gap-2">
                                <div class="flex-1 bg-blue-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">BASE</div>
                                    <div class="font-bold text-sm" id="proBase">-</div>
                                </div>
                                <div class="flex-1 bg-purple-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">AVANZ.</div>
                                    <div class="font-bold text-sm" id="proAvanzato">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PREMIUM -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold text-green-600">eCura PREMIUM</h4>
                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">SiDLY VITAL CARE</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Lead:</span>
                            <span class="font-bold" id="premiumLeads">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Contratti:</span>
                            <span class="font-bold" id="premiumContracts">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Revenue:</span>
                            <span class="font-bold text-green-600" id="premiumRevenue">-</span>
                        </div>
                        <div class="pt-2 border-t">
                            <div class="text-xs text-gray-500 mb-1">BASE vs AVANZATO</div>
                            <div class="flex gap-2">
                                <div class="flex-1 bg-blue-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">BASE</div>
                                    <div class="font-bold text-sm" id="premiumBase">-</div>
                                </div>
                                <div class="flex-1 bg-purple-100 rounded px-2 py-1 text-center">
                                    <div class="text-xs text-gray-600">AVANZ.</div>
                                    <div class="font-bold text-sm" id="premiumAvanzato">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contratti Recenti -->
        <div class="bg-white rounded-xl shadow-sm p-4 md:p-6">
            <h3 class="text-base md:text-lg font-bold text-gray-800 mb-4 md:mb-6 flex items-center">
                <i class="fas fa-file-contract text-green-500 mr-2"></i>
                Contratti
            </h3>
            
            <!-- Filtri Contratti -->
            <div class="mb-4 md:mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">
                        <i class="fas fa-calendar mr-1"></i> Data Scadenza
                    </label>
                    <select id="filterScadenza" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Tutte</option>
                        <option value="expired">Scaduti</option>
                        <option value="30">Prossimi 30 giorni</option>
                        <option value="60">Prossimi 60 giorni</option>
                        <option value="90">Prossimi 90 giorni</option>
                        <option value="180">Prossimi 6 mesi</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">
                        <i class="fas fa-user mr-1"></i> Cognome Cliente
                    </label>
                    <input 
                        type="text" 
                        id="filterCognome" 
                        placeholder="Cerca per cognome..."
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">
                        <i class="fas fa-check-circle mr-1"></i> Stato
                    </label>
                    <select id="filterStato" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Tutti</option>
                        <option value="SIGNED">Firmato</option>
                        <option value="SENT">Inviato</option>
                        <option value="DRAFT">Bozza</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">
                        <i class="fas fa-mobile-alt mr-1"></i> Dispositivo
                    </label>
                    <select id="filterDispositivo" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Tutti</option>
                        <option value="SIDLY VITAL CARE">SiDLY VITAL CARE</option>
                        <option value="SIDLY CARE PRO">SiDLY CARE PRO</option>
                    </select>
                </div>
            </div>

            <!-- Contatore risultati e reset filtri -->
            <div class="mb-4 flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    <span id="contractsCount">0</span> contratti trovati
                </div>
                <button 
                    id="resetFilters" 
                    class="text-sm text-blue-600 hover:text-blue-800 font-medium"
                    onclick="resetContractFilters()"
                >
                    <i class="fas fa-redo mr-1"></i> Reset Filtri
                </button>
            </div>

            <div class="overflow-x-auto -mx-4 md:mx-0">
                <table class="w-full min-w-[800px]">
                    <thead>
                        <tr class="border-b-2 border-gray-200 text-left">
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Codice</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Cliente</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Servizio</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Piano</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Dispositivo</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Valore</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Status</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Data</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Scadenza</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="contractsTable">
                        <tr>
                            <td colspan="10" class="py-8 text-center text-gray-400">
                                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                <p>Caricamento contratti...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tabella Proforma -->
        <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm mb-6 md:mb-8">
            <div class="flex items-center justify-between mb-4 md:mb-6">
                <h2 class="text-lg md:text-xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-file-invoice text-purple-500 mr-2 md:mr-3"></i>
                    Proforma (<span id="proformaCount">0</span>)
                </h2>
                <div class="flex space-x-2">
                    <select id="filterProformaStatus" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500" onchange="applyProformaFilters()">
                        <option value="">Tutti gli Status</option>
                        <option value="DRAFT">DRAFT</option>
                        <option value="SENT">SENT</option>
                        <option value="PAID">PAID</option>
                        <option value="EXPIRED">EXPIRED</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="border-b-2 border-gray-200 text-left">
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Numero</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Cliente</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Servizio</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Importo</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Status</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Emissione</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Scadenza</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="proformaTable">
                        <tr>
                            <td colspan="8" class="py-8 text-center text-gray-400">
                                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                <p>Caricamento proforma...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tabella Pagamenti -->
        <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm mb-6 md:mb-8">
            <div class="flex items-center justify-between mb-4 md:mb-6">
                <h2 class="text-lg md:text-xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-credit-card text-green-500 mr-2 md:mr-3"></i>
                    Pagamenti (<span id="paymentsCount">0</span>)
                </h2>
                <div class="flex space-x-2">
                    <select id="filterPaymentMethod" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500" onchange="applyPaymentFilters()">
                        <option value="">Tutti i Metodi</option>
                        <option value="STRIPE_CARD">Carta</option>
                        <option value="STRIPE_SEPA">SEPA</option>
                        <option value="BONIFICO">Bonifico</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="border-b-2 border-gray-200 text-left">
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">ID Pagamento</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Proforma</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Importo</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Metodo</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Status</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Transaction ID</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Data</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTable">
                        <tr>
                            <td colspan="7" class="py-8 text-center text-gray-400">
                                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                <p>Caricamento pagamenti...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tabella DDT -->
        <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm mb-6 md:mb-8">
            <div class="flex items-center justify-between mb-4 md:mb-6">
                <h2 class="text-lg md:text-xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-truck text-orange-500 mr-2 md:mr-3"></i>
                    DDT - Documenti di Trasporto (<span id="ddtCount">0</span>)
                </h2>
                <div class="flex space-x-2">
                    <select id="filterDdtStatus" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500" onchange="applyDdtFilters()">
                        <option value="">Tutti gli Status</option>
                        <option value="preparazione">In Preparazione</option>
                        <option value="spedito">Spedito</option>
                        <option value="in_transito">In Transito</option>
                        <option value="consegnato">Consegnato</option>
                        <option value="anomalia">Anomalia</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="border-b-2 border-gray-200 text-left">
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Numero DDT</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Destinatario</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Dispositivo</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Seriale</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Corriere</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Tracking</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Status</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Data</th>
                            <th class="pb-3 px-2 text-xs md:text-sm font-semibold text-gray-600">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="ddtTable">
                        <tr>
                            <td colspan="9" class="py-8 text-center text-gray-400">
                                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                <p>Caricamento DDT...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Helper function to escape HTML special characters
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        loadDataDashboard();

        async function loadDataDashboard() {
            try {
                // Carica statistiche generali
                const statsResponse = await fetch('/api/data/stats');
                const stats = await statsResponse.json();

                document.getElementById('kpiLeads').textContent = stats.totalLeads || '0';
                document.getElementById('kpiContracts').textContent = stats.totalContracts || '0';
                document.getElementById('kpiRevenue').textContent = stats.totalRevenue ? `€${stats.totalRevenue}` : '€0';
                document.getElementById('kpiConversion').textContent = stats.conversionRate || '0%';
                document.getElementById('kpiAov').textContent = stats.averageOrderValue ? `€${stats.averageOrderValue}` : '€0';

                // Carica lead per servizio
                const leadsResponse = await fetch('/api/leads?limit=200');
                const leadsData = await leadsResponse.json();
                const leads = leadsData.leads || [];

                // Analizza per servizio
                const serviceData = analyzeByService(leads);
                updateServiceMetrics(serviceData);

                // Carica contratti
                const contractsResponse = await fetch('/api/contratti?limit=200');
                const contractsData = await contractsResponse.json();
                const contracts = contractsData.contratti || [];
                
                // Salva i contratti globalmente per i filtri
                window.allContracts = contracts;
                
                renderContractsTable(contracts);
                
                // Aggiungi event listeners per i filtri
                document.getElementById('filterScadenza').addEventListener('change', applyContractFilters);
                document.getElementById('filterCognome').addEventListener('input', applyContractFilters);
                document.getElementById('filterStato').addEventListener('change', applyContractFilters);
                document.getElementById('filterDispositivo').addEventListener('change', applyContractFilters);

                // Carica proforma
                const proformaResponse = await fetch('/api/proforma');
                const proformaData = await proformaResponse.json();
                const proformas = proformaData.proforma || proformaData.proformas || [];
                window.allProformas = proformas;
                renderProformaTable(proformas);

                // Carica pagamenti
                const paymentsResponse = await fetch('/api/payments');
                const paymentsData = await paymentsResponse.json();
                const payments = paymentsData.payments || [];
                window.allPayments = payments;
                renderPaymentsTable(payments);

                // Carica DDT
                const ddtResponse = await fetch('/api/ddts');
                const ddtData = await ddtResponse.json();
                const ddts = ddtData.ddts || [];
                window.allDdts = ddts;
                renderDdtTable(ddts);

            } catch (error) {
                console.error('Errore caricamento data dashboard:', error);
            }
        }

        function applyContractFilters() {
            const filters = {
                scadenza: document.getElementById('filterScadenza').value,
                cognome: document.getElementById('filterCognome').value.toLowerCase().trim(),
                stato: document.getElementById('filterStato').value,
                dispositivo: document.getElementById('filterDispositivo').value
            };

            let filtered = window.allContracts || [];

            // Filtro cognome
            if (filters.cognome) {
                filtered = filtered.filter(c => 
                    (c.cliente_cognome || '').toLowerCase().includes(filters.cognome)
                );
            }

            // Filtro stato
            if (filters.stato) {
                filtered = filtered.filter(c => c.status === filters.stato);
            }

            // Filtro dispositivo
            if (filters.dispositivo) {
                filtered = filtered.filter(c => {
                    const dispositivo = getDispositivoForService(c.servizio || c.tipo_servizio);
                    return dispositivo.includes(filters.dispositivo);
                });
            }

            // Filtro data scadenza
            if (filters.scadenza) {
                const today = new Date();
                filtered = filtered.filter(c => {
                    if (!c.data_scadenza) return false;
                    
                    const scadenza = new Date(c.data_scadenza);
                    const diffTime = scadenza - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (filters.scadenza === 'expired') {
                        return diffDays < 0;
                    } else {
                        const days = parseInt(filters.scadenza);
                        return diffDays >= 0 && diffDays <= days;
                    }
                });
            }

            renderContractsTable(filtered);
        }

        function resetContractFilters() {
            document.getElementById('filterScadenza').value = '';
            document.getElementById('filterCognome').value = '';
            document.getElementById('filterStato').value = '';
            document.getElementById('filterDispositivo').value = '';
            renderContractsTable(window.allContracts || []);
        }

        function analyzeByService(leads) {
            const data = {
                FAMILY: { leads: 0, base: 0, avanzato: 0, revenue: 0 },
                PRO: { leads: 0, base: 0, avanzato: 0, revenue: 0 },
                PREMIUM: { leads: 0, base: 0, avanzato: 0, revenue: 0 }
            };

            const prezzi = {
                'FAMILY': { 'BASE': 390, 'AVANZATO': 690 },
                'PRO': { 'BASE': 480, 'AVANZATO': 840 },
                'PREMIUM': { 'BASE': 590, 'AVANZATO': 990 }
            };

            // Funzione per normalizzare il nome del servizio
            function normalizeServizio(servizio) {
                if (!servizio) return null;
                const s = servizio.toUpperCase();
                if (s.includes('FAMILY')) return 'FAMILY';
                if (s.includes('PRO') && !s.includes('PREMIUM')) return 'PRO';
                if (s.includes('PREMIUM')) return 'PREMIUM';
                return null;
            }

            leads.forEach(lead => {
                const servizioNormalized = normalizeServizio(lead.servizio);
                const piano = lead.pacchetto || 'BASE';
                
                if (servizioNormalized && data[servizioNormalized]) {
                    data[servizioNormalized].leads++;
                    
                    if (piano === 'BASE') {
                        data[servizioNormalized].base++;
                    } else {
                        data[servizioNormalized].avanzato++;
                    }

                    if (lead.contratto_inviato && prezzi[servizioNormalized]?.[piano]) {
                        data[servizioNormalized].revenue += prezzi[servizioNormalized][piano];
                    }
                }
            });

            return data;
        }

        function updateServiceMetrics(data) {
            // FAMILY
            document.getElementById('familyLeads').textContent = data.FAMILY.leads;
            document.getElementById('familyContracts').textContent = data.FAMILY.base + data.FAMILY.avanzato;
            document.getElementById('familyRevenue').textContent = `€${data.FAMILY.revenue.toFixed(0)}`;
            document.getElementById('familyBase').textContent = data.FAMILY.base;
            document.getElementById('familyAvanzato').textContent = data.FAMILY.avanzato;

            // PRO
            document.getElementById('proLeads').textContent = data.PRO.leads;
            document.getElementById('proContracts').textContent = data.PRO.base + data.PRO.avanzato;
            document.getElementById('proRevenue').textContent = `€${data.PRO.revenue.toFixed(0)}`;
            document.getElementById('proBase').textContent = data.PRO.base;
            document.getElementById('proAvanzato').textContent = data.PRO.avanzato;

            // PREMIUM
            document.getElementById('premiumLeads').textContent = data.PREMIUM.leads;
            document.getElementById('premiumContracts').textContent = data.PREMIUM.base + data.PREMIUM.avanzato;
            document.getElementById('premiumRevenue').textContent = `€${data.PREMIUM.revenue.toFixed(0)}`;
            document.getElementById('premiumBase').textContent = data.PREMIUM.base;
            document.getElementById('premiumAvanzato').textContent = data.PREMIUM.avanzato;
        }

        function renderContractsTable(contracts) {
            const tbody = document.getElementById('contractsTable');
            const countElement = document.getElementById('contractsCount');
            
            // Aggiorna contatore
            countElement.textContent = contracts.length;
            
            if (contracts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="py-8 text-center text-gray-400">Nessun contratto trovato</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = contracts.map(contract => {
                const dispositivo = getDispositivoForService(contract.servizio || contract.tipo_servizio);
                const date = new Date(contract.created_at).toLocaleDateString('it-IT');
                
                // Data scadenza con evidenziazione
                let scadenzaHtml = '<span class="text-gray-400 text-xs">N/A</span>';
                if (contract.data_scadenza) {
                    const scadenza = new Date(contract.data_scadenza);
                    const today = new Date();
                    const diffTime = scadenza - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    let colorClass = 'text-gray-600';
                    let icon = '';
                    
                    if (diffDays < 0) {
                        colorClass = 'text-red-600 font-bold';
                        icon = '<i class="fas fa-exclamation-triangle mr-1"></i>';
                    } else if (diffDays <= 30) {
                        colorClass = 'text-orange-600 font-semibold';
                        icon = '<i class="fas fa-clock mr-1"></i>';
                    } else if (diffDays <= 90) {
                        colorClass = 'text-yellow-600';
                        icon = '<i class="fas fa-calendar-check mr-1"></i>';
                    }
                    
                    scadenzaHtml = `<span class="${colorClass} text-xs">${icon}${scadenza.toLocaleDateString('it-IT')}</span>`;
                }
                
                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 text-xs">
                            <code class="bg-gray-100 px-2 py-1 rounded">${contract.codice_contratto || contract.id}</code>
                        </td>
                        <td class="py-3 text-sm font-medium">
                            ${escapeHtml(contract.cliente_nome)} ${escapeHtml(contract.cliente_cognome)}
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded font-medium">
                                ${contract.servizio || contract.tipo_servizio || 'N/A'}
                            </span>
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded font-medium">
                                ${contract.piano || 'N/A'}
                            </span>
                        </td>
                        <td class="py-3 text-sm text-gray-600">${dispositivo}</td>
                        <td class="py-3 text-sm font-bold text-green-600">
                            €${parseFloat(contract.prezzo_totale || 0).toFixed(2)}
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded font-medium">
                                ${contract.status || 'SENT'}
                            </span>
                        </td>
                        <td class="py-3 text-xs text-gray-500">${date}</td>
                        <td class="py-3">${scadenzaHtml}</td>
                        <td class="py-3">
                            ${contract.status === 'SIGNED' && contract.signed_pdf_url ? 
                                `<a href="${contract.signed_pdf_url}" 
                                   target="_blank" 
                                   class="inline-flex items-center px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded transition-all">
                                    <i class="fas fa-file-pdf mr-1"></i> PDF Firmato
                                </a>` : 
                                `<span class="text-gray-400 text-xs">-</span>`
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getDispositivoForService(servizio) {
            const dispositivi = {
                'FAMILY': 'SiDLY CARE PRO',
                'PRO': 'SiDLY CARE PRO',
                'PREMIUM': 'SiDLY VITAL CARE'
            };
            return dispositivi[servizio] || 'N/A';
        }

        // ============ PROFORMA TABLE ============
        function renderProformaTable(proformas) {
            const tbody = document.getElementById('proformaTable');
            const countElement = document.getElementById('proformaCount');
            
            countElement.textContent = proformas.length;
            
            if (proformas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="py-8 text-center text-gray-400">Nessuna proforma trovata</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = proformas.map(proforma => {
                const dataEmissione = proforma.data_emissione ? new Date(proforma.data_emissione).toLocaleDateString('it-IT') : '-';
                const dataScadenza = proforma.data_scadenza ? new Date(proforma.data_scadenza).toLocaleDateString('it-IT') : '-';
                
                // Status badge
                const statusColors = {
                    'DRAFT': 'bg-gray-100 text-gray-700',
                    'SENT': 'bg-blue-100 text-blue-700',
                    'PAID': 'bg-green-100 text-green-700',
                    'EXPIRED': 'bg-red-100 text-red-700'
                };
                const statusColor = statusColors[proforma.status] || 'bg-gray-100 text-gray-700';
                
                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 text-xs">
                            <code class="bg-gray-100 px-2 py-1 rounded">${proforma.numero_proforma || proforma.id}</code>
                        </td>
                        <td class="py-3 text-sm font-medium">
                            ${escapeHtml(proforma.cliente_nome || '')} ${escapeHtml(proforma.cliente_cognome || '')}
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded font-medium">
                                ${proforma.tipo_servizio || 'N/A'}
                            </span>
                        </td>
                        <td class="py-3 text-sm font-bold text-green-600">
                            €${parseFloat(proforma.prezzo_totale || 0).toFixed(2)}
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 ${statusColor} text-xs rounded font-medium">
                                ${proforma.status || 'DRAFT'}
                            </span>
                        </td>
                        <td class="py-3 text-xs text-gray-500">${dataEmissione}</td>
                        <td class="py-3 text-xs text-gray-500">${dataScadenza}</td>
                        <td class="py-3">
                            <a href="/proforma-view.html?id=${proforma.id}" 
                               target="_blank" 
                               class="inline-flex items-center px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs font-medium rounded transition-all">
                                <i class="fas fa-file-invoice mr-1"></i> Visualizza
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function applyProformaFilters() {
            const statusFilter = document.getElementById('filterProformaStatus').value;
            let filtered = window.allProformas || [];
            
            if (statusFilter) {
                filtered = filtered.filter(p => p.status === statusFilter);
            }
            
            renderProformaTable(filtered);
        }

        // ============ PAYMENTS TABLE ============
        function renderPaymentsTable(payments) {
            const tbody = document.getElementById('paymentsTable');
            const countElement = document.getElementById('paymentsCount');
            
            countElement.textContent = payments.length;
            
            if (payments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="py-8 text-center text-gray-400">Nessun pagamento trovato</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = payments.map(payment => {
                const dataPagamento = payment.data_pagamento ? new Date(payment.data_pagamento).toLocaleDateString('it-IT') : '-';
                
                // Metodo pagamento badge
                const metodoBadge = {
                    'STRIPE_CARD': '<i class="fas fa-credit-card mr-1"></i>Carta',
                    'STRIPE_SEPA': '<i class="fas fa-university mr-1"></i>SEPA',
                    'BONIFICO': '<i class="fas fa-money-check-alt mr-1"></i>Bonifico'
                };
                
                // Status badge
                const statusColors = {
                    'PENDING': 'bg-yellow-100 text-yellow-700',
                    'COMPLETED': 'bg-green-100 text-green-700',
                    'FAILED': 'bg-red-100 text-red-700',
                    'CANCELLED': 'bg-gray-100 text-gray-700'
                };
                const statusColor = statusColors[payment.status] || 'bg-gray-100 text-gray-700';
                
                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 text-xs">
                            <code class="bg-gray-100 px-2 py-1 rounded">${(payment.id || '').substring(0, 12)}...</code>
                        </td>
                        <td class="py-3 text-xs">
                            <code class="bg-purple-50 px-2 py-1 rounded text-purple-700">${payment.proforma_id || '-'}</code>
                        </td>
                        <td class="py-3 text-sm font-bold text-green-600">
                            €${parseFloat(payment.importo || 0).toFixed(2)}
                        </td>
                        <td class="py-3 text-xs">
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded font-medium">
                                ${metodoBadge[payment.metodo_pagamento] || payment.metodo_pagamento || 'N/A'}
                            </span>
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 ${statusColor} text-xs rounded font-medium">
                                ${payment.status || 'PENDING'}
                            </span>
                        </td>
                        <td class="py-3 text-xs text-gray-500">
                            ${payment.transaction_id ? `<code class="bg-gray-50 px-1 rounded">${payment.transaction_id.substring(0, 20)}...</code>` : '-'}
                        </td>
                        <td class="py-3 text-xs text-gray-500">${dataPagamento}</td>
                    </tr>
                `;
            }).join('');
        }

        function applyPaymentFilters() {
            const methodFilter = document.getElementById('filterPaymentMethod').value;
            let filtered = window.allPayments || [];
            
            if (methodFilter) {
                filtered = filtered.filter(p => p.metodo_pagamento === methodFilter);
            }
            
            renderPaymentsTable(filtered);
        }

        // ============ DDT TABLE ============
        function renderDdtTable(ddts) {
            const tbody = document.getElementById('ddtTable');
            const countElement = document.getElementById('ddtCount');
            
            countElement.textContent = ddts.length;
            
            if (ddts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="py-8 text-center text-gray-400">Nessuna DDT trovata</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = ddts.map(ddt => {
                const dataCreazione = ddt.created_at ? new Date(ddt.created_at).toLocaleDateString('it-IT') : '-';
                
                // Status badge
                const statusBadges = {
                    'preparazione': '<i class="fas fa-box mr-1"></i>In Preparazione',
                    'spedito': '<i class="fas fa-shipping-fast mr-1"></i>Spedito',
                    'in_transito': '<i class="fas fa-truck mr-1"></i>In Transito',
                    'consegnato': '<i class="fas fa-check-circle mr-1"></i>Consegnato',
                    'anomalia': '<i class="fas fa-exclamation-triangle mr-1"></i>Anomalia'
                };
                
                const statusColors = {
                    'preparazione': 'bg-blue-100 text-blue-700',
                    'spedito': 'bg-purple-100 text-purple-700',
                    'in_transito': 'bg-orange-100 text-orange-700',
                    'consegnato': 'bg-green-100 text-green-700',
                    'anomalia': 'bg-red-100 text-red-700'
                };
                const statusColor = statusColors[ddt.status] || 'bg-gray-100 text-gray-700';
                const statusBadge = statusBadges[ddt.status] || ddt.status || 'N/A';
                
                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 text-xs">
                            <code class="bg-gray-100 px-2 py-1 rounded font-bold">${ddt.numero_ddt || ddt.id}</code>
                        </td>
                        <td class="py-3 text-sm font-medium">
                            ${escapeHtml(ddt.destinatario_nome || '-')}
                        </td>
                        <td class="py-3 text-xs text-gray-600">
                            ${ddt.dispositivo || 'N/A'}
                        </td>
                        <td class="py-3 text-xs">
                            <code class="bg-blue-50 px-2 py-1 rounded text-blue-700">${ddt.serial_number || 'Da assegnare'}</code>
                        </td>
                        <td class="py-3 text-xs text-gray-600">
                            ${ddt.corriere || 'Da definire'}
                        </td>
                        <td class="py-3 text-xs">
                            ${ddt.tracking_number ? `<a href="#" class="text-blue-600 hover:text-blue-800 font-medium">${ddt.tracking_number}</a>` : '-'}
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 ${statusColor} text-xs rounded font-medium">
                                ${statusBadge}
                            </span>
                        </td>
                        <td class="py-3 text-xs text-gray-500">${dataCreazione}</td>
                        <td class="py-3">
                            <a href="/ddt-view.html?id=${ddt.numero_ddt || ddt.id}" 
                               target="_blank" 
                               class="inline-flex items-center px-3 py-1 bg-orange-600 hover:bg-orange-700 text-white text-xs font-medium rounded transition-all">
                                <i class="fas fa-truck mr-1"></i> Visualizza
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function applyDdtFilters() {
            const statusFilter = document.getElementById('filterDdtStatus').value;
            let filtered = window.allDdts || [];
            
            if (statusFilter) {
                filtered = filtered.filter(d => d.status === statusFilter);
            }
            
            renderDdtTable(filtered);
        }
    </script>
</body>
</html>
