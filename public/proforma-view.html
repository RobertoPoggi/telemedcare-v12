<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fattura Proforma - TeleMedCare</title>
<style>
body { 
  font-family: Arial, Helvetica, sans-serif; 
  line-height: 1.5; 
  max-width: 800px; 
  margin: 0 auto; 
  padding: 40px; 
  color: #000;
  background: #fff;
}
.header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 40px;
  padding-bottom: 20px;
  border-bottom: 3px solid #1e40af;
}
.company-info {
  flex: 1;
}
.company-info h1 {
  color: #1e40af;
  margin: 0 0 10px 0;
  font-size: 24px;
}
.invoice-info {
  text-align: right;
  flex: 1;
}
.invoice-info h2 {
  color: #1e40af;
  margin: 0 0 10px 0;
  font-size: 20px;
}
.client-section {
  background: #f8f9fa;
  padding: 20px;
  margin: 20px 0;
  border-left: 4px solid #1e40af;
}
.client-section h3 {
  margin: 0 0 10px 0;
  color: #1e40af;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin: 30px 0;
}
thead {
  background: #1e40af;
  color: white;
}
th, td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #dee2e6;
}
th {
  font-weight: 600;
}
.text-right {
  text-align: right;
}
.text-center {
  text-align: center;
}
.totals-section {
  margin: 30px 0;
  padding: 20px;
  background: #f8f9fa;
  border: 2px solid #1e40af;
}
.total-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  font-size: 16px;
}
.total-row.grand-total {
  border-top: 2px solid #1e40af;
  padding-top: 15px;
  margin-top: 10px;
  font-weight: bold;
  font-size: 20px;
  color: #1e40af;
}
.payment-info {
  background: #fff3cd;
  border: 2px solid #ffc107;
  padding: 20px;
  margin: 30px 0;
  border-radius: 8px;
}
.payment-info h3 {
  margin: 0 0 15px 0;
  color: #856404;
}
.bank-details {
  background: white;
  padding: 15px;
  margin: 10px 0;
  border-left: 4px solid #ffc107;
}
.footer {
  margin-top: 50px;
  padding-top: 20px;
  border-top: 2px solid #dee2e6;
  text-align: center;
  font-size: 12px;
  color: #6c757d;
}
.highlight {
  background: #d1ecf1;
  border: 1px solid #bee5eb;
  padding: 15px;
  margin: 20px 0;
  border-radius: 5px;
}
</style>
</head>
<body>

<div class="header">
  <div class="company-info">
    <h1>Medica GB S.r.l.</h1>
    <p style="margin: 5px 0;"><strong>Sede Legale:</strong> Corso Giuseppe Garibaldi, 34</p>
    <p style="margin: 5px 0;">20121 Milano (MI)</p>
    <p style="margin: 5px 0;"><strong>Sede Operativa:</strong> Via delle Eriche 53, 16148 Genova (GE)</p>
    <p style="margin: 5px 0;"><strong>P.IVA:</strong> 12435130963</p>
    <p style="margin: 5px 0;"><strong>REA:</strong> MI-2661409</p>
    <p style="margin: 5px 0;"><strong>Email:</strong> info@medicagb.it</p>
    <p style="margin: 5px 0;"><strong>PEC:</strong> medicagbsrl@pecimprese.it</p>
  </div>
  <div class="invoice-info">
    <h2>FATTURA PROFORMA</h2>
    <p style="margin: 10px 0;"><strong>N°:</strong> <span id="numero-proforma"></span></p>
    <p style="margin: 10px 0;"><strong>Data:</strong> <span id="data-emissione"></span></p>
    <p style="margin: 10px 0;"><strong>Valida fino al:</strong> <span id="data-scadenza"></span></p>
  </div>
</div>

<div class="client-section">
  <h3>DESTINATARIO</h3>
  <p style="margin: 5px 0;"><strong><span id="nome-cliente"></span> <span id="cognome-cliente"></span></strong></p>
  <p style="margin: 5px 0;"><span id="indirizzo-cliente"></span></p>
  <p style="margin: 5px 0;"><span id="cap-cliente"></span> <span id="citta-cliente"></span> (<span id="provincia-cliente"></span>)</p>
  <p style="margin: 5px 0;"><strong>Codice Fiscale:</strong> <span id="cf-cliente"></span></p>
  <p style="margin: 5px 0;"><strong>Email:</strong> <span id="email-cliente"></span></p>
  <p style="margin: 5px 0;"><strong>Telefono:</strong> <span id="telefono-cliente"></span></p>
</div>

<div class="highlight">
  <p style="margin: 0; font-weight: bold; color: #0c5460;">Questa è una FATTURA PROFORMA valida per 30 giorni dalla data di emissione. Non costituisce documento fiscale ma impegno a emettere fattura definitiva al ricevimento del pagamento.</p>
</div>

<table>
  <thead>
    <tr>
      <th style="width: 50%;">Descrizione</th>
      <th class="text-center" style="width: 15%;">Quantità</th>
      <th class="text-right" style="width: 20%;">Prezzo Unitario</th>
      <th class="text-right" style="width: 15%;">Totale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
        <strong>TIPO DI PRESTAZIONE: SERVIZI DI TELEASSISTENZA <span id="piano-servizio"></span> CON <span id="dispositivo-1"></span></strong><br/>
        <small style="display: block; margin-top: 10px; line-height: 1.6;">
          Sistema di allarme mobile di piccole dimensioni ed indossabile. È progettato per monitorare e proteggere le persone. 
          In caso di emergenza, la persona può attivarlo premendo un pulsante SOS sull'unità e la funzione di comunicazione vocale 
          bidirezionale consente di parlare con la Centrale Operativa. E' integrato con sensori che consentono la geolocalizzazione, 
          il geo-fencing, il rilevamento cadute, il reminder dei farmaci e la gestione dell'alimentazione. 
          E' un Dispositivo Medico certificato in classe IIA con codice CND V0399 (DISPOSITIVI CON FUNZIONI DI MISURA – ALTRI) 
          e codice BD/RDM <span id="codice-bd-rdm"></span> del repertorio dispositivi medicali e, come tale, consente la rilevazione della 
          Frequenza Cardiaca (FC) e della Saturazione (SpO2). E' inclusa basetta per la ricarica, alimentatore e cavo. 
          Installazione e collaudo inclusi. SIM SiDLY per <span id="dispositivo-2"></span>, per comunicazione e trasmissione dati. 
          Piattaforma/APP SiDLYCARE (Dispositivo medicale in classe I)
        </small><br/>
        <small style="display: block; margin-top: 10px;"><strong>Durata del Servizio:</strong> 12 mesi</small><br/>
        <small><strong>Include:</strong> Dispositivo <span id="dispositivo-3"></span>, Configurazione, Piattaforma Web/APP, SIM dati, Chiamate bidirezionali<span id="centrale-operativa"></span></small>
      </td>
      <td class="text-center">1</td>
      <td class="text-right">€ <span id="prezzo-base"></span></td>
      <td class="text-right">€ <span id="prezzo-base-2"></span></td>
    </tr>
  </tbody>
</table>

<div class="totals-section">
  <div class="total-row">
    <span>Imponibile:</span>
    <span>€ <span id="imponibile"></span></span>
  </div>
  <div class="total-row">
    <span>IVA (22%):</span>
    <span>€ <span id="importo-iva"></span></span>
  </div>
  <div class="total-row grand-total">
    <span>TOTALE DA PAGARE:</span>
    <span>€ <span id="prezzo-totale"></span></span>
  </div>
</div>

<div class="payment-info">
  <h3>MODALITÀ DI PAGAMENTO</h3>
  <p style="margin: 10px 0;">Il pagamento può essere effettuato tramite:</p>
  
  <div class="bank-details">
    <p style="margin: 5px 0; font-weight: bold;">1. BONIFICO BANCARIO</p>
    <p style="margin: 5px 0;"><strong>Beneficiario:</strong> Medica GB S.r.l.</p>
    <p style="margin: 5px 0;"><strong>IBAN:</strong> IT97L0503401727000000003519</p>
    <p style="margin: 5px 0;"><strong>Banca:</strong> Banca Popolare di Milano</p>
    <p style="margin: 5px 0;"><strong>Causale:</strong> Proforma <span id="causale-numero"></span> - TeleMedCare <span id="causale-servizio"></span></p>
  </div>

  <div class="bank-details">
    <p style="margin: 5px 0; font-weight: bold;">2. CARTA DI CREDITO/DEBITO</p>
    <p style="margin: 5px 0;">Pagamento sicuro online tramite il link fornito nell'email di conferma</p>
  </div>

  <p style="margin: 15px 0 5px 0; font-weight: bold; color: #856404;">⚠️ IMPORTANTE:</p>
  <ul style="margin: 5px 0; padding-left: 20px;">
    <li>Il pagamento deve essere effettuato entro la data di scadenza indicata</li>
    <li>La fattura fiscale definitiva verrà emessa al ricevimento del pagamento</li>
    <li>Il servizio verrà attivato entro 2 giorni lavorativi dal pagamento</li>
  </ul>
</div>

<div style="background: #e7f3ff; border-left: 4px solid #1e40af; padding: 15px; margin: 20px 0;">
  <p style="margin: 0; font-weight: bold;">✓ Cosa succede dopo il pagamento?</p>
  <ol style="margin: 10px 0; padding-left: 20px;">
    <li>Riceverai la fattura fiscale definitiva via email</li>
    <li>Ti invieremo il dispositivo SiDLY CARE PRO entro 10 giorni lavorativi</li>
    <li>Riceverai le istruzioni per la configurazione e l'attivazione</li>
    <li>Il nostro team ti contatterà per programmare l'attivazione del servizio</li>
  </ol>
</div>

<div class="footer">
  <p><strong>Medica GB S.r.l.</strong> - Startup Innovativa a Vocazione Sociale</p>
  <p>www.medicagb.it | www.telemedcare.it</p>
  <p>Tel: +39 02 1234567 | Email: info@medicagb.it</p>
  <p style="margin-top: 15px; font-size: 11px;">
    Documento generato automaticamente dal sistema TeleMedCare V11.0<br/>
    Per informazioni o assistenza: info@medicagb.it
  </p>
</div>

<script>
// Ottieni l'ID della proforma dall'URL
const urlParams = new URLSearchParams(window.location.search);
const proformaId = urlParams.get('id');

if (!proformaId) {
  alert('ID proforma mancante nell\'URL');
} else {
  // Carica i dati della proforma
  fetch(`/api/proforma/${proformaId}`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Proforma non trovata');
      }
      return response.json();
    })
    .then(data => {
      console.log('Dati proforma ricevuti:', data);
      
      // Estrai l'oggetto proforma dalla risposta API
      const proforma = data.proforma || data;
      
      // Popola i campi con i dati ricevuti
      document.getElementById('numero-proforma').textContent = proforma.numero_proforma || 'N/A';
      document.getElementById('data-emissione').textContent = formatDate(proforma.data_emissione) || formatDate(new Date());
      document.getElementById('data-scadenza').textContent = formatDate(proforma.data_scadenza) || 'N/A';
      
      document.getElementById('nome-cliente').textContent = proforma.cliente_nome || '';
      document.getElementById('cognome-cliente').textContent = proforma.cliente_cognome || '';
      document.getElementById('indirizzo-cliente').textContent = proforma.cliente_indirizzo || 'N/D';
      document.getElementById('cap-cliente').textContent = proforma.cliente_cap || '';
      document.getElementById('citta-cliente').textContent = proforma.cliente_citta || '';
      document.getElementById('provincia-cliente').textContent = proforma.cliente_provincia || '';
      document.getElementById('cf-cliente').textContent = proforma.cliente_codice_fiscale || 'N/D';
      document.getElementById('email-cliente').textContent = proforma.cliente_email || '';
      document.getElementById('telefono-cliente').textContent = proforma.cliente_telefono || 'N/D';
      
      // Servizio e Piano
      const servizio = proforma.servizio || 'eCura PRO';
      const piano = proforma.piano || 'BASE';
      
      // Determina il dispositivo dal servizio
      let dispositivo = 'SiDLY CARE PRO'; // Default
      
      // Mappatura corretta servizio → dispositivo
      if (servizio.includes('PREMIUM')) {
        dispositivo = 'SiDLY VITAL CARE';
      } else if (servizio.includes('PROFESSIONAL') || servizio.includes('PRO')) {
        dispositivo = 'SiDLY CARE PRO';
      } else if (servizio.includes('FAMILY')) {
        dispositivo = 'SiDLY CARE PRO'; // Con funzionalità ridotte
      }
      
      // Determina il codice BD/RDM
      const codiceBdRdm = dispositivo === 'SiDLY CARE PRO' ? '2853576' : '2853300';
      
      // Determina la centrale operativa
      const centraleOperativa = piano === 'AVANZATO' ? ' e Centrale Operativa H24' : '';
      
      // Popola i nuovi campi
      document.getElementById('piano-servizio').textContent = piano;
      document.getElementById('dispositivo-1').textContent = dispositivo;
      document.getElementById('dispositivo-2').textContent = dispositivo;
      document.getElementById('dispositivo-3').textContent = dispositivo;
      document.getElementById('codice-bd-rdm').textContent = codiceBdRdm;
      document.getElementById('centrale-operativa').textContent = centraleOperativa;
      
      document.getElementById('causale-numero').textContent = proforma.numero_proforma || '';
      document.getElementById('causale-servizio').textContent = `${servizio} ${piano}`;
      
      // Prezzi - USA PREZZO_TOTALE per il totale annuale!
      const prezzoTotaleIvaInclusa = parseFloat(proforma.prezzo_totale) || parseFloat(proforma.importo_totale) || 0;
      const prezzoBase = prezzoTotaleIvaInclusa / 1.22; // Scorporo IVA 22%
      const iva = prezzoTotaleIvaInclusa - prezzoBase;
      
      document.getElementById('prezzo-base').textContent = formatCurrency(prezzoBase);
      document.getElementById('prezzo-base-2').textContent = formatCurrency(prezzoBase);
      document.getElementById('imponibile').textContent = formatCurrency(prezzoBase);
      document.getElementById('importo-iva').textContent = formatCurrency(iva);
      document.getElementById('prezzo-totale').textContent = formatCurrency(prezzoTotaleIvaInclusa);
      
      // Link pagamento
      const linkPagamento = `/pagamento.html?proformaId=${proformaId}`;
      document.getElementById('link-pagamento').href = linkPagamento;
    })
    .catch(error => {
      console.error('Errore caricamento proforma:', error);
      alert('Errore: ' + (error.message || 'Impossibile caricare la proforma'));
    });
}

function formatDate(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function formatCurrency(amount) {
  return amount.toFixed(2).replace('.', ',');
}
</script>

</body>
</html>
