<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleMedCare V11.0 - Gestione Ambienti</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-cogs text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Gestione Ambienti</h1>
                        <p class="text-blue-100">TeleMedCare V11.0 Modular Enterprise</p>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <a href="/admin/data-dashboard" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-dashboard mr-2"></i>Dashboard
                    </a>
                    <a href="/admin/docs" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-book mr-2"></i>Docs
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Status Ambienti -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Development</p>
                        <p class="text-2xl font-bold text-green-600">Active</p>
                        <p class="text-gray-500 text-xs">telemedcare-leads</p>
                    </div>
                    <i class="fas fa-laptop-code text-3xl text-green-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Test</p>
                        <p class="text-2xl font-bold text-blue-600" id="testEnvCount">0</p>
                        <p class="text-gray-500 text-xs">telemedcare_test_0n</p>
                    </div>
                    <i class="fas fa-flask text-3xl text-blue-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-yellow-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Staging</p>
                        <p class="text-2xl font-bold text-yellow-600" id="stagingStatus">Inactive</p>
                        <p class="text-gray-500 text-xs">telemedcare_staging</p>
                    </div>
                    <i class="fas fa-server text-3xl text-yellow-500"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm card-hover border-l-4 border-red-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Production</p>
                        <p class="text-2xl font-bold text-red-600" id="productionStatus">Not Created</p>
                        <p class="text-gray-500 text-xs">telemedcare_database</p>
                    </div>
                    <i class="fas fa-globe text-3xl text-red-500"></i>
                </div>
            </div>
        </div>

        <!-- Azioni Ambiente -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Creazione Ambienti -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-plus-circle text-blue-500 mr-2"></i>
                    Crea Nuovo Ambiente
                </h3>
                
                <div class="space-y-4">
                    <button id="createProductionBtn" class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-lg font-medium transition-all flex items-center justify-center">
                        <i class="fas fa-globe mr-2"></i>
                        Crea Ambiente Produzione
                    </button>
                    
                    <div class="flex space-x-2">
                        <input type="number" id="testVersionInput" placeholder="Versione (opzionale)" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button id="createTestBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-all flex items-center">
                            <i class="fas fa-flask mr-2"></i>
                            Crea Test
                        </button>
                    </div>
                </div>
            </div>

            <!-- Clonazione Ambienti -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-copy text-green-500 mr-2"></i>
                    Clona Ambiente
                </h3>
                
                <div class="space-y-4">
                    <select id="sourceEnvSelect" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Seleziona ambiente sorgente</option>
                        <option value="development">Development</option>
                        <option value="test">Test</option>
                        <option value="staging">Staging</option>
                        <option value="production">Production</option>
                    </select>
                    
                    <div class="flex space-x-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="includeDataCheck" class="mr-2" checked>
                            <span class="text-sm">Includi dati</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="includeLogsCheck" class="mr-2">
                            <span class="text-sm">Includi log</span>
                        </label>
                    </div>
                    
                    <button id="cloneEnvBtn" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-all flex items-center justify-center">
                        <i class="fas fa-copy mr-2"></i>
                        Clona Ambiente
                    </button>
                </div>
            </div>
        </div>

        <!-- Deployment -->
        <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fas fa-rocket text-purple-500 mr-2"></i>
                Deployment Automatico
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="deployProductionBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-3 rounded-lg font-medium transition-all flex items-center justify-center">
                    <i class="fas fa-rocket mr-2"></i>
                    Deploy in Produzione
                </button>
                
                <button id="refreshEnvironmentsBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-medium transition-all flex items-center justify-center">
                    <i class="fas fa-sync mr-2"></i>
                    Aggiorna Lista Ambienti
                </button>
            </div>
        </div>

        <!-- Lista Ambienti -->
        <div class="bg-white rounded-xl shadow-sm">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold flex items-center">
                    <i class="fas fa-list text-indigo-500 mr-2"></i>
                    Ambienti Attivi
                </h3>
            </div>
            <div class="p-6">
                <div id="environmentsList" class="space-y-4">
                    <!-- Lista ambienti caricata dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Status Modal -->
    <div id="statusModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
            <div class="text-center">
                <div id="statusIcon" class="text-4xl mb-4"></div>
                <h3 id="statusTitle" class="text-lg font-semibold mb-2"></h3>
                <p id="statusMessage" class="text-gray-600 mb-4"></p>
                <button onclick="closeStatusModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-all">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        // Gestione modale status
        function showStatusModal(icon, title, message, isSuccess = true) {
            document.getElementById('statusIcon').innerHTML = icon
            document.getElementById('statusIcon').className = `text-4xl mb-4 ${isSuccess ? 'text-green-500' : 'text-red-500'}`
            document.getElementById('statusTitle').textContent = title
            document.getElementById('statusMessage').textContent = message
            document.getElementById('statusModal').classList.remove('hidden')
            document.getElementById('statusModal').classList.add('flex')
        }

        function closeStatusModal() {
            document.getElementById('statusModal').classList.add('hidden')
            document.getElementById('statusModal').classList.remove('flex')
        }

        // Funzioni API
        async function createProductionEnvironment() {
            try {
                showStatusModal('<i class="fas fa-spinner fa-spin"></i>', 'Creazione in corso...', 'Creando ambiente di produzione...')
                
                const response = await axios.post('/api/environment/create/production')
                
                if (response.data.success) {
                    showStatusModal('<i class="fas fa-check-circle"></i>', 'Successo!', `Ambiente produzione creato: ${response.data.project_name}`)
                    await loadEnvironments()
                } else {
                    showStatusModal('<i class="fas fa-times-circle"></i>', 'Errore', response.data.error || 'Errore nella creazione ambiente produzione', false)
                }
            } catch (error) {
                showStatusModal('<i class="fas fa-times-circle"></i>', 'Errore', 'Errore di connessione al server', false)
            }
        }

        async function createTestEnvironment() {
            try {
                const version = document.getElementById('testVersionInput').value
                showStatusModal('<i class="fas fa-spinner fa-spin"></i>', 'Creazione in corso...', 'Creando ambiente di test...')
                
                const response = await axios.post('/api/environment/create/test', {
                    version: version ? parseInt(version) : undefined
                })
                
                if (response.data.success) {
                    showStatusModal('<i class="fas fa-check-circle"></i>', 'Successo!', `Ambiente test creato: ${response.data.project_name}`)
                    document.getElementById('testVersionInput').value = ''
                    await loadEnvironments()
                } else {
                    showStatusModal('<i class="fas fa-times-circle"></i>', 'Errore', response.data.error || 'Errore nella creazione ambiente test', false)
                }
            } catch (error) {
                showStatusModal('<i class="fas fa-times-circle"></i>', 'Errore', 'Errore di connessione al server', false)
            }
        }

        async function cloneEnvironment() {
            try {
                const sourceEnv = document.getElementById('sourceEnvSelect').value
                const includeData = document.getElementById('includeDataCheck').checked
                const includeLogs = document.getElementById('includeLogsCheck').checked
                
                if (!sourceEnv) {
                    showStatusModal('<i class="fas fa-exclamation-triangle"></i>', 'Attenzione', 'Seleziona un ambiente sorgente', false)
                    return
                }
                
                showStatusModal('<i class="fas fa-spinner fa-spin"></i>', 'Clonazione in corso...', 'Clonando ambiente...')
                
                const response = await axios.post('/api/environment/clone', {
                    source_environment: sourceEnv,
                    target_environment: 'test',
                    include_data: includeData,
                    include_logs: includeLogs
                })
                
                if (response.data.success) {
                    showStatusModal('<i class="fas fa-check-circle"></i>', 'Successo!', `Ambiente clonato: ${response.data.source} â†’ ${response.data.target}`)
                    await loadEnvironments()
                } else {
                    showStatusModal('<i class="fas fa-times-circle"></i>', 'Errore', response.data.error || 'Errore nella clonazione ambiente', false)
                }
            } catch (error) {
                showStatusModal('<i class="fas fa-times-circle"></i>', 'Errore', 'Errore di connessione al server', false)
            }
        }

        async function deployToProduction() {
            try {
                showStatusModal('<i class="fas fa-spinner fa-spin"></i>', 'Deploy in corso...', 'Deploying in produzione...')
                
                const response = await axios.post('/api/environment/deploy/production')
                
                if (response.data.success) {
                    showStatusModal('<i class="fas fa-check-circle"></i>', 'Deploy Completato!', `Produzione live: ${response.data.url}`)
                    await loadEnvironments()
                } else {
                    showStatusModal('<i class="fas fa-times-circle"></i>', 'Errore Deploy', response.data.error || 'Errore nel deployment', false)
                }
            } catch (error) {
                showStatusModal('<i class="fas fa-times-circle"></i>', 'Errore', 'Errore di connessione al server', false)
            }
        }

        async function loadEnvironments() {
            try {
                const response = await axios.get('/api/environment/list')
                
                if (response.data.success) {
                    displayEnvironments(response.data.environments)
                }
            } catch (error) {
                console.error('Errore caricamento ambienti:', error)
            }
        }

        function displayEnvironments(environments) {
            const container = document.getElementById('environmentsList')
            container.innerHTML = ''
            
            environments.forEach(env => {
                const envCard = document.createElement('div')
                envCard.className = 'border border-gray-200 rounded-lg p-4'
                
                const statusIcon = env.status === 'active' ? 
                    '<i class="fas fa-circle text-green-500"></i>' : 
                    '<i class="fas fa-circle text-gray-400"></i>'
                
                envCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            ${statusIcon}
                            <div>
                                <h4 class="font-medium">${env.name}</h4>
                                <p class="text-sm text-gray-600">${env.config.description}</p>
                                <p class="text-xs text-gray-500">DB: ${env.config.database.database_name}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="px-2 py-1 bg-${env.status === 'active' ? 'green' : 'gray'}-100 text-${env.status === 'active' ? 'green' : 'gray'}-800 text-xs rounded-full">
                                ${env.status}
                            </span>
                        </div>
                    </div>
                `
                
                container.appendChild(envCard)
            })
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('createProductionBtn').addEventListener('click', createProductionEnvironment)
            document.getElementById('createTestBtn').addEventListener('click', createTestEnvironment)
            document.getElementById('cloneEnvBtn').addEventListener('click', cloneEnvironment)
            document.getElementById('deployProductionBtn').addEventListener('click', deployToProduction)
            document.getElementById('refreshEnvironmentsBtn').addEventListener('click', loadEnvironments)
            
            // Carica ambienti all'avvio
            loadEnvironments()
        })
    </script>
</body>
</html>